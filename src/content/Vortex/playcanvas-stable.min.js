/*

 PlayCanvas Engine v1.38.0 revision 98cb89e
 Copyright 2011-2021 PlayCanvas Ltd. All rights reserved.
*/
(function(q,cc){"object"===typeof exports&&"undefined"!==typeof module?cc(exports):"function"===typeof define&&define.amd?define(["exports"],cc):(q="undefined"!==typeof globalThis?globalThis:q||self,cc(q.pc={}))})(this,function(q){function cc(l){if(null===l)return"null";var g=typeof l;return"undefined"===g||"number"===g||"string"===g||"boolean"===g?g:hn[Object.prototype.toString.call(l)]}function Ob(l,g){var d;for(d in g){var b=g[d];"object"==cc(b)?l[d]=Ob({},b):"array"==cc(b)?l[d]=Ob([],b):l[d]=
b}return l}function ig(l){return void 0!==l}function jg(l,g){var d=l.length;g=g||0;if(0>g||g>=d)return null;var b=l.charCodeAt(g);return 1<d&&55296<=b&&56319>=b&&(l=l.charCodeAt(g+1),56320<=l&&57343>=l)?{code:1024*(b-55296)+l-56320+65536,long:!0}:{code:b,long:!1}}function dc(l,g,d){return l?(l=jg(l))?(l=l.code,l>=g&&l<=d):!1:!1}function Bi(l,g){for(var d=0;d<g.length;d++){var b=g[d];b.enumerable=b.enumerable||!1;b.configurable=!0;"value"in b&&(b.writable=!0);Object.defineProperty(l,b.key,b)}}function N(l,
g,d){g&&Bi(l.prototype,g);d&&Bi(l,d);return l}function K(l,g){l.prototype=Object.create(g.prototype);l.prototype.constructor=l;l.__proto__=g}function F(l){if(void 0===l)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return l}function jn(l,g){if(l){if("string"===typeof l)return Ci(l,g);var d=Object.prototype.toString.call(l).slice(8,-1);"Object"===d&&l.constructor&&(d=l.constructor.name);if("Map"===d||"Set"===d)return Array.from(l);if("Arguments"===d||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(d))return Ci(l,
g)}}function Ci(l,g){if(null==g||g>l.length)g=l.length;for(var d=0,b=Array(g);d<g;d++)b[d]=l[d];return b}function kn(l,g){var d;if("undefined"===typeof Symbol||null==l[Symbol.iterator]){if(Array.isArray(l)||(d=jn(l))||g&&l&&"number"===typeof l.length){d&&(l=d);var b=0;return function(){return b>=l.length?{done:!0}:{done:!1,value:l[b++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}d=l[Symbol.iterator]();
return d.next.bind(d)}function Ge(l){l=l.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/);this.scheme=l[2];this.authority=l[4];this.path=l[5];this.query=l[7];this.fragment=l[9];this.toString=function(){var g="";this.scheme&&(g+=this.scheme+":");this.authority&&(g+="//"+this.authority);g+=this.path;this.query&&(g+="?"+this.query);this.fragment&&(g+="#"+this.fragment);return g};this.getQuery=function(){var g,d={};if(this.query){var b=decodeURIComponent(this.query).split("&");b.forEach(function(a,
c,e){g=a.split("=");d[g[0]]=g[1]},this)}return d};this.setQuery=function(g){var d="",b;for(b in g)g.hasOwnProperty(b)&&(""!==d&&(d+="&"),d+=encodeURIComponent(b)+"="+encodeURIComponent(g[b]));this.query=d}}function Xc(l){for(var g=0,d=0,b=l.length;d<b;d++)g=(g<<5)-g+l.charCodeAt(d),g|=0;return g}function ln(l){this.array[this.index]=l}function mn(l,g){this.array[this.index]=l;this.array[this.index+1]=g}function nn(l,g,d){this.array[this.index]=l;this.array[this.index+1]=g;this.array[this.index+2]=
d}function on(l,g,d,b){this.array[this.index]=l;this.array[this.index+1]=g;this.array[this.index+2]=d;this.array[this.index+3]=b}function pn(l,g,d){this.array[l]=g[d]}function qn(l,g,d){this.array[l]=g[d];this.array[l+1]=g[d+1]}function rn(l,g,d){this.array[l]=g[d];this.array[l+1]=g[d+1];this.array[l+2]=g[d+2]}function sn(l,g,d){this.array[l]=g[d];this.array[l+1]=g[d+1];this.array[l+2]=g[d+2];this.array[l+3]=g[d+3]}function tn(l,g,d){g[d]=this.array[l]}function un(l,g,d){g[d]=this.array[l];g[d+1]=
this.array[l+1]}function vn(l,g,d){g[d]=this.array[l];g[d+1]=this.array[l+1];g[d+2]=this.array[l+2]}function wn(l,g,d){g[d]=this.array[l];g[d+1]=this.array[l+1];g[d+2]=this.array[l+2];g[d+3]=this.array[l+3]}function Ea(l,g,d,b,a,c){void 0===c&&(c=!1);if(null===vc){var e=new Ma(l,[{semantic:"POSITION",components:2,type:6}]);vc=new Ra(l,e,4);e=new vb(vc);e.element.POSITION.set(-1,-1);e.next();e.element.POSITION.set(1,-1);e.next();e.element.POSITION.set(-1,1);e.next();e.element.POSITION.set(1,1);e.end()}e=
l.renderTarget;l.setRenderTarget(g);l.updateBegin();if(b){var f=b.x;var h=b.y;var k=b.z;var m=b.w}else k=g?g.width:l.width,m=g?g.height:l.height,h=f=0;if(a){var n=a.x;var p=a.y;var t=a.z;var r=a.w}else n=f,p=h,t=k,r=m;a=l.vx;b=l.vy;g=l.vw;var u=l.vh;l.setViewport(f,h,k,m);k=l.sx;f=l.sy;h=l.sw;m=l.sh;l.setScissor(n,p,t,r);n=l.getDepthTest();p=l.getDepthWrite();t=l.getCullMode();r=l.writeRed;var v=l.writeGreen,w=l.writeBlue,y=l.writeAlpha;l.setDepthTest(!1);l.setDepthWrite(!1);l.setCullMode(0);l.setColorWrite(!0,
!0,!0,!0);c||l.setBlending(!1);l.setVertexBuffer(vc,0);l.setShader(d);l.draw(xn);l.setDepthTest(n);l.setDepthWrite(p);l.setCullMode(t);l.setColorWrite(r,v,w,y);l.updateEnd();l.setRenderTarget(e);l.updateBegin();l.setViewport(a,b,g,u);l.setScissor(k,f,h,m)}function He(l,g){g||(g=I);return 1===l||2===l?g.gamma2_2PS?g.gamma2_2PS:I.gamma2_2PS:3===l?"#define HDR\n"+(g.gamma2_2PS?g.gamma2_2PS:I.gamma2_2PS):g.gamma1_0PS?g.gamma1_0PS:I.gamma1_0PS}function Ie(l,g){g||(g=I);return 1===l?g.tonemappingFilmicPS?
g.tonemappingFilmicPS:I.tonemappingFilmicPS:0===l?g.tonemappingLinearPS?g.tonemappingLinearPS:I.tonemappingLinearPS:2===l?g.tonemappingHejlPS?g.tonemappingHejlPS:I.tonemappingHejlPS:3===l?g.tonemappingAcesPS?g.tonemappingAcesPS:I.tonemappingAcesPS:4===l?g.tonemappingAces2PS?g.tonemappingAces2PS:I.tonemappingAces2PS:g.tonemapingNonePS?g.tonemapingNonePS:I.tonemappingNonePS}function kg(l,g){g||(g=I);return"linear"===l?g.fogLinearPS?g.fogLinearPS:I.fogLinearPS:"exp"===l?g.fogExpPS?g.fogExpPS:I.fogExpPS:
"exp2"===l?g.fogExp2PS?g.fogExp2PS:I.fogExp2PS:g.fogNonePS?g.fogNonePS:I.fogNonePS}function lg(l,g){g||(g=I);return l.supportsBoneTextures?g.skinTexVS:"#define BONE_LIMIT "+l.getBoneLimit()+"\n"+g.skinConstVS}function wc(l){var g="precision "+l.precision+" float;\n";l.webgl2&&(g+="#ifdef GL2\nprecision "+l.precision+" sampler2DShadow;\n#endif\n");return g}function xc(l){return l.webgl2?"#version 300 es\n":""}function Di(){return"void main(void) {gl_FragColor = vec4(0.0);}"}function Yc(){return"void main(void)\n{\n"}
function Je(l){for(var g={},d=0,b=l.indexOf("attribute");0<=b&&!(0<b&&"/"===l[b-1]);){var a=l.indexOf(";",b),c=l.lastIndexOf(" ",a);a=l.substr(c+1,a-(c+1));c=yn[a];void 0!==c?g[a]=c:(g[a]="ATTR"+d,d++);b=l.indexOf("attribute",b+1)}return g}function Ja(l,g,d,b,a,c){var e=l.programLib._cache,f=e[b];if(void 0!==f)return f;d=wc(l)+"\n"+(d||Di());f=Je(g);l.webgl2&&(g=xc(l)+I.gles3VS+g,d=xc(l)+I.gles3PS+d);e[b]=new Ld(l,{attributes:f,vshader:g,fshader:(c?c:"")+d,useTransformFeedback:a});return e[b]}function jb(){this._mapXForms=
null}function Ei(l,g){if(l&&!g||!l&&g)return!1;l=l.data;g=g.data;if(l===g)return!0;if(l instanceof Float32Array&&g instanceof Float32Array){if(l.length!==g.length)return!1;for(var d=0;d<l.length;d++)if(l[d]!==g[d])return!1;return!0}return!1}function zn(l,g){for(var d in l)if(l.hasOwnProperty(d)&&!Ei(l[d],g[d]))return!1;for(d in g)if(g.hasOwnProperty(d)&&!Ei(g[d],l[d]))return!1;return!0}function An(l,g){var d;for(d=0;d<l.length;d++)if(0>g.indexOf(l[d]))return!1;for(d=0;d<g.length;d++)if(0>l.indexOf(g[d]))return!1;
return!0}function mg(l){l=l.node.worldTransform;l.getX(Ke);l.getY(Fi);l.getZ(Gi);Ke.cross(Ke,Fi);return 0<=Ke.dot(Gi)?1:-1}function Bn(l,g){return l.priority-g.priority}function Cn(l,g){return g.key-l.key}function Dn(l,g){if(0!==g||l.webgl2){if(3===g)return l.extTextureFloatLinear?1:0;if(2===g)return l.extTextureHalfFloatLinear?1:0}else return 0;return 1}function Hi(l,g,d,b){var a=3===b?14:2===b?12:4===b||0===b&&l.webgl2?16:7,c=Dn(l,b);g=new X(l,{format:a,width:g,height:d,mipmaps:!1,minFilter:c,magFilter:c,
addressU:1,addressV:1});g.name="shadowmap";return 4===b||0===b&&l.webgl2?(g.compareOnRead=!0,g.compareFunc=1,new va({depthBuffer:g})):new va({colorBuffer:g,depth:!0})}function Ii(l,g){l=new X(l,{format:7,width:g,height:g,cubemap:!0,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});l.name="shadowcube";g=[];for(var d,b=0;6>b;b++)d=new va({colorBuffer:l,face:b,depth:!0}),g.push(d);return g}function Ji(l,g,d,b){void 0===b&&(b=0);b=1E4*b+g;var a=Ki[d][b];a||(a=Hi(l,g,g,d?d:0),Ki[d][b]=a);return a}
function Li(l,g){if(1===g._type){0<g._shadowType&&(g._shadowType=0);if(g._cacheShadowMap){var d=Mi[g._shadowResolution];d||(d=Ii(l,g._shadowResolution),Mi[g._shadowResolution]=d)}else d=Ii(l,g._shadowResolution);g._shadowCamera.renderTarget=d[0];g._shadowCubeMap=d}else d=g._cacheShadowMap?Ji(l,g._shadowResolution,g._shadowType):Hi(l,g._shadowResolution,g._shadowResolution,g._shadowType),g._shadowCamera.renderTarget=d;g._isCachedShadowMap=g._cacheShadowMap}function Le(l,g,d,b){if(l.enabled){var a;
if(l.model&&l.model.model&&l.model.enabled&&(b&&b.push(l),l.model.lightmapped&&g))var c=l.model.model.meshInstances;l.render&&l.render.enabled&&(b&&b.push(l),l.render.lightmapped&&g&&(c=l.render.meshInstances));if(c){var e=!0;for(a=0;a<c.length;a++)if(!c[a].mesh.vertexBuffer.format.hasUv1){e=!1;break}if(e){var f=[];for(a=0;a<c.length;a++){var h=!1;for(e=0;e<c.length;e++)a!==e&&c[a].mesh===c[e].mesh&&(h=!0);h?(g.push(l),d.push([c[a]])):f.push(c[a])}0<f.length&&(g.push(l),d.push(f))}}for(a=0;a<l._children.length;a++)Le(l._children[a],
g,d,b)}}function Zc(l){return l-Math.floor(l)}function ng(l,g){return l-g*Math.floor(l/g)}function Me(l){var g=Zc(l);l=Zc(255*l);return[g-l/255,l-l/255]}function W(l,g){Ni[l]=void 0!==Ne[l]&&null!==Ne[l]?Ne[l]:g}function Oi(l,g){for(var d=l.length/3,b=Array(4*d),a=0;a<d;a++)b[4*a]=l[3*a],b[4*a+1]=l[3*a+1],b[4*a+2]=l[3*a+2],b[4*a+3]=(255*g[3*a]<<16|255*g[3*a+1]<<8|255*g[3*a+2])/16777216;return b}function yc(l,g){var d,b,a=g.length,c=l.length/a;for(d=0;d<c;d++)for(b=0;b<a;b++)g[b]=Math.max(g[b],Math.abs(l[d*
a+b]))}function zc(l,g,d){for(var b=new Float32Array(g.length),a=0;a<g.length;a++)b[a]=g[a]-l[a];yc(b,d);l=d.length;var c=b.length/l;for(g=0;g<c;g++)for(a=0;a<l;a++)b[g*l+a]/=0===d[a]?1:d[a],b[g*l+a]*=.5,b[g*l+a]+=.5;return b}function Pi(l,g){var d=g.length/3,b=l.length/3,a,c=new A,e=new A,f=new A,h=new A,k=new A,m=new A,n=[];for(a=0;a<l.length;a++)n[a]=0;for(a=0;a<d;a++){var p=g[3*a];var t=g[3*a+1];var r=g[3*a+2];c.set(l[3*p],l[3*p+1],l[3*p+2]);e.set(l[3*t],l[3*t+1],l[3*t+2]);f.set(l[3*r],l[3*r+
1],l[3*r+2]);h.sub2(e,c);k.sub2(f,c);m.cross(h,k).normalize();n[3*p]+=m.x;n[3*p+1]+=m.y;n[3*p+2]+=m.z;n[3*t]+=m.x;n[3*t+1]+=m.y;n[3*t+2]+=m.z;n[3*r]+=m.x;n[3*r+1]+=m.y;n[3*r+2]+=m.z}for(a=0;a<b;a++)l=n[3*a],g=n[3*a+1],d=n[3*a+2],l=1/Math.sqrt(l*l+g*g+d*d),n[3*a]*=l,n[3*a+1]*=l,n[3*a+2]*=l;return n}function Qi(l,g,d,b){var a=b.length/3,c=l.length/3,e=new A,f=new A,h=new A,k=new A,m=new A,n=new S,p=new S,t=new S,r,u=new Float32Array(3*c),v=new Float32Array(3*c),w=[];for(r=0;r<a;r++){var y=b[3*r];var x=
b[3*r+1];var z=b[3*r+2];h.set(l[3*y],l[3*y+1],l[3*y+2]);k.set(l[3*x],l[3*x+1],l[3*x+2]);m.set(l[3*z],l[3*z+1],l[3*z+2]);n.set(d[2*y],d[2*y+1]);p.set(d[2*x],d[2*x+1]);t.set(d[2*z],d[2*z+1]);var B=k.x-h.x;var C=m.x-h.x;var D=k.y-h.y;var G=m.y-h.y;var J=k.z-h.z;var E=m.z-h.z;var H=p.x-n.x;var P=t.x-n.x;var Y=p.y-n.y;var L=t.y-n.y;var V=H*L-P*Y;0==V?(e.set(0,1,0),f.set(1,0,0)):(V=1/V,e.set((L*B-Y*C)*V,(L*D-Y*G)*V,(L*J-Y*E)*V),f.set((H*C-P*B)*V,(H*G-P*D)*V,(H*E-P*J)*V));u[3*y]+=e.x;u[3*y+1]+=e.y;u[3*y+
2]+=e.z;u[3*x]+=e.x;u[3*x+1]+=e.y;u[3*x+2]+=e.z;u[3*z]+=e.x;u[3*z+1]+=e.y;u[3*z+2]+=e.z;v[3*y]+=f.x;v[3*y+1]+=f.y;v[3*y+2]+=f.z;v[3*x]+=f.x;v[3*x+1]+=f.y;v[3*x+2]+=f.z;v[3*z]+=f.x;v[3*z+1]+=f.y;v[3*z+2]+=f.z}Y=new A;L=new A;l=new A;d=new A;for(r=0;r<c;r++)l.set(g[3*r],g[3*r+1],g[3*r+2]),Y.set(u[3*r],u[3*r+1],u[3*r+2]),L.set(v[3*r],v[3*r+1],v[3*r+2]),b=l.dot(Y),d.copy(l).scale(b),d.sub2(Y,d).normalize(),w[4*r]=d.x,w[4*r+1]=d.y,w[4*r+2]=d.z,d.cross(l,Y),w[4*r+3]=0>d.dot(L)?-1:1;return w}function kb(l,
g,d){var b=d&&void 0!==d.normals?d.normals:null,a=d&&void 0!==d.tangents?d.tangents:null,c=d&&void 0!==d.colors?d.colors:null,e=d&&void 0!==d.uvs?d.uvs:null,f=d&&void 0!==d.uvs1?d.uvs1:null,h=d&&void 0!==d.indices?d.indices:null,k=d&&void 0!==d.blendIndices?d.blendIndices:null,m=d&&void 0!==d.blendWeights?d.blendWeights:null;d=[{semantic:"POSITION",components:3,type:6}];null!==b&&d.push({semantic:"NORMAL",components:3,type:6});null!==a&&d.push({semantic:"TANGENT",components:4,type:6});null!==c&&d.push({semantic:"COLOR",
components:4,type:1,normalize:!0});null!==e&&d.push({semantic:"TEXCOORD0",components:2,type:6});null!==f&&d.push({semantic:"TEXCOORD1",components:2,type:6});null!==k&&d.push({semantic:"BLENDINDICES",components:2,type:1});null!==m&&d.push({semantic:"BLENDWEIGHT",components:2,type:6});var n=new Ma(l,d);d=g.length/3;n=new Ra(l,n,d);for(var p=new vb(n),t=0;t<d;t++)p.element.POSITION.set(g[3*t],g[3*t+1],g[3*t+2]),null!==b&&p.element.NORMAL.set(b[3*t],b[3*t+1],b[3*t+2]),null!==a&&p.element.TANGENT.set(a[4*
t],a[4*t+1],a[4*t+2],a[4*t+3]),null!==c&&p.element.COLOR.set(c[4*t],c[4*t+1],c[4*t+2],c[4*t+3]),null!==e&&p.element.TEXCOORD0.set(e[2*t],e[2*t+1]),null!==f&&p.element.TEXCOORD1.set(f[2*t],f[2*t+1]),null!==k&&p.element.BLENDINDICES.set(k[2*t],k[2*t+1]),null!==m&&p.element.BLENDWEIGHT.set(m[2*t],m[2*t+1]),p.next();p.end();b=null;if(a=null!==h)b=new Db(l,1,h.length),(new Uint16Array(b.lock())).set(h),b.unlock();c=new la;c.compute(g);l=new bb(l);l.vertexBuffer=n;l.indexBuffer[0]=b;l.primitive[0].type=
4;l.primitive[0].base=0;l.primitive[0].count=a?h.length:d;l.primitive[0].indexed=a;l.aabb=c;return l}function Ri(l,g){var d=g&&void 0!==g.tubeRadius?g.tubeRadius:.2,b=g&&void 0!==g.ringRadius?g.ringRadius:.3,a=g&&void 0!==g.segments?g.segments:30,c=g&&void 0!==g.sides?g.sides:20;g=g&&void 0!==g.calculateTangents?g.calculateTangents:!1;var e,f,h=[],k=[],m=[],n=[];for(e=0;e<=c;e++)for(f=0;f<=a;f++){var p=Math.cos(2*Math.PI*f/a)*(b+d*Math.cos(2*Math.PI*e/c));var t=Math.sin(2*Math.PI*e/c)*d;var r=Math.sin(2*
Math.PI*f/a)*(b+d*Math.cos(2*Math.PI*e/c));var u=Math.cos(2*Math.PI*f/a)*Math.cos(2*Math.PI*e/c);var v=Math.sin(2*Math.PI*e/c);var w=Math.sin(2*Math.PI*f/a)*Math.cos(2*Math.PI*e/c);var y=e/c;var x=1-f/a;h.push(p,t,r);k.push(u,v,w);m.push(y,x);e<c&&f<a&&(p=e*(a+1)+f,t=(e+1)*(a+1)+f,r=e*(a+1)+(f+1),u=(e+1)*(a+1)+(f+1),n.push(p,t,r),n.push(t,u,r))}d={normals:k,uvs:m,indices:n};g&&(d.tangents=g(h,k,m,n));return kb(l,h,d)}function og(l,g,d,b,a,c){var e,f,h=new A,k=new A;var m=new A;var n=[],p=[],t=[],
r=[],u=[];if(0<d)for(e=0;e<=b;e++)for(f=0;f<=a;f++){var v=f/a*2*Math.PI-Math.PI;var w=Math.sin(v);v=Math.cos(v);var y=new A(w*l,-d/2,v*l);var x=new A(w*g,d/2,v*g);h.lerp(y,x,e/b);k.sub2(x,y).normalize();w=new A(v,0,-w);m.cross(w,k).normalize();n.push(h.x,h.y,h.z);p.push(m.x,m.y,m.z);x=f/a;y=e/b;t.push(x,y);w=y;y=x;x=w;x/=3;x=.875*x+.0625;y=.875*y+.0625;r.push(x,y);e<b&&f<a&&(w=e*(a+1)+f,v=e*(a+1)+(f+1),x=(e+1)*(a+1)+f,y=(e+1)*(a+1)+(f+1),u.push(w,v,x),u.push(v,y,x))}if(c){l=Math.floor(a/2);e=d/2;
for(d=0;d<=l;d++)for(v=d*Math.PI*.5/l,w=Math.sin(v),v=Math.cos(v),h=0;h<=a;h++)c=2*h*Math.PI/a-Math.PI/2,x=Math.sin(c),c=Math.cos(c),c*=w,f=v,m=x*w,x=1-h/a,y=1-d/l,n.push(c*g,f*g+e,m*g),p.push(c,f,m),t.push(x,y),x/=3,y/=3,x=.875*x+.0625,y=.875*y+.0625,x+=1/3,r.push(x,y);k=(b+1)*(a+1);for(d=0;d<l;++d)for(h=0;h<a;++h)w=d*(a+1)+h,v=w+a+1,u.push(k+w+1,k+v,k+w),u.push(k+w+1,k+v+1,k+v);for(d=0;d<=l;d++)for(v=.5*Math.PI+d*Math.PI*.5/l,w=Math.sin(v),v=Math.cos(v),h=0;h<=a;h++)c=2*h*Math.PI/a-Math.PI/2,x=
Math.sin(c),c=Math.cos(c),c*=w,f=v,m=x*w,x=1-h/a,y=1-d/l,n.push(c*g,f*g-e,m*g),p.push(c,f,m),t.push(x,y),x/=3,y/=3,x=.875*x+.0625,y=.875*y+.0625,x+=2/3,r.push(x,y);k=(b+1)*(a+1)+(a+1)*(l+1);for(d=0;d<l;++d)for(h=0;h<a;++h)w=d*(a+1)+h,v=w+a+1,u.push(k+w+1,k+v,k+w),u.push(k+w+1,k+v+1,k+v)}else{k=(b+1)*(a+1);if(0<l)for(e=0;e<a;e++)v=e/a*2*Math.PI,c=Math.sin(v),f=-d/2,m=Math.cos(v),x=1-(c+1)/2,y=(m+1)/2,n.push(c*l,f,m*l),p.push(0,-1,0),t.push(x,y),x/=3,y/=3,x=.875*x+.0625,y=.875*y+.0625,x+=1/3,r.push(x,
y),1<e&&u.push(k,k+e,k+e-1);k+=a;if(0<g)for(e=0;e<a;e++)v=e/a*2*Math.PI,c=Math.sin(v),f=d/2,m=Math.cos(v),x=1-(c+1)/2,y=(m+1)/2,n.push(c*g,f,m*g),p.push(0,1,0),t.push(x,y),x/=3,y/=3,x=.875*x+.0625,y=.875*y+.0625,x+=2/3,r.push(x,y),1<e&&u.push(k,k+e-1,k+e)}return{positions:n,normals:p,uvs:t,uvs1:r,indices:u}}function pg(l,g){var d=g&&(g.radius||g.baseRadius);d=void 0!==d?d:.5;var b=g&&void 0!==g.calculateTangents?g.calculateTangents:!1;g=og(d,d,g&&void 0!==g.height?g.height:1,g&&void 0!==g.heightSegments?
g.heightSegments:5,g&&void 0!==g.capSegments?g.capSegments:20,!1);b&&(g.tangents=b(g.positions,g.normals,g.uvs,g.indices));return kb(l,g.positions,g)}function qg(l,g){var d=g&&void 0!==g.radius?g.radius:.3,b=g&&void 0!==g.calculateTangents?g.calculateTangents:!1;g=og(d,d,(g&&void 0!==g.height?g.height:1)-2*d,g&&void 0!==g.heightSegments?g.heightSegments:1,g&&void 0!==g.sides?g.sides:20,!0);b&&(g.tangents=b(g.positions,g.normals,g.uvs,g.indices));return kb(l,g.positions,g)}function rg(l,g){var d=g&&
void 0!==g.calculateTangents?g.calculateTangents:!1;g=og(g&&void 0!==g.baseRadius?g.baseRadius:.5,g&&void 0!==g.peakRadius?g.peakRadius:0,g&&void 0!==g.height?g.height:1,g&&void 0!==g.heightSegments?g.heightSegments:5,g&&void 0!==g.capSegments?g.capSegments:18,!1);d&&(g.tangents=d(g.positions,g.normals,g.uvs,g.indices));return kb(l,g.positions,g)}function sg(l,g){var d=g&&void 0!==g.radius?g.radius:.5,b=g&&void 0!==g.latitudeBands?g.latitudeBands:16,a=g&&void 0!==g.longitudeBands?g.longitudeBands:
16;g=g&&void 0!==g.calculateTangents?g.calculateTangents:!1;var c,e=[],f=[],h=[],k=[];for(c=0;c<=b;c++){var m=c*Math.PI/b;var n=Math.sin(m);var p=Math.cos(m);for(m=0;m<=a;m++){var t=2*m*Math.PI/a-Math.PI/2;var r=Math.sin(t);t=Math.cos(t);t*=n;var u=p;r*=n;var v=1-m/a;var w=1-c/b;e.push(t*d,u*d,r*d);f.push(t,u,r);h.push(v,w)}}for(c=0;c<b;++c)for(m=0;m<a;++m)d=c*(a+1)+m,n=d+a+1,k.push(d+1,n,d),k.push(d+1,n+1,n);b={normals:f,uvs:h,uvs1:h,indices:k};g&&(b.tangents=g(e,f,h,k));return kb(l,e,b)}function tg(l,
g){var d=g&&void 0!==g.halfExtents?g.halfExtents:new S(.5,.5),b=g&&void 0!==g.widthSegments?g.widthSegments:5,a=g&&void 0!==g.lengthSegments?g.lengthSegments:5;g=g&&void 0!==g.calculateTangents?g.calculateTangents:!1;var c,e,f=[],h=[],k=[],m=[],n=0;for(c=0;c<=b;c++)for(e=0;e<=a;e++){var p=-d.x+2*d.x*c/b;var t=-(-d.y+2*d.y*e/a);var r=c/b;var u=e/a;f.push(p,0,t);h.push(0,1,0);k.push(r,u);c<b&&e<a&&(m.push(n+a+1,n+1,n),m.push(n+a+1,n+a+2,n+1));n++}d={normals:h,uvs:k,uvs1:k,indices:m};g&&(d.tangents=
g(f,h,k,m));return kb(l,f,d)}function Oe(l,g){var d=g&&void 0!==g.halfExtents?g.halfExtents:new A(.5,.5,.5),b=g&&void 0!==g.widthSegments?g.widthSegments:1,a=g&&void 0!==g.lengthSegments?g.lengthSegments:1,c=g&&void 0!==g.heightSegments?g.heightSegments:1;g=g&&void 0!==g.calculateTangents?g.calculateTangents:!1;var e=[new A(-d.x,-d.y,d.z),new A(d.x,-d.y,d.z),new A(d.x,d.y,d.z),new A(-d.x,d.y,d.z),new A(d.x,-d.y,-d.z),new A(-d.x,-d.y,-d.z),new A(-d.x,d.y,-d.z),new A(d.x,d.y,-d.z)],f=[[0,1,3],[4,5,
7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],h=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],k=[],m=[],n=[],p=[],t=[],r=0;d=function(u,v,w){var y,x;for(y=0;y<=v;y++)for(x=0;x<=w;x++){var z=new A;var B=new A;var C=new A,D=new A;z.lerp(e[f[u][0]],e[f[u][1]],y/v);B.lerp(e[f[u][0]],e[f[u][2]],x/w);C.sub2(B,e[f[u][0]]);D.add2(z,C);z=y/v;B=x/w;k.push(D.x,D.y,D.z);m.push(h[u][0],h[u][1],h[u][2]);n.push(z,B);z/=3;B/=3;z=.875*z+.0625;B=.875*B+.0625;z+=u%3/3;B+=Math.floor(u/3)/3;p.push(z,B);y<v&&x<w&&(t.push(r+
w+1,r+1,r),t.push(r+w+1,r+w+2,r+1));r++}};d(0,b,c);d(1,b,c);d(2,b,a);d(3,b,a);d(4,a,c);d(5,a,c);b={normals:m,uvs:n,uvs1:p,indices:t};g&&(b.tangents=g(k,m,n,t));return kb(l,k,b)}function Si(l,g){for(var d=null,b=0;b<Md.length;b++)Md[b].type===g&&Md[b].device===l&&(d=Md[b].primData);if(!d){switch(g){case "box":d=Oe(l,{halfExtents:new A(.5,.5,.5)});b={x:2,y:2,z:2,uv:2/3};break;case "capsule":d=qg(l,{radius:.5,height:2});b={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case "cone":d=rg(l,{baseRadius:.5,
peakRadius:0,height:1});b={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case "cylinder":d=pg(l,{radius:.5,height:1});b={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case "plane":d=tg(l,{halfExtents:new S(.5,.5),widthSegments:1,lengthSegments:1});b={x:0,y:1,z:0,uv:1};break;case "sphere":d=sg(l,{radius:.5});b={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;default:throw Error("Invalid primitive type: "+g);}d={mesh:d,area:b};Md.push({type:g,device:l,primData:d})}return d}function Pe(){return"undefined"!==
typeof Audio}function wb(){return!("undefined"===typeof AudioContext&&"undefined"===typeof webkitAudioContext)}function Nd(l){var g="_"+l;ug.push(g);Object.defineProperty(Ti.prototype,l,{get:function(){return this[g]||null},set:function(d){if(!!this[g]!==!!d||this[g]&&d&&this[g].hash!==d.hash)this[g]=d?{url:d.url,filename:d.filename,size:d.size,hash:d.hash,opt:d.opt||0}:null,this.asset.file&&(this.asset.fire("change",this.asset,"file",this.asset._file,this.asset._file),this.asset.reload())}})}function Ui(l){function g(c){this._fields=
c}function d(c){this._arrayBuffer=c||new ArrayBuffer(0);this._bufferView=new DataView(this._arrayBuffer);this._paxHeader=this._globalPaxHeader=null;this._bytesRead=0}if("undefined"!==typeof TextDecoder){var b=new TextDecoder("utf-8");var a=new TextDecoder("windows-1252")}else console.warn("TextDecoder not supported - pc.Untar module will not work");g.parse=function(c,e,f){for(var h=new Uint8Array(c,e,f),k=0,m=[];k<f;){var n;for(n=k;n<f&&32!=h[n];n++);if(n>=f)throw Error("Invalid PAX header data format.");
var p=parseInt(b.decode(new Uint8Array(c,e+k,n-k)),10);n=b.decode(new Uint8Array(c,e+n+1,p-(n-k)-2)).split("=");if(2!==n.length)throw Error("Invalid PAX header data format.");0===n[1].length&&(n[1]=null);m.push({name:n[0],value:n[1]});k+=p}return new g(m)};g.prototype.applyHeader=function(c){for(var e=0;e<this._fields.length;e++){var f=this._fields[e].name,h=this._fields[e].value;"path"===f&&(f="name");null===h?delete c[f]:c[f]=h}};l||(Vi=d);d.prototype._hasNext=function(){return this._bytesRead+
4<this._arrayBuffer.byteLength&&0!==this._bufferView.getUint32(this._bytesRead)};d.prototype._readNextFile=function(){var c=new DataView(this._arrayBuffer,this._bytesRead,512),e=a.decode(c);this._bytesRead+=512;c=e.substr(0,100).replace(/\0/g,"");var f=e.substr(257,6),h=parseInt(e.substr(124,12),8),k=e.substr(156,1),m=this._bytesRead,n=null,p=!1;switch(k){case "0":case "":p=!0;l||(n=new Blob([this._arrayBuffer.slice(this._bytesRead,this._bytesRead+h)]),n=URL.createObjectURL(n));break;case "g":this._globalPaxHeader=
g.parse(this._arrayBuffer,this._bytesRead,h);break;case "x":this._paxHeader=g.parse(this._arrayBuffer,this._bytesRead,h)}this._bytesRead+=h;k=h%512;0!==k&&(this._bytesRead+=512-k);if(!p)return null;-1!==f.indexOf("ustar")&&(e=e.substr(345,155).replace(/\0/g,""),0<e.length&&(c=e.trim()+c.trim()));c={name:c,start:m,size:h,url:n};this._globalPaxHeader&&this._globalPaxHeader.applyHeader(c);this._paxHeader&&(this._paxHeader.applyHeader(c),this._paxHeader=null);return c};d.prototype.untar=function(c){if(!b)return console.error("Cannot untar because TextDecoder interface is not available for this platform."),
[];for(var e=[];this._hasNext();){var f=this._readNextFile();f&&(c&&f.name&&(f.name=c+f.name),e.push(f))}return e};l&&(self.onmessage=function(c){var e=c.data.id;try{var f=(new d(c.data.arrayBuffer)).untar(c.data.prefix);postMessage({id:e,files:f,arrayBuffer:c.data.arrayBuffer},[c.data.arrayBuffer])}catch(h){postMessage({id:e,error:h.toString()})}})}function Wi(l,g,d,b){var a;if(g instanceof Ba){var c=g.c,e;for(e in c){var f=c[e],h=f.system.getPropertiesOfType("entity");var k=0;for(a=h.length;k<a;k++){var m=
h[k].name,n=f[m];l.findByGuid(n)&&((n=b[n].getGuid())?d.c[e][m]=n:console.warn("Could not find corresponding entity id when resolving duplicated entity references"))}}c.script&&!d._app.useLegacyScriptAttributeCloning&&d.script.resolveDuplicatedEntityReferenceProperties(c.script,b);g=g.children.filter(function(p){return p instanceof Ba});d=d.children.filter(function(p){return p instanceof Ba});k=0;for(a=g.length;k<a;k++)Wi(l,g[k],d[k],b)}}function vg(l){3>l.version&&(2>l.version&&(l.info.maps=l.info.maps||
[{width:l.info.width,height:l.info.height}]),l.chars=Object.keys(l.chars||{}).reduce(function(g,d){var b=l.chars[d];d=void 0!==b.letter?b.letter:Eb.fromCodePoint(d);2>l.version&&(b.map=b.map||0);g[d]=b;return g},{}),l.version=3);return l}function Od(){this.valid=this.removeInvalid=!0;this.enumValidators={occludeSpecular:this._createEnumValidator([0,1,2]),cull:this._createEnumValidator([0,1,2,3]),blendType:this._createEnumValidator([0,1,2,3,4,5,6,7,8,9,10]),shadingModel:this._createEnumValidator([0,
1])}}function En(l){var g=l.vertices,d=l.skins,b=l.meshes,a=l.meshInstances;for(l=0;l<b.length;l++)b[l].vertices=g[b[l].vertices],void 0!==b[l].skin&&(b[l].skin=d[b[l].skin]);for(l=0;l<a.length;l++)a[l].mesh=b[a[l].mesh]}function Fn(l){var g=l.vertices,d=l.skins,b=l.meshes,a=l.meshInstances;for(l=0;l<b.length;l++)b[l].vertices=g.indexOf(b[l].vertices),void 0!==b[l].skin&&(b[l].skin=d.indexOf(b[l].skin));for(l=0;l<a.length;l++)a[l].mesh=b.indexOf(a[l].mesh)}function Xi(l,g,d){var b,a;En(l);var c=l.vertices,
e=l.skins,f=l.meshes,h=l.meshInstances,k=function(G){var J=new Gn;J.index=G;return J};for(b=e.length-1;0<=b;b--)if(e[b].boneNames.length>d){var m=e.splice(b,1)[0],n=[];for(a=0;a<f.length;a++)f[a].skin===m&&n.push(f[a]);for(a=0;a<n.length;a++){var p=f.indexOf(n[a]);-1!==p&&f.splice(p,1)}if(0===n.length)throw Error("partitionSkin: There should be at least one mesh that references a skin");var t=n[0].vertices;for(a=1;a<n.length;a++)if(n[a].vertices!==t)throw Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");
var r=[],u=[];var v=[];var w=0;for(a=0;a<n.length;a++){var y=n[a];for(var x=y.indices,z=y.base;z<y.base+y.count;){p=x[z++];u[0]=k(p);v[0]=p;p=x[z++];u[1]=k(p);v[1]=p;p=x[z++];u[2]=k(p);v[2]=p;for(var B=!1,C=w;C<r.length;C++)if(p=r[C],p.addPrimitive(u,v,t,d)){B=!0;break}B||(p=new Hn,p.originalMesh=y,p.addPrimitive(u,v,t,d),r.push(p))}w=r.length}y=[];n=[];for(a=0;a<r.length;a++)if(p=r[a],p.vertices.length&&p.indices.length){u=y.length;v=p.vertices.length;w=n.length;x=p.indices.length;p.partition=a;
p.vertexStart=u;p.vertexCount=v;p.indexStart=w;p.indexCount=x;z=0;for(B=u;z<v;)y[B++]=p.vertices[z++];z=0;for(B=w;z<x;)n[B++]=p.indices[z++]+u}u=[];for(a=0;a<r.length;a++){p=r[a];w=[];x=[];for(v=0;v<p.boneIndices.length;v++)w.push(m.inverseBindMatrices[p.boneIndices[v]]),x.push(m.boneNames[p.boneIndices[v]]);p={inverseBindMatrices:w,boneNames:x};u.push(p);e.push(p)}var D;m={};for(D in t)m[D]={components:t[D].components,data:[],type:t[D].type};for(D in t)if("blendIndices"===D)for(p=m[D].data,a=0;a<
y.length;a++)v=y[a].boneIndices,p.push(v[0],v[1],v[2],v[3]);else for(a=t[D],w=a.data,x=a.components,a=0;a<y.length;a++)for(p=y[a].index,v=0;v<x;v++)m[D].data.push(w[p*x+v]);c[c.indexOf(t)]=m;for(a=0;a<r.length;a++)for(p=r[a],y={aabb:{min:[0,0,0],max:[0,0,0]},vertices:m,skin:u[a],indices:n.splice(0,p.indexCount),type:"triangles",base:0,count:p.indexCount},f.push(y),v=h.length-1;0<=v;v--)h[v].mesh===p.originalMesh&&(h.push({mesh:y,node:h[v].node}),g&&g.push({material:g[v].material,path:g[v].path}));
for(a=0;a<r.length;a++)for(p=r[a],v=h.length-1;0<=v;v--)h[v].mesh===p.originalMesh&&(h.splice(v,1),g&&g.splice(v,1))}Fn(l)}function Qe(l){this.resource&&(l=l.resource,l=l.renders&&l.renders[this.data.renderIndex])&&(this.resource.meshes=l.resource)}function Yi(l){this.registry.off("load:"+l.id,Qe,this);this.registry.on("load:"+l.id,Qe,this);this.registry.off("remove:"+l.id,Zi,this);this.registry.once("remove:"+l.id,Zi,this);l.resource?Qe.call(this,l):this.registry.load(l)}function Zi(l){this.registry.off("load:"+
l.id,Qe,this);this.resource&&(this.resource.meshes=null)}function wg(l){this.resource&&(this.resource.atlas=l.resource)}function xg(l){this.registry.load(l)}function In(){var l={astc:10,dxt:2,etc2:0,etc1:0,pvr:8,atc:11,none:14},g={astc:10,dxt:3,etc2:1,etc1:16,pvr:9,atc:12,none:16},d={0:21,1:23,2:8,3:10,8:26,9:27,10:28,11:29,12:30,13:7,14:3,16:5},b="undefined"!==typeof performance,a=function(k,m,n,p,t){var r=b?performance.now():0,u=new k.BasisFile(new Uint8Array(p));k=u.getImageWidth(0,0);p=u.getImageHeight(0,
0);var v=u.getNumImages(),w=u.getNumLevels(0),y=!!u.getHasAlpha();if(!(k&&p&&v&&w))throw u.close(),u.delete(),Error("Invalid image dimensions url="+m+" width="+k+" height="+p+" images="+v+" levels="+w);n=y?g[n]:l[n];if(8===n||9===n)if(0!==(k&k-1)||k!==p)n=8===n?14:13;t&&t.unswizzleGGGR&&(n=13);if(!u.startTranscoding())throw u.close(),u.delete(),Error("Failed to start transcoding url="+m);y=[];for(var x=0;x<w;++x){var z=u.getImageTranscodedSizeInBytes(0,x,n),B=new Uint8Array(z);if(!u.transcodeImage(B,
0,x,n,1,0))throw u.close(),u.delete(),Error("Failed to transcode image url="+m);if(14===n||16===n){var C=new Uint16Array(z/2);for(v=0;v<z/2;++v)C[v]=B[2*v]+256*B[2*v+1];B=C}y.push(B)}u.close();u.delete();if(t&&t.unswizzleGGGR)for(n=14,v=0;v<y.length;++v){t=v;u=y[v];for(w=0;w<u.length;w+=4)z=u[w+3],x=u[w+1],u[w+0]=z,z=2/255*z-1,x=2/255*x-1,u[w+2]=Math.max(0,Math.min(255,Math.floor(127.5*(Math.sqrt(1-Math.min(1,z*z+x*x))+1)))),u[w+3]=255;w=new Uint16Array(u.length/4);for(x=0;x<u.length;x+=4)w[x/4]=
(u[x+0]&248)<<8|(u[x+1]&252)<<3|u[x+2]>>3;y[t]=w}return{format:d[n],width:k+3&-4,height:p+3&-4,levels:y,cubemap:!1,mipmaps:!0,transcodeTime:b?performance.now()-r:0,url:m}},c=null,e=[],f=function(k,m,n,p){try{var t=a(c,k,m,n,p);t.levels=t.levels.map(function(r){return r.buffer});self.postMessage({url:k,data:t},t.levels)}catch(r){self.postMessage({url:k.toString(),err:r.toString()})}},h=function(k){var m=function(n,p){WebAssembly.instantiate(k,n).then(function(t){p(t)});return{}};self.BASIS(k?{instantiateWasm:m}:
null).then(function(n){c=n;c.initializeBasis();for(n=0;n<e.length;++n)f(e[n].url,e[n].format,e[n].data,e[n].options);e=[]})};self.onmessage=function(k){k=k.data;switch(k.type){case "init":h(k.module);break;case "transcode":c?f(k.url,k.format,k.data,k.options):e.push(k)}}}function yg(){if(!zg){var l=qa.getApplication().graphicsDevice;zg=l.extCompressedTextureASTC?"astc":l.extCompressedTextureS3TC?"dxt":l.extCompressedTextureETC?"etc2":l.extCompressedTextureETC1?"etc1":l.extCompressedTexturePVRTC?"pvr":
l.extCompressedTextureATC?"atc":"none"}return zg}function Jn(l){var g=l.data.url,d=l.data.err;l=l.data.data;var b=Pd[g];if(b){var a;if(d)for(a=0;a<b.length;++a)b[a](d);else{l.levels=3===l.format||5===l.format?l.levels.map(function(c){return new Uint16Array(c)}):l.levels.map(function(c){return new Uint8Array(c)});for(a=0;a<b.length;++a)b[a](null,l);delete Pd[g]}}else console.error("internal logical error encountered in basis transcoder")}function $i(l,g,d,b){Pd.hasOwnProperty(l)?Pd[l].push(d):(Pd[l]=
[d],Qd.postMessage({type:"transcode",url:l,format:yg(),data:g,options:b},[g]))}function Ag(l,g,d){l=["/* basis.js */",l,"/* mappings */\nvar PIXELFORMAT_ETC1 = 21;\nvar PIXELFORMAT_ETC2_RGBA = 23;\nvar PIXELFORMAT_DXT1 = 8;\nvar PIXELFORMAT_DXT5 = 10;\nvar PIXELFORMAT_PVRTC_4BPP_RGB_1 = 26;\nvar PIXELFORMAT_PVRTC_4BPP_RGBA_1 = 27;\nvar PIXELFORMAT_ASTC_4x4 = 28;\nvar PIXELFORMAT_ATC_RGB = 29;\nvar PIXELFORMAT_ATC_RGBA = 30;\nvar PIXELFORMAT_R8_G8_B8_A8 = 7;\nvar PIXELFORMAT_R5_G6_B5 = 3;\nvar PIXELFORMAT_R4_G4_B4_A4 = 5;\n\n/* worker */",
"("+In.toString()+")()\n\n"].join("\n");l=new Blob([l],{type:"application/javascript"});l=URL.createObjectURL(l);Qd=new Worker(l);Qd.addEventListener("message",Jn);Qd.postMessage({type:"init",module:g});d&&d();for(g=0;g<Bg.length;++g)d=Bg[g],$i(d.url,d.data,d.callback,d.options)}function Cg(l,g,d,b){Dg&&console.warn("basis module is being downloaded more than once");Dg=!0;if(Kn){var a=null,c=null,e=function(){a&&c&&Ag(a,c,b)},f=function(){oa.get(g,{cache:!0,responseType:"arraybuffer",retry:!1},function(h,
k){k&&WebAssembly.compile(k).then(function(m){c=m;e()})})};WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(g)).then(function(h){c=h;e()}).catch(function(h){console.error(h);console.warn("compileStreaming() failed for "+g+", falling back to arraybuffer download...");f()}):f();oa.get(l,{cache:!0,responseType:"text",retry:!1},function(h,k){a=k;e()})}else oa.get(d,{cache:!0,responseType:"text",retry:!1},function(h,k){k&&Ag(k,null,b)})}function aj(l){if(Rd)Cg(Rd.glueUrl,Rd.wasmUrl,Rd.fallbackUrl,
l);else{var g=((window.config?window.config.wasmModules:window.PRELOAD_MODULES)||[]).find(function(b){return"BASIS"===b.moduleName});if(g){var d=window.ASSET_PREFIX?window.ASSET_PREFIX:"";Cg(d+g.glueUrl,d+g.wasmUrl,d+g.fallbackUrl,l)}}}function bj(l,g,d,b){Qd?$i(l,g,d,b):(Bg.push({url:l,data:g,callback:d,options:b}),Dg||aj())}function Ln(l,g){if(!l)return l;switch(g){case "rgb":return l instanceof Q?l.clone():new Q(l[0],l[1],l[2]);case "rgba":return l instanceof Q?l.clone():new Q(l[0],l[1],l[2],l[3]);
case "vec2":return l instanceof S?l.clone():new S(l[0],l[1]);case "vec3":return l instanceof A?l.clone():new A(l[0],l[1],l[2]);case "vec4":return l instanceof Z?l.clone():new Z(l[0],l[1],l[2],l[3]);case "boolean":case "number":case "string":return l;case "entity":return l;default:throw Error("Could not convert unhandled type: "+g);}}function Mn(l,g,d,b){var a=Math.min(g,d);g=Math.max(g,d);return b?l>=a&&l<=g:l>a&&l<g}function cj(l,g){return Math.atan2(l.x*g.y-l.y*g.x,l.x*g.x+l.y*g.y)}function Re(l,
g,d){return l<=g?g:l>=d?d:l}function dj(l,g){for(var d in g)if(g.hasOwnProperty(d)){var b=g[d];b instanceof Object?(l.hasOwnProperty(d)||(l[d]={}),dj(l[d],g[d])):l[d]=b}}function Nn(l){if(0===l.length)return null;for(var g={},d=0;d<l.length;++d){var b=l[d],a={};a[b.name]={value:b.value,attributes:b.attributes};dj(g,a)}return g}function On(l,g){function d(k){f=f.filter(function(m){return void 0===k.find(function(n){return n===m})})}function b(k){for(var m=0;m<k.length;++m)f.push(k[m])}var a;if(0===
l.length)return null;var c={};for(a=0;a<l.length;++a){var e=l[a];c.hasOwnProperty(e.start)?null===c[e.start].open?c[e.start].open=[e]:c[e.start].open.push(e):c[e.start]={open:[e],close:null};c.hasOwnProperty(e.end)?null===c[e.end].close?c[e.end].close=[e]:c[e.end].close.push(e):c[e.end]={open:null,close:[e]}}var f=[];e=Object.keys(c).sort(function(k,m){return k-m});l=[];for(a=0;a<e.length;++a){var h=c[e[a]];null!==h.close&&d(h.close);null!==h.open&&b(h.open);l.push({start:e[a],tags:Nn(f)})}c=[];e=
null;for(a=0;a<l.length;++a){for(h=l[a];c.length<h.start;)c.push(e?e.tags:null);e=h}for(;c.length<g;)c.push(null);return c}function Pn(l){var g=new Qn(l),d=[],b=[];if(!g.parse(d,b))return console.warn(g.error()),{symbols:l,tags:null};if(g=b.find(function(a){return null===a.end}))return console.warn("Markup error: found unclosed tag='"+g.name+"'"),{symbols:l,tags:null};l=On(b,d.length);return{symbols:d,tags:l}}function Ac(l){var g="_"+l;Object.defineProperty(Se.prototype,l,{get:function(){return this[g]},
set:function(d){this[g]!==d&&(this[g]=d,this.fire("resize"))}})}function ej(l){function g(y){y=y.entity.layoutchild;return!y||!y.enabled||!y.excludeFromLayout}function d(y,x,z){switch(y){case 0:return Za.NONE;case 1:return x<z?Za.APPLY_STRETCHING:Za.NONE;case 2:return x>=z?Za.APPLY_SHRINKING:Za.NONE;case 3:return x<z?Za.APPLY_STRETCHING:x>=z?Za.APPLY_SHRINKING:Za.NONE;default:throw Error("Unrecognized fitting mode: "+y);}}function b(y,x){return k(y,x.size)+(y.length-1)*u.spacing[x.axis]}function a(y,
x,z){var B=n(y,z.maxSize),C=m(y,z.fittingProportion),D=r(C,B);x=cb[z.axis]-x;for(var G=0;G<y.length;++G){var J=B[G],E=e(J,x,C,D),H=y[J][z.size]+E,P=Math.min(H,y[J][z.maxSize]);y[J][z.size]=P;x-=E-Math.max(H-P,0)}}function c(y,x,z){var B=n(y,z.minSize,!0);var C=m(y,z.fittingProportion);if(1===C.length)C=[1];else{for(var D=[],G=C.length,J=0;J<G;++J)D.push((1-C[J])/(G-1));C=D}D=r(C,B);x-=cb[z.axis];for(G=0;G<y.length;++G){J=B[G];var E=e(J,x,C,D),H=y[J][z.size]-E,P=Math.max(H,y[J][z.minSize]);y[J][z.size]=
P;x-=E-Math.max(P-H,0)}}function e(y,x,z,B){z=z[y];y=B[y];return 1E-5>Math.abs(z)&&1E-5>Math.abs(y)?x:x*z/y}function f(y){for(var x=[],z=0;z<y.length;++z){var B=y[z],C=Math.max(h(B,"minWidth"),0),D=Math.max(h(B,"minHeight"),0),G=Math.max(h(B,"maxWidth"),C),J=Math.max(h(B,"maxHeight"),D);var E=h(B,"width");E=Math.min(Math.max(E,C),G);var H=h(B,"height");H=Math.min(Math.max(H,D),J);var P=h(B,"fitWidthProportion");B=h(B,"fitHeightProportion");x.push({minWidth:C,minHeight:D,maxWidth:G,maxHeight:J,width:E,
height:H,fitWidthProportion:P,fitHeightProportion:B})}return x}function h(y,x){var z=y.entity.layoutchild;return z&&z.enabled&&void 0!==z[x]&&null!==z[x]?z[x]:void 0!==y[x]?y[x]:Rn[x]}function k(y,x){return y.reduce(function(z,B){return z+B[x]},0)}function m(y,x){var z=k(y,x),B=[],C=y.length,D;if(0===z)for(D=0;D<C;++D)B.push(1/C);else for(D=0;D<C;++D)B.push(y[D][x]/z);return B}function n(y,x,z){y.forEach(p);return y.slice().sort(function(B,C){return z?C[x]-B[x]:B[x]-C[x]}).map(t)}function p(y,x){y.index=
x}function t(y){return y.index}function r(y,x){var z=[];z[x[y.length-1]]=y[x[y.length-1]];for(var B=y.length-2;0<=B;--B)z[x[B]]=z[x[B+1]]+y[x[B]];return z}var u,v=fj[l],w=fj[Sn[l]];return function(y,x){y=y.filter(g);u=x;cb.x=u.containerSize.x-u.padding.x-u.padding.z;cb.y=u.containerSize.y-u.padding.y-u.padding.w;x=y;for(var z=0;z<x.length;++z){var B=x[z],C=B.anchor;if(0!==C.x||0!==C.y||0!==C.z||0!==C.w)B.anchor=Z.ZERO}if(u.wrap){x=[[]];z=f(y);B=0;C=2===u[v.fitting];for(var D=0;D<y.length;++D){0<x[x.length-
1].length&&(B+=u.spacing[v.axis]);var G=z[D][v.size];B+=G;!C&&B>cb[v.axis]&&0!==x[x.length-1].length&&(B=G,x.push([]));x[x.length-1].push(y[D]);C&&B>cb[v.axis]&&D!==y.length-1&&(B=0,x.push([]))}y=x}else y=[y];x=0===u.orientation&&u.reverseX||1===u.orientation&&u.reverseY;z=0===u.orientation&&u.reverseY||1===u.orientation&&u.reverseX;if(x)for(B=0;B<y.length;++B)x&&y[B].reverse();z&&y.reverse();x=[];for(z=0;z<y.length;++z)B=f(y[z]),C=b(B,v),D=d(u[v.fitting],C,cb[v.axis]),D===Za.APPLY_STRETCHING?a(B,
C,v):D===Za.APPLY_SHRINKING&&c(B,C,v),x.push(B);G=[];D=[];for(B=0;B<y.length;++B){C=y[B];C.largestElement=null;C.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(z=0;z<C.length;++z){var J=x[B][z];J[w.size]>C.largestSize[w.size]&&(C.largestElement=C[z],C.largestSize=J)}G.push(C.largestElement);D.push(C.largestSize)}z=b(D,w);B=d(u[w.fitting],z,cb[w.axis]);B===Za.APPLY_STRETCHING?a(D,z,w):B===Za.APPLY_SHRINKING&&c(D,z,w);for(B=0;B<y.length;++B)for(C=y[B],z=0;z<C.length;++z)D=
x[B][z],G=1===y.length?cb[w.axis]:C.largestSize[w.size],J=d(u[w.fitting],D[w.size],G),J===Za.APPLY_STRETCHING?D[w.size]=Math.min(G,D[w.maxSize]):J===Za.APPLY_SHRINKING&&(D[w.size]=Math.max(G,D[w.minSize]));a:{z={};z[v.axis]=0;z[w.axis]=0;y[v.size]=Number.NEGATIVE_INFINITY;B=[];for(C=0;C<y.length;++C){D=y[C];if(0===D.length){z=void 0;break a}G=[];J=x[C];for(var E=0;E<D.length;++E){var H=D[E],P=J[E];z[w.axis]-=-P[w.size]*H.pivot[w.axis];z[v.axis]-=-P[v.size]*H.pivot[v.axis];G[E]={};G[E][v.axis]=z[v.axis];
G[E][w.axis]=z[w.axis];z[w.axis]+=-P[w.size]*H.pivot[w.axis];z[v.axis]+=P[v.size]*(1-H.pivot[v.axis])+u.spacing[v.axis]}D[v.size]=z[v.axis]-u.spacing[v.axis];D[w.size]=D.largestSize[w.size];y[v.size]=Math.max(y[v.size],D[v.size]);z[v.axis]=0;z[w.axis]+=D[w.size]+u.spacing[w.axis];B.push(G)}y[w.size]=z[w.axis]-u.spacing[w.axis];z=B}B=z;C=u.alignment[v.axis];D=u.alignment[w.axis];G=u.padding[v.axis];J=u.padding[w.axis];for(E=0;E<y.length;++E){H=y[E];P=x[E];for(var Y=B[E],L=(cb[v.axis]-H[v.size])*C+
G,V=(cb[w.axis]-y[w.size])*D+J,wa=0;wa<H.length;++wa){var xa=(H[w.size]-P[wa][w.size])*u.alignment[w.axis];Y[wa][v.axis]+=L;Y[wa][w.axis]+=V+xa}}for(B=0;B<y.length;++B)for(C=y[B],D=x[B],G=z[B],J=0;J<C.length;++J)E=C[J],E[v.calculatedSize]=D[J][v.size],E[w.calculatedSize]=D[J][w.size],0===u.orientation?E.entity.setLocalPosition(G[J][v.axis],G[J][w.axis],E.entity.getLocalPosition().z):E.entity.setLocalPosition(G[J][w.axis],G[J][v.axis],E.entity.getLocalPosition().z);x=y.width;y=y.height;return{bounds:new Z((cb.x-
x)*u.alignment.x+u.padding.x,(cb.y-y)*u.alignment.y+u.padding.y,x,y)}}}function Tn(l){return l.element}function Un(l){return l.enabled&&l.element&&l.element.enabled}function Pb(l){var g="_"+l;Object.defineProperty(Te.prototype,l,{get:function(){return this[g]},set:function(d){this[g]!==d&&(this[g]=d,this._scheduleReflow())}})}function ja(l,g,d,b){var a=Ue.prototype;$c.push(l);gj.push(g);Object.defineProperty(a,l,{get:function(){return this.data[l]},set:function(c){var e=this.data,f=e[l];if(b||f!==
c)e[l]=c,d&&d.call(this,c,f)},configurable:!0})}function Ve(l,g,d,b){var a,c;switch(g.type){case "boolean":return!!d;case "number":if("number"===typeof d)break;else{if("string"===typeof d)return d=parseInt(d,10),isNaN(d)?null:d;if("boolean"===typeof d)return 0+d}return null;case "json":b={};if(Array.isArray(g.schema))for(d&&"object"===typeof d||(d={}),a=0;a<g.schema.length;a++){var e=g.schema[a];if(e.name)if(e.array){b[e.name]=[];var f=Array.isArray(d[e.name])?d[e.name]:[];for(c=0;c<f.length;c++)b[e.name].push(Ve(l,
e,f[c]))}else c=d.hasOwnProperty(e.name)?d[e.name]:e.default,b[e.name]=Ve(l,e,c)}return b;case "asset":if(d instanceof fa)break;else{if("number"===typeof d)return l.assets.get(d)||null;if("string"===typeof d)return l.assets.get(parseInt(d,10))||null}return null;case "entity":if(d instanceof pa)break;else if("string"===typeof d)return l.getEntityFromIndex(d);return null;case "rgb":case "rgba":if(d instanceof Q)return b instanceof Q?(b.copy(d),b):d.clone();if(d instanceof Array&&3<=d.length&&4>=d.length){for(a=
0;a<d.length;a++)if("number"!==typeof d[a])return null;b||(b=new Q);b.r=d[0];b.g=d[1];b.b=d[2];b.a=3===d.length?1:d[3];return b}return"string"===typeof d&&/#([0-9abcdef]{2}){3,4}/i.test(d)?(b||(b=new Q),b.fromString(d),b):null;case "vec2":case "vec3":case "vec4":l=parseInt(g.type.slice(3),10);g=Vn[l];if(d instanceof g)return b instanceof g?(b.copy(d),b):d.clone();if(d instanceof Array&&d.length===l){for(a=0;a<d.length;a++)if("number"!==typeof d[a])return null;b||(b=new g);for(a=0;a<l;a++)b[Wn[a]]=
d[a];return b}return null;case "curve":if(d)return d instanceof db||d instanceof Qb?a=d.clone():(a=new (d.keys[0]instanceof Array?Qb:db)(d.keys),a.type=d.type),a}return d}function We(l,g){Object.defineProperty(Sd.prototype,l,{get:function(){return this[g]},set:function(d){this[g]=d;var b=this._slots,a;for(a in b){var c=b[a];if(!c.overlap){c=c.instances;for(var e=0,f=c.length;e<f;e++)c[e][l]=d}}}})}function hj(l,g){Object.defineProperty(Sd.prototype,l,{get:function(){return this[g]},set:function(d){this[g]=
d;var b=this._slots,a;for(a in b){var c=b[a];if(!c.overlap)for(var e=c.instances,f=0,h=e.length;f<h;f++)e[f][l]=c[l]*d}}})}function Sa(l,g,d,b,a,c,e){var f="_"+g+"Map",h=f+"Tiling",k=f+"Offset",m=f.substring(1)+"Transform",n=m+"Uniform",p=f+"Uv",t=f+"Channel",r="_"+g+"VertexColor",u="_"+g+"VertexColorChannel",v="_"+g+"Mode";l[f]=null;l[h]=new S(1,1);l[k]=new S(0,0);l[m]=null;l[n]=null;l[p]=d;0<b&&(d=a?a:1<b?"rgb":"g",l[t]=d,c&&(l[u]=d));c&&(l[r]=!1);e&&(l[v]="mul");Fb[g]=b;Object.defineProperty(ma.prototype,
f.substring(1),{get:function(){return this[f]},set:function(w){var y=this[f];!!y^!!w&&(this.dirtyShader=!0);y&&w&&(y.type!==w.type||y.fixCubemapSeams!==w.fixCubemapSeams||y.format!==w.format)&&(this.dirtyShader=!0);this[f]=w}});l=h.substring(1);g=k.substring(1);Object.defineProperty(ma.prototype,l,{get:function(){return this[h]},set:function(w){this.dirtyShader=!0;this[h]=w}});Bc[l]=function(w,y,x){w=w._updateMapTransform(x?w[m]:null,y,w[k]);return{name:"texture_"+m,value:w.data}};Object.defineProperty(ma.prototype,
g,{get:function(){return this[k]},set:function(w){this.dirtyShader=!0;this[k]=w}});Bc[g]=function(w,y,x){w=w._updateMapTransform(x?w[m]:null,w[h],y);return{name:"texture_"+m,value:w.data}};Object.defineProperty(ma.prototype,p.substring(1),{get:function(){return this[p]},set:function(w){this[p]!==w&&(this.dirtyShader=!0);this[p]=w}});Object.defineProperty(ma.prototype,t.substring(1),{get:function(){return this[t]},set:function(w){this[t]!==w&&(this.dirtyShader=!0);this[t]=w}});c&&(Object.defineProperty(ma.prototype,
r.substring(1),{get:function(){return this[r]},set:function(w){this.dirtyShader=!0;this[r]=w}}),Object.defineProperty(ma.prototype,u.substring(1),{get:function(){return this[u]},set:function(w){this[u]!==w&&(this.dirtyShader=!0);this[u]=w}}));e&&Object.defineProperty(ma.prototype,v.substring(1),{get:function(){return this[v]},set:function(w){this.dirtyShader=!0;this[v]=w}});Ha.push(f.substring(1));Ha.push(h.substring(1));Ha.push(k.substring(1));Ha.push(p.substring(1));Ha.push(t.substring(1));c&&(Ha.push(r.substring(1)),
Ha.push(u.substring(1)));e&&Ha.push(v.substring(1));Eg.push(m)}function Xe(l,g,d,b){var a="_"+g,c=g+"Uniform",e=g+"Intensity",f="_"+e;l[a]=d;l[c]=new Float32Array(3);Object.defineProperty(ma.prototype,g,{get:function(){this.dirtyShader=this.dirtyColor=!0;return this[a]},set:function(h){var k=this[a];(0===k.r&&0===k.g&&0===k.b||1===k.r&&1===k.g&&1===k.b)^(0===h.r&&0===h.g&&0===h.b||1===h.r&&1===h.g&&1===h.b)&&(this.dirtyShader=!0);this.dirtyColor=!0;this[a]=h}});Ha.push(g);Fg.push(c);Ye.push(g);Bc[g]=
function(h,k,m){m=m?h[c]:new Float32Array(3);var n=!1;h.useGammaTonemap&&(n=(h._scene||qa.getApplication().scene).gammaCorrection);for(var p=0;3>p;p++)m[p]=n?Math.pow(k.data[p],2.2):k.data[p],b&&(m[p]*=h[f]);return{name:"material_"+g,value:m}};b&&(l[f]=1,Object.defineProperty(ma.prototype,e,{get:function(){return this[f]},set:function(h){var k=this[f];(0===k||1===k)^(0===h||1===h)&&(this.dirtyShader=!0);this.dirtyColor=!0;this[f]=h}}),Ha.push(e),Bc[e]=function(h,k,m){k=m?h[c]:new Float32Array(3);
m=!1;h.useGammaTonemap&&(m=(h._scene||qa.getApplication().scene).gammaCorrection);for(var n=0;3>n;n++)k[n]=m?Math.pow(h[a].data[n],2.2):h[a].data[n],k[n]*=h[f];return{name:"material_"+g,value:k}})}function Na(l,g,d,b){var a="_"+g;l[a]=d;Object.defineProperty(ma.prototype,g,{get:function(){return this[a]},set:function(c){var e=this[a];e!==c&&(this[a]=c,0===e||1===e||0===c||1===c)&&(this.dirtyShader=!0)}});Ha.push(g);Bc[g]=void 0!==b?b:function(c,e,f){return{name:"material_"+g,value:e}}}function xb(l,
g,d){var b="_"+g;l[b]=null;Object.defineProperty(ma.prototype,g,{get:function(){return this[b]},set:function(a){!!this[b]^!!a&&(this.dirtyShader=!0);this[b]=a}});Ha.push(g);Bc[g]=d}function yb(l,g,d){Object.defineProperty(ma.prototype,d,{get:function(){return this[g]},set:function(b){this[g]=b}})}function Xn(l){Object.defineProperty(ma.prototype,"chunks",{get:function(){this.dirtyShader=!0;return this._chunks},set:function(g){this.dirtyShader=!0;this._chunks=g}});Ha.push("chunks")}function ya(l,g,
d){var b="_"+g;l[b]=d;Object.defineProperty(ma.prototype,g,{get:function(){return this[b]},set:function(a){this[b]!==a&&(this.dirtyShader=!0);this[b]=a}});Ha.push(g)}function ij(l,g){var d=!0,b=l.createTexture();l.bindTexture(l.TEXTURE_2D,b);l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.NEAREST);l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.NEAREST);l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE);l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE);l.texImage2D(l.TEXTURE_2D,
0,l.RGBA,2,2,0,l.RGBA,g,null);g=l.createFramebuffer();l.bindFramebuffer(l.FRAMEBUFFER,g);l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,b,0);l.checkFramebufferStatus(l.FRAMEBUFFER)!==l.FRAMEBUFFER_COMPLETE&&(d=!1);l.bindTexture(l.TEXTURE_2D,null);l.deleteTexture(b);l.bindFramebuffer(l.FRAMEBUFFER,null);l.deleteFramebuffer(g);return d}function Ze(l,g,d){var b=g._colorBuffer;if(7==b.format){var a=new Uint8Array(b.width*b.height*4),c=l.gl;l.setFramebuffer(g._glFrameBuffer);c.readPixels(0,
0,b.width,b.height,c.RGBA,c.UNSIGNED_BYTE,a);b._levels||(b._levels=[]);b._levels[0]||(b._levels[0]=[]);b._levels[0][d]=a}}function $e(l,g){return Math.atan2(l*g,Math.sqrt(l*l+g*g+1))}function jj(l,g,d){var b,a=g.width;if(7===g.format&&g._levels[0]){if(!g._levels[0][0].length)if(g._levels[0][0]instanceof HTMLImageElement){var c=l.gl;var e=Ja(l,I.fullscreenQuadVS,I.fullscreenQuadPS,"fsQuadSimple"),f=l.scope.resolve("source");for(b=0;6>b;b++){var h=g._levels[0][b],k=new X(l,{cubemap:!1,type:"default",
format:g.format,width:a,height:a,mipmaps:!1});k.name="prefiltered-cube";k._levels[0]=h;k.upload();h=new X(l,{cubemap:!1,type:"default",format:g.format,width:a,height:a,mipmaps:!1});h.name="prefiltered-cube";h=new va(l,h,{depth:!1});f.setValue(k);Ea(l,h,e);var m=new Uint8Array(a*a*4);c.bindFramebuffer(c.FRAMEBUFFER,h._glFrameBuffer);c.readPixels(0,0,k.width,k.height,c.RGBA,c.UNSIGNED_BYTE,m);g._levels[0][b]=m}}else return;e=[];for(c=0;c<a;c++)for(l=0;l<a;l++)e[c*a+l]=(new A(l/(a-1)*2-1,c/(a-1)*2-1,
1)).normalize();f=new Float32Array(27);for(b=h=0;6>b;b++)for(c=0;c<a;c++)for(l=0;l<a;l++){k=c*a+l;m=l;var n=c;var p=a;var t=(2*(m+.5)/p-1)*(1-1/p);var r=(2*(n+.5)/p-1)*(1-1/p);var u=1/p;var v=t-u;var w=r-u;t+=u;r+=u;v=$e(v,w)-$e(v,r)-$e(t,w)+$e(t,r);if(0===m&&0===n||m===p-1&&0===n||0===m&&n===p-1||m===p-1&&n===p-1)v/=3;else if(0===m||0===n||m===p-1||n===p-1)v*=.5;m=v;n=4*m/17;p=8*m/17;v=15*m/17;w=5*m/68;r=15*m/68;u=e[k];if(0==b){var y=u.z;var x=-u.y;var z=-u.x}else 1==b?(y=-u.z,x=-u.y,z=u.x):2==b?
(y=u.x,x=u.z,z=u.y):3==b?(y=u.x,x=-u.z,z=-u.y):4==b?(y=u.x,x=-u.y,z=u.z):5==b&&(y=-u.x,x=-u.y,z=-u.z);d||(y=-y);t=g._levels[0][b][4*k+3]/255;for(u=0;3>u;u++){var B=g._levels[0][b][4*k+u]/255;"rgbm"===g.type?(B*=8*t,B*=B):B=Math.pow(B,2.2);f[0+u]+=B*n;f[3+u]+=B*p*y;f[6+u]+=B*p*x;f[9+u]+=B*p*z;f[12+u]+=B*v*y*z;f[15+u]+=B*v*z*x;f[18+u]+=B*v*x*y;f[21+u]+=B*w*(3*z*z-1);f[24+u]+=B*r*(y*y-x*x);h+=m}}for(u=0;u<f.length;u++)f[u]*=4*Math.PI/h;return f}}function kj(l){switch(l.type){case "rgbm":return"RGBM";
case "rgbe":return"RGBE";default:switch(l.format){case 11:case 13:case 12:case 14:return"Linear";default:return"Gamma"}}}function lj(l){var g=new Ma(l,[{semantic:"POSITION",components:2,type:6}]);l=new Ra(l,g,4);g=new vb(l);g.element.POSITION.set(-1,-1);g.next();g.element.POSITION.set(1,-1);g.next();g.element.POSITION.set(-1,1);g.next();g.element.POSITION.set(1,1);g.end();return l}function mj(l,g,d,b,a){var c=l.getRenderTarget();l.setRenderTarget(g);l.updateBegin();var e=null!==g?g.width:l.width,
f=null!==g?g.height:l.height,h=0,k=0;a&&(h=a.x*e,k=a.y*f,e*=a.z,f*=a.w);a=l.vx;g=l.vy;var m=l.vw,n=l.vh;l.setViewport(h,k,e,f);var p=l.sx,t=l.sy,r=l.sw,u=l.sh;l.setScissor(h,k,e,f);e=l.getBlending();f=l.getDepthTest();h=l.getDepthWrite();k=l.getCullMode();var v=l.writeRed,w=l.writeGreen,y=l.writeBlue,x=l.writeAlpha;l.setBlending(!1);l.setDepthTest(!1);l.setDepthWrite(!1);l.setCullMode(0);l.setColorWrite(!0,!0,!0,!0);l.setVertexBuffer(d,0);l.setShader(b);l.draw(Yn);l.setBlending(e);l.setDepthTest(f);
l.setDepthWrite(h);l.setCullMode(k);l.setColorWrite(v,w,y,x);l.updateEnd();l.setRenderTarget(c);l.updateBegin();l.setViewport(a,g,m,n);l.setScissor(p,t,r,u)}function nj(l,g){if(Va.legacy)return null;if(oj.has(l))throw Error("script name: '"+l+"' is reserved, please change script name");var d=function(b){ec.call(this,b)};d.prototype=Object.create(ec.prototype);d.prototype.constructor=d;d.extend=ec.extend;d.attributes=new ad(d);pj(d,l,g);return d}function pj(l,g,d){if(!l.legacy){if("function"!==typeof l)throw Error("script class: '"+
l+"' must be a constructor function (i.e. class).");if(!(l.prototype instanceof ec))throw Error("script class: '"+ec.__getScriptName(l)+"' does not extend pc.ScriptType.");g=g||l.__name||ec.__getScriptName(l);if(oj.has(g))throw Error("script name: '"+g+"' is reserved, please change script name");l.__name=g;(d?d.scripts:qa.getApplication().scripts).add(l);Td._push(l)}}function Gg(l){af.key=l.keyCode;af.element=l.target;af.event=l;return af}function bf(l){return"string"===typeof l?l.toUpperCase().charCodeAt(0):
l}function Hg(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}function Zn(l,g,d){bd.sub2(g,l);cf.sub2(d[0],l);Ig.sub2(d[1],l);qj.sub2(d[2],l);df.cross(qj,bd);if(0<=cf.dot(df)){if(0>-Ig.dot(df))return!1;l=cf;if(0>rj.cross(bd,Ig).dot(l))return!1}else{Jg.sub2(d[3],l);if(0>Jg.dot(df))return!1;l=Jg;if(0>rj.cross(bd,cf).dot(l))return!1}return 1E-8>bd.sub2(d[0],d[2]).lengthSq()||1E-8>bd.sub2(d[1],d[3]).lengthSq()?!1:!0}function Kg(l){for(var g=0,
d=0,b=l.target;!(b instanceof HTMLElement);)b=b.parentNode;do g+=b.offsetLeft-b.scrollLeft,d+=b.offsetTop-b.scrollTop,b=b.offsetParent;while(b);return{x:l.pageX-g,y:l.pageY-d}}function ef(l,g,d){g=new X(g,{format:d,width:g.width,height:g.height});g.name="posteffect-pass";g.minFilter=0;g.magFilter=0;g.addressU=1;g.addressV=1;Ca[l]._colorBuffer=g}function sj(l){l=l.match($n)||[];for(var g,d,b=[],a=0;a<l.length;a++)g=l[a].search(ao),d=l[a].search(bo),g=l[a].substr(g,d-g),"uColorBuffer"!==g&&b.push(g);
return b}function Lg(l){this.name="UnsupportedBrowserError";this.message=l||""}function Mg(l){this.name="ContextCreationError";this.message=l||""}Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(l,g){if(null==this)throw TypeError('"this" is null or not defined');var d=Object(this),b=d.length>>>0;if("function"!==typeof l)throw TypeError("predicate must be a function");for(var a=0;a<b;){var c=d[a];if(l.call(g,c,a,d))return c;a++}},configurable:!0,writable:!0});Math.log2=
Math.log2||function(l){return Math.log(l)*Math.LOG2E};Math.sign||(Math.sign=function(l){return(0<l)-(0>l)||+l});"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(l,g){if(null==l)throw new TypeError("Cannot convert undefined or null to object");for(var d=Object(l),b=1;b<arguments.length;b++){var a=arguments[b];if(null!=a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(d[c]=a[c])}return d},writable:!0,configurable:!0});(function(){if("undefined"!==typeof navigator&&
"undefined"!==typeof document){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var l=function(){var d=document.createEvent("CustomEvent");d.initCustomEvent("pointerlockchange",!0,!1,null);document.dispatchEvent(d)},g=function(){var d=document.createEvent("CustomEvent");d.initCustomEvent("pointerlockerror",!0,!1,null);document.dispatchEvent(d)};document.addEventListener("webkitpointerlockchange",l,!1);document.addEventListener("webkitpointerlocklost",l,!1);document.addEventListener("mozpointerlockchange",
l,!1);document.addEventListener("mozpointerlocklost",l,!1);document.addEventListener("webkitpointerlockerror",g,!1);document.addEventListener("mozpointerlockerror",g,!1);Element.prototype.requestPointerLock=Element.prototype.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock;!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=
function(){document.pointerLockElement=this;navigator.pointer.lock(this,l,g)});document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock;document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}})();(function(){if("undefined"!==typeof window){for(var l=0,g=["ms","moz","webkit","o"],d=0;d<g.length&&!window.requestAnimationFrame;++d)window.requestAnimationFrame=
window[g[d]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[g[d]+"CancelAnimationFrame"]||window[g[d]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,a){var c=(new Date).getTime(),e=Math.max(0,16-(c-l));a=window.setTimeout(function(){b(c+e)},e);l=c+e;return a});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(b){clearTimeout(b)})}})();String.prototype.endsWith||(String.prototype.endsWith=function(l,g){if(void 0===
g||g>this.length)g=this.length;return this.substring(g-l.length,g)===l});String.prototype.includes||(String.prototype.includes=function(l,g){"number"!==typeof g&&(g=0);return g+l.length>this.length?!1:-1!==this.indexOf(l,g)});String.prototype.startsWith||(String.prototype.startsWith=function(l,g){return this.substr(!g||0>g?0:+g,l.length)===l});(function(){function l(a){var c=a.getError;a.getError=function(){do{var e=c.apply(a);e!=a.NO_ERROR&&(g[e]=!0)}while(e!=a.NO_ERROR);for(e in g)if(g[e])return delete g[e],
parseInt(e);return a.NO_ERROR}}var g={},d=function e(c){var f=c.gl;this.ext=c;this.isAlive=!0;this.hasBeenBound=!1;this.elementArrayBuffer=null;this.attribs=Array(c.maxVertexAttribs);for(c=0;c<this.attribs.length;c++){var h=new e.VertexAttrib(f);this.attribs[c]=h}this.maxAttrib=0};d.VertexAttrib=function(c){this.enabled=!1;this.buffer=null;this.size=4;this.type=c.FLOAT;this.normalized=!1;this.stride=16;this.offset=0;this.cached="";this.recache()};d.VertexAttrib.prototype.recache=function(){this.cached=
[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var b=function(c){var e=this;this.gl=c;l(c);var f=this.original={getParameter:c.getParameter,enableVertexAttribArray:c.enableVertexAttribArray,disableVertexAttribArray:c.disableVertexAttribArray,bindBuffer:c.bindBuffer,getVertexAttrib:c.getVertexAttrib,vertexAttribPointer:c.vertexAttribPointer};c.getParameter=function(h){return h==e.VERTEX_ARRAY_BINDING_OES?e.currentVertexArrayObject==e.defaultVertexArrayObject?null:e.currentVertexArrayObject:
f.getParameter.apply(this,arguments)};c.enableVertexAttribArray=function(h){var k=e.currentVertexArrayObject;k.maxAttrib=Math.max(k.maxAttrib,h);k.attribs[h].enabled=!0;return f.enableVertexAttribArray.apply(this,arguments)};c.disableVertexAttribArray=function(h){var k=e.currentVertexArrayObject;k.maxAttrib=Math.max(k.maxAttrib,h);k.attribs[h].enabled=!1;return f.disableVertexAttribArray.apply(this,arguments)};c.bindBuffer=function(h,k){switch(h){case c.ARRAY_BUFFER:e.currentArrayBuffer=k;break;case c.ELEMENT_ARRAY_BUFFER:e.currentVertexArrayObject.elementArrayBuffer=
k}return f.bindBuffer.apply(this,arguments)};c.getVertexAttrib=function(h,k){var m=e.currentVertexArrayObject.attribs[h];switch(k){case c.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return m.buffer;case c.VERTEX_ATTRIB_ARRAY_ENABLED:return m.enabled;case c.VERTEX_ATTRIB_ARRAY_SIZE:return m.size;case c.VERTEX_ATTRIB_ARRAY_STRIDE:return m.stride;case c.VERTEX_ATTRIB_ARRAY_TYPE:return m.type;case c.VERTEX_ATTRIB_ARRAY_NORMALIZED:return m.normalized;default:return f.getVertexAttrib.apply(this,arguments)}};c.vertexAttribPointer=
function(h,k,m,n,p,t){var r=e.currentVertexArrayObject;r.maxAttrib=Math.max(r.maxAttrib,h);r=r.attribs[h];r.buffer=e.currentArrayBuffer;r.size=k;r.type=m;r.normalized=n;r.stride=p;r.offset=t;r.recache();return f.vertexAttribPointer.apply(this,arguments)};c.instrumentExtension&&c.instrumentExtension(this,"OES_vertex_array_object");c.canvas.addEventListener("webglcontextrestored",function(){window.console&&window.console.log&&window.console.log("OESVertexArrayObject emulation library context restored");
e.reset_()},!0);this.reset_()};b.prototype.VERTEX_ARRAY_BINDING_OES=34229;b.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var c=0;c<this.vertexArrayObjects.length;++c)this.vertexArrayObjects.isAlive=!1;c=this.gl;this.maxVertexAttribs=c.getParameter(c.MAX_VERTEX_ATTRIBS);this.defaultVertexArrayObject=new d(this);this.currentArrayBuffer=this.currentVertexArrayObject=null;this.vertexArrayObjects=[this.defaultVertexArrayObject];this.bindVertexArrayOES(null)};b.prototype.createVertexArrayOES=
function(){var c=new d(this);this.vertexArrayObjects.push(c);return c};b.prototype.deleteVertexArrayOES=function(c){c.isAlive=!1;this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(c),1);this.currentVertexArrayObject==c&&this.bindVertexArrayOES(null)};b.prototype.isVertexArrayOES=function(c){return c&&c instanceof d&&c.hasBeenBound&&c.ext==this?!0:!1};b.prototype.bindVertexArrayOES=function(c){var e=this.gl;if(c&&!c.isAlive)g[e.INVALID_OPERATION]=!0,window.console&&window.console.error&&
window.console.error("bindVertexArrayOES: attempt to bind deleted arrayObject");else{var f=this.original,h=this.currentVertexArrayObject;this.currentVertexArrayObject=c||this.defaultVertexArrayObject;this.currentVertexArrayObject.hasBeenBound=!0;c=this.currentVertexArrayObject;if(h!=c){h&&c.elementArrayBuffer==h.elementArrayBuffer||f.bindBuffer.call(e,e.ELEMENT_ARRAY_BUFFER,c.elementArrayBuffer);for(var k=this.currentArrayBuffer,m=Math.max(h?h.maxAttrib:0,c.maxAttrib),n=0;n<=m;n++){var p=c.attribs[n],
t=h?h.attribs[n]:null;h&&p.enabled==t.enabled||(p.enabled?f.enableVertexAttribArray.call(e,n):f.disableVertexAttribArray.call(e,n));if(p.enabled){var r=!1;h&&p.buffer==t.buffer||(k!=p.buffer&&(f.bindBuffer.call(e,e.ARRAY_BUFFER,p.buffer),k=p.buffer),r=!0);(r||p.cached!=t.cached)&&f.vertexAttribPointer.call(e,n,p.size,p.type,p.normalized,p.stride,p.offset)}}this.currentArrayBuffer!=k&&f.bindBuffer.call(e,e.ARRAY_BUFFER,this.currentArrayBuffer)}}};window.setupVertexArrayObject=function(c){if(c.getSupportedExtensions){if(-1!=
c.getSupportedExtensions().indexOf("OES_vertex_array_object"))return}else if(c.getExtension&&c.getExtension("OES_vertex_array_object"))return;if(c.getSupportedExtensions){var e=c.getSupportedExtensions;c.getSupportedExtensions=function(){var h=e.call(this)||[];h.push("OES_vertex_array_object");return h}}var f=c.getExtension;c.getExtension=function(h){return"OES_vertex_array_object"==h?(c.__OESVertexArrayObject||(c.__OESVertexArrayObject=new b(c)),c.__OESVertexArrayObject):f?f.call(this,h):null}}})();
var hn=function(){for(var l={},g="Array Object Function Date RegExp Float32Array".split(" "),d=0;d<g.length;d++)l["[object "+g[d]+"]"]=g[d].toLowerCase();return l}(),co=function(){var l=null,g=null,d=null,b=null;return{display:function(a){l||(l=document.createElement("table"),g=document.createElement("tr"),d=document.createElement("td"),b=document.createElement("td"),l.style.cssText="position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc",l.style.top="0px",l.style.left="0px",l.style.border=
"thin solid #cccccc",document.body.appendChild(l));l.innerHTML="";for(var c in a){var e=g.cloneNode(),f=d.cloneNode(),h=b.cloneNode();f.textContent=c;h.textContent=a[c];e.appendChild(f);e.appendChild(h);l.appendChild(e)}}}}(),ba=function(){function l(){this._callbacks={};this._callbackActive={}}var g=l.prototype;g._addCallback=function(d,b,a,c){void 0===c&&(c=!1);d&&"string"===typeof d&&b&&(this._callbacks[d]||(this._callbacks[d]=[]),this._callbackActive[d]&&this._callbackActive[d]===this._callbacks[d]&&
(this._callbackActive[d]=this._callbackActive[d].slice()),this._callbacks[d].push({callback:b,scope:a||this,once:c}))};g.on=function(d,b,a){this._addCallback(d,b,a,!1);return this};g.off=function(d,b,a){if(d)this._callbackActive[d]&&this._callbackActive[d]===this._callbacks[d]&&(this._callbackActive[d]=this._callbackActive[d].slice());else for(var c in this._callbackActive)this._callbacks[c]&&this._callbacks[c]===this._callbackActive[c]&&(this._callbackActive[c]=this._callbackActive[c].slice());if(d)if(b){d=
this._callbacks[d];if(!d)return this;c=d.length;for(var e=0;e<c;e++)d[e].callback===b&&(a&&d[e].scope!==a||(d[e--]=d[--c]));d.length=c}else this._callbacks[d]&&(this._callbacks[d]=[]);else this._callbacks={};return this};g.fire=function(d,b,a,c,e,f,h,k,m){if(!d||!this._callbacks[d])return this;if(this._callbackActive[d]){this._callbackActive[d]===this._callbacks[d]&&(this._callbackActive[d]=this._callbackActive[d].slice());var n=this._callbacks[d].slice()}else this._callbackActive[d]=this._callbacks[d];
for(var p=0;(n||this._callbackActive[d])&&p<(n||this._callbackActive[d]).length;p++){var t=(n||this._callbackActive[d])[p];t.callback.call(t.scope,b,a,c,e,f,h,k,m);t.once&&(t=this._callbacks[d].indexOf(t),-1!==t&&(this._callbackActive[d]===this._callbacks[d]&&(this._callbackActive[d]=this._callbackActive[d].slice()),this._callbacks[d].splice(t,1)))}n||(this._callbackActive[d]=null);return this};g.once=function(d,b,a){this._addCallback(d,b,a,!0);return this};g.hasEvent=function(d){return this._callbacks[d]&&
0!==this._callbacks[d].length||!1};return l}(),Ud={attach:function(l){var g=Ud;l._addCallback=g._addCallback;l.on=g.on;l.off=g.off;l.fire=g.fire;l.once=g.once;l.hasEvent=g.hasEvent;l._callbacks={};l._callbackActive={};return l},_addCallback:ba.prototype._addCallback,on:ba.prototype.on,off:ba.prototype.off,fire:ba.prototype.fire,once:ba.prototype.once,hasEvent:ba.prototype.hasEvent},tj={create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(l){var g=16*Math.random()|
0;return("x"==l?g:g&3|8).toString(16)})}},da={delimiter:"/",join:function(){var l,g=arguments.length,d=arguments[0];for(l=0;l<g-1;++l){var b=arguments[l],a=arguments[l+1];if(!ig(b)||!ig(a))throw Error("undefined argument to pc.path.join");d=a[0]===da.delimiter?a:b&&a&&b[b.length-1]!==da.delimiter&&a[0]!==da.delimiter?d+(da.delimiter+a):d+a}return d},normalize:function(l){var g=l.startsWith(da.delimiter),d=l.endsWith(da.delimiter);l=l.split("/");for(var b=[],a=0;a<l.length;a++)""!==l[a]&&"."!==l[a]&&
(".."===l[a]&&0<b.length?b=b.slice(0,b.length-2):(0<a&&b.push(da.delimiter),b.push(l[a])));l=b.join("");g||l[0]!==da.delimiter||(l=l.slice(1));d&&l[l.length-1]!==da.delimiter&&(l+=da.delimiter);return l},split:function(l){l=l.split(da.delimiter);var g=l.slice(l.length-1)[0];return[l.slice(0,l.length-1).join(da.delimiter),g]},getBasename:function(l){return da.split(l)[1]},getDirectory:function(l){l=l.split(da.delimiter);return l.slice(0,l.length-1).join(da.delimiter)},getExtension:function(l){var g=
l.split("?")[0].split(".").pop();return g!==l?"."+g:""},isRelativePath:function(l){return"/"!==l.charAt(0)&&null===l.match(/:\/\//)},extractPath:function(l){var g="",d=l.split("/");if(1<d.length)if(da.isRelativePath(l))if("."===d[0])for(l=0;l<d.length-1;++l)g+=0===l?d[l]:"/"+d[l];else if(".."===d[0])for(l=0;l<d.length-1;++l)g+=0===l?d[l]:"/"+d[l];else for(g=".",l=0;l<d.length-1;++l)g+="/"+d[l];else for(l=0;l<d.length-1;++l)g+=0===l?d[l]:"/"+d[l];return g}},za={desktop:!1,mobile:!1,ios:!1,android:!1,
windows:!1,xbox:!1,gamepads:!1,touch:!1,workers:!1,passiveEvents:!1};if("undefined"!==typeof navigator){var Vd=navigator.userAgent;/(windows|mac os|linux|cros)/i.test(Vd)&&(za.desktop=!0);/xbox/i.test(Vd)&&(za.xbox=!0);/(windows phone|iemobile|wpdesktop)/i.test(Vd)?(za.desktop=!1,za.mobile=!0,za.windows=!0):/android/i.test(Vd)?(za.desktop=!1,za.mobile=!0,za.android=!0):/ip([ao]d|hone)/i.test(Vd)&&(za.desktop=!1,za.mobile=!0,za.ios=!0);"undefined"!==typeof window&&(za.touch="ontouchstart"in window||
"maxTouchPoints"in navigator&&0<navigator.maxTouchPoints);za.gamepads="getGamepads"in navigator;za.workers="undefined"!==typeof Worker;try{var uj=Object.defineProperty({},"passive",{get:function(){za.passiveEvents=!0;return!1}});window.addEventListener("testpassive",null,uj);window.removeEventListener("testpassive",null,uj)}catch(l){}}var Eb={ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
format:function(l){for(var g=1;g<arguments.length;g++)l=l.replace("{"+(g-1)+"}",arguments[g]);return l},toBool:function(l,g){if("true"===l)return!0;if(g){if("false"===l)return!1;throw new TypeError("Not a boolean string");}return!1},getCodePoint:function(l,g){return(l=jg(l,g))&&l.code},getCodePoints:function(l){if("string"!==typeof l)throw new TypeError("Not a string");for(var g=0,d=[],b;b=jg(l,g);)d.push(b.code),g+=b.long?2:1;return d},getSymbols:function(l){if("string"!==typeof l)throw new TypeError("Not a string");
for(var g=0,d=l.length,b=[],a=0,c;g<d;){c=a;var e=l,f=g+a;f===e.length-1?a=1:dc(e[f],55296,56319)?(a=e.substring(f,f+2),e=e.substring(f+2,f+4),a=dc(e,127995,127999)||dc(a,127462,127487)&&dc(e,127462,127487)?4:dc(e,65024,65039)?3:2):a=dc(e[f+1],65024,65039)?2:1;a=c+a;c=l[g+a];dc(c,8400,8447)&&(c=l[g+a++]);dc(c,65024,65039)&&(c=l[g+a++]);c&&8205===c.charCodeAt(0)?a++:(c=l.substring(g,g+a),b.push(c),g+=a,a=0)}return b},fromCodePoint:function(){for(var l=[],g,d,b=0;b<arguments.length;++b)g=Number(arguments[b]),
d=g-65536,g=65535<g?[(d>>10)+55296,d%1024+56320]:[g],l.push(String.fromCharCode.apply(null,g));return l.join("")}},R={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(l,g,d){return l>=d?d:l<=g?g:l},intToBytes24:function(l){return[l>>16&255,l>>8&255,l&255]},intToBytes32:function(l){return[l>>24&255,l>>16&255,l>>8&255,l&255]},bytesToInt24:function(l,g,d){l.length&&(d=l[2],g=l[1],l=l[0]);return l<<16|g<<8|d},bytesToInt32:function(l,g,d,b){l.length&&(b=l[3],d=l[2],g=l[1],l=l[0]);return(l<<
24|g<<16|d<<8|b)>>>32},lerp:function(l,g,d){return l+(g-l)*R.clamp(d,0,1)},lerpAngle:function(l,g,d){180<g-l&&(g-=360);-180>g-l&&(g+=360);return R.lerp(l,g,R.clamp(d,0,1))},powerOfTwo:function(l){return 0!==l&&!(l&l-1)},nextPowerOfTwo:function(l){l--;l|=l>>1;l|=l>>2;l|=l>>4;l|=l>>8;l|=l>>16;l++;return l},random:function(l,g){return Math.random()*(g-l)+l},smoothstep:function(l,g,d){if(d<=l)return 0;if(d>=g)return 1;d=(d-l)/(g-l);return d*d*(3-2*d)},smootherstep:function(l,g,d){if(d<=l)return 0;if(d>=
g)return 1;d=(d-l)/(g-l);return d*d*d*(d*(6*d-15)+10)},roundUp:function(l,g){return 0===g?l:Math.ceil(l/g)*g},float2Half:function(){var l=new Float32Array(1),g=new Int32Array(l.buffer);return function(d){l[0]=d;d=g[0];var b=d>>16&32768,a=d>>12&2047,c=d>>23&255;return 103>c?b:142<c?b|31744|((255==c?0:1)&&d&8388607):113>c?(a|=2048,b|(a>>114-c)+(a>>113-c&1)):b=(b|c-112<<10|a>>1)+(a&1)}}()},Q=function(){function l(d,b,a,c){void 0===d&&(d=0);void 0===b&&(b=0);void 0===a&&(a=0);void 0===c&&(c=1);var e=
d.length;3===e||4===e?(this.r=d[0],this.g=d[1],this.b=d[2],this.a=void 0!==d[3]?d[3]:1):(this.r=d,this.g=b,this.b=a,this.a=c)}var g=l.prototype;g.clone=function(){return new l(this.r,this.g,this.b,this.a)};g.copy=function(d){this.r=d.r;this.g=d.g;this.b=d.b;this.a=d.a;return this};g.equals=function(d){return this.r===d.r&&this.g===d.g&&this.b===d.b&&this.a===d.a};g.set=function(d,b,a,c){void 0===c&&(c=1);this.r=d;this.g=b;this.b=a;this.a=c;return this};g.lerp=function(d,b,a){this.r=d.r+a*(b.r-d.r);
this.g=d.g+a*(b.g-d.g);this.b=d.b+a*(b.b-d.b);this.a=d.a+a*(b.a-d.a);return this};g.fromString=function(d){var b=parseInt(d.replace("#","0x"),16);7<d.length?d=R.intToBytes32(b):(d=R.intToBytes24(b),d[3]=255);this.set(d[0]/255,d[1]/255,d[2]/255,d[3]/255);return this};g.toString=function(d){var b="#"+(16777216+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);!0===d&&(d=Math.round(255*this.a).toString(16),b=this.a<16/255?b+("0"+d):b+d);return b};
return l}();Q.BLACK=Object.freeze(new Q(0,0,0,1));Q.BLUE=Object.freeze(new Q(0,0,1,1));Q.CYAN=Object.freeze(new Q(0,1,1,1));Q.GRAY=Object.freeze(new Q(.5,.5,.5,1));Q.GREEN=Object.freeze(new Q(0,1,0,1));Q.MAGENTA=Object.freeze(new Q(1,0,1,1));Q.RED=Object.freeze(new Q(1,0,0,1));Q.WHITE=Object.freeze(new Q(1,1,1,1));Q.YELLOW=Object.freeze(new Q(1,1,0,1));var vj=function(){function l(){this._list=[];this._index={}}var g=l.prototype;g.push=function(d,b){if(this._index[d])throw Error("Key already in index "+
d);b=this._list.push(b)-1;this._index[d]=b};g.has=function(d){return void 0!==this._index[d]};g.get=function(d){d=this._index[d];return void 0!==d?this._list[d]:null};g.remove=function(d){var b=this._index[d];if(void 0!==b){this._list.splice(b,1);delete this._index[d];for(d in this._index){var a=this._index[d];a>b&&(this._index[d]=a-1)}return!0}return!1};g.list=function(){return this._list};g.clear=function(){this._list.length=0;for(var d in this._index)delete this._index[d]};return l}(),Wd=function(){function l(d){this._sortBy=
d.sortBy;this.items=[];this.length=0;this.loopIndex=-1;this._sortHandler=this._doSort.bind(this)}var g=l.prototype;g._binarySearch=function(d){var b=0,a=this.items.length-1;d=d[this._sortBy];for(var c,e;b<=a;)c=Math.floor((b+a)/2),e=this.items[c][this._sortBy],e<=d?b=c+1:e>d&&(a=c-1);return b};g._doSort=function(d,b){var a=this._sortBy;return d[a]-b[a]};g.insert=function(d){var b=this._binarySearch(d);this.items.splice(b,0,d);this.length++;this.loopIndex>=b&&this.loopIndex++};g.append=function(d){this.items.push(d);
this.length++};g.remove=function(d){d=this.items.indexOf(d);0>d||(this.items.splice(d,1),this.length--,this.loopIndex>=d&&this.loopIndex--)};g.sort=function(){var d=0<=this.loopIndex?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler);null!==d&&(this.loopIndex=this.items.indexOf(d))};return l}(),Ng=function(l){function g(b){var a=l.call(this)||this;a._index={};a._list=[];a._parent=b;return a}K(g,l);var d=g.prototype;d.add=function(){var b=!1,a=this._processArguments(arguments,!0);if(!a.length)return b;
for(var c=0;c<a.length;c++)this._index[a[c]]||(b=!0,this._index[a[c]]=!0,this._list.push(a[c]),this.fire("add",a[c],this._parent));b&&this.fire("change",this._parent);return b};d.remove=function(){var b=!1;if(!this._list.length)return b;var a=this._processArguments(arguments,!0);if(!a.length)return b;for(var c=0;c<a.length;c++)this._index[a[c]]&&(b=!0,delete this._index[a[c]],this._list.splice(this._list.indexOf(a[c]),1),this.fire("remove",a[c],this._parent));b&&this.fire("change",this._parent);return b};
d.clear=function(){if(this._list.length){var b=this._list.slice(0);this._list=[];this._index={};for(var a=0;a<b.length;a++)this.fire("remove",b[a],this._parent);this.fire("change",this._parent)}};d.has=function(){return this._list.length?this._has(this._processArguments(arguments)):!1};d._has=function(b){if(!this._list.length||!b.length)return!1;for(var a=0;a<b.length;a++)if(1===b[a].length){if(this._index[b[a][0]])return!0}else{for(var c=!0,e=0;e<b[a].length;e++)if(!this._index[b[a][e]]){c=!1;break}if(c)return!0}return!1};
d.list=function(){return this._list.slice(0)};d._processArguments=function(b,a){var c=[],e=[];if(!b||!b.length)return c;for(var f=0;f<b.length;f++)if(b[f]instanceof Array){a||(e=[]);for(var h=0;h<b[f].length;h++)"string"===typeof b[f][h]&&(a?c.push(b[f][h]):e.push(b[f][h]));!a&&e.length&&c.push(e)}else"string"===typeof b[f]&&(a?c.push(b[f]):c.push([b[f]]));return c};N(g,[{key:"size",get:function(){return this._list.length}}]);return g}(ba),eb="undefined"!==typeof window&&window.performance&&window.performance.now&&
window.performance.timing?function(){return window.performance.now()}:Date.now,wj=function(){function l(){this._isRunning=!1;this._b=this._a=0}var g=l.prototype;g.start=function(){this._isRunning=!0;this._a=eb()};g.stop=function(){this._isRunning=!1;this._b=eb()};g.getMilliseconds=function(){return this._b-this._a};return l}(),Oa=function(){function l(){this.ContentType=l.ContentType;this.ResponseType=l.ResponseType;this.binaryExtensions=l.binaryExtensions}var g=l.prototype;g.get=function(d,b,a){"function"===
typeof b&&(a=b,b={});return this.request("GET",d,b,a)};g.post=function(d,b,a,c){"function"===typeof a&&(c=a,a={});a.postdata=b;return this.request("POST",d,a,c)};g.put=function(d,b,a,c){"function"===typeof a&&(c=a,a={});a.postdata=b;return this.request("PUT",d,a,c)};g.del=function(d,b,a){"function"===typeof b&&(a=b,b={});return this.request("DELETE",d,b,a)};g.request=function(d,b,a,c){var e=!1;"function"===typeof a&&(c=a,a={});a.retry&&(a=Object.assign({retries:0,maxRetries:5},a));a.callback=c;null==
a.async&&(a.async=!0);null==a.headers&&(a.headers={});if(null!=a.postdata)if(a.postdata instanceof Document)var f=a.postdata;else if(a.postdata instanceof FormData)f=a.postdata;else if(a.postdata instanceof Object)switch(f=a.headers["Content-Type"],void 0===f&&(a.headers["Content-Type"]=l.ContentType.FORM_URLENCODED,f=a.headers["Content-Type"]),f){case l.ContentType.FORM_URLENCODED:f="";c=!0;for(h in a.postdata)a.postdata.hasOwnProperty(h)&&(c?c=!1:f+="&",f+=escape(h)+"="+escape(a.postdata[h]));break;
default:case l.ContentType.JSON:null==f&&(a.headers["Content-Type"]=l.ContentType.JSON),f=JSON.stringify(a.postdata)}else f=a.postdata;if(!1===a.cache){c=eb();var h=new Ge(b);h.query=h.query?h.query+"&ts="+c:"ts="+c;b=h.toString()}a.query&&(h=new Ge(b),c=Ob(h.getQuery(),a.query),h.setQuery(c),b=h.toString());var k=new XMLHttpRequest;k.open(d,b,a.async);k.withCredentials=void 0!==a.withCredentials?a.withCredentials:!1;k.responseType=a.responseType||this._guessResponseType(b);for(var m in a.headers)a.headers.hasOwnProperty(m)&&
k.setRequestHeader(m,a.headers[m]);k.onreadystatechange=function(){this._onReadyStateChange(d,b,a,k)}.bind(this);k.onerror=function(){this._onError(d,b,a,k);e=!0}.bind(this);try{k.send(f)}catch(n){e||a.error(k.status,k,n)}return k};g._guessResponseType=function(d){d=new Ge(d);d=da.getExtension(d.path);return 0<=l.binaryExtensions.indexOf(d)?l.ResponseType.ARRAY_BUFFER:".xml"===d?l.ResponseType.DOCUMENT:l.ResponseType.TEXT};g._isBinaryContentType=function(d){return 0<=[l.ContentType.MP4,l.ContentType.WAV,
l.ContentType.OGG,l.ContentType.MP3,l.ContentType.BIN,l.ContentType.DDS,l.ContentType.BASIS,l.ContentType.GLB].indexOf(d)?!0:!1};g._onReadyStateChange=function(d,b,a,c){if(4===c.readyState)switch(c.status){case 0:c.responseURL&&c.responseURL.startsWith("file:///")?this._onSuccess(d,b,a,c):this._onError(d,b,a,c);break;case 200:case 201:case 206:case 304:this._onSuccess(d,b,a,c);break;default:this._onError(d,b,a,c)}};g._onSuccess=function(d,b,a,c){if(d=c.getResponseHeader("Content-Type")){var e=d.split(";");
e=e[0].trim()}try{if(e===this.ContentType.JSON||b.split("?")[0].endsWith(".json"))var f=JSON.parse(c.responseText);else this._isBinaryContentType(e)?f=c.response:(e&&console.warn("responseType: "+c.responseType+" being served with Content-Type: "+e),f=c.responseType===l.ResponseType.ARRAY_BUFFER?c.response:c.responseType===l.ResponseType.BLOB||c.responseType===l.ResponseType.JSON?c.response:c.responseType===l.ResponseType.DOCUMENT||e===this.ContentType.XML?c.responseXML:c.responseText);a.callback(null,
f)}catch(h){a.callback(h)}};g._onError=function(d,b,a,c){if(!a.retrying)if(a.retry&&a.retries<a.maxRetries){a.retries++;a.retrying=!0;var e=R.clamp(Math.pow(2,a.retries)*l.retryDelay,0,a.maxRetryDelay||5E3);console.log(d+": "+b+" - Error "+c.status+". Retrying in "+e+" ms");setTimeout(function(){a.retrying=!1;this.request(d,b,a,a.callback)}.bind(this),e)}else a.callback(0===c.status?"Network error":c.status,null)};return l}();Oa.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",
JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream",BASIS:"image/basis",GLB:"model/gltf-binary"};Oa.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"};Oa.binaryExtensions=".model .wav .ogg .mp3 .mp4 .m4a .aac .dds .basis .glb".split(" ");Oa.retryDelay=100;var oa=new Oa,xj=function(){function l(d,
b){this._curve=d;this._left=-Infinity;this._right=Infinity;this._m1=this._m0=this._p1=this._p0=this._recip=0;this._reset(b||0)}var g=l.prototype;g.evaluate=function(d,b){(b||d<this._left||d>=this._right)&&this._reset(d);b=this._curve.type;5===b?d=this._p0:(d=0===this._recip?0:(d-this._left)*this._recip,d=0===b?R.lerp(this._p0,this._p1,d):1===b?R.lerp(this._p0,this._p1,d*d*(3-2*d)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,d));return d};g._reset=function(d){var b=this._curve.keys,a=
b.length;if(a)if(d<b[0][0])this._left=-Infinity,this._right=b[0][0],this._recip=0,this._p0=this._p1=b[0][1],this._m0=this._m1=0;else if(d>=b[a-1][0])this._left=b[a-1][0],this._right=Infinity,this._recip=0,this._p0=this._p1=b[a-1][1],this._m0=this._m1=0;else{for(a=0;d>=b[a+1][0];)a++;this._left=b[a][0];this._right=b[a+1][0];d=1/(this._right-this._left);this._recip=isFinite(d)?d:0;this._p0=b[a][1];this._p1=b[a+1][1];this._isHermite()&&this._calcTangents(b,a)}else this._left=-Infinity,this._right=Infinity,
this._p0=this._p1=this._m0=this._m1=this._recip=0};g._isHermite=function(){return 2===this._curve.type||3===this._curve.type||4===this._curve.type};g._calcTangents=function(d,b){var a=d[b],c=d[b+1];var e=0===b?[d[0][0]+(d[0][0]-d[1][0]),d[0][1]+(d[0][1]-d[1][1])]:d[b-1];d=b==d.length-2?[d[b+1][0]+(d[b+1][0]-d[b][0]),d[b+1][1]+(d[b+1][1]-d[b][1])]:d[b+2];if(4===this._curve.type){b=2*(c[0]-a[0])/(c[0]-e[0]);var f=2*(c[0]-a[0])/(d[0]-a[0]);this._m0=this._curve.tension*(isFinite(b)?b:0)*(c[1]-e[1]);this._m1=
this._curve.tension*(isFinite(f)?f:0)*(d[1]-a[1])}else f=(c[0]-a[0])/(a[0]-e[0]),b=(c[0]-a[0])/(d[0]-c[0]),e=a[1]+(e[1]-a[1])*(isFinite(f)?f:0),d=c[1]+(d[1]-c[1])*(isFinite(b)?b:0),b=2===this._curve.type?.5:this._curve.tension,this._m0=b*(c[1]-e),this._m1=b*(d-a[1])};g._evaluateHermite=function(d,b,a,c,e){var f=e*e,h=e+e,k=1-e;k*=k;return d*(1+h)*k+a*e*k+b*f*(3-h)+c*f*(e-1)};return l}(),db=function(){function l(d){this.keys=[];this.type=1;this.tension=.5;this._eval=new xj(this);if(d)for(var b=0;b<
d.length-1;b+=2)this.keys.push([d[b],d[b+1]]);this.sort()}var g=l.prototype;g.add=function(d,b){for(var a=this.keys,c=a.length,e=0;e<c&&!(a[e][0]>d);e++);d=[d,b];this.keys.splice(e,0,d);return d};g.get=function(d){return this.keys[d]};g.sort=function(){this.keys.sort(function(d,b){return d[0]-b[0]})};g.value=function(d){return this._eval.evaluate(d,!0)};g.closest=function(d){for(var b=this.keys,a=b.length,c=2,e=null,f=0;f<a;f++){var h=Math.abs(d-b[f][0]);if(c>=h)c=h,e=b[f];else break}return e};g.clone=
function(){var d=new l;d.keys=Ob(d.keys,this.keys);d.type=this.type;d.tension=this.tension;return d};g.quantize=function(d){d=Math.max(d,2);var b=new Float32Array(d),a=1/(d-1);b[0]=this._eval.evaluate(0,!0);for(var c=1;c<d;c++)b[c]=this._eval.evaluate(a*c);return b};g.quantizeClamped=function(d,b,a){d=this.quantize(d);for(var c=0;c<d.length;++c)d[c]=Math.min(a,Math.max(b,d[c]));return d};N(l,[{key:"length",get:function(){return this.keys.length}}]);return l}(),Qb=function(){function l(){var d;this.curves=
[];this._type=1;if(1<arguments.length)for(d=0;d<arguments.length;d++)this.curves.push(new db(arguments[d]));else if(0===arguments.length)this.curves.push(new db);else{var b=arguments[0];if("number"===typeof b)for(d=0;d<b;d++)this.curves.push(new db);else for(d=0;d<b.length;d++)this.curves.push(new db(b[d]))}}var g=l.prototype;g.get=function(d){return this.curves[d]};g.value=function(d,b){void 0===b&&(b=[]);var a=this.curves.length;b.length=a;for(var c=0;c<a;c++)b[c]=this.curves[c].value(d);return b};
g.clone=function(){var d=new l;d.curves=[];for(var b=0;b<this.curves.length;b++)d.curves.push(this.curves[b].clone());d._type=this._type;return d};g.quantize=function(d){d=Math.max(d,2);for(var b=this.curves.length,a=new Float32Array(d*b),c=1/(d-1),e=0;e<b;e++)for(var f=new xj(this.curves[e]),h=0;h<d;h++)a[h*b+e]=f.evaluate(c*h);return a};g.quantizeClamped=function(d,b,a){d=this.quantize(d);for(var c=0;c<d.length;++c)d[c]=Math.min(a,Math.max(b,d[c]));return d};N(l,[{key:"length",get:function(){return this.curves.length}},
{key:"type",get:function(){return this._type},set:function(d){this._type=d;for(var b=0;b<this.curves.length;b++)this.curves[b].type=d}}]);return l}(),lb=function(){function l(){var d=new Float32Array(9);d[0]=d[4]=d[8]=1;this.data=d}var g=l.prototype;g.clone=function(){return(new l).copy(this)};g.copy=function(d){d=d.data;var b=this.data;b[0]=d[0];b[1]=d[1];b[2]=d[2];b[3]=d[3];b[4]=d[4];b[5]=d[5];b[6]=d[6];b[7]=d[7];b[8]=d[8];return this};g.set=function(d){var b=this.data;b[0]=d[0];b[1]=d[1];b[2]=
d[2];b[3]=d[3];b[4]=d[4];b[5]=d[5];b[6]=d[6];b[7]=d[7];b[8]=d[8];return this};g.equals=function(d){var b=this.data;d=d.data;return b[0]===d[0]&&b[1]===d[1]&&b[2]===d[2]&&b[3]===d[3]&&b[4]===d[4]&&b[5]===d[5]&&b[6]===d[6]&&b[7]===d[7]&&b[8]===d[8]};g.isIdentity=function(){var d=this.data;return 1===d[0]&&0===d[1]&&0===d[2]&&0===d[3]&&1===d[4]&&0===d[5]&&0===d[6]&&0===d[7]&&1===d[8]};g.setIdentity=function(){var d=this.data;d[0]=1;d[1]=0;d[2]=0;d[3]=0;d[4]=1;d[5]=0;d[6]=0;d[7]=0;d[8]=1;return this};
g.toString=function(){for(var d="[",b=0;9>b;b++)d+=this.data[b],d+=8!==b?", ":"";return d+"]"};g.transpose=function(){var d=this.data;var b=d[1];d[1]=d[3];d[3]=b;b=d[2];d[2]=d[6];d[6]=b;b=d[5];d[5]=d[7];d[7]=b;return this};g.setFromMat4=function(d){d=d.data;var b=this.data;b[0]=d[0];b[1]=d[1];b[2]=d[2];b[3]=d[4];b[4]=d[5];b[5]=d[6];b[6]=d[8];b[7]=d[9];b[8]=d[10];return this};return l}();lb.IDENTITY=Object.freeze(new lb);lb.ZERO=Object.freeze((new lb).set([0,0,0,0,0,0,0,0,0]));var S=function(){function l(d,
b){void 0===d&&(d=0);void 0===b&&(b=0);2===d.length?(this.x=d[0],this.y=d[1]):(this.x=d,this.y=b)}var g=l.prototype;g.add=function(d){this.x+=d.x;this.y+=d.y;return this};g.add2=function(d,b){this.x=d.x+b.x;this.y=d.y+b.y;return this};g.clone=function(){return new l(this.x,this.y)};g.copy=function(d){this.x=d.x;this.y=d.y;return this};g.distance=function(d){var b=this.x-d.x;d=this.y-d.y;return Math.sqrt(b*b+d*d)};g.dot=function(d){return this.x*d.x+this.y*d.y};g.equals=function(d){return this.x===
d.x&&this.y===d.y};g.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};g.lengthSq=function(){return this.x*this.x+this.y*this.y};g.lerp=function(d,b,a){this.x=d.x+a*(b.x-d.x);this.y=d.y+a*(b.y-d.y);return this};g.mul=function(d){this.x*=d.x;this.y*=d.y;return this};g.mul2=function(d,b){this.x=d.x*b.x;this.y=d.y*b.y;return this};g.normalize=function(){var d=this.x*this.x+this.y*this.y;0<d&&(d=1/Math.sqrt(d),this.x*=d,this.y*=d);return this};g.scale=function(d){this.x*=d;this.y*=d;return this};
g.set=function(d,b){this.x=d;this.y=b;return this};g.sub=function(d){this.x-=d.x;this.y-=d.y;return this};g.sub2=function(d,b){this.x=d.x-b.x;this.y=d.y-b.y;return this};g.toString=function(){return"["+this.x+", "+this.y+"]"};return l}();S.ZERO=Object.freeze(new S(0,0));S.ONE=Object.freeze(new S(1,1));S.UP=Object.freeze(new S(0,1));S.DOWN=Object.freeze(new S(0,-1));S.RIGHT=Object.freeze(new S(1,0));S.LEFT=Object.freeze(new S(-1,0));var A=function(){function l(d,b,a){void 0===d&&(d=0);void 0===b&&
(b=0);void 0===a&&(a=0);3===d.length?(this.x=d[0],this.y=d[1],this.z=d[2]):(this.x=d,this.y=b,this.z=a)}var g=l.prototype;g.add=function(d){this.x+=d.x;this.y+=d.y;this.z+=d.z;return this};g.add2=function(d,b){this.x=d.x+b.x;this.y=d.y+b.y;this.z=d.z+b.z;return this};g.clone=function(){return new l(this.x,this.y,this.z)};g.copy=function(d){this.x=d.x;this.y=d.y;this.z=d.z;return this};g.cross=function(d,b){var a=d.x,c=d.y;d=d.z;var e=b.x,f=b.y;b=b.z;this.x=c*b-f*d;this.y=d*e-b*a;this.z=a*f-e*c;return this};
g.distance=function(d){var b=this.x-d.x,a=this.y-d.y;d=this.z-d.z;return Math.sqrt(b*b+a*a+d*d)};g.dot=function(d){return this.x*d.x+this.y*d.y+this.z*d.z};g.equals=function(d){return this.x===d.x&&this.y===d.y&&this.z===d.z};g.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};g.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z};g.lerp=function(d,b,a){this.x=d.x+a*(b.x-d.x);this.y=d.y+a*(b.y-d.y);this.z=d.z+a*(b.z-d.z);return this};g.mul=function(d){this.x*=
d.x;this.y*=d.y;this.z*=d.z;return this};g.mul2=function(d,b){this.x=d.x*b.x;this.y=d.y*b.y;this.z=d.z*b.z;return this};g.normalize=function(){var d=this.x*this.x+this.y*this.y+this.z*this.z;0<d&&(d=1/Math.sqrt(d),this.x*=d,this.y*=d,this.z*=d);return this};g.project=function(d){var b=(this.x*d.x+this.y*d.y+this.z*d.z)/(d.x*d.x+d.y*d.y+d.z*d.z);this.x=d.x*b;this.y=d.y*b;this.z=d.z*b;return this};g.scale=function(d){this.x*=d;this.y*=d;this.z*=d;return this};g.set=function(d,b,a){this.x=d;this.y=b;
this.z=a;return this};g.sub=function(d){this.x-=d.x;this.y-=d.y;this.z-=d.z;return this};g.sub2=function(d,b){this.x=d.x-b.x;this.y=d.y-b.y;this.z=d.z-b.z;return this};g.toString=function(){return"["+this.x+", "+this.y+", "+this.z+"]"};return l}();A.ZERO=Object.freeze(new A(0,0,0));A.ONE=Object.freeze(new A(1,1,1));A.UP=Object.freeze(new A(0,1,0));A.DOWN=Object.freeze(new A(0,-1,0));A.RIGHT=Object.freeze(new A(1,0,0));A.LEFT=Object.freeze(new A(-1,0,0));A.FORWARD=Object.freeze(new A(0,0,-1));A.BACK=
Object.freeze(new A(0,0,1));var Z=function(){function l(d,b,a,c){void 0===d&&(d=0);void 0===b&&(b=0);void 0===a&&(a=0);void 0===c&&(c=0);4===d.length?(this.x=d[0],this.y=d[1],this.z=d[2],this.w=d[3]):(this.x=d,this.y=b,this.z=a,this.w=c)}var g=l.prototype;g.add=function(d){this.x+=d.x;this.y+=d.y;this.z+=d.z;this.w+=d.w;return this};g.add2=function(d,b){this.x=d.x+b.x;this.y=d.y+b.y;this.z=d.z+b.z;this.w=d.w+b.w;return this};g.clone=function(){return new l(this.x,this.y,this.z,this.w)};g.copy=function(d){this.x=
d.x;this.y=d.y;this.z=d.z;this.w=d.w;return this};g.dot=function(d){return this.x*d.x+this.y*d.y+this.z*d.z+this.w*d.w};g.equals=function(d){return this.x===d.x&&this.y===d.y&&this.z===d.z&&this.w===d.w};g.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)};g.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w};g.lerp=function(d,b,a){this.x=d.x+a*(b.x-d.x);this.y=d.y+a*(b.y-d.y);this.z=d.z+a*(b.z-d.z);this.w=d.w+a*(b.w-d.w);return this};
g.mul=function(d){this.x*=d.x;this.y*=d.y;this.z*=d.z;this.w*=d.w;return this};g.mul2=function(d,b){this.x=d.x*b.x;this.y=d.y*b.y;this.z=d.z*b.z;this.w=d.w*b.w;return this};g.normalize=function(){var d=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;0<d&&(d=1/Math.sqrt(d),this.x*=d,this.y*=d,this.z*=d,this.w*=d);return this};g.scale=function(d){this.x*=d;this.y*=d;this.z*=d;this.w*=d;return this};g.set=function(d,b,a,c){this.x=d;this.y=b;this.z=a;this.w=c;return this};g.sub=function(d){this.x-=
d.x;this.y-=d.y;this.z-=d.z;this.w-=d.w;return this};g.sub2=function(d,b){this.x=d.x-b.x;this.y=d.y-b.y;this.z=d.z-b.z;this.w=d.w-b.w;return this};g.toString=function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"};return l}();Z.ZERO=Object.freeze(new Z(0,0,0,0));Z.ONE=Object.freeze(new Z(1,1,1,1));var Xd=new S,Cc=new A,fc=new A,gc=new A,ff=new A,M=function(){function l(){var d=new Float32Array(16);d[0]=d[5]=d[10]=d[15]=1;this.data=d}l._getPerspectiveHalfSize=function(d,b,a,c,e){e?(d.x=
c*Math.tan(b*Math.PI/360),d.y=d.x/a):(d.y=c*Math.tan(b*Math.PI/360),d.x=d.y*a)};var g=l.prototype;g.add2=function(d,b){d=d.data;b=b.data;var a=this.data;a[0]=d[0]+b[0];a[1]=d[1]+b[1];a[2]=d[2]+b[2];a[3]=d[3]+b[3];a[4]=d[4]+b[4];a[5]=d[5]+b[5];a[6]=d[6]+b[6];a[7]=d[7]+b[7];a[8]=d[8]+b[8];a[9]=d[9]+b[9];a[10]=d[10]+b[10];a[11]=d[11]+b[11];a[12]=d[12]+b[12];a[13]=d[13]+b[13];a[14]=d[14]+b[14];a[15]=d[15]+b[15];return this};g.add=function(d){return this.add2(this,d)};g.clone=function(){return(new l).copy(this)};
g.copy=function(d){d=d.data;var b=this.data;b[0]=d[0];b[1]=d[1];b[2]=d[2];b[3]=d[3];b[4]=d[4];b[5]=d[5];b[6]=d[6];b[7]=d[7];b[8]=d[8];b[9]=d[9];b[10]=d[10];b[11]=d[11];b[12]=d[12];b[13]=d[13];b[14]=d[14];b[15]=d[15];return this};g.equals=function(d){var b=this.data;d=d.data;return b[0]===d[0]&&b[1]===d[1]&&b[2]===d[2]&&b[3]===d[3]&&b[4]===d[4]&&b[5]===d[5]&&b[6]===d[6]&&b[7]===d[7]&&b[8]===d[8]&&b[9]===d[9]&&b[10]===d[10]&&b[11]===d[11]&&b[12]===d[12]&&b[13]===d[13]&&b[14]===d[14]&&b[15]===d[15]};
g.isIdentity=function(){var d=this.data;return 1===d[0]&&0===d[1]&&0===d[2]&&0===d[3]&&0===d[4]&&1===d[5]&&0===d[6]&&0===d[7]&&0===d[8]&&0===d[9]&&1===d[10]&&0===d[11]&&0===d[12]&&0===d[13]&&0===d[14]&&1===d[15]};g.mul2=function(d,b){var a=d.data;var c=b.data,e=this.data;b=a[0];d=a[1];var f=a[2];var h=a[3];var k=a[4];var m=a[5];var n=a[6];var p=a[7];var t=a[8];var r=a[9];var u=a[10];var v=a[11];var w=a[12];var y=a[13];var x=a[14];a=a[15];var z=c[0];var B=c[1];var C=c[2];var D=c[3];e[0]=b*z+k*B+t*
C+w*D;e[1]=d*z+m*B+r*C+y*D;e[2]=f*z+n*B+u*C+x*D;e[3]=h*z+p*B+v*C+a*D;z=c[4];B=c[5];C=c[6];D=c[7];e[4]=b*z+k*B+t*C+w*D;e[5]=d*z+m*B+r*C+y*D;e[6]=f*z+n*B+u*C+x*D;e[7]=h*z+p*B+v*C+a*D;z=c[8];B=c[9];C=c[10];D=c[11];e[8]=b*z+k*B+t*C+w*D;e[9]=d*z+m*B+r*C+y*D;e[10]=f*z+n*B+u*C+x*D;e[11]=h*z+p*B+v*C+a*D;z=c[12];B=c[13];C=c[14];D=c[15];e[12]=b*z+k*B+t*C+w*D;e[13]=d*z+m*B+r*C+y*D;e[14]=f*z+n*B+u*C+x*D;e[15]=h*z+p*B+v*C+a*D;return this};g.mulAffine2=function(d,b){var a=d.data;var c=b.data,e=this.data;b=a[0];
d=a[1];var f=a[2];var h=a[4];var k=a[5];var m=a[6];var n=a[8];var p=a[9];var t=a[10];var r=a[12];var u=a[13];a=a[14];var v=c[0];var w=c[1];var y=c[2];e[0]=b*v+h*w+n*y;e[1]=d*v+k*w+p*y;e[2]=f*v+m*w+t*y;e[3]=0;v=c[4];w=c[5];y=c[6];e[4]=b*v+h*w+n*y;e[5]=d*v+k*w+p*y;e[6]=f*v+m*w+t*y;e[7]=0;v=c[8];w=c[9];y=c[10];e[8]=b*v+h*w+n*y;e[9]=d*v+k*w+p*y;e[10]=f*v+m*w+t*y;e[11]=0;v=c[12];w=c[13];y=c[14];e[12]=b*v+h*w+n*y+r;e[13]=d*v+k*w+p*y+u;e[14]=f*v+m*w+t*y+a;e[15]=1;return this};g.mul=function(d){return this.mul2(this,
d)};g.transformPoint=function(d,b){void 0===b&&(b=new A);var a=this.data;var c=d.x;var e=d.y;d=d.z;b.x=c*a[0]+e*a[4]+d*a[8]+a[12];b.y=c*a[1]+e*a[5]+d*a[9]+a[13];b.z=c*a[2]+e*a[6]+d*a[10]+a[14];return b};g.transformVector=function(d,b){void 0===b&&(b=new A);var a=this.data;var c=d.x;var e=d.y;d=d.z;b.x=c*a[0]+e*a[4]+d*a[8];b.y=c*a[1]+e*a[5]+d*a[9];b.z=c*a[2]+e*a[6]+d*a[10];return b};g.transformVec4=function(d,b){void 0===b&&(b=new Z);var a=this.data;var c=d.x;var e=d.y;var f=d.z;d=d.w;b.x=c*a[0]+e*
a[4]+f*a[8]+d*a[12];b.y=c*a[1]+e*a[5]+f*a[9]+d*a[13];b.z=c*a[2]+e*a[6]+f*a[10]+d*a[14];b.w=c*a[3]+e*a[7]+f*a[11]+d*a[15];return b};g.setLookAt=function(d,b,a){gc.sub2(d,b).normalize();fc.copy(a).normalize();Cc.cross(fc,gc).normalize();fc.cross(gc,Cc);b=this.data;b[0]=Cc.x;b[1]=Cc.y;b[2]=Cc.z;b[3]=0;b[4]=fc.x;b[5]=fc.y;b[6]=fc.z;b[7]=0;b[8]=gc.x;b[9]=gc.y;b[10]=gc.z;b[11]=0;b[12]=d.x;b[13]=d.y;b[14]=d.z;b[15]=1;return this};g.setFrustum=function(d,b,a,c,e,f){var h=2*e;var k=b-d;var m=c-a;var n=f-e;
var p=this.data;p[0]=h/k;p[1]=0;p[2]=0;p[3]=0;p[4]=0;p[5]=h/m;p[6]=0;p[7]=0;p[8]=(b+d)/k;p[9]=(c+a)/m;p[10]=(-f-e)/n;p[11]=-1;p[12]=0;p[13]=0;p[14]=-h*f/n;p[15]=0;return this};g.setPerspective=function(d,b,a,c,e){l._getPerspectiveHalfSize(Xd,d,b,a,e);return this.setFrustum(-Xd.x,Xd.x,-Xd.y,Xd.y,a,c)};g.setOrtho=function(d,b,a,c,e,f){var h=this.data;h[0]=2/(b-d);h[1]=0;h[2]=0;h[3]=0;h[4]=0;h[5]=2/(c-a);h[6]=0;h[7]=0;h[8]=0;h[9]=0;h[10]=-2/(f-e);h[11]=0;h[12]=-(b+d)/(b-d);h[13]=-(c+a)/(c-a);h[14]=-(f+
e)/(f-e);h[15]=1;return this};g.setFromAxisAngle=function(d,b){b*=R.DEG_TO_RAD;var a=d.x;var c=d.y;d=d.z;var e=Math.cos(b);b=Math.sin(b);var f=1-e;var h=f*a;var k=f*c;var m=this.data;m[0]=h*a+e;m[1]=h*c+b*d;m[2]=h*d-b*c;m[3]=0;m[4]=h*c-b*d;m[5]=k*c+e;m[6]=k*d+b*a;m[7]=0;m[8]=h*d+b*c;m[9]=k*d-a*b;m[10]=f*d*d+e;m[11]=0;m[12]=0;m[13]=0;m[14]=0;m[15]=1;return this};g.setTranslate=function(d,b,a){var c=this.data;c[0]=1;c[1]=0;c[2]=0;c[3]=0;c[4]=0;c[5]=1;c[6]=0;c[7]=0;c[8]=0;c[9]=0;c[10]=1;c[11]=0;c[12]=
d;c[13]=b;c[14]=a;c[15]=1;return this};g.setScale=function(d,b,a){var c=this.data;c[0]=d;c[1]=0;c[2]=0;c[3]=0;c[4]=0;c[5]=b;c[6]=0;c[7]=0;c[8]=0;c[9]=0;c[10]=a;c[11]=0;c[12]=0;c[13]=0;c[14]=0;c[15]=1;return this};g.invert=function(){var d=this.data;var b=d[0];var a=d[1];var c=d[2];var e=d[3];var f=d[4];var h=d[5];var k=d[6];var m=d[7];var n=d[8];var p=d[9];var t=d[10];var r=d[11];var u=d[12];var v=d[13];var w=d[14];var y=d[15];var x=b*h-a*f;var z=b*k-c*f;var B=b*m-e*f;var C=a*k-c*h;var D=a*m-e*h;
var G=c*m-e*k;var J=n*v-p*u;var E=n*w-t*u;var H=n*y-r*u;var P=p*w-t*v;var Y=p*y-r*v;var L=t*y-r*w;var V=x*L-z*Y+B*P+C*H-D*E+G*J;0===V?this.setIdentity():(V=1/V,d[0]=(h*L-k*Y+m*P)*V,d[1]=(-a*L+c*Y-e*P)*V,d[2]=(v*G-w*D+y*C)*V,d[3]=(-p*G+t*D-r*C)*V,d[4]=(-f*L+k*H-m*E)*V,d[5]=(b*L-c*H+e*E)*V,d[6]=(-u*G+w*B-y*z)*V,d[7]=(n*G-t*B+r*z)*V,d[8]=(f*Y-h*H+m*J)*V,d[9]=(-b*Y+a*H-e*J)*V,d[10]=(u*D-v*B+y*x)*V,d[11]=(-n*D+p*B-r*x)*V,d[12]=(-f*P+h*E-k*J)*V,d[13]=(b*P-a*E+c*J)*V,d[14]=(-u*C+v*z-w*x)*V,d[15]=(n*C-p*
z+t*x)*V);return this};g.set=function(d){var b=this.data;b[0]=d[0];b[1]=d[1];b[2]=d[2];b[3]=d[3];b[4]=d[4];b[5]=d[5];b[6]=d[6];b[7]=d[7];b[8]=d[8];b[9]=d[9];b[10]=d[10];b[11]=d[11];b[12]=d[12];b[13]=d[13];b[14]=d[14];b[15]=d[15];return this};g.setIdentity=function(){var d=this.data;d[0]=1;d[1]=0;d[2]=0;d[3]=0;d[4]=0;d[5]=1;d[6]=0;d[7]=0;d[8]=0;d[9]=0;d[10]=1;d[11]=0;d[12]=0;d[13]=0;d[14]=0;d[15]=1;return this};g.setTRS=function(d,b,a){var c=b.x;var e=b.y;var f=b.z;var h=b.w;b=a.x;var k=a.y;a=a.z;
var m=c+c;var n=e+e;var p=f+f;var t=c*m;var r=c*n;c*=p;var u=e*n;e*=p;f*=p;m*=h;n*=h;h*=p;p=this.data;p[0]=(1-(u+f))*b;p[1]=(r+h)*b;p[2]=(c-n)*b;p[3]=0;p[4]=(r-h)*k;p[5]=(1-(t+f))*k;p[6]=(e+m)*k;p[7]=0;p[8]=(c+n)*a;p[9]=(e-m)*a;p[10]=(1-(t+u))*a;p[11]=0;p[12]=d.x;p[13]=d.y;p[14]=d.z;p[15]=1;return this};g.transpose=function(){var d=this.data;var b=d[1];d[1]=d[4];d[4]=b;b=d[2];d[2]=d[8];d[8]=b;b=d[3];d[3]=d[12];d[12]=b;b=d[6];d[6]=d[9];d[9]=b;b=d[7];d[7]=d[13];d[13]=b;b=d[11];d[11]=d[14];d[14]=b;return this};
g.invertTo3x3=function(d){var b=this.data;d=d.data;var a=b[0],c=b[1],e=b[2],f=b[4],h=b[5],k=b[6],m=b[8],n=b[9],p=b[10];b=p*h-k*n;var t=-p*f+k*m;var r=n*f-h*m;var u=a*b+c*t+e*r;if(0===u)return this;u=1/u;d[0]=u*b;d[1]=u*(-p*c+e*n);d[2]=u*(k*c-e*h);d[3]=u*t;d[4]=u*(p*a-e*m);d[5]=u*(-k*a+e*f);d[6]=u*r;d[7]=u*(-n*a+c*m);d[8]=u*(h*a-c*f);return this};g.getTranslation=function(d){void 0===d&&(d=new A);return d.set(this.data[12],this.data[13],this.data[14])};g.getX=function(d){void 0===d&&(d=new A);return d.set(this.data[0],
this.data[1],this.data[2])};g.getY=function(d){void 0===d&&(d=new A);return d.set(this.data[4],this.data[5],this.data[6])};g.getZ=function(d){void 0===d&&(d=new A);return d.set(this.data[8],this.data[9],this.data[10])};g.getScale=function(d){void 0===d&&(d=new A);this.getX(Cc);this.getY(fc);this.getZ(gc);d.set(Cc.length(),fc.length(),gc.length());return d};g.setFromEulerAngles=function(d,b,a){d*=R.DEG_TO_RAD;b*=R.DEG_TO_RAD;a*=R.DEG_TO_RAD;var c=Math.sin(-d);d=Math.cos(-d);var e=Math.sin(-b);b=Math.cos(-b);
var f=Math.sin(-a);a=Math.cos(-a);var h=this.data;h[0]=b*a;h[1]=-b*f;h[2]=e;h[3]=0;h[4]=d*f+a*c*e;h[5]=d*a-c*e*f;h[6]=-b*c;h[7]=0;h[8]=c*f-d*a*e;h[9]=a*c+d*e*f;h[10]=d*b;h[11]=0;h[12]=0;h[13]=0;h[14]=0;h[15]=1;return this};g.getEulerAngles=function(d){void 0===d&&(d=new A);this.getScale(ff);var b=ff.x;var a=ff.y;var c=ff.z;var e=this.data;var f=Math.asin(-e[2]/b);var h=.5*Math.PI;f<h?f>-h?(a=Math.atan2(e[6]/a,e[10]/c),b=Math.atan2(e[1]/b,e[0]/b)):(b=0,a=-Math.atan2(e[4]/a,e[5]/a)):(b=0,a=Math.atan2(e[4]/
a,e[5]/a));return d.set(a,f,b).scale(R.RAD_TO_DEG)};g.toString=function(){var d;var b="[";for(d=0;16>d;d+=1)b+=this.data[d],b+=15!==d?", ":"";return b+"]"};return l}();M.IDENTITY=Object.freeze(new M);M.ZERO=Object.freeze((new M).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));var ea=function(){function l(d,b,a,c){void 0===d&&(d=0);void 0===b&&(b=0);void 0===a&&(a=0);void 0===c&&(c=1);4===d.length?(this.x=d[0],this.y=d[1],this.z=d[2],this.w=d[3]):(this.x=d,this.y=b,this.z=a,this.w=c)}var g=l.prototype;g.clone=
function(){return new l(this.x,this.y,this.z,this.w)};g.conjugate=function(){this.x*=-1;this.y*=-1;this.z*=-1;return this};g.copy=function(d){this.x=d.x;this.y=d.y;this.z=d.z;this.w=d.w;return this};g.equals=function(d){return this.x===d.x&&this.y===d.y&&this.z===d.z&&this.w===d.w};g.getAxisAngle=function(d){var b=2*Math.acos(this.w),a=Math.sin(b/2);if(0!==a){if(d.x=this.x/a,d.y=this.y/a,d.z=this.z/a,0>d.x||0>d.y||0>d.z)d.x*=-1,d.y*=-1,d.z*=-1,b*=-1}else d.x=1,d.y=0,d.z=0;return b*R.RAD_TO_DEG};g.getEulerAngles=
function(d){void 0===d&&(d=new A);var b=this.x;var a=this.y;var c=this.z;var e=this.w;var f=2*(e*a-b*c);if(-.99999>=f){var h=2*Math.atan2(b,e);f=-Math.PI/2;b=0}else.99999<=f?(h=2*Math.atan2(b,e),f=Math.PI/2,b=0):(h=Math.atan2(2*(e*b+a*c),1-2*(b*b+a*a)),f=Math.asin(f),b=Math.atan2(2*(e*c+b*a),1-2*(a*a+c*c)));return d.set(h,f,b).scale(R.RAD_TO_DEG)};g.invert=function(){return this.conjugate().normalize()};g.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)};
g.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w};g.mul=function(d){var b=this.x;var a=this.y;var c=this.z;var e=this.w;var f=d.x;var h=d.y;var k=d.z;d=d.w;this.x=e*f+b*d+a*k-c*h;this.y=e*h+a*d+c*f-b*k;this.z=e*k+c*d+b*h-a*f;this.w=e*d-b*f-a*h-c*k;return this};g.mul2=function(d,b){var a=d.x;var c=d.y;var e=d.z;d=d.w;var f=b.x;var h=b.y;var k=b.z;b=b.w;this.x=d*f+a*b+c*k-e*h;this.y=d*h+c*b+e*f-a*k;this.z=d*k+e*b+a*h-c*f;this.w=d*b-a*f-c*h-e*k;return this};g.normalize=
function(){var d=this.length();0===d?(this.x=this.y=this.z=0,this.w=1):(d=1/d,this.x*=d,this.y*=d,this.z*=d,this.w*=d);return this};g.set=function(d,b,a,c){this.x=d;this.y=b;this.z=a;this.w=c;return this};g.setFromAxisAngle=function(d,b){b*=.5*R.DEG_TO_RAD;var a=Math.sin(b);b=Math.cos(b);this.x=a*d.x;this.y=a*d.y;this.z=a*d.z;this.w=b;return this};g.setFromEulerAngles=function(d,b,a){var c=.5*R.DEG_TO_RAD;d*=c;b*=c;a*=c;c=Math.sin(d);d=Math.cos(d);var e=Math.sin(b);b=Math.cos(b);var f=Math.sin(a);
a=Math.cos(a);this.x=c*b*a-d*e*f;this.y=d*e*a+c*b*f;this.z=d*b*f-c*e*a;this.w=d*b*a+c*e*f;return this};g.setFromMat4=function(d){d=d.data;var b=d[0];var a=d[1];var c=d[2];var e=d[4];var f=d[5];var h=d[6];var k=d[8];var m=d[9];d=d[10];var n=b*b+a*a+c*c;if(0===n)return this;n=1/Math.sqrt(n);var p=e*e+f*f+h*h;if(0===p)return this;p=1/Math.sqrt(p);var t=k*k+m*m+d*d;if(0===t)return this;t=1/Math.sqrt(t);b*=n;a*=n;c*=n;e*=p;f*=p;h*=p;k*=t;m*=t;d*=t;n=b+f+d;0<=n?(b=Math.sqrt(n+1),this.w=.5*b,b=.5/b,this.x=
(h-m)*b,this.y=(k-c)*b,this.z=(a-e)*b):b>f?b>d?(b=Math.sqrt(b-(f+d)+1),this.x=.5*b,b=.5/b,this.w=(h-m)*b,this.y=(a+e)*b,this.z=(c+k)*b):(b=Math.sqrt(d-(b+f)+1),this.z=.5*b,b=.5/b,this.w=(a-e)*b,this.x=(k+c)*b,this.y=(m+h)*b):f>d?(b=Math.sqrt(f-(d+b)+1),this.y=.5*b,b=.5/b,this.w=(k-c)*b,this.z=(h+m)*b,this.x=(e+a)*b):(b=Math.sqrt(d-(b+f)+1),this.z=.5*b,b=.5/b,this.w=(a-e)*b,this.x=(k+c)*b,this.y=(m+h)*b);return this};g.slerp=function(d,b,a){var c=d.x;var e=d.y;var f=d.z;d=d.w;var h=b.x;var k=b.y;var m=
b.z;b=b.w;var n=d*b+c*h+e*k+f*m;0>n&&(b=-b,h=-h,k=-k,m=-m,n=-n);if(1<=Math.abs(n))return this.w=d,this.x=c,this.y=e,this.z=f,this;var p=Math.acos(n),t=Math.sqrt(1-n*n);if(.001>Math.abs(t))return this.w=.5*d+.5*b,this.x=.5*c+.5*h,this.y=.5*e+.5*k,this.z=.5*f+.5*m,this;n=Math.sin((1-a)*p)/t;a=Math.sin(a*p)/t;this.w=d*n+b*a;this.x=c*n+h*a;this.y=e*n+k*a;this.z=f*n+m*a;return this};g.transformVector=function(d,b){void 0===b&&(b=new A);var a=d.x,c=d.y,e=d.z;d=this.x;var f=this.y,h=this.z,k=this.w,m=k*
a+f*e-h*c,n=k*c+h*a-d*e,p=k*e+d*c-f*a;a=-d*a-f*c-h*e;b.x=m*k+a*-d+n*-h-p*-f;b.y=n*k+a*-f+p*-d-m*-h;b.z=p*k+a*-h+m*-f-n*-d;return b};g.toString=function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"};return l}();ea.IDENTITY=Object.freeze(new ea(0,0,0,1));ea.ZERO=Object.freeze(new ea(0,0,0,0));var Gb=new A,mb=new A,Yd=new A,Zd=new A,Dc=new A,la=function(){function l(d,b){void 0===d&&(d=new A);void 0===b&&(b=new A(.5,.5,.5));this.center=d;this.halfExtents=b;this._min=new A;this._max=new A}
var g=l.prototype;g.add=function(d){var b=this.center,a=b.x,c=b.y,e=b.z,f=this.halfExtents,h=f.x,k=f.y,m=f.z,n=a-h;a+=h;h=c-k;c+=k;k=e-m;e+=m;m=d.center;var p=m.x,t=m.y;m=m.z;d=d.halfExtents;var r=d.x,u=d.y,v=d.z;d=p-r;p+=r;r=t-u;t+=u;u=m-v;m+=v;d<n&&(n=d);p>a&&(a=p);r<h&&(h=r);t>c&&(c=t);u<k&&(k=u);m>e&&(e=m);b.x=.5*(n+a);b.y=.5*(h+c);b.z=.5*(k+e);f.x=.5*(a-n);f.y=.5*(c-h);f.z=.5*(e-k)};g.copy=function(d){this.center.copy(d.center);this.halfExtents.copy(d.halfExtents)};g.clone=function(){return new l(this.center.clone(),
this.halfExtents.clone())};g.intersects=function(d){var b=this.getMax(),a=this.getMin(),c=d.getMax();d=d.getMin();return a.x<=c.x&&b.x>=d.x&&a.y<=c.y&&b.y>=d.y&&a.z<=c.z&&b.z>=d.z};g._intersectsRay=function(d,b){var a=Gb.copy(this.getMin()).sub(d.origin),c=mb.copy(this.getMax()).sub(d.origin),e=d.direction;0===e.x?(a.x=0>a.x?-Number.MAX_VALUE:Number.MAX_VALUE,c.x=0>c.x?-Number.MAX_VALUE:Number.MAX_VALUE):(a.x/=e.x,c.x/=e.x);0===e.y?(a.y=0>a.y?-Number.MAX_VALUE:Number.MAX_VALUE,c.y=0>c.y?-Number.MAX_VALUE:
Number.MAX_VALUE):(a.y/=e.y,c.y/=e.y);0===e.z?(a.z=0>a.z?-Number.MAX_VALUE:Number.MAX_VALUE,c.z=0>c.z?-Number.MAX_VALUE:Number.MAX_VALUE):(a.z/=e.z,c.z/=e.z);e=Yd.set(Math.min(a.x,c.x),Math.min(a.y,c.y),Math.min(a.z,c.z));a=Zd.set(Math.max(a.x,c.x),Math.max(a.y,c.y),Math.max(a.z,c.z));c=Math.max(Math.max(e.x,e.y),e.z);(a=Math.min(Math.min(a.x,a.y),a.z)>=c&&0<=c)&&b.copy(d.direction).scale(c).add(d.origin);return a};g._fastIntersectsRay=function(d){var b=d.direction;Gb.sub2(d.origin,this.center);Zd.set(Math.abs(Gb.x),
Math.abs(Gb.y),Math.abs(Gb.z));Yd.mul2(Gb,b);if(Zd.x>this.halfExtents.x&&0<=Yd.x||Zd.y>this.halfExtents.y&&0<=Yd.y||Zd.z>this.halfExtents.z&&0<=Yd.z)return!1;Dc.set(Math.abs(b.x),Math.abs(b.y),Math.abs(b.z));mb.cross(b,Gb);mb.set(Math.abs(mb.x),Math.abs(mb.y),Math.abs(mb.z));return mb.x>this.halfExtents.y*Dc.z+this.halfExtents.z*Dc.y||mb.y>this.halfExtents.x*Dc.z+this.halfExtents.z*Dc.x||mb.z>this.halfExtents.x*Dc.y+this.halfExtents.y*Dc.x?!1:!0};g.intersectsRay=function(d,b){return b?this._intersectsRay(d,
b):this._fastIntersectsRay(d)};g.setMinMax=function(d,b){this.center.add2(b,d).scale(.5);this.halfExtents.sub2(b,d).scale(.5)};g.getMin=function(){return this._min.copy(this.center).sub(this.halfExtents)};g.getMax=function(){return this._max.copy(this.center).add(this.halfExtents)};g.containsPoint=function(d){var b=this.getMin(),a=this.getMax();return d.x<b.x||d.x>a.x||d.y<b.y||d.y>a.y||d.z<b.z||d.z>a.z?!1:!0};g.setFromTransformedAabb=function(d,b){var a=d.center;d=d.halfExtents;b=b.data;var c=b[0],
e=b[4],f=b[8],h=b[1],k=b[5],m=b[9],n=b[2],p=b[6],t=b[10];this.center.set(b[12]+c*a.x+e*a.y+f*a.z,b[13]+h*a.x+k*a.y+m*a.z,b[14]+n*a.x+p*a.y+t*a.z);this.halfExtents.set(Math.abs(c)*d.x+Math.abs(e)*d.y+Math.abs(f)*d.z,Math.abs(h)*d.x+Math.abs(k)*d.y+Math.abs(m)*d.z,Math.abs(n)*d.x+Math.abs(p)*d.y+Math.abs(t)*d.z)};g.compute=function(d,b){b=void 0===b?d.length/3:b;if(0<b){for(var a=Gb.set(d[0],d[1],d[2]),c=mb.set(d[0],d[1],d[2]),e=1;e<b;e++){var f=d[3*e],h=d[3*e+1],k=d[3*e+2];f<a.x&&(a.x=f);h<a.y&&(a.y=
h);k<a.z&&(a.z=k);f>c.x&&(c.x=f);h>c.y&&(c.y=h);k>c.z&&(c.z=k)}this.setMinMax(a,c)}};g.intersectsBoundingSphere=function(d){return this._distanceToBoundingSphereSq(d)<=d.radius*d.radius?!0:!1};g._distanceToBoundingSphereSq=function(d){for(var b=this.getMin(),a=this.getMax(),c=0,e=["x","y","z"],f=0;3>f;++f){var h=0,k=d.center[e[f]],m=b[e[f]],n=a[e[f]];k<m&&(m-=k,h+=m*m);k>n&&(m=k-n,h+=m*m);c+=h}return c};g._expand=function(d,b){Gb.add2(this.getMin(),d);mb.add2(this.getMax(),b);this.setMinMax(Gb,mb)};
return l}(),hc=new A,gf=new A,cd=new A,yj=new A,dd=function(){function l(d,b){void 0===d&&(d=new A);void 0===b&&(b=.5);this.center=d;this.radius=b}var g=l.prototype;g.containsPoint=function(d){d=hc.sub2(d,this.center).lengthSq();var b=this.radius;return d<b*b};g.compute=function(d){var b,a=d.length/3;for(b=0;b<a;b++)hc.set(d[3*b],d[3*b+1],d[3*b+2]),cd.addSelf(hc),0===b%100&&(cd.scale(1/a),gf.add(cd),cd.set(0,0,0));cd.scale(1/a);gf.add(cd);this.center.copy(gf);var c=0;for(b=0;b<a;b++)hc.set(d[3*b],
d[3*b+1],d[3*b+2]),yj.sub2(hc,this.center),c=Math.max(yj.lengthSq(),c);this.radius=Math.sqrt(c)};g.intersectsRay=function(d,b){var a=hc.copy(d.origin).sub(this.center),c=a.dot(gf.copy(d.direction).normalize());a=a.dot(a)-this.radius*this.radius;if(0<a&&0<c)return null;a=c*c-a;if(0>a)return!1;c=Math.abs(-c-Math.sqrt(a));b&&b.copy(d.direction).scale(c).add(d.origin);return!0};g.intersectsBoundingSphere=function(d){hc.sub2(d.center,this.center);d=d.radius+this.radius;return hc.lengthSq()<=d*d?!0:!1};
return l}(),Og=function(){function l(){this.planes=[];for(var d=0;6>d;d++)this.planes[d]=[]}var g=l.prototype;g.setFromMat4=function(d){d=d.data;var b=this.planes;var a=b[0];a[0]=d[3]-d[0];a[1]=d[7]-d[4];a[2]=d[11]-d[8];a[3]=d[15]-d[12];var c=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=c;a[1]/=c;a[2]/=c;a[3]/=c;a=b[1];a[0]=d[3]+d[0];a[1]=d[7]+d[4];a[2]=d[11]+d[8];a[3]=d[15]+d[12];c=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=c;a[1]/=c;a[2]/=c;a[3]/=c;a=b[2];a[0]=d[3]+d[1];a[1]=d[7]+d[5];a[2]=
d[11]+d[9];a[3]=d[15]+d[13];c=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=c;a[1]/=c;a[2]/=c;a[3]/=c;a=b[3];a[0]=d[3]-d[1];a[1]=d[7]-d[5];a[2]=d[11]-d[9];a[3]=d[15]-d[13];c=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=c;a[1]/=c;a[2]/=c;a[3]/=c;a=b[4];a[0]=d[3]-d[2];a[1]=d[7]-d[6];a[2]=d[11]-d[10];a[3]=d[15]-d[14];c=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=c;a[1]/=c;a[2]/=c;a[3]/=c;a=b[5];a[0]=d[3]+d[2];a[1]=d[7]+d[6];a[2]=d[11]+d[10];a[3]=d[15]+d[14];c=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*
a[2]);a[0]/=c;a[1]/=c;a[2]/=c;a[3]/=c};g.containsPoint=function(d){var b;for(b=0;6>b;b++){var a=this.planes[b];if(0>=a[0]*d.x+a[1]*d.y+a[2]*d.z+a[3])return!1}return!0};g.containsSphere=function(d){var b=0,a=d.radius;var c=d.center;d=c.x;var e=c.y,f=c.z,h=this.planes;for(c=0;6>c;c++){var k=h[c];k=k[0]*d+k[1]*e+k[2]*f+k[3];if(k<=-a)return 0;k>a&&b++}return 6===b?2:1};return l}(),Ec=function(){function l(g,d){void 0===g&&(g=new A);void 0===d&&(d=new A(0,0,-1));this.origin=g;this.direction=d}l.prototype.set=
function(g,d){this.origin.copy(g);this.direction.copy(d);return this};return l}(),hf=new Ec,zj=new A,Pg=new dd,eo=new M,fo=function(){function l(d,b){void 0===d&&(d=new M);void 0===b&&(b=new A(.5,.5,.5));this.halfExtents=b;this._modelTransform=d.clone().invert();this._worldTransform=d.clone();this._aabb=new la(new A,this.halfExtents)}var g=l.prototype;g.intersectsRay=function(d,b){this._modelTransform.transformPoint(d.origin,hf.origin);this._modelTransform.transformVector(d.direction,hf.direction);
return b?(d=this._aabb._intersectsRay(hf,b),eo.copy(this._modelTransform).invert().transformPoint(b,b),d):this._aabb._fastIntersectsRay(hf)};g.containsPoint=function(d){this._modelTransform.transformPoint(d,zj);return this._aabb.containsPoint(zj)};g.intersectsBoundingSphere=function(d){this._modelTransform.transformPoint(d.center,Pg.center);Pg.radius=d.radius;return this._aabb.intersectsBoundingSphere(Pg)?!0:!1};N(l,[{key:"worldTransform",get:function(){return this._worldTransform},set:function(d){this._worldTransform.copy(d);
this._modelTransform.copy(d).invert()}}]);return l}(),go=new A,Aj=function(){function l(d,b){void 0===d&&(d=new A);void 0===b&&(b=new A(0,0,1));this.normal=b;this.point=d}var g=l.prototype;g.intersectsLine=function(d,b,a){var c=-this.normal.dot(this.point),e=this.normal.dot(d)+c;c=this.normal.dot(b)+c;e/=e-c;(c=0<=e&&1>=e)&&a&&a.lerp(d,b,e);return c};g.intersectsRay=function(d,b){var a=go.sub2(this.point,d.origin);a=this.normal.dot(a)/this.normal.dot(d.direction);var c=0<=a;c&&b&&b.copy(d.direction).scale(a).add(d.origin);
return c};return l}(),Fc=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array],$d=[1,1,2,2,4,4,4],Bj=[Uint8Array,Uint16Array,Uint32Array],Qg={POSITION:0,NORMAL:1,BLENDWEIGHT:2,BLENDINDICES:3,COLOR:4,TEXCOORD0:5,TEXCOORD1:6,TEXCOORD2:7,TEXCOORD3:8,TEXCOORD4:9,TEXCOORD5:10,TEXCOORD6:11,TEXCOORD7:12,TANGENT:13,ATTR0:0,ATTR1:1,ATTR2:2,ATTR3:3,ATTR4:4,ATTR5:5,ATTR6:6,ATTR7:7,ATTR8:8,ATTR9:9,ATTR10:10,ATTR11:11,ATTR12:12,ATTR13:13,ATTR14:14,ATTR15:15},ho=0,Ra=function(){function l(d,
b,a,c,e){void 0===c&&(c=0);this.device=d;this.format=b;this.numVertices=a;this.usage=c;this.id=ho++;this._vao=null;this.numBytes=b.verticesByteSize?b.verticesByteSize:b.size*a;d._vram.vb+=this.numBytes;e?this.setData(e):this.storage=new ArrayBuffer(this.numBytes);this.device.buffers.push(this)}var g=l.prototype;g.destroy=function(){var d=this.device,b=d.buffers.indexOf(this);-1!==b&&d.buffers.splice(b,1);this.bufferId&&(b=d.gl,d.boundVao=null,b.bindVertexArray(null),b.deleteBuffer(this.bufferId),
d._vram.vb-=this.storage.byteLength,this.bufferId=null)};g.loseContext=function(){this.bufferId=void 0;this._vao=null};g.getFormat=function(){return this.format};g.getUsage=function(){return this.usage};g.getNumVertices=function(){return this.numVertices};g.lock=function(){return this.storage};g.unlock=function(){var d=this.device.gl;this.bufferId||(this.bufferId=d.createBuffer());switch(this.usage){case 0:var b=d.STATIC_DRAW;break;case 1:b=d.DYNAMIC_DRAW;break;case 2:b=d.STREAM_DRAW;break;case 3:b=
this.device.webgl2?d.DYNAMIC_COPY:d.STATIC_DRAW}d.bindBuffer(d.ARRAY_BUFFER,this.bufferId);d.bufferData(d.ARRAY_BUFFER,this.storage,b)};g.setData=function(d){if(d.byteLength!==this.numBytes)return console.error("VertexBuffer: wrong initial data size: expected "+this.numBytes+", got "+d.byteLength),!1;this.storage=d;this.unlock();return!0};return l}(),Ma=function(){function l(d,b,a){var c;this.elements=[];this.hasTangents=this.hasColor=this.hasUv1=this.hasUv0=!1;this.verticesByteSize=0;this.vertexCount=
a;this.interleaved=void 0===a;this.size=b.reduce(function(m,n){return m+4*Math.ceil(n.components*$d[n.type]/4)},0);var e=0;d=0;for(c=b.length;d<c;d++){var f=b[d];var h=f.components*$d[f.type];a&&(e=R.roundUp(e,h));var k={name:f.semantic,offset:a?e:f.hasOwnProperty("offset")?f.offset:e,stride:a?h:f.hasOwnProperty("stride")?f.stride:this.size,dataType:f.type,numComponents:f.components,normalize:void 0===f.normalize?!1:f.normalize,size:h};this.elements.push(k);e=a?e+h*a:e+4*Math.ceil(h/4);"TEXCOORD0"===
f.semantic?this.hasUv0=!0:"TEXCOORD1"===f.semantic?this.hasUv1=!0:"COLOR"===f.semantic?this.hasColor=!0:"TANGENT"===f.semantic&&(this.hasTangents=!0)}a&&(this.verticesByteSize=e);this.update()}l.init=function(d){l._defaultInstancingFormat=new l(d,[{semantic:"TEXCOORD2",components:4,type:6},{semantic:"TEXCOORD3",components:4,type:6},{semantic:"TEXCOORD4",components:4,type:6},{semantic:"TEXCOORD5",components:4,type:6}])};var g=l.prototype;g.update=function(){this._evaluateHash()};g._evaluateHash=function(){var d=
[],b=[],a,c=this.elements.length;for(a=0;a<c;a++){var e=this.elements[a];var f=e.name;f+=e.dataType;f+=e.numComponents;f+=e.normalize;d.push(f);f+=e.offset;f+=e.stride;f+=e.size;b.push(f)}d.sort();this.batchingHash=Xc(d.join());this.renderingingHash=Xc(b.join())};N(l,null,[{key:"defaultInstancingFormat",get:function(){return l._defaultInstancingFormat}}]);return l}();Ma._defaultInstancingFormat=null;var io=function(){function l(d,b,a){this.index=0;this.numComponents=b.numComponents;this.array=a.interleaved?
new Fc[b.dataType](d,b.offset):new Fc[b.dataType](d,b.offset,a.vertexCount*b.numComponents);this.stride=b.stride/this.array.constructor.BYTES_PER_ELEMENT;switch(b.numComponents){case 1:this.set=ln;this.getToArray=tn;this.setFromArray=pn;break;case 2:this.set=mn;this.getToArray=un;this.setFromArray=qn;break;case 3:this.set=nn;this.getToArray=vn;this.setFromArray=rn;break;case 4:this.set=on,this.getToArray=wn,this.setFromArray=sn}}var g=l.prototype;g.get=function(d){return this.array[this.index+d]};
g.set=function(d,b,a,c){};g.getToArray=function(d,b,a){};g.setFromArray=function(d,b,a){};return l}(),vb=function(){function l(d){this.vertexBuffer=d;this.vertexFormatSize=d.getFormat().size;this.buffer=this.vertexBuffer.lock();this.accessors=[];this.element={};d=this.vertexBuffer.getFormat();for(var b=0;b<d.elements.length;b++){var a=d.elements[b];this.accessors[b]=new io(this.buffer,a,d);this.element[a.name]=this.accessors[b]}}var g=l.prototype;g.next=function(d){void 0===d&&(d=1);for(var b=0,a=
this.accessors,c=this.accessors.length;b<c;){var e=a[b++];e.index+=d*e.stride}};g.end=function(){this.vertexBuffer.unlock()};g.writeData=function(d,b,a){if(d=this.element[d]){a>this.vertexBuffer.numVertices&&(a=this.vertexBuffer.numVertices);var c,e=d.numComponents;if(this.vertexBuffer.getFormat().interleaved){var f=0;for(c=0;c<a;c++)d.setFromArray(f,b,c*e),f+=d.stride}else if(b.length>a*e)if(a*=e,ArrayBuffer.isView(b))b=b.subarray(0,a),d.array.set(b);else for(c=0;c<a;c++)d.array[c]=b[c];else d.array.set(b)}};
g.readData=function(d,b){d=this.element[d];var a=0;if(d){a=this.vertexBuffer.numVertices;var c,e=d.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(b)&&(b.length=0);var f=d.index=0;for(c=0;c<a;c++)d.getToArray(f,b,c*e),f+=d.stride}else if(ArrayBuffer.isView(b))b.set(d.array);else for(b.length=0,e*=a,c=0;c<e;c++)b[c]=d.array[c]}return a};return l}(),vc=null,xn={type:5,base:0,count:4,indexed:!1},Ld=function(){function l(d,b){this.device=d;this.definition=b;this.init();this.device.createShader(this)}
var g=l.prototype;g.init=function(){this.attributes=[];this.uniforms=[];this.samplers=[];this.failed=this.ready=!1};g.destroy=function(){this.device.destroyShader(this)};g.loseContext=function(){this.init()};return l}(),I={alphaTestPS:"uniform float alpha_ref;\nvoid alphaTest(float a) {\n\tif (a < alpha_ref) discard;\n}\n",ambientConstantPS:"void addAmbient() {\n\tdDiffuseLight += light_globalAmbient;\n}\n",ambientPrefilteredCubePS:"#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nvoid addAmbient() {\n\tvec3 fixedReflDir = fixSeamsStatic(cubeMapRotate(dNormalW), 1.0 - 1.0 / 4.0);\n#ifndef RIGHT_HANDED_CUBEMAP\n\tfixedReflDir.x *= -1.0;\n#endif\n\tdDiffuseLight += processEnvironment($DECODE(textureCube(texture_prefilteredCubeMap4, fixedReflDir)).rgb);\n}\n",
ambientPrefilteredCubeLodPS:"#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nvoid addAmbient() {\n\tvec3 fixedReflDir = fixSeamsStatic(cubeMapRotate(dNormalW), 1.0 - 1.0 / 4.0);\n#ifndef RIGHT_HANDED_CUBEMAP\n\tfixedReflDir.x *= -1.0;\n#endif\n\tdDiffuseLight += processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, 5.0) ).rgb);\n}\n",ambientSHPS:"uniform vec3 ambientSH[9];\nvoid addAmbient() {\n\tvec3 n = cubeMapRotate(dNormalW);\n\tvec3 color =\n\t\tambientSH[0] +\n\t\tambientSH[1] * n.x +\n\t\tambientSH[2] * n.y +\n\t\tambientSH[3] * n.z +\n\t\tambientSH[4] * n.x * n.z +\n\t\tambientSH[5] * n.z * n.y +\n\t\tambientSH[6] * n.y * n.x +\n\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n",
aoPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_aoMap;\n#endif\nvoid applyAO() {\n\tdAo = 1.0;\n\t#ifdef MAPTEXTURE\n\tdAo *= texture2D(texture_aoMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAo *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight *= dAo;\n}\n",aoSpecOccPS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",
aoSpecOccConstPS:"void occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccConstSimplePS:"void occludeSpecular() {\n\tfloat specOcc = dAo;\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccSimplePS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",
bakeDirLmEndPS:"\tvec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\tif (bakeDir > 0.5) {\n\t\tif (dAtten > 0.00001) {\n\t\t\tdirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n\t\t\tdAtten = saturate(dAtten);\n\t\t\tgl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n\t\t\tgl_FragColor.a = dirLm.w + dAtten;\n\t\t\tgl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n\t\t} else {\n\t\t\tgl_FragColor = dirLm;\n\t\t}\n\t} else {\n\t\tgl_FragColor.rgb = dirLm.xyz;\n\t\tgl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n\t}\n",
bakeLmEndPS:"\tgl_FragColor.rgb = dDiffuseLight;\n\tgl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n\tgl_FragColor.rgb /= 8.0;\n\tgl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n\tgl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n\tgl_FragColor.rgb /= gl_FragColor.a;\n",basePS:"uniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n\treturn x*x;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n",
baseVS:"attribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\nvec3 dLightPosW;\nvec3 dLightDirNormW;\nvec3 dNormalW;\n",baseNineSlicedPS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",
baseNineSlicedVS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",biasConstPS:"#define SHADOWBIAS\nfloat getShadowBias(float resolution, float maxBias) {\n\treturn maxBias;\n}\n",
blurVSMPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\n#endif\nvoid main(void) {\n\tvec3 moments = vec3(0.0);\n\tvec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n\tfor (int i=0; i<SAMPLES; i++) {\n\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\t\t#ifdef PACKED\n\t\tc.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n\t\t#endif\n\t\t#ifdef GAUSS\n\t\tmoments += c.xyz * weight[i];\n\t\t#else\n\t\tmoments += c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\tmoments /= float(SAMPLES);\n\t#endif\n\t#ifdef PACKED\n\tgl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n\t#else\n\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n\t#endif\n}\n",
clearCoatPS:"#ifdef MAPFLOAT\nuniform float material_clearCoat;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatMap;\n#endif\nvoid getClearCoat() {\n\tccSpecularity = 1.0;\n\t#ifdef MAPFLOAT\n\tccSpecularity *= material_clearCoat;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccSpecularity *= texture2D(texture_clearCoatMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",clearCoatGlossPS:"#ifdef MAPFLOAT\nuniform float material_clearCoatGlossiness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatGlossMap;\n#endif\nvoid getClearCoatGlossiness() {\n\tccGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tccGlossiness *= material_clearCoatGlossiness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tccGlossiness += 0.0000001;\n}\n",
clearCoatNormalPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatNormalMap;\nuniform float material_clearCoatBumpiness;\n#endif\nvoid getClearCoatNormal() {\n\t#ifdef MAPTEXTURE\n\tvec3 normalMap = unpackNormal(texture2D(texture_clearCoatNormalMap, $UV));\n\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness));\n\tccNormalW = dTBN * normalMap;\n\t#else\n\tccNormalW = normalize(dVertexNormalW);\n\t#endif\n\tccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n}\n",
combineClearCoatPS:"vec3 combineColorCC() {\n\treturn combineColor()+(ccSpecularLight*ccSpecularity+ccReflection.rgb*ccSpecularity*ccReflection.a);\n}\n",combineDiffusePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight;\n}\n",combineDiffuseSpecularPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);\n}\n",combineDiffuseSpecularNoConservePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n",
combineDiffuseSpecularNoReflPS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n",combineDiffuseSpecularNoReflSeparateAmbientPS:"uniform vec3 material_ambient;\nvec3 combineColor() {\n\treturn (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n",combineDiffuseSpecularOldPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n",
cookiePS:"vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",
cubeMapProjectBoxPS:"uniform vec3 envBoxMin, envBoxMax;\nvec3 cubeMapProject(vec3 nrdir) {\n\tnrdir = cubeMapRotate(nrdir);\n\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\tvec3 rbminmax;\n\trbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n\trbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n\trbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\tvec3 posonbox = vPositionW + nrdir * fa;\n\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\treturn posonbox - envBoxPos;\n}\n",
cubeMapProjectNonePS:"vec3 cubeMapProject(vec3 dir) {\n\treturn cubeMapRotate(dir);\n}\n",cubeMapRotatePS:"#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n\treturn refDir * cubeMapRotationMatrix;\n#else\n\treturn refDir;\n#endif\n}\n",detailModesPS:"vec3 detailMode_mul(vec3 c1, vec3 c2) {\n\treturn c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\treturn c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\treturn mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\treturn min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\treturn max(c1, c2);\n}\n",
diffusePS:"#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseMap;\n#endif\nvoid getAlbedo() {\n\tdAlbedo = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdAlbedo *= material_diffuse.rgb;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlbedo *= gammaCorrectInput(addAlbedoDetail(texture2D(texture_diffuseMap, $UV).$CH));\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n}\n",diffuseDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseDetailMap;\n#endif\nvec3 addAlbedoDetail(vec3 albedo) {\n\t#ifdef MAPTEXTURE\n\tvec3 albedoDetail = vec3(texture2D(texture_diffuseDetailMap, $UV).$CH);\n\treturn detailMode_$DETAILMODE(albedo, albedoDetail);\n\t#else\n\treturn albedo;\n\t#endif\n}\n",
dilatePS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n\tvec4 c = texture2D(source, vUv0);\n\tc = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n\tgl_FragColor = c;\n}\n",
dpAtlasQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec4 params;\nvoid main(void) {\n\tvec2 uv = vUv0;\n\tuv = uv * 2.0 - vec2(1.0);\n\tuv *= params.xy;\n\tuv = uv * 0.5 + 0.5;\n\tgl_FragColor = texture2D(source, uv);\n}\n",emissivePS:"#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_emissiveMap;\n#endif\nvec3 getEmission() {\n\tvec3 emission = vec3(1.0);\n\t#ifdef MAPFLOAT\n\temission *= material_emissiveIntensity;\n\t#endif\n\t#ifdef MAPCOLOR\n\temission *= material_emissive;\n\t#endif\n\t#ifdef MAPTEXTURE\n\temission *= $texture2DSAMPLE(texture_emissiveMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\temission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n\treturn emission;\n}\n",
endPS:"\t#ifdef CLEARCOAT\n\tgl_FragColor.rgb = combineColorCC();\n\t#else\n\tgl_FragColor.rgb = combineColor();\n\t#endif\n\tgl_FragColor.rgb += getEmission();\n\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\t#ifndef HDR\n\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n\t#endif\n",envConstPS:"vec3 processEnvironment(vec3 color) {\n\treturn color;\n}\n",envMultiplyPS:"uniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n\treturn color * skyboxIntensity;\n}\n",
extensionPS:"\n",extensionVS:"\n",falloffInvSquaredPS:"float getFalloffWindow(float lightRadius) {\n\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\tfloat invRadius = 1.0 / lightRadius;\n\treturn square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n}\nfloat getFalloffInvSquared(float lightRadius) {\n\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\tfloat invRadius = 1.0 / lightRadius;\n\tfalloff *= 16.0;\n\tfalloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\treturn falloff;\n}\n",
falloffLinearPS:"float getFalloffLinear(float lightRadius) {\n\tfloat d = length(dLightDirW);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",fixCubemapSeamsNonePS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\treturn vec;\n}\nvec3 calcSeam(vec3 vec) {\n\treturn vec3(0);\n}\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\treturn vec;\n}\n",fixCubemapSeamsStretchPS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\tfloat scale = 1.0 - exp2(mipmapIndex) / 128.0;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\tfloat scale = 1.0 - 1.0 / 128.0;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\tfloat scale = invRecMipSize;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 calcSeam(vec3 vec) {\n\tvec3 avec = abs(vec);\n\tfloat M = max(avec.x, max(avec.y, avec.z));\n\treturn vec3(avec.x != M ? 1.0 : 0.0,\n\t\t\t\tavec.y != M ? 1.0 : 0.0,\n\t\t\t\tavec.z != M ? 1.0 : 0.0);\n}\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\treturn vec * (seam * -scale + vec3(1.0));\n}\n",
fogExpPS:"uniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogExp2PS:"uniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * depth * fog_density * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",
fogLinearPS:"uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = (fog_end - depth) / (fog_end - fog_start);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\tfogFactor = gammaCorrectInput(fogFactor);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogNonePS:"float dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\treturn color;\n}\n",
fresnelSchlickPS:"\nuniform float material_fresnelFactor;\nvoid getFresnel() {\n\tfloat fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n\tfloat fresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= dGlossiness * dGlossiness;\n\tdSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n\t#ifdef CLEARCOAT\n\tfresnel = 1.0 - max(dot(ccNormalW, dViewDirW), 0.0);\n\tfresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= ccGlossiness * ccGlossiness;\n\tccSpecularity = ccSpecularity + (1.0 - ccSpecularity) * fresnel;\n\t#endif\n}\n",
fullscreenQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"attribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n",gamma1_0PS:"vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\treturn texture2D(tex, uv);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\treturn texture2D(tex, uv, bias);\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\treturn textureCube(tex, uvw);\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\treturn color;\n}\nvec3 gammaCorrectInput(vec3 color) {\n\treturn color;\n}\nfloat gammaCorrectInput(float color) {\n\treturn color;\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn color;\n}\n",
gamma2_2PS:"vec3 gammaCorrectInput(vec3 color) {\n\treturn pow(color, vec3(2.2));\n}\nfloat gammaCorrectInput(float color) {\n\treturn pow(color, 2.2);\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\tvec4 rgba = texture2D(tex, uv);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\tvec4 rgba = texture2D(tex, uv, bias);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\tvec4 rgba = textureCube(tex, uvw);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\t#ifdef HDR\n\treturn color;\n\t#else\n\tcolor += vec3(0.0000001);\n\treturn pow(color, vec3(0.45));\n\t#endif\n}\n",
genParaboloidPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nvoid main(void) {\n\tvec2 uv = vUv0;\n\tfloat side = uv.x < 0.5? 1.0 : -1.0;\n\tvec2 tc;\n\ttc.x = fract(uv.x * 2.0) * 2.0 - 1.0;\n\ttc.y = uv.y * 2.0 - 1.0;\n\tconst float scale = 1.1;\n\ttc *= scale;\n\tvec3 dir;\n\tdir.y = (dot(tc, tc) - 1.0) * side;\n\tdir.xz = tc * -2.0;\n\tdir.x *= -side * params.y;\n\tdir = fixSeams(dir, params.x);\n\tvec4 color = textureCube(source, dir, -100.0);\n\tgl_FragColor = color;\n}\n",
gles3PS:"#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n",gles3VS:"#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",
glossPS:"#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tdGlossiness *= material_shininess;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tdGlossiness += 0.0000001;\n}\n",instancingVS:"attribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n",
lightDiffuseLambertPS:"float getLightDiffuse() {\n\treturn max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n",lightDirPointPS:"void getLightDirPoint(vec3 lightPosW) {\n\tdLightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(dLightDirW);\n\tdLightPosW = lightPosW;\n}\n",lightmapDirPS:"uniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\nvoid addLightMap() {\n\tvec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\tvec3 dir = texture2D(texture_dirLightMap, $UV).xyz;\n\tif (dot(dir, vec3(1.0)) < 0.00001) {\n\t\tdDiffuseLight += color;\n\t} else {\n\t\tdLightDirNormW = normalize(dir * 2.0 - vec3(1.0));\n\t\tfloat vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n\t\tfloat flight = saturate(dot(dLightDirNormW, -dNormalW));\n\t\tfloat nlight = (flight / max(vlight, 0.01)) * 0.5;\n\t\tdDiffuseLight += color * nlight * 2.0;\n\t}\n\tdSpecularLight += color * getLightSpecular();\n}\n",
lightmapSinglePS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_lightMap;\n#endif\nvoid addLightMap() {\n\tvec3 lm = vec3(1.0);\n\t#ifdef MAPTEXTURE\n\tlm *= $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tlm *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight += lm;\n}\n",lightmapSingleVertPS:"void addLightMap() {\n\tdDiffuseLight += saturate(vVertexColor.$CH);\n}\n",lightSpecularAnisoGGXPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tfloat PI = 3.141592653589793;\n\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\tfloat anisotropy = material_anisotropy * roughness;\n\tfloat at = max((roughness + anisotropy), roughness / 4.0);\n\tfloat ab = max((roughness - anisotropy), roughness / 4.0);\n\tvec3 h = normalize(normalize(-dLightDirNormW) + normalize(dViewDirW));\n\tfloat NoH = dot(tNormalW, h);\n\tfloat ToH = dot(dTBN[0], h);\n\tfloat BoH = dot(dTBN[1], h);\n\tfloat a2 = at * ab;\n\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\tfloat v2 = dot(v, v);\n\tfloat w2 = a2 / v2;\n\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\tfloat ToV = dot(dTBN[0], dViewDirW);\n\tfloat BoV = dot(dTBN[1], dViewDirW);\n\tfloat ToL = dot(dTBN[0], -dLightDirNormW);\n\tfloat BoL = dot(dTBN[1], -dLightDirNormW);\n\tfloat NoV = dot(tNormalW, dViewDirW);\n\tfloat NoL = dot(tNormalW, -dLightDirNormW);\n\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\tfloat G = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",
lightSpecularBlinnPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tvec3 h = normalize( -dLightDirNormW + dViewDirW );\n\tfloat nh = max( dot( h, tNormalW ), 0.0 );\n\tfloat specPow = exp2(tGlossiness * 11.0);\n\tspecPow = antiAliasGlossiness(specPow);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",
lightSpecularPhongPS:"float calcLightSpecular(float tGlossiness, vec3 tReflDirW) {\n\tfloat specPow = tGlossiness;\n\tspecPow = antiAliasGlossiness(specPow);\n\treturn pow(max(dot(tReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dReflDirW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccReflDirW);\n}\n",ltc:"\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n\tvec3 coord0;\n\tvec3 coord1;\n\tvec3 coord2;\n\tvec3 coord3;\n};\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n\tvec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n\tvec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n\tvec3 lightNormal = cross( v1, v2 );\n\tfloat factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 =  factor * cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords.coord0 - P );\n\tcoords[ 1 ] = mat * ( rectCoords.coord1 - P );\n\tcoords[ 2 ] = mat * ( rectCoords.coord2 - P );\n\tcoords[ 3 ] = mat * ( rectCoords.coord3 - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn result;\n}\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\treturn coords;\n}\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tfloat radius = max(length(halfWidth), length(halfWidth));\n\tdSphereRadius = radius;\n\tvec3 f = normalize(lightPos-view_position);\n\tvec3 w = normalize(cross(f, halfHeight));\n\tvec3 h = normalize(cross(f, w));\n\tcoords.coord0 = lightPos + w * radius - h * radius;\n\tcoords.coord1 = lightPos - w * radius - h * radius;\n\tcoords.coord2 = lightPos - w * radius + h * radius;\n\tcoords.coord3 = lightPos + w * radius + h * radius;\n\treturn coords;\n}\nvec2 dLTCUV;\n#ifdef CLEARCOAT\nvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float tGlossiness, vec3 tNormalW)\n{\n\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\treturn LTC_Uv( tNormalW, dViewDirW, roughness );\n}\nvec3 dLTCSpecFres;\n#ifdef CLEARCOAT\nvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 tSpecularity)\n{\n\tvec4 t2 = texture2D( areaLightsLutTex2, uv );\n\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\tt2 *= vec4(0.693103,1,1,1);\n\tt2 += vec4(0.306897,0,0,0);\n\t#endif\n\treturn tSpecularity * t2.x + ( vec3( 1.0 ) - tSpecularity) * t2.y;\n}\nvoid calcLTCLightValues()\n{\n\tdLTCUV = getLTCLightUV(dGlossiness, dNormalW);\n\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, dSpecularityNoFres);\n#ifdef CLEARCOAT\n\tccLTCUV = getLTCLightUV(ccGlossiness, ccNormalW);\n\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, ccSpecularityNoFres);\n#endif\n}\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n\tcalcLTCLightValues();\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n\tcalcLTCLightValues();\n}\nvec3 SolveCubic(vec4 Coefficient)\n{\n\tfloat pi = 3.14159;\n\tCoefficient.xyz /= Coefficient.w;\n\tCoefficient.yz /= 3.0;\n\tfloat A = Coefficient.w;\n\tfloat B = Coefficient.z;\n\tfloat C = Coefficient.y;\n\tfloat D = Coefficient.x;\n\tvec3 Delta = vec3(\n\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\tdot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t);\n\tfloat Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n\tvec3 RootsA, RootsD;\n\tvec2 xlc, xsc;\n\t{\n\t\tfloat A_a = 1.0;\n\t\tfloat C_a = Delta.x;\n\t\tfloat D_a = -2.0 * B * Delta.x + Delta.y;\n\t\tfloat Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n\t\tfloat x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n\t\tfloat x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xl;\n\t\tif ((x_1a + x_3a) > 2.0 * B)\n\t\t\txl = x_1a;\n\t\telse\n\t\t\txl = x_3a;\n\t\txlc = vec2(xl - B, A);\n\t}\n\t{\n\t\tfloat A_d = D;\n\t\tfloat C_d = Delta.z;\n\t\tfloat D_d = -D * Delta.y + 2.0 * C * Delta.z;\n\t\tfloat Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n\t\tfloat x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n\t\tfloat x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xs;\n\t\tif (x_1d + x_3d < 2.0 * C)\n\t\t\txs = x_1d;\n\t\telse\n\t\t\txs = x_3d;\n\t\txsc = vec2(-D, xs + C);\n\t}\n\tfloat E =  xlc.y * xsc.y;\n\tfloat F = -xlc.x * xsc.y - xlc.y * xsc.x;\n\tfloat G =  xlc.x * xsc.x;\n\tvec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n\tvec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\tif (Root.x < Root.y && Root.x < Root.z)\n\t\tRoot.xyz = Root.yxz;\n\telse if (Root.z < Root.x && Root.z < Root.y)\n\t\tRoot.xyz = Root.xzy;\n\treturn Root;\n}\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n\tvec3 T1, T2;\n\tT1 = normalize(V - N * dot(V, N));\n\tT2 = cross(N, T1);\n\tmat3 R = transposeMat3( mat3( T1, T2, N ) );\n\tvec3 L_[ 3 ];\n\tL_[ 0 ] = R * ( points.coord0 - P );\n\tL_[ 1 ] = R * ( points.coord1 - P );\n\tL_[ 2 ] = R * ( points.coord2 - P );\n\tvec3 Lo_i = vec3(0);\n\tvec3 C  = 0.5 * (L_[0] + L_[2]);\n\tvec3 V1 = 0.5 * (L_[1] - L_[2]);\n\tvec3 V2 = 0.5 * (L_[1] - L_[0]);\n\tC  = Minv * C;\n\tV1 = Minv * V1;\n\tV2 = Minv * V2;\n\tfloat a, b;\n\tfloat d11 = dot(V1, V1);\n\tfloat d22 = dot(V2, V2);\n\tfloat d12 = dot(V1, V2);\n\tif (abs(d12) / sqrt(d11 * d22) > 0.0001)\n\t{\n\t\tfloat tr = d11 + d22;\n\t\tfloat det = -d12 * d12 + d11 * d22;\n\t\tdet = sqrt(det);\n\t\tfloat u = 0.5 * sqrt(tr - 2.0 * det);\n\t\tfloat v = 0.5 * sqrt(tr + 2.0 * det);\n\t\tfloat e_max = (u + v) * (u + v);\n\t\tfloat e_min = (u - v) * (u - v);\n\t\tvec3 V1_, V2_;\n\t\tif (d11 > d22)\n\t\t{\n\t\t\tV1_ = d12 * V1 + (e_max - d11) * V2;\n\t\t\tV2_ = d12 * V1 + (e_min - d11) * V2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tV1_ = d12*V2 + (e_max - d22)*V1;\n\t\t\tV2_ = d12*V2 + (e_min - d22)*V1;\n\t\t}\n\t\ta = 1.0 / e_max;\n\t\tb = 1.0 / e_min;\n\t\tV1 = normalize(V1_);\n\t\tV2 = normalize(V2_);\n\t}\n\telse\n\t{\n\t\ta = 1.0 / dot(V1, V1);\n\t\tb = 1.0 / dot(V2, V2);\n\t\tV1 *= sqrt(a);\n\t\tV2 *= sqrt(b);\n\t}\n\tvec3 V3 = cross(V1, V2);\n\tif (dot(C, V3) < 0.0)\n\t\tV3 *= -1.0;\n\tfloat L  = dot(V3, C);\n\tfloat x0 = dot(V1, C) / L;\n\tfloat y0 = dot(V2, C) / L;\n\tfloat E1 = inversesqrt(a);\n\tfloat E2 = inversesqrt(b);\n\ta *= L * L;\n\tb *= L * L;\n\tfloat c0 = a * b;\n\tfloat c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n\tfloat c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n\tfloat c3 = 1.0;\n\tvec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n\tfloat e1 = roots.x;\n\tfloat e2 = roots.y;\n\tfloat e3 = roots.z;\n\tvec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n\tmat3 rotate = mat3(V1, V2, V3);\n\tavgDir = rotate * avgDir;\n\tavgDir = normalize(avgDir);\n\tfloat L1 = sqrt(-e2 / e3);\n\tfloat L2 = sqrt(-e2 / e1);\n\tfloat formFactor = L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2));\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tvec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n\tuv = uv*LUT_SCALE + LUT_BIAS;\n\tfloat scale = texture2D( areaLightsLutTex2, uv ).w;\n\treturn formFactor*scale;\n}\nfloat getRectLightDiffuse() {\n\treturn LTC_EvaluateRect( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getDiskLightDiffuse() {\n\treturn LTC_EvaluateDisk( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getSphereLightDiffuse() {\n\tfloat falloff = dSphereRadius / (dot(dLightDirW, dLightDirW) + dSphereRadius);\n\treturn getLightDiffuse()*falloff;\n}\nmat3 getLTCLightInvMat(vec2 uv)\n{\n\tvec4 t1 = texture2D( areaLightsLutTex1, uv );\n\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\tt1 *= vec4(1.001, 0.3239, 0.60437568, 1.0);\n\tt1 += vec4(0.0, -0.2976, -0.01381, 0.0);\n\t#endif\n\treturn mat3(\n\t\tvec3( t1.x, 0, t1.y ),\n\t\tvec3(\t0, 1,\t0 ),\n\t\tvec3( t1.z, 0, t1.w )\n\t);\n}\nfloat calcRectLightSpecular(vec3 tNormalW, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateRect( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\nfloat getRectLightSpecular() {\n\treturn calcRectLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getRectLightSpecularCC() {\n\treturn calcRectLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\nfloat calcDiskLightSpecular(vec3 tNormalW, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateDisk( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\nfloat getDiskLightSpecular() {\n\treturn calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getDiskLightSpecularCC() {\n\treturn calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\nfloat getSphereLightSpecular() {\n\treturn calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getSphereLightSpecularCC() {\n\treturn calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\n",
metalnessPS:"void processMetalness(float metalness) {\n\tconst float dielectricF0 = 0.04;\n\tdSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n\tdAlbedo *= 1.0 - metalness;\n}\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_metalnessMap;\n#endif\nvoid getSpecularity() {\n\tfloat metalness = 1.0;\n\t#ifdef MAPFLOAT\n\tmetalness *= material_metalness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tmetalness *= texture2D(texture_metalnessMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tmetalness *= saturate(vVertexColor.$VC);\n\t#endif\n\tprocessMetalness(metalness);\n}\n",
msdfPS:"uniform sampler2D texture_msdfMap;\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n#ifdef GL2\n#define USE_FWIDTH\n#endif\nfloat median(float r, float g, float b) {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n\treturn (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\nvec4 applyMsdf(vec4 color) {\n\tvec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n\tvec2 uvShdw = vUv0 - shadow_offset;\n\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\t#ifdef USE_FWIDTH\n\tvec2 w = fwidth(vUv0);\n\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, 0.5);\n\t#else\n\tfloat font_size = 16.0;\n\tfloat smoothing = clamp(font_pxrange / font_size, 0.0, 0.5);\n\t#endif\n\tfloat mapMin = 0.05;\n\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\tfloat center = 0.5;\n\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\ttcolor = mix(tcolor, color, inside);\n\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\ttcolor = mix(scolor, tcolor, outline);\n\treturn tcolor;\n}\n",
normalVS:"#ifdef MORPHING_TEXTURE_BASED_NORMAL\nuniform highp sampler2D morphNormalTex;\n#endif\nvec3 getNormal() {\n\t#ifdef SKIN\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\t#elif defined(INSTANCING)\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\t#else\n\tdNormalMatrix = matrix_normal;\n\t#endif\n\tvec3 tempNormal = vertex_normal;\n\t#ifdef MORPHING\n\t#ifdef MORPHING_NRM03\n\ttempNormal += morph_weights_a[0] * morph_nrm0;\n\ttempNormal += morph_weights_a[1] * morph_nrm1;\n\ttempNormal += morph_weights_a[2] * morph_nrm2;\n\ttempNormal += morph_weights_a[3] * morph_nrm3;\n\t#endif\n\t#ifdef MORPHING_NRM47\n\ttempNormal += morph_weights_b[0] * morph_nrm4;\n\ttempNormal += morph_weights_b[1] * morph_nrm5;\n\ttempNormal += morph_weights_b[2] * morph_nrm6;\n\ttempNormal += morph_weights_b[3] * morph_nrm7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_NORMAL\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;\n\ttempNormal += morphNormal;\n\t#endif\n\treturn normalize(dNormalMatrix * tempNormal);\n}\n",
normalDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_normalDetailMap;\nuniform float material_normalDetailMapBumpiness;\nvec3 blendNormals(vec3 n1, vec3 n2) {\n\tn1 += vec3(0, 0, 1);\n\tn2 *= vec3(-1, -1, 1);\n\treturn normalize(n1*dot(n1, n2)/n1.z - n2);\n}\n#endif\nvec3 addNormalDetail(vec3 normalMap) {\n\t#ifdef MAPTEXTURE\n\tvec3 normalDetailMap = unpackNormal(texture2D(texture_normalDetailMap, $UV));\n\tnormalDetailMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness));\n\treturn blendNormals(normalMap, normalDetailMap);\n\t#else\n\treturn normalMap;\n\t#endif\n}\n",
normalInstancedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalMapPS:"uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));\n\tdNormalMap = addNormalDetail(normalMap);\n\tdNormalW = dTBN * dNormalMap;\n}\n",
normalMapFastPS:"uniform sampler2D texture_normalMap;\nvoid getNormal() {\n\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n\tdNormalMap = addNormalDetail(normalMap);\n\tdNormalW = dTBN * dNormalMap;\n}\n",normalSkinnedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalVertexPS:"void getNormal() {\n\tdNormalW = normalize(dVertexNormalW);\n}\n",normalXYPS:"vec3 unpackNormal(vec4 nmap) {\n\tvec3 normal;\n\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\tnormal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n\treturn normal;\n}\n",
normalXYZPS:"vec3 unpackNormal(vec4 nmap) {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\n",opacityPS:"#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_opacityMap;\n#endif\nvoid getOpacity() {\n\tdAlpha = 1.0;\n\t#ifdef MAPFLOAT\n\tdAlpha *= material_opacity;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlpha *= texture2D(texture_opacityMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n\t#endif\n}\n",outputAlphaPS:"gl_FragColor.a = dAlpha;\n",
outputAlphaOpaquePS:"gl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"gl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n",outputCubemapPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec4 color) {\n\tcolor.rgb = pow(color.rgb, vec3(0.5));\n\tcolor.rgb *= 1.0 / 8.0;\n\tcolor.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n\tcolor.a = ceil(color.a * 255.0) / 255.0;\n\tcolor.rgb /= color.a;\n\treturn color;\n}\nvoid main(void) {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\tgl_FragColor = textureCube(source, vec);\n\tif (params.w >= 2.0) gl_FragColor = encodeRGBM(gl_FragColor);\n}\n",
outputTex2DPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",packDepthPS:"\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",packDepthMaskPS:"vec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres.x = 0.0;\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",
parallaxPS:"uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax() {\n\tfloat parallaxScale = material_heightMapFactor;\n\tfloat height = texture2D(texture_heightMap, $UV).$CH;\n\theight = height * parallaxScale - parallaxScale*0.5;\n\tvec3 viewDirT = dViewDirW * dTBN;\n\tviewDirT.z += 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"varying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\n#endif\nvoid main(void) {\n\tvec4 tex  = texture2DSRGB(colorMap, texCoordsAlphaLife.xy);\n\tvec4 ramp = texture2DSRGB(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n\tramp.rgb *= colorMult;\n\tramp.a += texCoordsAlphaLife.z;\n\tvec3 rgb = tex.rgb * ramp.rgb;\n\tfloat a  = tex.a * ramp.a;\n",
particleVS:"vec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc) {\n\treturn mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex,tc);\n\tvec4 b = texture2D(tex,tc + graphSampleSize);\n\tfloat c = fract(tc.x*graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n\t#ifdef SCREEN_SPACE\n\t\tvec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n\t#else\n\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t#endif\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvec2 safeNormalize(vec2 v) {\n\tfloat l = length(v);\n\treturn (l > 1e-06) ? v / l : v;\n}\nvoid main(void) {\n\tvec3 meshLocalPos = particle_vertexData.xyz;\n\tfloat id = floor(particle_vertexData.w);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\tfloat uv = id / numParticlesPot;\n\treadInput(uv);\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);\n\tfloat particleLifetime = lifetime;\n\tif (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n\tvec2 quadXY = meshLocalPos.xy;\n\tfloat nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\tvec3 paramDiv;\n\tvec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat scale = params.y;\n\tfloat scaleDiv = paramDiv.x;\n\tfloat alphaDiv = paramDiv.z;\n\tscale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n\ttexCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\tvec3 particlePos = inPos;\n\tvec3 particlePosMoved = vec3(0.0);\n\tmat2 rotMatrix;\n",
particleAnimFrameClampVS:"\tfloat animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\tfloat animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\tfloat animationIndex;\n\tif (animTexIndexParams.y == 1.0) {\n\t\tanimationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n\t} else {\n\t\tanimationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n\t}\n\tfloat atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n\tfloat atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n\tatlasX = fract(atlasX);\n\ttexCoordsAlphaLife.xy *= animTexTilesParams.xy;\n\ttexCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",
particleInputFloatPS:"void readInput(float uv) {\n\tvec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\tinPos = tex.xyz;\n\tinVel = tex2.xyz;\n\tinAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n\tinShow = tex.w >= 0.0;\n\tinLife = tex2.w;\n}\n",particleInputRgba8PS:"\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n\tvec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n\tvec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n\tvec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\tinPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n\tinPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\tinVel = tex2.xyz;\n\tinVel = (inVel - vec3(0.5)) * maxVel;\n\tinAngle = decodeFloatRG(tex1.ba) * PI2;\n\tinShow = tex2.a > 0.5;\n\tinLife = decodeFloatRGBA(tex3);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\tinLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",
particleOutputFloatPS:"void writeOutput() {\n\tif (gl_FragCoord.y<1.0) {\n\t\tgl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n\t} else {\n\t\tgl_FragColor = vec4(outVel, outLife);\n\t}\n}\n",particleOutputRgba8PS:"uniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n\tvec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\treturn enc;\n}\nvoid writeOutput() {\n\toutPos = outPos * outBoundsMul + outBoundsAdd;\n\toutAngle = fract(outAngle / PI2);\n\toutVel = (outVel / maxVel) + vec3(0.5);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\toutLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\tif (gl_FragCoord.y < 1.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n\t} else if (gl_FragCoord.y < 2.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n\t} else if (gl_FragCoord.y < 3.0) {\n\t\tgl_FragColor = vec4(outVel, visMode*0.5+0.5);\n\t} else {\n\t\tgl_FragColor = encodeFloatRGBA(outLife);\n\t}\n}\n",
particleUpdaterAABBPS:"uniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tvec3 pos = inBounds - vec3(0.5);\n\tvec3 posAbs = abs(pos);\n\tvec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\tvec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\tpos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n\tpos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n\tpos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n\treturn emitterPos + spawnBounds * pos;\n#else\n\treturn spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity -= vec3(0, 0, initialVelocity);\n}\n",
particleUpdaterEndPS:"\twriteOutput();\n}\n",particleUpdaterInitPS:"varying vec2 vUv0;\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",
particleUpdaterNoRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = -1.0;\n\t}\n",particleUpdaterOnStopPS:"\tvisMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = 1.0;\n\t}\n\tvisMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"uniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tfloat rnd4 = fract(rndFactor * 1000.0);\n\tvec3 norm = normalize(inBounds.xyz - vec3(0.5));\n\tfloat r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n\treturn emitterPos + norm * r * spawnBoundsSphere;\n#else\n\treturn norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",
particleUpdaterStartPS:"float saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex, tc);\n\tvec4 b = texture2D(tex, tc + graphSampleSize);\n\tfloat c = fract(tc.x * graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n\tvec4 p4 = fract(vec4(p) * HASHSCALE4);\n\tp4 += dot(p4, p4.wzxy+19.19);\n\treturn fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void) {\n\tif (gl_FragCoord.x > numParticles) discard;\n\treadInput(vUv0.x);\n\tvisMode = inShow? 1.0 : -1.0;\n\tvec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\tfloat particleRate = rate + rateDiv * rndFactor.x;\n\toutLife = inLife + delta;\n\tfloat nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\tvec3 localVelocityDiv;\n\tvec3 velocityDiv;\n\tvec3 paramDiv;\n\tvec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n\tvec3 velocity =\t  tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n\tvec3 params =\t\ttex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat rotSpeed = params.x;\n\tfloat rotSpeedDiv = paramDiv.y;\n\tvec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n\tfloat radialSpeed = radialParams.x;\n\tfloat radialSpeedDiv = radialParams.y;\n\tbool respawn = inLife <= 0.0 || outLife >= lifetime;\n\tinPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n\tinAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n\tvec3 radialVel = inPos - emitterPos;\n#else\n\tvec3 radialVel = inPos;\n#endif\n\tradialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n\tradialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\tlocalVelocity +=\t(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n\tvelocity +=\t\t (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n\trotSpeed +=\t\t (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\taddInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n\toutVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n\toutVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\toutPos = inPos + outVel * delta;\n\toutAngle = inAngle + rotSpeed * delta;\n",
particle_billboardVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\tdBlendModeFogFactor = 0.0;\n\trgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n\tif ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\trgb = mix(vec3(1.0), rgb, vec3(a));\n\tif (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\tif (a < 0.01) discard;\n",particle_cpuVS:"attribute vec4 particle_vertexData;\nattribute vec4 particle_vertexData2;\nattribute vec4 particle_vertexData3;\nattribute float particle_vertexData4;\n#ifndef USE_MESH\n#define VDATA5TYPE vec2\n#else\n#define VDATA5TYPE vec4\n#endif\nattribute VDATA5TYPE particle_vertexData5;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds, emitterScale, faceTangent, faceBinorm;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvoid main(void)\n{\n\tvec3 particlePos = particle_vertexData.xyz;\n\tvec3 inPos = particlePos;\n\tvec3 vertPos = particle_vertexData3.xyz;\n\tvec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\tfloat id = floor(particle_vertexData4);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);\n\tvec2 quadXY = vertPos.xy;\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#else\n\ttexCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#endif\n\tmat2 rotMatrix;\n\tfloat inAngle = particle_vertexData2.x;\n\tvec3 particlePosMoved = vec3(0.0);\n\tvec3 meshLocalPos = particle_vertexData3.xyz;\n",
particle_cpu_endVS:"\tlocalPos *= particle_vertexData2.y * emitterScale;\n\tlocalPos += particlePos;\n\tgl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\trgb = addFog(rgb);\n\trgb = toneMap(rgb);\n\trgb = gammaCorrectOutput(rgb);\n\tgl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\tlocalPos *= scale * emitterScale;\n\tlocalPos += particlePos;\n\t#ifdef SCREEN_SPACE\n\tgl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n\t#else\n\tgl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n\t#endif\n",
particle_halflambertPS:"\tvec3 negNormal = normal*0.5+0.5;\n\tvec3 posNormal = -normal*0.5+0.5;\n\tnegNormal *= negNormal;\n\tposNormal *= posNormal;\n",particle_initVS:"attribute vec4 particle_vertexData;\n#ifdef USE_MESH\nattribute vec2 particle_uv;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",
particle_lambertPS:"\tvec3 negNormal = max(normal, vec3(0.0));\n\tvec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\tvec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n\t\t\t\t\t\tnegNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n\t\t\t\t\t\tnegNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\trgb *= light;\n",particle_localShiftVS:"\tparticlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\tvec3 localPos = meshLocalPos;\n\tlocalPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n\tlocalPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\tbillboard(particlePos, quadXY);\n",
particle_normalVS:"\tNormal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\tvec3 normalMap = normalize(texture2D(normalMap, texCoordsAlphaLife.xy).xyz * 2.0 - 1.0);\n\tvec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\tinAngle = atan(velocityV.x, velocityV.y);\n",particle_softPS:"\tfloat depth = getLinearScreenDepth();\n\tfloat particleDepth = vDepth;\n\tfloat depthDiff = saturate(abs(particleDepth - depth) * softening);\n\ta *= depthDiff;\n",particle_softVS:"\tvDepth = getLinearDepth(localPos);\n",
particle_stretchVS:"\tvec3 moveDir = inVel * stretch;\n\tvec3 posPrev = particlePos - moveDir;\n\tposPrev += particlePosMoved;\n\tvec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\tfloat interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\tparticlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\tmat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n\tParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",
particle_wrapVS:"\tvec3 origParticlePos = particlePos;\n\tparticlePos -= matrix_model[3].xyz;\n\tparticlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n\tparticlePos += matrix_model[3].xyz;\n\tparticlePosMoved = particlePos - origParticlePos;\n",precisionTestPS:"void main(void) {\n\tgl_FragColor = vec4(2147483648.0);\n}\n",precisionTest2PS:"uniform sampler2D source;\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\nvoid main(void) {\n\tfloat c = texture2D(source, vec2(0.0)).r;\n\tfloat diff = abs(c - 2147483648.0) / 2147483648.0;\n\tgl_FragColor = packFloat(diff);\n}\n",
prefilterCubemapPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nfloat rnd(vec2 uv) {\n\treturn fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nconst float PI = 3.14159265358979;\nvec3 hemisphereSample_cos(vec2 uv, mat3 vecSpace, vec3 cubeDir, float gloss) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = sqrt(1.0 - uv.x);\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\tvec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n\treturn normalize(mix(vecSpace * sampleDir, cubeDir, params.y));\n}\nvec3 hemisphereSample_phong(vec2 uv, mat3 vecSpace, vec3 cubeDir, float specPow) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\tvec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n\treturn vecSpace * sampleDir;\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nvec4 encodeRGBM(vec3 color) {\n\tvec4 encoded;\n\tencoded.rgb = pow(color.rgb, vec3(0.5));\n\tencoded.rgb *= 1.0 / 8.0;\n\tencoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\tencoded.rgb /= encoded.a;\n\treturn encoded;\n}\nvoid main(void) {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tif (params.w==1.0 || params.w==3.0) {\n\t\tst = 2.0 * floor(gl_FragCoord.xy) / (params.z - 1.0) - 1.0;\n\t}\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\tmat3 vecSpace = matrixFromVector(normalize(vec));\n\tvec3 color = vec3(0.0);\n\tconst int samples = $NUMSAMPLES;\n\tvec3 vect;\n\tfor(int i=0; i<samples; i++) {\n\t\tfloat sini = sin(float(i));\n\t\tfloat cosi = cos(float(i));\n\t\tfloat rand = rnd(vec2(sini, cosi));\n\t\tvect = hemisphereSample_$METHOD(vec2(float(i) / float(samples), rand), vecSpace, vec, params.y);\n\t\tcolor += $textureCube(source, vect).rgb;\n\t}\n\tcolor /= float(samples);\n\tgl_FragColor = params.w < 2.0? vec4(color, 1.0) : encodeRGBM(color);\n}\n",
reflDirPS:"void getReflDir() {\n\tdReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n}\n",reflDirAnisoPS:"void getReflDir() {\n\tfloat roughness = sqrt(1.0 - min(dGlossiness, 1.0));\n\tfloat anisotropy = material_anisotropy * roughness;\n\tvec3 anisotropicDirection = anisotropy >= 0.0 ? dTBN[1] : dTBN[0];\n\tvec3 anisotropicTangent = cross(anisotropicDirection, dViewDirW);\n\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\tvec3 bentNormal = normalize(mix(normalize(dNormalW), normalize(anisotropicNormal), anisotropy));\n\tdReflDirW = reflect(-dViewDirW, bentNormal);\n}\n",
reflectionCCPS:"#ifdef CLEARCOAT\nuniform float material_clearCoatReflectivity;\nvoid addReflectionCC() {\n\tccReflection += vec4(calcReflection(ccReflDirW, ccGlossiness), material_clearCoatReflectivity);\n}\n#endif\n",reflectionCubePS:"uniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 lookupVec = fixSeams(cubeMapProject(tReflDirW));\n#ifndef RIGHT_HANDED_CUBEMAP\n\tlookupVec.x *= -1.0;\n#endif\n\treturn $textureCubeSAMPLE(texture_cubeMap, lookupVec).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",
reflectionDpAtlasPS:"uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec2 getDpAtlasUv(vec2 uv, float mip) {\n\tvec4 rect;\n\tfloat sx = saturate(mip - 2.0);\n\trect.x = sx * 0.5;\n\tfloat t = mip - rect.x * 6.0;\n\tfloat i = 1.0 - rect.x;\n\trect.y = min(t * 0.5, 0.75) * i + rect.x;\n\tfloat st = saturate(t);\n\trect.z = (1.0 - st * 0.5) * i;\n\trect.w = rect.z * 0.5;\n\tfloat rcRectZ = 1.0 / rect.z;\n\tfloat scaleFactor = 0.00390625 * rcRectZ;\n\tvec2 scale = vec2(scaleFactor, scaleFactor * 2.0);\n\tuv = uv * (vec2(1.0) - scale) + scale * 0.5;\n\tuv = uv * rect.zw + rect.xy;\n\treturn uv;\n}\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDir = normalize(cubeMapProject(tReflDirW));\n\tbool up = reflDir.y > 0.0;\n\tfloat scale = 0.90909090909090909090909090909091;\n\tvec3 reflDirWarp = reflDir.xzx * vec3(-0.25, 0.5, 0.25);\n\tfloat reflDirVer = abs(reflDir.y) + 1.0;\n\treflDirWarp /= reflDirVer;\n\treflDirWarp *= scale;\n\treflDirWarp = vec3(0.75, 0.5, 0.25) - reflDirWarp;\n\tvec2 tc = up? reflDirWarp.xy : reflDirWarp.zy;\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tfloat mip = floor(bias);\n\tvec3 tex1 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\tmip = min(mip + 1.0, 5.0);\n\tvec3 tex2 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\ttex1 = mix(tex1, tex2, fract(bias));\n\ttex1 = processEnvironment(tex1);\n\treturn tex1;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",
reflectionPrefilteredCubePS:"uniform samplerCube texture_prefilteredCubeMap128;\nuniform samplerCube texture_prefilteredCubeMap64;\nuniform samplerCube texture_prefilteredCubeMap32;\nuniform samplerCube texture_prefilteredCubeMap16;\nuniform samplerCube texture_prefilteredCubeMap8;\n#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 refl = cubeMapProject(tReflDirW);\n#ifndef RIGHT_HANDED_CUBEMAP\n\trefl.x *= -1.0;\n#endif\n\tvec3 seam = calcSeam(refl);\n\tvec4 c0 = textureCube(texture_prefilteredCubeMap128, applySeam(refl, seam, 1.0 / 128.0));\n\tvec4 c1 = textureCube(texture_prefilteredCubeMap64, applySeam(refl, seam, 2.0 / 128.0));\n\tvec4 c2 = textureCube(texture_prefilteredCubeMap32, applySeam(refl, seam, 4.0 / 128.0));\n\tvec4 c3 = textureCube(texture_prefilteredCubeMap16, applySeam(refl, seam, 8.0 / 128.0));\n\tvec4 c4 = textureCube(texture_prefilteredCubeMap8, applySeam(refl, seam, 16.0 / 128.0));\n\tvec4 c5 = textureCube(texture_prefilteredCubeMap4, applySeam(refl, seam, 32.0 / 128.0));\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tvec4 cubes0;\n\tvec4 cubes1;\n\tif (bias < 1.0) {\n\t\tcubes0 = c0;\n\t\tcubes1 = c1;\n\t} else if (bias < 2.0) {\n\t\tcubes0 = c1;\n\t\tcubes1 = c2;\n\t} else if (bias < 3.0) {\n\t\tcubes0 = c2;\n\t\tcubes1 = c3;\n\t} else if (bias < 4.0) {\n\t\tcubes0 = c3;\n\t\tcubes1 = c4;\n\t} else {\n\t\tcubes0 = c4;\n\t\tcubes1 = c5;\n\t}\n\tvec4 cubeFinal = mix(cubes0, cubes1, fract(bias));\n\treturn processEnvironment($DECODE(cubeFinal).rgb);\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",
reflectionPrefilteredCubeLodPS:"#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tvec3 fixedReflDir = fixSeams(cubeMapProject(tReflDirW), bias);\n#ifndef RIGHT_HANDED_CUBEMAP\n\tfixedReflDir.x *= -1.0;\n#endif\n\tvec3 refl = processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, bias) ).rgb);\n\treturn refl;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",
reflectionSpherePS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = (mat3(matrix_view) * tReflDirW).xyz;\n\tfloat m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\treturn $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",
reflectionSphereLowPS:"uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = vNormalV;\n\tvec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n\treturn $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",refractionPS:"uniform float material_refraction, material_refractionIndex;\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n\tfloat vn = dot(viewVec, Normal);\n\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n\treturn refrVec;\n}\nvoid addRefraction() {\n\tvec3 tmp = dReflDirW;\n\tvec4 tmp2 = dReflection;\n\tdReflection = vec4(0.0);\n\tdReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n\taddReflection();\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n\tdReflDirW = tmp;\n\tdReflection = tmp2;\n}\n",
reprojectPS:"\nvarying vec2 vUv0;\nuniform sampler2D sourceTex;\nuniform samplerCube sourceCube;\nuniform vec4 params;\nfloat targetFace() { return params.x; }\nfloat specularPower() { return params.y; }\nfloat sourceCubeSeamScale() { return params.z; }\nfloat targetCubeSeamScale() { return params.w; }\nfloat PI = 3.141592653589793;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 decodeLinear(vec4 source) {\n\treturn source.rgb;\n}\nvec4 encodeLinear(vec3 source) {\n\treturn vec4(source, 1.0);\n}\nvec3 decodeGamma(vec4 source) {\n\treturn pow(source.xyz, vec3(2.2));\n}\nvec4 encodeGamma(vec3 source) {\n\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nvec4 encodeRGBM(vec3 source) {\n\tvec4 result;\n\tresult.rgb = pow(source.rgb, vec3(0.5));\n\tresult.rgb *= 1.0 / 8.0;\n\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\tresult.a = ceil(result.a * 255.0) / 255.0;\n\tresult.rgb /= result.a;\n\treturn result;\n}\nvec3 decodeRGBE(vec4 source) {\n\tif (source.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn source.xyz * pow(2.0, source.w * 255.0 - 128.0);\n\t}\n}\nvec4 encodeRGBE(vec3 source) {\n\tfloat maxVal = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4(0, 0, 0, 0);\n\t} else {\n\t\tfloat e = ceil(log2(maxVal));\n\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\nvec3 modifySeams(vec3 dir, float amount) {\n\tif (amount != 1.0) {\n\t\tvec3 adir = abs(dir);\n\t\tfloat M = max(max(adir.x, adir.y), adir.z);\n\t\tif (adir.x == M) {\n\t\t\tdir.y *= amount;\n\t\t\tdir.z *= amount;\n\t\t}\n\t\telse if (adir.y == M) {\n\t\t\tdir.x *= amount;\n\t\t\tdir.z *= amount;\n\t\t} else {\n\t\t\tdir.x *= amount;\n\t\t\tdir.y *= amount;\n\t\t}\n\t}\n\treturn dir;\n}\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(atan(dir.z, dir.x) * -1.0, asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n\treturn vec3(cos(uv.y) * cos(-uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * sin(-uv.x));\n}\nvec4 sampleEquirect(vec2 sph) {\n\treturn texture2D(sourceTex, sph / vec2(PI * 2.0, PI) + 0.5);\n}\nvec4 sampleEquirect(vec3 dir) {\n\treturn sampleEquirect(toSpherical(dir));\n}\nvec4 sampleCubemap(vec3 dir) {\n\treturn textureCube(sourceCube, modifySeams(dir, sourceCubeSeamScale()));\n}\nvec4 sampleCubemap(vec2 sph) {\n\treturn sampleCubemap(fromSpherical(sph));\n}\nvec3 getDirectionEquirect() {\n\treturn fromSpherical((vUv0 * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nvec3 getDirectionCubemap() {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = targetFace();\n\tvec3 vec;\n\tif (face == 0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face == 1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face == 2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face == 3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face == 4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\treturn normalize(modifySeams(vec, 1.0 / targetCubeSeamScale()));\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nmat3 matrixFromVectorSlow(vec3 n) {\n\tvec3 a = normalize(cross(n, vec3(0, 1, 0)));\n\tvec3 b = cross(n, a);\n\treturn mat3(a, b, n);\n}\nfloat rnd(int i) {\n\tfloat sini = sin(float(i));\n\tfloat cosi = cos(float(i));\n\treturn fract(sin(dot(vec2(sini, cosi), vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nvec3 hemisphereSamplePhong(vec2 uv, float specPow) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\treturn vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n}\nvec4 reproject() {\n\tif (NUM_SAMPLES <= 1) {\n\t\treturn ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));\n\t} else {\n\t\tvec2 sph = toSpherical(TARGET_FUNC());\n\t\tvec2 sphu = dFdx(sph);\n\t\tvec2 sphv = dFdy(sph);\n\t\tconst float num = sqrt(float(NUM_SAMPLES));\n\t\tvec3 result = vec3(0.0);\n\t\tfor (float u=0.0; u<num; ++u) {\n\t\t\tfor (float v=0.0; v<num; ++v) {\n\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(sph +\n\t\t\t\t\t\t\t\t\t\t\t\t  sphu * (u / num - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t  sphv * (v / num - 0.5)));\n\t\t\t}\n\t\t}\n\t\treturn ENCODE_FUNC(result / (num * num));\n\t}\n}\nvec4 prefilter() {\n\tvec3 vec = TARGET_FUNC();\n\tmat3 vecSpace = matrixFromVectorSlow(vec);\n\tvec3 result = vec3(0.0);\n\tfor (int i=0; i<NUM_SAMPLES; ++i) {\n\t\tvec2 uv = vec2(float(i) / float(NUM_SAMPLES), rnd(i));\n\t\tvec3 dir = vecSpace * hemisphereSamplePhong(uv, specularPower());\n\t\tresult += DECODE_FUNC(SOURCE_FUNC(dir));\n\t}\n\treturn ENCODE_FUNC(result / float(NUM_SAMPLES));\n}\nvoid main(void) {\n\tgl_FragColor = PROCESS_FUNC();\n}\n",
rgbmPS:"vec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n\treturn decodeRGBM(texture2D(tex, uv));\n}\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n\treturn decodeRGBM(textureCube(tex, uvw));\n}\n",screenDepthPS:"uniform sampler2D uDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n#ifdef GL2\nfloat linearizeDepth(float z) {\n\tz = z * 2.0 - 1.0;\n\treturn 1.0 / (camera_params.z * z + camera_params.w);\n}\n#else\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#endif\nfloat getLinearScreenDepth(vec2 uv) {\n\t#ifdef GL2\n\treturn linearizeDepth(texture2D(uDepthMap, uv).r) * camera_params.y;\n\t#else\n\treturn unpackFloat(texture2D(uDepthMap, uv)) * camera_params.y;\n\t#endif\n}\n#ifndef VERTEXSHADER\nfloat getLinearScreenDepth() {\n\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\treturn getLinearScreenDepth(uv);\n}\n#endif\nfloat getLinearDepth(vec3 pos) {\n\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",
shadowCommonPS:"void normalOffsetPointShadow(vec4 shadowParams) {\n\tfloat distScale = length(dLightDirW);\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\tvec3 dir = wPos - dLightPosW;\n\tdLightDirW = dir;\n}\n",shadowCoordPS:"void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tdShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xy /= projPos.w;\n\tdShadowCoord.xy = projPos.xy;\n\tdShadowCoord.z = length(dLightDirW) * shadowParams.w;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0);\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",
shadowCoordVS:"void getLightDirPoint(vec3 lightPosW) {\n\tvec3 lightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(lightDirW);\n\tdLightPosW = lightPosW;\n}\nvoid _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tvMainShadowUv = projPos;\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tvMainShadowUv = projPos;\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tvec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0);\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",
shadowCoordPerspZbufferPS:"void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xyz /= projPos.w;\n\tdShadowCoord = projPos.xyz;\n}\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n",
shadowEVSMPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec3 moments = texture2D(tex, texCoords).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",
shadowEVSMnPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tfloat pixelSize = 1.0 / resolution;\n\ttexCoords -= vec2(pixelSize);\n\tvec3 s00 = texture2D(tex, texCoords).xyz;\n\tvec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n\tvec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n\tvec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n\tvec2 fr = fract(texCoords * resolution);\n\tvec3 h0 = mix(s00, s10, fr.x);\n\tvec3 h1 = mix(s01, s11, fr.x);\n\tvec3 moments = mix(h0, h1, fr.y);\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",
shadowStandardPS:"vec3 lessThan2(vec3 a, vec3 b) {\n\treturn clamp((b - a)*1000.0, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#ifdef GL2\nfloat _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat sum = 0.0;\n\tfloat uw0 = (3.0 - 2.0 * s);\n\tfloat uw1 = (1.0 + 2.0 * s);\n\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\tfloat u1 = s / uw1 + 1.0;\n\tfloat vw0 = (3.0 - 2.0 * t);\n\tfloat vw1 = (1.0 + 2.0 * t);\n\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\tfloat v1 = t / vw1 + 1.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum *= 1.0f / 16.0;\n\treturn sum;\n}\nfloat getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#else\nfloat _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n\tmat3 shadowKernel;\n\tvec3 shadowCoord = dShadowCoord;\n\tvec3 shadowZ = vec3(shadowCoord.z);\n\tshadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\tvec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\tvec3 shadowCoord = dShadowCoord;\n\tfloat xoffset = 1.0 / shadowParams.x;\n\tfloat dx0 = -xoffset;\n\tfloat dx1 = xoffset;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n\tdepthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n\tdepthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n\tdepthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n\tdepthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n\tdepthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n\tdepthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n\tdepthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n\tdepthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\treturn _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n}\nfloat getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#endif\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\tvec3 tc = normalize(dir);\n\tvec3 tcAbs = abs(tc);\n\tvec4 dirX = vec4(1,0,0, tc.x);\n\tvec4 dirY = vec4(0,1,0, tc.y);\n\tfloat majorAxisLength = tc.z;\n\tif ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n\t\tdirX = vec4(0,0,1, tc.z);\n\t\tdirY = vec4(0,1,0, tc.y);\n\t\tmajorAxisLength = tc.x;\n\t} else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n\t\tdirX = vec4(1,0,0, tc.x);\n\t\tdirY = vec4(0,0,1, tc.z);\n\t\tmajorAxisLength = tc.y;\n\t}\n\tfloat shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\tvec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n\tvec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n\tvec3 dx0 = -xoffset;\n\tvec3 dy0 = -yoffset;\n\tvec3 dx1 = xoffset;\n\tvec3 dy1 = yoffset;\n\tmat3 shadowKernel;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n\tdepthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n\tdepthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n\tdepthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n\tdepthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n\tdepthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n\tdepthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n\tdepthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n\tdepthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\tvec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n\tshadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\tvec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\tvec2 fractionalCoord = fract( uv * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n\treturn _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n",
shadowStandardGL2PS:"float _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat uw0 = (4.0 - 3.0 * s);\n\tfloat uw1 = 7.0;\n\tfloat uw2 = (1.0 + 3.0 * s);\n\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tfloat u1 = (3.0 + s) / uw1;\n\tfloat u2 = s / uw2 + 2.0;\n\tfloat vw0 = (4.0 - 3.0 * t);\n\tfloat vw1 = 7.0;\n\tfloat vw2 = (1.0 + 3.0 * t);\n\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tfloat v1 = (3.0 + t) / vw1;\n\tfloat v2 = t / vw2 + 2.0;\n\tfloat sum = 0.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n\tsum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n\tsum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n\tsum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n\tsum *= 1.0f / 144.0;\n\tsum = gammaCorrectInput(sum);\n\tsum = saturate(sum);\n\treturn sum;\n}\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n",
shadowStandardGL2VSPS:"float getShadowPCF5x5VS(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tdShadowCoord = vMainShadowUv.xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\treturn _getShadowPCF5x5(shadowMap, shadowParams);\n}\n",shadowStandardVSPS:"#ifdef GL2\n#define SHADOW_SAMPLERVS sampler2DShadow\n#else\n#define SHADOW_SAMPLERVS sampler2D\n#endif\nfloat getShadowPCF3x3VS(SHADOW_SAMPLERVS shadowMap, vec3 shadowParams) {\n\tdShadowCoord = vMainShadowUv.xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\n",
shadowVSM8PS:"float calculateVSM8(vec3 moments, float Z, float vsmBias) {\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * Z;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec4 c = texture2D(tex, texCoords);\n\tvec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n\treturn calculateVSM8(moments, Z, vsmBias);\n}\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n",
shadowVSMVSPS:"float getShadowVSM$VS(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\tdShadowCoord = vMainShadowUv.xyz;\n\tdShadowCoord.z += shadowParams.z;\n\tdShadowCoord.xyz /= vMainShadowUv.w;\n\tdShadowCoord.z = min(dShadowCoord.z, 1.0);\n\treturn $VSM(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n",shadowVSM_commonPS:"float linstep(float a, float b, float v) {\n\treturn saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n   return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\tfloat variance = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tfloat d = mean - moments.x;\n\tfloat pMax = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\tZ = 2.0 * Z - 1.0;\n\tfloat warpedDepth = exp(exponent * Z);\n\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n",
skinBatchConstVS:"attribute float vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nmat4 getBoneMatrix(const in float i) {\n\tvec4 v1 = matrix_pose[int(3.0 * i)];\n\tvec4 v2 = matrix_pose[int(3.0 * i + 1.0)];\n\tvec4 v3 = matrix_pose[int(3.0 * i + 2.0)];\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinBatchTexVS:"attribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tvec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tvec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tvec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",
skinConstVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tv1 = matrix_pose[int(3.0 * i)];\n\tv2 = matrix_pose[int(3.0 * i + 1.0)];\n\tv3 = matrix_pose[int(3.0 * i + 2.0)];\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",
skinTexVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tv1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tv2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tv3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",
skyboxPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n\tgl_FragColor = textureCube(texture_cubeMap, fixSeams(vViewDir));\n}\n",skyboxVS:"attribute vec3 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projectionSkybox;\nvarying vec3 vViewDir;\nvoid main(void) {\n\tmat4 view = matrix_view;\n\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\tgl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\tgl_Position.z = gl_Position.w - 0.00001;\n\tvViewDir = aPosition;\n}\n",
skyboxHDRPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvoid main(void) {\n#ifdef CUBEMAP_ROTATION\n\tvec3 dir=vViewDir * cubeMapRotationMatrix;\n#else\n\tvec3 dir=vViewDir;\n#endif\n#ifndef RIGHT_HANDED_CUBEMAP\n\tdir.x *= -1.0;\n#endif\n\tvec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(dir, $FIXCONST)).rgb);\n\tcolor = toneMap(color);\n\tcolor = gammaCorrectOutput(color);\n\tgl_FragColor = vec4(color, 1.0);\n}\n",
skyboxPrefilteredCubePS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n\tfloat scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvoid main(void) {\n\tvec3 color = textureCubeRGBM(texture_cubeMap, fixSeamsStretch(vViewDir, 0.0, 128.0));\n\tcolor = toneMap(color);\n\tcolor = gammaCorrectOutput(color);\n\tgl_FragColor = vec4(color, 1.0);\n}\n",
specularPS:"#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\nvoid getSpecularity() {\n\tdSpecularity = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdSpecularity *= material_specular;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdSpecularity *= texture2D(texture_specularMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",specularAaNonePS:"float antiAliasGlossiness(float power) {\n\treturn power;\n}\n",
specularAaToksvigPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * mix(1.0, toksvig, material_bumpiness);\n}\n",specularAaToksvigFastPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * toksvig;\n}\n",spotPS:"float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n\tfloat cosAngle = dot(dLightDirNormW, lightSpotDirW);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",
startPS:"void main(void) {\n\tdDiffuseLight = vec3(0);\n\tdSpecularLight = vec3(0);\n\tdReflection = vec4(0);\n\tdSpecularity = vec3(0);\n\t#ifdef CLEARCOAT\n\tccSpecularLight = vec3(0);\n\tccReflection = vec4(0);\n\t#endif\n",startVS:"void main(void) {\n\tgl_Position = getPosition();\n",startNineSlicedPS:"\tnineSlicedUv = vUv0;\n",startNineSlicedTiledPS:"\tvec2 tileMask = step(vMask, vec2(0.99999));\n\tvec2 clampedUv = mix(innerOffset.xy*0.5, vec2(1.0) - innerOffset.zw*0.5, fract(vTiledUv));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n",
storeEVSMPS:"float exponent = VSM_EXPONENT;\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n",tangentBinormalVS:"vec3 getTangent() {\n\treturn normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n\treturn cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\nvec3 getObjectSpaceUp() {\n\treturn normalize(dNormalMatrix * vec3(0, 1, 0));\n}\n",TBNPS:"void getTBN() {\n\tdTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n",
TBNderivativePS:"\nvoid getTBN() {\n\tvec2 uv = $UV;\n\tvec3 dp1 = dFdx( vPositionW );\n\tvec3 dp2 = dFdy( vPositionW );\n\tvec2 duv1 = dFdx( uv );\n\tvec2 duv2 = dFdy( uv );\n\tvec3 dp2perp = cross( dp2, dVertexNormalW );\n\tvec3 dp1perp = cross( dVertexNormalW, dp1 );\n\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\tfloat invmax = 1.0 / sqrt( max( dot(T,T), dot(B,B) ) );\n\tdTBN = mat3( T * invmax, B * invmax, dVertexNormalW );\n}\n",TBNfastPS:"void getTBN() {\n\tdTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n",
TBNObjectSpacePS:"void getTBN() {\n\tvec3 B = cross(dVertexNormalW, vObjectSpaceUpW);\n\tvec3 T = cross(dVertexNormalW, B);\n\tif (dot(B,B)==0.0)\n\t{\n\t\tfloat major=max(max(dVertexNormalW.x, dVertexNormalW.y),dVertexNormalW.z);\n\t\tif (dVertexNormalW.x==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,1,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.y==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,0,1));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.z==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(1,0,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t}\n\tdTBN = mat3(normalize(T), normalize(B), normalize(dVertexNormalW));\n}\n",
tonemappingAcesPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tfloat tA = 2.51;\n\tfloat tB = 0.03;\n\tfloat tC = 2.43;\n\tfloat tD = 0.59;\n\tfloat tE = 0.14;\n\tvec3 x = color * exposure;\n\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"uniform float exposure;\nconst mat3 ACESInputMat = mat3(\n\t0.59719, 0.35458, 0.04823,\n\t0.07600, 0.90834, 0.01566,\n\t0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n\t 1.60475, -0.53108, -0.07367,\n\t-0.10208,  1.10813, -0.00605,\n\t-0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\treturn a / b;\n}\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tcolor = color * ACESInputMat;\n\tcolor = RRTAndODTFit(color);\n\tcolor = color * ACESOutputMat;\n\tcolor = clamp(color, 0.0, 1.0);\n\treturn color;\n}\n",
tonemappingFilmicPS:"const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n\tcolor = uncharted2Tonemap(color * exposure);\n\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\tcolor = color * whiteScale;\n\treturn color;\n}\n",tonemappingHejlPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tconst float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\tconst float Scl = 1.25;\n\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",
tonemappingLinearPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\treturn color * exposure;\n}\n",tonemappingNonePS:"vec3 toneMap(vec3 color) {\n\treturn color;\n}\n",transformVS:"#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef MORPHING\nuniform vec4 morph_weights_a;\nuniform vec4 morph_weights_b;\n#endif\n#ifdef MORPHING_TEXTURE_BASED\nuniform vec4 morph_tex_params;\nvec2 getTextureMorphCoords() {\n\tfloat vertexId = morph_vertex_id;\n\tvec2 textureSize = morph_tex_params.xy;\n\tvec2 invTextureSize = morph_tex_params.zw;\n\tfloat morphGridV = floor(vertexId * invTextureSize.x);\n\tfloat morphGridU = vertexId - (morphGridV * textureSize.x);\n\treturn (vec2(morphGridU, morphGridV) * invTextureSize) + (0.5 * invTextureSize);\n}\n#endif\n#ifdef MORPHING_TEXTURE_BASED_POSITION\nuniform highp sampler2D morphPositionTex;\n#endif\nmat4 getModelMatrix() {\n\t#ifdef DYNAMICBATCH\n\treturn getBoneMatrix(vertex_boneIndices);\n\t#elif defined(SKIN)\n\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t#elif defined(INSTANCING)\n\treturn mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n\t#else\n\treturn matrix_model;\n\t#endif\n}\nvec4 getPosition() {\n\tdModelMatrix = getModelMatrix();\n\tvec3 localPos = vertex_position;\n\t#ifdef NINESLICED\n\tlocalPos.xz *= outerScale;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n\tlocalPos.xz *= -0.5;\n\tlocalPos = localPos.xzy;\n\t#endif\n\t#ifdef MORPHING\n\t#ifdef MORPHING_POS03\n\tlocalPos.xyz += morph_weights_a[0] * morph_pos0;\n\tlocalPos.xyz += morph_weights_a[1] * morph_pos1;\n\tlocalPos.xyz += morph_weights_a[2] * morph_pos2;\n\tlocalPos.xyz += morph_weights_a[3] * morph_pos3;\n\t#endif\n\t#ifdef MORPHING_POS47\n\tlocalPos.xyz += morph_weights_b[0] * morph_pos4;\n\tlocalPos.xyz += morph_weights_b[1] * morph_pos5;\n\tlocalPos.xyz += morph_weights_b[2] * morph_pos6;\n\tlocalPos.xyz += morph_weights_b[3] * morph_pos7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_POSITION\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;\n\tlocalPos += morphPos;\n\t#endif\n\tvec4 posW = dModelMatrix * vec4(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\tposW.zw = vec2(0.0, 1.0);\n\t#endif\n\tdPositionW = posW.xyz;\n\tvec4 screenPos;\n\t#ifdef UV1LAYOUT\n\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t#else\n\t#ifdef SCREENSPACE\n\tscreenPos = posW;\n\t#else\n\tscreenPos = matrix_viewProjection * posW;\n\t#endif\n\t#ifdef PIXELSNAP\n\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\tscreenPos.xy *= uScreenSize.xy;\n\tscreenPos.xy = floor(screenPos.xy);\n\tscreenPos.xy *= uScreenSize.zw;\n\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t#endif\n\t#endif\n\treturn screenPos;\n}\nvec3 getWorldPosition() {\n\treturn dPositionW;\n}\n",
transformDeclVS:"attribute vec3 vertex_position;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\nvec3 dPositionW;\nmat4 dModelMatrix;\n",uv0VS:"#ifdef NINESLICED\nvec2 getUv0() {\n\tvec2 uv = vertex_position.xz;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tuv = uv * -0.5 + 0.5;\n\tuv = uv * atlasRect.zw + atlasRect.xy;\n\tvMask = vertex_texCoord0.xy;\n\treturn uv;\n}\n#else\nvec2 getUv0() {\n\treturn vertex_texCoord0;\n}\n#endif\n",
uv1VS:"vec2 getUv1() {\n\treturn vertex_texCoord1;\n}\n",viewDirPS:"void getViewDir() {\n\tdViewDirW = normalize(view_position - vPositionW);\n}\n",viewNormalVS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nvec3 getViewNormal() {\n\treturn mat3(matrix_view) * vNormalW;\n}\n"},yn={vertex_position:"POSITION",vertex_normal:"NORMAL",vertex_tangent:"TANGENT",vertex_texCoord0:"TEXCOORD0",vertex_texCoord1:"TEXCOORD1",vertex_texCoord2:"TEXCOORD2",vertex_texCoord3:"TEXCOORD3",
vertex_texCoord4:"TEXCOORD4",vertex_texCoord5:"TEXCOORD5",vertex_texCoord6:"TEXCOORD6",vertex_texCoord7:"TEXCOORD7",vertex_color:"COLOR",vertex_boneIndices:"BLENDINDICES",vertex_boneWeights:"BLENDWEIGHT"};I.collectAttribs=Je;I.createShader=function(l,g,d,b){g=I[g];d=wc(l)+"\n"+I[d];var a=Je(g);l.webgl2&&(g=xc(l)+I.gles3VS+g,d=xc(l)+I.gles3PS+d);return new Ld(l,{attributes:a,vshader:g,fshader:d,useTransformFeedback:b})};I.createShaderFromCode=Ja;var Rg=function(l,g,d){return"\n#ifdef MAPFLOAT\n"+l+
"\n#else\n"+I[g]+"\n#endif\n"},Sg=function(l,g,d){return"\n#ifdef MAPCOLOR\n"+l+"\n#else\n"+I[g]+"\n#endif\n"},Gc=function(l,g,d){return"\n#ifdef MAPTEXTURE\n"+l+"\n#else\n"+I[g]+"\n#endif\n"},Tg=function(l,g,d){return"#undef MAPTEXTURECOLOR\n#ifdef MAPTEXTURE\n#ifdef MAPCOLOR\n#define MAPTEXTURECOLOR\n#endif\n#endif\n#ifdef MAPTEXTURECOLOR\n"+l+"\n#else\n"+I[g]+"\n#endif\n"},jf=function(l,g,d){return"#undef MAPTEXTUREFLOAT\n#ifdef MAPTEXTURE\n#ifdef MAPFLOAT\n#define MAPTEXTUREFLOAT\n#endif\n#endif\n#ifdef MAPTEXTUREFLOAT\n"+
l+"\n#else\n"+I[g]+"\n#endif\n"},Hc=function(l,g,d){return"\n#ifdef MAPVERTEX\n"+l+"\n#else\n"+I[g]+"\n#endif\n"},Ug=function(l,g,d){return"#undef MAPVERTEXCOLOR\n#ifdef MAPVERTEX\n#ifdef MAPCOLOR\n#define MAPVERTEXCOLOR\n#endif\n#endif\n#ifdef MAPVERTEXCOLOR\n"+l+"\n#else\n"+I[g]+"\n#endif\n"},kf=function(l,g,d){return"#undef MAPVERTEXFLOAT\n#ifdef MAPVERTEX\n#ifdef MAPFLOAT\n#define MAPVERTEXFLOAT\n#endif\n#endif\n#ifdef MAPVERTEXFLOAT\n"+l+"\n#else\n"+I[g]+"\n#endif\n"},Fb=[],Vg={_oldChunkToNew:{aoTexPS:{n:"aoPS",
f:Gc},aoVertPS:{n:"aoPS",f:Hc},diffuseConstPS:{n:"diffusePS",f:Sg},diffuseTexPS:{n:"diffusePS",f:Gc},diffuseTexConstPS:{n:"diffusePS",f:Tg},diffuseVertPS:{n:"diffusePS",f:Hc},diffuseVertConstPS:{n:"diffusePS",f:Ug},emissiveConstPS:{n:"emissivePS",f:Sg},emissiveTexPS:{n:"emissivePS",f:Gc},emissiveTexConstPS:{n:"emissivePS",f:Tg},emissiveTexConstFloatPS:{n:"emissivePS",f:jf},emissiveVertPS:{n:"emissivePS",f:Hc},emissiveVertConstPS:{n:"emissivePS",f:Ug},emissiveVertConstFloatPS:{n:"emissivePS",f:kf},
glossConstPS:{n:"glossPS",f:Rg},glossTexPS:{n:"glossPS",f:Gc},glossTexConstPS:{n:"glossPS",f:jf},glossVertPS:{n:"glossPS",f:Hc},glossVertConstPS:{n:"glossPS",f:kf},metalnessConstPS:{n:"metalnessPS",f:Rg},metalnessTexPS:{n:"metalnessPS",f:Gc},metalnessTexConstPS:{n:"metalnessPS",f:jf},metalnessVertPS:{n:"metalnessPS",f:Hc},metalnessVertConstPS:{n:"metalnessPS",f:kf},opacityConstPS:{n:"opacityPS",f:Rg},opacityTexPS:{n:"opacityPS",f:Gc},opacityTexConstPS:{n:"opacityPS",f:jf},opacityVertPS:{n:"opacityPS",
f:Hc},opacityVertConstPS:{n:"opacityPS",f:kf},specularConstPS:{n:"specularPS",f:Sg},specularTexPS:{n:"specularPS",f:Gc},specularTexConstPS:{n:"specularPS",f:Tg},specularVertPS:{n:"specularPS",f:Hc},specularVertConstPS:{n:"specularPS",f:Ug},transformBatchSkinnedVS:{n:"transformVS",f:function(l,g,d){return"\n#ifdef DYNAMICBATCH\n"+l+"\n#else\n"+I[g]+"\n#endif\n"}},transformInstancedVS:{n:"transformVS",f:function(l,g,d){return"\n#ifdef INSTANCING\n"+l+"\n#else\n"+I[g]+"\n#endif\n"}},transformPixelSnapVS:{n:"transformVS",
f:function(l,g,d){return"\n#ifdef PIXELSNAP\n"+l+"\n#else\n"+I[g]+"\n#endif\n"}},transformScreenSpaceVS:{n:"transformVS",f:function(l,g,d){return"\n#ifdef SCREENSPACE\n"+l+"\n#else\n"+I[g]+"\n#endif\n"}},transformScreenSpaceBatchSkinned:{n:"transformVS",f:function(l,g,d){return"#undef SCREENSPACEBATCH\n#ifdef SCREENSPACE\n#ifdef BATCH\n#define SCREENSPACEBATCH\n#endif\n#endif\n#ifdef SCREENSPACEBATCH\n"+l+"\n#else\n"+I[g]+"\n#endif\n"}},transformSkinned:{n:"transformVS",f:function(l,g,d){return"\n#ifdef SKIN\n"+
l+"\n#else\n"+I[g]+"\n#endif\n"}},transformUv1:{n:"transformVS",f:function(l,g,d){return"\n#ifdef UV1LAYOUT\n"+l+"\n#else\n"+I[g]+"\n#endif\n"}}},optionsContext:{},optionsContextMin:{},generateKey:function(l){var g=function(c){var e=[],f;for(f in c)c.hasOwnProperty(f)&&"chunks"!==f&&"lights"!==f&&e.push(f);return e.sort()};if(l===this.optionsContextMin){this.propsMin||(this.propsMin=g(l));var d=this.propsMin}else l===this.optionsContext?(this.props||(this.props=g(l)),d=this.props):d=g(l);g="standard";
var b;for(b=0;b<d.length;b++)l[d[b]]&&(g+=d[b]+l[d[b]]);if(l.chunks){d=[];for(var a in l.chunks)l.chunks.hasOwnProperty(a)&&d.push(a+l.chunks[a]);d.sort();g+=d}if(l.lights)for(b=0;b<l.lights.length;b++)g+=l.lights[b].key;return Xc(g)},_correctChannel:function(l,g){if(0<Fb[l]){if(Fb[l]<g.length)return g.substring(0,Fb[l]);if(Fb[l]>g.length){var d=g.charAt(g.length-1);l=Fb[l]-g.length;for(var b=0;b<l;b++)g+=d;return g}return g}},_setMapTransform:function(l,g,d,b){l[0]+="uniform vec4 texture_"+g+"MapTransform;\n";
var a=d+100*b;l[3][a]||(l[1]+="varying vec2 vUV"+b+"_"+d+";\n",l[2]+="\t vUV"+b+"_"+d+" = uv"+b+" * texture_"+g+"MapTransform.xy + texture_"+g+"MapTransform.zw;\n",l[3][a]=!0);return l},_getUvSourceExpression:function(l,g,d){var b=d[l];g=d[g];var a=0===d.pass||1===d.pass;a&&1===d.nineSlicedMode?b="nineSlicedUv":a&&2===d.nineSlicedMode?b="nineSlicedUv, -1000.0":(b=0===b?"vUv"+g:"vUV"+g+"_"+b,d.heightMap&&"heightMapTransform"!==l&&(b+=" + dUvOffset"));return b},_addMapDef:function(l,g){var d="\n#undef "+
l+"\n";g&&(d+=" #define "+l+"\n");return d},_addMapDefs:function(l,g,d,b){l=""+this._addMapDef("MAPFLOAT",l);l+=this._addMapDef("MAPCOLOR",g);l+=this._addMapDef("MAPVERTEX",d);return l+=this._addMapDef("MAPTEXTURE",b)},_addMap:function(l,g,d,b,a){var c=l+"Map",e=c+"Uv",f=c+"Transform",h=c+"Channel",k=l+"VertexColorChannel",m=d[l+"Tint"],n=d[l+"VertexColor"];c=d[c];l=d[l+"Mode"];g=b[g];c&&(e=this._getUvSourceExpression(f,e,d),g=g.replace(/\$UV/g,e).replace(/\$CH/g,d[h]),void 0!==a&&(g=g.replace(/\$texture2DSAMPLE/g,
0===a?"texture2DSRGB":1===a?"texture2DRGBM":"texture2D")));n&&(g=g.replace(/\$VC/g,d[k]));l&&(g=g.replace(/\$DETAILMODE/g,l));g=this._addMapDefs(1===m,3===m,n,c)+g;return g.replace(/\$/g,"")},_nonPointShadowMapProjection:function(l,g,d){return!g._normalOffsetBias||g._isVsm?2===g._type?g._isPcf&&(l.webgl2||l.extStandardDerivatives)?"\t\t\t getShadowCoordPerspZbuffer"+d:"\t\t\t getShadowCoordPersp"+d:"\t\t\t getShadowCoordOrtho"+d:2===g._type?g._isPcf&&(l.webgl2||l.extStandardDerivatives)?"\t\t\t getShadowCoordPerspZbufferNormalOffset"+
d:"\t\t\t getShadowCoordPerspNormalOffset"+d:"\t\t\t getShadowCoordOrthoNormalOffset"+d},_addVaryingIfNeeded:function(l,g,d){return 0<=l.indexOf(d)?"varying "+g+" "+d+";\n":""},_getLightSourceShapeString:function(l){switch(l){case 1:return"Rect";case 2:return"Disk";case 3:return"Sphere";default:return""}},_vsAddTransformCode:function(l,g,d,b){return l+=d.transformVS},_vsAddBaseCode:function(l,g,d,b){l+=d.baseVS;if(1===b.nineSlicedMode||2===b.nineSlicedMode)l+=d.baseNineSlicedVS;return l},_fsAddBaseCode:function(l,
g,d,b){l+=d.basePS;1===b.nineSlicedMode?l+=d.baseNineSlicedPS:2===b.nineSlicedMode&&(l+=d.baseNineSlicedTiledPS);return l},_fsAddStartCode:function(l,g,d,b){l+=d.startPS;1===b.nineSlicedMode?l+=d.startNineSlicedPS:2===b.nineSlicedMode&&(l+=d.startNineSlicedTiledPS);return l},createShaderDefinition:function(l,g){var d=0<g.lights.length;g.dirLightMap&&(d=!0,g.useSpecular=!0);0===g.shadingModel?(g.fresnelModel=0,g.specularAntialias=!1,g.prefilteredCubemap=!1,g.dpAtlas=!1,g.ambientSH=!1):g.fresnelModel=
0===g.fresnelModel?2:g.fresnelModel;var b=(g.cubeMap||g.prefilteredCubemap&&g.useSpecular)&&!g.sphereMap&&!g.dpAtlas,a=g.sphereMap||b||g.dpAtlas,c=g.useTexCubeLod;g.cubeMap&&(g.sphereMap=null);g.dpAtlas&&(g.prefilteredCubemap=null);g.useSpecular||(g.specularMap=g.glossMap=null);var e=d||a||g.ambientSH||g.prefilteredCubemap||g.heightMap||g.enableGGXSpecular,f=3<=g.pass&&17>=g.pass;this.options=g;var h="",k="",m="",n=I,p={vertex_position:"POSITION"};if(g.chunks){var t={};for(z in n)if(n.hasOwnProperty(z))if(g.chunks[z]){var r=
g.chunks[z];0<=r.indexOf("vertex_normal")&&(p.vertex_normal="NORMAL");0<=r.indexOf("vertex_tangent")&&(p.vertex_tangent="TANGENT");0<=r.indexOf("vertex_texCoord0")&&(p.vertex_texCoord0="TEXCOORD0");0<=r.indexOf("vertex_texCoord1")&&(p.vertex_texCoord1="TEXCOORD1");0<=r.indexOf("vertex_color")&&(p.vertex_color="COLOR");0<=r.indexOf("vertex_boneWeights")&&(p.vertex_boneWeights="BLENDWEIGHT");0<=r.indexOf("vertex_boneIndices")&&(p.vertex_boneIndices="BLENDINDICES");t[z]=r}else t[z]=n[z];for(z in g.chunks)(n=
this._oldChunkToNew[z])&&(t[n.n]=n.f(g.chunks[z],n.n,z));n=t}h=this._vsAddBaseCode(h,l,n,g);t=-1;if(!g.noShadow&&!g.twoSidedLighting){for(r=0;r<g.lights.length;r++){var u=g.lights[r]._type;if(g.lights[r].castShadows&&0===u){h+="uniform mat4 light"+r+"_shadowMatrixVS;\n";h+="uniform vec3 light"+r+"_shadowParamsVS;\n";h+="uniform vec3 light"+r+(0===u?"_directionVS":"_positionVS")+";\n";t=r;break}}0<=t&&(h+=n.shadowCoordVS)}k+="\t vPositionW\t\t= getWorldPosition();\n";2===g.pass&&(h+="varying float vDepth;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n\n#endif\n",
k+="\t\tvDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n");g.useInstancing&&(p.instance_line1="TEXCOORD2",p.instance_line2="TEXCOORD3",p.instance_line3="TEXCOORD4",p.instance_line4="TEXCOORD5",h+=n.instancingVS);e&&(p.vertex_normal="NORMAL",k+="\t vNormalW\t\t= dNormalW = getNormal();\n",g.sphereMap&&16>=l.fragmentUniformsCount&&(h+=n.viewNormalVS,k+="\t vNormalV\t\t= getViewNormal();\n"),(g.heightMap||g.normalMap||g.enableGGXSpecular)&&g.hasTangents?(p.vertex_tangent="TANGENT",
h+=n.tangentBinormalVS,k+="\t vTangentW\t = getTangent();\n\t vBinormalW\t= getBinormal();\n"):g.enableGGXSpecular&&(h+=n.tangentBinormalVS,k+="\t vObjectSpaceUpW\t= getObjectSpaceUp();\n"),0<=t&&(u=g.lights[t]._type,k=(0===u?k+("\t dLightDirNormW = light"+t+"_directionVS;\n"):k+("\t getLightDirPoint(light"+t+"_positionVS);\n"))+this._nonPointShadowMapProjection(l,g.lights[t],"(light"+t+"_shadowMatrixVS, light"+t+"_shadowParamsVS);\n")));u=[];var v=[];for(z in Fb){r=z+"Map";if(g[z+"VertexColor"]){var w=
z+"VertexColorChannel";g[w]=this._correctChannel(z,g[w])}if(g[r]){w=r+"Channel";var y=r+"Transform";var x=r+"Uv";g[x]=Math.min(g[x],1);g[w]=this._correctChannel(z,g[w]);x=g[x];u[x]=!0;v[x]=v[x]||g[r]&&!g[y]}}g.forceUv1&&(u[1]=!0,v[1]=void 0!==v[1]?v[1]:!0);for(r=0;2>r;r++)u[r]&&(p["vertex_texCoord"+r]="TEXCOORD"+r,h+=n["uv"+r+"VS"],k+="\t vec2 uv"+r+" = getUv"+r+"();\n"),v[r]&&(k+="\t vUv"+r+" = uv"+r+";\n");k=[h,m,k,[]];for(z in Fb)r=z+"Map",g[r]&&(y=r+"Transform",g[y]&&(x=r+"Uv",this._setMapTransform(k,
z,g[y],g[x])));h=k[0];m=k[1];k=k[2];g.vertexColors&&(p.vertex_color="COLOR",k+="\t vVertexColor = vertex_color;\n");if(g.useMorphPosition||g.useMorphNormal)g.useMorphTextureBased?(h+="#define MORPHING_TEXTURE_BASED\n",g.useMorphPosition&&(h+="#define MORPHING_TEXTURE_BASED_POSITION\n"),g.useMorphNormal&&(h+="#define MORPHING_TEXTURE_BASED_NORMAL\n"),p.morph_vertex_id="ATTR15",h+="attribute float morph_vertex_id;\n"):(h+="#define MORPHING\n",g.useMorphPosition?(p.morph_pos0="ATTR8",p.morph_pos1="ATTR9",
p.morph_pos2="ATTR10",p.morph_pos3="ATTR11",h+="#define MORPHING_POS03\nattribute vec3 morph_pos0;\nattribute vec3 morph_pos1;\nattribute vec3 morph_pos2;\nattribute vec3 morph_pos3;\n"):g.useMorphNormal&&(p.morph_nrm0="ATTR8",p.morph_nrm1="ATTR9",p.morph_nrm2="ATTR10",p.morph_nrm3="ATTR11",h+="#define MORPHING_NRM03\nattribute vec3 morph_nrm0;\nattribute vec3 morph_nrm1;\nattribute vec3 morph_nrm2;\nattribute vec3 morph_nrm3;\n"),g.useMorphNormal?(p.morph_nrm4="ATTR12",p.morph_nrm5="ATTR13",p.morph_nrm6=
"ATTR14",p.morph_nrm7="ATTR15",h+="#define MORPHING_NRM47\nattribute vec3 morph_nrm4;\nattribute vec3 morph_nrm5;\nattribute vec3 morph_nrm6;\nattribute vec3 morph_nrm7;\n"):(p.morph_pos4="ATTR12",p.morph_pos5="ATTR13",p.morph_pos6="ATTR14",p.morph_pos7="ATTR15",h+="#define MORPHING_POS47\nattribute vec3 morph_pos4;\nattribute vec3 morph_pos5;\nattribute vec3 morph_pos6;\nattribute vec3 morph_pos7;\n"));g.skin?(p.vertex_boneWeights="BLENDWEIGHT",p.vertex_boneIndices="BLENDINDICES",h+=lg(l,n),h+="#define SKIN\n"):
g.useInstancing&&(h+="#define INSTANCING\n");g.screenSpace&&(h+="#define SCREENSPACE\n");g.pixelSnap&&(h+="#define PIXELSNAP\n");h=this._vsAddTransformCode(h,l,n,g);e&&(h+=n.normalVS);h=h+"\n"+n.startVS;var z=h=h+k+"}";k=m;m=""+this._addVaryingIfNeeded(h,"vec4","vMainShadowUv");m+=this._addVaryingIfNeeded(h,"vec4","vVertexColor");m+=this._addVaryingIfNeeded(h,"vec3","vPositionW");m+=this._addVaryingIfNeeded(h,"vec3","vNormalV");m+=this._addVaryingIfNeeded(h,"vec3","vNormalW");m+=this._addVaryingIfNeeded(h,
"vec3","vTangentW");m+=this._addVaryingIfNeeded(h,"vec3","vBinormalW");m+=this._addVaryingIfNeeded(h,"vec3","vObjectSpaceUpW");m+=this._addVaryingIfNeeded(h,"vec2","vUv0");m+=this._addVaryingIfNeeded(h,"vec2","vUv1");m+=k;z=m+z;h="";l.webgl2?(h=xc(l),n.extensionVS&&(h+=n.extensionVS+"\n"),z=h+n.gles3VS+z):(n.extensionVS&&(h=n.extensionVS+"\n"),z=h+z);g.forceFragmentPrecision&&"highp"!=g.forceFragmentPrecision&&"mediump"!==g.forceFragmentPrecision&&"lowp"!==g.forceFragmentPrecision&&(g.forceFragmentPrecision=
null);g.forceFragmentPrecision&&("highp"===g.forceFragmentPrecision&&"highp"!==l.maxPrecision&&(g.forceFragmentPrecision="mediump"),"mediump"===g.forceFragmentPrecision&&"lowp"===l.maxPrecision&&(g.forceFragmentPrecision="lowp"));h="";l.webgl2&&(h+=xc(l));l.extStandardDerivatives&&!l.webgl2&&(h+="#extension GL_OES_standard_derivatives : enable\n\n");n.extensionPS&&(h+=n.extensionPS+"\n");l.webgl2&&(h+=n.gles3PS);h+=g.forceFragmentPrecision?"precision "+g.forceFragmentPrecision+" float;\n\n":wc(l);
if(18===g.pass)return h=h+"uniform vec4 uColor;\n"+m,g.alphaTest&&(h=h+"float dAlpha;\n"+this._addMap("opacity","opacityPS",g,n),h+=n.alphaTestPS),h+=Yc(),g.alphaTest&&(h+="\t getOpacity();\n\t alphaTest(dAlpha);\n"),{attributes:p,vshader:z,fshader:h+"\t\tgl_FragColor = uColor;\n}\n"};if(2===g.pass)return h=h+"varying float vDepth;\n"+m+n.packDepthPS,g.alphaTest&&(h+="float dAlpha;\n",h+=this._addMap("opacity","opacityPS",g,n),h+=n.alphaTestPS),h+=Yc(),g.alphaTest&&(h+="\t getOpacity();\n",h+="\t alphaTest(dAlpha);\n"),
h+="\t\tgl_FragColor = packFloat(vDepth);\n",h+="}\n",{attributes:p,vshader:z,fshader:h};if(f)return b=g.pass-3,u=Math.floor(b/5),b-=5*u,l.extStandardDerivatives&&!l.webgl2&&(h+="uniform vec2 polygonOffset;\n"),3===b?h=l.textureFloatHighPrecision?h+"#define VSM_EXPONENT 15.0\n\n":h+"#define VSM_EXPONENT 5.54\n\n":2===b&&(h+="#define VSM_EXPONENT 5.54\n\n"),0!==u&&(h+="uniform vec3 view_position;\n",h+="uniform float light_radius;\n"),h+=m,g.alphaTest&&(h+="float dAlpha;\n",h+=this._addMap("opacity",
"opacityPS",g,n),h+=n.alphaTestPS),0!==b||l.webgl2&&1!==u?1===b&&(h+="vec2 encodeFloatRG( float v ) {\n",h+="\t\tvec2 enc = vec2(1.0, 255.0) * v;\n",h+="\t\tenc = fract(enc);\n",h+="\t\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",h+="\t\treturn enc;\n",h+="}\n\n"):h+=n.packDepthPS,h+=Yc(),g.alphaTest&&(h+="\t getOpacity();\n",h+="\t alphaTest(dAlpha);\n"),h=1===u||(1===b||2===b||3===b)&&0!==u?h+"\t float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n":h+"\t float depth = gl_FragCoord.z;\n",
0!==b||l.webgl2&&1!==u?h=0===b||4===b?h+"\t gl_FragColor = vec4(1.0);\n":1===b?h+"\t gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":h+n.storeEVSMPS:(l.extStandardDerivatives&&!l.webgl2&&(h+="\t float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",h+="\t depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n"),h+="\t gl_FragColor = packFloat(depth);\n"),h+="}\n",{attributes:p,vshader:z,fshader:h};
if(g.customFragmentShader)return l=h+g.customFragmentShader,{attributes:p,vshader:z,fshader:l,tag:1};h=this._fsAddBaseCode(h+m,l,n,g);g.detailModes&&(h+=n.detailModesPS);m=h;h="";0<g.clearCoat&&(h+="#define CLEARCOAT\n");!1===g.opacityFadesSpecular&&(h+="uniform float material_alphaFade;\n");x=0;w=[];var B=!1,C=!1;f=g.lights.some(function(J){return J._shape&&0!==J._shape});7===l._areaLightLutFormat&&(h+="#define AREA_R8_G8_B8_A8_LUTS\n");f&&(h+="#define AREA_LIGHTS\n",h+="uniform sampler2D areaLightsLutTex1;\n",
h+="uniform sampler2D areaLightsLutTex2;\n");for(r=y=0;r<g.lights.length;r++)if(v=g.lights[r],u=v._type,y=f&&v._shape?v._shape:0,h+="uniform vec3 light"+r+"_color;\n",0===u?h+="uniform vec3 light"+r+"_direction;\n":(h+="uniform vec3 light"+r+"_position;\n",h+="uniform float light"+r+"_radius;\n",2===u&&(h+="uniform vec3 light"+r+"_direction;\n",h+="uniform float light"+r+"_innerConeAngle;\n",h+="uniform float light"+r+"_outerConeAngle;\n")),0!==y&&(0===u&&(h+="uniform vec3 light"+r+"_position;\n"),
h+="uniform vec3 light"+r+"_halfWidth;\n",h+="uniform vec3 light"+r+"_halfHeight;\n"),v.castShadows&&!g.noShadow&&(h+="uniform mat4 light"+r+"_shadowMatrix;\n",h=0!==u?h+("uniform vec4 light"+r+"_shadowParams;\n"):h+("uniform vec3 light"+r+"_shadowParams;\n"),h=1===u?h+("uniform samplerCube light"+r+"_shadowMap;\n"):v._isPcf&&l.webgl2?h+("uniform sampler2DShadow light"+r+"_shadowMap;\n"):h+("uniform sampler2D light"+r+"_shadowMap;\n"),x++,w[v._shadowType]=!0,v._isVsm&&(B=!0),v._isPcf&&(l.webgl2||
l.extStandardDerivatives)&&2===u&&(C=!0)),v._cookie)if(v._cookie._cubemap)1===u&&(h+="uniform samplerCube light"+r+"_cookie;\n",h+="uniform float light"+r+"_cookieIntensity;\n",!v.castShadows||g.noShadow)&&(h+="uniform mat4 light"+r+"_shadowMatrix;\n");else if(2===u){h+="uniform sampler2D light"+r+"_cookie;\n";h+="uniform float light"+r+"_cookieIntensity;\n";if(!v.castShadows||g.noShadow)h+="uniform mat4 light"+r+"_shadowMatrix;\n";v._cookieTransform&&(h+="uniform vec4 light"+r+"_cookieMatrix;\n",
h+="uniform vec2 light"+r+"_cookieOffset;\n")}h+="\n";k=!g.hasTangents&&l.extStandardDerivatives?n.TBNderivativePS:g.fastTbn?n.TBNfastPS:n.TBNPS;e&&(g.normalMap||g.clearCoatNormalMap?(h+=g.packedNormal?n.normalXYPS:n.normalXYZPS,g.hasTangents||(r=this._getUvSourceExpression("normalMapTransform","normalMapUv",g),k=k.replace(/\$UV/g,r)),h+=k):g.enableGGXSpecular&&!g.heightMap&&(h+=n.normalVertexPS,h+=n.TBNObjectSpacePS));if(e)if(g.normalMap)g.normalDetail&&(h+=this._addMap("normalDetail","normalDetailMapPS",
g,n)),r=this._getUvSourceExpression("normalMapTransform","normalMapUv",g),h=g.normalizeNormalMap?h+n.normalMapPS.replace(/\$UV/g,r):h+n.normalMapFastPS.replace(/\$UV/g,r);else if(!g.enableGGXSpecular||g.heightMap)h+=n.normalVertexPS;h+=He(g.gamma,n);h+=Ie(g.toneMap,n);h+=kg(g.fog,n);g.useRgbm&&(h+=n.rgbmPS);if(b||g.prefilteredCubemap)h+=g.fixSeams?n.fixCubemapSeamsStretchPS:n.fixCubemapSeamsNonePS;g.useCubeMapRotation&&(h+="#define CUBEMAP_ROTATION\n");g.useRightHandedCubeMap&&(h+="#define RIGHT_HANDED_CUBEMAP\n");
e&&(h+=n.cubeMapRotatePS,h+=0<g.cubeMapProjection?n.cubeMapProjectBoxPS:n.cubeMapProjectNonePS,h+=g.skyboxIntensity?n.envMultiplyPS:n.envConstPS);g.diffuseDetail&&(h+=this._addMap("diffuseDetail","diffuseDetailMapPS",g,n));h+=this._addMap("diffuse","diffusePS",g,n);if(3!==g.blendType||g.alphaTest||g.alphaToCoverage)h+=this._addMap("opacity","opacityPS",g,n);h+=this._addMap("emissive","emissivePS",g,n,g.emissiveFormat);if(d&&g.useSpecular||a)h=g.specularAntialias&&g.normalMap?g.normalizeNormalMap&&
e?h+n.specularAaToksvigPS:h+n.specularAaToksvigFastPS:h+n.specularAaNonePS,r=g.useMetalness?"metalness":"specular",h+=this._addMap(r,r+"PS",g,n),h+=this._addMap("gloss","glossPS",g,n),2===g.fresnelModel&&(h+=n.fresnelSchlickPS);0<g.clearCoat&&(h+=this._addMap("clearCoat","clearCoatPS",g,n),h+=this._addMap("clearCoatGloss","clearCoatGlossPS",g,n),h+=this._addMap("clearCoatNormal","clearCoatNormalPS",g,n));g.heightMap&&(g.normalMap||(r=this._getUvSourceExpression("heightMapTransform","heightMapUv",
g),g.hasTangents||(k=k.replace(/\$UV/g,r)),h+=k),h+=this._addMap("height","parallaxPS",g,n));if(k=g.aoMap||g.aoVertexColor)h+=this._addMap("ao","aoPS",g,n),g.occludeSpecular&&(h=1===g.occludeSpecular?h+(g.occludeSpecularFloat?n.aoSpecOccSimplePS:n.aoSpecOccConstSimplePS):h+(g.occludeSpecularFloat?n.aoSpecOccPS:n.aoSpecOccConstPS));r=g.rgbmReflection?"decodeRGBM":g.hdrReflection?"":"gammaCorrectInput";g.sphereMap?(r=16<l.fragmentUniformsCount?n.reflectionSpherePS:n.reflectionSphereLowPS,r=r.replace(/\$texture2DSAMPLE/g,
g.rgbmReflection?"texture2DRGBM":g.hdrReflection?"texture2D":"texture2DSRGB"),h+=r):b?h=g.prefilteredCubemap?c?h+n.reflectionPrefilteredCubeLodPS.replace(/\$DECODE/g,r):h+n.reflectionPrefilteredCubePS.replace(/\$DECODE/g,r):h+n.reflectionCubePS.replace(/\$textureCubeSAMPLE/g,g.rgbmReflection?"textureCubeRGBM":g.hdrReflection?"textureCube":"textureCubeSRGB"):g.dpAtlas&&(h+=n.reflectionDpAtlasPS.replace(/\$texture2DSAMPLE/g,g.rgbmReflection?"texture2DRGBM":g.hdrReflection?"texture2D":"texture2DSRGB"));
if(b||g.sphereMap||g.dpAtlas)0<g.clearCoat&&(h+=n.reflectionCCPS),g.refraction&&(h+=n.refractionPS);0<x&&(w[0]&&(h+=n.shadowStandardPS),w[4]&&(h+=n.shadowStandardGL2PS),B&&(h+=n.shadowVSM_commonPS,w[1]&&(h+=n.shadowVSM8PS),w[2]&&(h+=l.extTextureHalfFloatLinear?n.shadowEVSMPS.replace(/\$/g,"16"):n.shadowEVSMnPS.replace(/\$/g,"16")),w[3]&&(h+=l.extTextureFloatLinear?n.shadowEVSMPS.replace(/\$/g,"32"):n.shadowEVSMnPS.replace(/\$/g,"32"))),l.webgl2||l.extStandardDerivatives||(h+=n.biasConstPS),h+=n.shadowCoordPS+
n.shadowCommonPS,C&&(h+=n.shadowCoordPerspZbufferPS),0<=t&&(w[0]&&(h+=n.shadowStandardVSPS),w[4]&&(h+=n.shadowStandardGL2VSPS),B&&(w[1]&&(h+=n.shadowVSMVSPS.replace(/\$VSM/g,"VSM8").replace(/\$/g,"8")),w[2]&&(h+=n.shadowVSMVSPS.replace(/\$VSM/g,"VSM16").replace(/\$/g,"16")),w[3]&&(h+=n.shadowVSMVSPS.replace(/\$VSM/g,"VSM32").replace(/\$/g,"32")))));g.enableGGXSpecular&&(h+="uniform float material_anisotropy;\n");d&&(h+=n.lightDiffuseLambertPS,f&&(h+=n.ltc));r=!1;g.useSpecular?(d&&(h+=0===g.shadingModel?
n.lightSpecularPhongPS:g.enableGGXSpecular?n.lightSpecularAnisoGGXPS:n.lightSpecularBlinnPS),g.sphereMap||b||g.dpAtlas||0<g.fresnelModel?h=0<g.fresnelModel?g.conserveEnergy&&!f?h+n.combineDiffuseSpecularPS:h+n.combineDiffuseSpecularNoConservePS:h+n.combineDiffuseSpecularOldPS:g.diffuseMap?h+=n.combineDiffuseSpecularNoReflPS:(h+=n.combineDiffuseSpecularNoReflSeparateAmbientPS,r=!0)):h+=n.combineDiffusePS;0<g.clearCoat&&(h+=n.combineClearCoatPS);u=!0;if(g.lightMap||g.lightVertexColor)h+=this._addMap("light",
g.dirLightMap?"lightmapDirPS":"lightmapSinglePS",g,n,g.lightMapFormat),u=g.lightMapWithoutAmbient;u&&(v=g.rgbmAmbient?"decodeRGBM":g.hdrAmbient?"":"gammaCorrectInput",h=g.ambientSH?h+n.ambientSHPS:g.prefilteredCubemap?c?h+n.ambientPrefilteredCubeLodPS.replace(/\$DECODE/g,v):h+n.ambientPrefilteredCubePS.replace(/\$DECODE/g,v):h+n.ambientConstantPS);g.ambientTint&&!r&&(h+="uniform vec3 material_ambient;\n");g.alphaTest&&(h+=n.alphaTestPS);g.msdf&&(h+=n.msdfPS);e&&(h+=n.viewDirPS,g.useSpecular&&(h+=
g.enableGGXSpecular?n.reflDirAnisoPS:n.reflDirPS));C=B=w=x=c=!1;g.twoSidedLighting&&(h+="uniform float twoSidedLightingNegScaleFactor;\n");h=this._fsAddStartCode(h,l,n,g);e&&(h=g.hasTangents||!l.extStandardDerivatives||g.fastTbn?g.twoSidedLighting?h+"\t dVertexNormalW = gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor;\n":h+"\t dVertexNormalW = vNormalW;\n":g.twoSidedLighting?h+"\t dVertexNormalW = normalize(gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor);\n":
h+"\t dVertexNormalW = normalize(vNormalW);\n",(g.heightMap||g.normalMap)&&g.hasTangents&&(g.twoSidedLighting?(h+="\t dTangentW = gl_FrontFacing ? vTangentW * twoSidedLightingNegScaleFactor : -vTangentW * twoSidedLightingNegScaleFactor;\n",h+="\t dBinormalW = gl_FrontFacing ? vBinormalW * twoSidedLightingNegScaleFactor : -vBinormalW * twoSidedLightingNegScaleFactor;\n"):(h+="\t dTangentW = vTangentW;\n",h+="\t dBinormalW = vBinormalW;\n")));v=!1;3!==g.blendType||g.alphaTest||g.alphaToCoverage?g.heightMap&&
g.opacityMap?v=!0:(h+="\t getOpacity();\n",g.alphaTest&&(h+="\t alphaTest(dAlpha);\n")):h+="\t dAlpha = 1.0;\n";y=!1;if(e){h+="\t getViewDir();\n";if(g.heightMap||g.normalMap||g.clearCoatNormalMap||g.enableGGXSpecular)h+="\t getTBN();\n";g.heightMap&&(h+="\t getParallax();\n");v&&(h+="\t getOpacity();\n",g.alphaTest&&(h+="\t alphaTest(dAlpha);\n"));h+="\t getNormal();\n";g.useSpecular&&(g.enableGGXSpecular&&(h+="\t getGlossiness();\n",y=!0),h+="\t getReflDir();\n")}h+="\t getAlbedo();\n";0<g.clearCoat&&
(h+="\t getClearCoat();\n",h+="\t getClearCoatGlossiness();\n",h+="\t getClearCoatNormal();\n");if(d&&g.useSpecular||a)h+="\t getSpecularity();\n",y||(h+="\t getGlossiness();\n"),f&&(h+="\t #ifdef AREA_LIGHTS\n",h+="\t dSpecularityNoFres = dSpecularity;\n",h+="\t #ifdef CLEARCOAT\n",h+="\t ccSpecularityNoFres = ccSpecularity;\n",h+="\t #endif\n",h+="\t #endif\n"),0<g.fresnelModel&&(h+="\t getFresnel();\n");u&&(h+="\t addAmbient();\n");g.ambientTint&&!r&&(h+="\t dDiffuseLight *= material_ambient;\n");
k&&!g.occludeDirect&&(h+="\t\tapplyAO();\n");if(g.lightMap||g.lightVertexColor)h+="\t addLightMap();\n";if(d||a){if(b||g.sphereMap||g.dpAtlas)0<g.clearCoat&&(h+="\t addReflectionCC();\n"),h+="\t addReflection();\n";f&&(h+="\t ccReflection.rgb *= ccSpecularity;\n",h+="\t dReflection.rgb *= dSpecularity;\n",h+="\t dSpecularLight *= dSpecularity;\n",h+="\t float roughness = max((1.0 - dGlossiness) * (1.0 - dGlossiness), 0.001);\n");e="";for(r=0;r<g.lights.length;r++){v=g.lights[r];u=v._type;a=!1;f&&
v._shape?(y=v._shape,e=this._getLightSourceShapeString(y)):(y=0,e="");0!==y&&(h+="\t calc"+e+"LightValues(light"+r+"_position, light"+r+"_halfWidth, light"+r+"_halfHeight);\n");0===u?(h+="\t dLightDirNormW = light"+r+"_direction;\n",h+="\t dAtten = 1.0;\n"):(v._cookie&&(2!==u||v._cookie._cubemap?1===u&&v._cookie._cubemap&&(a=C=!0):a=C=!0),h+="\t getLightDirPoint(light"+r+"_position);\n",c=!0,a&&(h=2===u?h+("\t dAtten3 = getCookie2D"+(v._cookieFalloff?"":"Clip")+(v._cookieTransform?"Xform":"")+"(light"+
r+"_cookie, light"+r+"_shadowMatrix, light"+r+"_cookieIntensity"+(v._cookieTransform?", light"+r+"_cookieMatrix, light"+r+"_cookieOffset":"")+")."+v._cookieChannel+";\n"):h+("\t dAtten3 = getCookieCube(light"+r+"_cookie, light"+r+"_shadowMatrix, light"+r+"_cookieIntensity)."+v._cookieChannel+";\n")),0===y?0===v._falloffMode?(h+="\t dAtten = getFalloffLinear(light"+r+"_radius);\n",x=!0):(h+="\t dAtten = getFalloffInvSquared(light"+r+"_radius);\n",w=!0):(h+="\t dAtten = getFalloffWindow(light"+r+"_radius);\n",
w=!0),h+="\t if (dAtten > 0.00001) {\n",2!==u||a&&!v._cookieFalloff||(h+="\t\t\t dAtten *= getSpotEffect(light"+r+"_direction, light"+r+"_innerConeAngle, light"+r+"_outerConeAngle);\n",B=!0));h=0!==y?0===u?h+"\t\t\t dAttenD = getLightDiffuse();\n":h+("\t\t\t dAttenD = get"+e+"LightDiffuse() * 16.0;\n"):h+"\t\t\t dAtten *= getLightDiffuse();\n";if(v.castShadows&&!g.noShadow){var D=null;if(1===v._shadowType){D="VSM8";var G="0.0"}else 2===v._shadowType?(D="VSM16",G="5.54"):3===v._shadowType?(D="VSM32",
G=l.textureFloatHighPrecision?"15.0":"5.54"):D=4===v._shadowType?"PCF5x5":"PCF3x3";null!==D&&(1===u?(d="(light"+r+"_shadowMap, light"+r+"_shadowParams);\n",v._normalOffsetBias&&(h+="\t\t\t normalOffsetPointShadow(light"+r+"_shadowParams);\n"),h+="\t\t\t dAtten *= getShadowPoint"+D+d):(t===r?D+="VS":(d="(light"+r+"_shadowMatrix, light"+r+"_shadowParams);\n",h+=this._nonPointShadowMapProjection(l,g.lights[r],d)),2===u&&(D="Spot"+D),h+="\t\t\t dAtten *= getShadow"+D+"(light"+r+"_shadowMap, light"+r+
"_shadowParams"+(v._isVsm?", "+G:"")+");\n"))}h=0!==y?g.conserveEnergy&&g.useSpecular?h+("\t\t\t dDiffuseLight += mix((dAttenD * dAtten) * light"+r+"_color"+(a?" * dAtten3":"")+", vec3(0), dLTCSpecFres);\n"):h+("\t\t\t dDiffuseLight += (dAttenD * dAtten) * light"+r+"_color"+(a?" * dAtten3":"")+";\n"):f&&g.conserveEnergy&&g.useSpecular?h+("\t\t\t dDiffuseLight += mix(dAtten * light"+r+"_color"+(a?" * dAtten3":"")+", vec3(0), dSpecularity);\n"):h+("\t\t\t dDiffuseLight += dAtten * light"+r+"_color"+
(a?" * dAtten3":"")+";\n");0!==y?(0<g.clearCoat&&(h+="\t\t\t ccSpecularLight += ccLTCSpecFres * get"+e+"LightSpecularCC() * dAtten * light"+r+"_color"+(a?" * dAtten3":"")+";\n"),g.useSpecular&&(h+="\t\t\t dSpecularLight += dLTCSpecFres * get"+e+"LightSpecular() * dAtten * light"+r+"_color"+(a?" * dAtten3":"")+";\n")):f?(0<g.clearCoat&&(h+="\t\t\t ccSpecularLight += ccSpecularity * getLightSpecularCC() * dAtten * light"+r+"_color"+(a?" * dAtten3":"")+";\n"),g.useSpecular&&(h+="\t\t\t dSpecularLight += dSpecularity * getLightSpecular() * dAtten * light"+
r+"_color"+(a?" * dAtten3":"")+";\n")):(0<g.clearCoat&&(h+="\t\t\t ccSpecularLight += getLightSpecularCC() * dAtten * light"+r+"_color"+(a?" * dAtten3":"")+";\n"),g.useSpecular&&(h+="\t\t\t dSpecularLight += getLightSpecular() * dAtten * light"+r+"_color"+(a?" * dAtten3":"")+";\n"));0!==u&&(h+="\t }\n");h+="\n"}f&&(0<g.clearCoat&&(h+="\t ccSpecularity = vec3(1);\n"),g.useSpecular&&(h+="\t dSpecularity = vec3(1);\n"));(b||g.sphereMap||g.dpAtlas)&&g.refraction&&(h+="\t addRefraction();\n")}h+="\n";
k&&(g.occludeDirect&&(h+="\t\tapplyAO();\n"),g.occludeSpecular&&(h+="\t\toccludeSpecular();\n"));if(!1===g.opacityFadesSpecular){if(2===g.blendType||4===g.blendType)h+="float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n",h+="#ifdef CLEARCOAT\n specLum += dot(ccSpecularLight * ccSpecularity + ccReflection.rgb * ccReflection.a * ccSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n#endif\n",h+="dAlpha = clamp(dAlpha + gammaCorrectInput(specLum), 0.0, 1.0);\n";
h+="dAlpha *= material_alphaFade;\n"}h+=n.endPS;h=2===g.blendType||6===g.blendType||g.alphaToCoverage?h+n.outputAlphaPS:4===g.blendType?h+n.outputAlphaPremulPS:h+n.outputAlphaOpaquePS;g.msdf&&(h+="\t gl_FragColor = applyMsdf(gl_FragColor);\n");h+="\n";h+="}\n";c&&(h=n.lightDirPointPS+h);x&&(h=n.falloffLinearPS+h);w&&(h=n.falloffInvSquaredPS+h);B&&(h=n.spotPS+h);C&&(h=n.cookiePS+h);l="";h.includes("dReflection")&&(l+="vec4 dReflection;\n");h.includes("dTBN")&&(l+="mat3 dTBN;\n");h.includes("dAlbedo")&&
(l+="vec3 dAlbedo;\n");h.includes("dEmission")&&(l+="vec3 dEmission;\n");h.includes("dNormalW")&&(l+="vec3 dNormalW;\n");h.includes("dVertexNormalW")&&(l+="vec3 dVertexNormalW;\n");h.includes("dTangentW")&&(l+="vec3 dTangentW;\n");h.includes("dBinormalW")&&(l+="vec3 dBinormalW;\n");h.includes("dViewDirW")&&(l+="vec3 dViewDirW;\n");h.includes("dReflDirW")&&(l+="vec3 dReflDirW;\n");h.includes("dDiffuseLight")&&(l+="vec3 dDiffuseLight;\n");h.includes("dSpecularLight")&&(l+="vec3 dSpecularLight;\n");
h.includes("dLightDirNormW")&&(l+="vec3 dLightDirNormW;\n");h.includes("dLightDirW")&&(l+="vec3 dLightDirW;\n");h.includes("dLightPosW")&&(l+="vec3 dLightPosW;\n");h.includes("dShadowCoord")&&(l+="vec3 dShadowCoord;\n");h.includes("dNormalMap")&&(l+="vec3 dNormalMap;\n");h.includes("dSpecularity")&&(l+="vec3 dSpecularity;\n");h.includes("dSpecularityNoFres")&&(l+="vec3 dSpecularityNoFres;\n");h.includes("dUvOffset")&&(l+="vec2 dUvOffset;\n");h.includes("dGlossiness")&&(l+="float dGlossiness;\n");
h.includes("dAlpha")&&(l+="float dAlpha;\n");h.includes("dAtten")&&(l+="float dAtten;\n");h.includes("dAttenD")&&(l+="float dAttenD;\n");h.includes("dAtten3")&&(l+="vec3 dAtten3;\n");h.includes("dAo")&&(l+="float dAo;\n");h.includes("dMsdf")&&(l+="vec4 dMsdf;\n");h.includes("ccReflection")&&(l+="vec4 ccReflection;\n");h.includes("ccNormalW")&&(l+="vec3 ccNormalW;\n");h.includes("ccReflDirW")&&(l+="vec3 ccReflDirW;\n");h.includes("ccSpecularLight")&&(l+="vec3 ccSpecularLight;\n");h.includes("ccSpecularity")&&
(l+="float ccSpecularity;\n");h.includes("ccSpecularityNoFres")&&(l+="float ccSpecularityNoFres;\n");h.includes("ccGlossiness")&&(l+="float ccGlossiness;\n");l=h=m+l+h;return{attributes:p,vshader:z,fshader:l,tag:1}}},lf={begin:Yc,dummyFragmentCode:Di,end:function(){return"}\n"},fogCode:kg,gammaCode:He,precisionCode:wc,skinCode:lg,tonemapCode:Ie,versionCode:xc,basic:{generateKey:function(l){var g="basic";l.fog&&(g+="_fog");l.alphaTest&&(g+="_atst");l.vertexColors&&(g+="_vcol");l.diffuseMap&&(g+="_diff");
return g+="_"+l.pass},createShaderDefinition:function(l,g){var d={vertex_position:"POSITION"};g.skin&&(d.vertex_boneWeights="BLENDWEIGHT",d.vertex_boneIndices="BLENDINDICES");g.vertexColors&&(d.vertex_color="COLOR");g.diffuseMap&&(d.vertex_texCoord0="TEXCOORD0");var b=""+I.transformDeclVS;g.skin?(b+=lg(l),b+=I.transformSkinnedVS):b+=I.transformVS;g.vertexColors&&(b+="attribute vec4 vertex_color;\nvarying vec4 vColor;\n");g.diffuseMap&&(b+="attribute vec2 vertex_texCoord0;\nvarying vec2 vUv0;\n");
2===g.pass&&(b+="varying float vDepth;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n\n#endif\n");b+=Yc();b+="\t gl_Position = getPosition();\n";2===g.pass&&(b+="\t\tvDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n");g.vertexColors&&(b+="\t\tvColor = vertex_color;\n");g.diffuseMap&&(b+="\t\tvUv0 = vertex_texCoord0;\n");var a=b+"}\n";b=wc(l);b=g.vertexColors?b+"varying vec4 vColor;\n":
b+"uniform vec4 uColor;\n";g.diffuseMap&&(b+="varying vec2 vUv0;\nuniform sampler2D texture_diffuseMap;\n");g.fog&&(b+=kg(g.fog));g.alphatest&&(b+=I.alphaTestPS);2===g.pass&&(b=b+"varying float vDepth;\n"+I.packDepthPS);b+=Yc();b=g.vertexColors?b+"\t\tgl_FragColor = vColor;\n":b+"\t\tgl_FragColor = uColor;\n";g.diffuseMap&&(b+="\t\tgl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n");g.alphatest&&(b+="\t alphaTest(gl_FragColor.a);\n");18!==g.pass&&(2===g.pass?b+="\t\tgl_FragColor = packFloat(vDepth);\n":
g.fog&&(b+="\t glFragColor.rgb = addFog(gl_FragColor.rgb);\n"));return{attributes:d,vshader:a,fshader:b+"}\n"}}},particle:{generateKey:function(l){var g="particle",d;for(d in l)l.hasOwnProperty(d)&&(g+=l[d]);return g},_animTex:function(l){l=""+(l.animTexLoop?I.particleAnimFrameLoopVS:I.particleAnimFrameClampVS);return l+=I.particleAnimTexVS},createShaderDefinition:function(l,g){var d="",b=wc(l)+"\n";b+="#define PARTICLE\n";l.webgl2&&(d+="#define GL2\n",b+="#define GL2\n");d+="#define VERTEXSHADER\n";
g.mesh&&(d+="#define USE_MESH\n");g.localSpace&&(d+="#define LOCAL_SPACE\n");g.screenSpace&&(d+="#define SCREEN_SPACE\n");g.animTex&&(d+="\nuniform vec2 animTexTilesParams;\n");g.animTex&&(d+="\nuniform vec4 animTexParams;\n");g.animTex&&(d+="\nuniform vec2 animTexIndexParams;\n");2==g.normal&&(d+="\nvarying mat3 ParticleMat;\n");1==g.normal&&(d+="\nvarying vec3 Normal;\n");g.soft&&(d+="\nvarying float vDepth;\n");l=g.customFace?I.particle_customFaceVS:I.particle_billboardVS;g.useCpu?(0<g.soft&&(d+=
I.screenDepthPS),d+=I.particle_cpuVS,g.localSpace&&(d+=I.particle_localShiftVS),g.animTex&&(d+=this._animTex(g)),g.alignToMotion&&(d+=I.particle_pointAlongVS),d+=g.mesh?I.particle_meshVS:l,1==g.normal&&(d+=I.particle_normalVS),2==g.normal&&(d+=I.particle_TBNVS),0<g.stretch&&(d+=I.particle_stretchVS),d+=I.particle_cpu_endVS):(d+=I.particle_initVS,d+=g.pack8?I.particleInputRgba8PS:I.particleInputFloatPS,0<g.soft&&(d+=I.screenDepthPS),d+=I.particleVS,g.localSpace&&(d+=I.particle_localShiftVS),g.animTex&&
(d+=this._animTex(g)),g.wrap&&(d+=I.particle_wrapVS),g.alignToMotion&&(d+=I.particle_pointAlongVS),d+=g.mesh?I.particle_meshVS:l,1==g.normal&&(d+=I.particle_normalVS),2==g.normal&&(d+=I.particle_TBNVS),0<g.stretch&&(d+=I.particle_stretchVS),d+=I.particle_endVS);0<g.soft&&(d+=I.particle_softVS);d+="}\n";0<g.normal&&(1==g.normal?b+="\nvarying vec3 Normal;\n":2==g.normal&&(b+="\nvarying mat3 ParticleMat;\n"),b+="\nuniform vec3 lightCube[6];\n");g.soft&&(b+="\nvarying float vDepth;\n");0===g.normal&&
"none"===g.fog&&(g.srgb=!1);b+=He(g.gamma);b+=Ie(g.toneMap);b="linear"===g.fog?b+I.fogLinearPS:"exp"===g.fog?b+I.fogExpPS:"exp2"===g.fog?b+I.fogExp2PS:b+I.fogNonePS;2==g.normal&&(b+="\nuniform sampler2D normalMap;\n");0<g.soft&&(b+=I.screenDepthPS);b+=I.particlePS;0<g.soft&&(b+=I.particle_softPS);1==g.normal&&(b+="\nvec3 normal = Normal;\n");2==g.normal&&(b+=I.particle_normalMapPS);0<g.normal&&(b+=g.halflambert?I.particle_halflambertPS:I.particle_lambertPS);0<g.normal&&(b+=I.particle_lightingPS);
2==g.blend?b+=I.particle_blendNormalPS:1==g.blend?b+=I.particle_blendAddPS:5==g.blend&&(b+=I.particle_blendMultiplyPS);b+=I.particle_endPS;return{attributes:Je(d),vshader:d,fshader:b}}},skybox:{generateKey:function(l){return"skybox"+l.rgbm+" "+l.hdr+" "+l.fixSeams+l.toneMapping+l.gamma+l.useIntensity+l.useCubeMapRotation+l.useRightHandedCubeMap+l.mip},createShaderDefinition:function(l,g){l=wc(l);l+=g.useCubeMapRotation?"#define CUBEMAP_ROTATION\n":"";l+=g.useRightHandedCubeMap?"#define RIGHT_HANDED_CUBEMAP\n":
"";l+=g.mip?I.fixCubemapSeamsStretchPS:I.fixCubemapSeamsNonePS;l+=g.useIntensity?I.envMultiplyPS:I.envConstPS;l+=He(g.gamma);l+=Ie(g.toneMapping);l+=I.rgbmPS;l+=I.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,g.rgbm?"textureCubeRGBM":g.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/[128,64,32,16,8,4,2][g.mip]+"");return{attributes:{aPosition:"POSITION"},vshader:I.skyboxVS,fshader:l}}},standard:Vg},mf=null,Pa=null,X=function(){function l(d,b){this.device=d;this.name=null;this._height=
this._width=4;this._depth=1;this._format=7;this.type="default";this.fixCubemapSeams=this._volume=this._cubemap=!1;this._flipY=!0;this._isRenderTarget=this._premultiplyAlpha=!1;this._mipmaps=!0;this._minFilter=5;this._anisotropy=this._magFilter=1;this._addressW=this._addressV=this._addressU=0;this._compareOnRead=!1;this._compareFunc=1;void 0!==b&&(void 0!==b.name&&(this.name=b.name),this._width=void 0!==b.width?b.width:this._width,this._height=void 0!==b.height?b.height:this._height,this._format=void 0!==
b.format?b.format:this._format,b.hasOwnProperty("type")?this.type=b.type:b.hasOwnProperty("rgbm")?this.type=b.rgbm?"rgbm":"default":b.hasOwnProperty("swizzleGGGR")&&(this.type=b.swizzleGGGR?"swizzleGGGR":"default"),this._mipmaps=void 0!==b.mipmaps?b.mipmaps:void 0!==b.autoMipmap?b.autoMipmap:this._mipmaps,this._levels=b.levels,this._cubemap=void 0!==b.cubemap?b.cubemap:this._cubemap,this.fixCubemapSeams=void 0!==b.fixCubemapSeams?b.fixCubemapSeams:this.fixCubemapSeams,this._minFilter=void 0!==b.minFilter?
b.minFilter:this._minFilter,this._magFilter=void 0!==b.magFilter?b.magFilter:this._magFilter,this._anisotropy=void 0!==b.anisotropy?b.anisotropy:this._anisotropy,this._addressU=void 0!==b.addressU?b.addressU:this._addressU,this._addressV=void 0!==b.addressV?b.addressV:this._addressV,this._compareOnRead=void 0!==b.compareOnRead?b.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==b._compareFunc?b._compareFunc:this._compareFunc,this._flipY=void 0!==b.flipY?b.flipY:this._flipY,this._premultiplyAlpha=
void 0!==b.premultiplyAlpha?b.premultiplyAlpha:this._premultiplyAlpha,d.webgl2&&(this._depth=void 0!==b.depth?b.depth:this._depth,this._volume=void 0!==b.volume?b.volume:this._volume,this._addressW=void 0!==b.addressW?b.addressW:this._addressW));this._compressed=8===this._format||9===this._format||10===this._format||21<=this._format;this._invalid=!1;this._lockedLevel=-1;this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]);this.dirtyAll();this._gpuSize=0}l.calcGpuSize=
function(d,b,a,c,e,f){mf||(mf=[1,1,2,2,2,2,4,4,,,,8,8,16,16,4,4,4,4,4,4]);Pa||(Pa=[],Pa[21]=8,Pa[22]=8,Pa[24]=8,Pa[25]=8,Pa[26]=8,Pa[27]=8,Pa[8]=8,Pa[29]=8,Pa[23]=16,Pa[9]=16,Pa[10]=16,Pa[28]=16,Pa[30]=16);for(var h=mf.hasOwnProperty(c)?mf[c]:0,k=Pa.hasOwnProperty(c)?Pa[c]:0,m=0;;){if(0<h)m+=d*b*a*h;else{var n=Math.floor((d+3)/4),p=Math.floor((b+3)/4),t=Math.floor((a+3)/4);if(24===c||25===c)n=Math.floor(n/2,1);m+=n*p*t*k}if(!e||1===d&&1===b&&1===a)break;d=Math.max(Math.floor(d/2),1);b=Math.max(Math.floor(b/
2),1);a=Math.max(Math.floor(a/2),1)}return m*(f?6:1)};var g=l.prototype;g.destroy=function(){this.device&&this.device.destroyTexture(this);this.device=null;this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]};g.dirtyAll=function(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0];this._needsUpload=!0;this._needsMipmapsUpload=this._mipmaps;this._mipmapsUploaded=!1;this._parameterFlags=255};g.lock=function(d){void 0===d&&(d={});void 0===d.level&&(d.level=0);void 0===d.face&&
(d.face=0);void 0===d.mode&&(d.mode=2);this._lockedLevel=d.level;if(null===this._levels[d.level])switch(this._format){case 0:case 1:this._levels[d.level]=new Uint8Array(this._width*this._height*this._depth);break;case 2:this._levels[d.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case 3:case 4:case 5:this._levels[d.level]=new Uint16Array(this._width*this._height*this._depth);break;case 6:this._levels[d.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case 7:this._levels[d.level]=
new Uint8Array(this._width*this._height*this._depth*4);break;case 8:this._levels[d.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case 9:case 10:this._levels[d.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case 11:this._levels[d.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case 13:this._levels[d.level]=new Float32Array(this._width*this._height*this._depth*3);
break;case 12:this._levels[d.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case 14:this._levels[d.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[d.level]};g.setSource=function(d,b){void 0===b&&(b=0);var a,c=!1;if(this._cubemap){if(d[0]){var e=d[0].width||0;var f=d[0].height||0;for(a=0;6>a;a++){var h=d[a];if(!h||h.width!==e||h.height!==f||!this.device._isBrowserInterface(h)){c=!0;break}}}else c=!0;if(!c)for(a=0;6>a;a++)this._levels[b][a]!==
d[a]&&(this._levelsUpdated[b][a]=!0)}else this.device._isBrowserInterface(d)||(c=!0),c||(d!==this._levels[b]&&(this._levelsUpdated[b]=!0),e=d.width,f=d.height);if(c)if(this._height=this._width=4,this._cubemap)for(a=0;6>a;a++)this._levels[b][a]=null,this._levelsUpdated[b][a]=!0;else this._levels[b]=null,this._levelsUpdated[b]=!0;else 0===b&&(this._width=e,this._height=f),this._levels[b]=d;this._invalid===c&&c||(this._invalid=c,this.upload())};g.getSource=function(d){void 0===d&&(d=0);return this._levels[d]};
g.unlock=function(){this.upload();this._lockedLevel=-1};g.upload=function(){this._needsUpload=!0;this._needsMipmapsUpload=this._mipmaps};g.getDds=function(){for(var d=128,b=0,a,c;this._levels[b];){if(this.cubemap)for(c=0;6>c;c++){if(!this._levels[b][c])return;a=this._levels[b][c].length;if(!a)return;d+=a}else{a=this._levels[b].length;if(!a)return;d+=a}d+=this._levels[b].length;b++}d=new ArrayBuffer(d);c=new Uint32Array(d,0,32);b=528391;1<this._levels.length&&(b|=131072);a=4096;1<this._levels.length&&
(a|=4194304);if(1<this._levels.length||this.cubemap)a|=8;var e=this.cubemap?65024:0;c[0]=542327876;c[1]=124;c[2]=b;c[3]=this.height;c[4]=this.width;c[5]=this.width*this.height*4;c[6]=0;c[7]=this._levels.length;for(b=0;11>b;b++)c[8+b]=0;c[19]=32;c[20]=65;c[21]=0;c[22]=32;c[23]=16711680;c[24]=65280;c[25]=255;c[26]=4278190080;c[27]=a;c[28]=e;c[29]=0;c[30]=0;c[31]=0;e=128;if(this.cubemap)for(c=0;6>c;c++)for(b=0;b<this._levels.length;b++){var f=this._levels[b][c];var h=new Uint8Array(d,e,f.length);for(a=
0;a<f.length;a++)h[a]=f[a];e+=f.length}else for(b=0;b<this._levels.length;b++){f=this._levels[b];h=new Uint8Array(d,e,f.length);for(a=0;a<f.length;a++)h[a]=f[a];e+=f.length}return d};N(l,[{key:"minFilter",get:function(){return this._minFilter},set:function(d){this._minFilter!==d&&(this._minFilter=d,this._parameterFlags|=1)}},{key:"magFilter",get:function(){return this._magFilter},set:function(d){this._magFilter!==d&&(this._magFilter=d,this._parameterFlags|=2)}},{key:"addressU",get:function(){return this._addressU},
set:function(d){this._addressU!==d&&(this._addressU=d,this._parameterFlags|=4)}},{key:"addressV",get:function(){return this._addressV},set:function(d){this._addressV!==d&&(this._addressV=d,this._parameterFlags|=8)}},{key:"addressW",get:function(){return this._addressW},set:function(d){this.device.webgl2&&this._volume&&d!==this._addressW&&(this._addressW=d,this._parameterFlags|=16)}},{key:"compareOnRead",get:function(){return this._compareOnRead},set:function(d){this._compareOnRead!==d&&(this._compareOnRead=
d,this._parameterFlags|=32)}},{key:"compareFunc",get:function(){return this._compareFunc},set:function(d){this._compareFunc!==d&&(this._compareFunc=d,this._parameterFlags|=64)}},{key:"anisotropy",get:function(){return this._anisotropy},set:function(d){this._anisotropy!==d&&(this._anisotropy=d,this._parameterFlags|=128)}},{key:"autoMipmap",get:function(){return this._mipmaps},set:function(d){this._mipmaps=d}},{key:"mipmaps",get:function(){return this._mipmaps},set:function(d){this._mipmaps!==d&&(this._mipmaps=
d,this._minFilterDirty=!0,d&&(this._needsMipmapsUpload=!0))}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"format",get:function(){return this._format}},{key:"cubemap",get:function(){return this._cubemap}},{key:"gpuSize",get:function(){return l.calcGpuSize(this._width,this._height,this._depth,this._format,this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length),this._cubemap)}},
{key:"volume",get:function(){return this._volume}},{key:"flipY",get:function(){return this._flipY},set:function(d){this._flipY!==d&&(this._flipY=d,this._needsUpload=!0)}},{key:"premultiplyAlpha",get:function(){return this._premultiplyAlpha},set:function(d){this._premultiplyAlpha!==d&&(this._premultiplyAlpha=d,this._needsUpload=!0)}},{key:"pot",get:function(){return R.powerOfTwo(this._width)&&R.powerOfTwo(this._height)}}]);return l}(),jo=0,Fa=function(){function l(){this.name="Untitled";this.id=jo++;
this._shader=null;this.variants={};this.parameters={};this.alphaTest=0;this.blend=this.alphaToCoverage=!1;this.blendSrc=1;this.blendEquation=this.blendDst=0;this.separateAlphaBlend=!1;this.blendSrcAlpha=1;this.blendAlphaEquation=this.blendDstAlpha=0;this.cull=1;this.depthWrite=this.depthTest=!0;this.stencilBack=this.stencilFront=null;this.slopeDepthBias=this.depthBias=0;this.alphaWrite=this.blueWrite=this.greenWrite=this.redWrite=!0;this.meshInstances=[];this._shaderVersion=0;this._scene=null;this._dirtyBlend=
!1;this.dirty=!0}var g=l.prototype;g._cloneInternal=function(d){d.name=this.name;d.shader=this.shader;d.alphaTest=this.alphaTest;d.alphaToCoverage=this.alphaToCoverage;d.blend=this.blend;d.blendSrc=this.blendSrc;d.blendDst=this.blendDst;d.blendEquation=this.blendEquation;d.separateAlphaBlend=this.separateAlphaBlend;d.blendSrcAlpha=this.blendSrcAlpha;d.blendDstAlpha=this.blendDstAlpha;d.blendAlphaEquation=this.blendAlphaEquation;d.cull=this.cull;d.depthTest=this.depthTest;d.depthWrite=this.depthWrite;
d.depthBias=this.depthBias;d.slopeDepthBias=this.slopeDepthBias;this.stencilFront&&(d.stencilFront=this.stencilFront.clone());this.stencilBack&&(d.stencilBack=this.stencilFront===this.stencilBack?d.stencilFront:this.stencilBack.clone());d.redWrite=this.redWrite;d.greenWrite=this.greenWrite;d.blueWrite=this.blueWrite;d.alphaWrite=this.alphaWrite};g.clone=function(){var d=new l;this._cloneInternal(d);return d};g._updateMeshInstanceKeys=function(){var d,b=this.meshInstances;for(d=0;d<b.length;d++)b[d].updateKey()};
g.updateUniforms=function(){};g.updateShader=function(d,b,a){};g.update=function(){this.dirty=!0;this._shader&&(this._shader.failed=!1)};g.clearParameters=function(){this.parameters={}};g.getParameters=function(){return this.parameters};g.clearVariants=function(){this.variants={};for(var d,b=0;b<this.meshInstances.length;b++){var a=this.meshInstances[b];for(d=0;d<a._shader.length;d++)a._shader[d]=null}};g.getParameter=function(d){return this.parameters[d]};g.setParameter=function(d,b){if(void 0===
b&&"object"===typeof d){b=d;if(b.length){for(d=0;d<b.length;d++)this.setParameter(b[d]);return}d=b.name;b=b.value}var a=this.parameters[d];a?a.data=b:this.parameters[d]={scopeId:null,data:b}};g.deleteParameter=function(d){this.parameters[d]&&delete this.parameters[d]};g.setParameters=function(d,b){var a=this.parameters;void 0===b&&(b=a);for(var c in b)if(b=a[c])b.scopeId||(b.scopeId=d.scope.resolve(c)),b.scopeId.setValue(b.data)};g.destroy=function(){this.variants={};this.shader=null;for(var d,b,
a=0;a<this.meshInstances.length;a++){d=this.meshInstances[a];for(b=0;b<d._shader.length;b++)d._shader[b]=null;d._material=null;b=l.defaultMaterial;this!==b&&(d.material=b)}};N(l,[{key:"shader",get:function(){return this._shader},set:function(d){this._shader=d}},{key:"blendType",get:function(){if(!this.blend&&1===this.blendSrc&&0===this.blendDst&&0===this.blendEquation)return 3;if(!this.blend||6!==this.blendSrc||8!==this.blendDst||0!==this.blendEquation){if(this.blend&&1===this.blendSrc&&1===this.blendDst&&
0===this.blendEquation)return 1;if(this.blend&&6===this.blendSrc&&1===this.blendDst&&0===this.blendEquation)return 6;if(this.blend&&4===this.blendSrc&&2===this.blendDst&&0===this.blendEquation)return 7;if(this.blend&&5===this.blendSrc&&1===this.blendDst&&0===this.blendEquation)return 8;if(this.blend&&1===this.blendSrc&&1===this.blendDst&&3===this.blendEquation)return 9;if(this.blend&&1===this.blendSrc&&1===this.blendDst&&4===this.blendEquation)return 10;if(this.blend&&4===this.blendSrc&&0===this.blendDst&&
0===this.blendEquation)return 5;if(this.blend&&1===this.blendSrc&&8===this.blendDst&&0===this.blendEquation)return 4}return 2},set:function(d){var b=this.blend;switch(d){case 3:this.blend=!1;this.blendSrc=1;this.blendEquation=this.blendDst=0;break;case 2:this.blend=!0;this.blendSrc=6;this.blendDst=8;this.blendEquation=0;break;case 4:this.blend=!0;this.blendSrc=1;this.blendDst=8;this.blendEquation=0;break;case 1:this.blend=!0;this.blendDst=this.blendSrc=1;this.blendEquation=0;break;case 6:this.blend=
!0;this.blendSrc=6;this.blendDst=1;this.blendEquation=0;break;case 7:this.blend=!0;this.blendSrc=4;this.blendDst=2;this.blendEquation=0;break;case 8:this.blend=!0;this.blendSrc=5;this.blendDst=1;this.blendEquation=0;break;case 5:this.blend=!0;this.blendSrc=4;this.blendEquation=this.blendDst=0;break;case 9:this.blend=!0;this.blendDst=this.blendSrc=1;this.blendEquation=3;break;case 10:this.blend=!0,this.blendDst=this.blendSrc=1,this.blendEquation=4}b!==this.blend&&(this._scene?this._scene.layers._dirtyBlend=
!0:this._dirtyBlend=!0);this._updateMeshInstanceKeys()}}]);return l}();Fa.defaultMaterial=null;jb.prototype.updateMinRef=function(l,g,d,b,a,c,e,f,h){this._updateSharedOptions(l,b,a,e);this._updateMinOptions(l,b);this._updateUVOptions(l,b,a,!0)};jb.prototype.updateRef=function(l,g,d,b,a,c,e,f,h){this._updateSharedOptions(l,b,a,e);l.useTexCubeLod=g.useTexCubeLod;this._updateEnvOptions(l,b,d,h);this._updateMaterialOptions(l,b);1===e&&(l.gamma&&(l.gamma=3),l.toneMap=0);l.hasTangents=a&&b.normalMap&&0!==
(a&512);this._updateLightOptions(l,b,a,f,c);this._updateUVOptions(l,b,a,!1);l.clearCoat=b.clearCoat;l.clearCoatGlossiness=b.clearCoatGlossiness};jb.prototype._updateSharedOptions=function(l,g,d,b){l.pass=b;l.alphaTest=0<g.alphaTest;l.forceFragmentPrecision=g.forceFragmentPrecision||"";l.chunks=g.chunks||"";l.blendType=g.blendType;l.forceUv1=g.forceUv1;l.screenSpace=d&&0!==(d&256);l.skin=d&&0!==(d&2);l.useInstancing=d&&0!==(d&32);l.useMorphPosition=d&&0!==(d&1024);l.useMorphNormal=d&&0!==(d&2048);
l.useMorphTextureBased=d&&0!==(d&4096);l.nineSlicedMode=g.nineSlicedMode||0};jb.prototype._updateUVOptions=function(l,g,d,b){var a=!1,c=!1,e=!1;d&&(a=0!==(d&4),c=0!==(d&8),e=0!==(d&16));l.vertexColors=!1;this._mapXForms=[];for(var f in Fb)this._updateTexOptions(l,g,f,a,c,e,b);this._mapXForms=null};jb.prototype._updateMinOptions=function(l,g){l.opacityTint=1!==g.opacity&&3!==g.blendType;l.lights=[]};jb.prototype._updateMaterialOptions=function(l,g){var d=1===g.diffuse.r&&1===g.diffuse.g&&1===g.diffuse.b||
!g.diffuseTint&&(g.diffuseMap||g.diffuseVertexColor)?0:3,b=!1,a=(g.useMetalness?!0:!!g.specularMap)||!!g.sphereMap||!!g.cubeMap||!!g.dpAtlas;(a=(a=(a=a||(g.useMetalness?!0:!(0===g.specular.r&&0===g.specular.g&&0===g.specular.b)))||g.enableGGXSpecular)||0<g.clearCoat)&&(!g.specularTint&&(g.specularMap||g.specularVertexColor)||g.useMetalness||(b=1!==g.specular.r||1!==g.specular.g||1!==g.specular.b));var c=g.emissiveMap?0:3;c||(c=(c=(1!==g.emissive.r||1!==g.emissive.g||1!==g.emissive.b||1!==g.emissiveIntensity)&&
g.emissiveTint)?3:1!==g.emissiveIntensity?1:0);var e=g.normalMap?10===g.normalMap.format||"swizzleGGGR"===g.normalMap.type:!1;l.opacityTint=1!==g.opacity&&3!==g.blendType?1:0;l.blendMapsWithColors=!0;l.ambientTint=g.ambientTint;l.diffuseTint=d;l.specularTint=b?3:0;l.metalnessTint=g.useMetalness&&1>g.metalness?1:0;l.glossTint=1;l.emissiveTint=c;l.alphaToCoverage=g.alphaToCoverage;l.normalizeNormalMap=g.normalizeNormalMap;l.sphereMap=!!g.sphereMap;l.cubeMap=!!g.cubeMap;l.dpAtlas=!!g.dpAtlas;l.ambientSH=
!!g.ambientSH;l.useSpecular=a;l.emissiveFormat=g.emissiveMap?"rgbm"===g.emissiveMap.type?1:14===g.emissiveMap.format?2:0:null;l.lightMapFormat=g.lightMap?"rgbm"===g.lightMap.type?1:14===g.lightMap.format?2:0:null;l.specularAntialias=g.specularAntialias&&!!g.normalMap&&!!g.normalMap.mipmaps&&!e;l.conserveEnergy=g.conserveEnergy;l.opacityFadesSpecular=g.opacityFadesSpecular;l.alphaFade=g.alphaFade;l.occludeSpecular=g.occludeSpecular;l.occludeSpecularFloat=1!==g.occludeSpecularIntensity;l.occludeDirect=
g.occludeDirect;l.shadingModel=g.shadingModel;l.fresnelModel=g.fresnelModel;l.packedNormal=e;l.fastTbn=g.fastTbn;l.cubeMapProjection=g.cubeMapProjection;l.customFragmentShader=g.customFragmentShader;l.refraction=!!g.refraction;l.useMetalness=g.useMetalness;l.enableGGXSpecular=g.enableGGXSpecular;l.msdf=!!g.msdfMap;l.twoSidedLighting=g.twoSidedLighting;l.pixelSnap=g.pixelSnap;l.aoMapUv=g.aoUvSet;l.diffuseDetail=!!g.diffuseMap;l.normalDetail=!!g.normalMap;l.diffuseDetailMode=g.diffuseDetailMode;l.detailModes=
!!l.diffuseDetail;l.clearCoatTint=1!==g.clearCoat?1:0;l.clearCoatGlossTint=1!==g.clearCoatGlossiness?1:0};jb.prototype._updateEnvOptions=function(l,g,d,b){var a=b&&"rgbm"===b.type||g.cubeMap&&"rgbm"===g.cubeMap.type||g.dpAtlas&&"rgbm"===g.dpAtlas.type,c=b&&("rgbm"===b.type||14===b.format)||g.cubeMap&&("rgbm"===g.cubeMap.type||14===g.cubeMap.format)||g.dpAtlas&&("rgbm"===g.dpAtlas.type||14===g.dpAtlas.format),e=b&&!g.cubeMap&&!g.sphereMap&&!g.dpAtlas&&"rgbm"===b.type||g.cubeMap&&"rgbm"===g.cubeMap.type||
g.sphereMap&&"rgbm"===g.sphereMap.type||g.dpAtlas&&"rgbm"===g.dpAtlas.type,f=(!b||g.cubeMap||g.sphereMap||g.dpAtlas?!1:"rgbm"===b.type||14===b.format)||g.cubeMap&&("rgbm"===g.cubeMap.type||14===g.cubeMap.format)||g.sphereMap&&("rgbm"===g.sphereMap.type||14===g.sphereMap.format)||g.dpAtlas&&("rgbm"===g.dpAtlas.type||14===g.dpAtlas.format),h;g.useSkybox&&d._skyboxPrefiltered&&(h=d._skyboxPrefiltered[0]);l.fog=g.useFog?d.fog:"none";l.gamma=g.useGammaTonemap?d.gammaCorrection:0;l.toneMap=g.useGammaTonemap?
d.toneMapping:-1;l.rgbmAmbient=a;l.hdrAmbient=c;l.rgbmReflection=e;l.hdrReflection=f;l.useRgbm=e||a||g.emissiveMap&&"rgbm"===g.emissiveMap.type||g.lightMap&&"rgbm"===g.lightMap.type;l.fixSeams=b?b.fixCubemapSeams:g.cubeMap?g.cubeMap.fixCubemapSeams:!1;l.prefilteredCubemap=!!b;l.skyboxIntensity=b&&h&&b===h&&1!==d.skyboxIntensity;l.useCubeMapRotation=g.useSkybox&&d&&d.skyboxRotation&&!d.skyboxRotation.equals(ea.IDENTITY);l.useRightHandedCubeMap=g.cubeMap?g.cubeMap._isRenderTarget:g.useSkybox&&d&&d._skyboxIsRenderTarget};
jb.prototype._updateLightOptions=function(l,g,d,b,a){l.lightMap=!1;l.lightMapChannel="";l.lightMapUv=0;l.lightMapTransform=0;l.lightMapWithoutAmbient=!1;l.dirLightMap=!1;d&&(l.noShadow=0!==(d&1),0!==(d&64)&&(l.lightMapFormat=1,l.lightMap=!0,l.lightMapChannel="rgb",l.lightMapUv=1,l.lightMapTransform=0,l.lightMapWithoutAmbient=!g.lightMap,l.useRgbm=!0,0!==(d&128)&&(l.dirLightMap=!0)));g.useLighting?(g=[],d=d?d>>16:1,b&&(this._collectLights(0,b[0],g,d),this._collectLights(1,b[1],g,d,a),this._collectLights(2,
b[2],g,d,a)),l.lights=g):l.lights=[];0===l.lights.length&&(l.noShadow=!0)};jb.prototype._updateTexOptions=function(l,g,d,b,a,c,e){var f=d+"Map",h=d+"VertexColor",k=d+"VertexColorChannel",m=f+"Channel",n=f+"Transform",p=f+"Uv";"light"!==d&&(l[f]=!1,l[m]="",l[n]=0,l[p]=0);l[h]=!1;l[k]="";var t="opacity"===d;if(t&&3===g.blendType&&0===g.alphaTest&&!g.alphaToCoverage)return l;if(!e||t)"height"!==d&&g[h]&&c&&(l[h]=g[h],l[k]=g[k],l.vertexColors=!0),g[f]&&(d=!0,0!==g[p]||b||(d=!1),1!==g[p]||a||(d=!1),d&&
(l[f]=!!g[f],l[n]=this._getMapTransformID(g[n],g[p]),l[m]=g[m],l[p]=g[p]))};jb.prototype._collectLights=function(l,g,d,b,a){var c;for(c=0;c<g.length;c++){var e=g[c];e.enabled&&e.mask&b&&(0===l||!e.isStatic)&&d.push(e)}if(a)for(c=0;c<a.length;c++)e=a[c],e._type===l&&d.push(e)};jb.prototype._getMapTransformID=function(l,g){if(!l)return 0;this._mapXForms[g]||(this._mapXForms[g]=[]);var d;for(d=0;d<this._mapXForms[g].length&&this._mapXForms[g][d][0]==l.x&&this._mapXForms[g][d][1]==l.y&&this._mapXForms[g][d][2]==
l.z&&this._mapXForms[g][d][3]==l.w;)return d+1;d=this._mapXForms[g].length;this._mapXForms[g][d]=[];this._mapXForms[g][d][0]=l.x;this._mapXForms[g][d][1]=l.y;this._mapXForms[g][d][2]=l.z;this._mapXForms[g][d][3]=l.w;return d+1};var Cj=function(){function l(){this._refCount=0}var g=l.prototype;g.incRefCount=function(){this._refCount++};g.decRefCount=function(){this._refCount--};g.getRefCount=function(){return this._refCount};return l}(),Db=function(){function l(d,b,a,c,e){void 0===c&&(c=0);this.device=
d;this.format=b;this.numIndices=a;this.usage=c;a=this.device.gl;if(0===b){var f=1;this.glFormat=a.UNSIGNED_BYTE}else 1===b?(f=2,this.glFormat=a.UNSIGNED_SHORT):2===b&&(f=4,this.glFormat=a.UNSIGNED_INT);this.bytesPerIndex=f;this.numBytes=this.numIndices*f;e?this.setData(e):this.storage=new ArrayBuffer(this.numBytes);d._vram.ib+=this.numBytes;this.device.buffers.push(this)}var g=l.prototype;g.destroy=function(){var d=this.device,b=d.buffers.indexOf(this);-1!==b&&d.buffers.splice(b,1);this.bufferId&&
(this.device.gl.deleteBuffer(this.bufferId),this.device._vram.ib-=this.storage.byteLength,this.bufferId=null,this.device.indexBuffer===this&&(this.device.indexBuffer=null))};g.loseContext=function(){this.bufferId=void 0};g.getFormat=function(){return this.format};g.getNumIndices=function(){return this.numIndices};g.lock=function(){return this.storage};g.unlock=function(){var d=this.device.gl;this.bufferId||(this.bufferId=d.createBuffer());switch(this.usage){case 0:var b=d.STATIC_DRAW;break;case 1:b=
d.DYNAMIC_DRAW;break;case 2:b=d.STREAM_DRAW;break;case 3:b=this.device.webgl2?d.DYNAMIC_COPY:d.STATIC_DRAW}d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,this.bufferId);d.bufferData(d.ELEMENT_ARRAY_BUFFER,this.storage,b)};g.setData=function(d){if(d.byteLength!==this.numBytes)return!1;this.storage=d;this.unlock();return!0};g._lockTypedArray=function(){var d=this.lock();return 2===this.format?new Uint32Array(d):1===this.format?new Uint16Array(d):new Uint8Array(d)};g.writeData=function(d,b){var a=this._lockTypedArray();
if(d.length>b)if(ArrayBuffer.isView(d))d=d.subarray(0,b),a.set(d);else{var c;for(c=0;c<b;c++)a[c]=d[c]}else a.set(d);this.unlock()};g.readData=function(d){var b=this._lockTypedArray(),a=this.numIndices;if(ArrayBuffer.isView(d))d.set(b);else{d.length=0;var c;for(c=0;c<a;c++)d[c]=b[c]}return a};return l}(),ko=0,Hb=function(){function l(){this.initDefaults()}var g=l.prototype;g.initDefaults=function(){this.recreate=!1;this.indexCount=this.vertexCount=this.maxIndices=this.maxVertices=this.indicesUsage=
this.verticesUsage=0;this.indexStreamUpdated=this.vertexStreamsUpdated=!1;this.vertexStreamDictionary={};this.indices=null};g._validateVertexCount=function(d,b){};g._changeVertexCount=function(d,b){this.vertexCount?this._validateVertexCount(d,b):this.vertexCount=d};return l}();Hb.DEFAULT_COMPONENTS_POSITION=3;Hb.DEFAULT_COMPONENTS_NORMAL=3;Hb.DEFAULT_COMPONENTS_UV=2;Hb.DEFAULT_COMPONENTS_COLORS=4;var lo=function(l,g,d,b){this.data=l;this.componentCount=g;this.dataType=d;this.dataTypeNormalize=b},
bb=function(l){function g(b){var a=l.call(this)||this;a.id=ko++;a.device=b||qa.getApplication().graphicsDevice;a.vertexBuffer=null;a.indexBuffer=[null];a.primitive=[{type:0,base:0,count:0}];a.skin=null;a.morph=null;a._geometryData=null;a._aabb=new la;a.boneAabb=null;return a}K(g,l);var d=g.prototype;d.destroy=function(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);var b,a;for(b=0;b<this.indexBuffer.length;b++)(a=this.indexBuffer[b])&&a.destroy();this.indexBuffer.length=
0;this._geometryData=null};d._initBoneAabbs=function(b){this.boneAabb=[];this.boneUsed=[];var a=this.vertexBuffer.numVertices,c,e,f=[],h=[],k=this.boneUsed,m=this.skin.boneNames.length,n,p,t;for(c=0;c<m;c++)f[c]=new A(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),h[c]=new A(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);var r=new vb(this.vertexBuffer),u=r.element.POSITION,v=r.element.BLENDWEIGHT,w=r.element.BLENDINDICES;for(c=0;c<a;c++){for(e=0;4>e;e++){var y=v.array[v.index+e];if(0<
y){var x=w.array[w.index+e];k[x]=!0;var z=u.array[u.index];var B=u.array[u.index+1];var C=u.array[u.index+2];y=h[x];x=f[x];x.x>z&&(x.x=z);x.y>B&&(x.y=B);x.z>C&&(x.z=C);y.x<z&&(y.x=z);y.y<B&&(y.y=B);y.z<C&&(y.z=C);if(b){z=n=z;B=p=B;var D=t=C;for(C=0;C<b.length;C++){var G=b[C];var J=G.deltaPositions[3*c];var E=G.deltaPositions[3*c+1];G=G.deltaPositions[3*c+2];0>J?z+=J:n+=J;0>E?B+=E:p+=E;0>G?D+=G:t+=G}x.x>z&&(x.x=z);x.y>B&&(x.y=B);x.z>D&&(x.z=D);y.x<n&&(y.x=n);y.y<p&&(y.y=p);y.z<t&&(y.z=t)}}}r.next()}for(c=
0;c<m;c++)b=new la,b.setMinMax(f[c],h[c]),this.boneAabb.push(b)};d._initGeometryData=function(){this._geometryData||(this._geometryData=new Hb,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),0<this.indexBuffer.length&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))};d.clear=function(b,a,c,e){void 0===c&&(c=
0);void 0===e&&(e=0);this._initGeometryData();this._geometryData.initDefaults();this._geometryData.recreate=!0;this._geometryData.maxVertices=c;this._geometryData.maxIndices=e;this._geometryData.verticesUsage=b?0:1;this._geometryData.indicesUsage=a?0:1};d.setVertexStream=function(b,a,c,e,f,h){void 0===f&&(f=6);void 0===h&&(h=!1);this._initGeometryData();this._geometryData._changeVertexCount(e||a.length/c,b);this._geometryData.vertexStreamsUpdated=!0;this._geometryData.vertexStreamDictionary[b]=new lo(a,
c,f,h)};d.getVertexStream=function(b,a){var c=0,e=!1;if(this._geometryData){var f=this._geometryData.vertexStreamDictionary[b];f&&(e=!0,c=this._geometryData.vertexCount,ArrayBuffer.isView(a)?a.set(f.data):(a.length=0,a.push(f.data)))}e||this.vertexBuffer&&(c=(new vb(this.vertexBuffer)).readData(b,a));return c};d.setPositions=function(b,a,c){void 0===a&&(a=Hb.DEFAULT_COMPONENTS_POSITION);this.setVertexStream("POSITION",b,a,c,6,!1)};d.setNormals=function(b,a,c){void 0===a&&(a=Hb.DEFAULT_COMPONENTS_NORMAL);
this.setVertexStream("NORMAL",b,a,c,6,!1)};d.setUvs=function(b,a,c,e){void 0===c&&(c=Hb.DEFAULT_COMPONENTS_UV);this.setVertexStream("TEXCOORD"+b,a,c,e,6,!1)};d.setColors=function(b,a,c){void 0===a&&(a=Hb.DEFAULT_COMPONENTS_COLORS);this.setVertexStream("COLOR",b,a,c,6,!1)};d.setColors32=function(b,a){this.setVertexStream("COLOR",b,Hb.DEFAULT_COMPONENTS_COLORS,a,1,!0)};d.setIndices=function(b,a){this._initGeometryData();this._geometryData.indexStreamUpdated=!0;this._geometryData.indices=b;this._geometryData.indexCount=
a||b.length};d.getPositions=function(b){return this.getVertexStream("POSITION",b)};d.getNormals=function(b){return this.getVertexStream("NORMAL",b)};d.getUvs=function(b,a){return this.getVertexStream("TEXCOORD"+b,a)};d.getColors=function(b){return this.getVertexStream("COLOR",b)};d.getIndices=function(b){var a=0;if(this._geometryData&&this._geometryData.indices){var c=this._geometryData.indices;a=this._geometryData.indexCount;ArrayBuffer.isView(b)?b.set(c):(b.length=0,b.push(c))}else 0<this.indexBuffer.length&&
this.indexBuffer[0]&&(a=this.indexBuffer[0].readData(b));return a};d.update=function(b,a){void 0===b&&(b=4);void 0===a&&(a=!0);this._geometryData&&(a&&(a=this._geometryData.vertexStreamDictionary.POSITION)&&3==a.componentCount&&this._aabb.compute(a.data,this._geometryData.vertexCount),a=this._geometryData.recreate,this._geometryData.vertexCount>this._geometryData.maxVertices&&(a=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),a&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=
null),a=this._geometryData.recreate,this._geometryData.indexCount>this._geometryData.maxIndices&&(a=!0,this._geometryData.maxIndices=this._geometryData.indexCount),a&&0<this.indexBuffer.length&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=b,0<this.indexBuffer.length&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&
(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1)};d._buildVertexFormat=function(b){var a=[],c;for(c in this._geometryData.vertexStreamDictionary){var e=this._geometryData.vertexStreamDictionary[c];
a.push({semantic:c,components:e.componentCount,type:e.dataType,normalize:e.dataTypeNormalize})}return new Ma(this.device,a,b)};d._updateVertexBuffer=function(){if(!this.vertexBuffer){var b=this._geometryData.maxVertices,a=this._buildVertexFormat(b);this.vertexBuffer=new Ra(this.device,a,b,this._geometryData.verticesUsage)}b=new vb(this.vertexBuffer);a=this._geometryData.vertexCount;for(var c in this._geometryData.vertexStreamDictionary)b.writeData(c,this._geometryData.vertexStreamDictionary[c].data,
a),delete this._geometryData.vertexStreamDictionary[c];b.end()};d._updateIndexBuffer=function(){if(0>=this.indexBuffer.length||!this.indexBuffer[0])this.indexBuffer[0]=new Db(this.device,65535<this._geometryData.maxVertices?2:1,this._geometryData.maxIndices,this._geometryData.indicesUsage);var b=this._geometryData.indices;b&&(this.indexBuffer[0].writeData(b,this._geometryData.indexCount),this._geometryData.indices=null)};d.generateWireframe=function(){var b=function(v){switch(v.format){case 0:return new Uint8Array(v.storage);
case 1:return new Uint16Array(v.storage);case 2:return new Uint32Array(v.storage);default:return null}},a=[];if(0<this.indexBuffer.length&&this.indexBuffer[0]){var c=[[0,1],[1,2],[2,0]];for(var e=this.primitive[0].base,f=this.primitive[0].count,h=this.indexBuffer[0],k=b(h),m={},n=e;n<e+f;n+=3)for(var p=0;3>p;p++){var t=k[n+c[p][0]],r=k[n+c[p][1]],u=t>r?r<<16|t:t<<16|r;void 0===m[u]&&(m[u]=0,a.push(t,r))}c=h.format}else{for(c=0;c<this.vertexBuffer.numVertices;c+=3)a.push(c,c+1,c+1,c+2,c+2,c);c=65535<
a.length?2:1}c=new Db(this.vertexBuffer.device,c,a.length);b(c).set(a);c.unlock();this.primitive[1]={type:1,base:0,count:a.length,indexed:!0};this.indexBuffer[1]=c};N(g,[{key:"aabb",get:function(){return this._aabb},set:function(b){this._aabb=b}}]);return g}(Cj),Ib=new la,nf=new la,Wg=new dd,mo=function(l){this.count=l;this.vertexBuffer=null},Xg=function(){function l(g,d,b){this._key=[];this._key[0]=(g&15)<<27|(3===d?1:0)<<26|33554432;this.command=b}N(l,[{key:"key",get:function(){return this._key[0]},
set:function(g){this._key[0]=g}}]);return l}(),Ga=function(){function l(d,b,a){this._key=[0,0];this._shader=[null,null,null];this.isStatic=!1;this._staticSource=this._staticLightList=null;this.node=d;this._mesh=b;b.incRefCount();this.material=a;this._shaderDefs=65536;this._shaderDefs|=b.vertexBuffer.format.hasUv0?4:0;this._shaderDefs|=b.vertexBuffer.format.hasUv1?8:0;this._shaderDefs|=b.vertexBuffer.format.hasColor?16:0;this._shaderDefs|=b.vertexBuffer.format.hasTangents?512:0;this._lightHash=0;this.visible=
!0;this.layer=15;this.renderStyle=0;this.castShadow=!1;this._receiveShadow=!0;this._noDepthDrawGl1=this._screenSpace=!1;this._updateAabb=this.pick=this.cull=!0;this._calculateSortDistance=this._updateAabbFunc=null;this.updateKey();this.instancingData=this._morphInstance=this._skinInstance=null;this.aabb=new la;this._aabbVer=-1;this.visibleThisFrame=this.drawOrder=0;this.isVisibleFunc=null;this.parameters={};this.stencilBack=this.stencilFront=null;this.flipFaces=!1}var g=l.prototype;g.destroy=function(){var d=
this.mesh;d&&(this.mesh=null,1>d.getRefCount()&&d.destroy());this._skinInstance&&(this._skinInstance.destroy(),this._skinInstance=null);this.morphInstance&&(this.morphInstance.destroy(),this.morphInstance=null);this.material=null};g.syncAabb=function(){};g._isVisible=function(d){if(this.visible){if(this.isVisibleFunc)return this.isVisibleFunc(d);var b=this.aabb.center;this._aabb._radiusVer!==this._aabbVer&&(this._aabb._radius=this._aabb.halfExtents.length(),this._aabb._radiusVer=this._aabbVer);Wg.radius=
this._aabb._radius;Wg.center=b;return d.frustum.containsSphere(Wg)}return!1};g.updateKey=function(){var d=this.material;this._key[0]=(this.layer&15)<<27|(3===(d.alphaToCoverage||d.alphaTest?2:d.blendType)?1:0)<<26|0|(d.id&33554431)<<0};g.setInstancing=function(d){d?(this.instancingData=new mo(d.numVertices),this.instancingData.vertexBuffer=d,d.instancing=!0,this.cull=!1):(this.instancingData=null,this.cull=!0)};g.clearParameters=function(){this.parameters={}};g.getParameters=function(){return this.parameters};
g.getParameter=function(d){return this.parameters[d]};g.setParameter=function(d,b,a){void 0===a&&(a=-524285);if(void 0===b&&"object"===typeof d){b=d;if(b.length){for(d=0;d<b.length;d++)this.setParameter(b[d]);return}d=b.name;b=b.value}var c=this.parameters[d];c?(c.data=b,c.passFlags=a):this.parameters[d]={scopeId:null,data:b,passFlags:a}};g.deleteParameter=function(d){this.parameters[d]&&delete this.parameters[d]};g.setParameters=function(d,b){var a=this.parameters,c;for(c in a){var e=a[c];e.passFlags&
b&&(e.scopeId||(e.scopeId=d.scope.resolve(c)),e.scopeId.setValue(e.data))}};g.setLightmapped=function(d){d?this.mask=(this.mask|2)&-6:(this.deleteParameter("texture_lightMap"),this.deleteParameter("texture_dirLightMap"),this._shaderDefs&=-65,this.mask=(this.mask|1)&-7)};g.setOverrideAabb=function(d){this._updateAabb=!d;d&&this.aabb.copy(d);this._setupSkinUpdate()};g._setupSkinUpdate=function(){this._skinInstance&&(this._skinInstance._updateBeforeCull=this._updateAabb)};N(l,[{key:"mesh",get:function(){return this._mesh},
set:function(d){d!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),(this._mesh=d)&&d.incRefCount())}},{key:"aabb",get:function(){var d;if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);if(this.skinInstance){this.mesh.boneAabb||this.mesh._initBoneAabbs(this._morphInstance?this._morphInstance.morph._targets:null);var b=this.mesh.boneUsed,a=this.node.getWorldTransform(),c=!0;for(d=0;d<this.mesh.boneAabb.length;d++)b[d]&&(nf.setFromTransformedAabb(this.mesh.boneAabb[d],
this.skinInstance.matrices[d]),c?(c=!1,Ib.center.copy(nf.center),Ib.halfExtents.copy(nf.halfExtents)):Ib.add(nf));this._aabb.setFromTransformedAabb(Ib,a)}else this.node._aabbVer!==this._aabbVer&&(this.mesh?(Ib.center.copy(this.mesh.aabb.center),Ib.halfExtents.copy(this.mesh.aabb.halfExtents)):(Ib.center.set(0,0,0),Ib.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph&&Ib._expand(this.mesh.morph.aabb.getMin(),this.mesh.morph.aabb.getMax()),this._aabb.setFromTransformedAabb(Ib,this.node.getWorldTransform()),
this._aabbVer=this.node._aabbVer);return this._aabb},set:function(d){this._aabb=d}},{key:"material",get:function(){return this._material},set:function(d){var b;for(b=0;b<this._shader.length;b++)this._shader[b]=null;if(this._material){var a=this._material.meshInstances;b=a.indexOf(this);-1!==b&&a.splice(b,1)}b=this._material;if(this._material=d)this._material.meshInstances.push(this),this.updateKey(),(b&&3!==b.blendType)!==(3!==this._material.blendType)&&(d=this._material._scene,!d&&b&&b._scene&&(d=
b._scene),d?d.layers._dirtyBlend=!0:this._material._dirtyBlend=!0)}},{key:"layer",get:function(){return this._layer},set:function(d){this._layer=d;this.updateKey()}},{key:"calculateSortDistance",get:function(){return this._calculateSortDistance},set:function(d){this._calculateSortDistance=d}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(d){this._shaderDefs=(this._receiveShadow=d)?this._shaderDefs&-2:this._shaderDefs|1;this._shader[0]=null;this._shader[1]=null}},{key:"skinInstance",
get:function(){return this._skinInstance},set:function(d){this._shaderDefs=(this._skinInstance=d)?this._shaderDefs|2:this._shaderDefs&-3;for(d=0;d<this._shader.length;d++)this._shader[d]=null;this._setupSkinUpdate()}},{key:"morphInstance",get:function(){return this._morphInstance},set:function(d){if(this._morphInstance=d)this._morphInstance.meshInstance=this;this._shaderDefs=d&&d.morph.useTextureMorph?this._shaderDefs|4096:this._shaderDefs&-4097;this._shaderDefs=d&&d.morph.morphPositions?this._shaderDefs|
1024:this._shaderDefs&-1025;this._shaderDefs=d&&d.morph.morphNormals?this._shaderDefs|2048:this._shaderDefs&-2049;for(d=0;d<this._shader.length;d++)this._shader[d]=null}},{key:"screenSpace",get:function(){return this._screenSpace},set:function(d){this._shaderDefs=(this._screenSpace=d)?this._shaderDefs|256:this._shaderDefs&-257;this._shader[0]=null}},{key:"key",get:function(){return this._key[0]},set:function(d){this._key[0]=d}},{key:"mask",get:function(){return this._shaderDefs>>16},set:function(d){this._shaderDefs=
this._shaderDefs&65535|d<<16;this._shader[0]=null;this._shader[1]=null}},{key:"instancingCount",get:function(){return this.instancingData?this.instancingData.count:0},set:function(d){this.instancingData&&(this.instancingData.count=d)}}]);return l}(),ed=function(l){function g(b,a){var c=l.call(this)||this;c.device=a||qa.getApplication().graphicsDevice;c._targets=b;c.device.supportsMorphTargetTexturesCore&&(c.device.extTextureHalfFloat&&c.device.textureHalfFloatRenderable?c._renderTextureFormat=g.FORMAT_HALF_FLOAT:
c.device.extTextureFloat&&c.device.textureFloatRenderable&&(c._renderTextureFormat=g.FORMAT_FLOAT),c.device.extTextureHalfFloat&&c.device.textureHalfFloatUpdatable?c._textureFormat=g.FORMAT_HALF_FLOAT:c.device.extTextureFloat&&(c._textureFormat=g.FORMAT_FLOAT),void 0!==c._renderTextureFormat&&void 0!==c._textureFormat&&(c._useTextureMorph=!0));c._init();c._updateMorphFlags();c._calculateAabb();return c}K(g,l);var d=g.prototype;d._init=function(){this._useTextureMorph&&(this._useTextureMorph=this._initTextureBased());
var b;if(!this._useTextureMorph)for(b=0;b<this._targets.length;b++)this._targets[b]._initVertexBuffers(this.device);for(b=0;b<this._targets.length;b++)this._targets[b]._postInit()};d._initTextureBased=function(){var b,a=[],c=[];for(b=0;b<this._targets.length;b++){var e=this._targets[b];e.options.deltaPositions&&(a.push(e.options.deltaPositions),c.push({target:e,name:"texturePositions"}));e.options.deltaNormals&&(a.push(e.options.deltaNormals),c.push({target:e,name:"textureNormals"}))}var f=[],h=[],
k=1,m=a[0].length;for(e=0;e<m;e+=3){var n=!1;for(b=0;b<a.length;b++){var p=a[b];if(0!==p[e]||0!==p[e+1]||0!==p[e+2]){n=!0;break}}n?(f.push(k),h.push(e/3),k++):f.push(0)}b=Math.min(this.device.maxTextureSize,4096);e=Math.ceil(Math.sqrt(k));e=Math.min(e,b);p=Math.ceil(k/e);if(p>b)return!1;this.morphTextureWidth=e;this.morphTextureHeight=p;k=!1;n=3;m=R.float2Half;this._textureFormat===g.FORMAT_HALF_FLOAT&&(k=!0,n=4);b=this.morphTextureWidth*this.morphTextureHeight*n;var t=k?new Uint16Array(b):new Float32Array(b);
for(b=0;b<a.length;b++){p=a[b];for(e=0;e<h.length;e++){var r=h[e];k?(t[e*n+n]=m(p[3*r]),t[e*n+n+1]=m(p[3*r+1]),t[e*n+n+2]=m(p[3*r+2])):(t[e*n+n]=p[3*r],t[e*n+n+1]=p[3*r+1],t[e*n+n+2]=p[3*r+2])}e=c[b].target;e._setTexture(c[b].name,this._createTexture("MorphTarget",this._textureFormat===g.FORMAT_FLOAT?13:12,t))}this.vertexBufferIds=new Ra(this.device,new Ma(this.device,[{semantic:"ATTR15",components:1,type:6}]),f.length,0,new Float32Array(f));return!0};d.destroy=function(){this.vertexBufferIds&&(this.vertexBufferIds.destroy(),
this.vertexBufferIds=null);for(var b=0;b<this._targets.length;b++)this._targets[b].destroy();this._targets.length=0};d.getTarget=function(b){return this._targets[b]};d._updateMorphFlags=function(){this._morphNormals=this._morphPositions=!1;for(var b,a=0;a<this._targets.length;a++)b=this._targets[a],b.morphPositions&&(this._morphPositions=!0),b.morphNormals&&(this._morphNormals=!0)};d._calculateAabb=function(){this.aabb=new la(new A(0,0,0),new A(0,0,0));for(var b,a=0;a<this._targets.length;a++)b=this._targets[a],
this.aabb._expand(b.aabb.getMin(),b.aabb.getMax())};d._createTexture=function(b,a,c){a=new X(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:a,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});a.name=b;c&&(a.lock().set(c),a.unlock());return a};N(g,[{key:"morphPositions",get:function(){return this._morphPositions}},{key:"morphNormals",get:function(){return this._morphNormals}},{key:"maxActiveTargets",get:function(){return this._useTextureMorph?this._targets.length:
this._morphPositions&&this._morphNormals?4:8}},{key:"useTextureMorph",get:function(){return this._useTextureMorph}}]);return g}(Cj);ed.FORMAT_FLOAT=0;ed.FORMAT_HALF_FLOAT=1;var ae=function(){function l(d){this.morph=d;d.incRefCount();this.device=d.device;this.meshInstance=null;this._weights=[];for(var b=0;b<d._targets.length;b++)this.setWeight(b,d._targets[b].defaultWeight);this._activeTargets=[];if(d.useTextureMorph){this.shaderCache={};this.maxSubmitCount=this.device.maxTextures;this._shaderMorphWeights=
new Float32Array(this.maxSubmitCount);b=function(a,c){this[c]=d._createTexture(a,d._renderTextureFormat===ed.FORMAT_FLOAT?14:12);return new va({colorBuffer:this[c],depth:!1})}.bind(this);d.morphPositions&&(this.rtPositions=b("MorphRTPos","texturePositions"));d.morphNormals&&(this.rtNormals=b("MorphRTNrm","textureNormals"));this._textureParams=new Float32Array([d.morphTextureWidth,d.morphTextureHeight,1/d.morphTextureWidth,1/d.morphTextureHeight]);for(b=0;b<this.maxSubmitCount;b++)this["morphBlendTex"+
b]=this.device.scope.resolve("morphBlendTex"+b);this.morphFactor=this.device.scope.resolve("morphFactor[0]");this.zeroTextures=!1}else this.maxSubmitCount=8,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4),this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,16,4),this._activeVertexBuffers=Array(this.maxSubmitCount)}var g=l.prototype;g.destroy=function(){this.shader=this.meshInstance=
null;var d=this.morph;d&&(this.morph=null,d.decRefCount(),1>d.getRefCount()&&d.destroy());this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null);this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null);this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null);this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)};g.clone=function(){return new l(this.morph)};g.getWeight=function(d){return this._weights[d]};g.setWeight=function(d,
b){this._weights[d]=b;this._dirty=!0};g._getFragmentShader=function(d){var b,a="";0<d&&(a+="varying vec2 uv0;\nuniform highp float morphFactor["+d+"];\n");for(b=0;b<d;b++)a+="uniform highp sampler2D morphBlendTex"+b+";\n";a+="void main (void) {\n\t\thighp vec4 color = vec4(0, 0, 0, 1);\n";for(b=0;b<d;b++)a+="\t\tcolor.xyz += morphFactor["+b+"] * texture2D(morphBlendTex"+b+", uv0).xyz;\n";return a+"\t\tgl_FragColor = color;\n}\n"};g._getShader=function(d){var b=this.shaderCache[d];b||(b=this._getFragmentShader(d),
b=Ja(this.device,"attribute vec2 vertex_position;\nvarying vec2 uv0;\nvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n}\n",b,"textureMorph"+d),this.shaderCache[d]=b);return b};g._updateTextureRenderTarget=function(d,b){for(var a=this.device,c=function(p,t){this.morphFactor.setValue(this._shaderMorphWeights);a.setBlending(t);t&&(a.setBlendFunction(1,1),a.setBlendEquation(0));p=this._getShader(p);Ea(a,d,p,void 0,void 0,t)}.bind(this),
e=0,f=!1,h=this._activeTargets.length,k=0;k<h;k++){var m=this._activeTargets[k],n=m.target[b];n&&(this["morphBlendTex"+e].setValue(n),this._shaderMorphWeights[e]=m.weight,e++,e>=this.maxSubmitCount&&(c(e,f),e=0,f=!0))}(0<e||0===h&&!this.zeroTextures)&&c(e,f)};g._updateTextureMorph=function(){if(0<this._activeTargets.length||!this.zeroTextures)this._updateTextureRenderTarget(this.rtPositions,"texturePositions"),this._updateTextureRenderTarget(this.rtNormals,"textureNormals"),this.zeroTextures=0===
this._activeTargets.length};g._updateVertexMorph=function(){var d,b=this.maxSubmitCount;for(d=0;d<b;d++)this._shaderMorphWeights[d]=0,this._activeVertexBuffers[d]=null;b=0;var a=this.morph.morphPositions?4:0;for(d=0;d<this._activeTargets.length;d++){var c=this._activeTargets[d].target;c._vertexBufferPositions&&(this._activeVertexBuffers[b]=c._vertexBufferPositions,this._shaderMorphWeights[b]=this._activeTargets[d].weight,b++);c._vertexBufferNormals&&(this._activeVertexBuffers[a]=c._vertexBufferNormals,
this._shaderMorphWeights[a]=this._activeTargets[d].weight,a++)}};g.update=function(){this._dirty=!1;var d=this.morph._targets,b=0,a;for(a=0;a<d.length;a++){var c=Math.abs(this.getWeight(a));if(1E-5<c){this._activeTargets.length<=b&&(this._activeTargets[b]={});var e=this._activeTargets[b++];e.absWeight=c;e.weight=this.getWeight(a);e.target=d[a]}}this._activeTargets.length=b;d=this.morph.maxActiveTargets;this._activeTargets.length>d&&(this._activeTargets.sort(function(f,h){return f.absWeight<h.absWeight?
1:h.absWeight<f.absWeight?-1:0}),this._activeTargets.length=d);this.morph.useTextureMorph?this._updateTextureMorph():this._updateVertexMorph()};return l}(),Dj=new M,ic=function(){function l(d){this._dirty=!0;this._skinUpdateIndex=-1;this._updateBeforeCull=!0;d&&this.initSkin(d)}var g=l.prototype;g.init=function(d,b){if(d.supportsBoneTextures){b*=3;var a=Math.ceil(Math.sqrt(b));a=R.roundUp(a,3);this.boneTexture=new X(d,{width:a,height:Math.ceil(b/a),format:14,mipmaps:!1,minFilter:0,magFilter:0});this.boneTexture.name=
"skin";this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=new Float32Array(12*b)};g.destroy=function(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)};g.initSkin=function(d){this.skin=d;this.bones=[];var b=d.inverseBindPose.length;this.init(d.device,b);this.matrices=[];for(d=0;d<b;d++)this.matrices[d]=new M};g.uploadBones=function(d){d.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())};g._updateMatrices=function(d,b){if(this._skinUpdateIndex!==
b)for(this._skinUpdateIndex=b,Dj.copy(d.getWorldTransform()).invert(),d=this.bones.length-1;0<=d;d--)this.matrices[d].mulAffine2(Dj,this.bones[d].getWorldTransform()),this.matrices[d].mulAffine2(this.matrices[d],this.skin.inverseBindPose[d])};g.updateMatrices=function(d,b){this._updateBeforeCull&&this._updateMatrices(d,b)};g.updateMatrixPalette=function(d,b){this._updateMatrices(d,b);b=this.matrixPalette;for(var a,c=this.bones.length,e=0;e<c;e++)d=this.matrices[e].data,a=12*e,b[a]=d[0],b[a+1]=d[4],
b[a+2]=d[8],b[a+3]=d[12],b[a+4]=d[1],b[a+5]=d[5],b[a+6]=d[9],b[a+7]=d[13],b[a+8]=d[2],b[a+9]=d[6],b[a+10]=d[10],b[a+11]=d[14];this.uploadBones(this.skin.device)};return l}(),fb=function(){function l(){this.graph=null;this.meshInstances=[];this.skinInstances=[];this.morphInstances=[];this.cameras=[];this.lights=[];this._shadersVersion=0;this._immutable=!1}var g=l.prototype;g.getGraph=function(){return this.graph};g.setGraph=function(d){this.graph=d};g.getCameras=function(){return this.cameras};g.setCameras=
function(d){this.cameras=d};g.getLights=function(){return this.lights};g.setLights=function(d){this.lights=d};g.getMaterials=function(){var d,b=[];for(d=0;d<this.meshInstances.length;d++){var a=this.meshInstances[d];-1===b.indexOf(a.material)&&b.push(a.material)}return b};g.clone=function(){var d,b,a=[],c=[],e=function v(u){var w=u.clone();a.push(u);c.push(w);for(var y=0;y<u._children.length;y++)w.addChild(v(u._children[y]));return w}(this.graph),f=[],h=[],k=[];for(d=0;d<this.skinInstances.length;d++){var m=
this.skinInstances[d].skin,n=new ic(m),p=[];for(b=0;b<m.boneNames.length;b++){var t=e.findByName(m.boneNames[b]);p.push(t)}n.bones=p;h.push(n)}for(d=0;d<this.morphInstances.length;d++)b=new ae(this.morphInstances[d].morph),k.push(b);for(d=0;d<this.meshInstances.length;d++)b=this.meshInstances[d],m=a.indexOf(b.node),m=new Ga(c[m],b.mesh,b.material),b.skinInstance&&(n=this.skinInstances.indexOf(b.skinInstance),m.skinInstance=h[n]),b.morphInstance&&(b=this.morphInstances.indexOf(b.morphInstance),m.morphInstance=
k[b]),f.push(m);d=new l;d.graph=e;d.meshInstances=f;d.skinInstances=h;d.morphInstances=k;d.getGraph().syncHierarchy();return d};g.destroy=function(){for(var d=this.meshInstances,b=0;b<d.length;b++)d[b].destroy();this.meshInstances.length=0};g.generateWireframe=function(){var d,b=[];for(d=0;d<this.meshInstances.length;d++){var a=this.meshInstances[d].mesh;-1===b.indexOf(a)&&b.push(a)}for(d=0;d<b.length;++d)a=b[d],a.primitive[1]||a.generateWireframe()};return l}(),Yg=function(l,g,d){this.origMeshInstances=
l;this._aabb=new la;this.model=this.meshInstance=null;this.dynamic=g;this.batchGroupId=d},Da=function(l,g,d,b,a){void 0===a&&(a=[0]);this.dynamic=d;this.maxAabbSize=b;this.id=l;this.name=g;this.layers=a;this._sprite=this._ui=!1;this._obj={model:[],element:[],sprite:[],render:[]}};Da.MODEL="model";Da.ELEMENT="element";Da.SPRITE="sprite";Da.RENDER="render";for(var Zg=function(l){function g(b,a,c){var e=l.call(this)||this;e.init(b,a.length);e.device=b;e.rootNode=c;e.bones=a;return e}K(g,l);var d=g.prototype;
d.updateMatrices=function(b,a){};d.updateMatrixPalette=function(b,a){a=this.matrixPalette;for(var c,e=this.bones.length,f=0;f<e;f++)b=this.bones[f].getWorldTransform().data,c=12*f,a[c]=b[0],a[c+1]=b[4],a[c+2]=b[8],a[c+3]=b[12],a[c+4]=b[1],a[c+5]=b[5],a[c+6]=b[9],a[c+7]=b[13],a[c+8]=b[2],a[c+9]=b[6],a[c+10]=b[10],a[c+11]=b[14];this.uploadBones(this.device)};return g}(ic),Ke=new A,Fi=new A,Gi=new A,Ej=function(){function l(d,b,a){this.device=d;this.rootNode=b;this.scene=a;this._init=!1;this._batchGroups=
{};this._batchGroupCounter=0;this._batchList=[];this._dirtyGroups=[]}var g=l.prototype;g.destroyManager=function(){this.scene=this.rootNode=this.device=null;this._batchGroups={};this._batchList=[];this._dirtyGroups=[]};g.addGroup=function(d,b,a,c,e){void 0===c&&(c=this._batchGroupCounter,this._batchGroupCounter++);if(!this._batchGroups[c])return this._batchGroups[c]=d=new Da(c,d,b,a,e)};g.removeGroup=function(d){if(this._batchGroups[d]){for(var b=[],a=0;a<this._batchList.length;a++)this._batchList[a].batchGroupId!==
d?b.push(this._batchList[a]):this.destroy(this._batchList[a]);this._batchList=b;this._removeModelsFromBatchGroup(this.rootNode,d);delete this._batchGroups[d]}};g.markGroupDirty=function(d){0>this._dirtyGroups.indexOf(d)&&this._dirtyGroups.push(d)};g.getGroupByName=function(d){var b=this._batchGroups,a;for(a in b)if(b.hasOwnProperty(a)&&b[a].name===d)return b[a];return null};g.getBatches=function(d){for(var b=[],a=this._batchList.length,c=0;c<a;c++){var e=this._batchList[c];e.batchGroupId===d&&b.push(e)}return b};
g._removeModelsFromBatchGroup=function(d,b){if(d.enabled){d.model&&d.model.batchGroupId===b&&(d.model.batchGroupId=-1);d.render&&d.render.batchGroupId===b&&(d.render.batchGroupId=-1);d.element&&d.element.batchGroupId===b&&(d.element.batchGroupId=-1);d.sprite&&d.sprite.batchGroupId===b&&(d.sprite.batchGroupId=-1);for(var a=0;a<d._children.length;a++)this._removeModelsFromBatchGroup(d._children[a],b)}};g.insert=function(d,b,a){var c=this._batchGroups[b];c&&0>c._obj[d].indexOf(a)&&(c._obj[d].push(a),
this.markGroupDirty(b))};g.remove=function(d,b,a){var c=this._batchGroups[b];c&&(a=c._obj[d].indexOf(a),0<=a&&(c._obj[d].splice(a,1),this.markGroupDirty(b)))};g._extractRender=function(d,b,a,c){if(d.render){if(d.render.isStatic){c=this.scene.drawCalls;var e=d.render.meshInstances;for(a=0;a<c.length;a++)c[a]._staticSource&&(0>e.indexOf(c[a]._staticSource)||b.push(c[a]));for(a=0;a<e.length;a++)0<=c.indexOf(e[a])&&b.push(e[a])}else b=c[d.render.batchGroupId]=b.concat(d.render.meshInstances);d.render.removeFromLayers()}return b};
g._extractModel=function(d,b,a,c){if(d.model&&d.model.model){if(d.model.isStatic){c=this.scene.drawCalls;var e=d.model.meshInstances;for(a=0;a<c.length;a++)c[a]._staticSource&&(0>e.indexOf(c[a]._staticSource)||b.push(c[a]));for(a=0;a<e.length;a++)0<=c.indexOf(e[a])&&b.push(e[a])}else b=c[d.model.batchGroupId]=b.concat(d.model.meshInstances);d.model.removeModelFromLayers()}return b};g._extractElement=function(d,b,a){if(d.element){var c=!1;d.element._text&&0<d.element._text._model.meshInstances.length?
(b.push(d.element._text._model.meshInstances[0]),d.element.removeModelFromLayers(d.element._text._model),c=!0):d.element._image&&(b.push(d.element._image._renderable.meshInstance),d.element.removeModelFromLayers(d.element._image._renderable.model),d.element._image._renderable.unmaskMeshInstance&&(b.push(d.element._image._renderable.unmaskMeshInstance),d.element._image._renderable.unmaskMeshInstance.stencilFront&&d.element._image._renderable.unmaskMeshInstance.stencilBack||(d.element._dirtifyMask(),
d.element._onPrerender())),c=!0);c&&(a._ui=!0)}};g._collectAndRemoveMeshInstances=function(d,b){for(var a,c,e,f=0;f<b.length;f++)if(a=b[f],c=this._batchGroups[a]){(e=d[a])||(e=d[a]=[]);for(a=0;a<c._obj.model.length;a++)e=this._extractModel(c._obj.model[a],e,c,d);for(a=0;a<c._obj.render.length;a++)e=this._extractRender(c._obj.render[a],e,c,d);for(a=0;a<c._obj.element.length;a++)this._extractElement(c._obj.element[a],e,c);for(var h=0;h<c._obj.sprite.length;h++)a=c._obj.sprite[h],a.sprite&&a.sprite._meshInstance&&
(c.dynamic||0===a.sprite.sprite._renderMode)&&(e.push(a.sprite._meshInstance),a.sprite.removeModelFromLayers(),c._sprite=!0,a.sprite._batchGroup=c)}};g.generate=function(d){var b,a={};d||(d=Object.keys(this._batchGroups));var c=[];for(b=0;b<this._batchList.length;b++)0>d.indexOf(this._batchList[b].batchGroupId)?c.push(this._batchList[b]):this.destroy(this._batchList[b]);this._batchList=c;this._collectAndRemoveMeshInstances(a,d);if(d===this._dirtyGroups)this._dirtyGroups.length=0;else{c=[];for(b=0;b<
this._dirtyGroups.length;b++)0>d.indexOf(this._dirtyGroups[b])&&c.push(this._dirtyGroups[b]);this._dirtyGroups=c}var e,f;for(f in a)if(a.hasOwnProperty(f)&&(b=a[f],d=this._batchGroups[f])){var h=this.prepare(b,d.dynamic,d.maxAabbSize,d._ui||d._sprite);for(b=0;b<h.length;b++)if(e=this.create(h[b],d.dynamic,parseInt(f,10)))for(c=0;c<d.layers.length;c++){var k=this.scene.layers.getLayerById(d.layers[c]);k&&k.addMeshInstances(e.model.meshInstances)}}};g.prepare=function(d,b,a,c){void 0===a&&(a=Number.POSITIVE_INFINITY);
if(0===d.length)return[];a*=.5;var e=this.device.supportsBoneTextures?1024:this.device.boneLimit,f=this.device.extUintElement?4294967295:65535,h=new la,k=new la,m=null,n,p=[],t,r=0;c&&d.sort(function(L,V){return L.drawOrder-V.drawOrder});for(var u=d,v,w=c?function(L){m?m.add(L.aabb):m=L.aabb.clone();v.push(L)}:function(L){v.push(L)};0<u.length;){p[r]=[u[0]];v=[];d=u[0].material;var y=u[0].layer;var x=u[0]._shaderDefs;var z=u[0].parameters;var B=u[0].stencilFront;var C=u[0]._staticLightList;var D=
u[0].mesh.vertexBuffer.getNumVertices();var G=u[0].drawOrder;h.copy(u[0].aabb);var J=mg(u[0]);var E=u[0].mesh.vertexBuffer.format.batchingHash;var H=u[0].mesh.primitive[0].indexed;m=null;for(t=1;t<u.length;t++){var P=u[t];if(b&&p[r].length>=e){v=v.concat(u.slice(t));break}if(d!==P.material||y!==P.layer||E!==P.mesh.vertexBuffer.format.batchingHash||H!==P.mesh.primitive[0].indexed||x!==P._shaderDefs||D+P.mesh.vertexBuffer.getNumVertices()>f)w(P);else if(k.copy(h),k.add(P.aabb),k.halfExtents.x>a||k.halfExtents.y>
a||k.halfExtents.z>a)w(P);else if(!B||(n=P.stencilFront)&&B.func==n.func&&B.zpass==n.zpass)if(J!=mg(P))w(P);else if(zn(z,P.parameters)){var Y=P._staticLightList;if(C&&Y){if(!An(C,Y)){w(P);continue}}else if(C||Y){w(P);continue}c&&m&&m.intersects(P.aabb)&&P.drawOrder!==G?w(P):(h.add(P.aabb),D+=P.mesh.vertexBuffer.getNumVertices(),p[r].push(P))}else w(P);else w(P)}r++;u=v}return p};g.create=function(d,b,a){this._init||(this.transformVS="#define BONE_LIMIT "+this.device.getBoneLimit()+"\n#define DYNAMICBATCH\n"+
I.transformVS,this.skinTexVS=I.skinBatchTexVS,this.skinConstVS=I.skinBatchConstVS,this.vertexFormats={},this._init=!0);var c,e,f=null,h=null,k=0,m=0,n=null;for(c=0;c<d.length;c++)if(d[c].visible){var p=d[c].mesh;var t=p.vertexBuffer.numVertices;k+=t;m+=p.primitive[0].indexed?p.primitive[0].count:6==p.primitive[0].type&&4===p.primitive[0].count?6:0;if(!f){h=d[c].material;f={};t=p.vertexBuffer.format.elements;for(e=0;e<t.length;e++){var r=t[e].name;f[r]={numComponents:t[e].numComponents,dataType:t[e].dataType,
normalize:t[e].normalize,count:0}}b&&(f.BLENDINDICES={numComponents:1,dataType:6,normalize:!1,count:0})}}if(f){n=new Yg(d,b,a);this._batchList.push(n);var u=0,v=0,w,y=new A;m=new (65535>=k?Uint16Array:Uint32Array)(m);for(r in f){var x=f[r];x.typeArrayType=Fc[x.dataType];x.elementByteSize=$d[x.dataType];x.buffer=new x.typeArrayType(k*x.numComponents)}for(c=0;c<d.length;c++)if(d[c].visible){p=d[c].mesh;t=p.vertexBuffer.numVertices;b||(w=d[c].node.getWorldTransform());for(r in f)if("BLENDINDICES"!==
r){x=f[r];k=new x.typeArrayType(x.buffer.buffer,x.elementByteSize*x.count);var z=p.getVertexStream(r,k)*x.numComponents;x.count+=z;if(!b&&3<=x.numComponents&&("POSITION"==r||"NORMAL"==r||"TANGENT"==r))for(w.transformFunction="POSITION"==r?M.prototype.transformPoint:M.prototype.transformVector,e=0;e<z;e+=x.numComponents)y.set(k[e],k[e+1],k[e+2]),w.transformFunction(y,y),k[e]=y.x,k[e+1]=y.y,k[e+2]=y.z}if(b)for(x=f.BLENDINDICES,e=0;e<t;e++)x.buffer[x.count++]=c;if(p.primitive[0].indexed)x=p.primitive[0].base,
k=p.primitive[0].count,e=p.indexBuffer[0].getFormat(),p=new Bj[e](p.indexBuffer[0].storage);else if(6==p.primitive[0].type&&4===p.primitive[0].count)x=0,k=6,p=[0,1,3,2,3,1];else continue;for(e=0;e<k;e++)m[e+v]=p[x+e]+u;v+=k;u+=t}p=new bb(this.device);for(r in f)x=f[r],p.setVertexStream(r,x.buffer,x.numComponents,void 0,x.dataType,x.normalize);0<m.length&&p.setIndices(m);p.update(4,!1);b&&(h=h.clone(),h.chunks.transformVS=this.transformVS,h.chunks.skinTexVS=this.skinTexVS,h.chunks.skinConstVS=this.skinConstVS,
h.update());d=new Ga(this.rootNode,p,h);d.castShadow=n.origMeshInstances[0].castShadow;d.parameters=n.origMeshInstances[0].parameters;d.isStatic=n.origMeshInstances[0].isStatic;d.layer=n.origMeshInstances[0].layer;d._staticLightList=n.origMeshInstances[0]._staticLightList;d._shaderDefs=n.origMeshInstances[0]._shaderDefs;d.cull=n.origMeshInstances[0].cull;(c=this._batchGroups[a])&&c._ui&&(d.cull=!1);if(b){b=[];for(c=0;c<n.origMeshInstances.length;c++)b.push(n.origMeshInstances[c].node);d.skinInstance=
new Zg(this.device,b,this.rootNode)}d._updateAabb=!1;d.drawOrder=n.origMeshInstances[0].drawOrder;d.stencilFront=n.origMeshInstances[0].stencilFront;d.stencilBack=n.origMeshInstances[0].stencilBack;d.flipFaces=0>mg(n.origMeshInstances[0]);n.meshInstance=d;this.update(n);b=new fb;b.meshInstances=[n.meshInstance];b.castShadows=n.origMeshInstances[0].castShadows;n.model=b}return n};g.update=function(d){d._aabb.copy(d.origMeshInstances[0].aabb);for(var b=1;b<d.origMeshInstances.length;b++)d._aabb.add(d.origMeshInstances[b].aabb);
d.meshInstance.aabb=d._aabb;d._aabb._radiusVer=-1;d.meshInstance._aabbVer=0};g.updateAll=function(){0<this._dirtyGroups.length&&this.generate(this._dirtyGroups);for(var d=0;d<this._batchList.length;d++)this._batchList[d].dynamic&&this.update(this._batchList[d])};g.clone=function(d,b){var a=new Yg(b,d.dynamic,d.batchGroupId);this._batchList.push(a);for(var c=[],e=0;e<b.length;e++)c.push(b[e].node);a.meshInstance=new Ga(d.meshInstance.node,d.meshInstance.mesh,d.meshInstance.material);a.meshInstance._updateAabb=
!1;a.meshInstance.parameters=b[0].parameters;a.meshInstance.isStatic=b[0].isStatic;a.meshInstance.cull=b[0].cull;a.meshInstance.layer=b[0].layer;a.meshInstance._staticLightList=b[0]._staticLightList;d.dynamic&&(a.meshInstance.skinInstance=new Zg(this.device,c,this.rootNode));a.meshInstance.castShadow=d.meshInstance.castShadow;a.meshInstance._shader=d.meshInstance._shader;b=new fb;b.meshInstances=[a.meshInstance];b.castShadows=d.origMeshInstances[0].castShadows;a.model=b;return a};g.destroy=function(d){if(d.model){for(var b=
this._batchGroups[d.batchGroupId].layers,a=0;a<b.length;a++){var c=this.scene.layers.getLayerById(b[a]);c&&c.removeMeshInstances(d.model.meshInstances)}d.model.destroy()}};return l}(),fd=new A,Ic=new A,Fj=new A,Gj=new M,be=function(){function l(){this._aspectRatio=16/9;this._aspectRatioMode=0;this._calculateTransform=this._calculateProjection=null;this._clearColor=new Q(.75,.75,.75,1);this._clearColorBuffer=!0;this._clearDepth=1;this._clearDepthBuffer=!0;this._clearStencil=0;this._clearStencilBuffer=
!0;this._cullingMask=4294967295;this._cullFaces=!0;this._farClip=1E3;this._flipFaces=!1;this._fov=45;this._frustumCulling=!0;this._horizontalFov=!1;this._layers=[0,1,2,4,3];this._nearClip=.1;this._node=null;this._orthoHeight=10;this._projection=0;this._rect=new Z(0,0,1,1);this._renderTarget=null;this._scissorRect=new Z(0,0,1,1);this._vrDisplay=null;this._projMat=new M;this._projMatDirty=!0;this._projMatSkybox=new M;this._viewMat=new M;this._viewMatDirty=!0;this._viewProjMat=new M;this._viewProjMatDirty=
!0;this.frustum=new Og}var g=l.prototype;g.clone=function(){return(new this.constructor).copy(this)};g.copy=function(d){this.aspectRatio=d.aspectRatio;this.aspectRatioMode=d.aspectRatioMode;this.calculateProjection=d.calculateProjection;this.calculateTransform=d.calculateTransform;this.clearColor=d.clearColor;this.clearColorBuffer=d.clearColorBuffer;this.clearDepth=d.clearDepth;this.clearDepthBuffer=d.clearDepthBuffer;this.clearStencil=d.clearStencil;this.clearStencilBuffer=d.clearStencilBuffer;this.cullFaces=
d.cullFaces;this.cullingMask=d.cullingMask;this.farClip=d.farClip;this.flipFaces=d.flipFaces;this.fov=d.fov;this.frustumCulling=d.frustumCulling;this.horizontalFov=d.horizontalFov;this.layers=d.layers;this.nearClip=d.nearClip;this.orthoHeight=d.orthoHeight;this.projection=d.projection;this.rect=d.rect;this.renderTarget=d.renderTarget;this.scissorRect=d.scissorRect;this.vrDisplay=d.vrDisplay};g._updateViewProjMat=function(){if(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)this._viewProjMat.mul2(this.projectionMatrix,
this.viewMatrix),this._viewProjMatDirty=!1};g.worldToScreen=function(d,b,a,c){void 0===c&&(c=new A);this._updateViewProjMat();this._viewProjMat.transformPoint(d,c);var e=this._viewProjMat.data;d=d.x*e[3]+d.y*e[7]+d.z*e[11]+1*e[15];c.x=.5*(c.x/d+1)*b;c.y=.5*(1-c.y/d)*a;return c};g.screenToWorld=function(d,b,a,c,e,f){void 0===f&&(f=new A);fd.set(d/c,(e-b)/e,a/(this._farClip-this._nearClip));fd.scale(2);fd.sub(A.ONE);0===this._projection?(M._getPerspectiveHalfSize(Ic,this._fov,this._aspectRatio,this._nearClip,
this._horizontalFov),Ic.x*=fd.x,Ic.y*=fd.y,d=this._node.getWorldTransform(),Ic.z=-this._nearClip,d.transformPoint(Ic,Fj),d=this._node.getPosition(),f.sub2(Fj,d),f.normalize(),f.scale(a),f.add(d)):(this._updateViewProjMat(),Gj.copy(this._viewProjMat).invert(),Gj.transformPoint(fd,f));return f};g._evaluateProjectionMatrix=function(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip,this._horizontalFov),this._projMatSkybox.copy(this._projMat);
else{var d=this._orthoHeight,b=d*this._aspectRatio;this._projMat.setOrtho(-b,b,-d,d,this._nearClip,this._farClip);this._projMatSkybox.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip)}this._projMatDirty=!1}};g.getProjectionMatrixSkybox=function(){this._evaluateProjectionMatrix();return this._projMatSkybox};N(l,[{key:"aspectRatio",get:function(){return this._aspectRatio},set:function(d){this._aspectRatio!==d&&(this._aspectRatio=d,this._projMatDirty=!0)}},{key:"aspectRatioMode",
get:function(){return this._aspectRatioMode},set:function(d){this._aspectRatioMode!==d&&(this._aspectRatioMode=d,this._projMatDirty=!0)}},{key:"calculateProjection",get:function(){return this._calculateProjection},set:function(d){this._calculateProjection=d;this._projMatDirty=!0}},{key:"calculateTransform",get:function(){return this._calculateTransform},set:function(d){this._calculateTransform=d}},{key:"clearColor",get:function(){return this._clearColor},set:function(d){this._clearColor.copy(d)}},
{key:"clearColorBuffer",get:function(){return this._clearColorBuffer},set:function(d){this._clearColorBuffer=d}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(d){this._clearDepth=d}},{key:"clearDepthBuffer",get:function(){return this._clearDepthBuffer},set:function(d){this._clearDepthBuffer=d}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(d){this._clearStencil=d}},{key:"clearStencilBuffer",get:function(){return this._clearStencilBuffer},set:function(d){this._clearStencilBuffer=
d}},{key:"cullingMask",get:function(){return this._cullingMask},set:function(d){this._cullingMask=d}},{key:"cullFaces",get:function(){return this._cullFaces},set:function(d){this._cullFaces=d}},{key:"farClip",get:function(){return this._farClip},set:function(d){this._farClip!==d&&(this._farClip=d,this._projMatDirty=!0)}},{key:"flipFaces",get:function(){return this._flipFaces},set:function(d){this._flipFaces=d}},{key:"fov",get:function(){return this._fov},set:function(d){this._fov!==d&&(this._fov=
d,this._projMatDirty=!0)}},{key:"frustumCulling",get:function(){return this._frustumCulling},set:function(d){this._frustumCulling=d}},{key:"horizontalFov",get:function(){return this._horizontalFov},set:function(d){this._horizontalFov!==d&&(this._horizontalFov=d,this._projMatDirty=!0)}},{key:"layers",get:function(){return this._layers},set:function(d){this._layers=d.slice(0)}},{key:"nearClip",get:function(){return this._nearClip},set:function(d){this._nearClip!==d&&(this._nearClip=d,this._projMatDirty=
!0)}},{key:"node",get:function(){return this._node},set:function(d){this._node=d}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(d){this._orthoHeight!==d&&(this._orthoHeight=d,this._projMatDirty=!0)}},{key:"projection",get:function(){return this._projection},set:function(d){this._projection!==d&&(this._projection=d,this._projMatDirty=!0)}},{key:"projectionMatrix",get:function(){this._evaluateProjectionMatrix();return this._projMat}},{key:"rect",get:function(){return this._rect},
set:function(d){this._rect.copy(d)}},{key:"renderTarget",get:function(){return this._renderTarget},set:function(d){this._renderTarget=d}},{key:"scissorRect",get:function(){return this._scissorRect},set:function(d){this._scissorRect.copy(d)}},{key:"viewMatrix",get:function(){if(this._viewMatDirty){var d=this._node.getWorldTransform();this._viewMat.copy(d).invert();this._viewMatDirty=!1}return this._viewMat}},{key:"vrDisplay",get:function(){return this._vrDisplay},set:function(d){if(this._vrDisplay=
d)d._camera=this}}]);return l}(),Hj=new M,$g=new A,Ij=new ea,ah=new ea,Jj=new A,Kj=new A,no=new M,oo=new ea,gb=new A,Lj=new M,Wa=new ea,gd=new ea,Mj=new M,bh=new A,of=new A,pa=function(l){function g(b){var a=l.call(this)||this;a.name="string"===typeof b?b:"Untitled";a.tags=new Ng(F(a));a._labels={};a.localPosition=new A(0,0,0);a.localRotation=new ea(0,0,0,1);a.localScale=new A(1,1,1);a.localEulerAngles=new A(0,0,0);a.position=new A(0,0,0);a.rotation=new ea(0,0,0,1);a.eulerAngles=new A(0,0,0);a._scale=
null;a.localTransform=new M;a._dirtyLocal=!1;a._aabbVer=0;a._frozen=!1;a.worldTransform=new M;a._dirtyWorld=!1;a.normalMatrix=new lb;a._dirtyNormal=!0;a._right=null;a._up=null;a._forward=null;a._parent=null;a._children=[];a._graphDepth=0;a._enabled=!0;a._enabledInHierarchy=!1;a.scaleCompensation=!1;return a}K(g,l);var d=g.prototype;d._notifyHierarchyStateChanged=function(b,a){b._onHierarchyStateChanged(a);b=b._children;for(var c=0,e=b.length;c<e;c++)b[c]._enabled&&this._notifyHierarchyStateChanged(b[c],
a)};d._onHierarchyStateChanged=function(b){(this._enabledInHierarchy=b)&&!this._frozen&&this._unfreezeParentToRoot()};d._cloneInternal=function(b){b.name=this.name;for(var a=this.tags._list,c=0;c<a.length;c++)b.tags.add(a[c]);b._labels=Object.assign({},this._labels);b.localPosition.copy(this.localPosition);b.localRotation.copy(this.localRotation);b.localScale.copy(this.localScale);b.localEulerAngles.copy(this.localEulerAngles);b.position.copy(this.position);b.rotation.copy(this.rotation);b.eulerAngles.copy(this.eulerAngles);
b.localTransform.copy(this.localTransform);b._dirtyLocal=this._dirtyLocal;b.worldTransform.copy(this.worldTransform);b._dirtyWorld=this._dirtyWorld;b._dirtyNormal=this._dirtyNormal;b._aabbVer=this._aabbVer+1;b._enabled=this._enabled;b.scaleCompensation=this.scaleCompensation;b._enabledInHierarchy=!1};d.clone=function(){var b=new g;this._cloneInternal(b);return b};d.find=function(b,a){var c=[],e=this._children.length,f;if(b instanceof Function)for((a=b(this))&&c.push(this),f=0;f<e;f++){var h=this._children[f].find(b);
h.length&&(c=c.concat(h))}else for(this[b]&&(f=this[b]instanceof Function?this[b]():this[b],f===a&&c.push(this)),f=0;f<e;++f)h=this._children[f].find(b,a),h.length&&(c=c.concat(h));return c};d.findOne=function(b,a){var c,e=this._children.length,f;if(b instanceof Function){if(f=b(this))return this;for(c=0;c<e;c++)if(f=this._children[c].findOne(b))return f}else{if(this[b]&&(c=this[b]instanceof Function?this[b]():this[b],c===a))return this;for(c=0;c<e;c++)if(f=this._children[c].findOne(b,a),null!==f)return f}return null};
d.findByTag=function(){var b=this.tags._processArguments(arguments);return this._findByTag(b)};d._findByTag=function(b){var a=[],c,e=this._children.length;for(c=0;c<e;c++){this._children[c].tags._has(b)&&a.push(this._children[c]);var f=this._children[c]._findByTag(b);f.length&&(a=a.concat(f))}return a};d.findByName=function(b){if(this.name===b)return this;for(var a=0;a<this._children.length;a++){var c=this._children[a].findByName(b);if(null!==c)return c}return null};d.findByPath=function(b){b=b.split("/");
for(var a=this,c=null,e=0,f=b.length;e<f&&a;e++){var h=b[e];c=null;a=a._children;for(var k=0,m=a.length;k<m;k++)if(a[k].name==h){c=a[k];break}a=c}return c};d.forEach=function(b,a){b.call(a,this);for(var c=this._children,e=0;e<c.length;e++)c[e].forEach(b,a)};d.isDescendantOf=function(b){for(var a=this._parent;a;){if(a===b)return!0;a=a._parent}return!1};d.isAncestorOf=function(b){return b.isDescendantOf(this)};d.getEulerAngles=function(){this.getWorldTransform().getEulerAngles(this.eulerAngles);return this.eulerAngles};
d.getLocalEulerAngles=function(){this.localRotation.getEulerAngles(this.localEulerAngles);return this.localEulerAngles};d.getLocalPosition=function(){return this.localPosition};d.getLocalRotation=function(){return this.localRotation};d.getLocalScale=function(){return this.localScale};d.getLocalTransform=function(){this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1);return this.localTransform};d.getPosition=function(){this.getWorldTransform().getTranslation(this.position);
return this.position};d.getRotation=function(){this.rotation.setFromMat4(this.getWorldTransform());return this.rotation};d.getScale=function(){this._scale||(this._scale=new A);return this.getWorldTransform().getScale(this._scale)};d.getWorldTransform=function(){if(!this._dirtyLocal&&!this._dirtyWorld)return this.worldTransform;this._parent&&this._parent.getWorldTransform();this._sync();return this.worldTransform};d.reparent=function(b,a){var c=this._parent;c&&c.removeChild(this);b&&(0<=a?b.insertChild(this,
a):b.addChild(this))};d.setLocalEulerAngles=function(b,a,c){b instanceof A?this.localRotation.setFromEulerAngles(b.x,b.y,b.z):this.localRotation.setFromEulerAngles(b,a,c);this._dirtyLocal||this._dirtifyLocal()};d.setLocalPosition=function(b,a,c){b instanceof A?this.localPosition.copy(b):this.localPosition.set(b,a,c);this._dirtyLocal||this._dirtifyLocal()};d.setLocalRotation=function(b,a,c,e){b instanceof ea?this.localRotation.copy(b):this.localRotation.set(b,a,c,e);this._dirtyLocal||this._dirtifyLocal()};
d.setLocalScale=function(b,a,c){b instanceof A?this.localScale.copy(b):this.localScale.set(b,a,c);this._dirtyLocal||this._dirtifyLocal()};d._dirtifyLocal=function(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())};d._unfreezeParentToRoot=function(){for(var b=this._parent;b;)b._frozen=!1,b=b._parent};d._dirtifyWorld=function(){this._dirtyWorld||this._unfreezeParentToRoot();this._dirtifyWorldInternal()};d._dirtifyWorldInternal=function(){if(!this._dirtyWorld){this._frozen=
!1;this._dirtyWorld=!0;for(var b=0;b<this._children.length;b++)this._children[b]._dirtyWorld||this._children[b]._dirtifyWorldInternal()}this._dirtyNormal=!0;this._aabbVer++};d.setPosition=function(b,a,c){b instanceof A?gb.copy(b):gb.set(b,a,c);null===this._parent?this.localPosition.copy(gb):(Lj.copy(this._parent.getWorldTransform()).invert(),Lj.transformPoint(gb,this.localPosition));this._dirtyLocal||this._dirtifyLocal()};d.setRotation=function(b,a,c,e){b instanceof ea?Wa.copy(b):Wa.set(b,a,c,e);
null===this._parent?this.localRotation.copy(Wa):(b=this._parent.getRotation(),gd.copy(b).invert(),this.localRotation.copy(gd).mul(Wa));this._dirtyLocal||this._dirtifyLocal()};d.setEulerAngles=function(b,a,c){b instanceof A?this.localRotation.setFromEulerAngles(b.x,b.y,b.z):this.localRotation.setFromEulerAngles(b,a,c);null!==this._parent&&(b=this._parent.getRotation(),gd.copy(b).invert(),this.localRotation.mul2(gd,this.localRotation));this._dirtyLocal||this._dirtifyLocal()};d.addChild=function(b){if(null!==
b._parent)throw Error("GraphNode is already parented");this._children.push(b);this._onInsertChild(b)};d.addChildAndSaveTransform=function(b){var a=b.getPosition(),c=b.getRotation(),e=b._parent;e&&e.removeChild(b);b.setPosition(no.copy(this.worldTransform).invert().transformPoint(a));b.setRotation(oo.copy(this.getRotation()).invert().mul(c));this._children.push(b);this._onInsertChild(b)};d.insertChild=function(b,a){if(null!==b._parent)throw Error("GraphNode is already parented");this._children.splice(a,
0,b);this._onInsertChild(b)};d._onInsertChild=function(b){b._parent=this;var a=b._enabled&&this.enabled;b._enabledInHierarchy!==a&&(b._enabledInHierarchy=a,b._notifyHierarchyStateChanged(b,a));b._updateGraphDepth();b._dirtifyWorld();this._frozen&&b._unfreezeParentToRoot();b.fire&&b.fire("insert",this);this.fire&&this.fire("childinsert",b)};d._updateGraphDepth=function(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(var b=0,a=this._children.length;b<a;b++)this._children[b]._updateGraphDepth()};
d.removeChild=function(b){var a,c=this._children.length;for(a=0;a<c;++a)if(this._children[a]===b){this._children.splice(a,1);b._parent=null;b.fire&&b.fire("remove",this);this.fire&&this.fire("childremove",b);break}};d._sync=function(){this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1);if(this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){var b=this._parent,a=this.localScale,
c=b;if(c){for(;c&&c.scaleCompensation;)c=c._parent;if(c&&(c=c._parent)){var e=c.worldTransform.getScale();Jj.mul2(e,this.localScale);a=Jj}}ah.setFromMat4(b.worldTransform);Ij.mul2(ah,this.localRotation);c=b.worldTransform;b.scaleCompensation&&(Kj.mul2(e,b.getLocalScale()),Hj.setTRS(b.worldTransform.getTranslation($g),ah,Kj),c=Hj);c.transformPoint(this.localPosition,$g);this.worldTransform.setTRS($g,Ij,a)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=
!1}};d.syncHierarchy=function(){if(this._enabled&&!this._frozen){this._frozen=!0;(this._dirtyLocal||this._dirtyWorld)&&this._sync();for(var b=this._children,a=0,c=b.length;a<c;a++)b[a].syncHierarchy()}};d.lookAt=function(b,a,c,e,f,h){void 0===e&&(e=0);void 0===f&&(f=1);void 0===h&&(h=0);if(b instanceof A)bh.copy(b),a instanceof A?of.copy(a):of.copy(A.UP);else{if(void 0===c)return;bh.set(b,a,c);of.set(e,f,h)}Mj.setLookAt(this.getPosition(),bh,of);Wa.setFromMat4(Mj);this.setRotation(Wa)};d.translate=
function(b,a,c){b instanceof A?gb.copy(b):gb.set(b,a,c);gb.add(this.getPosition());this.setPosition(gb)};d.translateLocal=function(b,a,c){b instanceof A?gb.copy(b):gb.set(b,a,c);this.localRotation.transformVector(gb,gb);this.localPosition.add(gb);this._dirtyLocal||this._dirtifyLocal()};d.rotate=function(b,a,c){b instanceof A?Wa.setFromEulerAngles(b.x,b.y,b.z):Wa.setFromEulerAngles(b,a,c);null===this._parent?this.localRotation.mul2(Wa,this.localRotation):(b=this.getRotation(),a=this._parent.getRotation(),
gd.copy(a).invert(),Wa.mul2(gd,Wa),this.localRotation.mul2(Wa,b));this._dirtyLocal||this._dirtifyLocal()};d.rotateLocal=function(b,a,c){b instanceof A?Wa.setFromEulerAngles(b.x,b.y,b.z):Wa.setFromEulerAngles(b,a,c);this.localRotation.mul(Wa);this._dirtyLocal||this._dirtifyLocal()};N(g,[{key:"right",get:function(){this._right||(this._right=new A);return this.getWorldTransform().getX(this._right).normalize()}},{key:"up",get:function(){this._up||(this._up=new A);return this.getWorldTransform().getY(this._up).normalize()}},
{key:"forward",get:function(){this._forward||(this._forward=new A);return this.getWorldTransform().getZ(this._forward).normalize().scale(-1)}},{key:"enabled",get:function(){return this._enabled&&this._enabledInHierarchy},set:function(b){this._enabled!==b&&(this._enabled=b,this._parent&&!this._parent.enabled||this._notifyHierarchyStateChanged(this,b))}},{key:"parent",get:function(){return this._parent}},{key:"path",get:function(){var b=this._parent;if(b){for(var a=this.name;b&&b._parent;)a=b.name+
"/"+a,b=b._parent;return a}return""}},{key:"root",get:function(){var b=this._parent;if(!b)return this;for(;b._parent;)b=b._parent;return b}},{key:"children",get:function(){return this._children}},{key:"graphDepth",get:function(){return this._graphDepth}}]);return g}(ba),ch,dh,pf,qf,po=[null,function(l,g){return l.drawOrder-g.drawOrder},function(l,g){ch=l._key[0];dh=g._key[0];return ch===dh&&l.mesh&&g.mesh?g.mesh.id-l.mesh.id:dh-ch},function(l,g){return g.zdist-l.zdist},function(l,g){return l.zdist-
g.zdist}],eh=0,Nj=function(){this.list=[];this.length=0;this.done=!1},qo=function(){function l(){this.opaqueMeshInstances=[];this.transparentMeshInstances=[];this.shadowCasters=[];this.visibleOpaque=[];this.visibleTransparent=[]}l.prototype.clearVisibleLists=function(g){this.visibleOpaque[g]&&(this.visibleOpaque[g].length=0,this.visibleOpaque[g].list.length=0);this.visibleTransparent[g]&&(this.visibleTransparent[g].length=0,this.visibleTransparent[g].list.length=0)};return l}(),nb=function(){function l(d){void 0===
d&&(d={});void 0!==d.id?(this.id=d.id,eh=Math.max(this.id+1,eh)):this.id=eh++;this.name=d.name;this._refCounter=(this._enabled=void 0===d.enabled?!0:d.enabled)?1:0;this.opaqueSortMode=void 0===d.opaqueSortMode?2:d.opaqueSortMode;this.transparentSortMode=void 0===d.transparentSortMode?3:d.transparentSortMode;this.renderTarget=d.renderTarget;this.shaderPass=void 0===d.shaderPass?0:d.shaderPass;this.passThrough=void 0===d.passThrough?!1:d.passThrough;this.overrideClear=void 0===d.overrideClear?!1:d.overrideClear;
this._clearColor=new Q(0,0,0,1);d.clearColor&&this._clearColor.copy(d.clearColor);this._clearColorBuffer=void 0===d.clearColorBuffer?!1:d.clearColorBuffer;this._clearDepthBuffer=void 0===d.clearDepthBuffer?!1:d.clearDepthBuffer;this._clearStencilBuffer=void 0===d.clearStencilBuffer?!1:d.clearStencilBuffer;this._clearOptions={color:[this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a],depth:1,stencil:0,flags:(this._clearColorBuffer?1:0)|(this._clearDepthBuffer?2:0)|(this._clearStencilBuffer?
4:0)};this.onPreCull=d.onPreCull;this.onPreRender=d.onPreRender;this.onPreRenderOpaque=d.onPreRenderOpaque;this.onPreRenderTransparent=d.onPreRenderTransparent;this.onPostCull=d.onPostCull;this.onPostRender=d.onPostRender;this.onPostRenderOpaque=d.onPostRenderOpaque;this.onPostRenderTransparent=d.onPostRenderTransparent;this.onDrawCall=d.onDrawCall;this.onEnable=d.onEnable;this.onDisable=d.onDisable;if(this._enabled&&this.onEnable)this.onEnable();this.instances=(this.layerReference=d.layerReference)?
d.layerReference.instances:new qo;this.cullingMask=d.cullingMask?d.cullingMask:4294967295;this.opaqueMeshInstances=this.instances.opaqueMeshInstances;this.transparentMeshInstances=this.instances.transparentMeshInstances;this.shadowCasters=this.instances.shadowCasters;this.customCalculateSortValues=this.customSortCallback=null;this._lightComponents=[];this._lights=[];this._splitLights=[[],[],[]];this.cameras=[];this._dirtyCameras=this._dirtyLights=this._dirty=!1;this._staticLightHash=this._lightHash=
this._cameraHash=0;this._needsStaticPrepare=!0;this._staticPrepareDone=!1;this._shaderVersion=-1;this._version=0;this._lightCube=null}var g=l.prototype;g._updateClearFlags=function(){var d=0;this._clearColorBuffer&&(d|=1);this._clearDepthBuffer&&(d|=2);this._clearStencilBuffer&&(d|=4);this._clearOptions.flags=d};g.incrementCounter=function(){if(0===this._refCounter&&(this._enabled=!0,this.onEnable))this.onEnable();this._refCounter++};g.decrementCounter=function(){if(1===this._refCounter){if(this._enabled=
!1,this.onDisable)this.onDisable()}else if(0===this._refCounter)return;this._refCounter--};g.addMeshInstances=function(d,b){for(var a=this._shaderVersion,c,e,f,h=this.shadowCasters,k=0;k<d.length;k++)c=d[k],f=c.material,e=3===f.blendType?this.opaqueMeshInstances:this.transparentMeshInstances,0>this.opaqueMeshInstances.indexOf(c)&&0>this.transparentMeshInstances.indexOf(c)&&e.push(c),!b&&c.castShadow&&0>h.indexOf(c)&&h.push(c),!this.passThrough&&0<=a&&f._shaderVersion!==a&&(f.updateShader!==Fa.prototype.updateShader&&
(f.clearVariants(),f.shader=null),f._shaderVersion=a);this.passThrough||(this._dirty=!0)};g.removeMeshInstanceFromArray=function(d,b){for(var a,c=-1,e=0,f=b.length,h=0;h<f;h++){a=b[h];if(a===d){c=h;e=1;break}if(a._staticSource===d)0>c&&(c=h),e++;else if(0<=c)break}0<=c&&b.splice(c,e)};g.removeMeshInstances=function(d,b){for(var a,c=this.opaqueMeshInstances,e=this.transparentMeshInstances,f=this.shadowCasters,h=0;h<d.length;h++)a=d[h],this.removeMeshInstanceFromArray(a,c),this.removeMeshInstanceFromArray(a,
e),b||(a=f.indexOf(a),0<=a&&f.splice(a,1));this._dirty=!0};g.clearMeshInstances=function(d){if(0!==this.opaqueMeshInstances.length||0!==this.transparentMeshInstances.length||!d&&0!==this.shadowCasters.length)this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,d||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0)};g.addLight=function(d){0<=this._lightComponents.indexOf(d)||(this._lightComponents.push(d),this._lights.push(d.light),this._dirtyLights=!0,this._generateLightHash())};
g.removeLight=function(d){var b=this._lightComponents.indexOf(d);0>b||(this._lightComponents.splice(b,1),b=this._lights.indexOf(d.light),this._lights.splice(b,1),this._dirtyLights=!0,this._generateLightHash())};g.clearLights=function(){this._lightComponents.length=0;this._lights.length=0;this._dirtyLights=!0};g.addShadowCasters=function(d){for(var b,a=this.shadowCasters,c=0;c<d.length;c++)b=d[c],b.castShadow&&0>a.indexOf(b)&&a.push(b);this._dirtyLights=!0};g.removeShadowCasters=function(d){for(var b,
a=this.shadowCasters,c=0;c<d.length;c++)b=a.indexOf(d[c]),0<=b&&a.splice(b,1);this._dirtyLights=!0};g._generateLightHash=function(){if(0<this._lights.length){this._lights.sort(Cn);for(var d="",b="",a=0;a<this._lights.length;a++)this._lights[a].isStatic?b+=this._lights[a].key:d+=this._lights[a].key;this._lightHash=0===d.length?0:Xc(d);this._staticLightHash=0===b.length?0:Xc(b)}else this._staticLightHash=this._lightHash=0};g._generateCameraHash=function(){if(1<this.cameras.length){this.cameras.sort(Bn);
for(var d="",b=0;b<this.cameras.length;b++)d+=this.cameras[b].entity.getGuid();this._cameraHash=Xc(d)}else this._cameraHash=0;this._dirtyCameras=!0};g.addCamera=function(d){0<=this.cameras.indexOf(d)||(this.cameras.push(d),this._generateCameraHash())};g.removeCamera=function(d){d=this.cameras.indexOf(d);0>d||(this.cameras.splice(d,1),this._generateCameraHash(),this.instances.clearVisibleLists(d))};g.clearCameras=function(){this._cameraHash=this.cameras.length=0;this._dirtyCameras=!0};g._sortCameras=
function(){this._generateCameraHash()};g._calculateSortDistances=function(d,b,a,c){var e;for(e=0;e<b;e++){var f=d[e];if(!(f.command||2>=f.layer))if(f.calculateSortDistance)f.zdist=f.calculateSortDistance(f,a,c);else{var h=f.aabb.center;var k=h.x-a.x;var m=h.y-a.y;h=h.z-a.z;f.zdist=k*c.x+m*c.y+h*c.z}}};g._sortVisible=function(d,b,a){var c=this.instances,e=d?this.transparentSortMode:this.opaqueSortMode;if(0!==e)if(d=d?c.visibleTransparent[a]:c.visibleOpaque[a],5===e)pf=b.getPosition(),qf=b.forward,
this.customCalculateSortValues&&this.customCalculateSortValues(d.list,d.length,pf,qf),d.list.length!==d.length&&(d.list.length=d.length),this.customSortCallback&&d.list.sort(this.customSortCallback);else{if(3===e||4===e)pf=b.getPosition(),qf=b.forward,this._calculateSortDistances(d.list,d.length,pf,qf);d.list.length!==d.length&&(d.list.length=d.length);d.list.sort(po[e])}};N(l,[{key:"renderTarget",get:function(){return this._renderTarget},set:function(d){this._renderTarget=d;this._dirtyCameras=!0}},
{key:"enabled",get:function(){return this._enabled},set:function(d){if(d!==this._enabled)if(this._enabled=d){if(this.incrementCounter(),this.onEnable)this.onEnable()}else if(this.decrementCounter(),this.onDisable)this.onDisable()}},{key:"clearColor",get:function(){return this._clearColor},set:function(d){this._clearColor.copy(d)}},{key:"clearColorBuffer",get:function(){return this._clearColorBuffer},set:function(d){this._clearColorBuffer=d;this._updateClearFlags()}},{key:"clearDepthBuffer",get:function(){return this._clearDepthBuffer},
set:function(d){this._clearDepthBuffer=d;this._updateClearFlags()}},{key:"clearStencilBuffer",get:function(){return this._clearStencilBuffer},set:function(d){this._clearStencilBuffer=d;this._updateClearFlags()}}]);return l}(),Oj=(new M).mul2((new M).setTranslate(.5,.5,.5),(new M).setScale(.5,.5,.5)),ro={r:1,g:2,b:3,a:4},Pj=[(new ea).setFromEulerAngles(0,90,180),(new ea).setFromEulerAngles(0,-90,180),(new ea).setFromEulerAngles(90,0,0),(new ea).setFromEulerAngles(-90,0,0),(new ea).setFromEulerAngles(0,
180,180),(new ea).setFromEulerAngles(0,0,180)],Ki=[{},{},{},{},{}],Jc=new Float32Array(2),ce={x:1,y:1,z:0,w:0},Kc=new M,rf=new M,Qj=new M,ob=new M,$a=new M,Rj=new lb,zb=new M,pb,Rb=new M,Sb=new M,hd=new M,id=new M,jd=new A,kd=new A,de,ee,Sj=new M,Tj=new M,Uj=new M,Vj=new M,jc=new A,sf=new A,tf=new A,Wj=new A,Lc={center:null,radius:0},uf=new la,fe=[0,0,0,0],ld,hb,fh,vf,Mi={},md,nd,wf=null,gh=0,od=new Set,na=[],Xj=0;8>Xj;Xj++)na.push(new A);var ra=[new A,new A,new A,new A,new A,new A,new A,new A],hh=
function(){function l(d){d=this.device=d;this._layerCompositionUpdateTime=this._instancingTime=this._morphTime=this._skinTime=this._sortTime=this._cullTime=this._forwardTime=this._depthMapTime=this._shadowMapTime=this._shadowMapUpdates=this._materialSwitches=this._camerasRendered=this._skinDrawCalls=this._forwardDrawCalls=this._shadowDrawCalls=0;this.library=d.getProgramLibrary();d=d.scope;this.projId=d.resolve("matrix_projection");this.projSkyboxId=d.resolve("matrix_projectionSkybox");this.viewId=
d.resolve("matrix_view");this.viewId3=d.resolve("matrix_view3");this.viewInvId=d.resolve("matrix_viewInverse");this.viewProjId=d.resolve("matrix_viewProjection");this.viewPos=new Float32Array(3);this.viewPosId=d.resolve("view_position");this.nearClipId=d.resolve("camera_near");this.farClipId=d.resolve("camera_far");this.cameraParamsId=d.resolve("camera_params");this.shadowMapLightRadiusId=d.resolve("light_radius");this.fogColorId=d.resolve("fog_color");this.fogStartId=d.resolve("fog_start");this.fogEndId=
d.resolve("fog_end");this.fogDensityId=d.resolve("fog_density");this.modelMatrixId=d.resolve("matrix_model");this.normalMatrixId=d.resolve("matrix_normal");this.poseMatrixId=d.resolve("matrix_pose[0]");this.boneTextureId=d.resolve("texture_poseMap");this.boneTextureSizeId=d.resolve("texture_poseMapSize");this.morphWeightsA=d.resolve("morph_weights_a");this.morphWeightsB=d.resolve("morph_weights_b");this.morphPositionTex=d.resolve("morphPositionTex");this.morphNormalTex=d.resolve("morphNormalTex");
this.morphTexParams=d.resolve("morph_tex_params");this.alphaTestId=d.resolve("alpha_ref");this.opacityMapId=d.resolve("texture_opacityMap");this.ambientId=d.resolve("light_globalAmbient");this.exposureId=d.resolve("exposure");this.skyboxIntensityId=d.resolve("skyboxIntensity");this.lightColorId=[];this.lightDir=[];this.lightDirId=[];this.lightShadowMapId=[];this.lightShadowMatrixId=[];this.lightShadowParamsId=[];this.lightShadowMatrixVsId=[];this.lightShadowParamsVsId=[];this.lightDirVs=[];this.lightDirVsId=
[];this.lightRadiusId=[];this.lightPos=[];this.lightPosId=[];this.lightWidth=[];this.lightWidthId=[];this.lightHeight=[];this.lightHeightId=[];this.lightInAngleId=[];this.lightOutAngleId=[];this.lightPosVsId=[];this.lightCookieId=[];this.lightCookieIntId=[];this.lightCookieMatrixId=[];this.lightCookieOffsetId=[];this.depthMapId=d.resolve("uDepthMap");this.screenSizeId=d.resolve("uScreenSize");this._screenSize=new Float32Array(4);this.sourceId=d.resolve("source");this.pixelOffsetId=d.resolve("pixelOffset");
this.weightId=d.resolve("weight[0]");this.blurVsmShaderCode=[I.blurVSMPS,"#define GAUSS\n"+I.blurVSMPS];this.blurPackedVsmShaderCode=["#define PACKED\n"+this.blurVsmShaderCode[0],"#define PACKED\n"+this.blurVsmShaderCode[1]];this.blurVsmShader=[{},{}];this.blurPackedVsmShader=[{},{}];this.blurVsmWeights={};this.twoSidedLightingNegScaleFactorId=d.resolve("twoSidedLightingNegScaleFactor");this.polygonOffsetId=d.resolve("polygonOffset");this.polygonOffset=new Float32Array(2);this.fogColor=new Float32Array(3);
this.ambientColor=new Float32Array(3);this.cameraParams=new Float32Array(4)}var g=l.prototype;g.sortCompare=function(d,b){if(d.layer===b.layer){if(d.drawOrder&&b.drawOrder)return d.drawOrder-b.drawOrder;if(d.zdist&&b.zdist)return b.zdist-d.zdist;if(d.zdist2&&b.zdist2)return d.zdist2-b.zdist2}return b._key[0]-d._key[0]};g.sortCompareMesh=function(d,b){if(d.layer===b.layer){if(d.drawOrder&&b.drawOrder)return d.drawOrder-b.drawOrder;if(d.zdist&&b.zdist)return b.zdist-d.zdist}md=d._key[0];nd=b._key[0];
return md===nd&&d.mesh&&b.mesh?b.mesh.id-d.mesh.id:nd-md};g.depthSortCompare=function(d,b){md=d._key[1];nd=b._key[1];return md===nd&&d.mesh&&b.mesh?b.mesh.id-d.mesh.id:nd-md};g.lightCompare=function(d,b){return d.key-b.key};g.getShadowCamera=function(d,b){var a=b._shadowCamera;if(null===a){a=b._shadowType;var c=4===a||0===a&&d.webgl2;1===b._type&&(c=!1);var e=new be;e.clearColor=1<=a&&3>=a?new Q(0,0,0,0):new Q(1,1,1,1);e.clearColorBuffer=!c;e.clearDepthBuffer=!0;e.clearStencilBuffer=!1;e.node=new pa;
a=b._shadowCamera=e;Li(d,b)}else c=a.renderTarget,c.width===b._shadowResolution&&c.height===b._shadowResolution||Li(d,b);return a};g.updateCameraFrustum=function(d){if(d.vrDisplay&&d.vrDisplay.presenting){pb=d.vrDisplay.combinedProj;var b=d._node.parent;b?$a.copy(b.getWorldTransform()).mul(d.vrDisplay.combinedViewInv).invert():$a.copy(d.vrDisplay.combinedView);ob.copy($a).invert();this.viewInvId.setValue(ob.data);zb.mul2(pb,$a);d.frustum.setFromMat4(zb)}else if(d.xr&&d.xr.views.length){b=d.xr.views[0];
zb.mul2(b.projMat,b.viewOffMat);d.frustum.setFromMat4(zb);return}pb=d.projectionMatrix;d.calculateProjection&&d.calculateProjection(pb,0);if(d.calculateTransform)d.calculateTransform(ob,0);else{b=d._node.getPosition();var a=d._node.getRotation();ob.setTRS(b,a,A.ONE);this.viewInvId.setValue(ob.data)}$a.copy(ob).invert();zb.mul2(pb,$a);d.frustum.setFromMat4(zb)};g.setCamera=function(d,b,a,c){var e=d.vrDisplay,f;if(e&&e.presenting){de=e.leftProj;ee=e.rightProj;pb=e.combinedProj;d.calculateProjection&&
(d.calculateProjection(de,1),d.calculateProjection(ee,2),d.calculateProjection(pb,0));if(d.calculateTransform)d.calculateTransform(Rb,1),d.calculateTransform(Sb,2),d.calculateTransform(ob,0),hd.copy(Rb).invert(),id.copy(Sb).invert(),$a.copy(ob).invert();else if(f=d._node.parent){var h=f.getWorldTransform();Rb.mul2(h,e.leftViewInv);Sb.mul2(h,e.rightViewInv);hd.copy(Rb).invert();id.copy(Sb).invert();$a.copy(f.getWorldTransform()).mul(e.combinedViewInv).invert()}else Rb.copy(e.leftViewInv),Sb.copy(e.rightViewInv),
hd.copy(e.leftView),id.copy(e.rightView),$a.copy(e.combinedView);Sj.setFromMat4(hd);Tj.setFromMat4(id);Uj.mul2(de,hd);Vj.mul2(ee,id);jd.x=Rb.data[12];jd.y=Rb.data[13];jd.z=Rb.data[14];kd.x=Sb.data[12];kd.y=Sb.data[13];kd.z=Sb.data[14];zb.mul2(pb,$a);d.frustum.setFromMat4(zb)}else if(d.xr&&d.xr.session){(f=d._node.parent)&&(h=f.getWorldTransform());e=d.xr.views;for(var k=0;k<e.length;k++){var m=e[k];f?(m.viewInvOffMat.mul2(h,m.viewInvMat),m.viewOffMat.copy(m.viewInvOffMat).invert()):(m.viewInvOffMat.copy(m.viewInvMat),
m.viewOffMat.copy(m.viewMat));m.viewMat3.setFromMat4(m.viewOffMat);m.projViewOffMat.mul2(m.projMat,m.viewOffMat);m.position[0]=m.viewInvOffMat.data[12];m.position[1]=m.viewInvOffMat.data[13];m.position[2]=m.viewInvOffMat.data[14];d.frustum.setFromMat4(m.projViewOffMat)}}else pb=d.projectionMatrix,d.calculateProjection&&d.calculateProjection(pb,0),this.projId.setValue(pb.data),this.projSkyboxId.setValue(d.getProjectionMatrixSkybox().data),d.calculateTransform?d.calculateTransform(ob,0):(f=d._node.getPosition(),
h=d._node.getRotation(),ob.setTRS(f,h,A.ONE)),this.viewInvId.setValue(ob.data),$a.copy(ob).invert(),this.viewId.setValue($a.data),Rj.setFromMat4($a),this.viewId3.setValue(Rj.data),zb.mul2(pb,$a),this.viewProjId.setValue(zb.data),f=d._node.getPosition(),this.viewPos[0]=f.x,this.viewPos[1]=f.y,this.viewPos[2]=f.z,this.viewPosId.setValue(this.viewPos),d.frustum.setFromMat4(zb);this.nearClipId.setValue(d._nearClip);this.farClipId.setValue(d._farClip);f=d._nearClip;h=d._farClip;this.cameraParams[0]=1/
h;this.cameraParams[1]=h;this.cameraParams[2]=.5*(1-h/f);this.cameraParams[3]=.5*(1+h/f);this.cameraParamsId.setValue(this.cameraParams);this.clearView(d,b,a,!1);a=this.device;f=b?b.width:a.width;b=b?b.height:a.height;d=d.scissorRect;a.setScissor(Math.floor(d.x*f),Math.floor(d.y*b),Math.floor(d.z*f),Math.floor(d.w*b));c&&a.setScissor(1,1,f-2,b-2)};g.clearView=function(d,b,a,c,e){var f=this.device;f.setRenderTarget(b);f.updateBegin();c&&(f.setColorWrite(!0,!0,!0,!0),f.setDepthWrite(!0));c=d.rect;var h=
b?b.width:f.width,k=b?b.height:f.height;b=Math.floor(c.x*h);var m=Math.floor(c.y*k);h=Math.floor(c.z*h);c=Math.floor(c.w*k);f.setViewport(b,m,h,c);f.setScissor(b,m,h,c);a&&(e||(e=d._clearOptions),f.clear(e?e:{color:[d._clearColor.r,d._clearColor.g,d._clearColor.b,d._clearColor.a],depth:d._clearDepth,flags:(d._clearColorBuffer?1:0)|(d._clearDepthBuffer?2:0)|(d._clearStencilBuffer?4:0),stencil:d._clearStencil}))};g.dispatchGlobalLights=function(d){var b;this.mainLight=-1;this.ambientColor[0]=d.ambientLight.r;
this.ambientColor[1]=d.ambientLight.g;this.ambientColor[2]=d.ambientLight.b;if(d.gammaCorrection)for(b=0;3>b;b++)this.ambientColor[b]=Math.pow(this.ambientColor[b],2.2);this.ambientId.setValue(this.ambientColor);this.exposureId.setValue(d.exposure);d.skyboxModel&&this.skyboxIntensityId.setValue(d.skyboxIntensity)};g._resolveLight=function(d,b){var a="light"+b;this.lightColorId[b]=d.resolve(a+"_color");this.lightDir[b]=new Float32Array(3);this.lightDirId[b]=d.resolve(a+"_direction");this.lightShadowMapId[b]=
d.resolve(a+"_shadowMap");this.lightShadowMatrixId[b]=d.resolve(a+"_shadowMatrix");this.lightShadowParamsId[b]=d.resolve(a+"_shadowParams");this.lightShadowMatrixVsId[b]=d.resolve(a+"_shadowMatrixVS");this.lightShadowParamsVsId[b]=d.resolve(a+"_shadowParamsVS");this.lightDirVs[b]=new Float32Array(3);this.lightDirVsId[b]=d.resolve(a+"_directionVS");this.lightRadiusId[b]=d.resolve(a+"_radius");this.lightPos[b]=new Float32Array(3);this.lightPosId[b]=d.resolve(a+"_position");this.lightWidth[b]=new Float32Array(3);
this.lightWidthId[b]=d.resolve(a+"_halfWidth");this.lightHeight[b]=new Float32Array(3);this.lightHeightId[b]=d.resolve(a+"_halfHeight");this.lightInAngleId[b]=d.resolve(a+"_innerConeAngle");this.lightOutAngleId[b]=d.resolve(a+"_outerConeAngle");this.lightPosVsId[b]=d.resolve(a+"_positionVS");this.lightCookieId[b]=d.resolve(a+"_cookie");this.lightCookieIntId[b]=d.resolve(a+"_cookieIntensity");this.lightCookieMatrixId[b]=d.resolve(a+"_cookieMatrix");this.lightCookieOffsetId[b]=d.resolve(a+"_cookieOffset")};
g.setLTCDirectionallLight=function(d,b,a,c,e){this.lightPos[b][0]=c.x-a.x*e;this.lightPos[b][1]=c.y-a.y*e;this.lightPos[b][2]=c.z-a.z*e;this.lightPosId[b].setValue(this.lightPos[b]);a=d.transformVector(new A(-.5,0,0));this.lightWidth[b][0]=a.x*e;this.lightWidth[b][1]=a.y*e;this.lightWidth[b][2]=a.z*e;this.lightWidthId[b].setValue(this.lightWidth[b]);d=d.transformVector(new A(0,0,.5));this.lightHeight[b][0]=d.x*e;this.lightHeight[b][1]=d.y*e;this.lightHeight[b][2]=d.z*e;this.lightHeightId[b].setValue(this.lightHeight[b])};
g.dispatchDirectLights=function(d,b,a,c){var e=d.length,f,h=0;this.mainLight=-1;var k=this.device.scope;for(f=0;f<e;f++)if(d[f].mask&a){var m=d[f];var n=m._node.getWorldTransform();this.lightColorId[h]||this._resolveLight(k,h);this.lightColorId[h].setValue(b.gammaCorrection?m._linearFinalColor:m._finalColor);n.getY(m._direction).scale(-1);m._direction.normalize();this.lightDir[h][0]=m._direction.x;this.lightDir[h][1]=m._direction.y;this.lightDir[h][2]=m._direction.z;this.lightDirId[h].setValue(this.lightDir[h]);
0!==m.shape&&this.setLTCDirectionallLight(n,h,m._direction,c._node.getPosition(),c.farClip);if(m.castShadows){var p=m._isPcf&&this.device.webgl2?m._shadowCamera.renderTarget.depthBuffer:m._shadowCamera.renderTarget.colorBuffer;m._isVsm?n=-2E-4:(n=m.shadowBias/m._shadowCamera._farClip*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(n*=-100));var t=m._isVsm?m.vsmBias/(m._shadowCamera._farClip/7):m._normalOffsetBias;this.lightShadowMapId[h].setValue(p);this.lightShadowMatrixId[h].setValue(m._shadowMatrix.data);
p=m._rendererParams;3!==p.length&&(p.length=3);p[0]=m._shadowResolution;p[1]=t;p[2]=n;this.lightShadowParamsId[h].setValue(p);0>this.mainLight&&(this.lightShadowMatrixVsId[h].setValue(m._shadowMatrix.data),this.lightShadowParamsVsId[h].setValue(p),m._direction.normalize(),this.lightDirVs[h][0]=m._direction.x,this.lightDirVs[h][1]=m._direction.y,this.lightDirVs[h][2]=m._direction.z,this.lightDirVsId[h].setValue(this.lightDirVs[h]),this.mainLight=f)}h++}return h};g.setLTCPositionalLight=function(d,
b){var a=d.transformVector(new A(-.5,0,0));this.lightWidth[b][0]=a.x;this.lightWidth[b][1]=a.y;this.lightWidth[b][2]=a.z;this.lightWidthId[b].setValue(this.lightWidth[b]);d=d.transformVector(new A(0,0,.5));this.lightHeight[b][0]=d.x;this.lightHeight[b][1]=d.y;this.lightHeight[b][2]=d.z;this.lightHeightId[b].setValue(this.lightHeight[b])};g.dispatchOmniLight=function(d,b,a,c){var e=a._node.getWorldTransform();this.lightColorId[c]||this._resolveLight(b,c);this.lightRadiusId[c].setValue(a.attenuationEnd);
this.lightColorId[c].setValue(d.gammaCorrection?a._linearFinalColor:a._finalColor);e.getTranslation(a._position);this.lightPos[c][0]=a._position.x;this.lightPos[c][1]=a._position.y;this.lightPos[c][2]=a._position.z;this.lightPosId[c].setValue(this.lightPos[c]);0!==a.shape&&this.setLTCPositionalLight(e,c);a.castShadows&&(this.lightShadowMapId[c].setValue(a._shadowCamera.renderTarget.colorBuffer),d=a._rendererParams,4!==d.length&&(d.length=4),d[0]=a._shadowResolution,d[1]=a._normalOffsetBias,d[2]=a.shadowBias,
d[3]=1/a.attenuationEnd,this.lightShadowParamsId[c].setValue(d));a._cookie&&(this.lightCookieId[c].setValue(a._cookie),this.lightShadowMatrixId[c].setValue(e.data),this.lightCookieIntId[c].setValue(a.cookieIntensity))};g.dispatchSpotLight=function(d,b,a,c){var e=a._node.getWorldTransform();this.lightColorId[c]||this._resolveLight(b,c);this.lightInAngleId[c].setValue(a._innerConeAngleCos);this.lightOutAngleId[c].setValue(a._outerConeAngleCos);this.lightRadiusId[c].setValue(a.attenuationEnd);this.lightColorId[c].setValue(d.gammaCorrection?
a._linearFinalColor:a._finalColor);e.getTranslation(a._position);this.lightPos[c][0]=a._position.x;this.lightPos[c][1]=a._position.y;this.lightPos[c][2]=a._position.z;this.lightPosId[c].setValue(this.lightPos[c]);0!==a.shape&&this.setLTCPositionalLight(e,c);e.getY(a._direction).scale(-1);a._direction.normalize();this.lightDir[c][0]=a._direction.x;this.lightDir[c][1]=a._direction.y;this.lightDir[c][2]=a._direction.z;this.lightDirId[c].setValue(this.lightDir[c]);a.castShadows&&(a._isVsm?d=-2E-4:(d=
20*a.shadowBias,!this.device.webgl2&&this.device.extStandardDerivatives&&(d*=-100)),b=a._isVsm?a.vsmBias/(a.attenuationEnd/7):a._normalOffsetBias,this.lightShadowMapId[c].setValue(a._isPcf&&this.device.webgl2?a._shadowCamera.renderTarget.depthBuffer:a._shadowCamera.renderTarget.colorBuffer),this.lightShadowMatrixId[c].setValue(a._shadowMatrix.data),e=a._rendererParams,4!==e.length&&(e.length=4),e[0]=a._shadowResolution,e[1]=b,e[2]=d,e[3]=1/a.attenuationEnd,this.lightShadowParamsId[c].setValue(e));
a._cookie&&(this.lightCookieId[c].setValue(a._cookie),a.castShadows||(d=this.getShadowCamera(this.device,a),b=d._node,b.setPosition(a._node.getPosition()),b.setRotation(a._node.getRotation()),b.rotateLocal(-90,0,0),d.projection=0,d.aspectRatio=1,d.fov=2*a._outerConeAngle,Kc.setTRS(b.getPosition(),b.getRotation(),A.ONE).invert(),rf.mul2(d.projectionMatrix,Kc),a._shadowMatrix.mul2(Oj,rf)),this.lightShadowMatrixId[c].setValue(a._shadowMatrix.data),this.lightCookieIntId[c].setValue(a.cookieIntensity),
a._cookieTransform&&(a._cookieTransformUniform[0]=a._cookieTransform.x,a._cookieTransformUniform[1]=a._cookieTransform.y,a._cookieTransformUniform[2]=a._cookieTransform.z,a._cookieTransformUniform[3]=a._cookieTransform.w,this.lightCookieMatrixId[c].setValue(a._cookieTransformUniform),a._cookieOffsetUniform[0]=a._cookieOffset.x,a._cookieOffsetUniform[1]=a._cookieOffset.y,this.lightCookieOffsetId[c].setValue(a._cookieOffsetUniform)))};g.dispatchLocalLights=function(d,b,a,c,e){var f=d[1];d=d[2];var h=
f.length,k=d.length,m=c,n=this.device.scope;for(c=0;c<h;c++){var p=f[c];p.mask&a&&!p.isStatic&&(this.dispatchOmniLight(b,n,p,m),m++)}f=0;if(e)for(p=e[f];p&&1===p._type;)this.dispatchOmniLight(b,n,p,m),m++,f++,p=e[f];for(c=0;c<k;c++)p=d[c],p.mask&a&&!p.isStatic&&(this.dispatchSpotLight(b,n,p,m),m++);if(e)for(p=e[f];p&&2===p._type;)this.dispatchSpotLight(b,n,p,m),m++,f++,p=e[f]};g.cull=function(d,b,a){var c=0,e,f=b.length,h=d.cullingMask||4294967295;if(!d.frustumCulling){for(e=0;e<f;e++){var k=b[e];
if(k.visible||k.command)k.mask&&0===(k.mask&h)||(a[c]=k,c++,k.visibleThisFrame=!0)}return c}for(e=0;e<f;e++)if(k=b[e],k.command)a[c]=k,c++,k.visibleThisFrame=!0;else if(k.visible){var m=!0;k.mask&&0===(k.mask&h)||(k.cull&&(m=k._isVisible(d)),m&&(a[c]=k,c++,k.visibleThisFrame=!0))}return c};g.cullLights=function(d,b){var a;for(a=0;a<b.length;a++){var c=b[a];c.castShadows&&c.enabled&&0!==c.shadowUpdateMode&&0!==c._type&&(c.getBoundingSphere(Lc),d.frustum.containsSphere(Lc)&&(c.visibleThisFrame=!0))}};
g.updateCpuSkinMatrices=function(d){gh++;var b=d.length;if(0!==b){var a,c;for(a=0;a<b;a++)if(c=d[a].skinInstance)c.updateMatrices(d[a].node,gh),c._dirty=!0}};g.updateGpuSkinMatrices=function(d){var b,a,c=d.length;for(b=0;b<c;b++)d[b].visibleThisFrame&&(a=d[b].skinInstance)&&a._dirty&&(a.updateMatrixPalette(d[b].node,gh),a._dirty=!1)};g.updateMorphing=function(d){var b,a,c=d.length;for(b=0;b<c;b++)(a=d[b].morphInstance)&&a._dirty&&d[b].visibleThisFrame&&a.update()};g.setBaseConstants=function(d,b){d.setCullMode(b.cull);
b.opacityMap&&(this.opacityMapId.setValue(b.opacityMap),this.alphaTestId.setValue(b.alphaTest))};g.setSkinning=function(d,b,a){b.skinInstance&&(this._skinDrawCalls++,d.supportsBoneTextures?(ld=b.skinInstance.boneTexture,this.boneTextureId.setValue(ld),fe[0]=ld.width,fe[1]=ld.height,fe[2]=1/ld.width,fe[3]=1/ld.height,this.boneTextureSizeId.setValue(fe)):this.poseMatrixId.setValue(b.skinInstance.matrixPalette))};g.drawInstance=function(d,b,a,c,e){if(hb=b.instancingData){if(0<hb.count&&(this._instancedDrawCalls++,
d.setVertexBuffer(hb.vertexBuffer),d.draw(a.primitive[c],hb.count),hb.vertexBuffer===wf))return this._removedByInstancing+=hb.count,b.instancingData=null,hb.count-1}else fh=b.node.worldTransform,this.modelMatrixId.setValue(fh.data),e&&(vf=b.node.normalMatrix,b.node._dirtyNormal&&(fh.invertTo3x3(vf),vf.transpose(),b.node._dirtyNormal=!1),this.normalMatrixId.setValue(vf.data)),d.draw(a.primitive[c]);return 0};g.drawInstance2=function(d,b,a,c){if(hb=b.instancingData){if(0<hb.count&&(this._instancedDrawCalls++,
d.draw(a.primitive[c],hb.count,!0),hb.vertexBuffer===wf))return this._removedByInstancing+=hb.count,b.instancingData=null,hb.count-1}else d.draw(a.primitive[c],void 0,!0);return 0};g.renderShadows=function(d,b){var a=this.device;a.grabPassAvailable=!1;var c;for(c=0;c<d.length;c++){var e=d[c];var f=e._type;if(e.castShadows&&e.enabled&&(e._shadowCamera||this.getShadowCamera(a,e),0!==e.shadowUpdateMode&&e.visibleThisFrame)){var h=this.getShadowCamera(a,e);var k=h._node;var m=0;var n=1;if(0===f){if(0>
e._visibleLength[b])continue;m=e._visibleCameraSettings[b];k.setPosition(m.x,m.y,m.z);h.orthoHeight=m.orthoHeight;h.farClip=m.farClip;m=b}else if(2===f){var p=k.getPosition();this.viewPos[0]=p.x;this.viewPos[1]=p.y;this.viewPos[2]=p.z;this.viewPosId.setValue(this.viewPos);this.shadowMapLightRadiusId.setValue(e.attenuationEnd)}else 1===f&&(p=k.getPosition(),this.viewPos[0]=p.x,this.viewPos[1]=p.y,this.viewPos[2]=p.z,this.viewPosId.setValue(this.viewPos),this.shadowMapLightRadiusId.setValue(e.attenuationEnd),
n=6);1!==f&&(Kc.setTRS(k.getPosition(),k.getRotation(),A.ONE).invert(),rf.mul2(h.projectionMatrix,Kc),e._shadowMatrix.mul2(Oj,rf));a.webgl2?1===f?a.setDepthBias(!1):(a.setDepthBias(!0),a.setDepthBiasValues(-1E3*e.shadowBias,-1E3*e.shadowBias)):a.extStandardDerivatives&&(1===f?(this.polygonOffset[0]=0,this.polygonOffset[1]=0):(this.polygonOffset[0]=-1E3*e.shadowBias,this.polygonOffset[1]=-1E3*e.shadowBias),this.polygonOffsetId.setValue(this.polygonOffset));1===e.shadowUpdateMode&&(e.shadowUpdateMode=
0);this._shadowMapUpdates+=n;a.setBlending(!1);a.setDepthWrite(!0);a.setDepthTest(!0);e._isPcf&&a.webgl2&&1!==f?a.setColorWrite(!1,!1,!1,!1):a.setColorWrite(!0,!0,!0,!0);for(m?n=m+1:m=0;m<n;){1===f&&(k.setRotation(Pj[m]),h.renderTarget=e._shadowCubeMap[m]);this.setCamera(h,h.renderTarget,!0,1!==f);p=e._visibleList[m];var t=e._visibleLength[m];var r=e._shadowType;var u=r+5*f;for(r=0;r<t;r++){var v=p[r];var w=v.mesh;var y=v.material;this.setBaseConstants(a,y);this.setSkinning(a,v,y);y.dirty&&(y.updateUniforms(),
y.dirty=!1);y.chunks&&(this.setCullMode(!0,!1,v),y.setParameters(a),v.setParameters(a,8));y=v._shader[3+u];if(!y){this.updateShader(v,v._shaderDefs,null,3+u);y=v._shader[3+u];var x=v._key,z=v.material,B=v.skinInstance?10:0,C=0;z.opacityMap&&(z=z.opacityMapChannel)&&(C=ro[z]);x[1]=B+C}a.setShader(y);y=v.renderStyle;this.setVertexBuffers(a,w);this.setMorphing(a,v.morphInstance);a.setIndexBuffer(w.indexBuffer[y]);r+=this.drawInstance(a,v,w,y);this._shadowDrawCalls++}m++;0===f&&(e._visibleLength[b]=-1)}if(e._isVsm&&
(f=e._vsmBlurSize,1<f)){h=h.renderTarget;k=Ji(a,e._shadowResolution,e._shadowType,1);n=1===e._shadowType;m=e.vsmBlurMode;p=(n?this.blurPackedVsmShader:this.blurVsmShader)[m][f];if(!p){p=this.blurVsmWeights;y=r=f;25<y&&(y=25);x=(y-1)/6;u=.5*(y-1);v=Array(y);for(w=t=0;w<y;++w)B=w-u,v[w]=Math.exp(-(B*B)/(2*x*x)),t+=v[w];for(w=0;w<y;++w)v[w]/=t;p[r]=v;p=I.fullscreenQuadVS;r="#define SAMPLES "+f+"\n";r=n?r+this.blurPackedVsmShaderCode[m]:r+this.blurVsmShaderCode[m];p=Ja(this.device,p,r,"blurVsm"+m+f+n);
n?this.blurPackedVsmShader[m][f]=p:this.blurVsmShader[m][f]=p}ce.z=e._shadowResolution-2;ce.w=ce.z;this.sourceId.setValue(h.colorBuffer);Jc[0]=1/e._shadowResolution;Jc[1]=0;this.pixelOffsetId.setValue(Jc);1===m&&this.weightId.setValue(this.blurVsmWeights[f]);Ea(a,k,p,null,ce);this.sourceId.setValue(k.colorBuffer);Jc[1]=Jc[0];Jc[0]=0;this.pixelOffsetId.setValue(Jc);Ea(a,h,p,null,ce)}}}a.webgl2?a.setDepthBias(!1):a.extStandardDerivatives&&(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset));
a.grabPassAvailable=!0};g.updateShader=function(d,b,a,c,e){d.material._scene=this.scene;d.material._dirtyBlend&&(this.scene.layers._dirtyBlend=!0);d.material.updateShader(this.device,this.scene,b,a,c,e);d._shader[c]=d.material.shader};g.setCullMode=function(d,b,a){var c=a.material,e=0;d&&(d=1,0<c.cull&&3>c.cull&&(a.flipFaces&&(d*=-1),b&&(d*=-1),b=a.node.worldTransform,b.getX(jc),b.getY(sf),b.getZ(tf),jc.cross(jc,sf),0>jc.dot(tf)&&(d*=-1)),e=0>d?2===c.cull?1:2:c.cull);this.device.setCullMode(e);0===
e&&0===c.cull&&(a=a.node.worldTransform,a.getX(jc),a.getY(sf),a.getZ(tf),jc.cross(jc,sf),0>jc.dot(tf)?this.twoSidedLightingNegScaleFactorId.setValue(-1):this.twoSidedLightingNegScaleFactorId.setValue(1))};g.setVertexBuffers=function(d,b){d.setVertexBuffer(b.vertexBuffer)};g.setMorphing=function(d,b){if(b)if(b.morph.useTextureMorph)d.setVertexBuffer(b.morph.vertexBufferIds),this.morphPositionTex.setValue(b.texturePositions),this.morphNormalTex.setValue(b.textureNormals),this.morphTexParams.setValue(b._textureParams);
else{for(var a,c,e=0;e<b._activeVertexBuffers.length;e++)if(a=b._activeVertexBuffers[e])c="ATTR"+(e+8),a.format.elements[0].name=c,a.format.elements[0].scopeId=d.scope.resolve(c),a.format.update(),d.setVertexBuffer(a);this.morphWeightsA.setValue(b._shaderMorphWeightsA);this.morphWeightsB.setValue(b._shaderMorphWeightsB)}};g.renderForward=function(d,b,a,c,e,f,h,k){var m=this.device,n=this.scene,p=d.vrDisplay;k=k?k._lightHash:0;var t=1<<e,r,u=null,v=.5*m.width;for(r=0;r<a;r++){var w=b[r];if(!f||!w.mask||
f&w.mask)if(w.command)w.command();else{var y=w.mesh;var x=w.material;var z=w._shaderDefs;var B=w.mask;this.setSkinning(m,w,x);x&&x===u&&z!==C&&(u=null);if(w.isStatic||G)u=null;if(x!==u){this._materialSwitches++;x.dirty&&(x.updateUniforms(),x.dirty=!1);if(!w._shader[e]||w._shaderDefs!==z||w._lightHash!==k){if(w.isStatic)this.updateShader(w,z,w._staticLightList,e,c);else{var C=e+"_"+z+"_"+k;w._shader[e]=x.variants[C];w._shader[e]||(this.updateShader(w,z,null,e,c),x.variants[C]=w._shader[e])}w._shaderDefs=
z;w._lightHash=k}w._shader[e].failed||m.setShader(w._shader[e])||(w._shader[e].failed=!0);x.setParameters(m);if(!u||B!==D){var D=this.dispatchDirectLights(c[0],n,B,d);this.dispatchLocalLights(c,n,B,D,w._staticLightList)}this.alphaTestId.setValue(x.alphaTest);m.setBlending(x.blend);x.blend&&(x.separateAlphaBlend?(m.setBlendFunctionSeparate(x.blendSrc,x.blendDst,x.blendSrcAlpha,x.blendDstAlpha),m.setBlendEquationSeparate(x.blendEquation,x.blendAlphaEquation)):(m.setBlendFunction(x.blendSrc,x.blendDst),
m.setBlendEquation(x.blendEquation)));m.setColorWrite(x.redWrite,x.greenWrite,x.blueWrite,x.alphaWrite);m.setDepthWrite(x.depthWrite);x.depthWrite&&!x.depthTest?(m.setDepthFunc(7),m.setDepthTest(!0)):(m.setDepthFunc(3),m.setDepthTest(x.depthTest));m.setAlphaToCoverage(x.alphaToCoverage);x.depthBias||x.slopeDepthBias?(m.setDepthBias(!0),m.setDepthBiasValues(x.depthBias,x.slopeDepthBias)):m.setDepthBias(!1)}this.setCullMode(d._cullFaces,d._flipFaces,w);D=w.stencilFront||x.stencilFront;u=w.stencilBack||
x.stencilBack;D||u?(m.setStencilTest(!0),D===u?(m.setStencilFunc(D.func,D.ref,D.readMask),m.setStencilOperation(D.fail,D.zfail,D.zpass,D.writeMask)):(D?(m.setStencilFuncFront(D.func,D.ref,D.readMask),m.setStencilOperationFront(D.fail,D.zfail,D.zpass,D.writeMask)):(m.setStencilFuncFront(7,0,255),m.setStencilOperationFront(0,0,0,255)),u?(m.setStencilFuncBack(u.func,u.ref,u.readMask),m.setStencilOperationBack(u.fail,u.zfail,u.zpass,u.writeMask)):(m.setStencilFuncBack(7,0,255),m.setStencilOperationBack(0,
0,0,255)))):m.setStencilTest(!1);w.setParameters(m,t);this.setVertexBuffers(m,y);this.setMorphing(m,w.morphInstance);D=w.renderStyle;m.setIndexBuffer(y.indexBuffer[D]);h&&h(w,r);if(p&&p.presenting)m.setViewport(0,0,v,m.height),this.projId.setValue(de.data),this.projSkyboxId.setValue(de.data),this.viewInvId.setValue(Rb.data),this.viewId.setValue(hd.data),this.viewId3.setValue(Sj.data),this.viewProjId.setValue(Uj.data),this.viewPos[0]=jd.x,this.viewPos[1]=jd.y,this.viewPos[2]=jd.z,this.viewPosId.setValue(this.viewPos),
r+=this.drawInstance(m,w,y,D,!0),this._forwardDrawCalls++,m.setViewport(v,0,v,m.height),this.projId.setValue(ee.data),this.projSkyboxId.setValue(ee.data),this.viewInvId.setValue(Sb.data),this.viewId.setValue(id.data),this.viewId3.setValue(Tj.data),this.viewProjId.setValue(Vj.data),this.viewPos[0]=kd.x,this.viewPos[1]=kd.y,this.viewPos[2]=kd.z,this.viewPosId.setValue(this.viewPos),r+=this.drawInstance2(m,w,y,D),this._forwardDrawCalls++;else if(d.xr&&d.xr.session&&d.xr.views.length)for(u=d.xr.views,
C=0;C<u.length;C++){var G=u[C];m.setViewport(G.viewport.x,G.viewport.y,G.viewport.z,G.viewport.w);this.projId.setValue(G.projMat.data);this.projSkyboxId.setValue(G.projMat.data);this.viewId.setValue(G.viewOffMat.data);this.viewInvId.setValue(G.viewInvOffMat.data);this.viewId3.setValue(G.viewMat3.data);this.viewProjId.setValue(G.projViewOffMat.data);this.viewPosId.setValue(G.position);r=0===C?r+this.drawInstance(m,w,y,D,!0):r+this.drawInstance2(m,w,y,D);this._forwardDrawCalls++}else r+=this.drawInstance(m,
w,y,D,!0),this._forwardDrawCalls++;r<a-1&&b[r+1].material===x&&x.setParameters(m,w.parameters);u=x;C=z;D=B;G=w.isStatic}}m.updateEnd()};g.setupInstancing=function(d){d.enableAutoInstancing&&(wf||(wf=new Ra(d,Ma.defaultInstancingFormat,d.autoInstancingMaxObjects,1)))};g.revertStaticMeshes=function(d){var b,a=d.length,c=[];for(b=0;b<a;b++){var e=d[b];if(e._staticSource){if(e._staticSource!==f){c.push(e._staticSource);var f=e._staticSource}}else c.push(e)}d.length=c.length;for(b=0;b<c.length;b++)d[b]=
c[b]};g.prepareStaticMeshes=function(d,b){var a,c,e,f,h=this.device,k=d.length,m=[],n,p,t,r=new A,u=new A,v=new la,w=new M,y=[],x,z=[],B=[],C=[];for(a=0;a<k;a++){var D=d[a];if(D.isStatic){var G=D.aabb;C.length=0;for(x=1;2>=x;x++)for(c=0;c<b.length;c++){var J=b[c];J._type===x&&J.enabled&&J.mask&D.mask&&J.isStatic&&(z[c]||(z[c]=new la,J._node.getWorldTransform(),J.getBoundingSphere(Lc),z[c].center.copy(Lc.center),z[c].halfExtents.x=Lc.radius,z[c].halfExtents.y=Lc.radius,z[c].halfExtents.z=Lc.radius),
z[c].intersects(G)&&C.push(c))}if(0===C.length)m.push(D);else{G=D.mesh;x=G.vertexBuffer;J=G.indexBuffer[D.renderStyle];var E=2===J.bytesPerIndex?new Uint16Array(J.lock()):new Uint32Array(J.lock());var H=G.primitive[D.renderStyle].count/3;var P=G.primitive[D.renderStyle].base;var Y=x.format.elements;var L=x.format.size/4;G=new Float32Array(x.storage);for(e=0;e<Y.length;e++)"POSITION"===Y[e].name&&(n=Y[e].offset/4);y.length=H;for(e=0;e<H;e++)y[e]=0;Y=!1;B.length=6*H;for(e=0;e<H;e++){var V=t=p=Number.MAX_VALUE;
var wa=-Number.MAX_VALUE;var xa=-Number.MAX_VALUE;var U=-Number.MAX_VALUE;for(f=0;3>f;f++){c=E[3*e+f+P];c=c*L+n;var ha=G[c];var aa=G[c+1];c=G[c+2];ha<p&&(p=ha);aa<t&&(t=aa);c<V&&(V=c);ha>wa&&(wa=ha);aa>xa&&(xa=aa);c>U&&(U=c)}c=6*e;B[c]=p;B[c+1]=t;B[c+2]=V;B[c+3]=wa;B[c+4]=xa;B[c+5]=U}for(ha=0;ha<C.length;ha++)for(c=C[ha],w.copy(D.node.worldTransform).invert(),v.setFromTransformedAabb(z[c],w),aa=v.getMin(),p=v.getMax(),f=1<<ha,e=0;e<H;e++)c=6*e,B[c]<=p.x&&B[c+3]>=aa.x&&B[c+1]<=p.y&&B[c+4]>=aa.y&&B[c+
2]<=p.z&&B[c+5]>=aa.z&&(y[e]|=f,Y=!0);if(Y){Y={};for(e=0;e<H;e++){c=3*e+P;var T=y[e];Y[T]||(Y[T]=[]);f=Y[T];f.push(E[c]);f.push(E[c+1]);f.push(E[c+2])}for(T in Y){f=Y[T];E=new Db(h,J.format,f.length,J.usage);(2===E.bytesPerIndex?new Uint16Array(E.lock()):new Uint32Array(E.lock())).set(f);E.unlock();V=t=p=Number.MAX_VALUE;wa=-Number.MAX_VALUE;xa=-Number.MAX_VALUE;U=-Number.MAX_VALUE;for(e=0;e<f.length;e++)c=f[e],ha=G[c*L+n],aa=G[c*L+n+1],c=G[c*L+n+2],ha<p&&(p=ha),aa<t&&(t=aa),c<V&&(V=c),ha>wa&&(wa=
ha),aa>xa&&(xa=aa),c>U&&(U=c);r.set(p,t,V);u.set(wa,xa,U);e=new la;e.setMinMax(r,u);H=new bb(h);H.vertexBuffer=x;H.indexBuffer[0]=E;H.primitive[0].type=4;H.primitive[0].base=0;H.primitive[0].count=f.length;H.primitive[0].indexed=!0;H.aabb=e;E=new Ga(D.node,H,D.material);E.isStatic=D.isStatic;E.visible=D.visible;E.layer=D.layer;E.castShadow=D.castShadow;E._receiveShadow=D._receiveShadow;E.cull=D.cull;E.pick=D.pick;E.mask=D.mask;E.parameters=D.parameters;E._shaderDefs=D._shaderDefs;E._staticSource=
D;E._staticLightList=D._staticLightList?D._staticLightList:[];for(e=0;e<C.length;e++)f=1<<e,T&f&&(H=b[C[e]],0>E._staticLightList.indexOf(H)&&E._staticLightList.push(H));E._staticLightList.sort(this.lightCompare);m.push(E)}}else m.push(D)}}else m.push(D)}d.length=m.length;for(a=0;a<m.length;a++)d[a]=m[a]};g.updateShaders=function(d){for(var b,a=d.length,c=0;c<a;c++)(b=d[c].material)&&!od.has(b)&&(od.add(b),b.updateShader!==Fa.prototype.updateShader&&(b.clearVariants(),b.shader=null));od.clear()};g.updateLitShaders=
function(d){for(var b,a=d.length,c=0;c<a;c++)(b=d[c].material)&&!od.has(b)&&(od.add(b),b.updateShader===Fa.prototype.updateShader||!b.useLighting||b.emitter&&!b.emitter.lighting||(b.clearVariants(),b.shader=null));od.clear()};g.beginFrame=function(d){var b=this.scene,a=d._meshInstances;d=d._lights;b.updateShaders?(this.updateShaders(a),b.updateShaders=!1,b.updateLitShaders=!1,b._shaderVersion++):b.updateLitShaders&&(this.updateLitShaders(a),b.updateLitShaders=!1,b._shaderVersion++);this.updateCpuSkinMatrices(a);
var c=a.length;for(b=0;b<c;b++)a[b].visibleThisFrame=!1;c=d.length;for(b=0;b<c;b++)d[b].visibleThisFrame=0===d[b]._type};g.beginLayers=function(d){var b=this.scene,a=d.layerList.length,c,e=this.scene._shaderVersion;for(c=0;c<a;c++)d.layerList[c]._postRenderCounter=0;for(c=0;c<a;c++){var f=d.layerList[c];f._shaderVersion=e;f._preRenderCalledForCameras=0;f._postRenderCalledForCameras=0;var h=d.subLayerList[c];f._postRenderCounter=h?f._postRenderCounter|2:f._postRenderCounter|1;f._postRenderCounterMax=
f._postRenderCounter;for(h=0;h<f.cameras.length;h++)f.instances.visibleOpaque[h]||(f.instances.visibleOpaque[h]=new Nj),f.instances.visibleTransparent[h]||(f.instances.visibleTransparent[h]=new Nj),f.instances.visibleOpaque[h].done=!1,f.instances.visibleTransparent[h].done=!1;f.cameras.length<f.instances.visibleOpaque.length&&f.instances.visibleOpaque.splice(f.cameras.length,1);f.cameras.length<f.instances.visibleTransparent.length&&f.instances.visibleTransparent.splice(f.cameras.length,1);f._needsStaticPrepare&&
f._staticLightHash&&(f._staticPrepareDone&&(this.revertStaticMeshes(f.opaqueMeshInstances),this.revertStaticMeshes(f.transparentMeshInstances)),this.prepareStaticMeshes(f.opaqueMeshInstances,f._lights),this.prepareStaticMeshes(f.transparentMeshInstances,f._lights),d._dirty=!0,b.updateShaders=!0,f._needsStaticPrepare=!1,f._staticPrepareDone=!0)}};g.cullLocalShadowmap=function(d,b){var a,c,e,f;var h=d._type;if(0!==h){d.visibleThisFrame=!0;var k=this.getShadowCamera(this.device,d);k.projection=0;k.nearClip=
d.attenuationEnd/1E3;k.farClip=d.attenuationEnd;k.aspectRatio=1;if(2===h){k.fov=2*d._outerConeAngle;var m=1}else k.fov=90,m=6;var n=k._node;var p=d._node;n.setPosition(p.getPosition());2===h&&(n.setRotation(p.getRotation()),n.rotateLocal(-90,0,0));for(a=0;a<m;a++){1===h&&(n.setRotation(Pj[a]),k.renderTarget=d._shadowCubeMap[a]);this.updateCameraFrustum(k);(e=d._visibleList[a])||(e=d._visibleList[a]=[]);p=f=d._visibleLength[a]=0;for(c=b.length;p<c;p++){var t=b[p];var r=!0;t.cull&&(r=t._isVisible(k));
r&&(e[f]=t,f++,t.visibleThisFrame=!0)}d._visibleLength[a]=f;e.length!==f&&(e.length=f);e.sort(this.depthSortCompare)}}};g.cullDirectionalShadowmap=function(d,b,a,c){var e=this.device;d.visibleThisFrame=!0;e=this.getShadowCamera(e,d);var f=e._node;var h=d._node;f.setPosition(h.getPosition());f.setRotation(h.getRotation());f.rotateLocal(-90,0,0);var k=d.shadowDistance||a._farClip;var m=a._nearClip;var n=a._fov*Math.PI/180;var p=a._aspectRatio;var t=a._projection;var r=0===t?Math.tan(n/2)*m:a._orthoHeight;
var u=r*p;na[0].x=u;na[0].y=-r;na[0].z=-m;na[1].x=u;na[1].y=r;na[1].z=-m;na[2].x=-u;na[2].y=r;na[2].z=-m;na[3].x=-u;na[3].y=-r;na[3].z=-m;0===t&&(r=Math.tan(n/2)*k,u=r*p);na[4].x=u;na[4].y=-r;na[4].z=-k;na[5].x=u;na[5].y=r;na[5].z=-k;na[6].x=-u;na[6].y=r;na[6].z=-k;na[7].x=-u;na[7].y=-r;na[7].z=-k;p=Wj.sub2(na[0],na[6]).length();p=Math.max(p,Wj.sub2(na[4],na[6]).length());Kc.copy(f.getWorldTransform()).invert();Qj.copy(Kc).mul(a._node.getWorldTransform());for(n=0;8>n;n++)Qj.transformPoint(na[n],na[n]);
k=m=a=1E6;u=r=t=-1E6;for(n=0;8>n;n++){var v=na[n];v.x<k&&(k=v.x);v.x>u&&(u=v.x);v.y<m&&(m=v.y);v.y>r&&(r=v.y);v.z<a&&(a=v.z);v.z>t&&(t=v.z)}n=p/d._shadowResolution;k=Math.floor((k-.5*(p-(u-k)))/n)*n;m=Math.floor((m-.5*(p-(r-m)))/n)*n;k=.5*(k+p+k);m=.5*(m+p+m);f.translateLocal(k,m,1E5);e.projection=1;e.nearClip=0;e.farClip=2E5;e.aspectRatio=1;e.orthoHeight=.5*p;this.updateCameraFrustum(e);r=!0;(t=d._visibleList[c])||(t=d._visibleList[c]=[]);n=p=d._visibleLength[c]=0;for(u=b.length;n<u;n++){var w=b[n];
v=!0;w.cull&&(v=w._isVisible(e));v&&(t[p]=w,p++,w.visibleThisFrame=!0,v=w.aabb,r?(uf.copy(v),r=!1):uf.add(v))}d._visibleLength[c]=p;t.length!==p&&(t.length=p);t.sort(this.depthSortCompare);b=uf.getMin();n=uf.getMax();ra[0].x=ra[1].x=ra[2].x=ra[3].x=b.x;ra[1].y=ra[3].y=ra[7].y=ra[5].y=b.y;ra[2].z=ra[3].z=ra[6].z=ra[7].z=b.z;ra[4].x=ra[5].x=ra[6].x=ra[7].x=n.x;ra[0].y=ra[2].y=ra[4].y=ra[6].y=n.y;ra[0].z=ra[1].z=ra[4].z=ra[5].z=n.z;n=9999999999;b=-9999999999;for(t=0;8>t;++t)Kc.transformPoint(ra[t],ra[t]),
p=ra[t].z,p<n&&(n=p),p>b&&(b=p);t=b;n>a&&(a=n);f.setPosition(h.getPosition());f.translateLocal(k,m,t+.01);e.farClip=t-a;(h=d._visibleCameraSettings[c])||(h=d._visibleCameraSettings[c]={});d=f.getPosition();h.x=d.x;h.y=d.y;h.z=d.z;h.orthoHeight=e.orthoHeight;h.farClip=e.farClip};g.gpuUpdate=function(d){this.updateGpuSkinMatrices(d);this.updateMorphing(d)};g.setSceneConstants=function(){var d,b=this.device,a=this.scene;this.dispatchGlobalLights(a);if("none"!==a.fog){this.fogColor[0]=a.fogColor.r;this.fogColor[1]=
a.fogColor.g;this.fogColor[2]=a.fogColor.b;if(a.gammaCorrection)for(d=0;3>d;d++)this.fogColor[d]=Math.pow(this.fogColor[d],2.2);this.fogColorId.setValue(this.fogColor);"linear"===a.fog?(this.fogStartId.setValue(a.fogStart),this.fogEndId.setValue(a.fogEnd)):this.fogDensityId.setValue(a.fogDensity)}this._screenSize[0]=b.width;this._screenSize[1]=b.height;this._screenSize[2]=1/b.width;this._screenSize[3]=1/b.height;this.screenSizeId.setValue(this._screenSize)};g.updateLightStats=function(d,b){};g.renderComposition=
function(d){var b=this.device,a=d._renderedRt,c=d._renderedByCam,e=d._renderedLayer,f=d._renderActions,h,k;this.scene.updateSkybox&&(this.scene._updateSkybox(b),this.scene.updateSkybox=!1);this.beginLayers(d);var m=d._update();m&2&&(this.scene.updateLitShaders=!0);this.updateLightStats(d,m);this.beginFrame(d);this.setSceneConstants();var n=0;for(m=0;m<f.length;m++){var p=f[m];var t=p.layerIndex;var r=d.layerList[t];if(r.enabled&&d.subLayerEnabled[t]){var u=d.subLayerList[t];var v=p.cameraIndex;if(t=
r.cameras[v]){t.frameBegin(p.renderTarget);var w=p=!1;for(k=0;k<n;k++)if(c[k]===t&&(p=!0,e[k]===r)){w=!0;break}p||(this.updateCameraFrustum(t.camera),this._camerasRendered++);w||this.cullLights(t.camera,r._lights);p&&w||(c[n]=t,e[n]=r,n++);k=r.instances;k=u?k.visibleTransparent[v]:k.visibleOpaque[v];if(!k.done){if(r.onPreCull)r.onPreCull(h);u=u?r.transparentMeshInstances:r.opaqueMeshInstances;k.length=this.cull(t.camera,u,k.list);k.done=!0;if(r.onPostCull)r.onPostCull(v)}t.frameEnd()}}}for(m=0;m<
d._lights.length;m++)n=d._lights[m],n.visibleThisFrame&&0!==n._type&&n.castShadows&&n.enabled&&0!==n.shadowUpdateMode&&(t=d._lightShadowCasters[m],this.cullLocalShadowmap(n,t));e=-1;for(m=0;m<d._lights.length;m++)if(n=d._lights[m],0===n._type&&(e++,n.castShadows&&n.enabled&&0!==n.shadowUpdateMode))for(t=d._lightShadowCasters[m],r=d._globalLightCameras[e],h=0;h<r.length;h++)this.cullDirectionalShadowmap(n,t,r[h].camera,d._globalLightCameraIds[e][h]);this.gpuUpdate(d._meshInstances);this.renderShadows(d._splitLights[2]);
this.renderShadows(d._splitLights[1]);for(m=n=0;m<f.length;m++)if(p=f[m],t=p.layerIndex,r=d.layerList[t],r.enabled&&d.subLayerEnabled[t]){u=d.subLayerList[t];v=p.cameraIndex;(t=r.cameras[v])&&t.frameBegin(p.renderTarget);if(!u&&r.onPreRenderOpaque)r.onPreRenderOpaque(v);else if(u&&r.onPreRenderTransparent)r.onPreRenderTransparent(v);if(!(r._preRenderCalledForCameras&1<<v)){if(r.onPreRender)r.onPreRender(v);r._preRenderCalledForCameras|=1<<v;r.overrideClear&&this.clearView(t.camera,p.renderTarget,
!0,!0,r._clearOptions)}if(t){h=p.renderTarget;e=!1;for(k=0;k<n;k++)if(a[k]===h&&c[k]===t){e=!0;break}e||(r.overrideClear||this.clearView(t.camera,p.renderTarget,!0,!0),a[n]=h,c[n]=t,n++);this.renderShadows(r._splitLights[0],v);r._sortVisible(u,t.camera.node,v);k=r.instances;k=u?k.visibleTransparent[v]:k.visibleOpaque[v];this.scene._activeCamera=t.camera;this.setCamera(t.camera,p.renderTarget);this.renderForward(t.camera,k.list,k.length,r._splitLights,r.shaderPass,r.cullingMask,r.onDrawCall,r);b.setColorWrite(!0,
!0,!0,!0);b.setStencilTest(!1);b.setAlphaToCoverage(!1);b.setDepthBias(!1);t.frameEnd()}if(!u&&r.onPostRenderOpaque)r.onPostRenderOpaque(v);else if(u&&r.onPostRenderTransparent)r.onPostRenderTransparent(v);!r.onPostRender||r._postRenderCalledForCameras&1<<v||(r._postRenderCounter&=~(u?2:1),0===r._postRenderCounter&&(r.onPostRender(v),r._postRenderCalledForCameras|=1<<v,r._postRenderCounter=r._postRenderCounterMax))}};return l}(),ih=function(l){function g(){var b=l.call(this)||this;b.color=new Q(1,
1,1,1);b.colorUniform=new Float32Array(4);b.colorMap=null;b.vertexColors=!1;return b}K(g,l);var d=g.prototype;d.clone=function(){var b=new g;Fa.prototype._cloneInternal.call(this,b);b.color.copy(this.color);b.colorMap=this.colorMap;b.vertexColors=this.vertexColors;return b};d.updateUniforms=function(){this.clearParameters();this.colorUniform[0]=this.color.r;this.colorUniform[1]=this.color.g;this.colorUniform[2]=this.color.b;this.colorUniform[3]=this.color.a;this.setParameter("uColor",this.colorUniform);
this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)};d.updateShader=function(b,a,c,e,f,h){a={skin:!!this.meshInstances[0].skinInstance,vertexColors:this.vertexColors,diffuseMap:!!this.colorMap,pass:f};this.shader=b.getProgramLibrary().getProgram("basic",a)};return g}(Fa),xf=new pa,so=function(){function l(d){this.lineVertexFormat=new Ma(d,[{semantic:"POSITION",components:3,type:6},{semantic:"COLOR",components:4,type:1,normalize:!0}]);this.lineBatches=[];this.layers=[];this.layerToBatch=
{};this.cubeWorldPos=this.cubeLocalPos=this.quadMesh=null}var g=l.prototype;g.addLayer=function(d){0>this.layers.indexOf(d)&&this.layers.push(d)};g.getLayerIdx=function(d){return this.layerToBatch[d.id]};g.addLayerIdx=function(d,b){this.layerToBatch[b.id]=d};return l}(),to=function(){function l(){this.numLinesAllocated=128;this.mesh=this.vbRam=this.vb=null;this.linesUsed=0;this.layer=this.meshInstance=this.material=null}var g=l.prototype;g.init=function(d,b,a,c){this.mesh||(this.mesh=new bb(d),this.mesh.primitive[0].type=
1,this.mesh.primitive[0].base=0,this.mesh.primitive[0].indexed=!1,this.material=new ih,this.material.vertexColors=!0,this.material.blend=!0,this.material.blendType=2,this.material.update());for(this.layer=a;this.linesUsed+c>this.numLinesAllocated;)this.vb&&(this.vb.destroy(),this.vb=null),this.numLinesAllocated*=2;this.vertexFormat=b;this.vb||(this.vb=new Ra(d,b,2*this.numLinesAllocated,1),this.mesh.vertexBuffer=this.vb,this.vbRam=new DataView(this.vb.lock()),this.meshInstance||(xf.worldTransform=
M.IDENTITY,xf._dirtyWorld=xf._dirtyNormal=!1,this.meshInstance=new Ga(xf,this.mesh,this.material),this.meshInstance.cull=!1))};g.addLines=function(d,b){for(var a=!!b.length,c=2*this.linesUsed*this.vertexFormat.size,e,f=0;f<d.length;f++)this.vbRam.setFloat32(c,d[f].x,!0),c+=4,this.vbRam.setFloat32(c,d[f].y,!0),c+=4,this.vbRam.setFloat32(c,d[f].z,!0),c+=4,e=a?b[f]:b,this.vbRam.setUint8(c,255*e.r),c+=1,this.vbRam.setUint8(c,255*e.g),c+=1,this.vbRam.setUint8(c,255*e.b),c+=1,this.vbRam.setUint8(c,255*
e.a),c+=1;this.linesUsed+=d.length/2};g.finalize=function(d){0<this.linesUsed&&(this.vb.setData(this.vbRam.buffer),this.mesh.primitive[0].count=2*this.linesUsed,d[0]=this.meshInstance,this.layer.addMeshInstances(d,!0),this.linesUsed=0)};return l}(),uo=function(){this.cameraIndex=this.layerIndex=0;this.renderTarget=null},yf=function(l){function g(){var b=l.call(this)||this;b.layerList=[];b.subLayerList=[];b.subLayerEnabled=[];b._opaqueOrder={};b._transparentOrder={};b._dirty=!1;b._dirtyBlend=!1;b._dirtyLights=
!1;b._dirtyCameras=!1;b._meshInstances=[];b._meshInstancesSet=new Set;b._lights=[];b._lightsMap=new Map;b._lightShadowCasters=[];b._lightShadowCastersSets=[];b._splitLights=[[],[],[]];b._globalLightCameras=[];b.cameras=[];b._globalLightCameraIds=[];b._renderedRt=[];b._renderedByCam=[];b._renderedLayer=[];b._renderActions=[];return b}K(g,l);var d=g.prototype;d._splitLightsArray=function(b){var a=b._lights;b._splitLights[0].length=0;b._splitLights[1].length=0;for(var c=b._splitLights[2].length=0;c<
a.length;c++){var e=a[c];e.enabled&&b._splitLights[e._type].push(e)}};d._update=function(){function b(x,z,B){for(var C,D=!1,G=B.length,J=0;J<G;J++)C=B[J],z.has(C)||(z.add(C),x.push(C),(C=C.material)&&C._dirtyBlend&&(D=!0,C._dirtyBlend=!1));return D}function a(x,z,B){for(var C,D=0;D<z.length;)C=(C=z[D].material)&&3!==C.blendType,C===B?(x.push(z[D]),z[D]=z[z.length-1],z.length--):D++}function c(x,z,B){var C=y[w];C||(C=y[w]=new uo);C.layerIndex=z;C.cameraIndex=B;z=(z=x.cameras[B])?z.renderTarget:void 0;
C.renderTarget=z?z:x.renderTarget;w++}var e,f,h=this.layerList.length,k=0;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(e=0;e<h;e++){var m=this.layerList[e];m._dirty&&(this._dirty=!0);m._dirtyLights&&(this._dirtyLights=!0);m._dirtyCameras&&(this._dirtyCameras=!0)}if(this._dirty){k|=1;this._meshInstances.length=0;this._meshInstancesSet.clear();for(e=0;e<h;e++)m=this.layerList[e],m.passThrough||(this._dirtyBlend=b(this._meshInstances,this._meshInstancesSet,m.opaqueMeshInstances)||this._dirtyBlend,
this._dirtyBlend=b(this._meshInstances,this._meshInstancesSet,m.transparentMeshInstances)||this._dirtyBlend),m._dirty=!1,m._version++;this._dirty=!1}if(this._dirtyBlend){k|=8;for(e=0;e<h;e++)m=this.layerList[e],m.passThrough||(a(m.opaqueMeshInstances,m.transparentMeshInstances,!1),a(m.transparentMeshInstances,m.opaqueMeshInstances,!0));this._dirtyBlend=!1}if(this._dirtyLights){k|=2;this._lights.length=0;this._lightsMap.clear();for(e=0;e<h;e++){m=this.layerList[e];var n=m._lights;for(f=0;f<n.length;f++){var p=
n[f];this._lightsMap.has(p)||(this._lightsMap.set(p,this._lights.length),this._lights.push(p))}}m=this._lights.length;this._lightShadowCasters.length=m;this._lightShadowCastersSets.length=m;for(e=0;e<m;e++)this._lightShadowCasters[e]?this._lightShadowCasters[e].length=0:this._lightShadowCasters[e]=[],this._lightShadowCastersSets[e]?this._lightShadowCastersSets[e].clear():this._lightShadowCastersSets[e]=new Set;this._splitLightsArray(this);this._dirtyLights=!1;for(e=0;e<h;e++)m=this.layerList[e],this._splitLightsArray(m),
m._dirtyLights=!1}if(k){for(e=0;e<this._lightShadowCasters.length;e++)this._lightShadowCasters[e].length=0,this._lightShadowCastersSets[e].clear();for(e=0;e<h;e++)for(m=this.layerList[e],n=m._lights,f=0;f<n.length;f++){var t=this._lightsMap.get(n[f]);p=this._lightShadowCasters[t];var r=this._lightShadowCastersSets[t];var u=m.shadowCasters;for(t=0;t<u.length;t++){var v=u[t];r.has(v)||(r.add(v),p.push(v))}}}if(k&2||this._dirtyCameras)for(this._globalLightCameras.length=0,n=this._splitLights[0],f=0;f<
n.length;f++)for(p=n[f],this._globalLightCameras[f]=[],e=0;e<h;e++)if(m=this.layerList[e],0<=m._splitLights[0].indexOf(p))for(t=0;t<m.cameras.length;t++)0>this._globalLightCameras[f].indexOf(m.cameras[t])&&this._globalLightCameras[f].push(m.cameras[t]);var w=0,y=this._renderActions;if(this._dirtyCameras){this._dirtyCameras=!1;k|=4;for(e=this.cameras.length=0;e<h;e++)for(m=this.layerList[e],m._dirtyCameras=!1,f=0;f<m.cameras.length;f++)n=m.cameras[f],t=this.cameras.indexOf(n),0>t&&this.cameras.push(n);
for(e=n=0;e<h;e++)if(n)n--;else if(m=this.layerList[e],0!==m.cameras.length||m.isPostEffect)if(p=m._cameraHash,0===p)c(m,e,0);else{t=1;for(f=e+1;f<h;f++)if(p!==this.layerList[f]._cameraHash){t=f-e-1;break}else f===h-1&&(t=f-e);if(1===t)for(p=0;p<m.cameras.length;p++)c(m,e,p);else{for(p=0;p<m.cameras.length;p++)for(f=0;f<=t;f++)c(m,e+f,p);n=t}}this._renderActions.length=w}if(k&2||k&4)for(f=this._globalLightCameraIds.length=0;f<this._globalLightCameras.length;f++){h=[];for(e=0;e<this._globalLightCameras[f].length;e++)t=
this.cameras.indexOf(this._globalLightCameras[f][e]),0>t||h.push(t);this._globalLightCameraIds.push(h)}return k};d._isLayerAdded=function(b){return 0<=this.layerList.indexOf(b)?!0:!1};d._isSublayerAdded=function(b,a){for(var c=0;c<this.layerList.length;c++)if(this.layerList[c]===b&&this.subLayerList[c]===a)return!0;return!1};d.push=function(b){this._isLayerAdded(b)||(this.layerList.push(b),this.layerList.push(b),this._opaqueOrder[b.id]=this.subLayerList.push(!1)-1,this._transparentOrder[b.id]=this.subLayerList.push(!0)-
1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",b))};d.insert=function(b,a){if(!this._isLayerAdded(b)){this.layerList.splice(a,0,b,b);this.subLayerList.splice(a,0,!1,!0);var c=this.layerList.length;this._updateOpaqueOrder(a,c-1);this._updateTransparentOrder(a,c-1);this.subLayerEnabled.splice(a,0,!0,!0);this._dirtyCameras=this._dirtyLights=this._dirty=!0;this.fire("add",b)}};d.remove=function(b){var a=this.layerList.indexOf(b);
delete this._opaqueOrder[a];for(delete this._transparentOrder[a];0<=a;)this.layerList.splice(a,1),this.subLayerList.splice(a,1),this.subLayerEnabled.splice(a,1),a=this.layerList.indexOf(b),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("remove",b);b=this.layerList.length;this._updateOpaqueOrder(0,b-1);this._updateTransparentOrder(0,b-1)};d.pushOpaque=function(b){this._isSublayerAdded(b,!1)||(this.layerList.push(b),this._opaqueOrder[b.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),
this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",b))};d.insertOpaque=function(b,a){this._isSublayerAdded(b,!1)||(this.layerList.splice(a,0,b),this.subLayerList.splice(a,0,!1),this._updateOpaqueOrder(a,this.subLayerList.length-1),this.subLayerEnabled.splice(a,0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",b))};d.removeOpaque=function(b){for(var a=0,c=this.layerList.length;a<c;a++)if(this.layerList[a]===b&&!this.subLayerList[a]){this.layerList.splice(a,
1);this.subLayerList.splice(a,1);c--;this._updateOpaqueOrder(a,c-1);this.subLayerEnabled.splice(a,1);this._dirtyCameras=this._dirtyLights=this._dirty=!0;0>this.layerList.indexOf(b)&&this.fire("remove",b);break}};d.pushTransparent=function(b){this._isSublayerAdded(b,!0)||(this.layerList.push(b),this._transparentOrder[b.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",b))};d.insertTransparent=function(b,a){this._isSublayerAdded(b,
!0)||(this.layerList.splice(a,0,b),this.subLayerList.splice(a,0,!0),this._updateTransparentOrder(a,this.subLayerList.length-1),this.subLayerEnabled.splice(a,0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",b))};d.removeTransparent=function(b){for(var a=0,c=this.layerList.length;a<c;a++)if(this.layerList[a]===b&&this.subLayerList[a]){this.layerList.splice(a,1);this.subLayerList.splice(a,1);c--;this._updateTransparentOrder(a,c-1);this.subLayerEnabled.splice(a,1);this._dirtyCameras=
this._dirtyLights=this._dirty=!0;0>this.layerList.indexOf(b)&&this.fire("remove",b);break}};d._getSublayerIndex=function(b,a){var c=this.layerList.indexOf(b);return 0>c||this.subLayerList[c]!==a&&(c=this.layerList.indexOf(b,c+1),0>c||this.subLayerList[c]!==a)?-1:c};d.getOpaqueIndex=function(b){return this._getSublayerIndex(b,!1)};d.getTransparentIndex=function(b){return this._getSublayerIndex(b,!0)};d.getLayerById=function(b){for(var a=0;a<this.layerList.length;a++)if(this.layerList[a].id===b)return this.layerList[a];
return null};d.getLayerByName=function(b){for(var a=0;a<this.layerList.length;a++)if(this.layerList[a].name===b)return this.layerList[a];return null};d._updateOpaqueOrder=function(b,a){for(;b<=a;b++)!1===this.subLayerList[b]&&(this._opaqueOrder[this.layerList[b].id]=b)};d._updateTransparentOrder=function(b,a){for(;b<=a;b++)!0===this.subLayerList[b]&&(this._transparentOrder[this.layerList[b].id]=b)};d._sortLayersDescending=function(b,a,c){var e,f=-1,h=-1;var k=0;for(e=b.length;k<e;k++){var m=b[k];
c.hasOwnProperty(m)&&(f=Math.max(f,c[m]))}k=0;for(e=a.length;k<e;k++)m=a[k],c.hasOwnProperty(m)&&(h=Math.max(h,c[m]));return-1===f&&-1!==h?1:-1===h&&-1!==f?-1:h-f};d.sortTransparentLayers=function(b,a){return this._sortLayersDescending(b,a,this._transparentOrder)};d.sortOpaqueLayers=function(b,a){return this._sortLayersDescending(b,a,this._opaqueOrder)};return g}(ba),Ab=[],Tb=[],Ka,La=new A,Jb=new la,ge=new la,he={},Yj=["texture_lightMap","texture_dirLightMap"],jh=[],Zj=function(){function l(d,b,
a,c,e){this.device=d;this.root=b;this.scene=a;this.renderer=c;this.assets=e}var g=l.prototype;g.destroy=function(){this.assets=this.renderer=this.scene=this.root=this.device=null};g.calculateLightmapSize=function(d){var b=this.scene.lightmapSizeMultiplier||16;if(d.model){var a=d.model.lightmapSizeMultiplier;if(d.model.asset){var c=this.assets.get(d.model.asset).data;if(c.area)var e=c.area}else d.model._area&&(c=d.model,c._area&&(e=c._area))}else d.render&&(a=d.render.lightmapSizeMultiplier,"asset"!==
d.render.type&&d.render._area&&(c=d.render,c._area&&(e=c._area)));var f=1,h=1,k=1;c=1;e&&(f=e.x,h=e.y,k=e.z,c=e.uv);e=a||1;f*=e;h*=e;k*=e;La.copy(d.localScale);for(d=d._parent;d;)La.mul(d.localScale),d=d._parent;La.x=Math.abs(La.x);La.y=Math.abs(La.y);La.z=Math.abs(La.z);d=f*La.y*La.z+h*La.x*La.z+k*La.x*La.y;d=Math.sqrt(d/c);return Math.min(R.nextPowerOfTwo(d*b),this.scene.lightmapMaxResolution||2048)};g.bake=function(d,b){var a,c,e=this.device,f=this.scene,h=1;void 0===b&&(b=1);1===b&&(h=2);var k;
b=[];var m=[];if(d){var n;for(a=Tb.length-1;0<=a;a--)for(c=0;c<d.length;c++)if(Tb[a]===d[c]){for(n=0;n<Ab[a].length;n++)Ab[a][n].destroy();Ab.splice(a,1);Tb.splice(a,1)}n=[];for(a=0;a<d.length;a++)Le(d[a],n,m);d=n;Le(this.root,null,null,b)}else{for(a=0;a<Ab.length;a++)for(c=0;c<Ab[a].length;c++)Ab[a][c].destroy();Ab=[];Tb=[];d=[];Le(this.root,d,m,b)}if(0===d.length)e.fire("lightmapper:end",{timestamp:eb(),target:this});else{n=!1;f._needsStaticPrepare&&(f._needsStaticPrepare=!1,n=!0);var p=[[],[]],
t={};c=new X(this.device,{width:4,height:4,format:7,type:"rgbm"});c.name="lightmap";for(a=0;a<d.length;a++){var r=this.calculateLightmapSize(d[a]);for(k=0;k<h;k++){var u=new X(e,{width:r,height:r,format:7,mipmaps:!1,type:0===k?"rgbm":"default",minFilter:0,magFilter:0});u.name="lightmap";p[k].push(u)}if(!t[r]){var v=new X(e,{width:r,height:r,format:7,mipmaps:!1,type:"rgbm",minFilter:0,magFilter:0});v.name="lightmap";v=new va(e,v,{depth:!1});t[r]=v}}var w=f.layers;w._update();r=[];v=[];var y=[],x=[],
z=w._lights;for(a=0;a<z.length;a++)z[a].enabled&&(u=z[a].mask,0!==(u&4)&&(v.push(u),y.push(z[a].shadowUpdateMode),z[a].mask=4294967295,z[a].shadowUpdateMode=0===z[a]._type?2:1,r.push(z[a]),z[a].isStatic=!1)),x.push(z[a].enabled),z[a].enabled=!1;var B="#define UV1LAYOUT\n"+I.transformVS,C=I.bakeLmEndPS;u=Ja(e,I.fullscreenQuadVS,I.dilatePS,"lmDilate");var D=e.scope.resolve("source"),G=e.scope.resolve("pixelOffset"),J=e.scope.resolve("bakeDir"),E=new Float32Array(2);w=w._meshInstances;for(a=0;a<w.length;a++)w[a].node&&
w[a].node.getWorldTransform();w=f.fog;var H=f.ambientLight.r,P=f.ambientLight.g,Y=f.ambientLight.b;f.fog="none";f.ambientLight.set(0,0,0);Ka||(Ka=new be,Ka.clearColor=new Q(0,0,0,0),Ka.clearColorBuffer=!0,Ka.clearDepthBuffer=!1,Ka.clearStencilBuffer=!1,Ka.frustumCulling=!1,Ka.node=new pa);var L,V=function(Mc){return Mc.render?Mc.render:Mc.model},wa=function(Mc){return Mc.render?Mc.render.meshInstances:Mc.model.model.meshInstances},xa=[];xa.length=Tb.length;for(L=0;L<b.length;L++){var U=wa(b[L]);var ha=
[];for(a=0;a<U.length;a++)ha.push(U[a]._shaderDefs),U[a]._shaderDefs&=-193;for(a=0;a<Tb.length;a++)if(Tb[a]===b[L]){xa[a]=ha;break}}ha=[];var aa=[];for(L=0;L<b.length;L++)if(a=V(b[L]),ha[L]=a.castShadows,a.castShadows=a.castShadowsLightmap){var T=wa(b[L]);for(a=0;a<T.length;a++)T[a].visibleThisFrame=!0,aa.push(T[a])}this.renderer.updateCpuSkinMatrices(aa);this.renderer.gpuUpdate(aa);var pd=[],ie=[];T=[[],[]];var qd=[];qd.length=d.length;for(k=0;k<h;k++)jh[k]||(a=new ma,a.chunks.transformVS=B,0===
k?(a.chunks.endPS=C,a.ambient=new Q(0,0,0),a.ambientTint=!0,a.lightMap=c):(a.chunks.basePS=I.basePS+"\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n",a.chunks.endPS=I.bakeDirLmEndPS),a.chunks.outputAlphaPS="\n",a.chunks.outputAlphaOpaquePS="\n",a.chunks.outputAlphaPremulPS="\n",a.cull=0,a.forceUv1=!0,a.update(),a.updateShader(e,f),a.name="lmMaterial"+k,jh[k]=a);for(L=0;L<d.length;L++){U=m[L];qd[L]=0;if(0<U.length)for(Jb.copy(U[0].aabb),a=0;a<U.length;a++)U[a].node.getWorldTransform(),
Jb.add(U[a].aabb);a=new la;a.copy(Jb);ie.push(a);for(a=0;a<U.length;a++){var sa=U[a];sa._shaderDefs&=-193;sa.mask=4;sa.deleteParameter("texture_lightMap");sa.deleteParameter("texture_dirLightMap");sa.setParameter("texture_lightMap",sa.material.lightMap?sa.material.lightMap:c);sa.setParameter("texture_dirLightMap",c)}for(k=0;k<h;k++){var Xa=p[k][L];var Ub=new va(e,Xa,{depth:!1});T[k].push(Ub)}}for(c=0;c<r.length;c++)r[c].enabled=!1;B=[[],[],[]];C=!1;for(a=0;a<r.length;a++){r[a].enabled=!0;var Vb=!1;
r[a]._cacheShadowMap=!0;0!==r[a]._type&&(r[a]._node.getWorldTransform(),r[a].getBoundingSphere(he),ge.center=he.center,ge.halfExtents.x=he.radius,ge.halfExtents.y=he.radius,ge.halfExtents.z=he.radius);if(2===r[a]._type){L=r[a];var Ia=this.renderer.getShadowCamera(e,L);Ia._node.setPosition(L._node.getPosition());Ia._node.setRotation(L._node.getRotation());Ia._node.rotateLocal(-90,0,0);Ia.projection=0;Ia.nearClip=L.attenuationEnd/1E3;Ia.farClip=L.attenuationEnd;Ia.aspectRatio=1;Ia.fov=2*L._outerConeAngle;
this.renderer.updateCameraFrustum(Ia)}0<m.length&&this.renderer.updateShaders(m[0]);for(L=0;L<d.length;L++){U=m[L];Jb=ie[L];if(0===r[a]._type)La.copy(Jb.center),La.y+=Jb.halfExtents.y,Ka.node.setPosition(La),Ka.node.setEulerAngles(-90,0,0),c=Math.max(Jb.halfExtents.x,Jb.halfExtents.z),Ka.projection=1,Ka.nearClip=0,Ka.farClip=2*Jb.halfExtents.y,Ka.aspectRatio=1,Ka.orthoHeight=c;else if(!ge.intersects(Jb))continue;if(2===r[a]._type){k=!1;for(c=0;c<U.length;c++)if(U[c]._isVisible(Ia)){k=!0;break}if(!k)continue}0===
r[a]._type?(B[0][0]=r[a],B[1].length=0,B[2].length=0,!Vb&&r[a].castShadows&&(this.renderer.cullDirectionalShadowmap(r[a],aa,Ka,0),this.renderer.renderShadows(B[0],0),Vb=!0)):(B[0].length=0,1===r[a]._type?(B[1][0]=r[a],B[2].length=0,!Vb&&r[a].castShadows&&(this.renderer.cullLocalShadowmap(r[a],aa),this.renderer.renderShadows(B[1]),Vb=!0)):(B[1].length=0,B[2][0]=r[a],!Vb&&r[a].castShadows&&(this.renderer.cullLocalShadowmap(r[a],aa),this.renderer.renderShadows(B[2]),Vb=!0)));for(c=0;c<U.length;c++)pd[c]=
U[c].material;for(k=0;k<h;k++){Xa=p[k][L];Ub=T[k][L];sa=t[Xa.width];var Kb=sa.colorBuffer;0===k?C=f.updateShaders:C&&(f.updateShaders=!0);for(c=0;c<U.length;c++)U[c].material=jh[k];1<h&&this.renderer.updateShaders(U);this.renderer.setCamera(Ka,sa,!0);1===k&&J.setValue(r[a].bakeDir?1:0);this.renderer._forwardTime=0;this.renderer._shadowMapTime=0;this.renderer.renderForward(Ka,U,U.length,B,1);p[k][L]=Kb;T[k][L]=sa;t[Xa.width]=Ub;for(c=0;c<U.length;c++)sa=U[c],sa.setParameter(Yj[k],Kb),sa._shaderDefs|=
64}qd[L]++;for(c=0;c<U.length;c++)U[c].material=pd[c]}r[a].enabled=!1;r[a]._cacheShadowMap=!1;r[a]._isCachedShadowMap&&r[a]._destroyShadowMap()}for(L=0;L<d.length;L++){U=m[L];Ia=[];for(k=0;k<h;k++){Xa=p[k][L];Ub=T[k][L];sa=t[Xa.width];Kb=sa.colorBuffer;E[0]=1/Xa.width;E[1]=1/Xa.height;G.setValue(E);for(a=0;4>a;a++)D.setValue(Xa),Ea(e,sa,u),D.setValue(Kb),Ea(e,Ub,u);for(a=0;a<U.length;a++)sa=U[a],sa.mask=2,U[a].setParameter(Yj[k],Xa),1===k&&(U[a]._shaderDefs|=128);Ia[k]=Xa;k===h-1&&Ub.destroy()}Ab.push(Ia);
Tb.push(d[L])}for(var Wb in t)t.hasOwnProperty(Wb)&&(t[Wb].colorBuffer.destroy(),t[Wb].destroy());for(a=0;a<Ab.length;a++)for(c=0;c<Ab[a].length;c++)u=Ab[a][c],u.minFilter=1,u.magFilter=1;for(L=0;L<b.length;L++)V(b[L]).castShadows=ha[L];for(a=0;a<xa.length;a++)if(xa[a])for(U=wa(Tb[a]),c=0;c<U.length;c++)U[c]._shaderDefs|=xa[a][c]&192;for(a=0;a<r.length;a++)r[a].mask=v[a],r[a].shadowUpdateMode=y[a];for(a=0;a<z.length;a++)z[a].enabled=x[a];f.fog=w;f.ambientLight.set(H,P,Y);n&&(f._needsStaticPrepare=
!0)}};return l}(),Xb,ak=1,kh=new M,lh=new M,Lb=new A,Aa=new A,Bb=new A,rd=new A,Ta=new A,ta=new A,sd=new A,td=new A,je=new A,bk=new A,Ua=new A,zf=new A,Nc=new A,vo=function(){function l(d){this._emitter=d}var g=l.prototype;g.calcSpawnPosition=function(d,b,a,c,e){var f=this._emitter,h=Math.random(),k=Math.random(),m=Math.random(),n=Math.random();f.useCpu&&(d[4*e+8*f.numParticlesPot]=h,d[4*e+1+8*f.numParticlesPot]=k,d[4*e+2+8*f.numParticlesPot]=m);Aa.x=h-.5;Aa.y=k-.5;Aa.z=m-.5;0===f.emitterShape?(n=
Math.max(Math.abs(Aa.x),Math.max(Math.abs(Aa.y),Math.abs(Aa.z))),k=n+(.5-n)*a[1],m=n+(.5-n)*a[2],Aa.x=(n+(.5-n)*a[0])*(n==Math.abs(Aa.x)?Math.sign(Aa.x):2*Aa.x),Aa.y=k*(n==Math.abs(Aa.y)?Math.sign(Aa.y):2*Aa.y),Aa.z=m*(n==Math.abs(Aa.z)?Math.sign(Aa.z):2*Aa.z),f.localSpace?Lb.copy(b.transformPoint(Aa)):Lb.copy(c).add(b.transformPoint(Aa))):(Aa.normalize(),b=0===f.emitterRadius?0:f.emitterRadiusInner/f.emitterRadius,b=n*(1-b)+b,f.localSpace?Lb.copy(Aa.scale(b*f.emitterRadius)):Lb.copy(c).add(Aa.scale(b*
f.emitterRadius)));c=-R.lerp(f.rate,f.rate2,h)*e;f.pack8?(n=(Lb.x-f.worldBounds.center.x)/f.worldBoundsSize.x+.5,a=(Lb.y-f.worldBounds.center.y)/f.worldBoundsSize.y+.5,b=(Lb.z-f.worldBounds.center.z)/f.worldBoundsSize.z+.5,h=R.lerp(f.startAngle*R.DEG_TO_RAD,f.startAngle2*R.DEG_TO_RAD,h),h=h%(2*Math.PI)/(2*Math.PI),n=Me(n),d[4*e]=n[0],d[4*e+1]=n[1],a=Me(a),d[4*e+2]=a[0],d[4*e+3]=a[1],b=Me(b),d[4*e+4*f.numParticlesPot]=b[0],d[4*e+1+4*f.numParticlesPot]=b[1],h=Me(h),d[4*e+2+4*f.numParticlesPot]=h[0],
d[4*e+3+4*f.numParticlesPot]=h[1],d[4*e+3+8*f.numParticlesPot]=1,h=Math.max(f.lifetime,(f.numParticles-1)*Math.max(f.rate,f.rate2)),a=(c+h)/(h+(f.lifetime+1)),h=Zc(a),c=Zc(255*a),b=Zc(65025*a),a=Zc(160581375*a),h-=c/255,c-=b/255,h=[h,c,b-a/255,a-a/255],d[4*e+12*f.numParticlesPot]=h[0],d[4*e+1+12*f.numParticlesPot]=h[1],d[4*e+2+12*f.numParticlesPot]=h[2],d[4*e+3+12*f.numParticlesPot]=h[3]):(d[4*e]=Lb.x,d[4*e+1]=Lb.y,d[4*e+2]=Lb.z,d[4*e+3]=R.lerp(f.startAngle*R.DEG_TO_RAD,f.startAngle2*R.DEG_TO_RAD,
h),d[4*e+3+4*f.numParticlesPot]=c)};g.update=function(d,b,a,c,e,f,h,k){var m=this._emitter;if(m.meshInstance.node){var n=m.meshInstance.node.worldTransform;for(f=0;12>f;f++)kh.data[f]=n.data[f];lh.copy(kh);lh.invert();Xb=m.meshInstance.node.localScale;ak=Math.max(Math.max(Xb.x,Xb.y),Xb.z)}f=null===m.meshInstance.node||m.localSpace?A.ZERO:m.meshInstance.node.getPosition();var p=m.camera?m.camera._node.getPosition():A.ZERO,t=m.useMesh?17:15,r=m.precision-1;for(n=0;n<m.numParticles;n++){var u=Math.floor(m.vbCPU[n*
m.numParticleVerts*(m.useMesh?6:4)+3]),v=a[4*u+8*m.numParticlesPot];Bb.x=v;Bb.y=a[4*u+1+8*m.numParticlesPot];Bb.z=a[4*u+2+8*m.numParticlesPot];var w=m.rate+(m.rate2-m.rate)*v,y=m.lifetime,x=a[4*u+3+4*m.numParticlesPot]+h,z=Math.max(Math.min(x/y,1),0),B=0;var C=0;(0>=x-h||x>=y)&&this.calcSpawnPosition(a,c,e,f,u);var D=0<x&&x<y;if(D){C=z*r;var G=Math.floor(C);var J=Math.ceil(C);C%=1;var E=m.qRotSpeed[G];var H=m.qRotSpeed[J];var P=E+(H-E)*C;E=m.qRotSpeed2[G];H=m.qRotSpeed2[J];var Y=E+(H-E)*C;E=m.qScale[G];
H=m.qScale[J];B=E+(H-E)*C;E=m.qScale2[G];H=m.qScale2[J];var L=E+(H-E)*C;E=m.qAlpha[G];H=m.qAlpha[J];var V=E+(H-E)*C;E=m.qAlpha2[G];H=m.qAlpha2[J];var wa=E+(H-E)*C;E=m.qRadialSpeed[G];H=m.qRadialSpeed[J];var xa=E+(H-E)*C;E=m.qRadialSpeed2[G];H=m.qRadialSpeed2[J];E+=(H-E)*C;xa+=100*v%1*(E-xa);rd.x=a[4*u];rd.y=a[4*u+1];rd.z=a[4*u+2];m.localSpace?je.copy(rd):je.copy(rd).sub(f);je.normalize().scale(xa);G*=3;J*=3;E=m.qLocalVelocity[G];H=m.qLocalVelocity[J];ta.x=E+(H-E)*C;E=m.qLocalVelocity[G+1];H=m.qLocalVelocity[J+
1];ta.y=E+(H-E)*C;E=m.qLocalVelocity[G+2];H=m.qLocalVelocity[J+2];ta.z=E+(H-E)*C;E=m.qLocalVelocity2[G];H=m.qLocalVelocity2[J];td.x=E+(H-E)*C;E=m.qLocalVelocity2[G+1];H=m.qLocalVelocity2[J+1];td.y=E+(H-E)*C;E=m.qLocalVelocity2[G+2];H=m.qLocalVelocity2[J+2];td.z=E+(H-E)*C;E=m.qVelocity[G];H=m.qVelocity[J];Ta.x=E+(H-E)*C;E=m.qVelocity[G+1];H=m.qVelocity[J+1];Ta.y=E+(H-E)*C;E=m.qVelocity[G+2];H=m.qVelocity[J+2];Ta.z=E+(H-E)*C;E=m.qVelocity2[G];H=m.qVelocity2[J];sd.x=E+(H-E)*C;E=m.qVelocity2[G+1];H=m.qVelocity2[J+
1];sd.y=E+(H-E)*C;E=m.qVelocity2[G+2];H=m.qVelocity2[J+2];sd.z=E+(H-E)*C;ta.x+=(td.x-ta.x)*Bb.x;ta.y+=(td.y-ta.y)*Bb.y;ta.z+=(td.z-ta.z)*Bb.z;0<m.initialVelocity&&(1===m.emitterShape?(Aa.copy(Bb).scale(2).sub(A.ONE).normalize(),ta.add(Aa.scale(m.initialVelocity))):ta.add(A.FORWARD.scale(m.initialVelocity)));Ta.x+=(sd.x-Ta.x)*Bb.x;Ta.y+=(sd.y-Ta.y)*Bb.y;Ta.z+=(sd.z-Ta.z)*Bb.z;P+=(Y-P)*Bb.y;B=(B+1E4*v%1*(L-B))*ak;C=1E3*v%1*(wa-V);m.meshInstance.node&&(m.localSpace?(ta.x/=Xb.x,ta.y/=Xb.y,ta.z/=Xb.z):
kh.transformPoint(ta,ta));m.localSpace?(lh.transformPoint(Ta,Ta),ta.add(Ta).add(je)):(ta.add(Ta.mul(Xb)),ta.add(je.mul(Xb)));zf.copy(ta);bk.copy(rd).add(ta.scale(h));Ua.copy(bk);a[4*u]=Ua.x;a[4*u+1]=Ua.y;a[4*u+2]=Ua.z;a[4*u+3]+=P*h;m.wrap&&m.wrapBounds&&(m.localSpace||Ua.sub(f),Ua.x=ng(Ua.x,m.wrapBounds.x)-.5*m.wrapBounds.x,Ua.y=ng(Ua.y,m.wrapBounds.y)-.5*m.wrapBounds.y,Ua.z=ng(Ua.z,m.wrapBounds.z)-.5*m.wrapBounds.z,m.localSpace||Ua.add(f));0<m.sort&&(1===m.sort?(Nc.copy(Ua).sub(p),m.particleDistance[u]=
-(Nc.x*Nc.x+Nc.y*Nc.y+Nc.z*Nc.z)):2===m.sort?m.particleDistance[u]=x:3===m.sort&&(m.particleDistance[u]=-x))}k?0>x&&(a[4*u+3+8*m.numParticlesPot]=-1):(x>=y&&(x-=Math.max(y,(m.numParticles-1)*w),a[4*u+3+8*m.numParticlesPot]=m.loop?1:-1),0>x&&m.loop&&(a[4*u+3+8*m.numParticlesPot]=1));0>a[4*u+3+8*m.numParticlesPot]&&(D=!1);a[4*u+3+4*m.numParticlesPot]=x;for(P=0;P<m.numParticleVerts;P++)v=(n*m.numParticleVerts+P)*(m.useMesh?6:4),w=m.vbCPU[v],y=m.vbCPU[v+1],x=m.vbCPU[v+2],D||(w=y=x=0),G=n*m.numParticleVerts*
t+P*t,d[G]=Ua.x,d[G+1]=Ua.y,d[G+2]=Ua.z,d[G+3]=z,d[G+4]=m.alignToMotion?0:a[4*u+3],d[G+5]=B,d[G+6]=C,d[G+7]=zf.x,d[G+8]=w,d[G+9]=y,d[G+10]=x,d[G+11]=zf.y,d[G+12]=u,d[G+13]=zf.z,d[G+14]=m.vbCPU[v+3],m.useMesh&&(d[G+15]=m.vbCPU[v+4],d[G+16]=m.vbCPU[v+5])}if(0<m.sort&&m.camera){d=m.useMesh?6:4;a=m.particleDistance;for(n=0;n<m.numParticles;n++)b[n][0]=n,b[n][1]=a[Math.floor(m.vbCPU[n*m.numParticleVerts*d+3])];m.vbOld.set(m.vbCPU);b.sort(function(U,ha){return U[1]-ha[1]});for(n=0;n<m.numParticles;n++)for(a=
b[n][0]*m.numParticleVerts*d,c=n*m.numParticleVerts*d,f=0;f<m.numParticleVerts*d;f++)m.vbCPU[c+f]=m.vbOld[a+f]}};return l}(),ck=new lb,dk=new lb,ek=new lb,wo=function(){function l(d,b){this.randomize=function(){this.frameRandomUniform[0]=Math.random();this.frameRandomUniform[1]=Math.random();this.frameRandomUniform[2]=Math.random()};this._emitter=d;this.frameRandomUniform=new Float32Array(3);this.emitterPosUniform=new Float32Array(3);this.emitterScaleUniform=new Float32Array([1,1,1]);this.worldBoundsMulUniform=
new Float32Array(3);this.worldBoundsAddUniform=new Float32Array(3);this.inBoundsSizeUniform=new Float32Array(3);this.inBoundsCenterUniform=new Float32Array(3);this.constantParticleTexIN=b.scope.resolve("particleTexIN");this.constantParticleTexOUT=b.scope.resolve("particleTexOUT");this.constantEmitterPos=b.scope.resolve("emitterPos");this.constantEmitterScale=b.scope.resolve("emitterScale");this.constantSpawnBounds=b.scope.resolve("spawnBounds");this.constantSpawnPosInnerRatio=b.scope.resolve("spawnPosInnerRatio");
this.constantSpawnBoundsSphere=b.scope.resolve("spawnBoundsSphere");this.constantSpawnBoundsSphereInnerRatio=b.scope.resolve("spawnBoundsSphereInnerRatio");this.constantInitialVelocity=b.scope.resolve("initialVelocity");this.constantFrameRandom=b.scope.resolve("frameRandom");this.constantDelta=b.scope.resolve("delta");this.constantRate=b.scope.resolve("rate");this.constantRateDiv=b.scope.resolve("rateDiv");this.constantLifetime=b.scope.resolve("lifetime");this.constantGraphSampleSize=b.scope.resolve("graphSampleSize");
this.constantGraphNumSamples=b.scope.resolve("graphNumSamples");this.constantInternalTex0=b.scope.resolve("internalTex0");this.constantInternalTex1=b.scope.resolve("internalTex1");this.constantInternalTex2=b.scope.resolve("internalTex2");this.constantInternalTex3=b.scope.resolve("internalTex3");this.constantEmitterMatrix=b.scope.resolve("emitterMatrix");this.constantEmitterMatrixInv=b.scope.resolve("emitterMatrixInv");this.constantNumParticles=b.scope.resolve("numParticles");this.constantNumParticlesPot=
b.scope.resolve("numParticlesPot");this.constantLocalVelocityDivMult=b.scope.resolve("localVelocityDivMult");this.constantVelocityDivMult=b.scope.resolve("velocityDivMult");this.constantRotSpeedDivMult=b.scope.resolve("rotSpeedDivMult");this.constantSeed=b.scope.resolve("seed");this.constantStartAngle=b.scope.resolve("startAngle");this.constantStartAngle2=b.scope.resolve("startAngle2");this.constantOutBoundsMul=b.scope.resolve("outBoundsMul");this.constantOutBoundsAdd=b.scope.resolve("outBoundsAdd");
this.constantInBoundsSize=b.scope.resolve("inBoundsSize");this.constantInBoundsCenter=b.scope.resolve("inBoundsCenter");this.constantMaxVel=b.scope.resolve("maxVel");this.constantFaceTangent=b.scope.resolve("faceTangent");this.constantFaceBinorm=b.scope.resolve("faceBinorm")}var g=l.prototype;g._setInputBounds=function(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x;this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y;this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z;
this.constantInBoundsSize.setValue(this.inBoundsSizeUniform);this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x;this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y;this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z;this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)};g.update=function(d,b,a,c,e){var f=this._emitter;d.setBlending(!1);d.setColorWrite(!0,!0,!0,!0);d.setCullMode(0);d.setDepthTest(!1);d.setDepthWrite(!1);this.randomize();this.constantGraphSampleSize.setValue(1/
f.precision);this.constantGraphNumSamples.setValue(f.precision);this.constantNumParticles.setValue(f.numParticles);this.constantNumParticlesPot.setValue(f.numParticlesPot);this.constantInternalTex0.setValue(f.internalTex0);this.constantInternalTex1.setValue(f.internalTex1);this.constantInternalTex2.setValue(f.internalTex2);this.constantInternalTex3.setValue(f.internalTex3);var h=f.meshInstance.node,k=null===h?A.ONE:h.localScale;if(f.pack8){this.worldBoundsMulUniform[0]=f.worldBoundsMul.x;this.worldBoundsMulUniform[1]=
f.worldBoundsMul.y;this.worldBoundsMulUniform[2]=f.worldBoundsMul.z;this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform);this.worldBoundsAddUniform[0]=f.worldBoundsAdd.x;this.worldBoundsAddUniform[1]=f.worldBoundsAdd.y;this.worldBoundsAddUniform[2]=f.worldBoundsAdd.z;this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform);this._setInputBounds();var m=f.maxVel*Math.max(Math.max(k.x,k.y),k.z);m=Math.max(m,1);this.constantMaxVel.setValue(m)}m=null===h||f.localSpace?A.ZERO:h.getPosition();
h=null===h?M.IDENTITY:h.getWorldTransform();0===f.emitterShape?(ck.setFromMat4(b),this.constantSpawnBounds.setValue(ck.data),this.constantSpawnPosInnerRatio.setValue(a)):(this.constantSpawnBoundsSphere.setValue(f.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===f.emitterRadius?0:f.emitterRadiusInner/f.emitterRadius));this.constantInitialVelocity.setValue(f.initialVelocity);dk.setFromMat4(h);h.invertTo3x3(ek);this.emitterPosUniform[0]=m.x;this.emitterPosUniform[1]=m.y;this.emitterPosUniform[2]=
m.z;this.constantEmitterPos.setValue(this.emitterPosUniform);this.constantFrameRandom.setValue(this.frameRandomUniform);this.constantDelta.setValue(c);this.constantRate.setValue(f.rate);this.constantRateDiv.setValue(f.rate2-f.rate);this.constantStartAngle.setValue(f.startAngle*R.DEG_TO_RAD);this.constantStartAngle2.setValue(f.startAngle2*R.DEG_TO_RAD);this.constantSeed.setValue(f.seed);this.constantLifetime.setValue(f.lifetime);this.emitterScaleUniform[0]=k.x;this.emitterScaleUniform[1]=k.y;this.emitterScaleUniform[2]=
k.z;this.constantEmitterScale.setValue(this.emitterScaleUniform);this.constantEmitterMatrix.setValue(dk.data);this.constantEmitterMatrixInv.setValue(ek.data);this.constantLocalVelocityDivMult.setValue(f.localVelocityUMax);this.constantVelocityDivMult.setValue(f.velocityUMax);this.constantRotSpeedDivMult.setValue(f.rotSpeedUMax[0]);b=f.swapTex?f.particleTexOUT:f.particleTexIN;b=f.beenReset?f.particleTexStart:b;a=f.swapTex?f.particleTexIN:f.particleTexOUT;this.constantParticleTexIN.setValue(b);Ea(d,
f.swapTex?f.rtParticleTexIN:f.rtParticleTexOUT,e?f.shaderParticleUpdateOnStop:f.loop?f.shaderParticleUpdateRespawn:f.shaderParticleUpdateNoRespawn);f.material.setParameter("particleTexOUT",b);f.material.setParameter("particleTexIN",a);f.beenReset=!1;f.swapTex=!f.swapTex;d.setDepthTest(!0);d.setDepthWrite(!0);f.prevWorldBoundsSize.copy(f.worldBoundsSize);f.prevWorldBoundsCenter.copy(f.worldBounds.center);f.pack8&&this._setInputBounds()};return l}(),fk=[[-1,-1],[1,-1],[1,1],[-1,1]],qb=function(l,g,
d,b,a,c,e){void 0===a&&(a=14);var f=0;e&&7===a&&(f=1);l=new X(l,{width:g,height:d,format:a,cubemap:!1,mipmaps:!1,minFilter:f,magFilter:f,addressU:1,addressV:1});l.name="PSTexture";g=l.lock();if(7===a){a=new Uint8Array(b.length);for(d=0;d<b.length;d++)a[d]=b[d]*c*255;b=a}g.set(b);l.unlock();return l},gk=new db([0,0,1,0]),hk=new db([0,1,1,1]),ik=new Qb([0,0,1,0],[0,0,1,0],[0,0,1,0]),xo=new Qb([0,1,1,1],[0,1,1,1],[0,1,1,1]),Yb=2,Zb=new Float32Array(3),Oc=new M,jk=new A,Af=new A,Bf=new A,Ni,Ne,Cf=function(){function l(d,
b){this.graphicsDevice=d;this.precision=32;this._addTimeTime=0;if(!l.DEFAULT_PARAM_TEXTURE){var a=new Float32Array(1024),c,e;for(e=0;16>e;e++)for(c=0;16>c;c++){var f=c+1-8.5;var h=e+1-8.5;h=Math.max(Math.min(1-Math.max(Math.min(Math.sqrt(f*f+h*h)/16,1),0)-.5,1),0);f=16*e+c;a[4*f]=1;a[4*f+1]=1;a[4*f+2]=1;a[4*f+3]=h}l.DEFAULT_PARAM_TEXTURE=qb(d,16,16,a,7,1,!0);l.DEFAULT_PARAM_TEXTURE.minFilter=1;l.DEFAULT_PARAM_TEXTURE.magFilter=1}Ni=this;Ne=b;W("numParticles",1);this.numParticles>d.maxTextureSize&&
(console.warn("WARNING: can't create more than "+d.maxTextureSize+" particles on this device."),this.numParticles=d.maxTextureSize);W("rate",1);W("rate2",this.rate);W("lifetime",50);W("emitterExtents",new A(0,0,0));W("emitterExtentsInner",new A(0,0,0));W("emitterRadius",0);W("emitterRadiusInner",0);W("emitterShape",0);W("initialVelocity",1);W("wrap",!1);W("localSpace",!1);W("screenSpace",!1);W("wrapBounds",null);W("colorMap",l.DEFAULT_PARAM_TEXTURE);W("normalMap",null);W("loop",!0);W("preWarm",!1);
W("sort",0);W("mode",0);W("scene",null);W("lighting",!1);W("halfLambert",!1);W("intensity",1);W("stretch",0);W("alignToMotion",!1);W("depthSoftening",0);W("mesh",null);W("particleNormal",new A(0,1,0));W("orientation",0);W("depthWrite",!1);W("noFog",!1);W("blendType",2);W("node",null);W("startAngle",0);W("startAngle2",this.startAngle);W("animTilesX",1);W("animTilesY",1);W("animStartFrame",0);W("animNumFrames",1);W("animNumAnimations",1);W("animIndex",0);W("randomizeAnimIndex",!1);W("animSpeed",1);
W("animLoop",!0);this._gpuUpdater=new wo(this,d);this._cpuUpdater=new vo(this);this.constantLightCube=d.scope.resolve("lightCube[0]");this.emitterPosUniform=new Float32Array(3);this.wrapBoundsUniform=new Float32Array(3);this.emitterScaleUniform=new Float32Array([1,1,1]);W("colorGraph",xo);W("colorGraph2",this.colorGraph);W("scaleGraph",hk);W("scaleGraph2",this.scaleGraph);W("alphaGraph",hk);W("alphaGraph2",this.alphaGraph);W("localVelocityGraph",ik);W("localVelocityGraph2",this.localVelocityGraph);
W("velocityGraph",ik);W("velocityGraph2",this.velocityGraph);W("rotationSpeedGraph",gk);W("rotationSpeedGraph2",this.rotationSpeedGraph);W("radialSpeedGraph",gk);W("radialSpeedGraph2",this.radialSpeedGraph);this.lightCube=new Float32Array(18);this.lightCubeDir=Array(6);this.lightCubeDir[0]=new A(-1,0,0);this.lightCubeDir[1]=new A(1,0,0);this.lightCubeDir[2]=new A(0,-1,0);this.lightCubeDir[3]=new A(0,1,0);this.lightCubeDir[4]=new A(0,0,-1);this.lightCubeDir[5]=new A(0,0,1);this.animTilesParams=new Float32Array(2);
this.animParams=new Float32Array(4);this.animIndexParams=new Float32Array(2);this.camera=this.particleDistance=this.vbOld=this.vbToSort=this.colorParam=this.internalTex2=this.internalTex1=this.internalTex0=null;this.swapTex=!1;this.useMesh=!0;this.useCpu=!1;this.pack8=!0;this.localBounds=new la;this.worldBoundsNoTrail=new la;this.worldBoundsTrail=[new la,new la];this.worldBounds=new la;this.worldBoundsSize=new A;this.prevWorldBoundsSize=new A;this.prevWorldBoundsCenter=new A;this.prevEmitterExtents=
this.emitterExtents;this.prevEmitterRadius=this.emitterRadius;this.worldBoundsMul=new A;this.worldBoundsAdd=new A;this.timeToSwitchBounds=0;this.shaderParticleUpdateOnStop=this.shaderParticleUpdateNoRespawn=this.shaderParticleUpdateRespawn=null;this.numParticleIndices=this.numParticleVerts=0;this.meshInstance=this.material=null;this.drawOrder=0;this.seed=Math.random();this.fixedTimeStep=1/60;this.maxSubSteps=10;this.simTimeTotal=this.simTime=0;this.beenReset=!1;this._layer=null;this.rebuild()}var g=
l.prototype;g.onChangeCamera=function(){this.regenShader();this.resetMaterial()};g.calculateBoundsMad=function(){this.worldBoundsMul.x=1/this.worldBoundsSize.x;this.worldBoundsMul.y=1/this.worldBoundsSize.y;this.worldBoundsMul.z=1/this.worldBoundsSize.z;this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).scale(-1);this.worldBoundsAdd.x+=.5;this.worldBoundsAdd.y+=.5;this.worldBoundsAdd.z+=.5};g.calculateWorldBounds=function(){if(this.node){this.prevWorldBoundsSize.copy(this.worldBoundsSize);
this.prevWorldBoundsCenter.copy(this.worldBounds.center);this.useCpu||(0===this.emitterShape?!this.emitterExtents.equals(this.prevEmitterExtents):this.emitterRadius!==this.prevEmitterRadius)&&this.calculateLocalBounds();var d=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,d);this.worldBoundsTrail[0].add(this.worldBoundsNoTrail);this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);var b=this.simTimeTotal;
b>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=b+this.lifetime);this.worldBounds.copy(this.worldBoundsTrail[0]);this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2);this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,d),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,d)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds));
this.meshInstance._aabbVer=1-this.meshInstance._aabbVer;this.pack8&&this.calculateBoundsMad()}};g.resetWorldBounds=function(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?M.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),
this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.timeToSwitchBounds=this.simTimeTotal=0)};g.calculateLocalBounds=function(){var d=Number.MAX_VALUE,b=Number.MAX_VALUE,a=Number.MAX_VALUE,c=-Number.MAX_VALUE,e=-Number.MAX_VALUE,f=-Number.MAX_VALUE,h=0,k=0,m=this.lifetime/this.precision,n=[this.qVelocity,this.qVelocity2],p=[this.qLocalVelocity,this.qLocalVelocity2],t=[0,0],r=[0,0],u=[0,0],v=[0,0],w=[0,0],y,x;for(y=0;y<this.precision+1;y++){var z=Math.min(y,this.precision-1);for(x=0;2>x;x++){var B=
p[x][3*z]*m+t[x];var C=p[x][3*z+1]*m+r[x];var D=p[x][3*z+2]*m+u[x];d=Math.min(B,d);b=Math.min(C,b);a=Math.min(D,a);c=Math.max(B,c);e=Math.max(C,e);f=Math.max(D,f);t[x]=B;r[x]=C;u[x]=D}for(x=0;2>x;x++)w[x]+=m*Math.sqrt(n[x][3*z]*n[x][3*z]+n[x][3*z+1]*n[x][3*z+1]+n[x][3*z+2]*n[x][3*z+2]);v[0]+=this.qRadialSpeed[z]*m;v[1]+=this.qRadialSpeed2[z]*m;h=Math.max(h,Math.max(Math.abs(v[0]),Math.abs(v[1])));k=Math.max(k,this.qScale[z])}0===this.emitterShape?(B=.5*this.emitterExtents.x,C=.5*this.emitterExtents.y,
D=.5*this.emitterExtents.z):D=C=B=this.emitterRadius;m=Math.max(w[0],w[1]);Af.x=d-k-B-h-m;Af.y=b-k-C-h-m;Af.z=a-k-D-h-m;Bf.x=c+k+B+h+m;Bf.y=e+k+C+h+m;Bf.z=f+k+D+h+m;this.localBounds.setMinMax(Af,Bf)};g.rebuild=function(){var d,b=this.graphicsDevice;null===this.colorMap&&(this.colorMap=l.DEFAULT_PARAM_TEXTURE);this.spawnBounds=0===this.emitterShape?this.emitterExtents:this.emitterRadius;this.useCpu=this.useCpu||0<this.sort||1>=b.maxVertexTextures||64>b.fragmentUniformsCount||b.forceCpuParticles||!b.extTextureFloat;
this._destroyResources();this.pack8=(this.pack8||!b.textureFloatRenderable)&&!this.useCpu;Yb=this.useCpu||this.pack8?4:2;this.useMesh=!1;this.mesh&&(65535<this.numParticles*this.mesh.vertexBuffer.numVertices?console.warn("WARNING: particle system can't render mesh particles because numParticles * numVertices is more than 65k. Reverting to quad particles."):this.useMesh=!0);this.numParticlesPot=R.nextPowerOfTwo(this.numParticles);this.rebuildGraphs();this.calculateLocalBounds();this.resetWorldBounds();
this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?M.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad());this.vbToSort=Array(this.numParticles);for(d=0;d<this.numParticles;d++)this.vbToSort[d]=
[0,0];this.particleDistance=new Float32Array(this.numParticles);this._gpuUpdater.randomize();this.particleTex=new Float32Array(this.numParticlesPot*Yb*4);var a=null===this.node||this.localSpace?A.ZERO:this.node.getPosition();0===this.emitterShape&&(null===this.node||this.localSpace?Oc.setTRS(A.ZERO,ea.IDENTITY,this.spawnBounds):Oc.setTRS(A.ZERO,this.node.getRotation(),jk.copy(this.spawnBounds).mul(this.node.localScale)),Zb[0]=0!=this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:
0,Zb[1]=0!=this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Zb[2]=0!=this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(d=0;d<this.numParticles;d++)this._cpuUpdater.calcSpawnPosition(this.particleTex,Oc,Zb,a,d),this.useCpu&&(this.particleTex[4*d+3+8*this.numParticlesPot]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*Yb*4);for(d=0;d<this.particleTexStart.length;d++)this.particleTexStart[d]=this.particleTex[d];this.useCpu||(this.pack8?
(this.particleTexIN=qb(b,this.numParticlesPot,Yb,this.particleTex,7,1,!1),this.particleTexOUT=qb(b,this.numParticlesPot,Yb,this.particleTex,7,1,!1),this.particleTexStart=qb(b,this.numParticlesPot,Yb,this.particleTexStart,7,1,!1)):(this.particleTexIN=qb(b,this.numParticlesPot,Yb,this.particleTex),this.particleTexOUT=qb(b,this.numParticlesPot,Yb,this.particleTex),this.particleTexStart=qb(b,this.numParticlesPot,Yb,this.particleTexStart)),this.rtParticleTexIN=new va(b,this.particleTexIN,{depth:!1}),this.rtParticleTexOUT=
new va(b,this.particleTexOUT,{depth:!1}),this.swapTex=!1);d=(this.localSpace?"#define LOCAL_SPACE\n":"")+I.particleUpdaterInitPS+(this.pack8?I.particleInputRgba8PS+I.particleOutputRgba8PS:I.particleInputFloatPS+I.particleOutputFloatPS)+(0===this.emitterShape?I.particleUpdaterAABBPS:I.particleUpdaterSpherePS)+I.particleUpdaterStartPS;a=d+I.particleUpdaterNoRespawnPS+I.particleUpdaterEndPS;var c=d+I.particleUpdaterOnStopPS+I.particleUpdaterEndPS,e=this.emitterShape+""+this.pack8+this.localSpace;this.shaderParticleUpdateRespawn=
Ja(b,I.fullscreenQuadVS,d+I.particleUpdaterRespawnPS+I.particleUpdaterEndPS,"fsQuad0"+e);this.shaderParticleUpdateNoRespawn=Ja(b,I.fullscreenQuadVS,a,"fsQuad1"+e);this.shaderParticleUpdateOnStop=Ja(b,I.fullscreenQuadVS,c,"fsQuad2"+e);this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4;this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6;this._allocate(this.numParticles);b=new bb(b);b.vertexBuffer=this.vertexBuffer;b.indexBuffer[0]=this.indexBuffer;b.primitive[0].type=
4;b.primitive[0].base=0;b.primitive[0].count=this.numParticles*this.numParticleIndices;b.primitive[0].indexed=!0;this.material=new Fa;this.material.name=this.node.name;this.material.cull=0;this.material.alphaWrite=!1;this.material.blend=!0;this.material.blendType=this.blendType;this.material.depthWrite=this.depthWrite;this.material.emitter=this;this.regenShader();this.resetMaterial();d=this.meshInstance?this.meshInstance.visible:!0;this.meshInstance=new Ga(this.node,b,this.material);this.meshInstance.pick=
!1;this.meshInstance.updateKey();this.meshInstance.cull=!0;this.meshInstance._noDepthDrawGl1=!0;this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds);this.meshInstance._updateAabb=!1;this.meshInstance.visible=d;this._initializeTextures();this.resetTime();this.addTime(0,!1);this.preWarm&&this.prewarm(this.lifetime)};g._isAnimated=function(){return 1<=this.animNumFrames&&(1<this.animTilesX||1<this.animTilesY)&&
(this.colorMap&&this.colorMap!==l.DEFAULT_PARAM_TEXTURE||this.normalMap)};g.rebuildGraphs=function(){var d=this.precision,b=this.graphicsDevice,a;this.qLocalVelocity=this.localVelocityGraph.quantize(d);this.qVelocity=this.velocityGraph.quantize(d);this.qColor=this.colorGraph.quantizeClamped(d,0,1);this.qRotSpeed=this.rotationSpeedGraph.quantize(d);this.qScale=this.scaleGraph.quantize(d);this.qAlpha=this.alphaGraph.quantize(d);this.qRadialSpeed=this.radialSpeedGraph.quantize(d);this.qLocalVelocity2=
this.localVelocityGraph2.quantize(d);this.qVelocity2=this.velocityGraph2.quantize(d);this.qColor2=this.colorGraph2.quantizeClamped(d,0,1);this.qRotSpeed2=this.rotationSpeedGraph2.quantize(d);this.qScale2=this.scaleGraph2.quantize(d);this.qAlpha2=this.alphaGraph2.quantize(d);this.qRadialSpeed2=this.radialSpeedGraph2.quantize(d);for(a=0;a<d;a++)this.qRotSpeed[a]*=R.DEG_TO_RAD,this.qRotSpeed2[a]*=R.DEG_TO_RAD;this.localVelocityUMax=new Float32Array(3);this.velocityUMax=new Float32Array(3);this.colorUMax=
new Float32Array(3);this.rotSpeedUMax=[0];this.scaleUMax=[0];this.alphaUMax=[0];this.radialSpeedUMax=[0];this.qLocalVelocityDiv=zc(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax);this.qVelocityDiv=zc(this.qVelocity,this.qVelocity2,this.velocityUMax);this.qColorDiv=zc(this.qColor,this.qColor2,this.colorUMax);this.qRotSpeedDiv=zc(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax);this.qScaleDiv=zc(this.qScale,this.qScale2,this.scaleUMax);this.qAlphaDiv=zc(this.qAlpha,this.qAlpha2,this.alphaUMax);
this.qRadialSpeedDiv=zc(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax);if(this.pack8){var c=[0,0,0];yc(this.qVelocity,c);var e=[0,0,0];yc(this.qVelocity2,e);a=[0,0,0];yc(this.qLocalVelocity,a);var f=[0,0,0];yc(this.qLocalVelocity2,f);var h=[0];yc(this.qRadialSpeed,h);var k=[0];yc(this.qRadialSpeed2,k);var m=Math.max(c[0],e[0]);m=Math.max(m,c[1]);m=Math.max(m,e[1]);m=Math.max(m,c[2]);m=Math.max(m,e[2]);c=Math.max(a[0],f[0]);c=Math.max(c,a[1]);c=Math.max(c,f[1]);c=Math.max(c,a[2]);c=Math.max(c,
f[2]);this.maxVel=m+c+Math.max(h[0],k[0])}if(!this.useCpu){this.internalTex0=qb(b,d,1,Oi(this.qLocalVelocity,this.qLocalVelocityDiv));this.internalTex1=qb(b,d,1,Oi(this.qVelocity,this.qVelocityDiv));a=this.qRotSpeed;f=this.qScale;h=this.qScaleDiv;k=this.qRotSpeedDiv;m=this.qAlphaDiv;c=Array(4*a.length);for(e=0;e<a.length;e++)c[4*e]=a[e],c[4*e+1]=f[e],c[4*e+2]=0,c[4*e+3]=(255*h[e]<<16|255*k[e]<<8|255*m[e])/16777216;this.internalTex2=qb(b,d,1,c);a=this.qRadialSpeed;f=this.qRadialSpeedDiv;h=Array(4*
a.length);for(k=0;k<a.length;k++)h[4*k]=a[k],h[4*k+1]=f[k],h[4*k+2]=0,h[4*k+3]=0;this.internalTex3=qb(b,d,1,h)}a=this.qColor;f=this.qAlpha;h=Array(4*f.length);for(k=0;k<f.length;k++)h[4*k]=a[3*k],h[4*k+1]=a[3*k+1],h[4*k+2]=a[3*k+2],h[4*k+3]=f[k];this.colorParam=qb(b,d,1,h,7,1,!0)};g._initializeTextures=function(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))};g.regenShader=function(){var d=
this.graphicsDevice.getProgramLibrary(),b=null!==this.normalMap;this.normalOption=0;this.lighting&&(this.normalOption=b?2:1);this.material.updateShader=function(){this.emitter.scene&&this.emitter.camera!=this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());this.shader=d.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,
soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:this.emitter.inTools?!1:this.emitter.screenSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,
customFace:0!=this.emitter.orientation})};this.material.updateShader()};g.resetMaterial=function(){var d=this.material;d.setParameter("stretch",this.stretch);this._isAnimated()&&(d.setParameter("animTexTilesParams",this.animTilesParams),d.setParameter("animTexParams",this.animParams),d.setParameter("animTexIndexParams",this.animIndexParams));d.setParameter("colorMult",this.intensity);this.useCpu||(d.setParameter("internalTex0",this.internalTex0),d.setParameter("internalTex1",this.internalTex1),d.setParameter("internalTex2",
this.internalTex2),d.setParameter("internalTex3",this.internalTex3));d.setParameter("colorParam",this.colorParam);d.setParameter("numParticles",this.numParticles);d.setParameter("numParticlesPot",this.numParticlesPot);d.setParameter("lifetime",this.lifetime);d.setParameter("rate",this.rate);d.setParameter("rateDiv",this.rate2-this.rate);d.setParameter("seed",this.seed);d.setParameter("scaleDivMult",this.scaleUMax[0]);d.setParameter("alphaDivMult",this.alphaUMax[0]);d.setParameter("radialSpeedDivMult",
this.radialSpeedUMax[0]);d.setParameter("graphNumSamples",this.precision);d.setParameter("graphSampleSize",1/this.precision);d.setParameter("emitterScale",new Float32Array([1,1,1]));this.pack8&&(this._gpuUpdater._setInputBounds(),d.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),d.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),d.setParameter("maxVel",this.maxVel));this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=
this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,d.setParameter("wrapBounds",this.wrapBoundsUniform));this.colorMap&&d.setParameter("colorMap",this.colorMap);this.lighting&&this.normalMap&&d.setParameter("normalMap",this.normalMap);0<this.depthSoftening&&d.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100));0<this.stretch&&(d.cull=0);this._compParticleFaceParams()};g._compParticleFaceParams=function(){if(0==this.orientation){var d=new Float32Array([1,0,0]);var b=
new Float32Array([0,0,1])}else{d=1==this.orientation?this.particleNormal.normalize():(null===this.node?M.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize();var a=new A(1,0,0);1==Math.abs(a.dot(d))&&a.set(0,0,1);b=(new A).cross(d,a).normalize();a.cross(b,d).normalize();d=new Float32Array([a.x,a.y,a.z]);b=new Float32Array([b.x,b.y,b.z])}this.material.setParameter("faceTangent",d);this.material.setParameter("faceBinorm",b)};g._allocate=function(d){var b=d*this.numParticleVerts,
a=d*this.numParticleIndices;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==b){if(this.useCpu)var c=[{semantic:"ATTR0",components:4,type:6},{semantic:"ATTR1",components:4,type:6},{semantic:"ATTR2",components:4,type:6},{semantic:"ATTR3",components:1,type:6},{semantic:"ATTR4",components:this.useMesh?4:2,type:6}];else c=[{semantic:"ATTR0",components:4,type:6}],this.useMesh&&c.push({semantic:"ATTR1",components:2,type:6});c=new Ma(this.graphicsDevice,c);this.vertexBuffer=new Ra(this.graphicsDevice,
c,b,1);this.indexBuffer=new Db(this.graphicsDevice,1,a);c=new Float32Array(this.vertexBuffer.lock());if(this.useMesh){var e=new Float32Array(this.mesh.vertexBuffer.lock());var f=e.length/this.mesh.vertexBuffer.numVertices;for(a=0;a<this.mesh.vertexBuffer.format.elements.length;a++)if("TEXCOORD0"===this.mesh.vertexBuffer.format.elements[a].name){var h=this.mesh.vertexBuffer.format.elements[a].offset/4;break}}for(a=0;a<b;a++){var k=Math.floor(a/this.numParticleVerts);if(this.useMesh){var m=a%this.numParticleVerts;
c[6*a]=e[m*f];c[6*a+1]=e[m*f+1];c[6*a+2]=e[m*f+2];c[6*a+3]=k;c[6*a+4]=e[m*f+h+0];c[6*a+5]=e[m*f+h+1]}else m=a%4,c[4*a]=fk[m][0],c[4*a+1]=fk[m][1],c[4*a+2]=0,c[4*a+3]=k}this.useCpu&&(this.vbCPU=new Float32Array(c),this.vbOld=new Float32Array(this.vbCPU.length));this.vertexBuffer.unlock();this.useMesh&&this.mesh.vertexBuffer.unlock();b=0;f=new Uint16Array(this.indexBuffer.lock());this.useMesh&&(e=new Uint16Array(this.mesh.indexBuffer[0].lock()));for(a=0;a<d;a++)if(this.useMesh)for(h=0;h<this.numParticleIndices;h++)f[a*
this.numParticleIndices+h]=e[h]+a*this.numParticleVerts;else h=4*a,f[b++]=h,f[b++]=h+1,f[b++]=h+2,f[b++]=h,f[b++]=h+2,f[b++]=h+3;this.indexBuffer.unlock();this.useMesh&&this.mesh.indexBuffer[0].unlock()}};g.reset=function(){this.beenReset=!0;this.seed=Math.random();this.material.setParameter("seed",this.seed);if(this.useCpu)for(var d=0;d<this.particleTexStart.length;d++)this.particleTex[d]=this.particleTexStart[d];else this._initializeTextures();this.resetWorldBounds();this.resetTime();d=this.loop;
this.loop=!0;this.addTime(0,!1);this.loop=d;this.preWarm&&this.prewarm(this.lifetime)};g.prewarm=function(d){var b=Math.min(Math.floor(d/this.lifetime*this.precision),this.precision);d/=b;for(var a=0;a<b;a++)this.addTime(d,!1)};g.resetTime=function(){var d=Math.max(this.rate,this.rate2)*this.numParticles+this.lifetime;this.endTime=Date.now()+1E3*d};g.finishFrame=function(){this.useCpu&&this.vertexBuffer.unlock()};g.addTime=function(d,b){var a=this.graphicsDevice;this.simTimeTotal+=d;this.calculateWorldBounds();
if(this._isAnimated()){var c=this.animTilesParams;c[0]=1/this.animTilesX;c[1]=1/this.animTilesY;c=this.animParams;c[0]=this.animStartFrame;c[1]=this.animNumFrames*this.animSpeed;c[2]=this.animNumFrames-1;c[3]=this.animNumAnimations-1;c=this.animIndexParams;c[0]=this.animIndex;c[1]=this.randomizeAnimIndex}this.scene&&this.camera!=this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera());0===this.emitterShape&&(Zb[0]=0!=this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:
0,Zb[1]=0!=this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Zb[2]=0!=this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?Oc.setTRS(A.ZERO,ea.IDENTITY,this.emitterExtents):Oc.setTRS(A.ZERO,this.meshInstance.node.getRotation(),jk.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));c=null===this.meshInstance.node?A.ONE:this.meshInstance.node.localScale;this.emitterScaleUniform[0]=c.x;this.emitterScaleUniform[1]=
c.y;this.emitterScaleUniform[2]=c.z;this.material.setParameter("emitterScale",this.emitterScaleUniform);if(this.localSpace&&this.meshInstance.node){var e=this.meshInstance.node.getPosition();this.emitterPosUniform[0]=e.x;this.emitterPosUniform[1]=e.y;this.emitterPosUniform[2]=e.z;this.material.setParameter("emitterPos",this.emitterPosUniform)}this._compParticleFaceParams();this.useCpu?(a=new Float32Array(this.vertexBuffer.lock()),this._cpuUpdater.update(a,this.vbToSort,this.particleTex,Oc,Zb,e,d,
b)):this._gpuUpdater.update(a,Oc,Zb,d,b);if(!this.loop&&Date.now()>this.endTime){if(this.onFinished)this.onFinished();this.meshInstance.visible=!1}this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder)};g._destroyResources=function(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null);this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null);this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=
null);this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),this.rtParticleTexIN=null);this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null);this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null);this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null);this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null);this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=null);this.colorParam&&(this.colorParam.destroy(),
this.colorParam=null);this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=void 0);this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0);this.material&&(this.material.destroy(),this.material=null)};g.destroy=function(){this.camera=null;this._destroyResources()};return l}(),Md=[],mh=function(l){function g(){var b=l.call(this)||this;b.destroy=function(){this.skybox=null};b.root=null;b._gravity=new A(0,-9.8,0);b._layers=null;b._fog="none";b.fogColor=new Q(0,0,0);b.fogStart=
1;b.fogEnd=1E3;b.fogDensity=0;b.ambientLight=new Q(0,0,0);b._gammaCorrection=0;b._toneMapping=0;b.exposure=1;b._skyboxPrefiltered=[null,null,null,null,null,null];b._firstUpdateSkybox=!0;b._skyboxCubeMap=null;b.skyboxModel=null;b._skyboxIntensity=1;b._skyboxMip=0;b._skyboxRotation=new ea;b._skyboxRotationMat3=null;b._skyboxRotationMat4=null;b._skyboxIsRenderTarget=!1;b.lightmapSizeMultiplier=1;b.lightmapMaxResolution=2048;b.lightmapMode=1;b._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,
lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0};b.updateShaders=!0;b.updateSkybox=!0;b._shaderVersion=0;b._statsUpdated=!1;b._models=[];b.defaultMaterial=new ma;b.defaultMaterial.name="Default Material";b.defaultMaterial.shadingModel=1;return b}K(g,l);var d=g.prototype;d.destroy=function(){this.root=null;this.defaultMaterial.destroy();this.defaultMaterial=null;this.off()};d.applySettings=
function(b){this._gravity.set(b.physics.gravity[0],b.physics.gravity[1],b.physics.gravity[2]);this.ambientLight.set(b.render.global_ambient[0],b.render.global_ambient[1],b.render.global_ambient[2]);this._fog=b.render.fog;this.fogColor.set(b.render.fog_color[0],b.render.fog_color[1],b.render.fog_color[2]);this.fogStart=b.render.fog_start;this.fogEnd=b.render.fog_end;this.fogDensity=b.render.fog_density;this._gammaCorrection=b.render.gamma_correction;this._toneMapping=b.render.tonemapping;this.lightmapSizeMultiplier=
b.render.lightmapSizeMultiplier;this.lightmapMaxResolution=b.render.lightmapMaxResolution;this.lightmapMode=b.render.lightmapMode;this.exposure=b.render.exposure;this._skyboxIntensity=void 0===b.render.skyboxIntensity?1:b.render.skyboxIntensity;this._skyboxMip=void 0===b.render.skyboxMip?0:b.render.skyboxMip;void 0!==b.render.skyboxRotation&&this._skyboxRotation.setFromEulerAngles(b.render.skyboxRotation[0],b.render.skyboxRotation[1],b.render.skyboxRotation[2]);this._resetSkyboxModel();this.updateShaders=
!0};d._updateSkybox=function(b){if(!this.skyboxModel){var a=[0,1,3,4,5,6],c=this._skyboxMip?this._skyboxPrefiltered[a[this._skyboxMip]]||this._skyboxPrefiltered[0]||this._skyboxCubeMap:this._skyboxCubeMap||this._skyboxPrefiltered[0];if(c){this._skyboxIsRenderTarget=c._isRenderTarget?!0:!1;var e=new Fa,f=this;e.updateShader=function(m,n,p,t,r){this.shader=b.getProgramLibrary().getProgram("skybox",{rgbm:"rgbm"===c.type,hdr:"rgbm"===c.type||14===c.format,useIntensity:1!==f.skyboxIntensity,useCubeMapRotation:!f.skyboxRotation.equals(ea.IDENTITY),
useRightHandedCubeMap:f._skyboxIsRenderTarget,mip:c.fixCubemapSeams?f.skyboxMip:0,fixSeams:c.fixCubemapSeams,gamma:1===r?f.gammaCorrection?3:0:f.gammaCorrection,toneMapping:1===r?0:f.toneMapping})};e.updateShader();e.setParameter("texture_cubeMap",c);this.skyboxRotation.equals(ea.IDENTITY)||(this._skyboxRotationMat4||(this._skyboxRotationMat4=new M),this._skyboxRotationMat3||(this._skyboxRotationMat3=new lb),this._skyboxRotationMat4.setTRS(pc.Vec3.ZERO,this._skyboxRotation,pc.Vec3.ONE),this._skyboxRotationMat4.invertTo3x3(this._skyboxRotationMat3),
e.setParameter("cubeMapRotationMatrix",this._skyboxRotationMat3.data));e.cull=2;e.depthWrite=!1;if(a=this.layers.getLayerById(2)){var h=new pa,k=Oe(b);e=new Ga(h,k,e);e.cull=!1;e._noDepthDrawGl1=!0;k=new fb;k.graph=h;k.meshInstances=[e];this.skyboxModel=k;a.addMeshInstances(k.meshInstances);this.skyLayer=a;this._firstUpdateSkybox&&(a.enabled=!0,this._firstUpdateSkybox=!1);this.fire("set:skybox",c)}}}};d._resetSkyboxModel=function(){this.skyboxModel&&(this.skyLayer.removeMeshInstances(this.skyboxModel.meshInstances),
this.skyboxModel.destroy());this.skyboxModel=null;this.updateSkybox=!0};d.setSkybox=function(b){var a;b||(b=[null,null,null,null,null,null,null]);var c=!1;this._skyboxCubeMap!==b[0]&&(c=!0);if(!c)for(a=0;6>a&&!c;a++)this._skyboxPrefiltered[a]!==b[a+1]&&(c=!0);if(c){for(a=0;6>a;a++)this._skyboxPrefiltered[a]=b[a+1];this.skybox=b[0]}};d.addModel=function(b){if(!this.containsModel(b)){var a=this.layers.getLayerById(0);a&&(a.addMeshInstances(b.meshInstances),this._models.push(b))}};d.addShadowCaster=
function(b){var a=this.layers.getLayerById(0);a&&a.addShadowCasters(b.meshInstances)};d.removeModel=function(b){var a=this._models.indexOf(b);if(-1!==a){var c=this.layers.getLayerById(0);c&&(c.removeMeshInstances(b.meshInstances),this._models.splice(a,1))}};d.removeShadowCasters=function(b){var a=this.layers.getLayerById(0);a&&a.removeShadowCasters(b.meshInstances)};d.containsModel=function(b){return 0<=this._models.indexOf(b)};d.getModels=function(b){return this._models};N(g,[{key:"fog",get:function(){return this._fog},
set:function(b){b!==this._fog&&(this._fog=b,this.updateShaders=!0)}},{key:"gammaCorrection",get:function(){return this._gammaCorrection},set:function(b){b!==this._gammaCorrection&&(this._gammaCorrection=b,this.updateShaders=!0)}},{key:"toneMapping",get:function(){return this._toneMapping},set:function(b){b!==this._toneMapping&&(this._toneMapping=b,this.updateShaders=!0)}},{key:"skybox",get:function(){return this._skyboxCubeMap},set:function(b){this._skyboxCubeMap=b;this._resetSkyboxModel();this.updateShaders=
!0}},{key:"skyboxIntensity",get:function(){return this._skyboxIntensity},set:function(b){this._skyboxIntensity=b;this._resetSkyboxModel();this.updateShaders=!0}},{key:"skyboxRotation",get:function(){return this._skyboxRotation},set:function(b){this._skyboxRotation.equals(b)||(this._skyboxRotation.copy(b),this._resetSkyboxModel(),this.updateShaders=!0)}},{key:"skyboxMip",get:function(){return this._skyboxMip},set:function(b){this._skyboxMip=b;this._resetSkyboxModel();this.updateShaders=!0}},{key:"skyboxPrefiltered128",
get:function(){return this._skyboxPrefiltered[0]},set:function(b){this._skyboxPrefiltered[0]!==b&&(this._skyboxPrefiltered[0]=b,this.updateShaders=!0)}},{key:"skyboxPrefiltered64",get:function(){return this._skyboxPrefiltered[1]},set:function(b){this._skyboxPrefiltered[1]!==b&&(this._skyboxPrefiltered[1]=b,this.updateShaders=!0)}},{key:"skyboxPrefiltered32",get:function(){return this._skyboxPrefiltered[2]},set:function(b){this._skyboxPrefiltered[2]!==b&&(this._skyboxPrefiltered[2]=b,this.updateShaders=
!0)}},{key:"skyboxPrefiltered16",get:function(){return this._skyboxPrefiltered[3]},set:function(b){this._skyboxPrefiltered[3]!==b&&(this._skyboxPrefiltered[3]=b,this.updateShaders=!0)}},{key:"skyboxPrefiltered8",get:function(){return this._skyboxPrefiltered[4]},set:function(b){this._skyboxPrefiltered[4]!==b&&(this._skyboxPrefiltered[4]=b,this.updateShaders=!0)}},{key:"skyboxPrefiltered4",get:function(){return this._skyboxPrefiltered[5]},set:function(b){this._skyboxPrefiltered[5]!==b&&(this._skyboxPrefiltered[5]=
b,this.updateShaders=!0)}},{key:"drawCalls",get:function(){var b=this.layers._meshInstances;b.length||(this.layers._update(),b=this.layers._meshInstances);return b},set:function(b){}},{key:"layers",get:function(){return this._layers},set:function(b){var a=this._layers;this._layers=b;this.fire("set:layers",a,b)}},{key:"defaultMaterial",get:function(){return Fa.defaultMaterial},set:function(b){Fa.defaultMaterial=b}}]);return g}(ba),ud=function(){function l(d,b,a){void 0===a&&(a={});this.volume=void 0===
a.volume?1:a.volume;this.loop=void 0===a.loop?!1:a.loop;this.pitch=void 0===a.pitch?1:a.pitch;this.sound=b;this.suspended=this.paused=!1;this.manager=d;this.source=null;wb()?(this.startOffset=this.startTime=0,this.gain=d.context.createGain()):Pe()&&b.audio&&(this.source=b.audio.cloneNode(!1),this.source.pause())}var g=l.prototype;g.getVolume=function(){return this.volume};g.getLoop=function(){return this.loop};g.setLoop=function(d){this.loop=d;this.source&&(this.source.loop=d)};g.getPitch=function(){return this.pitch};
g.onManagerVolumeChange=function(){this.setVolume(this.getVolume())};g.onManagerSuspend=function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())};g.onManagerResume=function(){this.suspended&&(this.suspended=!1,this.unpause())};return l}();wb()?Object.assign(ud.prototype,{play:function(){if(this.source)throw Error("Call stop() before calling play()");this._createSource();if(this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),
this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended))this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)},unpause:function(){this.source||!this.paused?console.warn("Call pause() before unpausing."):
(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1))},stop:function(){this.source&&(this.source.stop(0),this.source=null);this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setVolume:function(l){this.volume=
l=R.clamp(l,0,1);this.gain&&(this.gain.gain.value=l*this.manager.volume)},setPitch:function(l){this.pitch=l;this.source&&(this.source.playbackRate.value=l)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?this.source.buffer.duration:0},_createSource:function(){var l=this.manager.context;this.sound.buffer&&(this.source=l.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),
this.gain.connect(l.destination),this.loop||(this.source.onended=this.pause.bind(this)))}}):Pe()&&Object.assign(ud.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play());this.manager.on("volumechange",this.onManagerVolumeChange,this);this.manager.on("suspend",this.onManagerSuspend,this);this.manager.on("resume",this.onManagerResume,this);if(this.manager.suspended)this.onManagerSuspend()},pause:function(){this.source&&
(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause();this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setVolume:function(l){this.volume=l=R.clamp(l,0,1);this.source&&(this.source.volume=l*this.manager.volume)},setPitch:function(l){this.pitch=l;this.source&&(this.source.playbackRate=
l)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}});var Mb=function(l){function g(b,a,c){a=l.call(this,b,a,c)||this;a.position=new A;a.velocity=new A;wb()?a.panner=b.context.createPanner():(a.maxDistance=1E4,a.minDistance=1,a.rollOffFactor=1,a.distanceModel="inverse");return a}K(g,l);var d=g.prototype;d.getPosition=function(){return this.position};d.getVelocity=function(){return this.velocity};return g}(ud);
if(wb())Object.assign(Mb.prototype,{setPosition:function(l){this.position.copy(l);this.panner.setPosition(l.x,l.y,l.z)},setVelocity:function(l){this.velocity.copy(l);this.panner.setVelocity(l.x,l.y,l.z)},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(l){this.panner.maxDistance=l},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(l){this.panner.refDistance=l},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(l){this.panner.rolloffFactor=
l},getDistanceModel:function(){return this.pannel.distanceModel},setDistanceModel:function(l){this.panner.distanceModel=l},_createSource:function(){var l=this.manager.context;this.source=l.createBufferSource();this.source.buffer=this.sound.buffer;this.source.connect(this.panner);this.panner.connect(this.gain);this.gain.connect(l.destination);this.loop||(this.source.onended=this.pause.bind(this))}});else{var nh=new A;Object.assign(Mb.prototype,{setPosition:function(l){this.position.copy(l);if(this.source){var g=
this.manager.listener.getPosition();l=this.minDistance;var d=this.maxDistance,b=this.rollOffFactor,a=this.distanceModel;nh=nh.sub2(g,this.position);g=nh.length();if(g<l)l=1;else if(g>d)l=0;else{var c=0;"linear"===a?c=1-b*(g-l)/(d-l):"inverse"===a?c=l/(l+b*(g-l)):"exponential"===a&&(c=Math.pow(g/l,-b));l=R.clamp(c,0,1)}d=this.getVolume();this.source.volume=d*l}},setVelocity:function(l){this.velocity.copy(l)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(l){this.maxDistance=
l},getMinDistance:function(){return this.minDistance},setMinDistance:function(l){this.minDistance=l},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(l){this.rollOffFactor=l},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(l){this.distanceModel=l}})}var kk=function(){function l(d){this.position=new A;this.velocity=new A;this.orientation=new M;wb()&&(this.listener=d.context.listener)}var g=l.prototype;g.getPosition=function(){return this.position};
g.setPosition=function(d){this.position.copy(d);this.listener&&this.listener.setPosition(d.x,d.y,d.z)};g.getVelocity=function(){return this.velocity};g.setVelocity=function(d){this.velocity.copy(d);this.listener&&this.listener.setPosition(d.x,d.y,d.z)};g.setOrientation=function(d){this.orientation.copy(d);this.listener&&this.listener.setOrientation(-d.data[8],-d.data[9],-d.data[10],d.data[4],d.data[5],d.data[6])};g.getOrientation=function(){return this.orientation};return l}(),vd=function(l){function g(b){var a=
l.call(this)||this;if(wb()||b.forceWebAudioApi){if("undefined"!==typeof AudioContext?a.context=new AudioContext:"undefined"!==typeof webkitAudioContext&&(a.context=new webkitAudioContext),a.context){var c=a.context;a.resumeContext=function(){this.context.resume();window.removeEventListener("mousedown",this.resumeContext);window.removeEventListener("touchend",this.resumeContext)}.bind(F(a));window.addEventListener("mousedown",a.resumeContext);window.addEventListener("touchend",a.resumeContext);za.ios&&
window.addEventListener("touchend",function f(){var h=c.createBuffer(1,1,44100),k=c.createBufferSource();k.buffer=h;k.connect(c.destination);k.start(0);k.disconnect();window.removeEventListener("touchend",f)})}}else console.warn("No support for 3D audio found");Pe()||console.warn("No support for 2D audio found");a.listener=new kk(F(a));a._volume=1;a.suspended=!1;return a}K(g,l);var d=g.prototype;d.suspend=function(){this.suspended=!0;this.fire("suspend")};d.resume=function(){this.suspended=!1;this.fire("resume")};
d.destroy=function(){window.removeEventListener("mousedown",this.resumeContext);window.removeEventListener("touchend",this.resumeContext);this.fire("destroy");this.context&&this.context.close&&(this.context.close(),this.context=null)};d.playSound=function(b,a){a=a||{};var c=null;ud&&(c=new ud(this,b,a),c.play());return c};d.playSound3d=function(b,a,c){c=c||{};var e=null;Mb&&(e=new Mb(this,b,c),e.setPosition(a),c.volume&&e.setVolume(c.volume),c.loop&&e.setLoop(c.loop),c.maxDistance&&e.setMaxDistance(c.maxDistance),
c.minDistance&&e.setMinDistance(c.minDistance),c.rollOffFactor&&e.setRollOffFactor(c.rollOffFactor),c.distanceModel&&e.setDistanceModel(c.distanceModel),e.play());return e};N(g,[{key:"volume",get:function(){return this._volume},set:function(b){this._volume=b=R.clamp(b,0,1);this.fire("volumechange",b)}}]);return g}(ba),Df=function(l,g,d,b){this.time=l;this.position=g;this.rotation=d;this.scale=b},Ef=function(){this._name="";this._keys=[]},$b=function(){function l(){this.name="";this.duration=0;this._nodes=
[];this._nodeDict={}}var g=l.prototype;g.getNode=function(d){return this._nodeDict[d]};g.addNode=function(d){this._nodes.push(d);this._nodeDict[d._name]=d};N(l,[{key:"nodes",get:function(){return this._nodes}}]);return l}(),oh=function(){function l(d){2===arguments.length&&(d=arguments[1]);this.options=d;this.name=d.name;this.defaultWeight=d.defaultWeight||0;this.aabb=d.aabb;this.aabb||(this.aabb=new la,d.deltaPositions&&this.aabb.compute(d.deltaPositions));this.deltaPositions=d.deltaPositions}var g=
l.prototype;g._postInit=function(){this.options=null};g._initVertexBuffers=function(d){var b=this.options;this._vertexBufferPositions=this._createVertexBuffer(d,b.deltaPositions,b.deltaPositionsType);this._vertexBufferNormals=this._createVertexBuffer(d,b.deltaNormals,b.deltaNormalsType);this._vertexBufferPositions&&(this.deltaPositions=this._vertexBufferPositions.lock())};g._createVertexBuffer=function(d,b,a){void 0===a&&(a=6);return b?new Ra(d,new Ma(d,[{semantic:"ATTR0",components:3,type:a}]),b.length/
3,0,b):null};g._setTexture=function(d,b){this[d]=b};g.destroy=function(){this._vertexBufferPositions&&(this._vertexBufferPositions.destroy(),this._vertexBufferPositions=null);this._vertexBufferNormals&&(this._vertexBufferNormals.destroy(),this._vertexBufferNormals=null);this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null);this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)};N(l,[{key:"morphPositions",get:function(){return!!this._vertexBufferPositions||
!!this.texturePositions}},{key:"morphNormals",get:function(){return!!this._vertexBufferNormals||!!this.textureNormals}}]);return l}(),Ff=function(l,g,d){this.device=l;this.inverseBindPose=g;this.boneNames=d},ph=function(){function l(g,d,b,a){this._paths=g;this._input=d;this._output=b;this._interpolation=a}N(l,[{key:"paths",get:function(){return this._paths}},{key:"input",get:function(){return this._input}},{key:"output",get:function(){return this._output}},{key:"interpolation",get:function(){return this._interpolation}}]);
return l}(),Gf=function(){function l(g,d){this._components=g;this._data=d}N(l,[{key:"components",get:function(){return this._components}},{key:"data",get:function(){return this._data}}]);return l}(),ke=function(){function l(g,d,b,a,c){this._name=g;this._duration=d;this._inputs=b;this._outputs=a;this._curves=c}l.prototype.eval=function(g,d){d._time=g;var b=this._inputs,a=this._outputs,c=this._curves,e=d._cache;d=d._results;var f;for(f=0;f<b.length;++f)e[f].update(g,b[f]._data);for(f=0;f<c.length;++f)g=
c[f],e[g._input].eval(d[f],g._interpolation,a[g._output])};N(l,[{key:"name",get:function(){return this._name}},{key:"duration",get:function(){return this._duration}},{key:"inputs",get:function(){return this._inputs}},{key:"outputs",get:function(){return this._outputs}},{key:"curves",get:function(){return this._curves}}]);return l}(),yo=function(){function l(){}var g=l.prototype;g._validate=function(d){if(!d.header)throw Error('pc.I18n#addData: Missing "header" field');if(!d.header.version)throw Error('pc.I18n#addData: Missing "header.version" field');
if(1!==d.header.version)throw Error('pc.I18n#addData: Invalid "header.version" field');if(!d.data)throw Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(d.data))throw Error('pc.I18n#addData: "data" field must be an array');for(var b=0,a=d.data.length;b<a;b++){var c=d.data[b];if(!c.info)throw Error('pc.I18n#addData: missing "data['+b+'].info" field');if(!c.info.locale)throw Error('pc.I18n#addData: missing "data['+b+'].info.locale" field');if("string"!==typeof c.info.locale)throw Error('pc.I18n#addData: "data['+
b+'].info.locale" must be a string');if(!c.messages)throw Error('pc.I18n#addData: missing "data['+b+'].messages" field');}};g.parse=function(d){return d.data};return l}(),le={},kc=function(l,g){for(var d=0,b=l.length;d<b;d++)le[l[d]]=g},lc=function(l){var g=l.indexOf("-");return-1!==g?l.substring(0,g):l},Hf={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"};kc("ja ko th vi zh id".split(" "),function(l){return 0});
kc(["fa","hi"],function(l){return 0<=l&&1>=l?0:1});kc(["fr","pt"],function(l){return 0<=l&&2>l?0:1});kc(["da"],function(l){return 1===l||!Number.isInteger(l)&&0<=l&&1>=l?0:1});kc("de en it el es tr fi sv nb no ur".split(" "),function(l){return 1===l?0:1});kc(["ru","uk"],function(l){if(Number.isInteger(l)){var g=l%10;l%=100;if(1===g&&11!==l)return 0;if(2<=g&&4>=g&&(12>l||14<l))return 1;if(0===g||5<=g&&9>=g||11<=l&&14>=l)return 2}return 3});kc(["pl"],function(l){if(Number.isInteger(l)){if(1===l)return 0;
var g=l%10;l%=100;if(2<=g&&4>=g&&(12>l||14<l))return 1;if(0<=g&&1>=g||5<=g&&9>=g||12<=l&&14>=l)return 2}return 3});kc(["ar"],function(l){if(0===l)return 0;if(1===l)return 1;if(2===l)return 2;if(Number.isInteger(l)){l%=100;if(3<=l&&10>=l)return 3;if(11<=l&&99>=l)return 4}return 5});var qh=le[lc("en-US")],rh=function(l){function g(b){var a=l.call(this)||this;a.destroy=function(){this._parser=this._assets=this._availableLangs=this._translations=null;this.off()};a.locale="en-US";a._translations={};a._availableLangs=
{};a._app=b;a._assets=[];a._parser=new yo;return a}K(g,l);g.findAvailableLocale=function(b,a){if(a[b])return b;var c=Hf[b];if(c&&a[c])return c;b=lc(b);c=Hf[b];return a[c]?c:a[b]?b:"en-US"};var d=g.prototype;d.getText=function(b,a){var c=b;if(!a){a=this._locale;var e=this._lang}var f=this._translations[a];f||(e||(e=lc(a)),a=this._findFallbackLocale(a,e),f=this._translations[a]);f&&f.hasOwnProperty(b)&&(c=f[b],Array.isArray(c)&&(c=c[0]),null===c||void 0===c)&&(c=b);return c};d.getPluralText=function(b,
a,c){var e=b;if(c){var f=lc(c);var h=le[f]||qh}else c=this._locale,f=this._lang,h=this._pluralFn;var k=this._translations[c];k||(c=this._findFallbackLocale(c,f),f=lc(c),h=le[f]||qh,k=this._translations[c]);k&&k[b]&&h&&(a=h(a),e=k[b][a],null===e||void 0===e)&&(e=b);return e};d.addData=function(b){try{var a=this._parser.parse(b)}catch(k){console.error(k);return}b=0;for(var c=a.length;b<c;b++){var e=a[b],f=e.info.locale;e=e.messages;if(!this._translations[f]){this._translations[f]={};var h=lc(f);this._availableLangs[h]||
(this._availableLangs[h]=f)}Object.assign(this._translations[f],e);this.fire("data:add",f,e)}};d.removeData=function(b){var a;try{var c=this._parser.parse(b)}catch(n){console.error(n);return}b=0;for(var e=c.length;b<e;b++){var f=c[b],h=f.info.locale,k=this._translations[h];if(k){f=f.messages;for(a in f)delete k[a];var m=!1;for(a in k){m=!0;break}m||(delete this._translations[h],delete this._availableLangs[lc(h)]);this.fire("data:remove",h,f)}}};d._findFallbackLocale=function(b,a){return(b=Hf[b])&&
this._translations[b]||(b=Hf[a])&&this._translations[b]?b:(b=this._availableLangs[a])&&this._translations[b]?b:"en-US"};d._onAssetAdd=function(b){b.on("load",this._onAssetLoad,this);b.on("change",this._onAssetChange,this);b.on("remove",this._onAssetRemove,this);b.on("unload",this._onAssetUnload,this);b.resource&&this._onAssetLoad(b)};d._onAssetLoad=function(b){this.addData(b.resource)};d._onAssetChange=function(b){b.resource&&this.addData(b.resource)};d._onAssetRemove=function(b){b.off("load",this._onAssetLoad,
this);b.off("change",this._onAssetChange,this);b.off("remove",this._onAssetRemove,this);b.off("unload",this._onAssetUnload,this);b.resource&&this.removeData(b.resource);this._app.assets.once("add:"+b.id,this._onAssetAdd,this)};d._onAssetUnload=function(b){b.resource&&this.removeData(b.resource)};N(g,[{key:"locale",get:function(){return this._locale},set:function(b){if(this._locale!==b){var a=lc(b);if("in"===a){a="id";var c=a,e=b.indexOf("-");b=-1!==e?c+b.substring(e):c;if(this._locale===b)return}c=
this._locale;this._locale=b;this._lang=a;this._pluralFn=le[this._lang]||qh;this.fire("set:locale",b,c)}}},{key:"assets",get:function(){return this._assets},set:function(b){var a,c={};var e=0;for(a=b.length;e<a;e++){var f=b[e]instanceof fa?b[e].id:b[e];c[f]=!0}for(e=this._assets.length;e--;)f=this._assets[e],c[f]||(this._app.assets.off("add:"+f,this._onAssetAdd,this),(b=this._app.assets.get(f))&&this._onAssetRemove(b),this._assets.splice(e,1));for(f in c)if(f=parseInt(f,10),-1===this._assets.indexOf(f))if(this._assets.push(f),
b=this._app.assets.get(f))this._onAssetAdd(b);else this._app.assets.once("add:"+f,this._onAssetAdd,this)}}]);return g}(ba),wd=/^\s*(?:(?:[a-z]+[a-z0-9\-\+\.]*:)?\/\/|data:|blob:)/i,ug=[],Ti=function(){function l(g){this.asset=g}l.prototype.clear=function(){for(var g=0;g<ug.length;g++)this[ug[g]]=null};return l}();Nd("dxt");Nd("pvr");Nd("etc1");Nd("etc2");Nd("basis");var zo=-1,Ao={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",
basis:"canvas"},lk=["pvr","dxt","etc2","etc1","basis"],fa=function(l){function g(b,a,c,e,f){var h=l.call(this)||this;h._id=zo--;h.name=b||"";h.type=a;h.tags=new Ng(F(h));h._preload=!1;h.variants=new Ti(F(h));h._file=null;h._data=e||{};h.options=f||{};h._resources=[];h._i18n={};h.loaded=!1;h.loading=!1;h.registry=null;c&&(h.file=c);return h}K(g,l);var d=g.prototype;d.getFileUrl=function(){var b=this.getPreferredFile();if(!b||!b.url)return null;var a=b.url;this.registry&&this.registry.prefix&&!wd.test(a)&&
(a=this.registry.prefix+a);if("script"!==this.type&&b.hash){var c=-1!==a.indexOf("?")?"&":"?";a+=c+"t="+b.hash}return a};d.getPreferredFile=function(){if(!this.file)return null;if("texture"===this.type||"textureatlas"===this.type||"bundle"===this.type)for(var b=this.registry._loader._app,a=b.graphicsDevice,c=0,e=lk.length;c<e;c++){var f=lk[c];if(a[Ao[f]]){if(this.file.variants[f])return this.file.variants[f];if(b.enableBundles){var h=b.bundles.listBundlesForAsset(this);if(h)for(var k=0,m=h.length;k<
m;k++)if(h[k].file&&h[k].file.variants&&h[k].file.variants[f])return this.file}}}return this.file};d.getAbsoluteUrl=function(b){var a=da.getDirectory(this.file.url);return da.join(a,b)};d.getLocalizedAssetId=function(b){b=rh.findAvailableLocale(b,this._i18n);return this._i18n[b]||null};d.addLocalizedAssetId=function(b,a){this._i18n[b]=a;this.fire("add:localized",b,a)};d.removeLocalizedAssetId=function(b){var a=this._i18n[b];a&&(delete this._i18n[b],this.fire("remove:localized",b,a))};d.ready=function(b,
a){a=a||this;if(this.resource)b.call(a,this);else this.once("load",function(c){b.call(a,c)})};d.reload=function(){this.loaded&&(this.loaded=!1,this.registry.load(this))};d.unload=function(){if(this.loaded||0!==this._resources.length){this.fire("unload",this);this.registry.fire("unload:"+this.id,this);var b=this._resources;this.resources=[];this.loaded=!1;this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(var a=0;a<b.length;++a){var c=b[a];c&&c.destroy&&c.destroy()}}};N(g,
[{key:"id",get:function(){return this._id},set:function(b){this._id=b}},{key:"file",get:function(){return this._file},set:function(b){var a;if(!!b!==!!this._file||b&&this._file&&b.hash!==this._file)if(b){this._file||(this._file={});this._file.url=b.url;this._file.filename=b.filename;this._file.hash=b.hash;this._file.size=b.size;this._file.variants=this.variants;this._file.contents=b.contents;if(b.hasOwnProperty("variants")&&(this.variants.clear(),b.variants))for(a in b.variants)b.variants[a]&&(this.variants[a]=
b.variants[a]);this.fire("change",this,"file",this._file,this._file);this.reload()}else this._file=null,this.variants.clear();else if(b&&this._file&&b.hasOwnProperty("variants")&&(this.variants.clear(),b.variants))for(a in b.variants)b.variants[a]&&(this.variants[a]=b.variants[a])}},{key:"data",get:function(){return this._data},set:function(b){var a=this._data;this._data=b;b!==a&&(this.fire("change",this,"data",b,a),this.loaded&&this.registry._loader.patch(this,this.registry))}},{key:"resource",get:function(){return this._resources[0]},
set:function(b){var a=this._resources[0];this._resources[0]=b;this.fire("change",this,"resource",b,a)}},{key:"resources",get:function(){return this._resources},set:function(b){var a=this._resources;this._resources=b;this.fire("change",this,"resources",b,a)}},{key:"preload",get:function(){return this._preload},set:function(b){b=!!b;this._preload!==b&&(this._preload=b)&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this)}},{key:"loadFaces",get:function(){return this._loadFaces},set:function(b){b=
!!b;this.hasOwnProperty("_loadFaces")&&b===this._loadFaces||(this._loadFaces=b,this.loaded&&this.registry._loader.patch(this,this.registry))}}]);return g}(ba),Pc=function(){function l(){}l.joinPath=function(d,b){b=b||".";return d.map(function(a){return a.replace(/\\/g,"\\\\").replace(new RegExp("\\"+b,"g"),"\\"+b)}).join(b)};l.splitPath=function(d,b){b=b||".";for(var a=[],c="",e=0;e<d.length;){var f=d[e++];"\\"===f&&e<d.length?(f=d[e++],c="\\"===f||f===b?c+f:c+("\\"+f)):f===b?(a.push(c),c=""):c+=
f}0<c.length&&a.push(c);return a};var g=l.prototype;g.resolve=function(d){return null};g.unresolve=function(d){};g.update=function(d){};return l}(),sh=function(){function l(){}var g=l.prototype;g.encode=function(d){return Pc.joinPath([Pc.joinPath(d[0]),d[1],Pc.joinPath(d[2])],"/")};g.decode=function(d){d=Pc.splitPath(d,"/");return[Pc.splitPath(d[0]),d[1],Pc.splitPath(d[2])]};return l}(),If=function(l){switch(l){case "SCALAR":return 1;case "VEC2":return 2;case "VEC3":return 3;case "VEC4":return 4;
case "MAT2":return 4;case "MAT3":return 9;case "MAT4":return 16;default:return 3}},th=function(l){switch(l){case 5120:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6;default:return 0}},Bo=function(l){switch(l){case 5120:return 1;case 5121:return 1;case 5122:return 2;case 5123:return 2;case 5124:return 4;case 5125:return 4;case 5126:return 4;default:return 0}},Co=function(l){switch(l){case 5120:return Int8Array;case 5121:return Uint8Array;
case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}},Jf={POSITION:"POSITION",NORMAL:"NORMAL",TANGENT:"TANGENT",COLOR_0:"COLOR",JOINTS_0:"BLENDINDICES",WEIGHTS_0:"BLENDWEIGHT",TEXCOORD_0:"TEXCOORD0",TEXCOORD_1:"TEXCOORD1"},xd=function b(g,d){var a=If(g.type),c=Co(g.componentType);if(!c)return null;if(g.sparse){var e=g.sparse,f=b(Object.assign({count:e.count,type:"SCALAR"},e.indices),d),
h=b(Object.assign({count:e.count,type:g.scalar,componentType:g.componentType},e.values),d);g=g.hasOwnProperty("bufferView")?b({bufferView:g.bufferView,byteOffset:g.byteOffset,componentType:g.componentType,count:g.count,type:g.type},d).slice():new c(g.count*a);for(c=0;c<e.count;++c){d=f[c];for(var k=0;k<a;++k)g[d*a+k]=h[c*a+k]}}else e=d[g.bufferView],g=new c(e.buffer,e.byteOffset+(g.hasOwnProperty("byteOffset")?g.byteOffset:0),g.count*a);return g},Do=function(g){if(!g.hasOwnProperty("mode"))return 4;
switch(g.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;case 5:return 5;case 6:return 6;default:return 4}},mk=function(g,d){var b=g.POSITION;if(b&&3===b.components){if(b.size!==b.stride){var a=b.stride/$d[b.type],c=new Fc[b.type](b.buffer,b.offset,b.count*a);var e=new Fc[b.type](3*b.count);for(var f=0;f<b.count;++f)e[3*f]=c[f*a],e[3*f+1]=c[f*a+1],e[3*f+2]=c[f*a+2]}else e=new Fc[b.type](b.buffer,b.offset,3*b.count);b=b.count;if(!d)for(d=new Uint16Array(b),a=0;a<
b;a++)d[a]=a;e=Pi(e,d);d=new Float32Array(e.length);d.set(e);g.NORMAL={buffer:d.buffer,size:12,offset:0,stride:12,count:b,components:3,type:6}}},Eo=function(g){var d,b,a=[],c=[],e=[];for(d=0;d<g.format.elements.length;++d){var f=g.format.elements[d];if("TEXCOORD0"===f.name||"TEXCOORD1"===f.name)switch(f.dataType){case 6:a.push({offset:f.offset/4+1,stride:f.stride/4});break;case 3:c.push({offset:f.offset/2+1,stride:f.stride/2});break;case 1:e.push({offset:f.offset+1,stride:f.stride})}}f=function(h,
k,m){k=new k(g.storage);for(d=0;d<h.length;++d){var n=h[d].offset,p=h[d].stride;for(b=0;b<g.numVertices;++b)k[n]=m-k[n],n+=p}};0<a.length&&f(a,Float32Array,1);0<c.length&&f(c,Uint16Array,65535);0<e.length&&f(e,Uint8Array,255)},nk=function(g,d,b){var a=d.POSITION,c=a.count,e=[];for(p in d)d.hasOwnProperty(p)&&e.push({semantic:p,components:d[p].components,type:d[p].type,normalize:!!d[p].normalize});var f="POSITION NORMAL TANGENT COLOR BLENDINDICES BLENDWEIGHT TEXCOORD0 TEXCOORD1".split(" ");e.sort(function(v,
w){v=f.indexOf(v.semantic);w=f.indexOf(w.semantic);return v<w?-1:w<v?1:0});var h,k=new Ma(g,e),m=!0;for(e=0;e<k.elements.length;++e){var n=k.elements[e];var p=d[n.name];var t=p.offset-a.offset;if(p.buffer!==a.buffer||p.stride!==n.stride||p.size!==n.size||t!==n.offset){m=!1;break}}g=new Ra(g,k,c,0);e=g.lock();t=new Uint32Array(e);if(m)a=new Uint32Array(a.buffer,a.offset,c*g.format.size/4),t.set(a);else for(e=0;e<g.format.elements.length;++e){n=g.format.elements[e];m=n.stride/4;p=d[n.name];a=new Uint32Array(p.buffer,
p.offset,p.count*p.stride/4);k=p.stride/4;var r=0;n=n.offset/4;var u=Math.floor((p.size+3)/4);for(p=0;p<c;++p){for(h=0;h<u;++h)t[n+h]=a[r+h];r+=k;n+=m}}b||Eo(g);g.unlock();return g},Fo=function(g,d,b,a,c,e,f){var h,k={},m=[];for(h in d)d.hasOwnProperty(h)&&Jf.hasOwnProperty(h)&&(k[h]=d[h],m.push(h+":"+d[h]));m.sort();m=m.join();var n=f[m];if(!n){n={};for(h in k){k=a[d[h]];var p=xd(k,c),t=c[k.bufferView],r=Jf[h],u=If(k.type)*Bo(k.componentType);t=t.hasOwnProperty("byteStride")?t.byteStride:u;n[r]=
{buffer:p.buffer,size:u,offset:p.byteOffset,stride:t,count:k.count,components:If(k.type),type:th(k.componentType),normalize:k.normalized}}n.hasOwnProperty("NORMAL")||mk(n,b);n=nk(g,n,e);f[m]=n}return n},Go=function(g,d,b,a,c,e,f){var h,k=d.num_points(),m={};b=b.attributes;for(var n in b)if(b.hasOwnProperty(n)&&Jf.hasOwnProperty(n)){var p=Jf[n];var t=a.GetAttributeByUniqueId(d,b[n]);var r=k*t.num_components();switch(t.data_type()){case c.DT_UINT8:var u=h=1;var v=c._malloc(r*u);a.GetAttributeDataArrayForAllPoints(d,
t,c.DT_UINT8,r*u,v);r=(new Uint8Array(c.HEAPU8.buffer,v,r)).slice();break;case c.DT_UINT16:h=3;u=2;v=c._malloc(r*u);a.GetAttributeDataArrayForAllPoints(d,t,c.DT_UINT16,r*u,v);r=(new Uint16Array(c.HEAPU16.buffer,v,r)).slice();break;default:h=6,u=4,v=c._malloc(r*u),a.GetAttributeDataArrayForAllPoints(d,t,c.DT_FLOAT32,r*u,v),r=(new Float32Array(c.HEAPF32.buffer,v,r)).slice()}c._free(v);v=r;r=t.num_components();t=t.normalized();u*=r;m[p]={values:v,buffer:v.buffer,size:u,offset:0,stride:u,count:k,components:r,
type:h,normalize:t}}m.hasOwnProperty("NORMAL")||mk(m,e);return nk(g,m,f)},Kf=new M,yd=new A,Ho=function(g,d,b,a,c,e,f){var h=[];d.primitives.forEach(function(k){var m=null,n=new bb(g),p=!0;if(k.hasOwnProperty("extensions")){var t=k.extensions;if(t.hasOwnProperty("KHR_draco_mesh_compression")){var r=window.DracoDecoderModule;if(r&&(t=t.KHR_draco_mesh_compression,t.hasOwnProperty("attributes"))){var u=a[t.bufferView];p=new r.DecoderBuffer;p.Init(u,u.length);u=new r.Decoder;var v=u.GetEncodedGeometryType(p);
switch(v){case r.POINT_CLOUD:var w=0;var y=new r.PointCloud;var x=u.DecodeBufferToPointCloud(p,y);break;case r.TRIANGULAR_MESH:w=4,y=new r.Mesh,x=u.DecodeBufferToMesh(p,y)}if(!x||!x.ok()||0==y.ptr){c("Failed to decode draco compressed asset: "+(x?x.error_msg():"Mesh asset - invalid draco compressed geometry type: "+v));return}x=y.num_faces();if(v==r.TRIANGULAR_MESH){m=65535<y.num_points();v=3*x;var z=v*(m?4:2);x=r._malloc(z);m?(u.GetTrianglesUInt32Array(y,z,x),m=(new Uint32Array(r.HEAPU32.buffer,
x,v)).slice()):(u.GetTrianglesUInt16Array(y,z,x),m=(new Uint16Array(r.HEAPU16.buffer,x,v)).slice());r._free(x)}v=Go(g,y,t,u,r,m,e);r.destroy(y);r.destroy(u);r.destroy(p);p=!1}}}v||(m=k.hasOwnProperty("indices")?xd(b[k.indices],a):null,v=Fo(g,k.attributes,m,b,a,e,f),w=Do(k));n.vertexBuffer=v;n.primitive[0].type=w;n.primitive[0].base=0;n.primitive[0].indexed=null!==m;null!==m?(w=m instanceof Uint8Array?0:m instanceof Uint16Array?1:2,2!==w||g.extUintElement||(w=1,m=new Uint16Array(m)),w=new Db(g,w,m.length,
0,m),n.indexBuffer[0]=w,n.primitive[0].count=m.length):n.primitive[0].count=v.numVertices;n.materialIndex=k.material;var B=b[k.attributes.POSITION];w=B.min;r=B.max;w=new la(new A((r[0]+w[0])/2,(r[1]+w[1])/2,(r[2]+w[2])/2),new A((r[0]-w[0])/2,(r[1]-w[1])/2,(r[2]-w[2])/2));n.aabb=w;if(p&&k.hasOwnProperty("targets")){var C=[];k.targets.forEach(function(D,G){var J={};D.hasOwnProperty("POSITION")&&(B=b[D.POSITION],J.deltaPositions=xd(B,a),J.deltaPositionsType=th(B.componentType),B.hasOwnProperty("min")&&
B.hasOwnProperty("max")&&(J.aabb=new la,J.aabb.setMinMax(new A(B.min),new A(B.max))));D.hasOwnProperty("NORMAL")&&(B=b[D.NORMAL],J.deltaNormals=xd(B,a),J.deltaNormalsType=th(B.componentType));d.hasOwnProperty("extras")&&d.extras.hasOwnProperty("targetNames")?J.name=d.extras.targetNames[G]:J.name=C.length.toString(10);C.push(new oh(g,J))});n.morph=new ed(C);if(d.hasOwnProperty("weights"))for(k=0;k<d.weights.length;++k)C[k].defaultWeight=d.weights[k]}h.push(n)});return h},Io=function(g,d,b){var a=[1,
1],c=[0,0],e=function(n,p,t){var r,u=n.texCoord;if(u)for(r=0;r<t.length;++r)p[t[r]+"MapUv"]=u;u=a;var v=c;if(n=n.extensions)if(n=n.KHR_texture_transform)n.scale&&(u=n.scale),n.offset&&(v=n.offset);for(r=0;r<t.length;++r)p[t[r]+"MapTiling"]=new S(u[0],u[1]),p[t[r]+"MapOffset"]=new S(v[0],b?v[1]:1-u[1]-v[1])},f=new ma;f.occludeSpecular=!0;f.diffuseTint=!0;f.diffuseVertexColor=!0;f.specularTint=!0;f.specularVertexColor=!0;g.hasOwnProperty("name")&&(f.name=g.name);if(g.hasOwnProperty("extensions")&&g.extensions.hasOwnProperty("KHR_materials_pbrSpecularGlossiness")){var h=
g.extensions.KHR_materials_pbrSpecularGlossiness;if(h.hasOwnProperty("diffuseFactor")){var k=h.diffuseFactor;f.diffuse.set(Math.pow(k[0],1/2.2),Math.pow(k[1],1/2.2),Math.pow(k[2],1/2.2));f.opacity=null!=k[3]?k[3]:1}else f.diffuse.set(1,1,1),f.opacity=1;if(h.hasOwnProperty("diffuseTexture")){var m=h.diffuseTexture;k=d[m.index];f.diffuseMap=k;f.diffuseMapChannel="rgb";f.opacityMap=k;f.opacityMapChannel="a";e(m,f,["diffuse","opacity"])}f.useMetalness=!1;h.hasOwnProperty("specularFactor")?(k=h.specularFactor,
f.specular.set(Math.pow(k[0],1/2.2),Math.pow(k[1],1/2.2),Math.pow(k[2],1/2.2))):f.specular.set(1,1,1);h.hasOwnProperty("glossinessFactor")?f.shininess=100*h.glossinessFactor:f.shininess=100;h.hasOwnProperty("specularGlossinessTexture")&&(k=h.specularGlossinessTexture,f.specularMap=f.glossMap=d[k.index],f.specularMapChannel="rgb",f.glossMapChannel="a",e(k,f,["gloss","metalness"]));f.chunks.specularPS="#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\n\nvoid getSpecularity() {\n\t\tdSpecularity = vec3(1.0);\n\n\t\t#ifdef MAPCOLOR\n\t\t\t\tdSpecularity *= material_specular;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\t\t\tvec3 srgb = texture2D(texture_specularMap, $UV).$CH;\n\t\t\t\tdSpecularity *= vec3(pow(srgb.r, 2.2), pow(srgb.g, 2.2), pow(srgb.b, 2.2));\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\t\t\tdSpecularity *= saturate(vVertexColor.$VC);\n\t\t#endif\n}"}else g.hasOwnProperty("pbrMetallicRoughness")&&
(h=g.pbrMetallicRoughness,h.hasOwnProperty("baseColorFactor")?(k=h.baseColorFactor,f.diffuse.set(Math.pow(k[0],1/2.2),Math.pow(k[1],1/2.2),Math.pow(k[2],1/2.2)),f.opacity=k[3]):(f.diffuse.set(1,1,1),f.opacity=1),h.hasOwnProperty("baseColorTexture")&&(m=h.baseColorTexture,k=d[m.index],f.diffuseMap=k,f.diffuseMapChannel="rgb",f.opacityMap=k,f.opacityMapChannel="a",e(m,f,["diffuse","opacity"])),f.useMetalness=!0,h.hasOwnProperty("metallicFactor")?f.metalness=h.metallicFactor:f.metalness=1,h.hasOwnProperty("roughnessFactor")?
f.shininess=100*h.roughnessFactor:f.shininess=100,h.hasOwnProperty("metallicRoughnessTexture")&&(k=h.metallicRoughnessTexture,f.metalnessMap=f.glossMap=d[k.index],f.metalnessMapChannel="b",f.glossMapChannel="g",e(k,f,["gloss","metalness"])),f.chunks.glossPS="#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\n\nvoid getGlossiness() {\n\t\tdGlossiness = 1.0;\n\n#ifdef MAPFLOAT\n\t\tdGlossiness *= material_shininess;\n#endif\n\n#ifdef MAPTEXTURE\n\t\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n#endif\n\n#ifdef MAPVERTEX\n\t\tdGlossiness *= saturate(vVertexColor.$VC);\n#endif\n\n\t\tdGlossiness = 1.0 - dGlossiness;\n\n\t\tdGlossiness += 0.0000001;\n}");
g.hasOwnProperty("normalTexture")&&(k=g.normalTexture,f.normalMap=d[k.index],e(k,f,["normal"]),k.hasOwnProperty("scale")&&(f.bumpiness=k.scale));g.hasOwnProperty("occlusionTexture")&&(k=g.occlusionTexture,f.aoMap=d[k.index],f.aoMapChannel="r",e(k,f,["ao"]));g.hasOwnProperty("emissiveFactor")?(k=g.emissiveFactor,f.emissive.set(Math.pow(k[0],1/2.2),Math.pow(k[1],1/2.2),Math.pow(k[2],1/2.2)),f.emissiveTint=!0):(f.emissive.set(0,0,0),f.emissiveTint=!1);g.hasOwnProperty("emissiveTexture")&&(k=g.emissiveTexture,
f.emissiveMap=d[k.index],e(k,f,["emissive"]));if(g.hasOwnProperty("alphaMode"))switch(g.alphaMode){case "MASK":f.blendType=3;g.hasOwnProperty("alphaCutoff")?f.alphaTest=g.alphaCutoff:f.alphaTest=.5;break;case "BLEND":f.blendType=2;break;default:case "OPAQUE":f.blendType=3}else f.blendType=3;g.hasOwnProperty("doubleSided")?(f.twoSidedLighting=g.doubleSided,f.cull=g.doubleSided?0:1):(f.twoSidedLighting=!1,f.cull=1);g.hasOwnProperty("extensions")&&g.extensions.hasOwnProperty("KHR_materials_clearcoat")&&
(k=g.extensions.KHR_materials_clearcoat,k.hasOwnProperty("clearcoatFactor")?f.clearCoat=.25*k.clearcoatFactor:f.clearCoat=0,k.hasOwnProperty("clearcoatTexture")&&(h=k.clearcoatTexture,f.clearCoatMap=d[h.index],f.clearCoatMapChannel="r",e(h,f,["clearCoat"])),k.hasOwnProperty("clearcoatRoughnessFactor")?f.clearCoatGlossiness=k.clearcoatRoughnessFactor:f.clearCoatGlossiness=0,k.hasOwnProperty("clearcoatRoughnessTexture")&&(h=k.clearcoatRoughnessTexture,f.clearCoatGlossMap=d[h.index],f.clearCoatGlossMapChannel=
"g",e(h,f,["clearCoatGloss"])),k.hasOwnProperty("clearcoatNormalTexture")&&(k=k.clearcoatNormalTexture,f.clearCoatNormalMap=d[k.index],e(k,f,["clearCoatNormal"]),k.hasOwnProperty("scale")&&(f.clearCoatBumpiness=k.scale)),f.chunks.clearCoatGlossPS="#ifdef MAPFLOAT\nuniform float material_clearCoatGlossiness;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatGlossMap;\n#endif\n\nvoid getClearCoatGlossiness() {\n\t\tccGlossiness = 1.0;\n\n#ifdef MAPFLOAT\n\t\tccGlossiness *= material_clearCoatGlossiness;\n#endif\n\n#ifdef MAPTEXTURE\n\t\tccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV).$CH;\n#endif\n\n#ifdef MAPVERTEX\n\t\tccGlossiness *= saturate(vVertexColor.$VC);\n#endif\n\n\t\tccGlossiness = 1.0 - ccGlossiness;\n\n\t\tccGlossiness += 0.0000001;\n}");
g.hasOwnProperty("extensions")&&g.extensions.hasOwnProperty("KHR_materials_unlit")&&(f.useLighting=!1,f.emissive.copy(f.diffuse),f.emissiveTint=f.diffuseTint,f.emissiveMap=f.diffuseMap,f.emissiveMapUv=f.diffuseMapUv,f.emissiveMapTiling.copy(f.diffuseMapTiling),f.emissiveMapOffset.copy(f.diffuseMapOffset),f.emissiveMapChannel=f.diffuseMapChannel,f.emissiveVertexColor=f.diffuseVertexColor,f.emissiveVertexColorChannel=f.diffuseVertexColorChannel,f.diffuse.set(0,0,0),f.diffuseTint=!1,f.diffuseMap=null,
f.diffuseVertexColor=!1);f.update();return f},Jo=function(g,d,b,a,c){var e=function(v){var w=xd(v,a);return new Gf(If(v.type),new w.constructor(w))},f={STEP:0,LINEAR:1,CUBICSPLINE:2},h={},k=[],m={},n=[],p=[],t;for(t=0;t<g.samplers.length;++t){var r=g.samplers[t];h.hasOwnProperty(r.input)||(h[r.input]=k.length,k.push(e(b[r.input])));m.hasOwnProperty(r.output)||(m[r.output]=n.length,n.push(e(b[r.output])));var u=r.hasOwnProperty("interpolation")&&f.hasOwnProperty(r.interpolation)?f[r.interpolation]:
1;p.push(new ph([],h[r.input],m[r.output],u))}b=[];e=new sh;f={translation:"localPosition",rotation:"localRotation",scale:"localScale",weights:"weights"};for(t=0;t<g.channels.length;++t)m=g.channels[t],h=m.target,m=p[m.sampler],m._paths.push(e.encode([[c[h.node].name],"graph",[f[h.path]]])),h.path.startsWith("rotation")&&2!==m.interpolation?b.push(m.output):h.path.startsWith("weights")&&(n[m.output]._components=n[m.output].data.length/k[m.input].data.length);b.sort();e=null;for(t=0;t<b.length;++t)if(c=
b[t],0===t||c!==e){e=n[c];if(4===e.components)for(e=e.data,f=e.length-4,h=0;h<f;h+=4)0>e[h+0]*e[h+4]+e[h+1]*e[h+5]+e[h+2]*e[h+6]+e[h+3]*e[h+7]&&(e[h+4]*=-1,e[h+5]*=-1,e[h+6]*=-1,e[h+7]*=-1);e=c}for(t=c=0;t<k.length;t++)e=k[t]._data,c=Math.max(c,0===e.length?0:e[e.length-1]);return new ke(g.hasOwnProperty("name")?g.name:"animation_"+d,c,k,n,p)},Ko=function(g,d){var b=new pa;g.hasOwnProperty("name")&&0<g.name.length?b.name=g.name:b.name="node_"+d;g.hasOwnProperty("matrix")&&(Kf.data.set(g.matrix),Kf.getTranslation(yd),
b.setLocalPosition(yd),Kf.getEulerAngles(yd),b.setLocalEulerAngles(yd),Kf.getScale(yd),b.setLocalScale(yd));g.hasOwnProperty("rotation")&&(d=g.rotation,b.setLocalRotation(d[0],d[1],d[2],d[3]));g.hasOwnProperty("translation")&&(d=g.translation,b.setLocalPosition(d[0],d[1],d[2]));g.hasOwnProperty("scale")&&(g=g.scale,b.setLocalScale(g[0],g[1],g[2]));return b},Lo=function(g,d,b,a){return d.hasOwnProperty("skins")&&0!==d.skins.length?d.skins.map(function(c){var e=d.accessors,f,h=c.joints,k=h.length,m=
[];if(c.hasOwnProperty("inverseBindMatrices")){var n=xd(e[c.inverseBindMatrices],a),p=[];for(e=0;e<k;e++){for(f=0;16>f;f++)p[f]=n[16*e+f];f=new M;f.set(p);m.push(f)}}else for(e=0;e<k;e++)f=new M,m.push(f);n=[];for(e=0;e<k;e++)n[e]=b[h[e]].name;c=c.skeleton;m=new Ff(g,m,n);m.skeleton=b[c];m.bones=[];for(e=0;e<h.length;e++)m.bones[e]=b[h[e]];return m}):[]},Mo=function(g,d,b,a,c){if(!d.hasOwnProperty("meshes")||0===d.meshes.length||!d.hasOwnProperty("accessors")||0===d.accessors.length||!d.hasOwnProperty("bufferViews")||
0===d.bufferViews.length)return[];var e={};return d.meshes.map(function(f){return Ho(g,f,d.accessors,b,a,c,e)})},No=function(g,d,b,a){if(!g.hasOwnProperty("materials")||0===g.materials.length)return[];var c=b&&b.material&&b.material.preprocess,e=b&&b.material&&b.material.process||Io,f=b&&b.material&&b.material.postprocess;return g.materials.map(function(h){c&&c(h);var k=e(h,d,a);f&&f(h,k);return k})},Oo=function(g,d,b,a){if(!g.hasOwnProperty("animations")||0===g.animations.length)return[];var c=a&&
a.animation&&a.animation.preprocess,e=a&&a.animation&&a.animation.postprocess;return g.animations.map(function(f,h){c&&c(f);h=Jo(f,h,g.accessors,b,d);e&&e(f,h);return h})},Po=function(g,d){if(!g.hasOwnProperty("nodes")||0===g.nodes.length)return[];var b=d&&d.node&&d.node.preprocess,a=d&&d.node&&d.node.process||Ko,c=d&&d.node&&d.node.postprocess;d=g.nodes.map(function(n,p){b&&b(n);p=a(n,p);c&&c(n,p);return p});for(var e=0;e<g.nodes.length;++e){var f=g.nodes[e];if(f.hasOwnProperty("children"))for(var h=
0;h<f.children.length;++h){var k=d[e],m=d[f.children[h]];m.parent||k.addChild(m)}}return d},Qo=function(g,d){var b=[],a=g.scenes.length;if(1===a&&1===g.scenes[0].nodes.length)b.push(d[g.scenes[0].nodes[0]]);else for(var c=0;c<a;c++){for(var e=g.scenes[c],f=new pa(e.name),h=0;h<e.nodes.length;h++)f.addChild(d[e.nodes[h]]);b.push(f)}return b},ok=function(g,d,b,a,c,e){var f=c&&c.global&&c.global.preprocess,h=c&&c.global&&c.global.postprocess;f&&f(d);var k=d.asset&&"PlayCanvas"===d.asset.generator;f=
Po(d,c);var m=Qo(d,f),n=Oo(d,f,b,c);c=No(d,a.map(function(p){return p.resource}),c,k);k=Mo(g,d,b,e,k);g=Lo(g,d,f,b);a={gltf:d,nodes:f,scenes:m,animations:n,textures:a,materials:c,meshes:k,skins:g};h&&h(d,a);e(null,a)},Ro=function(g,d){var b={magFilter:9729,minFilter:9987,wrapS:10497,wrapT:10497},a=function(e){switch(e){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return 1}},c=function(e){switch(e){case 33071:return 1;case 33648:return 2;
case 10497:return 0;default:return 0}};g&&(d=d||b,g.minFilter=a(d.minFilter),g.magFilter=a(d.magFilter),g.addressU=c(d.wrapS),g.addressV=c(d.wrapT))},So=function(g,d,b,a,c,e,f){var h=e&&e.image&&e.image.preprocess,k=e&&e.image&&e.image.processAsync||function(p,t){t(null,null)},m=e&&e.image&&e.image.postprocess,n=function(p,t,r,u){var v={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/vnd-ms.dds":"dds"},w={url:p};t&&(t=v[t])&&(w.filename="glb-texture-"+d+"."+t);
var y=new fa("texture_"+d,"texture",w,null,{crossOrigin:r});y.on("load",function(){u&&URL.revokeObjectURL(p);m&&m(g,y);f(null,y)});y.on("error",function(x,z){f(x)});c.add(y);c.load(y)};h&&h(g);k(g,function(p,t){p?f(p):t?(m&&m(g,t),f(null,t)):g.hasOwnProperty("uri")?/^data:.*,.*$/i.test(g.uri)?(t=p=g.uri,t=t.substring(t.indexOf(":")+1,t.indexOf(";")),n(p,t)):n(da.join(a,g.uri),null,"anonymous"):g.hasOwnProperty("bufferView")&&g.hasOwnProperty("mimeType")?(p=new Blob([b[g.bufferView]],{type:g.mimeType}),
n(URL.createObjectURL(p),g.mimeType,null,!0)):f("Invalid image found in gltf (neither uri or bufferView found). index="+d)})},To=function(g,d,b,a,c,e){if(g.hasOwnProperty("images")&&0!==g.images.length&&g.hasOwnProperty("textures")&&0!==g.textures.length)for(var f=c&&c.texture&&c.texture.preprocess,h=c&&c.texture&&c.texture.processAsync||function(v,w,y){y(null,null)},k=c&&c.texture&&c.texture.postprocess,m=[],n=[],p=g.textures.length,t=function(v,w){n[w]||(n[w]=[]);n[w].push(v);if(0===--p){var y=
[];n.forEach(function(x,z){x.forEach(function(B,C){if(0===C)var D=m[z];else{D=m[z];var G=new pc.Asset(D.name+"_clone",D.type,D.file,D.data,D.options);G.loaded=!0;for(var J=D.resource,E=new pc.Texture(J.device,J),H=[],P=0;P<J._levels.length;++P){var Y=[];if(J.cubemap)for(var L=0;6>L;++L)Y.push(J._levels[P][L]);else Y=J._levels[P];H.push(Y)}E._levels=H;G.resource=E;D.registry.add(G);D=G}Ro(D.resource,(g.samplers||[])[g.textures[B].sampler]);y[B]=D;k&&k(g.textures[C],D)})});e(null,y)}},r=0;r<g.textures.length;++r){var u=
g.textures[r];f&&f(u);h(u,g.images,function(v,w,y,x){if(y)e(y);else{if(void 0===x||null===x)x=w.source;m[x]?t(v,x):So(g.images[x],v,d,b,a,c,function(z,B){z?e(z):(m[x]=B,t(v,x))})}}.bind(null,r,u))}else e(null,[])},Uo=function(g,d,b,a,c){var e=[];if(g.buffers&&0!==g.buffers.length){var f=a&&a.buffer&&a.buffer.preprocess,h=a&&a.buffer&&a.buffer.processAsync||function(t,r){r(null,null)},k=a&&a.buffer&&a.buffer.postprocess,m=g.buffers.length,n=function(t,r){e[t]=r;k&&k(g.buffers[t],r);0===--m&&c(null,
e)};for(a=0;a<g.buffers.length;++a){var p=g.buffers[a];f&&f(p);h(p,function(t,r,u,v){if(u)c(u);else if(v)n(t,new Uint8Array(v));else if(r.hasOwnProperty("uri"))if(/^data:.*,.*$/i.test(r.uri)){r=atob(r.uri.split(",")[1]);u=new Uint8Array(r.length);for(v=0;v<r.length;v++)u[v]=r.charCodeAt(v);n(t,u)}else oa.get(da.join(b,r.uri),{cache:!0,responseType:"arraybuffer",retry:!1},function(w,y,x){y?c(y):n(w,new Uint8Array(x))}.bind(null,t));else n(t,d)}.bind(null,a,p))}}else c(null,e)},pk=function(g,d){var b=
JSON,a=b.parse;if("undefined"!==typeof TextDecoder)g=(new TextDecoder).decode(g);else{for(var c="",e=0;e<g.length;e++)c+=String.fromCharCode(g[e]);g=decodeURIComponent(escape(c))}b=a.call(b,g);b.asset&&b.asset.version&&2>parseFloat(b.asset.version)?d("Invalid gltf version. Expected version 2.0 or above but found version '"+b.asset.version+"'."):d(null,b)},qk=function(g,d,b){if(g&&g.toLowerCase().endsWith(".glb")){g=new DataView(d);var a=g.getUint32(0,!0),c=g.getUint32(4,!0),e=g.getUint32(8,!0);if(1179937895!==
a)b("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+a.toString(16));else if(2!==c)b("Invalid version number found in glb header. Expected 2, found "+c);else if(0>=e||e>d.byteLength)b("Invalid length found in glb header. Found "+e);else{a=[];for(c=12;c<e;){var f=g.getUint32(c,!0);if(c+f+8>d.byteLength)throw Error("Invalid chunk length found in glb. Found "+f);var h=g.getUint32(c+4,!0),k=new Uint8Array(d,c+8,f);a.push({length:f,type:h,data:k});c+=f+8}1!==a.length&&2!==a.length?
b("Invalid number of chunks found in glb file."):1313821514!==a[0].type?b("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+a[0].type.toString(16)):1<a.length&&5130562!==a[1].type?b("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+a[1].type.toString(16)):b(null,{gltfChunk:a[0].data,binaryChunk:2===a.length?a[1].data:null})}}else b(null,{gltfChunk:d,binaryChunk:null})},rk=function(g,d,b,a){var c=[],e=b&&b.bufferView&&b.bufferView.preprocess,f=b&&b.bufferView&&
b.bufferView.processAsync||function(p,t,r){r(null,null)},h=b&&b.bufferView&&b.bufferView.postprocess,k=g.bufferViews?g.bufferViews.length:0;if(k){var m=function(p,t){var r=g.bufferViews[p];r.hasOwnProperty("byteStride")&&(t.byteStride=r.byteStride);c[p]=t;h&&h(r,t);0===--k&&a(null,c)};for(b=0;b<g.bufferViews.length;++b){var n=g.bufferViews[b];e&&e(n);f(n,d,function(p,t,r,u){r?a(r):u?m(p,u):(r=d[t.buffer],t=new Uint8Array(r.buffer,r.byteOffset+(t.hasOwnProperty("byteOffset")?t.byteOffset:0),t.byteLength),
m(p,t))}.bind(null,b,n))}}else a(null,null)},me=function(){function g(){}g.parseAsync=function(d,b,a,c,e,f,h){qk(d,a,function(k,m){k?h(k):pk(m.gltfChunk,function(n,p){n?h(n):Uo(p,m.binaryChunk,b,f,function(t,r){t?h(t):rk(p,r,f,function(u,v){u?h(u):To(p,v,b,e,f,function(w,y){w?h(w):ok(c,p,v,y,f,h)})})})})})};g.parse=function(d,b,a,c){var e=null;c=c||{};qk(d,b,function(f,h){f?console.error(f):pk(h.gltfChunk,function(k,m){k?console.error(k):rk(m,[h.binaryChunk],c,function(n,p){n?console.error(n):ok(a,
m,p,[],c,function(t,r){t?console.error(t):e=r})})})});return e};g.createModel=function(d,b){var a=new fb,c,e=[];for(c=0;c<d.skins.length;c++){var f=new ic(d.skins[c]);f.bones=d.skins[c].bones;e.push(f)}if(1===d.scenes.length)a.graph=d.scenes[0];else for(a.graph=new pa("SceneGroup"),c=0;c<d.scenes.length;c++)a.graph.addChild(d.scenes[c]);for(c=0;c<d.nodes.length;c++)if(f=d.nodes[c],f.root===a.graph){var h=d.gltf.nodes[c];if(h.hasOwnProperty("mesh"))for(var k=d.meshes[h.mesh],m=0;m<k.length;m++){var n=
a,p=k[m],t=d.skins,r=e,u=h,v=new Ga(f,p,void 0===p.materialIndex?b:d.materials[p.materialIndex]);if(p.morph){var w=new ae(p.morph);if(p.weights)for(var y=0;y<p.weights.length;y++)w.setWeight(y,p.weights[y]);v.morphInstance=w;n.morphInstances.push(w)}u.hasOwnProperty("skin")&&(u=u.skin,p.skin=t[u],p=r[u],v.skinInstance=p,n.skinInstances.push(p));n.meshInstances.push(v)}}return a};return g}(),sk=function(){function g(){this.maxRetries=0}var d=g.prototype;d.load=function(b,a){"string"===typeof b&&(b=
{load:b,original:b});var c={retry:0<this.maxRetries,maxRetries:this.maxRetries};if(b.load.startsWith("blob:")||b.load.startsWith("data:"))".glb"===da.getExtension(b.original).toLowerCase()?c.responseType=Oa.ResponseType.ARRAY_BUFFER:c.responseType=Oa.ResponseType.JSON;oa.get(b.load,c,function(e,f){e?a("Error loading animation resource: "+b.original+" ["+e+"]"):a(null,f)})};d.open=function(b,a){return".glb"===da.getExtension(b).toLowerCase()?(b=me.parse("filename.glb",a,null))?b.animations:null:this["_parseAnimationV"+
a.animation.version](a)};d._parseAnimationV3=function(b){b=b.animation;var a=new $b;a.name=b.name;a.duration=b.duration;for(var c=0;c<b.nodes.length;c++){var e=new Ef,f=b.nodes[c];e._name=f.name;for(var h=0;h<f.keys.length;h++){var k=f.keys[h],m=k.time,n=k.pos,p=k.rot;k=k.scale;n=new A(n[0],n[1],n[2]);p=(new ea).setFromEulerAngles(p[0],p[1],p[2]);k=new A(k[0],k[1],k[2]);m=new Df(m,n,p,k);e._keys.push(m)}a.addNode(e)}return a};d._parseAnimationV4=function(b){b=b.animation;var a=new $b;a.name=b.name;
a.duration=b.duration;for(var c=0;c<b.nodes.length;c++){var e=new Ef,f=b.nodes[c];e._name=f.name;for(var h=f.defaults.p,k=f.defaults.r,m=f.defaults.s,n=0;n<f.keys.length;n++){var p=f.keys[n],t=p.t,r=h?h:p.p,u=k?k:p.r;p=m?m:p.s;r=new A(r[0],r[1],r[2]);u=(new ea).setFromEulerAngles(u[0],u[1],u[2]);p=new A(p[0],p[1],p[2]);t=new Df(t,r,u,p);e._keys.push(t)}a.addNode(e)}return a};return g}(),tk=function(){function g(){this.maxRetries=0}var d=g.prototype;d.load=function(b,a){"string"===typeof b&&(b={load:b,
original:b});var c={retry:0<this.maxRetries,maxRetries:this.maxRetries};b.load.startsWith("blob:")&&(c.responseType=Oa.ResponseType.JSON);oa.get(b.load,c,function(e,f){e?a("Error loading animation clip resource: "+b.original+" ["+e+"]"):a(null,f)})};d.open=function(b,a){b=a.name;var c=a.duration,e=a.inputs.map(function(h){return new Gf(1,h)}),f=a.outputs.map(function(h){return new Gf(h.components,h.data)});a=a.curves.map(function(h){return new ph([h.path],h.inputIndex,h.outputIndex,h.interpolation)});
return new ke(b,c,e,f,a)};return g}(),Lf=function(){function g(d){this._layers=[];this._parameters={};var b;if(Array.isArray(d.layers))this._layers=d.layers;else for(var a in d.layers){var c=d.layers[a],e={name:c.name,states:[],transitions:[]};for(b=0;b<c.states.length;b++)e.states.push(d.states[c.states[b]]);for(b=0;b<c.transitions.length;b++){var f=d.transitions[c.transitions[b]];if(f.conditions&&!Array.isArray(f.conditions)){for(var h=Object.keys(f.conditions),k=[],m=0;m<h.length;m++){var n=f.conditions[h[m]];
n.parameterName&&k.push(n)}f.conditions=k}Number.isInteger(f.from)&&(f.from=d.states[f.from].name);Number.isInteger(f.to)&&(f.to=d.states[f.to].name);e.transitions.push(f)}this._layers.push(e)}for(var p in d.parameters)b=d.parameters[p],this._parameters[b.name]={type:b.type,value:b.value}}N(g,[{key:"parameters",get:function(){return Object.assign({},this._parameters)}},{key:"layers",get:function(){return this._layers}}]);return g}(),uk=function(){function g(){this.maxRetries=0}var d=g.prototype;d.load=
function(b,a){"string"===typeof b&&(b={load:b,original:b});var c={retry:0<this.maxRetries,maxRetries:this.maxRetries};b.load.startsWith("blob:")&&(c.responseType=Oa.ResponseType.JSON);oa.get(b.load,c,function(e,f){e?a("Error loading animation state graph resource: "+b.original+" ["+e+"]"):a(null,f)})};d.open=function(b,a){return new Lf(a)};return g}(),uh=function(){function g(d){d instanceof Audio?this.audio=d:this.buffer=d}N(g,[{key:"duration",get:function(){var d=0;this.buffer?d=this.buffer.duration:
this.audio&&(d=this.audio.duration);return d||0}}]);return g}(),vh=function(){if("undefined"===typeof window)return!1;var g=window.navigator.userAgent,d=g.indexOf("MSIE ");return 0<d?parseInt(g.substring(d+5,g.indexOf(".",d)),10):0<g.indexOf("Trident/")?(d=g.indexOf("rv:"),parseInt(g.substring(d+3,g.indexOf(".",d)),10)):!1}(),Vo={".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav",".mp4a":"audio/mp4",".m4a":"audio/mp4",".mp4":"audio/mp4",".aac":"audio/aac"},vk=function(){function g(b){this.manager=
b;this.maxRetries=0}var d=g.prototype;d._isSupported=function(b){b=da.getExtension(b);return Vo[b]?!0:!1};d.load=function(b,a){"string"===typeof b&&(b={load:b,original:b});var c=function(f){a(null,new uh(f))},e=function(f){var h="Error loading audio url: "+b.original;f&&(h+=": "+(f.message||f));console.warn(h);a(h)};this._createSound?this._isSupported(b.original)?this._createSound(b.load,c,e):e("Audio format for "+b.original+" not supported"):e(null)};d.open=function(b,a){return a};d._createSound=
function(b,a,c){if(wb()){var e=this.manager;if(e.context){var f={retry:0<this.maxRetries,maxRetries:this.maxRetries};if(b.startsWith("blob:")||b.startsWith("data:"))f.responseType=Oa.ResponseType.ARRAY_BUFFER;oa.get(b,f,function(k,m){k?c(k):e.context.decodeAudioData(m,a,c)})}else c("Audio manager has no audio context")}else if(Pe()){var h=null;try{h=new Audio}catch(k){c("No support for Audio element");return}vh&&document.body.appendChild(h);h.onerror=function(){h.onerror=null;vh&&document.body.removeChild(h);
c()};h.addEventListener("canplaythrough",function m(){h.removeEventListener("canplaythrough",m);vh&&document.body.removeChild(h);a(h)});h.src=b}};return g}(),wk=function(){function g(){this.maxRetries=0}var d=g.prototype;d.load=function(b,a){"string"===typeof b&&(b={load:b,original:b});oa.get(b.load,{responseType:Oa.ResponseType.ARRAY_BUFFER,retry:0<this.maxRetries,maxRetries:this.maxRetries},function(c,e){c?a("Error loading binary resource: "+b.original+" ["+c+"]"):a(null,e)})};d.open=function(b,
a){return a};d.patch=function(b,a){};return g}(),xk=function(){function g(b){this._blobUrls={};for(var a=0,c=b.length;a<c;a++)b[a].url&&(this._blobUrls[b[a].name]=b[a].url)}var d=g.prototype;d.hasBlobUrl=function(b){return!!this._blobUrls[b]};d.getBlobUrl=function(b){return this._blobUrls[b]};d.destroy=function(){for(var b in this._blobUrls)URL.revokeObjectURL(this._blobUrls[b]);this._blobUrls=null};return g}(),Vi,wh=null,Wo=function(){function g(b){this._requestId=0;this._pendingRequests={};this._filenamePrefix=
b;b=Worker;if(!wh){var a=new Blob(["("+Ui.toString()+")(true)\n\n"],{type:"application/javascript"});wh=URL.createObjectURL(a)}this._worker=new b(wh);this._worker.addEventListener("message",this._onMessage.bind(this))}var d=g.prototype;d._onMessage=function(b){var a=b.data.id;if(this._pendingRequests[a]){var c=this._pendingRequests[a];delete this._pendingRequests[a];if(b.data.error)c(b.data.error);else{a=b.data.arrayBuffer;for(var e=0,f=b.data.files.length;e<f;e++){var h=b.data.files[e],k=new Blob([a.slice(h.start,
h.start+h.size)]);h.url=URL.createObjectURL(k)}c(null,b.data.files)}}};d.untar=function(b,a){var c=this._requestId++;this._pendingRequests[c]=a;this._worker.postMessage({id:c,prefix:this._filenamePrefix,arrayBuffer:b},[b])};d.hasPendingRequests=function(){for(var b in this._pendingRequests)return!0;return!1};d.destroy=function(){this._worker&&(this._worker.terminate(),this._pendingRequests=this._worker=null)};return g}();Ui();var yk=function(){function g(b){this._assets=b;this._worker=null;this.maxRetries=
0}var d=g.prototype;d.load=function(b,a){"string"===typeof b&&(b={load:b,original:b});var c=this;oa.get(b.load,{responseType:Oa.ResponseType.ARRAY_BUFFER,retry:0<this.maxRetries,maxRetries:this.maxRetries},function(e,f){if(e)a("Error loading bundle resource "+b.original+": "+e);else try{c._untar(f,a)}catch(h){a("Error loading bundle resource "+b.original+": "+h)}})};d._untar=function(b,a){var c=this;za.workers?(c._worker||(c._worker=new Wo(c._assets.prefix)),c._worker.untar(b,function(e,f){a(e,f);
c._worker.hasPendingRequests()||(c._worker.destroy(),c._worker=null)})):(b=(new Vi(b)).untar(c._assets.prefix),a(null,b))};d.open=function(b,a){return new xk(a)};d.patch=function(b,a){};return g}(),Ba=function(g){function d(a,c){var e=g.call(this,a)||this;a instanceof qa&&(c=a);e._batchHandle=null;e.c={};e._app=c;if(!c&&(e._app=qa.getApplication(),!e._app))throw Error("Couldn't find current application");e._guid=null;e._destroying=!1;e._template=!1;return e}K(d,g);var b=d.prototype;b.addComponent=
function(a,c){var e=this._app.systems[a];return!e||this.c[a]?null:e.addComponent(this,c)};b.removeComponent=function(a){var c=this._app.systems[a];c&&this.c[a]&&c.removeComponent(this)};b.findComponent=function(a){var c=this.findOne(function(e){return e.c&&e.c[a]});return c&&c.c[a]};b.findComponents=function(a){return this.find(function(c){return c.c&&c.c[a]}).map(function(c){return c.c[a]})};b.getGuid=function(){this._guid||this.setGuid(tj.create());return this._guid};b.setGuid=function(a){var c=
this._app._entityIndex;this._guid&&delete c[this._guid];this._guid=a;c[this._guid]=this};b._notifyHierarchyStateChanged=function(a,c){var e=!1;a===this&&0===this._app._enableList.length&&(e=!0);a._beingEnabled=!0;a._onHierarchyStateChanged(c);a._onHierarchyStatePostChanged&&this._app._enableList.push(a);var f,h=a._children;var k=0;for(f=h.length;k<f;k++)h[k]._enabled&&this._notifyHierarchyStateChanged(h[k],c);a._beingEnabled=!1;if(e){for(k=0;k<this._app._enableList.length;k++)this._app._enableList[k]._onHierarchyStatePostChanged();
this._app._enableList.length=0}};b._onHierarchyStateChanged=function(a){g.prototype._onHierarchyStateChanged.call(this,a);var c=this.c,e;for(e in c)if(c.hasOwnProperty(e)){var f=c[e];if(f.enabled)if(a)f.onEnable();else f.onDisable()}};b._onHierarchyStatePostChanged=function(){var a=this.c,c;for(c in a)if(a.hasOwnProperty(c))a[c].onPostStateChange()};b.findByGuid=function(a){return this._guid===a?this:(a=this._app._entityIndex[a])&&(a===this||a.isDescendantOf(this))?a:null};b.destroy=function(){this._destroying=
!0;for(a in this.c)this.c[a].enabled=!1;for(a in this.c)this.c[a].system.removeComponent(this);this._parent&&this._parent.removeChild(this);var a=this._children;for(var c=a.shift();c;)c instanceof d&&c.destroy(),c._parent=null,c=a.shift();this.fire("destroy",this);this.off();this._guid&&delete this._app._entityIndex[this._guid];this._destroying=!1};b.clone=function(){var a={},c=this._cloneRecursively(a);a[this.getGuid()]=c;Wi(this,this,c,a);return c};b._cloneRecursively=function(a){var c=new d(this._app);
g.prototype._cloneInternal.call(this,c);for(var e in this.c)this.c[e].system.cloneComponent(this,c);for(e=0;e<this._children.length;e++){var f=this._children[e];if(f instanceof d){var h=f._cloneRecursively(a);c.addChild(h);a[f.getGuid()]=h}}return c};return d}(pa),zk=function(){function g(b){this.data=b;this.model=null;this.renders=[];this.materials=[];this.textures=[];this.animations=[];this.registry=null}var d=g.prototype;d.instantiateModelEntity=function(b){var a=new pc.Entity;a.addComponent("model",
Object.assign({type:"asset",asset:this.model},b));return a};d.instantiateRenderEntity=function(b){for(var a=[],c=function w(r,u,v){if(v){var y=new Ba;v._cloneInternal(y);for(var x=null,z=0;z<u.meshInstances.length;z++){var B=u.meshInstances[z];if(B.node===v){var C=new Ga(y,B.mesh,B.material);B.morphInstance&&(C.morphInstance=B.morphInstance.clone());B.skinInstance&&r.push({src:B.skinInstance,dst:C});x||(x=[]);x.push(C)}}x&&(y.addComponent("render",Object.assign({type:"asset"},b)),y.render.meshInstances=
x);v=v.children;for(x=0;x<v.length;x++)z=w(r,u,v[x]),y.addChild(z);return y}return null}(a,this.model.resource,this.model.resource.graph),e=0;e<a.length;e++){for(var f=a[e].dst,h=a[e].src.skin,k=new ic(h),m=[],n=0;n<h.boneNames.length;n++){var p=c.findByName(h.boneNames[n]);m.push(p)}k.bones=m;f.skinInstance=k}return c};d.destroy=function(){var b=this.registry,a=function(e){b.remove(e);e.unload()},c=function(e){e.forEach(function(f){a(f)})};this.animations&&(c(this.animations),this.animations=null);
this.textures&&(c(this.textures),this.textures=null);this.materials&&(c(this.materials),this.materials=null);this.model&&(a(this.model),this.model=null);this.assets=this.data=null};return g}(),Ak=function(){function g(b,a){this._device=b;this._defaultMaterial=a;this.maxRetries=0}var d=g.prototype;d._getUrlWithoutParams=function(b){return 0<=b.indexOf("?")?b.split("?")[0]:b};d.load=function(b,a,c){"string"===typeof b&&(b={load:b,original:b});var e={responseType:Oa.ResponseType.ARRAY_BUFFER,retry:0<
this.maxRetries,maxRetries:this.maxRetries},f=this,h=function(k){me.parseAsync(f._getUrlWithoutParams(b.original),da.extractPath(b.load),k,f._device,c.registry,c.options,function(m,n){m?a(m):a(null,new zk(n))})};c&&c.file&&c.file.contents?h(c.file.contents):oa.get(b.load,e,function(k,m){a&&(k?a("Error loading model: "+b.original+" ["+k+"]"):h(m))})};d.open=function(b,a,c){return a};d.patch=function(b,a){var c=b.resource,e=c&&c.data;if(e){var f=function(t,r,u){t=new fa(b.name+"/"+t+"/"+u,t,{url:""});
t.resource=r;t.loaded=!0;a.add(t);return t},h,k=f("model",me.createModel(e,this._defaultMaterial),0),m=[];for(h=0;h<e.meshes.length;++h)m.push(f("render",e.meshes[h],h));var n=[];for(h=0;h<e.materials.length;++h)n.push(f("material",e.materials[h],h));var p=[];for(h=0;h<e.animations.length;++h)p.push(f("animation",e.animations[h],h));c.data=null;c.model=k;c.renders=m;c.materials=n;c.textures=e.textures;c.animations=p;c.registry=a}};return g}(),Bk=function(){function g(){this.maxRetries=0}var d=g.prototype;
d.load=function(b,a){"string"===typeof b&&(b={load:b,original:b});oa.get(b.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(c,e){c?a("Error loading css resource: "+b.original+" ["+c+"]"):a(null,e)})};d.open=function(b,a){return a};d.patch=function(b,a){};return g}(),Ck=function(){function g(b,a,c){this._device=b;this._registry=a;this._loader=c}var d=g.prototype;d.load=function(b,a,c){this.loadAssets(c,a)};d.open=function(b,a,c){return c?c.resource:null};d.patch=function(b,a){this.loadAssets(b,
function(c,e){c&&(a.fire("error",b),a.fire("error:"+b.id,c,b),b.fire("error",b))})};d.getAssetIds=function(b){var a=[];a[0]=b.file;if((b.loadFaces||!b.file)&&b.data&&b.data.textures)for(var c=0;6>c;++c)a[c+1]=b.data.textures[c];else a[1]=a[2]=a[3]=a[4]=a[5]=a[6]=null;return a};d.compareAssetIds=function(b,a){return b&&a?parseInt(b,10)===b||"string"===typeof b?b===a:b.url===a.url:null!==b===(null!==a)};d.update=function(b,a,c){var e=b.data||{},f=b._handlerState.assets,h=b._resources,k,m,n=[null,null,
null,null,null,null,null],p=function(){return e.hasOwnProperty("type")?e.type:e.hasOwnProperty("rgbm")?e.rgbm?"rgbm":"default":null};if(b.loaded&&c[0]===f[0])n[1]=h[1]||null,n[2]=h[2]||null,n[3]=h[3]||null,n[4]=h[4]||null,n[5]=h[5]||null,n[6]=h[6]||null;else if(c[0]){var t=c[0].resource;for(m=0;6>m;++m){var r=[t._levels[m]];if(0===m&&this._device.useTexCubeLod)for(k=1;k<t._levels.length;++k)r[k]=t._levels[k];r=new X(this._device,{name:b.name+"_prelitCubemap"+(t.width>>m),cubemap:!0,type:p()||t.type,
width:t.width>>m,height:t.height>>m,format:t.format,levels:r,fixCubemapSeams:!0,addressU:1,addressV:1});n[m+1]=r}}t=c.slice(1);if(b.loaded&&this.cmpArrays(t,f.slice(1)))n[0]=h[0]||null;else if(-1===t.indexOf(null)){t=t.map(function(u){return u.resource});m=[];for(k=0;k<t[0]._levels.length;++k)m.push(t.map(function(u){return u._levels[k]}));p=new X(this._device,{name:b.name+"_faces",cubemap:!0,type:p()||t[0].type,width:t[0].width,height:t[0].height,format:t[0].format,levels:m,minFilter:e.hasOwnProperty("minFilter")?
e.minFilter:t[0].minFilter,magFilter:e.hasOwnProperty("magFilter")?e.magFilter:t[0].magFilter,anisotropy:e.hasOwnProperty("anisotropy")?e.anisotropy:1,addressU:1,addressV:1,fixCubemapSeams:!!c[0]});n[0]=p}if(!this.cmpArrays(n,h))for(b.resources=n,b._handlerState.assetIds=a,b._handlerState.assets=c,m=0;m<h.length;++m)null!==h[m]&&-1===n.indexOf(h[m])&&h[m].destroy();for(m=0;m<f.length;++m)null!==f[m]&&-1===c.indexOf(f[m])&&f[m].unload()};d.cmpArrays=function(b,a){if(b.length!==a.length)return!1;for(var c=
0;c<b.length;++c)if(b[c]!==a[c])return!1;return!0};d.resolveId=function(b){var a=parseInt(b,10);return a===b||a.toString()===b?a:b};d.loadAssets=function(b,a){b.hasOwnProperty("_handlerState")||(b._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});for(var c=this,e=c.getAssetIds(b),f=[null,null,null,null,null,null,null],h=b._handlerState.assetIds,k=b._handlerState.assets,m=c._registry,n=7,p=function(x,z){f[x]=z;n--;0===n&&(c.update(b,e,f),a(null,
b.resources))},t=function(x,z){var B=z&&z.resource&&z.resource._levels[0];B&&"undefined"!==typeof ImageBitmap&&B instanceof ImageBitmap?createImageBitmap(B,{premultiplyAlpha:"none",imageOrientation:"flipY"}).then(function(C){z.resource._levels[0]=C;p(x,z)}).catch(function(C){a(C)}):p(x,z)},r=function(x,z,B){a(z)},u=function(x,z){z.loaded?t(x,z):(m.once("load:"+z.id,t.bind(c,x)),m.once("error:"+z.id,r.bind(c,x)),z.loading||m.load(z))},v,w=0;7>w;++w){var y=this.resolveId(e[w]);y?c.compareAssetIds(y,
h[w])?p(w,k[w]):parseInt(y,10)===y?(v=m.get(y))?u(w,v):setTimeout(function(x,z){var B=m.get(z);B?u(x,B):a("failed to find dependent cubemap asset="+z)}.bind(null,w,y)):(v=new fa(b.name+"_part_"+w,"texture","string"===typeof y?{url:y,filename:y}:y),m.add(v),m.once("load:"+v.id,t.bind(c,w)),m.once("error:"+v.id,r.bind(c,w)),m.load(v)):p(w,null)}};return g}(),Dk=function(){function g(){}var d=g.prototype;d.load=function(b,a){a(null,null)};d.open=function(b,a){return a};return g}(),xh=function(){function g(d,
b){this.type=b?b.type||"msdf":"msdf";this.em=1;this.textures=d;this.intensity=0;this._data=null;this.data=b}N(g,[{key:"data",get:function(){return this._data},set:function(d){if(this._data=d)if(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),!this._data.version||2>this._data.version)if(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)for(var b in this._data.chars)this._data.chars[b].map=0}}]);
return g}(),Ek=function(){function g(b){this._loader=b;this.maxRetries=0}var d=g.prototype;d.load=function(b,a,c){"string"===typeof b&&(b={load:b,original:b});var e=this;".json"===da.getExtension(b.original)?oa.get(b.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(f,h){if(f)a("Error loading font resource: "+b.original+" ["+f+"]");else{var k=vg(h);e._loadTextures(b.load.replace(".json",".png"),k,function(m,n){if(m)return a(m);a(null,{data:k,textures:n})})}}):(c&&c.data&&(c.data=
vg(c.data)),this._loadTextures(b.load,c&&c.data,a))};d._loadTextures=function(b,a,c){var e=a.info.maps.length,f=0,h=null,k=Array(e),m=this._loader;a=function(p){var t=function(r,u){if(!h){if(r)return h=r,c(r);u.upload();k[p]=u;f++;f===e&&c(null,k)}};0===p?m.load(b,"texture",t):m.load(b.replace(".png",p+".png"),"texture",t)};for(var n=0;n<e;n++)a(n)};d.open=function(b,a,c){return a.textures?new xh(a.textures,a.data):new xh(a,null)};d.patch=function(b,a){a=b.resource;!a.data&&b.data?a.data=b.data:!b.data&&
a.data&&(b.data=a.data);b.data&&(b.data=vg(b.data))};return g}(),Fk=function(g){function d(a,c){var e=g.call(this)||this;e._assets=[];e._registry=c;e._loaded=!1;e._count=0;e._total=0;e._failed=[];e._waitingAssets=[];if(a.length&&a[0]instanceof fa)e._assets=a;else for(var f=0;f<a.length;f++){var h=c.get(a[f]);h?e._assets.push(h):(e._waitForAsset(a[f]),e._total++)}return e}K(d,g);var b=d.prototype;b.destroy=function(){var a=this;this._registry.off("load",this._onLoad);this._registry.off("error",this._onError);
this._waitingAssets.forEach(function(c){a._registry.off("add:"+c,this._onAddAsset)});this.off("progress");this.off("load")};b.load=function(a,c){var e=this._assets.length;this._count=0;this._failed=[];this._callback=a;this._scope=c;this._registry.on("load",this._onLoad,this);this._registry.on("error",this._onError,this);for(a=0;a<e;a++)c=this._assets[a],c.loading||c.loaded||(this._registry.load(c),this._total++)};b.ready=function(a,c){c=c||this;if(this._loaded)a.call(c,this._assets);else this.once("load",
function(e){a.call(c,e)})};b._loadingComplete=function(){this._loaded=!0;this._registry.off("load",this._onLoad,this);this._registry.off("error",this._onError,this);this._failed&&this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",this._assets))};b._onLoad=function(a){var c=this;0<=this._assets.indexOf(a)&&(this._count++,this.fire("progress",
a));this._count===this._total&&setTimeout(function(){c._loadingComplete(c._failed)},0)};b._onError=function(a,c){var e=this;0<=this._assets.indexOf(c)&&(this._count++,this._failed.push(c));this._count===this._total&&setTimeout(function(){e._loadingComplete(e._failed)},0)};b._onAddAsset=function(a){var c=this._waitingAssets.indexOf(a);0<=c&&this._waitingAssets.splice(c,1);this._assets.push(a);var e=this._assets.length;for(c=0;c<e;c++)a=this._assets[c],a.loading||a.loaded||this._registry.load(a)};b._waitForAsset=
function(a){this._waitingAssets.push(a);this._registry.once("add:"+a,this._onAddAsset,this)};return d}(ba),ac={waitForTemplatesInScene:function(g,d,b){if(g.collapsedInstances){var a=ac._getAllCollapsedEntities(g);ac.waitForTemplateAssets(a,d,b,g)}else b(null,g)},waitForTemplateAssets:function(g,d,b,a){g=ac._extractTemplateIds(g);(new Fk(g,d)).load(function(c){b(c,a)})},_getAllCollapsedEntities:function(g){var d={};g.collapsedInstances.forEach(function(b){Object.assign(d,b.instanceEntities)});return d},
_extractTemplateIds:function(g){var d=[],b;for(b in g){var a=g[b].template_id;a&&d.push(a)}return d},expandTemplateEntities:function(g,d){var b={},a;for(a in d){var c=d[a];b[a]=c.collapsed_entity?ac.expandEntity(g,c):c}return b},expandEntity:function(g,d){}},yh={setCompressedPRS:function(g,d,b){var a=b.singleVecs,c=d.___1;if(!c){var e=b.tripleVecs;var f=d.___2}d=c?c[0]:e[f];g.setLocalPosition(a[d],a[d+1],a[d+2]);d=c?c[1]:e[f+1];g.setLocalEulerAngles(a[d],a[d+1],a[d+2]);d=c?c[2]:e[f+2];g.setLocalScale(a[d],
a[d+1],a[d+2])},oneCharToKey:function(g,d){g=g.charCodeAt(0)-d.fieldFirstCode;return d.fieldArray[g]},multCharToKey:function(g,d){for(var b=0,a=0;a<g.length;a++)b=b*d.fieldCodeBase+g.charCodeAt(a)-d.fieldFirstCode;return d.fieldArray[b]}},Xo=function(){function g(b,a){this._node=b;this._data=a}var d=g.prototype;d.run=function(){var b=Object.prototype.toString.call(this._node);"[object Object]"===b?this._handleMap():"[object Array]"===b?this._handleArray():this._result=this._node;return this._result};
d._handleMap=function(){this._result={};Object.keys(this._node).forEach(this._handleKey,this)};d._handleKey=function(b){var a=b,c=b.length;1===c?a=yh.oneCharToKey(b,this._data):2===c&&(a=yh.multCharToKey(b,this._data));this._result[a]=(new g(this._node[b],this._data)).run()};d._handleArray=function(){this._result=[];this._node.forEach(this._handleArElt,this)};d._handleArElt=function(b){b=(new g(b,this._data)).run();this._result.push(b)};return g}(),zh=function(){function g(b,a){this._app=b;this._isTemplate=
a}var d=g.prototype;d.parse=function(b){var a={},c,e,f=null;if(e=b.compressedFormat)b.entities=(new Xo(b.entities,e)).run();b.collapsedInstances&&this._addCollapsedToEntities(this._app,b);for(c in b.entities){var h=b.entities[c];var k=this._createEntity(h,e);a[c]=k;null===h.parent&&(f=k)}for(c in b.entities){k=a[c];h=b.entities[c].children;var m=h.length;for(e=0;e<m;e++){var n=a[h[e]];n&&k.addChild(n)}}this._openComponentData(f,b.entities);delete b.compressedFormat;return f};d._createEntity=function(b,
a){var c=new Ba;c.name=b.name;c.setGuid(b.resource_id);this._setPosRotScale(c,b,a);c._enabled=void 0!==b.enabled?b.enabled:!0;this._isTemplate?c._template=!0:c._enabledInHierarchy=c._enabled;c.template=b.template;if(b.tags)for(a=0;a<b.tags.length;a++)c.tags.add(b.tags[a]);b.labels&&b.labels.forEach(function(e){c.addLabel(e)});return c};d._setPosRotScale=function(b,a,c){if(c)yh.setCompressedPRS(b,a,c);else{c=a.position;var e=a.rotation;a=a.scale;b.setLocalPosition(c[0],c[1],c[2]);b.setLocalEulerAngles(e[0],
e[1],e[2]);b.setLocalScale(a[0],a[1],a[2])}};d._openComponentData=function(b,a){var c=this._app.systems.list,e,f=c.length,h=a[b.getGuid()];for(e=0;e<f;e++){var k=c[e],m=h.components[k.id];m&&k.addComponent(b,m)}f=h.children.length;c=b._children;for(e=0;e<f;e++)c[e]=this._openComponentData(c[e],a);return b};d._addCollapsedToEntities=function(b,a){a.collapsedInstances.forEach(function(c){c=ac.expandTemplateEntities(b,c.instanceEntities);Object.assign(a.entities,c)})};return g}(),Gk=function(){function g(b){this._app=
b;this.maxRetries=0}var d=g.prototype;d.load=function(b,a){"string"===typeof b&&(b={load:b,original:b});var c=this._app.assets;oa.get(b.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(e,f){e?(f="Error while loading scene "+b.original,e.message?(f+=": "+e.message,e.stack&&(f+="\n"+e.stack)):f+=": "+e,a(f)):ac.waitForTemplatesInScene(f,c,a)})};d.open=function(b,a){this._app.systems.script.preloading=!0;b=(new zh(this._app,!1)).parse(a);this._app.systems.script.preloading=!1;return b};
return g}(),Hk=function(){function g(){this.maxRetries=0}var d=g.prototype;d.load=function(b,a){"string"===typeof b&&(b={load:b,original:b});oa.get(b.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(c,e){c?a("Error loading html resource: "+b.original+" ["+c+"]"):a(null,e)})};d.open=function(b,a){return a};d.patch=function(b,a){};return g}(),Ik=function(){function g(){this.maxRetries=0}var d=g.prototype;d.load=function(b,a){"string"===typeof b&&(b={load:b,original:b});var c={retry:0<
this.maxRetries,maxRetries:this.maxRetries};b.load.startsWith("blob:")&&(c.responseType=Oa.ResponseType.JSON);oa.get(b.load,c,function(e,f){e?a("Error loading JSON resource: "+b.original+" ["+e+"]"):a(null,f)})};d.open=function(b,a){return a};d.patch=function(b,a){};return g}(),zd={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMap:"texture",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",
aoMapOffset:"vec2",diffuse:"rgb",diffuseTint:"boolean",diffuseVertexColor:"boolean",diffuseVertexColorChannel:"string",diffuseMap:"texture",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",diffuseDetailMap:"texture",diffuseDetailMapChannel:"string",diffuseDetailMapUv:"number",diffuseDetailMapTiling:"vec2",diffuseDetailMapOffset:"vec2",diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",specularVertexColor:"boolean",specularVertexColorChannel:"string",
specularMap:"texture",specularMapChannel:"string",specularMapUv:"number",specularMapTiling:"vec2",specularMapOffset:"vec2",specularAntialias:"boolean",occludeSpecular:"enum:occludeSpecular",useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMap:"texture",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",conserveEnergy:"boolean",
shininess:"number",glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMap:"texture",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",glossMapOffset:"vec2",clearCoat:"number",clearCoatVertexColor:"boolean",clearCoatVertexColorChannel:"string",clearCoatMap:"texture",clearCoatMapChannel:"string",clearCoatMapUv:"number",clearCoatMapTiling:"vec2",clearCoatMapOffset:"vec2",clearCoatGlossiness:"number",clearCoatGlossVertexColor:"boolean",clearCoatGlossVertexColorChannel:"string",
clearCoatGlossMap:"texture",clearCoatGlossMapChannel:"string",clearCoatGlossMapUv:"number",clearCoatGlossMapTiling:"vec2",clearCoatGlossMapOffset:"vec2",clearCoatBumpiness:"number",clearCoatNormalMap:"texture",clearCoatNormalMapUv:"number",clearCoatNormalMapTiling:"vec2",clearCoatNormalMapOffset:"vec2",fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMap:"texture",emissiveMapChannel:"string",emissiveMapUv:"number",
emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapUv:"number",bumpiness:"number",normalDetailMap:"texture",normalDetailMapTiling:"vec2",normalDetailMapOffset:"vec2",normalDetailMapUv:"number",normalDetailMapBumpiness:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",
alphaFade:"number",opacity:"number",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMap:"texture",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",opacityFadesSpecular:"boolean",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMap:"texture",lightMapChannel:"string",
lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",depthTest:"boolean",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",prefilteredCubeMap128:"texture",prefilteredCubeMap64:"texture",prefilteredCubeMap32:"texture",prefilteredCubeMap16:"texture",prefilteredCubeMap8:"texture",prefilteredCubeMap4:"texture"},Ad,Bd=
[];for(Ad in zd){var Ah=zd[Ad];"texture"===Ah&&Bd.push(Ad)}var Mf=[];for(Ad in zd)Ah=zd[Ad],"cubemap"===Ah&&Mf.push(Ad);var ne=function(){function g(b,a,c,e,f){this.propertyName=b;this.parent=a;this._scope=f;this._registry=c;this.asset=this.url=this.id=null;this._onAssetLoad=e.load;this._onAssetAdd=e.add;this._onAssetRemove=e.remove;this._onAssetUnload=e.unload}var d=g.prototype;d._bind=function(){if(this.id){if(this._onAssetLoad)this._registry.on("load:"+this.id,this._onLoad,this);if(this._onAssetAdd)this._registry.once("add:"+
this.id,this._onAdd,this);if(this._onAssetRemove)this._registry.on("remove:"+this.id,this._onRemove,this);if(this._onAssetUnload)this._registry.on("unload:"+this.id,this._onUnload,this)}if(this.url){if(this._onAssetLoad)this._registry.on("load:url:"+this.url,this._onLoad,this);if(this._onAssetAdd)this._registry.once("add:url:"+this.url,this._onAdd,this);if(this._onAssetRemove)this._registry.on("remove:url:"+this.url,this._onRemove,this)}};d._unbind=function(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+
this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.off("unload:"+this.id,this._onUnload,this));this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))};d._onLoad=
function(b){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,b)};d._onAdd=function(b){this.asset=b;this._onAssetAdd.call(this._scope,this.propertyName,this.parent,b)};d._onRemove=function(b){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,b);this.asset=null};d._onUnload=function(b){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,b)};N(g,[{key:"id",get:function(){return this._id},set:function(b){if(this.url)throw Error("Can't set id and url");this._unbind();
this._id=b;this.asset=this._registry.get(this._id);this._bind()}},{key:"url",get:function(){return this._url},set:function(b){if(this.id)throw Error("Can't set id and url");this._unbind();this._url=b;this.asset=this._registry.getByUrl(this._url);this._bind()}}]);return g}();Od.prototype.setInvalid=function(g,d){this.valid=!1;this.removeInvalid&&delete d[g]};Od.prototype.validate=function(g){var d,b="path"===g.mappingFormat,a;for(a in g)if(d=zd[a])if(d.startsWith("enum"))d=d.split(":")[1],this.enumValidators[d]&&
(this.enumValidators[d](g[a])||this.setInvalid(a,g));else if("number"===d)"number"!==typeof g[a]&&this.setInvalid(a,g);else if("boolean"===d)"boolean"!==typeof g[a]&&this.setInvalid(a,g);else if("string"===d)"string"!==typeof g[a]&&this.setInvalid(a,g);else if("vec2"===d)g[a]instanceof Array&&2===g[a].length||this.setInvalid(a,g);else if("rgb"===d)g[a]instanceof Array&&3===g[a].length||this.setInvalid(a,g);else if("texture"===d)b?"string"===typeof g[a]||g[null===a]||g[a]instanceof X||this.setInvalid(a,
g):"number"!==typeof g[a]&&null!==g[a]&&(g[a]instanceof X||this.setInvalid(a,g));else if("boundingbox"===d)g[a].center&&g[a].center instanceof Array&&3===g[a].center.length||this.setInvalid(a,g),g[a].halfExtents&&g[a].halfExtents instanceof Array&&3===g[a].halfExtents.length||this.setInvalid(a,g);else if("cubemap"===d)"number"!==typeof g[a]&&null!==g[a]&&void 0!==g[a]&&(g[a]instanceof X&&g[a].cubemap||this.setInvalid(a,g));else if("chunks"===d){var c=Object.keys(g[a]);for(d=0;d<c.length;d++)"string"!==
typeof g[a][c[d]]&&this.setInvalid(c[d],g[a])}else console.error("Unknown material type: "+d);else this.valid=!1;g.validated=!0;return this.valid};Od.prototype._createEnumValidator=function(g){return function(d){return 0<=g.indexOf(d)}};var Jk=function(){function g(){this._validator=null}var d=g.prototype;d.parse=function(b){b=this.migrate(b);b=this._validate(b);var a=new ma;this.initialize(a,b);return a};d.initialize=function(b,a){a.validated||(this._validator||(this._validator=new Od),this._validator.validate(a));
a.chunks&&b.chunks.copy(a.chunks);for(var c in a){var e=zd[c],f=a[c];"vec2"===e?b[c]=new S(f[0],f[1]):"rgb"===e?b[c]=new Q(f[0],f[1],f[2]):"texture"===e?f instanceof X?b[c]=f:b[c]instanceof X&&"number"===typeof f&&0<f||(b[c]=null):"cubemap"===e?f instanceof X?b[c]=f:b[c]instanceof X&&"number"===typeof f&&0<f||(b[c]=null):"boundingbox"===e?(e=new A(f.center[0],f.center[1],f.center[2]),f=new A(f.halfExtents[0],f.halfExtents[1],f.halfExtents[2]),b[c]=new la(e,f)):b[c]=a[c]}b.update()};d.migrate=function(b){void 0===
b.shadingModel&&(b.shadingModel="blinn"===b.shader?1:0);b.shader&&delete b.shader;b.mapping_format&&(b.mappingFormat=b.mapping_format,delete b.mapping_format);var a,c=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor",
"glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint","specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"]];for(a=0;a<c.length;a++){var e=c[a][0],f=c[a][1];void 0!==b[e]&&void 0===b[f]&&(b[f]=b[e],delete b[e])}c=["fresnelFactor","shadowSampleType"];for(a=0;a<c.length;a++)e=c[a],b.hasOwnProperty(e)&&delete b[e];return b};d._validate=function(b){this._validator||(this._validator=new Od);this._validator.validate(b);
return b};return g}(),Yo={aoMap:"white",diffuseMap:"gray",specularMap:"gray",metalnessMap:"black",glossMap:"gray",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"},Kk=function(){function g(b){this._assets=b.assets;this._device=b.graphicsDevice;this._placeholderTextures=null;this._parser=new Jk;this.maxRetries=0}var d=g.prototype;d.load=function(b,a){"string"===typeof b&&(b={load:b,original:b});oa.get(b.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},
function(c,e){c?a&&a("Error loading material: "+b.original+" ["+c+"]"):a&&(e._engine=!0,a(null,e))})};d.open=function(b,a){b=this._parser.parse(a);a._engine&&(b._data=a,delete a._engine);return b};d._createPlaceholders=function(){this._placeholderTextures={};var b={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]},a;for(a in b)if(b.hasOwnProperty(a)){this._placeholderTextures[a]=new X(this._device,{width:2,height:2,format:7});this._placeholderTextures[a].name=
"placeholder";for(var c=this._placeholderTextures[a].lock(),e=0;4>e;e++)for(var f=0;4>f;f++)c[4*e+f]=b[a][f];this._placeholderTextures[a].unlock()}};d.patch=function(b,a){b.resource._data&&(b._data=b.resource._data,delete b.resource._data);b.data.name=b.name;b.resource.name=b.name;this._bindAndAssignAssets(b,a);b.off("unload",this._onAssetUnload,this);b.on("unload",this._onAssetUnload,this)};d._onAssetUnload=function(b){delete b.data.parameters;delete b.data.chunks;delete b.data.name};d._assignTexture=
function(b,a,c){a.data[b]=c;a.resource[b]=c};d._assignPlaceholderTexture=function(b,a){this._placeholderTextures||this._createPlaceholders();a.resource[b]=this._placeholderTextures[Yo[b]]};d._onTextureLoad=function(b,a,c){this._assignTexture(b,a,c.resource);a.resource.update()};d._onTextureAdd=function(b,a,c){this._assets.load(c)};d._onTextureRemove=function(b,a,c){var e=a.resource;e&&e[b]===c.resource&&(this._assignTexture(b,a,null),e.update())};d._assignCubemap=function(b,a,c){a.data[b]=c[0];7===
c.length&&(a.data.prefilteredCubeMap128=c[1],a.data.prefilteredCubeMap64=c[2],a.data.prefilteredCubeMap32=c[3],a.data.prefilteredCubeMap16=c[4],a.data.prefilteredCubeMap8=c[5],a.data.prefilteredCubeMap4=c[6])};d._onCubemapLoad=function(b,a,c){this._assignCubemap(b,a,c.resources);this._parser.initialize(a.resource,a.data)};d._onCubemapAdd=function(b,a,c){0===a.data.shadingModel&&(a.loadFaces=!0);this._assets.load(c)};d._onCubemapRemove=function(b,a,c){var e=a.resource;e[b]===c.resource&&(this._assignCubemap(b,
a,[null,null,null,null,null,null,null]),e.update())};d._bindAndAssignAssets=function(b,a){var c=this._parser.migrate(b.data),e=b.resource,f="path"===c.mappingFormat,h;for(h=0;h<Bd.length;h++){var k=Bd[h];var m=e._assetReferences[k];!c[k]||c[k]instanceof X?m&&(f?m.url=null:m.id=null):(m||(m=new ne(k,b,a,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemove},this),e._assetReferences[k]=m),f?m.url=b.getAbsoluteUrl(c[k]):m.id=c[k],m.asset&&(m.asset.resource?this._assignTexture(k,
b,m.asset.resource):this._assignPlaceholderTexture(k,b),a.load(m.asset)))}for(h=0;h<Mf.length;h++)k=Mf[h],m=e._assetReferences[k],!c[k]||c[k]instanceof X||(m||(m=new ne(k,b,a,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemove},this),e._assetReferences[k]=m),f?m.url=c[k]:m.id=c[k],m.asset&&(m.asset.loaded&&this._assignCubemap(k,b,m.asset.resources),a.load(m.asset)));this._parser.initialize(e,c)};return g}(),Zo=function(){function g(d){this._device=d}g.prototype.parse=function(d){return(d=
me.parse("filename.glb",d,this._device))?me.createModel(d,Fa.defaultMaterial):null};return g}(),Gn=function(){this.index=0;this.boneIndices=[0,0,0,0]},Hn=function(){function g(){this.indexCount=this.indexStart=this.vertexCount=this.vertexStart=this.partition=0;this.boneIndices=[];this.vertices=[];this.indices=[];this.indexMap={}}var d=g.prototype;d.addVertex=function(b,a,c){if(void 0!==this.indexMap[a])c=this.indexMap[a],this.indices.push(c);else{for(var e=0;4>e;e++)0!==c.blendWeight.data[4*a+e]&&
(b.boneIndices[e]=this.getBoneRemap(c.blendIndices.data[4*b.index+e]));c=this.vertices.length;this.indices.push(c);this.vertices.push(b);this.indexMap[a]=c}};d.addPrimitive=function(b,a,c,e){var f,h,k=[],m=0,n=b.length;for(f=0;f<n;f++)for(var p=b[f].index,t=0;4>t;t++)if(0<c.blendWeight.data[4*p+t]){var r=c.blendIndices.data[4*p+t],u=!0;for(h=0;h<m;h++)if(k[h]==r){u=!1;break}u&&(k[m]=r,h=this.getBoneRemap(r),m+=-1===h?1:0)}if(this.boneIndices.length+m>e)return!1;for(f=0;f<m;f++)this.boneIndices.push(k[f]);
for(f=0;f<n;f++)this.addVertex(b[f],a[f],c);return!0};d.getBoneRemap=function(b){for(var a=0;a<this.boneIndices.length;a++)if(this.boneIndices[a]===b)return a;return-1};return g}(),$o={points:0,lines:1,lineloop:2,linestrip:3,triangles:4,trianglestrip:5,trianglefan:6},ap={int8:0,uint8:1,int16:2,uint16:3,int32:4,uint32:5,float32:6},bp=function(){function g(b){this._device=b}var d=g.prototype;d.parse=function(b){var a=b.model;if(!a||1>=a.version)return null;a=this._parseNodes(b);var c=this._parseSkins(b,
a),e=this._parseVertexBuffers(b),f=this._parseIndexBuffers(b,e),h=this._parseMorphs(b,a,e);e=this._parseMeshes(b,c.skins,h.morphs,e,f.buffer,f.data);b=this._parseMeshInstances(b,a,e,c.skins,c.instances,h.morphs,h.instances);e=new fb;e.graph=a[0];e.meshInstances=b;e.skinInstances=c.instances;e.morphInstances=h.instances;e.getGraph().syncHierarchy();return e};d._parseNodes=function(b){b=b.model;var a=[],c;for(c=0;c<b.nodes.length;c++){var e=b.nodes[c],f=new pa(e.name);f.setLocalPosition(e.position[0],
e.position[1],e.position[2]);f.setLocalEulerAngles(e.rotation[0],e.rotation[1],e.rotation[2]);f.setLocalScale(e.scale[0],e.scale[1],e.scale[2]);f.scaleCompensation=!!e.scaleCompensation;a.push(f)}for(c=1;c<b.parents.length;c++)a[b.parents[c]].addChild(a[c]);return a};d._parseSkins=function(b,a){b=b.model;var c=[],e=[],f;if(!this._device.supportsBoneTextures&&0<b.skins.length){var h=this._device.getBoneLimit();Xi(b,null,h)}for(h=0;h<b.skins.length;h++){var k=b.skins[h],m=[];for(f=0;f<k.inverseBindMatrices.length;f++){var n=
k.inverseBindMatrices[f];m[f]=(new M).set(n)}k=new Ff(this._device,m,k.boneNames);c.push(k);m=new ic(k);n=[];for(f=0;f<k.boneNames.length;f++){var p=a[0].findByName(k.boneNames[f]);n.push(p)}m.bones=n;e.push(m)}return{skins:c,instances:e}};d._getMorphVertexCount=function(b,a,c){for(var e=0;e<b.meshes.length;e++){var f=b.meshes[e];if(f.morph===a)return c[f.vertices].numVertices}};d._parseMorphs=function(b,a,c){b=b.model;a=[];var e=[],f,h;if(b.morphs){var k=function(w,y,x){x=new Float32Array(3*x);for(var z=
0;z<y.length;z++){var B=3*y[z];x[B]=w[3*z];x[B+1]=w[3*z+1];x[B+2]=w[3*z+2]}return x};for(f=0;f<b.morphs.length;f++){var m=b.morphs[f].targets;var n=[];var p=this._getMorphVertexCount(b,f,c);for(h=0;h<m.length;h++){var t=m[h].aabb;var r=t.min;t=t.max;r=new la(new A(.5*(t[0]+r[0]),.5*(t[1]+r[1]),.5*(t[2]+r[2])),new A(.5*(t[0]-r[0]),.5*(t[1]-r[1]),.5*(t[2]-r[2])));t=m[h].indices;var u=m[h].deltaPositions,v=m[h].deltaNormals;t&&(u=k(u,t,p),v=k(v,t,p));r=new oh({deltaPositions:u,deltaNormals:v,name:m[h].name,
aabb:r});n.push(r)}h=new ed(n,this._device);a.push(h);h=new ae(h);e.push(h)}}return{morphs:a,instances:e}};d._parseVertexBuffers=function(b){b=b.model;var a=[],c,e={position:"POSITION",normal:"NORMAL",tangent:"TANGENT",blendWeight:"BLENDWEIGHT",blendIndices:"BLENDINDICES",color:"COLOR",texCoord0:"TEXCOORD0",texCoord1:"TEXCOORD1",texCoord2:"TEXCOORD2",texCoord3:"TEXCOORD3",texCoord4:"TEXCOORD4",texCoord5:"TEXCOORD5",texCoord6:"TEXCOORD6",texCoord7:"TEXCOORD7"},f,h;for(f=0;f<b.vertices.length;f++){var k=
b.vertices[f],m=[];for(c in k){var n=k[c];m.push({semantic:e[c],components:n.components,type:ap[n.type],normalize:"COLOR"===e[c]})}n=new Ma(this._device,m);m=k.position.data.length/k.position.components;var p=new Ra(this._device,n,m),t=new vb(p);for(h=0;h<m;h++){for(c in k)switch(n=k[c],n.components){case 1:t.element[e[c]].set(n.data[h]);break;case 2:t.element[e[c]].set(n.data[2*h],n.data[2*h+1]);break;case 3:t.element[e[c]].set(n.data[3*h],n.data[3*h+1],n.data[3*h+2]);break;case 4:t.element[e[c]].set(n.data[4*
h],n.data[4*h+1],n.data[4*h+2],n.data[4*h+3])}t.next()}t.end();a.push(p)}return a};d._parseIndexBuffers=function(b,a){var c=b.model,e=b=null,f,h=0;for(f=0;f<c.meshes.length;f++){var k=c.meshes[f];void 0!==k.indices&&(h+=k.indices.length)}for(f=c=0;f<a.length;f++)c=Math.max(c,a[f].numVertices);0<h&&(65535<c&&this._device.extUintElement?(b=new Db(this._device,2,h),e=new Uint32Array(b.lock())):(b=new Db(this._device,1,h),e=new Uint16Array(b.lock())));return{buffer:b,data:e}};d._parseMeshes=function(b,
a,c,e,f,h){b=b.model;var k=[],m=0,n;for(n=0;n<b.meshes.length;n++){var p=b.meshes[n],t=p.aabb,r=t.min;t=t.max;r=new la(new A(.5*(t[0]+r[0]),.5*(t[1]+r[1]),.5*(t[2]+r[2])),new A(.5*(t[0]-r[0]),.5*(t[1]-r[1]),.5*(t[2]-r[2])));t=void 0!==p.indices;var u=new bb(this._device);u.vertexBuffer=e[p.vertices];u.indexBuffer[0]=t?f:null;u.primitive[0].type=$o[p.type];u.primitive[0].base=t?p.base+m:p.base;u.primitive[0].count=p.count;u.primitive[0].indexed=t;u.skin=void 0!==p.skin?a[p.skin]:null;u.morph=void 0!==
p.morph?c[p.morph]:null;u.aabb=r;t&&(h.set(p.indices,m),m+=p.indices.length);k.push(u)}null!==f&&f.unlock();return k};d._parseMeshInstances=function(b,a,c,e,f,h,k){b=b.model;var m=[],n;for(n=0;n<b.meshInstances.length;n++){var p=b.meshInstances[n],t=c[p.mesh];p=new Ga(a[p.node],t,Fa.defaultMaterial);if(t.skin){var r=e.indexOf(t.skin);p.skinInstance=f[r]}t.morph&&(t=h.indexOf(t.morph),p.morphInstance=k[t]);m.push(p)}return m};return g}(),Lk=function(){function g(b,a){this._device=b;this._parsers=[];
this._defaultMaterial=a;this.maxRetries=0;this.addParser(new bp(this._device),function(c,e){return".json"===da.getExtension(c)});this.addParser(new Zo(this._device),function(c,e){return".glb"===da.getExtension(c)})}var d=g.prototype;d.load=function(b,a){"string"===typeof b&&(b={load:b,original:b});var c={retry:0<this.maxRetries,maxRetries:this.maxRetries};if(b.load.startsWith("blob:")||b.load.startsWith("data:"))".glb"===da.getExtension(b.original).toLowerCase()?c.responseType=Oa.ResponseType.ARRAY_BUFFER:
c.responseType=Oa.ResponseType.JSON;oa.get(b.load,c,function(e,f){a&&(e?a("Error loading model: "+b.original+" ["+e+"]"):a(null,f))})};d.open=function(b,a){for(var c=0;c<this._parsers.length;c++){var e=this._parsers[c];if(e.decider(b,a))return e.parser.parse(a)}return null};d.patch=function(b,a){if(b.resource){var c=b.data,e=this;b.resource.meshInstances.forEach(function(f,h){if(c.mapping){var k=function r(t){t.resource?f.material=t.resource:(t.once("load",r),a.load(t));t.once("remove",function(u){f.material===
u.resource&&(f.material=e._defaultMaterial)})};if(c.mapping[h]){var m=c.mapping[h].material,n=c.mapping[h].path;if(void 0!==m)if(m)if(h=a.get(m))k(h);else a.once("add:"+m,k);else f.material=e._defaultMaterial;else if(n)if(m=b.getAbsoluteUrl(c.mapping[h].path),h=a.getByUrl(m))k(h);else a.once("add:url:"+m,k)}else f.material=e._defaultMaterial}})}};d.addParser=function(b,a){this._parsers.push({parser:b,decider:a})};return g}(),cp=function(g){function d(){var b=g.call(this)||this;b._meshes=null;return b}
K(d,g);N(d,[{key:"meshes",get:function(){return this._meshes},set:function(b){this._meshes=b;this.fire("set:meshes",b)}}]);return d}(ba),Mk=function(){function g(b){this._registry=b}var d=g.prototype;d.load=function(b,a,c){};d.open=function(b,a){return new cp};d.patch=function(b,a){if(b.data.containerAsset){var c=a.get(b.data.containerAsset);if(c)Yi.call(b,c);else a.once("add:"+b.data.containerAsset,Yi,b)}};return g}(),Nk=function(){function g(b){this._handlers={};this._requests={};this._cache={};
this._app=b}var d=g.prototype;d.addHandler=function(b,a){this._handlers[b]=a;a._loader=this};d.removeHandler=function(b){delete this._handlers[b]};d.getHandler=function(b){return this._handlers[b]};d.load=function(b,a,c,e){var f=this._handlers[a];if(f)if(b){var h=b+a;if(void 0!==this._cache[h])c(null,this._cache[h]);else if(this._requests[h])this._requests[h].push(c);else{this._requests[h]=[c];var k=this,m=function(p,t){p?k._onFailure(h,p):f.load(t,function(r,u,v){if(k._requests[h])if(r)k._onFailure(h,
r);else try{k._onSuccess(h,f.open(t.original,u,e),v)}catch(w){k._onFailure(h,w)}},e)},n=b.split("?")[0];this._app.enableBundles&&this._app.bundles.hasUrl(n)?this._app.bundles.canLoadUrl(n)?this._app.bundles.loadUrl(n,function(p,t){m(p,{load:t,original:n})}):m("Bundle for "+b+" not loaded yet"):m(null,{load:b,original:e&&e.getPreferredFile().filename||b})}}else this._loadNull(f,c,e);else c("No handler for asset type: "+a)};d._loadNull=function(b,a,c){b.load(null,function(e,f,h){if(e)a(e);else try{a(null,
b.open(null,f,c),h)}catch(k){a(k)}},c)};d._onSuccess=function(b,a,c){this._cache[b]=a;for(var e=0;e<this._requests[b].length;e++)this._requests[b][e](null,a,c);delete this._requests[b]};d._onFailure=function(b,a){console.error(a);if(this._requests[b]){for(var c=0;c<this._requests[b].length;c++)this._requests[b][c](a);delete this._requests[b]}};d.open=function(b,a){var c=this._handlers[b];return c?c.open(null,a):(console.warn("No resource handler found for: "+b),a)};d.patch=function(b,a){var c=this._handlers[b.type];
c?c.patch&&c.patch(b,a):console.warn("No resource handler found for: "+b.type)};d.clearCache=function(b,a){delete this._cache[b+a]};d.getFromCache=function(b,a){if(this._cache[b+a])return this._cache[b+a]};d.enableRetry=function(b){void 0===b&&(b=5);b=Math.max(0,b)||0;for(var a in this._handlers)this._handlers[a].maxRetries=b};d.disableRetry=function(){for(var b in this._handlers)this._handlers[b].maxRetries=0};d.destroy=function(){this._handlers={};this._requests={};this._cache={}};return g}(),Ok=
function(){function g(b){this._app=b;this.maxRetries=0}var d=g.prototype;d.load=function(b,a){"string"===typeof b&&(b={load:b,original:b});var c=this._app.assets;oa.get(b.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(e,f){e?(f="Error while loading scene "+b.original,e.message?(f+=": "+e.message,e.stack&&(f+="\n"+e.stack)):f+=": "+e,a(f)):ac.waitForTemplatesInScene(f,c,a)})};d.open=function(b,a){this._app.systems.script.preloading=!0;b=(new zh(this._app,!1)).parse(a);var c=this._app.scene;
c.root=b;this._app.applySceneSettings(a.settings);this._app.systems.script.preloading=!1;return c};d.patch=function(b,a){};return g}(),Pk=function(){function g(b){this._app=b;this.maxRetries=0}var d=g.prototype;d.load=function(b,a){"string"===typeof b&&(b={load:b,original:b});oa.get(b.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(c,e){c?(e="Error while loading scene settings "+b.original,c.message?(e+=": "+c.message,c.stack&&(e+="\n"+c.stack)):e+=": "+c,a(e)):a(null,e)})};d.open=
function(b,a){return a.settings};return g}(),Bh=!1,Qk=!1,Va={app:null,create:function(g,d){if(Bh){var b=d(Va.app);b._pcScriptName=g;Td._push(b);this.fire("created",g,d)}},attribute:function(g,d,b,a){},createLoadingScreen:function(g){if(!Qk){Qk=!0;var d=qa.getApplication();g(d)}}};Object.defineProperty(Va,"legacy",{get:function(){return Bh},set:function(g){Bh=g}});Ud.attach(Va);var Td=function(){function g(b){this._app=b;this._scripts={};this._cache={}}g._push=function(b){Va.legacy&&0<g._types.length?
console.assert("Script Ordering Error. Contact support@playcanvas.com"):g._types.push(b)};var d=g.prototype;d.load=function(b,a){"string"===typeof b&&(b={load:b,original:b});var c=this;Va.app=this._app;this._loadScript(b.load,function(e,f,h){if(e)a(e);else if(Va.legacy)e=null,g._types.length&&(e=g._types.pop()),e?this._scripts[f]=e:e=null,a(null,e,h);else{e={};for(var k=0;k<g._types.length;k++)e[g._types[k].name]=g._types[k];g._types.length=0;a(null,e,h);delete c._loader._cache[f+"script"]}}.bind(this))};
d.open=function(b,a){return a};d.patch=function(b,a){};d._loadScript=function(b,a){var c=document.head,e=document.createElement("script");this._cache[b]=e;e.async=!1;e.addEventListener("error",function(h){a("Script: "+h.target.src+" failed to load")},!1);var f=!1;e.onload=e.onreadystatechange=function(){f||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(f=!0,a(null,b,e))};e.src=b;c.appendChild(e)};return g}();Td._types=[];var Rk=function(){function g(){this.maxRetries=0}
var d=g.prototype;d.load=function(b,a){"string"===typeof b&&(b={load:b,original:b});oa.get(b.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(c,e){c?a("Error loading shader resource: "+b.original+" ["+c+"]"):a(null,e)})};d.open=function(b,a){return a};d.patch=function(b,a){};return g}(),dp=[0,0,1,0,0,1,0,0,1,0,0,1],ep=[0,1,3,2,3,1],Sk=function(g){function d(a,c){var e=g.call(this)||this;e._device=a;e._pixelsPerUnit=c&&void 0!==c.pixelsPerUnit?c.pixelsPerUnit:1;e._renderMode=c&&void 0!==
c.renderMode?c.renderMode:0;e._atlas=c&&void 0!==c.atlas?c.atlas:null;e._frameKeys=c&&void 0!==c.frameKeys?c.frameKeys:null;e._meshes=[];e._updatingProperties=!1;e._meshesDirty=!1;e._atlas&&e._frameKeys&&e._createMeshes();return e}K(d,g);var b=d.prototype;b._createMeshes=function(){var a;var c=0;for(a=this._meshes.length;c<a;c++){var e=this._meshes[c];e&&e.destroy()}a=this._frameKeys.length;this._meshes=Array(a);e=1===this.renderMode||2===this._renderMode?this._create9SliceMesh:this._createSimpleMesh;
for(c=0;c<a;c++){var f=this._atlas.frames[this._frameKeys[c]];this._meshes[c]=f?e.call(this,f):null}this.fire("set:meshes")};b._createSimpleMesh=function(a){var c=a.rect,e=this._atlas.texture.width,f=this._atlas.texture.height,h=c.z/this._pixelsPerUnit,k=c.w/this._pixelsPerUnit,m=a.pivot.x;a=a.pivot.y;var n=c.x/e,p=c.y/f;e=(c.x+c.z)/e;c=(c.y+c.w)/f;return kb(this._device,[-m*h,-a*k,0,(1-m)*h,-a*k,0,(1-m)*h,(1-a)*k,0,-m*h,(1-a)*k,0],{uvs:[n,p,e,p,e,c,n,c],normals:dp,indices:ep})};b._create9SliceMesh=
function(){var a=S.ONE,c,e,f=[],h=[],k=[],m=[],n=0;for(c=0;3>=c;c++){var p=0===c||3===c?0:1;for(e=0;3>=e;e++){var t=-a.x+2*a.x*(1>=c?0:3)/3;var r=-(-a.y+2*a.y*(1>=e?0:3)/3);var u=0===e||3===e?0:1;f.push(-t,0,r);h.push(0,1,0);k.push(p,u);3>c&&3>e&&(m.push(n+3+1,n+1,n),m.push(n+3+1,n+3+2,n+1));n++}}return kb(this._device,f,{normals:h,uvs:k,indices:m})};b._onSetFrames=function(a){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()};b._onFrameChanged=function(a,c){a=this._frameKeys.indexOf(a);
0>a||(c?0===this.renderMode&&(this._meshes[a]=this._createSimpleMesh(c)):this._meshes[a]=null,this.fire("set:meshes"))};b._onFrameRemoved=function(a){a=this._frameKeys.indexOf(a);0>a||(this._meshes[a]=null,this.fire("set:meshes"))};b.startUpdate=function(){this._updatingProperties=!0;this._meshesDirty=!1};b.endUpdate=function(){this._updatingProperties=!1;this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes();this._meshesDirty=!1};b.destroy=function(){for(var a=kn(this._meshes),c;!(c=
a()).done;)(c=c.value)&&c.destroy();this._meshes.length=0};N(d,[{key:"frameKeys",get:function(){return this._frameKeys},set:function(a){this._frameKeys=a;this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes());this.fire("set:frameKeys",a)}},{key:"atlas",get:function(){return this._atlas},set:function(a){a!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",
this._onFrameRemoved,this)),(this._atlas=a)&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",a))}},{key:"pixelsPerUnit",get:function(){return this._pixelsPerUnit},set:function(a){this._pixelsPerUnit!==a&&(this._pixelsPerUnit=a,this.fire("set:pixelsPerUnit",a),this._atlas&&this._frameKeys&&
0===this.renderMode&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}},{key:"renderMode",get:function(){return this._renderMode},set:function(a){if(this._renderMode!==a){var c=this._renderMode;this._renderMode=a;this.fire("set:renderMode",a);(0===c||0===a)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}}},{key:"meshes",get:function(){return this._meshes}}]);return d}(ba),Tk=function(){function g(b,a){this._assets=b;this._device=
a;this.maxRetries=0}var d=g.prototype;d.load=function(b,a){"string"===typeof b&&(b={load:b,original:b});".json"===da.getExtension(b.original)&&oa.get(b.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(c,e){c?a(c):a(null,e)})};d.open=function(b,a){var c=new Sk(this._device);b&&(c.__data=a);return c};d.patch=function(b,a){var c=b.resource;c.__data&&(b.data.pixelsPerUnit=c.__data.pixelsPerUnit,b.data.renderMode=c.__data.renderMode,b.data.frameKeys=c.__data.frameKeys,c.__data.textureAtlasAsset&&
((a=a.getByUrl(c.__data.textureAtlasAsset))?b.data.textureAtlasAsset=a.id:console.warn("Could not find textureatlas with url: "+c.__data.textureAtlasAsset)));c.startUpdate();c.renderMode=b.data.renderMode;c.pixelsPerUnit=b.data.pixelsPerUnit;c.frameKeys=b.data.frameKeys;this._updateAtlas(b);c.endUpdate();b.off("change",this._onAssetChange,this);b.on("change",this._onAssetChange,this)};d._updateAtlas=function(b){var a=b.resource;if(b.data.textureAtlasAsset){this._assets.off("load:"+b.data.textureAtlasAsset,
wg,b);this._assets.on("load:"+b.data.textureAtlasAsset,wg,b);var c=this._assets.get(b.data.textureAtlasAsset);c&&c.resource?a.atlas=c.resource:c?this._assets.load(c):(this._assets.off("add:"+b.data.textureAtlasAsset,xg,b),this._assets.on("add:"+b.data.textureAtlasAsset,xg,b))}else a.atlas=null};d._onAssetChange=function(b,a,c,e){"data"===a&&c&&c.textureAtlasAsset&&e&&c.textureAtlasAsset!==e.textureAtlasAsset&&(this._assets.off("load:"+e.textureAtlasAsset,wg,b),this._assets.off("add:"+e.textureAtlasAsset,
xg,b))};return g}(),Uk=function(){function g(b,a){this._app=b;this._data=a;this._templateRoot=null}var d=g.prototype;d.instantiate=function(){this._templateRoot||this._parseTemplate();return this._templateRoot.clone()};d._parseTemplate=function(){this._templateRoot=(new zh(this._app,!0)).parse(this._data)};return g}(),Vk=function(){function g(b){this._app=b}var d=g.prototype;d.load=function(b,a){"string"===typeof b&&(b={load:b,original:b});var c=this._app.assets;oa.get(b.load,function(e,f){e?a("Error requesting template: "+
b.original):ac.waitForTemplateAssets(f.entities,c,a,f)})};d.open=function(b,a){return new Uk(this._app,a)};return g}(),Wk=function(){function g(){this.maxRetries=0}var d=g.prototype;d.load=function(b,a){"string"===typeof b&&(b={load:b,original:b});oa.get(b.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(c,e){c?a("Error loading text resource: "+b.original+" ["+c+"]"):a(null,e)})};d.open=function(b,a){return a};d.patch=function(b,a){};return g}(),Xk=function(g){function d(){var a=
g.call(this)||this;a._texture=null;a._frames=null;return a}K(d,g);var b=d.prototype;b.setFrame=function(a,c){var e=this._frames[a];e?(e.rect.copy(c.rect),e.pivot.copy(c.pivot),e.border.copy(c.border)):(e={rect:c.rect.clone(),pivot:c.pivot.clone(),border:c.border.clone()},this._frames[a]=e);this.fire("set:frame",a.toString(),e)};b.removeFrame=function(a){var c=this._frames[a];c&&(delete this._frames[a],this.fire("remove:frame",a.toString(),c))};b.destroy=function(){this._texture&&this._texture.destroy()};
N(d,[{key:"texture",get:function(){return this._texture},set:function(a){this._texture=a;this.fire("set:texture",a)}},{key:"frames",get:function(){return this._frames},set:function(a){this._frames=a;this.fire("set:frames",a)}}]);return d}(ba),Nf={repeat:0,clamp:1,mirror:2},Of={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},fp=/^data\.frames\.(\d+)$/,Yk=function(){function g(b){this._loader=b;this.maxRetries=0}var d=g.prototype;d.load=function(b,
a){"string"===typeof b&&(b={load:b,original:b});var c=this,e=this._loader.getHandler("texture");if(".json"===da.getExtension(b.original))oa.get(b.load,{retry:0<this.maxRetries,maxRetries:this.maxRetries},function(f,h){f?a(f):(f=b.original.replace(".json",".png"),c._loader.load(f,"texture",function(k,m){k?a(k):a(null,{data:h,texture:m})}))});else return e.load(b,a)};d.open=function(b,a){var c=new Xk;if(a.texture&&a.data)c.texture=a.texture,c.__data=a.data;else{b=this._loader.getHandler("texture").open(b,
a);if(!b)return null;c.texture=b}return c};d.patch=function(b,a){b.resource.__data&&(void 0!==b.resource.__data.minfilter&&(b.data.minfilter=b.resource.__data.minfilter),void 0!==b.resource.__data.magfilter&&(b.data.magfilter=b.resource.__data.magfilter),void 0!==b.resource.__data.addressu&&(b.data.addressu=b.resource.__data.addressu),void 0!==b.resource.__data.addressv&&(b.data.addressv=b.resource.__data.addressv),void 0!==b.resource.__data.mipmaps&&(b.data.mipmaps=b.resource.__data.mipmaps),void 0!==
b.resource.__data.anisotropy&&(b.data.anisotropy=b.resource.__data.anisotropy),void 0!==b.resource.__data.rgbm&&(b.data.rgbm=!!b.resource.__data.rgbm),b.data.frames=b.resource.__data.frames,delete b.resource.__data);if(a=b.resource.texture)if(a.name=b.name,b.data.hasOwnProperty("minfilter")&&a.minFilter!==Of[b.data.minfilter]&&(a.minFilter=Of[b.data.minfilter]),b.data.hasOwnProperty("magfilter")&&a.magFilter!==Of[b.data.magfilter]&&(a.magFilter=Of[b.data.magfilter]),b.data.hasOwnProperty("addressu")&&
a.addressU!==Nf[b.data.addressu]&&(a.addressU=Nf[b.data.addressu]),b.data.hasOwnProperty("addressv")&&a.addressV!==Nf[b.data.addressv]&&(a.addressV=Nf[b.data.addressv]),b.data.hasOwnProperty("mipmaps")&&a.mipmaps!==b.data.mipmaps&&(a.mipmaps=b.data.mipmaps),b.data.hasOwnProperty("anisotropy")&&a.anisotropy!==b.data.anisotropy&&(a.anisotropy=b.data.anisotropy),b.data.hasOwnProperty("rgbm")){var c=b.data.rgbm?"rgbm":"default";a.type!==c&&(a.type=c)}b.resource.texture=a;a={};for(var e in b.data.frames)c=
b.data.frames[e],a[e]={rect:new Z(c.rect),pivot:new S(c.pivot),border:new Z(c.border)};b.resource.frames=a;b.off("change",this._onAssetChange,this);b.on("change",this._onAssetChange,this)};d._onAssetChange=function(b,a,c){if("data"===a||"data.frames"===a){var e={};for(f in c.frames)a=c.frames[f],e[f]={rect:new Z(a.rect),pivot:new S(a.pivot),border:new Z(a.border)};b.resource.frames=e}else if(a=a.match(fp)){var f=a[1];c?(b.resource.frames[f]?(a=b.resource.frames[f],a.rect.set(c.rect[0],c.rect[1],c.rect[2],
c.rect[3]),a.pivot.set(c.pivot[0],c.pivot[1]),a.border.set(c.border[0],c.border[1],c.border[2],c.border[3])):b.resource.frames[f]={rect:new Z(c.rect),pivot:new S(c.pivot),border:new Z(c.border)},b.resource.fire("set:frame",f,b.resource.frames[f])):b.resource.frames[f]&&(delete b.resource.frames[f],b.resource.fire("remove:frame",f))}};return g}(),Kn=function(){try{if("object"===typeof WebAssembly&&"function"===typeof WebAssembly.instantiate){var g=new WebAssembly.Module(Uint8Array.of(0,97,115,109,
1,0,0,0));if(g instanceof WebAssembly.Module)return new WebAssembly.Instance(g)instanceof WebAssembly.Instance}}catch(d){}return!1}(),Dg=!1,Qd=null,Pd={},zg=null,Bg=[],Rd=null,Zk=function(){function g(b){this.maxRetries=0}var d=g.prototype;d.load=function(b,a,c){oa.get(b.load,{cache:!0,responseType:"arraybuffer",retry:0<this.maxRetries,maxRetries:this.maxRetries},function(e,f){if(e)a(e,f);else{if(e="pvr"===yg()&&c&&c.file&&c.file.variants&&c.file.variants.basis&&0!==(c.file.variants.basis.opt&8))c.file.variants.basis.opt&=
-9;bj(b.load,f,a,{unswizzleGGGR:e})}})};d.open=function(b,a,c){b=new X(c,{name:b,addressU:a.cubemap?1:0,addressV:a.cubemap?1:0,width:a.width,height:a.height,format:a.format,cubemap:a.cubemap,levels:a.levels});b.upload();return b};return g}(),$k=function(){function g(b){this.crossOrigin=b.prefix?"anonymous":null;this.maxRetries=0;this.useImageBitmap=!1}var d=g.prototype;d.load=function(b,a,c){if(c&&c.options&&c.options.hasOwnProperty("crossOrigin"))var e=c.options.crossOrigin;else wd.test(b.load)&&
(e=this.crossOrigin);this.useImageBitmap?this._loadImageBitmap(b.load,b.original,e,a):this._loadImage(b.load,b.original,e,a)};d.open=function(b,a,c){var e=da.getExtension(b).toLowerCase();b=new X(c,{name:b,width:a.width,height:a.height,format:".jpg"===e||".jpeg"===e?6:7});b.setSource(a);return b};d._loadImage=function(b,a,c,e){var f=new Image;c&&(f.crossOrigin=c);var h=0,k=this.maxRetries,m;f.onload=function(){e(null,f)};f.onerror=function(){if(!m)if(0<k&&++h<=k){var n=100*Math.pow(2,h);console.log("Error loading Texture from: '"+
a+"' - Retrying in "+n+"ms...");var p=0<=b.indexOf("?")?"&":"?";m=setTimeout(function(){f.src=b+p+"retry="+Date.now();m=null},n)}else e("Error loading Texture from: '"+a+"'")};f.src=b};d._loadImageBitmap=function(b,a,c,e){oa.get(b,{cache:!0,responseType:"blob",retry:0<this.maxRetries,maxRetries:this.maxRetries},function(f,h){f?e(f):createImageBitmap(h,{premultiplyAlpha:"none",imageOrientation:"flipY"}).then(function(k){e(null,k)}).catch(function(k){e(k)})})};return g}(),Ch=[1481919403,3140563232,
169478669],al={33776:8,33778:9,33779:10,36196:21,37492:22,37496:23,35840:26,35841:24,35842:27,35843:25},bl=function(){function g(b){this.maxRetries=0}var d=g.prototype;d.load=function(b,a,c){oa.get(b.load,{cache:!0,responseType:"arraybuffer",retry:0<this.maxRetries,maxRetries:this.maxRetries},a)};d.open=function(b,a,c){a=this.parse(a);if(!a)return null;b=new X(c,{name:b,addressU:a.cubemap?1:0,addressV:a.cubemap?1:0,width:a.width,height:a.height,format:a.format,cubemap:a.cubemap,levels:a.levels});
b.upload();return b};d.parse=function(b){var a=new Uint32Array(b,0,16);if(Ch[0]!==a[0]||Ch[1]!==a[1]||Ch[2]!==a[2])return null;var c=a[6],e=a[7],f=a[9],h=a[10],k=a[12],m=a[13],n=a[14];if(1<a[11]||1<k||0!==c||!al[e])return null;a=64+a[15];c=[];k=!1;for(var p=0;p<(n||1);p++){var t=(new Uint32Array(b.slice(a,a+4)))[0];a+=4;t/=m||1;1<m&&(k=!0,c.push([]));for(var r=0;r<m;r++){var u=new Uint8Array(b,a,t);1<m?c[p].push(u):c.push(u);a+=t}a+=3-(a+3)%4}return{format:al[e],width:f,height:h,levels:c,cubemap:k}};
return g}(),cl=function(){function g(b){this.maxRetries=0}var d=g.prototype;d.load=function(b,a,c){oa.get(b.load,{cache:!0,responseType:"arraybuffer",retry:0<this.maxRetries,maxRetries:this.maxRetries},a)};d.open=function(b,a,c){var e=new Uint32Array(a,0,32),f=e[4],h=e[3],k=Math.max(e[7],1),m=e[21],n=e[22],p=65024===e[28],t=!1,r=!1,u=!1,v=!1,w=!1,y=null;if(4===e[20])if(827611204===m)y=8,t=!0;else if(894720068===m)y=10,t=!0;else if(116===m)y=14,r=!0;else if(826496069===m)y=21,u=t=!0;else if(825438800===
m||825504336===m)y=825438800===m?24:25,v=t=!0;else{if(825439312===m||825504848===m)y=825439312===m?26:27,w=t=!0}else 32===n&&(y=7);if(!y)return b=new X(c,{width:4,height:4,format:6}),b.name="dds-legacy-empty",b;b=new X(c,{name:b,addressU:p?1:0,addressV:p?1:0,width:f,height:h,format:y,cubemap:p});c=128;e=p?6:1;m=827611204===m?8:16;for(n=0;n<e;n++){y=f;for(var x=h,z=0;z<k;z++){if(t)if(u)var B=Math.floor((y+3)/4)*Math.floor((x+3)/4)*8;else if(v)B=Math.max(y,16)*Math.max(x,8)/4;else if(w)B=Math.max(y,
8)*Math.max(x,8)/2;else{B=Math.floor((y+4-1)/4);var C=Math.floor((x+4-1)/4);B*=C;B*=m}else B=y*x*4;C=r?new Float32Array(a,c,B):new Uint8Array(a,c,B);p?(b._levels[z]||(b._levels[z]=[]),b._levels[z][n]=C):b._levels[z]=C;c+=r?4*B:B;y=Math.max(.5*y,1);x=Math.max(.5*x,1)}}b.upload();return b};return g}(),dl={repeat:0,clamp:1,mirror:2},el={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},gp={"default":"default",rgbm:"rgbm",rgbe:"rgbe",swizzleGGGR:"swizzleGGGR"},
hp=function(){function g(){}var d=g.prototype;d.load=function(b,a,c){throw Error("not implemented");};d.open=function(b,a,c){throw Error("not implemented");};return g}(),ip=function(g){var d=Math.log2(Math.max(g._width,g._height))+1,b=function(k){return k instanceof HTMLCanvasElement||k instanceof HTMLImageElement||k instanceof HTMLVideoElement};if(!(7!==g._format&&14!==g._format||g._volume||g._compressed||1===g._levels.length||g._levels.length===d||b(g._cubemap?g._levels[0][0]:g._levels[0]))){b=
function(k,m,n){var p=Math.max(1,k>>1),t=Math.max(1,m>>1),r=new n.constructor(p*t*4),u=Math.floor(k/p);m=Math.floor(m/t);for(var v=u*m,w=0;w<t;++w)for(var y=0;y<p;++y)for(var x=0;4>x;++x){for(var z=0,B=0;B<m;++B)for(var C=0;C<u;++C)z+=n[4*(y*u+C+(w*m+B)*k)+x];r[4*(y+w*p)+x]=z/v}return r};for(var a=g._levels.length;a<d;++a){var c=Math.max(1,g._width>>a-1),e=Math.max(1,g._height>>a-1);if(g._cubemap){for(var f=[],h=0;6>h;++h)f.push(b(c,e,g._levels[a-1][h]));g._levels.push(f)}else g._levels.push(b(c,
e,g._levels[a-1]))}g._levelsUpdated=g._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}},fl=function(){function g(b,a,c){this._device=b;this._assets=a;this._loader=c;this.imgParser=new $k(a);this.parsers={dds:new cl(a),ktx:new bl(a),basis:new Zk(a)}}var d=g.prototype;d._getUrlWithoutParams=function(b){return 0<=b.indexOf("?")?b.split("?")[0]:b};d._getParser=function(b){b=da.getExtension(this._getUrlWithoutParams(b)).toLowerCase().replace(".","");return this.parsers[b]||this.imgParser};d.load=function(b,a,c){"string"===
typeof b&&(b={load:b,original:b});this._getParser(b.original).load(b,a,c)};d.open=function(b,a,c){if(b)return b=this._getParser(b).open(b,a,this._device),null===b?b=new X(this._device,{width:4,height:4,format:6}):ip(b),b};d.patch=function(b,a){if(a=b.resource){b.name&&0<b.name.length&&(a.name=b.name);var c=b.data;c.hasOwnProperty("minfilter")&&(a.minFilter=el[c.minfilter]);c.hasOwnProperty("magfilter")&&(a.magFilter=el[c.magfilter]);a.cubemap||(c.hasOwnProperty("addressu")&&(a.addressU=dl[c.addressu]),
c.hasOwnProperty("addressv")&&(a.addressV=dl[c.addressv]));c.hasOwnProperty("mipmaps")&&(a.mipmaps=c.mipmaps);c.hasOwnProperty("anisotropy")&&(a.anisotropy=c.anisotropy);c.hasOwnProperty("flipY")&&(a.flipY=!!c.flipY);c.hasOwnProperty("type")?a.type=gp[c.type]:c.hasOwnProperty("rgbm")&&c.rgbm?a.type="rgbm":b.file&&b.getPreferredFile&&(b=b.getPreferredFile())&&b.opt&&0!==(b.opt&8)&&(a.type="swizzleGGGR")}};N(g,[{key:"crossOrigin",get:function(){return this.imgParser.crossOrigin},set:function(b){this.imgParser.crossOrigin=
b}},{key:"maxRetries",get:function(){return this.imgParser.maxRetries},set:function(b){this.imgParser.maxRetries=b;for(var a in this.parsers)this.parsers.hasOwnProperty(a)&&(this.parsers[a].maxRetries=b)}}]);return g}(),jp=function(){function g(b){void 0===b&&(b=null);this._index={};this._key=b}var d=g.prototype;d.addItem=function(b){for(var a=b.tags._list,c=0;c<a.length;c++)this.add(a[c],b)};d.removeItem=function(b){for(var a=b.tags._list,c=0;c<a.length;c++)this.remove(a[c],b)};d.add=function(b,
a){this._index[b]&&-1!==this._index[b].list.indexOf(a)||(this._index[b]||(this._index[b]={list:[]},this._key&&(this._index[b].keys={})),this._index[b].list.push(a),this._key&&(this._index[b].keys[a[this._key]]=a))};d.remove=function(b,a){if(this._index[b]&&(!this._key||this._index[b].keys[a[this._key]])){var c=this._index[b].list.indexOf(a);-1!==c&&(this._index[b].list.splice(c,1),this._key&&delete this._index[b].keys[a[this._key]],0===this._index[b].list.length&&delete this._index[b])}};d.find=function(b){var a=
this,c={},e=[],f,h,k=function(t,r){return a._index[t].list.length-a._index[r].list.length};for(f=0;f<b.length;f++){var m=b[f];if(m instanceof Array){if(0===m.length)continue;if(1===m.length)m=m[0];else{var n=!1;for(h=0;h<m.length;h++)if(!this._index[m[h]]){n=!0;break}if(n)continue;m=m.slice(0).sort(k);var p=m.slice(1);1===p.length&&(p=p[0]);for(h=0;h<this._index[m[0]].list.length;h++)n=this._index[m[0]].list[h],(this._key?!c[n[this._key]]:-1===e.indexOf(n))&&n.tags.has(p)&&(this._key&&(c[n[this._key]]=
!0),e.push(n));continue}}if(m&&"string"===typeof m&&this._index[m])for(h=0;h<this._index[m].list.length;h++)n=this._index[m].list[h],this._key?c[n[this._key]]||(c[n[this._key]]=!0,e.push(n)):-1===e.indexOf(n)&&e.push(n)}return e};return g}(),Dh=function(g){function d(a){var c=g.call(this)||this;c._loader=a;c._assets=[];c._cache={};c._names={};c._tags=new jp("_id");c._urls={};c.prefix=null;return c}K(d,g);var b=d.prototype;b.list=function(a){a=a||{};return this._assets.filter(function(c){var e=!0;
void 0!==a.preload&&(e=c.preload===a.preload);return e})};b.add=function(a){var c=this._assets.push(a)-1;this._cache[a.id]=c;this._names[a.name]||(this._names[a.name]=[]);this._names[a.name].push(c);if(a.file){var e=a.file.url;this._urls[e]=c}a.registry=this;this._tags.addItem(a);a.tags.on("add",this._onTagAdd,this);a.tags.on("remove",this._onTagRemove,this);this.fire("add",a);this.fire("add:"+a.id,a);e&&this.fire("add:url:"+e,a);a.preload&&this.load(a)};b.remove=function(a){var c=this._cache[a.id],
e=a.file?a.file.url:null;if(void 0!==c){this._assets.splice(c,1);delete this._cache[a.id];this._names={};this._urls=[];c=0;for(var f=this._assets.length;c<f;c++){var h=this._assets[c];this._cache[h.id]=c;this._names[h.name]||(this._names[h.name]=[]);this._names[h.name].push(c);h.file&&(this._urls[h.file.url]=c)}this._tags.removeItem(a);a.tags.off("add",this._onTagAdd,this);a.tags.off("remove",this._onTagRemove,this);a.fire("remove",a);this.fire("remove",a);this.fire("remove:"+a.id,a);e&&this.fire("remove:url:"+
e,a);return!0}return!1};b.get=function(a){return this._assets[this._cache[a]]};b.getByUrl=function(a){return this._assets[this._urls[a]]};b.load=function(a){if(!a.loading&&!a.loaded){var c=this,e=a.getPreferredFile(),f=function(k){k instanceof Array?a.resources=k:a.resource=k;c._loader.patch(a,c);c.fire("load",a);c.fire("load:"+a.id,a);e&&e.url&&c.fire("load:url:"+e.url,a);a.fire("load",a)},h=function(k,m,n){a.loaded=!0;a.loading=!1;k?(c.fire("error",k,a),c.fire("error:"+a.id,k,a),a.fire("error",
k,a)):(Va.legacy||"script"!==a.type||(k=c._loader.getHandler("script"),k._cache[a.id]&&k._cache[a.id].parentNode===document.head&&document.head.removeChild(k._cache[a.id]),k._cache[a.id]=n),f(m))};e||"cubemap"===a.type?(this.fire("load:start",a),this.fire("load:"+a.id+":start",a),a.loading=!0,c._loader.load(a.getFileUrl(),a.type,h,a)):(h=c._loader.open(a.type,a.data),a.loaded=!0,f(h))}};b.loadFromUrl=function(a,c,e){this.loadFromUrlAndFilename(a,null,c,e)};b.loadFromUrlAndFilename=function(a,c,e,
f){var h=this,k=da.getBasename(c||a);c={filename:c||k,url:a};a=h.getByUrl(a);a||(a=new fa(k,e,c),h.add(a));k=function(m){m.once("load",function(n){"material"===e?h._loadTextures(n,function(p,t){f(p,n)}):f(null,n)});m.once("error",function(n){f(n)});h.load(m)};a.resource?f(null,a):"model"===e?h._loadModel(a,k):k(a)};b._loadModel=function(a,c){var e=this,f=a.getFileUrl(),h=da.getExtension(f);if(".json"===h||".glb"===h){var k=da.getDirectory(f);f=da.getBasename(f);h=da.join(k,f.replace(h,".mapping.json"));
this._loader.load(h,"json",function(m,n){m?(a.data={mapping:[]},c(a)):e._loadMaterials(a,n,function(p,t){a.data=n;c(a)})})}else c(a)};b._loadMaterials=function(a,c,e){for(var f=this,h=[],k=0,m=function(t,r){f._loadTextures(r,function(u,v){h.push(r);h.length===k&&e(null,h)})},n=0;n<c.mapping.length;n++){var p=c.mapping[n].path;p&&(k++,f.loadFromUrl(a.getAbsoluteUrl(p),"material",m))}0===k&&e(null,h)};b._loadTextures=function(a,c){var e=[],f=0,h=a.data;if("path"!==h.mappingFormat)c(null,e);else{for(var k=
function(p,t){p&&console.error(p);e.push(t);e.length===f&&c(null,e)},m=0;m<Bd.length;m++){var n=h[Bd[m]];n&&"string"===typeof n&&(f++,this.loadFromUrl(a.getAbsoluteUrl(n),"texture",k))}0===f&&c(null,e)}};b.findAll=function(a,c){var e=this;return(a=this._names[a])?(a=a.map(function(f){return e._assets[f]}),c?a.filter(function(f){return f.type===c}):a):[]};b._onTagAdd=function(a,c){this._tags.add(a,c)};b._onTagRemove=function(a,c){this._tags.remove(a,c)};b.findByTag=function(){return this._tags.find(arguments)};
b.filter=function(a){for(var c=[],e=0,f=this._assets.length;e<f;e++)a(this._assets[e])&&c.push(this._assets[e]);return c};b.find=function(a,c){a=this.findAll(a,c);return 0<a.length?a[0]:null};return d}(ba),gl=function(){function g(b){this._assets=b;this._bundleAssets={};this._assetsInBundles={};this._urlsInBundles={};this._fileRequests={};this._assets.on("add",this._onAssetAdded,this);this._assets.on("remove",this._onAssetRemoved,this)}var d=g.prototype;d._onAssetAdded=function(b){if("bundle"===b.type){this._bundleAssets[b.id]=
b;this._registerBundleEventListeners(b.id);for(var a=0,c=b.data.assets.length;a<c;a++)this._indexAssetInBundle(b.data.assets[a],b)}else this._assetsInBundles[b.id]&&this._indexAssetFileUrls(b)};d._registerBundleEventListeners=function(b){this._assets.on("load:"+b,this._onBundleLoaded,this);this._assets.on("error:"+b,this._onBundleError,this)};d._unregisterBundleEventListeners=function(b){this._assets.off("load:"+b,this._onBundleLoaded,this);this._assets.off("error:"+b,this._onBundleError,this)};d._indexAssetInBundle=
function(b,a){if(this._assetsInBundles[b]){var c=this._assetsInBundles[b];-1===c.indexOf(a)&&c.push(a)}else this._assetsInBundles[b]=[a];(b=this._assets.get(b))&&this._indexAssetFileUrls(b)};d._indexAssetFileUrls=function(b){var a=this._getAssetFileUrls(b);if(a)for(var c=0,e=a.length;c<e;c++)this._urlsInBundles[a[c]]=this._assetsInBundles[b.id]};d._getAssetFileUrls=function(b){var a=b.getFileUrl();if(!a)return null;a=this._normalizeUrl(a);var c=[a];if("font"===b.type){b=b.data.info.maps.length;for(var e=
1;e<b;e++)c.push(a.replace(".png",e+".png"))}return c};d._normalizeUrl=function(b){return b&&b.split("?")[0]};d._onAssetRemoved=function(b){if("bundle"===b.type){delete this._bundleAssets[b.id];this._unregisterBundleEventListeners(b.id);var a;for(a in this._assetsInBundles){var c=this._assetsInBundles[a];var e=c.indexOf(b);if(-1!==e&&(c.splice(e,1),!c.length)){delete this._assetsInBundles[a];for(var f in this._urlsInBundles)this._urlsInBundles[f]===c&&delete this._urlsInBundles[f]}}this._onBundleError("Bundle "+
b.id+" was removed",b)}else if(this._assetsInBundles[b.id])for(delete this._assetsInBundles[b.id],b=this._getAssetFileUrls(b),e=0,a=b.length;e<a;e++)delete this._urlsInBundles[b[e]]};d._onBundleLoaded=function(b){b.resource?requestAnimationFrame(function(){if(this._fileRequests)for(var a in this._fileRequests){var c=this._urlsInBundles[a];if(c&&-1!==c.indexOf(b)){c=decodeURIComponent(a);var e=null;b.resource.hasBlobUrl(c)||(e="Bundle "+b.id+" does not contain URL "+a);for(var f=this._fileRequests[a],
h=0,k=f.length;h<k;h++)if(e)f[h](e);else f[h](null,b.resource.getBlobUrl(c));delete this._fileRequests[a]}}}.bind(this)):this._onBundleError("Bundle "+b.id+" failed to load",b)};d._onBundleError=function(b,a){for(var c in this._fileRequests)if(!this._findLoadedOrLoadingBundleForUrl(c)){a=this._fileRequests[c];for(var e=0,f=a.length;e<f;e++)a[e](b);delete this._fileRequests[c]}};d._findLoadedOrLoadingBundleForUrl=function(b){b=this._urlsInBundles[b];if(!b)return null;var a=b.length,c;for(c=0;c<a;c++)if(b[c].loaded&&
b[c].resource)return b[c];for(c=0;c<a;c++)if(b[c].loading)return b[c];return null};d.listBundlesForAsset=function(b){return this._assetsInBundles[b.id]||null};d.list=function(){var b=[],a;for(a in this._bundleAssets)b.push(this._bundleAssets[a]);return b};d.hasUrl=function(b){return!!this._urlsInBundles[b]};d.canLoadUrl=function(b){return!!this._findLoadedOrLoadingBundleForUrl(b)};d.loadUrl=function(b,a){var c=this._findLoadedOrLoadingBundleForUrl(b);if(c)if(c.loaded){var e=decodeURIComponent(b);
c.resource.hasBlobUrl(e)?a(null,c.resource.getBlobUrl(e)):a("Bundle "+c.id+" does not contain URL "+b)}else this._fileRequests.hasOwnProperty(b)?this._fileRequests[b].push(a):this._fileRequests[b]=[a];else a("URL "+b+" not found in any bundles")};d.destroy=function(){this._assets.off("add",this._onAssetAdded,this);this._assets.off("remove",this._onAssetRemoved,this);for(var b in this._bundleAssets)this._unregisterBundleEventListeners(b);this._fileRequests=this._urlsInBundles=this._assetsInBundles=
this._bundleAssets=this._assets=null};return g}(),hl=function(g){function d(a){var c=g.call(this)||this;c.list=function(){return this._list};c.app=a;c._scripts={};c._list=[];return c}K(d,g);var b=d.prototype;b.destroy=function(){this.app=null;this.off()};b.add=function(a){var c=this,e=a.__name;if(this._scripts.hasOwnProperty(e))return setTimeout(function(){if(a.prototype.swap){var f=c._list.indexOf(c._scripts[e]);c._list[f]=a;c._scripts[e]=a;c.fire("swap",e,a);c.fire("swap:"+e,a)}else console.warn("script registry already has '"+
e+"' script, define 'swap' method for new script type to enable code hot swapping")}),!1;this._scripts[e]=a;this._list.push(a);this.fire("add",e,a);this.fire("add:"+e,a);setTimeout(function(){if(c._scripts.hasOwnProperty(e)&&c.app&&c.app.systems&&c.app.systems.script){var f=c.app.systems.script._components,h=[],k=[];for(f.loopIndex=0;f.loopIndex<f.length;f.loopIndex++){var m=f.items[f.loopIndex];if(m._scriptsIndex[e]&&m._scriptsIndex[e].awaiting){if(m._scriptsData&&m._scriptsData[e])var n=m._scriptsData[e].attributes;
(m=m.create(e,{preloading:!0,ind:m._scriptsIndex[e].ind,attributes:n}))&&h.push(m)}}for(f=0;f<h.length;f++)h[f].__initializeAttributes();for(f=0;f<h.length;f++)h[f].enabled&&(h[f]._initialized=!0,k.push(h[f]),h[f].initialize&&h[f].initialize());for(f=0;f<k.length;f++)k[f].enabled&&!k[f]._postInitialized&&(k[f]._postInitialized=!0,k[f].postInitialize&&k[f].postInitialize())}});return!0};b.remove=function(a){var c=a;"string"!==typeof a?a=c.__name:c=this.get(a);if(this.get(a)!==c)return!1;delete this._scripts[a];
var e=this._list.indexOf(c);this._list.splice(e,1);this.fire("remove",a,c);this.fire("remove:"+a,c);return!0};b.get=function(a){return this._scripts[a]||null};b.has=function(a){return"string"===typeof a?this._scripts.hasOwnProperty(a):a?this._scripts[a.__name]===a:!1};return d}(ba),il=function(g){function d(a,c){var e=g.call(this)||this;var f=F(e);e._app=a;e._device=a.graphicsDevice;e.id=c.displayId;e._frameData=null;window.VRFrameData&&(e._frameData=new window.VRFrameData);e.display=c;e._camera=
null;e.sitToStandInv=new M;e.leftView=new M;e.leftProj=new M;e.leftViewInv=new M;e.leftPos=new A;e.rightView=new M;e.rightProj=new M;e.rightViewInv=new M;e.rightPos=new A;e.combinedPos=new A;e.combinedView=new M;e.combinedProj=new M;e.combinedViewInv=new M;e.combinedFov=0;e.combinedAspect=0;e.presenting=!1;f._presentChange=function(h){if((h.display?h.display:h.detail&&h.detail.display?h.detail.display:h.detail&&h.detail.vrdisplay?h.detail.vrdisplay:f.display)===f.display){f.presenting=f.display&&
f.display.isPresenting;if(f.presenting){h=f.display.getEyeParameters("left");var k=f.display.getEyeParameters("right");f._app.graphicsDevice.setResolution(2*Math.max(h.renderWidth,k.renderWidth),Math.max(h.renderHeight,k.renderHeight));f._app._allowResize=!1}else f._app.setCanvasResolution("AUTO"),f._app._allowResize=!0;f.fire("beforepresentchange",f);f.fire("presentchange",f)}};window.addEventListener("vrdisplaypresentchange",f._presentChange,!1);return e}K(d,g);var b=d.prototype;b.destroy=function(){window.removeEventListener("vrdisplaypresentchange",
self._presentChange);this._camera&&(this._camera.vrDisplay=null);this._camera=null};b.poll=function(){if(this.display){this.display.getFrameData(this._frameData);this.leftProj.data=this._frameData.leftProjectionMatrix;this.rightProj.data=this._frameData.rightProjectionMatrix;var a=this.display.stageParameters;a?(this.sitToStandInv.set(a.sittingToStandingTransform).invert(),this.combinedView.set(this._frameData.leftViewMatrix),this.leftView.mul2(this.combinedView,this.sitToStandInv),this.combinedView.set(this._frameData.rightViewMatrix),
this.rightView.mul2(this.combinedView,this.sitToStandInv)):(this.leftView.set(this._frameData.leftViewMatrix),this.rightView.set(this._frameData.rightViewMatrix));var c=this.leftProj.data[3]+this.leftProj.data[0],e=this.leftProj.data[11]+this.leftProj.data[8],f=1/Math.sqrt(c*c+e*e);a=-Math.atan2(e*f,c*f);c=this.rightProj.data[3]+this.rightProj.data[0];e=this.rightProj.data[11]+this.rightProj.data[8];f=1/Math.sqrt(c*c+e*e);a=Math.max(a,-Math.atan2(e*f,c*f));this.combinedFov=a*=2;this.combinedAspect=
c=this.rightProj.data[5]/this.rightProj.data[0];e=this.combinedView;e.copy(this.leftView);e.invert();this.leftViewInv.copy(e);f=this.combinedPos;f.x=this.leftPos.x=e.data[12];f.y=this.leftPos.y=e.data[13];f.z=this.leftPos.z=e.data[14];e.copy(this.rightView);e.invert();this.rightViewInv.copy(e);var h=f.x-e.data[12],k=f.y-e.data[13],m=f.z-e.data[14];h=Math.sqrt(h*h+k*k+m*m);this.rightPos.x=e.data[12];this.rightPos.y=e.data[13];this.rightPos.z=e.data[14];f.x+=e.data[12];f.y+=e.data[13];f.z+=e.data[14];
f.x*=.5;f.y*=.5;f.z*=.5;h=.5*h*Math.sin(Math.PI-(.5*Math.PI+.5*a));k=e.data[9];m=e.data[10];e.data[12]=f.x+e.data[8]*h;e.data[13]=f.y+k*h;e.data[14]=f.z+m*h;this.combinedViewInv.copy(e);e.invert();this.combinedProj.setPerspective(a*R.RAD_TO_DEG,c,this.display.depthNear+h,this.display.depthFar+h,!0)}};b.requestPresent=function(a){this.display?this.presenting?a&&a(Error("VrDisplay already presenting")):this.display.requestPresent([{source:this._device.canvas}]).then(function(){a&&a()},function(c){a&&
a(c)}):a&&a(Error("No VrDisplay to requestPresent"))};b.exitPresent=function(a){this.display||a&&a(Error("No VrDisplay to exitPresent"));this.presenting?this.display.exitPresent().then(function(){a&&a()},function(){a&&a(Error("exitPresent failed"))}):a&&a(Error("VrDisplay not presenting"))};b.requestAnimationFrame=function(a){this.display&&this.display.requestAnimationFrame(a)};b.submitFrame=function(){this.display&&this.display.submitFrame()};b.reset=function(){this.display&&this.display.resetPose()};
b.setClipPlanes=function(a,c){this.display&&(this.display.depthNear=a,this.display.depthFar=c)};b.getFrameData=function(){if(this.display)return this._frameData};N(d,[{key:"capabilities",get:function(){return this.display?this.display.capabilities:{}}}]);return d}(ba),Eh=function(g){function d(b){var a=F(void 0);(void 0)._onDisplayConnect=(void 0)._onDisplayConnect.bind(F(void 0));(void 0)._onDisplayDisconnect=(void 0)._onDisplayDisconnect.bind(F(void 0));a._attach();(void 0)._getDisplays(function(c,
e){if(c)a.fire("error",c);else{for(c=0;c<e.length;c++)a._addDisplay(e[c]);a.fire("ready",a.displays)}});return F(void 0)}K(d,g);g=d.prototype;g._attach=function(){window.addEventListener("vrdisplayconnect",this._onDisplayConnect);window.addEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)};g._detach=function(){window.removeEventListener("vrdisplayconnect",this._onDisplayConnect);window.removeEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)};g.destroy=function(){this._detach()};
g.poll=function(){var b=this.displays.length;if(b)for(var a=0;a<b;a++)this.displays[a]._camera&&this.displays[a].poll()};g._getDisplays=function(b){navigator.getVRDisplays?navigator.getVRDisplays().then(function(a){b&&b(null,a)}):b&&b(Error("WebVR not supported"))};g._addDisplay=function(b){this._index[b.displayId]||(b=new il(this._app,b),this._index[b.id]=b,this.displays.push(b),this.display||(this.display=b),this.fire("displayconnect",b))};g._onDisplayConnect=function(b){b.detail&&b.detail.display?
this._addDisplay(b.detail.display):this._addDisplay(b.display)};g._onDisplayDisconnect=function(b){if(b=this._index[b.detail&&b.detail.display?b.detail.display.displayId:b.display.displayId]){b.destroy();delete this._index[b.id];var a=this.displays.indexOf(b);this.displays.splice(a,1);this.display===b&&(this.display=this.displays.length?this.displays[0]:null);this.fire("displaydisconnect",b)}};return d}(ba);Eh.isSupported="undefined"!==typeof navigator?!!navigator.getVRDisplays:!1;for(var jl=[],kl=
[],ll=function(g){function d(a,c,e){var f=g.call(this)||this;f.manager=a;f._xrHitTestSource=c;f._transient=e;return f}K(d,g);var b=d.prototype;b.remove=function(){if(this._xrHitTestSource){var a=this.manager.hitTest.sources,c=a.indexOf(this);-1!==c&&a.splice(c,1);this.onStop()}};b.onStop=function(){this._xrHitTestSource.cancel();this._xrHitTestSource=null;this.fire("remove");this.manager.hitTest.fire("remove",this)};b.update=function(a){if(this._transient){a=a.getHitTestResultsForTransientInput(this._xrHitTestSource);
for(var c=0;c<a.length;c++){var e=a[c],f;e.inputSource&&(f=this.manager.input._getByInputSource(e.inputSource));this.updateHitResults(e.results,f)}}else this.updateHitResults(a.getHitTestResults(this._xrHitTestSource))};b.updateHitResults=function(a,c){for(var e=0;e<a.length;e++){var f=a[e].getPose(this.manager._referenceSpace),h=jl.pop();h||(h=new A);h.copy(f.transform.position);var k=kl.pop();k||(k=new ea);k.copy(f.transform.orientation);this.fire("result",h,k,c);this.manager.hitTest.fire("result",
this,h,k,c);jl.push(h);kl.push(k)}};return d}(ba),ml=function(g){function d(a){var c=g.call(this)||this;c.manager=a;c._supported=!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource);c._session=null;c.sources=[];c._supported&&(c.manager.on("start",c._onSessionStart,F(c)),c.manager.on("end",c._onSessionEnd,F(c)));return c}K(d,g);var b=d.prototype;b._onSessionStart=function(){"immersive-ar"===this.manager.type&&(this._session=this.manager.session)};b._onSessionEnd=function(){if(this._session){this._session=
null;for(var a=0;a<this.sources.length;a++)this.sources[a].onStop();this.sources=[]}};b.isAvailable=function(a,c){var e;this._supported||(e=Error("XR HitTest is not supported"));this._session||(e=Error("XR Session is not started (1)"));"immersive-ar"!==this.manager.type&&(e=Error("XR HitTest is available only for AR"));return e?(a&&a(e),c&&c.fire("error",e),!1):!0};b.start=function(a){var c=this;a=a||{};if(this.isAvailable(a.callback,this)){a.profile||a.spaceType||(a.spaceType="viewer");var e,f=a.offsetRay;
f&&(e=new XRRay(new DOMPoint(f.origin.x,f.origin.y,f.origin.z),new DOMPoint(f.direction.x,f.direction.y,f.direction.z)));var h=a.callback;a.spaceType?this._session.requestReferenceSpace(a.spaceType).then(function(k){c._session?c._session.requestHitTestSource({space:k,entityTypes:a.entityTypes||void 0,offsetRay:e}).then(function(m){c._onHitTestSource(m,!1,h)}).catch(function(m){h&&h(m);c.fire("error",m)}):(k=Error("XR Session is not started (2)"),h&&h(k),c.fire("error",k))}).catch(function(k){h&&h(k);
c.fire("error",k)}):this._session.requestHitTestSourceForTransientInput({profile:a.profile,entityTypes:a.entityTypes||void 0,offsetRay:e}).then(function(k){c._onHitTestSource(k,!0,h)}).catch(function(k){h&&h(k);c.fire("error",k)})}};b._onHitTestSource=function(a,c,e){this._session?(a=new ll(this.manager,a,c),this.sources.push(a),e&&e(null,a),this.fire("add",a)):(a.cancel(),a=Error("XR Session is not started (3)"),e&&e(a),this.fire("error",a))};b.update=function(a){for(var c=0;c<this.sources.length;c++)this.sources[c].update(a)};
N(d,[{key:"supported",get:function(){return this._supported}}]);return d}(ba),kp=function(){function g(d,b){this._index=d;this._hand=b;this._hand._fingers.push(this);this._joints=[];this._tip=null}N(g,[{key:"index",get:function(){return this._index}},{key:"hand",get:function(){return this._hand}},{key:"joints",get:function(){return this._joints}},{key:"tip",get:function(){return this._tip}}]);return g}(),nl=window.XRHand?[XRHand.THUMB_PHALANX_TIP,XRHand.INDEX_PHALANX_TIP,XRHand.MIDDLE_PHALANX_TIP,
XRHand.RING_PHALANX_TIP,XRHand.LITTLE_PHALANX_TIP]:[],ol={},Fh=0;Fh<nl.length;Fh++)ol[nl[Fh]]=!0;var pl=function(){function g(b,a,c,e){void 0===e&&(e=null);this._index=b;this._id=a;this._hand=c;this._hand._joints.push(this);this._hand._jointsById[a]=this;(this._finger=e)&&this._finger._joints.push(this);if(this._wrist=a===XRHand.WRIST)this._hand._wrist=this;if(this._tip=this._finger&&!!ol[a])this._hand._tips.push(this),this._finger&&(this._finger._tip=this);this._radius=null;this._localTransform=
new M;this._worldTransform=new M;this._localPosition=new A;this._localRotation=new ea;this._position=new A;this._rotation=new ea;this._dirtyLocal=!0}var d=g.prototype;d.update=function(b){this._dirtyLocal=!0;this._radius=b.radius;this._localPosition.copy(b.transform.position);this._localRotation.copy(b.transform.orientation)};d._updateTransforms=function(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,A.ONE));var b=this._hand._manager.camera.parent;
b?this._worldTransform.mul2(b.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)};d.getPosition=function(){this._updateTransforms();this._worldTransform.getTranslation(this._position);return this._position};d.getRotation=function(){this._updateTransforms();this._rotation.setFromMat4(this._worldTransform);return this._rotation};N(g,[{key:"index",get:function(){return this._index}},{key:"hand",get:function(){return this._hand}},{key:"finger",get:function(){return this._finger}},
{key:"wrist",get:function(){return this._wrist}},{key:"tip",get:function(){return this._tip}},{key:"radius",get:function(){return this._radius||.005}}]);return g}(),Pf=[],Qc=new A,Qf=new A,ql=new A;window.XRHand&&(Pf=[[XRHand.THUMB_METACARPAL,XRHand.THUMB_PHALANX_PROXIMAL,XRHand.THUMB_PHALANX_DISTAL,XRHand.THUMB_PHALANX_TIP],[XRHand.INDEX_METACARPAL,XRHand.INDEX_PHALANX_PROXIMAL,XRHand.INDEX_PHALANX_INTERMEDIATE,XRHand.INDEX_PHALANX_DISTAL,XRHand.INDEX_PHALANX_TIP],[XRHand.MIDDLE_METACARPAL,XRHand.MIDDLE_PHALANX_PROXIMAL,
XRHand.MIDDLE_PHALANX_INTERMEDIATE,XRHand.MIDDLE_PHALANX_DISTAL,XRHand.MIDDLE_PHALANX_TIP],[XRHand.RING_METACARPAL,XRHand.RING_PHALANX_PROXIMAL,XRHand.RING_PHALANX_INTERMEDIATE,XRHand.RING_PHALANX_DISTAL,XRHand.RING_PHALANX_TIP],[XRHand.LITTLE_METACARPAL,XRHand.LITTLE_PHALANX_PROXIMAL,XRHand.LITTLE_PHALANX_INTERMEDIATE,XRHand.LITTLE_PHALANX_DISTAL,XRHand.LITTLE_PHALANX_TIP]]);var lp=function(g){function d(a){var c=g.call(this)||this;c.update=function(m){for(var n=this._inputSource._xrInputSource,
p=0;p<this._joints.length;p++){var t=this._joints[p],r=n.hand[t._id];if(r)if(r=m.getJointPose(r,this._manager._referenceSpace))t.update(r),t.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(t.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}t=this._jointsById[XRHand.THUMB_METACARPAL];r=this._jointsById[XRHand.THUMB_PHALANX_TIP];m=this._jointsById[XRHand.INDEX_PHALANX_PROXIMAL];var u=this._jointsById[XRHand.INDEX_PHALANX_TIP];n=this._jointsById[XRHand.RING_PHALANX_PROXIMAL];
p=this._jointsById[XRHand.LITTLE_PHALANX_PROXIMAL];t&&r&&m&&u&&n&&p&&(this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(r._localPosition,u._localPosition,.5),"left"===this._inputSource.handedness&&(r=t,t=p,p=r),Qc.sub2(t._localPosition,this._wrist._localPosition),Qf.sub2(p._localPosition,this._wrist._localPosition),ql.cross(Qc,Qf).normalize(),Qc.lerp(m._localPosition,n._localPosition,.5),Qc.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(ql,
Qc,.5).normalize());this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",
this._inputSource))};var e=a._xrInputSource.hand;c._manager=a._manager;c._inputSource=a;c._tracking=!1;c._fingers=[];c._joints=[];c._jointsById={};c._tips=[];c._wrist=null;e[XRHand.WRIST]&&(c._wrist=new pl(0,XRHand.WRIST,F(c),null));for(a=0;a<Pf.length;a++)for(var f=new kp(a,F(c)),h=0;h<Pf[a].length;h++){var k=Pf[a][h];e[k]&&new pl(h,k,F(c),f)}return c}K(d,g);var b=d.prototype;b._fingerIsClosed=function(a){a=this._fingers[a];Qc.sub2(a.joints[0]._localPosition,a.joints[1]._localPosition).normalize();
Qf.sub2(a.joints[2]._localPosition,a.joints[3]._localPosition).normalize();return-.8>Qc.dot(Qf)};b.getJointById=function(a){return this._jointsById[a]||null};N(d,[{key:"fingers",get:function(){return this._fingers}},{key:"joints",get:function(){return this._joints}},{key:"tips",get:function(){return this._tips}},{key:"wrist",get:function(){return this._wrist}},{key:"tracking",get:function(){return this._tracking}}]);return d}(ba),rl=new ea,mp=0,oe=function(g){function d(a,c){var e=g.call(this)||this;
e._updateRayTransforms=function(){var f=this._dirtyRay;this._dirtyRay=!1;this._manager.camera.parent?(f=this._manager.camera.parent.getWorldTransform(),f.getTranslation(this._position),this._rotation.setFromMat4(f),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)):f&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))};
e.getLocalRotation=function(){return this._localRotation};e.getOrigin=function(){this._updateRayTransforms();return this._ray.origin};e._id=++mp;e._manager=a;e._xrInputSource=c;e._ray=new Ec;e._rayLocal=new Ec;e._grip=!1;e._hand=null;c.hand&&(e._hand=new lp(F(e)));e._localTransform=null;e._worldTransform=null;e._position=new A;e._rotation=new ea;e._localPosition=null;e._localRotation=null;e._dirtyLocal=!0;e._selecting=!1;e._squeezing=!1;e._elementInput=!0;e._elementEntity=null;e._hitTestSources=[];
return e}K(d,g);var b=d.prototype;b.update=function(a){if(this._hand)this._hand.update(a);else{if(this._xrInputSource.gripSpace){var c=a.getPose(this._xrInputSource.gripSpace,this._manager._referenceSpace);c&&(this._grip||(this._grip=!0,this._localTransform=new M,this._worldTransform=new M,this._localPosition=new A,this._localRotation=new ea),this._dirtyLocal=!0,this._localPosition.copy(c.transform.position),this._localRotation.copy(c.transform.orientation))}if(a=a.getPose(this._xrInputSource.targetRaySpace,
this._manager._referenceSpace))this._dirtyRay=!0,this._rayLocal.origin.copy(a.transform.position),this._rayLocal.direction.set(0,0,-1),rl.copy(a.transform.orientation),rl.transformVector(this._rayLocal.direction,this._rayLocal.direction)}};b._updateTransforms=function(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,A.ONE));var a=this._manager.camera.parent;a?this._worldTransform.mul2(a.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)};
b.getPosition=function(){if(!this._position)return null;this._updateTransforms();this._worldTransform.getTranslation(this._position);return this._position};b.getLocalPosition=function(){return this._localPosition};b.getRotation=function(){if(!this._rotation)return null;this._updateTransforms();this._rotation.setFromMat4(this._worldTransform);return this._rotation};b.getDirection=function(){this._updateRayTransforms();return this._ray.direction};b.hitTestStart=function(a){void 0===a&&(a={});var c=
this;a.profile=this._xrInputSource.profiles[0];var e=a.callback;a.callback=function(f,h){if(h)c.onHitTestSourceAdd(h);e&&e(f,h)};this._manager.hitTest.start(a)};b.onHitTestSourceAdd=function(a){this._hitTestSources.push(a);this.fire("hittest:add",a);a.on("result",function(c,e,f){f===this&&this.fire("hittest:result",a,c,e)},this);a.once("remove",function(){this.onHitTestSourceRemove(a);this.fire("hittest:remove",a)},this)};b.onHitTestSourceRemove=function(a){a=this._hitTestSources.indexOf(a);-1!==
a&&this._hitTestSources.splice(a,1)};N(d,[{key:"id",get:function(){return this._id}},{key:"inputSource",get:function(){return this._xrInputSource}},{key:"targetRayMode",get:function(){return this._xrInputSource.targetRayMode}},{key:"handedness",get:function(){return this._xrInputSource.handedness}},{key:"profiles",get:function(){return this._xrInputSource.profiles}},{key:"grip",get:function(){return this._grip}},{key:"hand",get:function(){return this._hand}},{key:"gamepad",get:function(){return this._xrInputSource.gamepad||
null}},{key:"selecting",get:function(){return this._selecting}},{key:"squeezing",get:function(){return this._squeezing}},{key:"elementInput",get:function(){return this._elementInput},set:function(a){this._elementInput!==a&&(this._elementInput=a,this._elementInput||(this._elementEntity=null))}},{key:"elementEntity",get:function(){return this._elementEntity}},{key:"hitTestSources",get:function(){return this._hitTestSources}}]);return d}(ba),sl=function(g){function d(a){var c=g.call(this)||this;var e=
F(c);c.manager=a;c._session=null;c._inputSources=[];c._onInputSourcesChangeEvt=function(f){e._onInputSourcesChange(f)};c.manager.on("start",c._onSessionStart,F(c));c.manager.on("end",c._onSessionEnd,F(c));return c}K(d,g);var b=d.prototype;b._onSessionStart=function(){this._session=this.manager.session;this._session.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt);var a=this;this._session.addEventListener("select",function(f){var h=a._getByInputSource(f.inputSource);h.update(f.frame);
h.fire("select",f);a.fire("select",h,f)});this._session.addEventListener("selectstart",function(f){var h=a._getByInputSource(f.inputSource);h.update(f.frame);h._selecting=!0;h.fire("selectstart",f);a.fire("selectstart",h,f)});this._session.addEventListener("selectend",function(f){var h=a._getByInputSource(f.inputSource);h.update(f.frame);h._selecting=!1;h.fire("selectend",f);a.fire("selectend",h,f)});this._session.addEventListener("squeeze",function(f){var h=a._getByInputSource(f.inputSource);h.update(f.frame);
h.fire("squeeze",f);a.fire("squeeze",h,f)});this._session.addEventListener("squeezestart",function(f){var h=a._getByInputSource(f.inputSource);h.update(f.frame);h._squeezing=!0;h.fire("squeezestart",f);a.fire("squeezestart",h,f)});this._session.addEventListener("squeezeend",function(f){var h=a._getByInputSource(f.inputSource);h.update(f.frame);h._squeezing=!1;h.fire("squeezeend",f);a.fire("squeezeend",h,f)});for(var c=this._session.inputSources,e=0;e<c.length;e++)this._addInputSource(c[e])};b._onSessionEnd=
function(){for(var a=this._inputSources.length;a--;){var c=this._inputSources[a];this._inputSources.splice(a,1);c.fire("remove");this.fire("remove",c)}this._session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt);this._session=null};b._onInputSourcesChange=function(a){var c;for(c=0;c<a.removed.length;c++)this._removeInputSource(a.removed[c]);for(c=0;c<a.added.length;c++)this._addInputSource(a.added[c])};b._getByInputSource=function(a){for(var c=0;c<this._inputSources.length;c++)if(this._inputSources[c].inputSource===
a)return this._inputSources[c];return null};b._addInputSource=function(a){this._getByInputSource(a)||(a=new oe(this.manager,a),this._inputSources.push(a),this.fire("add",a))};b._removeInputSource=function(a){for(var c=0;c<this._inputSources.length;c++)if(this._inputSources[c].inputSource===a){a=this._inputSources[c];this._inputSources.splice(c,1);for(c=a.hitTestSources.length;c--;)a.hitTestSources[c].remove();a.fire("remove");this.fire("remove",a);break}};b.update=function(a){for(var c=0;c<this._inputSources.length;c++)this._inputSources[c].update(a)};
N(d,[{key:"inputSources",get:function(){return this._inputSources}}]);return d}(ba),Cd=new A,tl=new A,Gh=new M,ul=new M,vl=function(g){function d(a){var c=g.call(this)||this;c._manager=a;c._supported=!1;c._available=!1;c._lightProbeRequested=!1;c._lightProbe=null;c._intensity=0;c._rotation=new ea;c._color=new Q;c._sphericalHarmonics=new Float32Array(27);c._manager.on("start",c._onSessionStart,F(c));c._manager.on("end",c._onSessionEnd,F(c));return c}K(d,g);var b=d.prototype;b._onSessionStart=function(){this._manager.session.requestLightProbe&&
(this._supported=!0)};b._onSessionEnd=function(){this._lightProbeRequested=this._available=this._supported=!1;this._lightProbe=null};b.start=function(){var a;this._manager.session||(a=Error("XR session is not running"));a||"immersive-ar"===this._manager.type||(a=Error("XR session type is not AR"));a||this._supported||(a=Error("light-estimation is not supported"));if(!a&&this._lightProbe||this._lightProbeRequested)a=Error("light estimation is already requested");if(a)this.fire("error",a);else{var c=
this;this._lightProbeRequested=!0;this._manager.session.requestLightProbe().then(function(e){var f=c._lightProbeRequested;c._lightProbeRequested=!1;c._manager.active?f&&(c._lightProbe=e):c.fire("error",Error("XR session is not active"))}).catch(function(e){c._lightProbeRequested=!1;c.fire("error",e)})}};b.end=function(){this._lightProbeRequested=!1;this._lightProbe=null;this._available=!1};b.update=function(a){if(this._lightProbe&&(a=a.getLightEstimate(this._lightProbe))){this._available||(this._available=
!0,this.fire("available"));var c=a.primaryLightIntensity;this._intensity=Math.max(1,Math.max(c.x,Math.max(c.y,c.z)));Cd.copy(c).scale(1/this._intensity);this._color.set(Cd.x,Cd.y,Cd.z);Cd.set(0,0,0);tl.copy(a.primaryLightDirection);Gh.setLookAt(tl,Cd,A.UP);ul.setFromAxisAngle(A.RIGHT,90);Gh.mul(ul);this._rotation.setFromMat4(Gh);this._sphericalHarmonics.set(a.sphericalHarmonicsCoefficients)}};N(d,[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}},
{key:"intensity",get:function(){return this._available?this._intensity:null}},{key:"color",get:function(){return this._available?this._color:null}},{key:"rotation",get:function(){return this._available?this._rotation:null}},{key:"sphericalHarmonics",get:function(){return this._available?this._sphericalHarmonics:null}}]);return d}(ba),wl=function(g){function d(a,c){var e=g.call(this)||this;e.destroy=function(){this._pose=this._image=null;this._bitmap&&(this._bitmap.close(),this._bitmap=null)};e.getRotation=
function(){this._pose&&this._rotation.copy(this._pose.transform.orientation);return this._rotation};e._image=a;e._bitmap=null;e._width=c;e._measuredWidth=0;e._trackable=!1;e._tracking=!1;e._emulated=!1;e._pose=null;e._position=new A;e._rotation=new ea;return e}K(d,g);var b=d.prototype;b.prepare=function(){var a=this;return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then(function(c){a._bitmap=c;return{image:a._bitmap,widthInMeters:a._width}})};b.getPosition=
function(){this._pose&&this._position.copy(this._pose.transform.position);return this._position};N(d,[{key:"image",get:function(){return this._image}},{key:"width",get:function(){return this._width},set:function(a){this._width=a}},{key:"trackable",get:function(){return this._trackable}},{key:"tracking",get:function(){return this._tracking}},{key:"emulated",get:function(){return this._emulated}}]);return d}(ba),xl=function(g){function d(a){var c=g.call(this)||this;c._manager=a;c._supported=!!window.XRImageTrackingResult;
c._available=!1;c._images=[];c._supported&&(c._manager.on("start",c._onSessionStart,F(c)),c._manager.on("end",c._onSessionEnd,F(c)));return c}K(d,g);var b=d.prototype;b.add=function(a,c){if(!this._supported||this._manager.active)return null;a=new wl(a,c);this._images.push(a);return a};b.remove=function(a){if(!this._manager.active){var c=this._images.indexOf(a);-1!==c&&(a.destroy(),this._images.splice(c,1))}};b._onSessionStart=function(){var a=this;this._manager.session.getTrackedImageScores().then(function(c){a._available=
!0;for(var e=0;e<c.length;e++)a._images[e]._trackable="trackable"===c[e]}).catch(function(c){a._available=!1;a.fire("error",c)})};b._onSessionEnd=function(){this._available=!1;for(var a=0;a<this._images.length;a++)this._images[a]._pose=null,this._images[a]._measuredWidth=0,this._images[a]._tracking&&(this._images[a]._tracking=!1,this._images[a].fire("untracked"))};b.prepareImages=function(a){this._images.length?Promise.all(this._images.map(function(c){return c.prepare()})).then(function(c){a(null,
c)}).catch(function(c){a(c,null)}):a(null,null)};b.update=function(a){if(this._available){var c=a.getImageTrackingResults(),e={},f;for(f=0;f<c.length;f++){e[c[f].index]=c[f];var h=this._images[c[f].index];h._emulated="emulated"===c[f].trackingState;h._measuredWidth=c[f].measuredWidthInMeters;h._dirtyTransform=!0;h._pose=a.getPose(c[f].imageSpace,this._manager._referenceSpace)}for(f=0;f<this._images.length;f++)this._images[f]._tracking&&!e[f]?(this._images[f]._tracking=!1,this._images[f].fire("untracked")):
!this._images[f]._tracking&&e[f]&&(this._images[f]._tracking=!0,this._images[f].fire("tracked"))}};N(d,[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._available}},{key:"images",get:function(){return this._images}}]);return d}(ba),yl=function(){function g(d){this._manager=d;this._supported=!!window.XRDOMOverlayState;this._root=null}N(g,[{key:"supported",get:function(){return this._supported}},{key:"available",get:function(){return this._supported&&
this._manager.active&&null!==this._manager._session.domOverlayState}},{key:"state",get:function(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}},{key:"root",set:function(d){this._supported&&!this._manager.active&&(this._root=d)},get:function(){return this._root}}]);return g}(),zl=function(g){function d(a){var c=g.call(this)||this;c._manager=a;c._depthInfo=null;c._available=!1;c._matrixDirty=!1;c._matrix=new M;
c._emptyBuffer=new Uint8Array(32);c._depthBuffer=null;c._texture=new X(c._manager.app.graphicsDevice,{format:2,mipmaps:!1,addressU:1,addressV:1,minFilter:1,magFilter:1});c._manager.on("end",c._onSessionEnd,F(c));return c}K(d,g);var b=d.prototype;b._onSessionEnd=function(){this._depthInfo=null;this._available&&(this._available=!1,this.fire("unavailable"));this._depthBuffer=null;this._texture._width=4;this._texture._height=4;this._texture._levels[0]=this._emptyBuffer;this._texture.upload()};b._updateTexture=
function(){if(this._depthInfo){var a=!1;if(this._depthInfo.width!==this._texture.width||this._depthInfo.height!==this._texture.height)this._texture._width=this._depthInfo.width,this._texture._height=this._depthInfo.height,a=this._matrixDirty=!0;var c=this._depthInfo.data;this._depthBuffer=new Uint8Array(c.buffer,c.byteOffset,c.byteLength);this._texture._levels[0]=this._depthBuffer;this._texture.upload();a&&this.fire("resize",this._depthInfo.width,this._depthInfo.height)}else this._depthBuffer&&(this._depthBuffer=
null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload())};b.update=function(a,c){c?(this._depthInfo||(this._matrixDirty=!0),this._depthInfo=a.getDepthInformation(c)):(this._depthInfo&&(this._matrixDirty=!0),this._depthInfo=null);this._updateTexture();this._matrixDirty&&(this._matrixDirty=!1,this._depthInfo?this._matrix.data.set(this._depthInfo.normTextureFromNormView.matrix):this._matrix.setIdentity());this._depthInfo&&!this._available?
(this._available=!0,this.fire("available")):!this._depthInfo&&this._available&&(this._available=!1,this.fire("unavailable"))};b.getDepth=function(a,c){return this._depthInfo?this._depthInfo.getDepth(a,c):null};N(d,[{key:"supported",get:function(){return!!window.XRDepthInformation}},{key:"available",get:function(){return this._available}},{key:"width",get:function(){return this._depthInfo&&this._depthInfo.width||0}},{key:"height",get:function(){return this._depthInfo&&this._depthInfo.height||0}},{key:"texture",
get:function(){return this._texture}},{key:"uvMatrix",get:function(){return this._matrix}}]);return d}(ba),Al=function(g){function d(a){var c=g.call(this)||this;var e=F(c);c.app=a;c._supported=!!navigator.xr;c._available={};c._available.inline=!1;c._available["immersive-vr"]=!1;c._available["immersive-ar"]=!1;c._type=null;c._spaceType=null;c._session=null;c._baseLayer=null;c._referenceSpace=null;c.depthSensing=new zl(F(c));c.domOverlay=new yl(F(c));c.hitTest=new ml(F(c));c.imageTracking=new xl(F(c));
c.input=new sl(F(c));c.lightEstimation=new vl(F(c));c._camera=null;c.views=[];c.viewsPool=[];c._localPosition=new A;c._localRotation=new ea;c._depthNear=.1;c._depthFar=1E3;c._width=0;c._height=0;c._supported&&(navigator.xr.addEventListener("devicechange",function(){e._deviceAvailabilityCheck()}),c._deviceAvailabilityCheck());return c}K(d,g);var b=d.prototype;b.start=function(a,c,e,f){var h=this,k=f;"object"===typeof f&&(k=f.callback);if(this._available[c])if(this._session)k&&k(Error("XR session is already started"));
else{this._camera=a;this._camera.camera.xr=this;this._type=c;this._spaceType=e;this._setClipPlanes(a.nearClip,a.farClip);var m={requiredFeatures:[e],optionalFeatures:[]};"immersive-ar"===c?(m.optionalFeatures.push("light-estimation"),m.optionalFeatures.push("hit-test"),m.optionalFeatures.push("depth-sensing"),f&&f.imageTracking&&m.optionalFeatures.push("image-tracking"),this.domOverlay.root&&(m.optionalFeatures.push("dom-overlay"),m.domOverlay={root:this.domOverlay.root})):"immersive-vr"===c&&m.optionalFeatures.push("hand-tracking");
f&&f.optionalFeatures&&(m.optionalFeatures=m.optionalFeatures.concat(f.optionalFeatures));this.imageTracking.images.length?this.imageTracking.prepareImages(function(n,p){n?(k&&k(n),h.fire("error",n)):(null!==p&&(m.trackedImages=p),h._onStartOptionsReady(c,e,m,k))}):h._onStartOptionsReady(c,e,m,k)}else k&&k(Error("XR is not available"))};b._onStartOptionsReady=function(a,c,e,f){var h=this;navigator.xr.requestSession(a,e).then(function(k){h._onSessionStart(k,c,f)}).catch(function(k){h._camera.camera.xr=
null;h._camera=null;h._type=null;h._spaceType=null;f&&f(k);h.fire("error",k)})};b.end=function(a){if(this._session){if(a)this.once("end",a);this._session.end()}else a&&a(Error("XR Session is not initialized"))};b.isAvailable=function(a){return this._available[a]};b._deviceAvailabilityCheck=function(){for(var a in this._available)this._sessionSupportCheck(a)};b._sessionSupportCheck=function(a){var c=this;navigator.xr.isSessionSupported(a).then(function(e){c._available[a]!==e&&(c._available[a]=e,c.fire("available",
a,e),c.fire("available:"+a,e))}).catch(function(e){c.fire("error",e)})};b._onSessionStart=function(a,c,e){var f=this,h=!1;this._session=a;var k=function(){f.fire("visibility:change",a.visibilityState)},m=function(){f._setClipPlanes(f._camera.nearClip,f._camera.farClip)};a.addEventListener("end",function p(){f._session=null;f._referenceSpace=null;f.views=[];f._width=0;f._height=0;f._type=null;f._spaceType=null;f._camera&&(f._camera.off("set_nearClip",m),f._camera.off("set_farClip",m),f._camera.camera.xr=
null,f._camera=null);a.removeEventListener("end",p);a.removeEventListener("visibilitychange",k);h||f.fire("end");f.app.tick()});a.addEventListener("visibilitychange",k);this._camera.on("set_nearClip",m);this._camera.on("set_farClip",m);this._baseLayer=new XRWebGLLayer(a,this.app.graphicsDevice.gl);a.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar});a.requestReferenceSpace(c).then(function(p){f._referenceSpace=p;f.app.tick();e&&e(null);f.fire("start")}).catch(function(p){h=
!0;a.end();e&&e(p);f.fire("error",p)})};b._setClipPlanes=function(a,c){if(this._depthNear!==a||this._depthFar!==c)this._depthNear=a,this._depthFar=c,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar})};b.update=function(a){if(this._session){var c,e=a.session.renderState.baseLayer.framebufferWidth;var f=a.session.renderState.baseLayer.framebufferHeight;if(this._width!==e||this._height!==f)this._width=e,this._height=f,this.app.graphicsDevice.setResolution(e,
f);var h=(e=a.getViewerPose(this._referenceSpace))?e.views.length:0;if(h>this.views.length)for(f=0;f<=h-this.views.length;f++)(c=this.viewsPool.pop())||(c={viewport:new Z,projMat:new M,viewMat:new M,viewOffMat:new M,viewInvMat:new M,viewInvOffMat:new M,projViewOffMat:new M,viewMat3:new lb,position:new Float32Array(3),rotation:new ea}),this.views.push(c);else if(h<=this.views.length)for(f=0;f<this.views.length-h;f++)this.viewsPool.push(this.views.pop());if(e){f=e.transform.position;c=e.transform.orientation;
this._localPosition.set(f.x,f.y,f.z);this._localRotation.set(c.x,c.y,c.z,c.w);var k=a.session.renderState.baseLayer;for(f=0;f<e.views.length;f++){h=e.views[f];c=this.views[f];var m=k.getViewport(h);c.viewport.x=m.x;c.viewport.y=m.y;c.viewport.z=m.width;c.viewport.w=m.height;c.projMat.set(h.projectionMatrix);c.viewMat.set(h.transform.inverse.matrix);c.viewInvMat.set(h.transform.matrix)}}this._camera.camera._node.setLocalPosition(this._localPosition);this._camera.camera._node.setLocalRotation(this._localRotation);
this.input.update(a);"immersive-ar"===this._type&&(this.hitTest.supported&&this.hitTest.update(a),this.lightEstimation.supported&&this.lightEstimation.update(a),this.depthSensing.supported&&this.depthSensing.update(a,e&&e.views[0]),this.imageTracking.supported&&this.imageTracking.update(a));this.fire("update",a)}};N(d,[{key:"supported",get:function(){return this._supported}},{key:"active",get:function(){return!!this._session}},{key:"type",get:function(){return this._type}},{key:"spaceType",get:function(){return this._spaceType}},
{key:"session",get:function(){return this._session}},{key:"visibilityState",get:function(){return this._session?this._session.visibilityState:null}},{key:"camera",get:function(){return this._camera?this._camera.entity:null}}]);return d}(ba),ca=function(g){function d(a,c){var e=g.call(this)||this;e.system=a;e.entity=c;e.system.schema&&!e._accessorsBuilt&&e.buildAccessors(e.system.schema);e.on("set",function(f,h,k){this.fire("set_"+f,f,h,k)});e.on("set_enabled",e.onSetEnabled,F(e));return e}K(d,g);
d._buildAccessors=function(a,c){c.forEach(function(e){var f="object"===typeof e?e.name:e;Object.defineProperty(a,f,{get:function(){return this.data[f]},set:function(h){var k=this.data,m=k[f];k[f]=h;this.fire("set",f,m,h)},configurable:!0})});a._accessorsBuilt=!0};var b=d.prototype;b.buildAccessors=function(a){d._buildAccessors(this,a)};b.onSetEnabled=function(a,c,e){if(c!==e&&this.entity.enabled)if(e)this.onEnable();else this.onDisable()};b.onEnable=function(){};b.onDisable=function(){};b.onPostStateChange=
function(){};N(d,[{key:"data",get:function(){var a=this.system.store[this.entity.getGuid()];return a?a.data:null}}]);return d}(ba),O=function(g){function d(a){var c=g.call(this)||this;c.app=a;c.store={};c.schema=[];return c}K(d,g);d._helper=function(a,c){for(var e=0,f=a.length;e<f;e++)a[e].f.call(a[e].s,c)};d.initialize=function(a){this._helper(this._init,a)};d.postInitialize=function(a){this._helper(this._postInit,a);this.fire("postinitialize",a)};d.update=function(a,c){this._helper(c?this._toolsUpdate:
this._update,a)};d.animationUpdate=function(a,c){this._helper(this._animationUpdate,a)};d.fixedUpdate=function(a,c){this._helper(this._fixedUpdate,a)};d.postUpdate=function(a,c){this._helper(this._postUpdate,a)};d.bind=function(a,c,e){switch(a){case "initialize":this._init.push({f:c,s:e});break;case "postInitialize":this._postInit.push({f:c,s:e});break;case "update":this._update.push({f:c,s:e});break;case "animationUpdate":this._animationUpdate.push({f:c,s:e});break;case "postUpdate":this._postUpdate.push({f:c,
s:e});break;case "fixedUpdate":this._fixedUpdate.push({f:c,s:e});break;case "toolsUpdate":this._toolsUpdate.push({f:c,s:e});break;default:console.error("Component System does not support event",a)}};d._erase=function(a,c,e){for(var f=0;f<a.length;f++)a[f].f===c&&a[f].s===e&&a.splice(f--,1)};d.unbind=function(a,c,e){switch(a){case "initialize":this._erase(this._init,c,e);break;case "postInitialize":this._erase(this._postInit,c,e);break;case "update":this._erase(this._update,c,e);break;case "animationUpdate":this._erase(this._animationUpdate,
c,e);break;case "postUpdate":this._erase(this._postUpdate,c,e);break;case "fixedUpdate":this._erase(this._fixedUpdate,c,e);break;case "toolsUpdate":this._erase(this._toolsUpdate,c,e);break;default:console.error("Component System does not support event",a)}};var b=d.prototype;b.addComponent=function(a,c){var e=new this.ComponentType(this,a),f=new this.DataType;c=c||{};this.store[a.getGuid()]={entity:a,data:f};a[this.id]=e;a.c[this.id]=e;this.initializeComponentData(e,c,[]);this.fire("add",a,e);return e};
b.removeComponent=function(a){var c=this.store[a.getGuid()];this.fire("beforeremove",a,a.c[this.id]);delete this.store[a.getGuid()];delete a[this.id];delete a.c[this.id];this.fire("remove",a,c.data)};b.cloneComponent=function(a,c){a=this.store[a.getGuid()];return this.addComponent(c,a.data)};b.initializeComponentData=function(a,c,e){void 0===c&&(c={});for(var f,h,k,m=0,n=e.length;m<n;m++)f=e[m],"object"===typeof f?(h=f.name,f=f.type):(h=f,f=void 0),k=c[h],void 0!==k?(void 0!==f&&(k=Ln(k,f)),a[h]=
k):a[h]=a.data[h];if(a.enabled&&a.entity.enabled)a.onEnable()};b.getPropertiesOfType=function(a){var c=[];(this.schema||[]).forEach(function(e){e&&"object"===typeof e&&e.type===a&&c.push(e)});return c};b.destroy=function(){this.off()};return d}(ba);O._init=[];O._postInit=[];O._toolsUpdate=[];O._update=[];O._animationUpdate=[];O._fixedUpdate=[];O._postUpdate=[];Ud.attach(O);O.destroy=function(){O.off("initialize");O.off("postInitialize");O.off("toolsUpdate");O.off("update");O.off("animationUpdate");
O.off("fixedUpdate");O.off("postUpdate");O._init=[];O._postInit=[];O._toolsUpdate=[];O._update=[];O._animationUpdate=[];O._fixedUpdate=[];O._postUpdate=[]};var np=function(){function g(){this._left=Infinity;this._right=-Infinity;this._t=this._p1=this._p0=this._recip=this._len=0;this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}var d=g.prototype;d.update=function(b,a){if(b<this._left||b>=this._right){var c=a.length;c?b<a[0]?(this._left=-Infinity,this._right=a[0],this._p0=this._p1=this._recip=this._len=
0):b>=a[c-1]?(this._left=a[c-1],this._right=Infinity,this._recip=this._len=0,this._p0=this._p1=c-1):(c=this._findKey(b,a),this._left=a[c],this._right=a[c+1],this._len=this._right-this._left,a=1/this._len,this._recip=isFinite(a)?a:0,this._p0=c,this._p1=c+1):(this._left=-Infinity,this._right=Infinity,this._p0=this._p1=this._recip=this._len=0)}this._t=0===this._recip?0:(b-this._left)*this._recip;this._hermite.valid=!1};d._findKey=function(b,a){for(var c=0;b>=a[c+1];)c++;return c};d.eval=function(b,a,
c){var e=c._data;c=c._components;var f=this._p0*c,h;if(0===a)for(h=0;h<c;++h)b[h]=e[f+h];else{var k=this._t,m=this._p1*c;switch(a){case 1:for(h=0;h<c;++h)b[h]=R.lerp(e[f+h],e[m+h],k);break;case 2:a=this._hermite;a.valid||(h=k*k,f=k+k,m=1-k,m*=m,a.valid=!0,a.p0=(1+f)*m,a.m0=k*m,a.p1=h*(3-f),a.m1=h*(k-1));k=(3*this._p0+1)*c;f=(3*this._p0+2)*c;m=(3*this._p1+1)*c;var n=3*this._p1*c;for(h=0;h<c;++h)b[h]=a.p0*e[k+h]+a.m0*e[f+h]*this._len+a.p1*e[m+h]+a.m1*e[n+h]*this._len}}};return g}(),Bl=function(g){this._name=
g.name+"Snapshot";this._time=-1;this._cache=[];this._results=[];var d;for(d=0;d<g._inputs.length;++d)this._cache[d]=new np;var b=g._curves;g=g._outputs;for(d=0;d<b.length;++d){for(var a=g[b[d]._output],c=[],e=0;e<a._components;++e)c[e]=0;this._results[d]=c}},Hh=function(){function g(b,a,c,e,f){this._name=b.name;this._track=b;this._snapshot=new Bl(b);this._playing=e;this._time=a;this._speed=c;this._loop=f;this._blendWeight=1;this._blendOrder=0}var d=g.prototype;d._update=function(b){if(this._playing){var a=
this._time,c=this._track.duration,e=this._speed,f=this._loop;a+=e*b;0<=e?a>c&&(f?a=a%c||0:(a=this._track.duration,this.pause())):0>a&&(f?a=c+(a%c||0):(a=0,this.pause()));this._time=a}this._time!=this._snapshot._time&&this._track.eval(this._time,this._snapshot)};d.play=function(){this._playing=!0;this._time=0};d.stop=function(){this._playing=!1;this._time=0};d.pause=function(){this._playing=!1};d.resume=function(){this._playing=!0};d.reset=function(){this._time=0};N(g,[{key:"name",get:function(){return this._name},
set:function(b){this._name=b}},{key:"track",get:function(){return this._track}},{key:"snapshot",get:function(){return this._snapshot}},{key:"time",get:function(){return this._time},set:function(b){this._time=b}},{key:"speed",get:function(){return this._speed},set:function(b){this._speed=b}},{key:"loop",get:function(){return this._loop},set:function(b){this._loop=b}},{key:"blendWeight",get:function(){return this._blendWeight},set:function(b){this._blendWeight=b}},{key:"blendOrder",get:function(){return this._blendOrder},
set:function(b){this._blendOrder=b}}]);return g}(),Ih=function(){function g(b){this._binder=b;this._clips=[];this._inputs=[];this._outputs=[];this._targets={}}g._dot=function(b,a){for(var c=b.length,e=0,f=0;f<c;++f)e+=b[f]*a[f];return e};g._normalize=function(b){var a=g._dot(b,b);if(0<a){a=1/Math.sqrt(a);for(var c=b.length,e=0;e<c;++e)b[e]*=a}};g._set=function(b,a,c){var e=b.length;if("quaternion"===c){var f=g._dot(a,a);0<f&&(f=1/Math.sqrt(f));for(c=0;c<e;++c)b[c]=a[c]*f}else for(c=0;c<e;++c)b[c]=
a[c]};g._blendVec=function(b,a,c){for(var e=1-c,f=b.length,h=0;h<f;++h)b[h]=b[h]*e+a[h]*c};g._blendQuat=function(b,a,c){var e=b.length,f=1-c;0>g._dot(b,a)&&(c=-c);for(var h=0;h<e;++h)b[h]=b[h]*f+a[h]*c;g._normalize(b)};g._blend=function(b,a,c,e){"quaternion"===e?g._blendQuat(b,a,c):g._blendVec(b,a,c)};g._stableSort=function(b,a){for(var c=b.length,e=0;e<c-1;++e)for(var f=e+1;f<c;++f)if(a(b[f],b[e])){var h=b[e];b[e]=b[f];b[f]=h}};var d=g.prototype;d.addClip=function(b){for(var a=this._targets,c=b.track.curves,
e=b.snapshot,f=[],h=[],k=0;k<c.length;++k)for(var m=c[k].paths,n=0;n<m.length;++n){var p=m[n],t=a[p];if(!t){var r=this._binder.resolve(p);if(r){t={target:r,value:[],curves:0,blendCounter:0};for(r=0;r<t.target.components;++r)t.value.push(0);a[p]=t}}t&&(t.curves++,f.push(e._results[k]),h.push(t))}this._clips.push(b);this._inputs.push(f);this._outputs.push(h)};d.removeClip=function(b){for(var a=this._targets,c=this._clips,e=c[b].track.curves,f=0;f<e.length;++f)for(var h=e[f].paths,k=0;k<h.length;++k){var m=
h[k],n=a[m];n&&(n.curves--,0===n.curves&&(this._binder.unresolve(m),delete a[m]))}c.splice(b,1);this._inputs.splice(b,1);this._outputs.splice(b,1)};d.removeClips=function(){for(;0<this._clips.length;)this.removeClip(0)};d.findClip=function(b){for(var a=this._clips,c=0;c<a.length;++c){var e=a[c];if(e.name===b)return e}return null};d.update=function(b){var a=this._clips,c=a.map(function(u,v){return v});g._stableSort(c,function(u,v){return a[u].blendOrder<a[v].blendOrder});var e;for(e=0;e<a.length;++e){var f=
c[e];var h=a[f];var k=this._inputs[f];f=this._outputs[f];var m=h.blendWeight;0<m&&h._update(b);if(1<=m)for(h=0;h<k.length;++h){var n=k[h];var p=f[h];var t=p.value;g._set(t,n,p.target.type);p.blendCounter++}else if(0<m)for(h=0;h<k.length;++h)n=k[h],p=f[h],t=p.value,0===p.blendCounter?g._set(t,n,p.target.type):g._blend(t,n,m,p.target.type),p.blendCounter++}c=this._targets;for(var r in c)c.hasOwnProperty(r)&&(e=c[r],e.target.func(e.value),e.blendCounter=0);this._binder.update(b)};N(g,[{key:"clips",get:function(){return this._clips}}]);
return g}(),mc=function(){function g(d,b,a){this._func=d;this._type=b;this._components=a}N(g,[{key:"func",get:function(){return this._func}},{key:"type",get:function(){return this._type}},{key:"components",get:function(){return this._components}}]);return g}(),Jh=function(){function g(b){this.propertyLocator=new sh;if(b){var a={};(function h(f){a[f.name]={node:f,count:0};for(var k=0;k<f.children.length;++k)h(f.children[k])})(b);var c=function(f){for(;f&&!(f instanceof Ba);)f=f.parent;if(f)if(f.render)var h=
f.render.meshInstances;else f.model&&(h=f.model.meshInstances);return h};this.nodes=a;this.activeNodes=[];this.handlers={localPosition:function(f){var h=f.localPosition;return new mc(function(k){h.set.apply(h,k)},"vector",3)},localRotation:function(f){var h=f.localRotation;return new mc(function(k){h.set.apply(h,k)},"quaternion",4)},localScale:function(f){var h=f.localScale;return new mc(function(k){h.set.apply(h,k)},"vector",3)},weights:function(f){var h=c(f);if(h){for(var k,m=0;m<h.length;++m)if(h[m].node.name===
f.name&&h[m].morphInstance){k=h[m].morphInstance;break}if(k)return new mc(function(n){for(var p=0;p<n.length;++p)k.setWeight(p,n[p])},"vector",k.morph._targets.length)}return null},materialTexture:function(f,h){var k=c(f);if(k){for(var m,n=0;n<k.length;++n)if(k[n].node.name===f.name){m=k[n];break}if(m)return f=function(p){(p=this.animComponent.system.app.assets.get(p[0]))&&p.resource&&"texture"===p.type&&(m.material[h]=p.resource,m.material.update())}.bind(this),new mc(f,"vector",1)}return null}.bind(this)}}}
var d=g.prototype;d.resolve=function(b){var a=this.propertyLocator.decode(b);b=this.nodes[a[0][0]||""];if(!b)return null;a=this.handlers[a[2][0]];if(!a)return null;a=a(b.node);if(!a)return null;0===b.count&&this.activeNodes.push(b.node);b.count++;return a};d.unresolve=function(b){b=this.propertyLocator.decode(b);if("graph"===b[1]){var a=this.nodes[b[0][0]];a.count--;if(0===a.count){b=this.activeNodes;a=b.indexOf(a.node);var c=b.length;a<c-1&&(b[a]=b[c-1]);b.pop()}}};d.update=function(b){b=this.activeNodes;
for(var a=0;a<b.length;++a)b[a]._dirtifyLocal()};return g}(),op=function(){function g(){this._written=!1;this._name="";this._keyFrames=[];this._quat=new ea;this._pos=new A;this._scale=new A;this._targetNode=null}var d=g.prototype;d.getTarget=function(){return this._targetNode};d.setTarget=function(b){this._targetNode=b};return g}(),rb=function(){function g(b){function a(e){var f=new op;f._name=e.name;c._interpolatedKeys.push(f);c._interpolatedKeyDict[e.name]=f;for(f=c._currKeyIndices[e.name]=0;f<
e._children.length;f++)a(e._children[f])}this._animation=null;this._time=0;this.looping=!0;this._interpolatedKeys=[];this._interpolatedKeyDict={};this._currKeyIndices={};this.graph=null;var c=this;a(b)}var d=g.prototype;d.addTime=function(b){if(null!==this._animation){var a=this._animation._nodes;var c=this._animation.duration;if(this._time!==c||this.looping){this._time+=b;if(this._time>c)for(this._time=this.looping?0:c,c=0;c<a.length;c++){var e=a[c];var f=e._name;this._currKeyIndices[f]=0}else if(0>
this._time)for(this._time=this.looping?c:0,c=0;c<a.length;c++)e=a[c],f=e._name,this._currKeyIndices[f]=e._keys.length-2;b=0<=b?1:-1;for(c=0;c<a.length;c++){e=a[c];f=e._name;e=e._keys;var h=this._interpolatedKeyDict[f];if(void 0!==h){var k=!1;if(1!==e.length)for(var m=this._currKeyIndices[f];m<e.length-1&&0<=m;m+=b){var n=e[m];var p=e[m+1];if(n.time<=this._time&&p.time>=this._time){k=(this._time-n.time)/(p.time-n.time);h._pos.lerp(n.position,p.position,k);h._quat.slerp(n.rotation,p.rotation,k);h._scale.lerp(n.scale,
p.scale,k);h._written=!0;this._currKeyIndices[f]=m;k=!0;break}}if(1===e.length||!k&&0===this._time&&this.looping)h._pos.copy(e[0].position),h._quat.copy(e[0].rotation),h._scale.copy(e[0].scale),h._written=!0}}}}};d.blend=function(b,a,c){for(var e=this._interpolatedKeys.length,f=0;f<e;f++){var h=b._interpolatedKeys[f],k=a._interpolatedKeys[f],m=this._interpolatedKeys[f];h._written&&k._written?(m._quat.slerp(h._quat,a._interpolatedKeys[f]._quat,c),m._pos.lerp(h._pos,a._interpolatedKeys[f]._pos,c),m._scale.lerp(h._scale,
k._scale,c),m._written=!0):h._written?(m._quat.copy(h._quat),m._pos.copy(h._pos),m._scale.copy(h._scale),m._written=!0):k._written&&(m._quat.copy(k._quat),m._pos.copy(k._pos),m._scale.copy(k._scale),m._written=!0)}};d.setGraph=function(b){var a;if(this.graph=b)for(a=0;a<this._interpolatedKeys.length;a++){var c=b.findByName(this._interpolatedKeys[a]._name);this._interpolatedKeys[a].setTarget(c)}else for(a=0;a<this._interpolatedKeys.length;a++)this._interpolatedKeys[a].setTarget(null)};d.updateGraph=
function(){if(this.graph)for(var b=0;b<this._interpolatedKeys.length;b++){var a=this._interpolatedKeys[b];if(a._written){var c=a.getTarget();c.localPosition.copy(a._pos);c.localRotation.copy(a._quat);c.localScale.copy(a._scale);c._dirtyLocal||c._dirtifyLocal();a._written=!1}}};N(g,[{key:"animation",get:function(){return this._animation},set:function(b){this._animation=b;this.currentTime=0}},{key:"currentTime",get:function(){return this._time},set:function(b){this._time=b;b=this._interpolatedKeys.length;
for(var a=0;a<b;a++)this._currKeyIndices[this._interpolatedKeys[a]._name]=0;this.addTime(0);this.updateGraph()}},{key:"numNodes",get:function(){return this._interpolatedKeys.length}}]);return g}(),Kh=function(g){function d(a,c){a=g.call(this,a,c)||this;a.animationsIndex={};a.on("set_animations",a.onSetAnimations,F(a));a.on("set_assets",a.onSetAssets,F(a));a.on("set_loop",a.onSetLoop,F(a));return a}K(d,g);var b=d.prototype;b.play=function(a,c){if(this.enabled&&this.entity.enabled){var e=this.data;
if(e.animations[a]){c=c||0;e.prevAnim=e.currAnim;e.currAnim=a;if(e.model){e.skeleton||e.animEvaluator||this._createAnimationController();a=e.animations[e.prevAnim];var f=e.animations[e.currAnim];e.blending=0<c&&e.prevAnim;e.blending&&(e.blend=0,e.blendSpeed=1/c);e.skeleton&&(e.blending?(e.fromSkel.animation=a,e.fromSkel.addTime(e.skeleton._time),e.toSkel.animation=f):e.skeleton.animation=f);if(e.animEvaluator){c=e.animEvaluator;if(e.blending)for(;1<c.clips.length;)c.removeClip(0);else e.animEvaluator.removeClips();
c=new Hh(e.animations[e.currAnim],0,1,!0,e.loop);c.name=e.currAnim;c.blendWeight=e.blending?0:1;c.reset();e.animEvaluator.addClip(c)}}e.playing=!0}}};b.getAnimation=function(a){return this.data.animations[a]};b.setModel=function(a){var c=this.data;a!==c.model&&(this._resetAnimationController(),c.model=a,c.animations&&c.currAnim&&c.animations[c.currAnim]&&this.play(c.currAnim))};b._resetAnimationController=function(){var a=this.data;a.skeleton=null;a.fromSkel=null;a.toSkel=null;a.animEvaluator=null};
b._createAnimationController=function(){var a=this.data,c=a.model,e=a.animations,f=!1,h=!1,k;for(k in e)e.hasOwnProperty(k)&&(e[k].constructor===ke?h=!0:f=!0);c=c.getGraph();f?(a.fromSkel=new rb(c),a.toSkel=new rb(c),a.skeleton=new rb(c),a.skeleton.looping=a.loop,a.skeleton.setGraph(c)):h&&(a.animEvaluator=new Ih(new Jh(c)))};b.loadAnimationAssets=function(a){if(a&&a.length){var c=this,e=this.system.app.assets,f,h=a.length,k=function(p){if(1<p.resources.length)for(var t=0;t<p.resources.length;t++)c.animations[p.resources[t].name]=
p.resources[t],c.animationsIndex[p.id]=p.resources[t].name;else c.animations[p.name]=p.resource,c.animationsIndex[p.id]=p.name;c.animations=c.animations},m=function(p){p.off("change",c.onAssetChanged,c);p.on("change",c.onAssetChanged,c);p.off("remove",c.onAssetRemoved,c);p.on("remove",c.onAssetRemoved,c);p.resource?k(p):(p.once("load",k,c),c.enabled&&c.entity.enabled&&e.load(p))};for(f=0;f<h;f++){var n=e.get(a[f]);if(n)m(n);else e.on("add:"+a[f],m)}}};b.onAssetChanged=function(a,c,e,f){if("resource"===
c||"resources"===c)if("resources"===c&&e&&0===e.length&&(e=null),e){if(1<e.length){if(f&&1<f.length)for(c=0;c<f.length;c++)delete this.animations[f[c].name];else delete this.animations[a.name];f=!1;for(c=0;c<e.length;c++)this.animations[e[c].name]=e[c],!f&&this.data.currAnim===e[c].name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(f=!0,this.play(e[c].name,0))}else{if(f&&1<f.length)for(c=0;c<f.length;c++)delete this.animations[f[c].name];this.animations[a.name]=e[0]||e;f=!1;this.data.currAnim===
a.name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(f=!0,this.play(a.name,0))}f||(this._stopCurrentAnimation(),this.onSetAnimations());this.animationsIndex[a.id]=a.name}else{if(1<f.length)for(c=0;c<f.length;c++)delete this.animations[f[c].name],this.data.currAnim===f[c].name&&this._stopCurrentAnimation();else delete this.animations[a.name],this.data.currAnim===a.name&&this._stopCurrentAnimation();delete this.animationsIndex[a.id]}};b.onAssetRemoved=function(a){a.off("remove",this.onAssetRemoved,
this);if(this.animations){if(1<a.resources.length)for(var c=0;c<a.resources.length;c++)delete this.animations[a.resources[c].name],this.data.currAnim===a.resources[c].name&&this._stopCurrentAnimation();else delete this.animations[a.name],this.data.currAnim===a.name&&this._stopCurrentAnimation();delete this.animationsIndex[a.id]}};b._stopCurrentAnimation=function(){var a=this.data;a.currAnim=null;a.playing=!1;a.skeleton&&(a.skeleton.currentTime=0,a.skeleton.animation=null);if(a.animEvaluator){for(var c=
0;c<a.animEvaluator.clips.length;++c)a.animEvaluator.clips[c].stop();a.animEvaluator.update(0);a.animEvaluator.removeClips()}};b.onSetAnimations=function(a,c,e){a=this.data;(c=this.entity.model)&&(c=c.model)&&c!==a.model&&this.setModel(c);if(!a.currAnim&&a.activate&&a.enabled&&this.entity.enabled)for(var f in a.animations){this.play(f,0);break}};b.onSetAssets=function(a,c,e){if(c&&c.length)for(a=0;a<c.length;a++)if(c[a]){var f=this.system.app.assets.get(c[a]);if(f){f.off("change",this.onAssetChanged,
this);f.off("remove",this.onAssetRemoved,this);var h=this.animationsIndex[f.id];this.data.currAnim===h&&this._stopCurrentAnimation();delete this.animations[h];delete this.animationsIndex[f.id]}}c=e.map(function(k){return k instanceof fa?k.id:k});this.loadAnimationAssets(c)};b.onSetLoop=function(a,c,e){a=this.data;a.skeleton&&(a.skeleton.looping=a.loop);if(a.animEvaluator)for(c=0;c<a.animEvaluator.clips.length;++c)a.animEvaluator.clips[c].loop=a.loop};b.onSetCurrentTime=function(a,c,e){a=this.data;
a.skeleton&&(c=a.skeleton,c.currentTime=e,c.addTime(0),c.updateGraph());if(a.animEvaluator)for(a=a.animEvaluator,c=0;c<a.clips.length;++c)a.clips[c].time=e};b.onEnable=function(){g.prototype.onEnable.call(this);var a=this.data,c=a.assets,e=this.system.app.assets;if(c)for(var f=0,h=c.length;f<h;f++){var k=c[f];k instanceof fa||(k=e.get(k));k&&!k.resource&&e.load(k)}if(a.activate&&!a.currAnim)for(var m in a.animations){this.play(m,0);break}};b.onBeforeRemove=function(){for(var a=0;a<this.assets.length;a++){var c=
this.assets[a];"number"===typeof c&&(c=this.system.app.assets.get(c));c&&(c.off("change",this.onAssetChanged,this),c.off("remove",this.onAssetRemoved,this))}a=this.data;delete a.animation;delete a.skeleton;delete a.fromSkel;delete a.toSkel;delete a.animEvaluator};N(d,[{key:"currentTime",get:function(){var a=this.data;return a.skeleton?this.data.skeleton._time:a.animEvaluator&&(a=a.animEvaluator.clips,0<a.length)?a[a.length-1].time:0},set:function(a){var c=this.data;if(c.skeleton){var e=c.skeleton;
e.currentTime=a;e.addTime(0);e.updateGraph()}if(c.animEvaluator)for(c=c.animEvaluator,e=0;e<c.clips.length;++e)c.clips[e].time=a}},{key:"duration",get:function(){return this.data.animations[this.data.currAnim].duration}}]);return d}(ca),pp=function(){this.assets=[];this.speed=1;this.enabled=this.activate=this.loop=!0;this.animations={};this.currAnim=this.prevAnim=this.model=null;this.blending=!1;this.blendSpeed=this.blend=0;this.playing=!1;this.animEvaluator=this.toSkel=this.fromSkel=this.skeleton=
null},Cl="enabled assets speed loop activate animations skeleton model prevAnim currAnim fromSkel toSkel blending blendTimeRemaining playing".split(" "),Dl=function(g){function d(a){a=g.call(this,a)||this;a.id="animation";a.ComponentType=Kh;a.DataType=pp;a.schema=Cl;a.on("beforeremove",a.onBeforeRemove,F(a));a.on("update",a.onUpdate,F(a));O.bind("update",a.onUpdate,F(a));return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c,e){e=["activate","enabled","loop","speed","assets"];g.prototype.initializeComponentData.call(this,
a,c,e)};b.cloneComponent=function(a,c){var e;this.addComponent(c,{});c.animation.assets=a.animation.assets.slice();c.animation.data.speed=a.animation.speed;c.animation.data.loop=a.animation.loop;c.animation.data.activate=a.animation.activate;c.animation.data.enabled=a.animation.enabled;var f={},h=a.animation.animations;for(e in h)h.hasOwnProperty(e)&&(f[e]=h[e]);c.animation.animations=f;f={};a=a.animation.animationsIndex;for(e in a)a.hasOwnProperty(e)&&(f[e]=a[e]);c.animation.animationsIndex=f};b.onBeforeRemove=
function(a,c){c.onBeforeRemove()};b.onUpdate=function(a){var c=this.store,e;for(e in c)if(c.hasOwnProperty(e)){var f=c[e],h=f.data;if(h.enabled&&f.entity.enabled){h.blending&&(h.blend+=a*h.blendSpeed,1<=h.blend&&(h.blend=1));h.playing&&(f=h.skeleton,null!==f&&null!==h.model&&(h.blending?f.blend(h.fromSkel,h.toSkel,h.blend):(f.addTime(a*h.speed),0<h.speed&&f._time===f._animation.duration&&!h.loop?h.playing=!1:0>h.speed&&0===f._time&&!h.loop&&(h.playing=!1)),h.blending&&1===h.blend&&(f.animation=h.toSkel._animation),
f.updateGraph()));if(f=h.animEvaluator){for(var k=0;k<f.clips.length;++k){var m=f.clips[k];m.speed=h.speed;h.playing?m.resume():m.pause()}h.blending&&(f.clips[1].blendWeight=h.blend);f.update(a)}h.blending&&1===h.blend&&(h.blending=!1)}}};return d}(O);ca._buildAccessors(Kh.prototype,Cl);var Lh=new S,Rf=new A,pe=new Z,qe=new Q,re=new ea,qp=function(g){function d(a,c){c=g.call(this,c)||this;c.animComponent=a;return c}K(d,g);d._packFloat=function(a){return a[0]};d._packBoolean=function(a){return!!a[0]};
d._packVec2=function(a){Lh.x=a[0];Lh.y=a[1];return Lh};d._packVec3=function(a){Rf.x=a[0];Rf.y=a[1];Rf.z=a[2];return Rf};d._packVec4=function(a){pe.x=a[0];pe.y=a[1];pe.z=a[2];pe.w=a[3];return pe};d._packColor=function(a){qe.r=a[0];qe.g=a[1];qe.b=a[2];qe.a=a[3];return qe};d._packQuat=function(a){re.x=a[0];re.y=a[1];re.z=a[2];re.w=a[3];return re};var b=d.prototype;b.resolve=function(a){var c=this.propertyLocator.decode(a);a=c[0];var e=c[1];c=c[2];var f=this._getEntityFromHierarchy(a);if(!f)return null;
switch(e){case "entity":a=f;break;case "graph":if(!this.nodes||!this.nodes[a[0]])return null;a=this.nodes[a[0]].node;break;default:if(a=f.findComponent(e),!a)return null}return this._createAnimTargetForProperty(a,c)};b.update=function(a){if(a=this.activeNodes)for(var c=0;c<a.length;c++)a[c]._dirtifyLocal()};b._getEntityFromHierarchy=function(a){if(!this.animComponent.entity.name===a[0])return null;var c=this.animComponent.entity;return 1===a.length?c:c._parent.findByPath(a.join("/"))};b._resolvePath=
function(a,c,e){e=c.length-(e?0:1);for(var f=0;f<e;f++)a=a[c[f]];return a};b._setter=function(a,c,e){var f=this._resolvePath(a,c),h=c[c.length-1],k="set"+h.substring(0,1).toUpperCase()+h.substring(1);if(f[k]){var m=f[k].bind(f);return function(r){m(e(r))}}var n=f[h];if("object"===typeof n&&n.hasOwnProperty("copy"))return function(r){n.copy(e(r))};if(-1!==[S,A,Z,Q,ea].indexOf(f.constructor)&&1<c.length){var p=2<c.length?this._resolvePath(a,c.slice(0,-1)):a,t=c[c.length-2];return function(r){f[h]=e(r);
p[t]=f}}return function(r){f[h]=e(r)}};b._createAnimTargetForProperty=function(a,c){if(this.handlers&&"weights"===c[0])return this.handlers.weights(a);if(this.handlers&&"material"===c[0]&&2===c.length){var e=c[1];if(e.indexOf("Map")===e.length-3)return this.handlers.materialTexture(a,e)}e=this._resolvePath(a,c,!0);if("undefined"===typeof e)return null;if("number"===typeof e){var f=this._setter(a,c,d._packFloat);var h="vector";var k=1}else if("boolean"===typeof e)f=this._setter(a,c,d._packBoolean),
h="vector",k=1;else if("object"===typeof e)switch(e.constructor){case S:f=this._setter(a,c,d._packVec2);h="vector";k=2;break;case A:f=this._setter(a,c,d._packVec3);h="vector";k=3;break;case Z:f=this._setter(a,c,d._packVec4);h="vector";k=4;break;case Q:f=this._setter(a,c,d._packColor);h="vector";k=4;break;case ea:f=this._setter(a,c,d._packQuat);h="quaternion";k=4;break;default:return null}return-1!==c.indexOf("material")?new mc(function(m){f(m);a.material.update()},h,k):new mc(f,h,k)};return d}(Jh),
El=function(){function g(b,a,c){this._name=b;this._controller=a;this._component=c}var d=g.prototype;d.play=function(b){this._controller.play(b)};d.pause=function(){this._controller.pause()};d.reset=function(){this._controller.reset()};d.update=function(b){this._controller.update(b)};d.assignAnimation=function(b,a){a.constructor===ke&&(this._controller.assignAnimation(b,a),this._component.activate&&this._component.playable&&(this._component.playing=!0))};d.removeNodeAnimations=function(b){this._controller.removeNodeAnimations(b);
this._component.playing=!1};N(g,[{key:"name",get:function(){return this._name}},{key:"playing",get:function(){return this._controller.playing},set:function(b){this._controller.playing=b}},{key:"playable",get:function(){return this._controller.playable}},{key:"activeState",get:function(){return this._controller.activeStateName}},{key:"previousState",get:function(){return this._controller.previousStateName}},{key:"activeStateProgress",get:function(){return this._controller.activeStateProgress}},{key:"activeStateDuration",
get:function(){return this._controller.activeStateDuration}},{key:"activeStateCurrentTime",get:function(){return this._controller.activeStateCurrentTime},set:function(b){this._controller.activeStateCurrentTime=b}},{key:"transitioning",get:function(){return this._controller.transitioning}},{key:"transitionProgress",get:function(){return this.transitioning?this._controller.transitionProgress:null}},{key:"states",get:function(){return this._controller.states}}]);return g}(),Mh=function(){function g(d,
b,a,c,e){void 0===e&&(e=1);this._state=d;this._parent=b;this._name=a;this._point=Array.isArray(c)?new pc.Vec2(c):c;this._speed=e;this._weight=1;this._animTrack=null}N(g,[{key:"parent",get:function(){return this._parent}},{key:"name",get:function(){return this._name}},{key:"path",get:function(){return this._parent?this._parent.path+"."+this._name:this._name}},{key:"point",get:function(){return this._point}},{key:"weight",get:function(){return this._parent?this._parent.weight*this._weight:this._weight},
set:function(d){this._weight=d}},{key:"normalizedWeight",get:function(){var d=this._state.totalWeight;return 0===d?0:this.weight/d}},{key:"speed",get:function(){return this._speed}},{key:"animTrack",get:function(){return this._animTrack},set:function(d){this._animTrack=d}}]);return g}(),Nh=function(g){function d(a,c,e,f,h,k,m,n){c=g.call(this,a,c,e,f)||this;c._type=h;c._parameters=k;c._parameterValues=null;c._children=[];c._findParameter=n;for(h=0;h<m.length;h++)k=m[h],k.children?c._children.push(new d(a,
F(c),k.name,k.point,k.type,k.parameter?[k.parameter]:k.parameters,k.children,n)):c._children.push(new Mh(a,F(c),k.name,k.point,k.speed));return c}K(d,g);var b=d.prototype;b.getChild=function(a){for(var c=0;c<this._children.length;c++)if(this._children[c].name===a)return this._children[c]};b.calculateWeights=function(){var a,c;switch(this._type){case "1D":var e=this._findParameter(this._parameters[0]).value;if(this._parameterValues&&this._parameterValues[0]===e)break;this._parameterValues=[e];for(a=
this._children[0].weight=0;a<this._children.length-1;a++){var f=this._children[a];var h=this._children[a+1];if(Mn(e,f.point,h.point,!0)){var k=Math.abs(f.point-h.point);k=(k-Math.abs(f.point-e))/k;f.weight=k;h.weight=1-k}else h.weight=0}break;case "2D_CARTESIAN":a=this._parameters.map(function(t){return this._findParameter(t).value}.bind(this));if(this._parameterValues&&this._parameterValues.equals(a))break;this._parameterValues=a;f=new pc.Vec2(this._parameterValues);for(a=c=0;a<this._children.length;a++){h=
this._children[a].point.clone();k=Number.MAX_VALUE;for(e=0;e<this._children.length;e++)if(a!==e){var m=this._children[e].point.clone();var n=m.clone().sub(h);m=f.clone().sub(h);m=Re(1-m.clone().dot(n)/n.lengthSq(),0,1);m<k&&(k=m)}this._children[a].weight=k;c+=k}for(a=0;a<this._children.length;a++)this._children[a].weight=this._children[a]._weight/c;break;case "2D_DIRECTIONAL":a=this._parameters.map(function(t){return this._findParameter(t).value}.bind(this));if(this._parameterValues&&this._parameterValues.equals(a))break;
this._parameterValues=a;f=new pc.Vec2(this._parameterValues);for(a=c=0;a<this._children.length;a++){h=this._children[a].point.clone();k=Number.MAX_VALUE;for(e=0;e<this._children.length;e++)if(a!==e){m=this._children[e].point.clone();var p=cj(h,f);n=cj(h,m);n=new pc.Vec2((m.length()-h.length())/((m.length()+h.length())/2),2*n);m=new pc.Vec2((f.length()-h.length())/((m.length()+h.length())/2),2*p);m=Re(1-Math.abs(m.clone().dot(n)/n.lengthSq()),0,1);m<k&&(k=m)}this._children[a].weight=k;c+=k}for(a=0;a<
this._children.length;a++)this._children[a].weight=this._children[a]._weight/c;break;case "DIRECT":if(a=this._parameters.map(function(t){return this._findParameter(t).value}.bind(this)),this._parameterValues!==a){this._parameterValues=a;for(a=c=0;a<this._children.length;a++)c+=Re(this._parameterValues[a],0,Number.MAX_VALUE);for(a=0;a<this._children.length;a++)this._children[a].weight=Re(this._parameterValues[a],0,Number.MAX_VALUE)/c}}};b.getNodeCount=function(){for(var a=0,c=0;c<this._children.length;c++)this._children[c].constructor===
d?a+=this._children[c].getNodeCount():a++;return a};N(d,[{key:"parent",get:function(){return this._parent}},{key:"name",get:function(){return this._name}},{key:"point",get:function(){return this._point}},{key:"weight",get:function(){this.calculateWeights();return this._parent?this._parent.weight*this._weight:this._weight},set:function(a){this._weight=a}},{key:"speed",get:function(){return this._speed}}]);return d}(Mh),rp=function(){function g(b,a,c,e,f){this._controller=b;this._name=a;this._animations=
{};this._animationList=[];this._speed=c||1;this._loop=void 0===e?!0:e;b=this._controller.findParameter.bind(this._controller);this._blendTree=f?new Nh(this,null,a,1,f.type,f.parameter?[f.parameter]:f.parameters,f.children,b):new Mh(this,null,a,1,c)}var d=g.prototype;d._getNodeFromPath=function(b){for(var a=this._blendTree,c=1;c<b.length;c++)a=a.getChild(b[c]);return a};d.addAnimation=function(b,a){var c=this._animationList.findIndex(function(e){return e.path===b});0<=c?this._animationList[c].animTrack=
a:(c=this._getNodeFromPath(b),c.animTrack=a,this._animationList.push(c))};N(g,[{key:"name",get:function(){return this._name}},{key:"animations",get:function(){return this._animationList},set:function(b){this._animationList=b}},{key:"speed",get:function(){return this._speed}},{key:"loop",get:function(){return this._loop}},{key:"nodeCount",get:function(){return this._blendTree&&this._blendTree.constructor===Nh?this._blendTree.getNodeCount():1}},{key:"playable",get:function(){return"START"===this.name||
"END"===this.name||"ANY"===this.name||this.animations.length===this.nodeCount}},{key:"looping",get:function(){if(0<this.animations.length){var b=this._controller.animEvaluator.findClip(this.name+"."+this.animations[0].animTrack.name);if(b)return b.loop}return!1}},{key:"totalWeight",get:function(){var b=0,a;for(a=0;a<this.animations.length;a++)b+=this.animations[a].weight;return b}},{key:"timelineDuration",get:function(){var b=0,a;for(a=0;a<this.animations.length;a++){var c=this.animations[a];c.animTrack.duration>
b&&(b=c.animTrack.duration)}return b}}]);return g}(),Fl=function(){function g(d,b,a,c,e,f,h,k,m){void 0===m&&(m="NONE");this._controller=d;this._from=b;this._to=a;this._time=c;this._priority=e;this._conditions=f||[];this._exitTime=h||null;this._transitionOffset=k||null;this._interruptionSource=m}N(g,[{key:"from",get:function(){return this._from}},{key:"to",get:function(){return this._to}},{key:"time",get:function(){return this._time}},{key:"priority",get:function(){return this._priority}},{key:"conditions",
get:function(){return this._conditions}},{key:"exitTime",get:function(){return this._exitTime}},{key:"transitionOffset",get:function(){return this._transitionOffset}},{key:"interruptionSource",get:function(){return this._interruptionSource}},{key:"hasExitTime",get:function(){return!!this.exitTime}},{key:"hasConditionsMet",get:function(){var d=!0,b;for(b=0;b<this.conditions.length;b++){var a=this.conditions[b],c=this._controller.findParameter(a.parameterName);switch(a.predicate){case "GREATER_THAN":d=
d&&c.value>a.value;break;case "LESS_THAN":d=d&&c.value<a.value;break;case "GREATER_THAN_EQUAL_TO":d=d&&c.value>=a.value;break;case "LESS_THAN_EQUAL_TO":d=d&&c.value<=a.value;break;case "EQUAL_TO":d=d&&c.value===a.value;break;case "NOT_EQUAL_TO":d=d&&c.value!==a.value}if(!d)break}return d}}]);return g}(),Gl=function(){function g(b,a,c,e,f){this._animEvaluator=b;this._states={};this._stateNames=[];for(b=0;b<a.length;b++)this._states[a[b].name]=new rp(this,a[b].name,a[b].speed,a[b].loop,a[b].blendTree),
this._stateNames.push(a[b].name);this._transitions=c.map(function(h){return new Fl(this,h.from,h.to,h.time,h.priority,h.conditions,h.exitTime,h.transitionOffset,h.interruptionSource)}.bind(this));this._findTransitionsFromStateCache={};this._findTransitionsBetweenStatesCache={};this._parameters=e;this._previousStateName=null;this._activeStateName="START";this._playing=!1;this._activate=f;this._totalTransitionTime=this._currTransitionTime=1;this._isTransitioning=!1;this._transitionInterruptionSource=
"NONE";this._transitionPreviousStates=[];this._timeInStateBefore=this._timeInState=0}var d=g.prototype;d._findState=function(b){return this._states[b]};d._getActiveStateProgressForTime=function(b){if("START"===this.activeStateName||"END"===this.activeStateName||"ANY"===this.activeStateName)return 1;var a=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return a?b/a.track.duration:null};d._findTransitionsFromState=function(b){var a=this._findTransitionsFromStateCache[b];a||(a=this._transitions.filter(function(c){return c.from===
b}),a.sort(function(c,e){return c.priority<e.priority}),this._findTransitionsFromStateCache[b]=a);return a};d._findTransitionsBetweenStates=function(b,a){var c=this._findTransitionsBetweenStatesCache[b+"->"+a];c||(c=this._transitions.filter(function(e){return e.from===b&&e.to===a}),c.sort(function(e,f){return e.priority<f.priority}),this._findTransitionsBetweenStatesCache[b+"->"+a]=c);return c};d._findTransition=function(b,a){var c=[];if(b&&a)c.concat(this._findTransitionsBetweenStates(b,a));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case "PREV_STATE":c=
c.concat(this._findTransitionsFromState(this._previousStateName));c=c.concat(this._findTransitionsFromState("ANY"));break;case "NEXT_STATE":c=c.concat(this._findTransitionsFromState(this._activeStateName));c=c.concat(this._findTransitionsFromState("ANY"));break;case "PREV_STATE_NEXT_STATE":c=c.concat(this._findTransitionsFromState(this._previousStateName));c=c.concat(this._findTransitionsFromState(this._activeStateName));c=c.concat(this._findTransitionsFromState("ANY"));break;case "NEXT_STATE_PREV_STATE":c=
c.concat(this._findTransitionsFromState(this._activeStateName)),c=c.concat(this._findTransitionsFromState(this._previousStateName)),c=c.concat(this._findTransitionsFromState("ANY"))}else c=c.concat(this._findTransitionsFromState(this._activeStateName)),c=c.concat(this._findTransitionsFromState("ANY"));c=c.filter(function(e){if(e.to===this.activeStateName)return!1;if(e.hasExitTime){var f=this._getActiveStateProgressForTime(this._timeInStateBefore),h=this._getActiveStateProgressForTime(this._timeInState);
1>e.exitTime&&this.activeState.looping&&(f-=Math.floor(f),h-=Math.floor(h));if(!(e.exitTime>f&&e.exitTime<=h))return null}return e.hasConditionsMet}.bind(this));return 0<c.length?c[0]:null};d._updateStateFromTransition=function(b){var a,c;this.previousState=b.from;this.activeState=b.to;for(a=0;a<b.conditions.length;a++){var e=this.findParameter(b.conditions[a].parameterName);"TRIGGER"===e.type&&(e.value=!1)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]);this._transitionPreviousStates.push({name:this._previousStateName,
weight:1});var f=Math.min(this._currTransitionTime/this._totalTransitionTime,1);for(a=0;a<this._transitionPreviousStates.length;a++){this._transitionPreviousStates[a].weight=this._isTransitioning?a!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[a].weight*(1-f):f:1;var h=this._findState(this._transitionPreviousStates[a].name);for(c=0;c<h.animations.length;c++){var k=h.animations[c];e=this._animEvaluator.findClip(k.name+".previous."+a);e||(e=this._animEvaluator.findClip(k.name),
e.name=k.name+".previous."+a);a!==this._transitionPreviousStates.length-1&&e.pause()}}}this._isTransitioning=!0;this._totalTransitionTime=b.time;this._currTransitionTime=0;this._transitionInterruptionSource=b.interruptionSource;c=b.transitionOffset&&0<b.transitionOffset&&1>b.transitionOffset;h=this.activeState;for(a=0;a<h.animations.length;a++)(e=this._animEvaluator.findClip(h.animations[a].name))?e.reset():(e=Number.isFinite(h.animations[a].speed)?h.animations[a].speed:h.speed,e=new Hh(h.animations[a].animTrack,
0,e,!0,h.loop),e.name=h.animations[a].name,this._animEvaluator.addClip(e)),e.blendWeight=0<b.time?0:h.animations[a].normalizedWeight,e.play(),e.time=c?h.timelineDuration*b.transitionOffset:0<=h.speed?0:this.activeStateDuration;e=a=0;c&&(e=a=b=h.timelineDuration*b.transitionOffset);this._timeInState=a;this._timeInStateBefore=e};d._transitionToState=function(b){if(b!==this._activeStateName&&this._findState(b)){var a=this._findTransition(this._activeStateName,b);a||(this._animEvaluator.removeClips(),
a=new Fl(this,null,b,0,0));this._updateStateFromTransition(a)}};d.assignAnimation=function(b,a){b=b.split(".");var c=this._findState(b[0]);c&&(c.addAnimation(b,a),!this._playing&&this._activate&&this.playable&&this.play())};d.removeNodeAnimations=function(b){if(b=this._findState(b))b.animations=[]};d.play=function(b){b&&this._transitionToState(b);this._playing=!0};d.pause=function(){this._playing=!1};d.reset=function(){this._previousStateName=null;this._activeStateName="START";this._playing=!1;this._totalTransitionTime=
this._currTransitionTime=1;this._isTransitioning=!1;this._timeInStateBefore=this._timeInState=0;this._animEvaluator.removeClips()};d.update=function(b){if(this._playing){var a,c,e;this._timeInStateBefore=this._timeInState;this._timeInState+=b;(a=this._findTransition(this._activeStateName))&&this._updateStateFromTransition(a);if(this._isTransitioning)if(this._currTransitionTime+=b,this._currTransitionTime<=this._totalTransitionTime){var f=this._currTransitionTime/this._totalTransitionTime;for(a=0;a<
this._transitionPreviousStates.length;a++){var h=this._findState(this._transitionPreviousStates[a].name);var k=this._transitionPreviousStates[a].weight;for(c=0;c<h.animations.length;c++){var m=h.animations[c];if(e=this._animEvaluator.findClip(m.name+".previous."+a))e.blendWeight=(1-f)*m.normalizedWeight*k}}h=this.activeState;for(a=0;a<h.animations.length;a++)m=h.animations[a],this._animEvaluator.findClip(m.name).blendWeight=f*m.normalizedWeight}else{this._isTransitioning=!1;c=this.activeStateAnimations.length;
h=this._animEvaluator.clips.length;for(a=0;a<h-c;a++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[];h=this.activeState;for(a=0;a<h.animations.length;a++)if(m=h.animations[a],e=this._animEvaluator.findClip(m.name))e.blendWeight=m.normalizedWeight}else if(this.activeState._blendTree.constructor===Nh)for(h=this.activeState,a=0;a<h.animations.length;a++)if(m=h.animations[a],e=this._animEvaluator.findClip(m.name))e.blendWeight=m.normalizedWeight;this._animEvaluator.update(b)}};d.findParameter=
function(b){return this._parameters[b]};N(g,[{key:"animEvaluator",get:function(){return this._animEvaluator}},{key:"activeState",get:function(){return this._findState(this._activeStateName)},set:function(b){this._activeStateName=b}},{key:"activeStateName",get:function(){return this._activeStateName}},{key:"activeStateAnimations",get:function(){return this.activeState.animations}},{key:"previousState",get:function(){return this._findState(this._previousStateName)},set:function(b){this._previousStateName=
b}},{key:"previousStateName",get:function(){return this._previousStateName}},{key:"playable",get:function(){var b=!0,a;for(a=0;a<this._stateNames.length;a++)this._states[this._stateNames[a]].playable||(b=!1);return b}},{key:"playing",get:function(){return this._playing},set:function(b){this._playing=b}},{key:"activeStateProgress",get:function(){return this._getActiveStateProgressForTime(this._timeInState)}},{key:"activeStateDuration",get:function(){if("START"===this.activeStateName||"END"===this.activeStateName)return 0;
for(var b=0,a=0;a<this.activeStateAnimations.length;a++){var c=this._animEvaluator.findClip(this.activeStateAnimations[a].name);b=Math.max(b,c.track.duration)}return b}},{key:"activeStateCurrentTime",get:function(){return this._timeInState},set:function(b){this._timeInState=this._timeInStateBefore=b;for(var a=0;a<this.activeStateAnimations.length;a++){var c=this.animEvaluator.findClip(this.activeStateAnimations[a].name);c&&(c.time=b)}}},{key:"transitioning",get:function(){return this._isTransitioning}},
{key:"transitionProgress",get:function(){return this._currTransitionTime/this._totalTransitionTime}},{key:"states",get:function(){return this._stateNames}}]);return g}(),Oh=function(g){function d(a,c){return g.call(this,a,c)||this}K(d,g);var b=d.prototype;b.loadStateGraph=function(a){function c(n,p,t,r){var u=new qp(this,m);u=new Ih(u);p=new Gl(u,p,t,f.parameters,f.activate);f.layers.push(new El(n,p,this));f.layerIndices[n]=r}var e,f=this.data;f.stateGraph=a;f.parameters={};var h=Object.keys(a.parameters);
for(e=0;e<h.length;e++){var k=h[e];f.parameters[k]={type:a.parameters[k].type,value:a.parameters[k].value}}f.layers=[];var m;this.entity.model?(e=this.entity.model.model)&&(m=e.getGraph()):m=this.entity;for(e=0;e<a.layers.length;e++)h=a.layers[e],c.bind(this)(h.name,h.states,h.transitions,e);this.setupAnimationAssets()};b.setupAnimationAssets=function(){for(var a=0;a<this.data.layers.length;a++)for(var c=this.data.layers[a],e=c.name,f=0;f<c.states.length;f++){var h=c.states[f];"START"!==h&&"END"!==
h&&"ANY"!==h&&(h=e+":"+h,this.data.animationAssets[h]||(this.data.animationAssets[h]={asset:null}))}this.loadAnimationAssets()};b.loadAnimationAssets=function(){for(var a=0;a<this.data.layers.length;a++)for(var c=this.data.layers[a],e=0;e<c.states.length;e++){var f=c.states[e],h=this.data.animationAssets[c.name+":"+f];if(h&&h.asset){if(h=this.system.app.assets.get(h.asset))h.resource?this.assignAnimation(f,h.resource,c.name):(h.once("load",function(k,m){return function(n){this.assignAnimation(m,n.resource,
k)}.bind(this)}.call(this,c.name,f)),this.system.app.assets.load(h))}else this.removeNodeAnimations(f,c.name)}};b.removeStateGraph=function(){this.data.stateGraph=null;this.data.stateGraphAsset=null;this.data.animationAssets={};this.data.layers=[];this.data.layerIndices={};this.data.parameters={};this.data.playing=!1};b.resetStateGraph=function(){if(this.stateGraphAsset){var a=this.system.app.assets.get(this.stateGraphAsset).resource;this.loadStateGraph(a)}else this.removeStateGraph()};b.reset=function(){this.data.parameters=
Object.assign({},this.data.stateGraph.parameters);for(var a=0;a<this.data.layers.length;a++){var c=this.data.layers[a].playing;this.data.layers[a].reset();this.data.layers[a].playing=c}};b.findAnimationLayer=function(a){return this.data.layers[this.data.layerIndices[a]]||null};b.assignAnimation=function(a,c,e){this.data.stateGraph&&(e=e?this.findAnimationLayer(e):this.baseLayer)&&e.assignAnimation(a,c)};b.removeNodeAnimations=function(a,c){(c=c?this.findAnimationLayer(c):this.baseLayer)&&c.removeNodeAnimations(a)};
b.getParameterValue=function(a,c){if((a=this.data.parameters[a])&&a.type===c)return a.value};b.setParameterValue=function(a,c,e){(a=this.data.parameters[a])&&a.type===c&&(a.value=e)};b.getFloat=function(a){return this.getParameterValue(a,"FLOAT")};b.setFloat=function(a,c){this.setParameterValue(a,"FLOAT",c)};b.getInteger=function(a){return this.getParameterValue(a,"INTEGER")};b.setInteger=function(a,c){"number"===typeof c&&0===c%1&&this.setParameterValue(a,"INTEGER",c)};b.getBoolean=function(a){return this.getParameterValue(a,
"BOOLEAN")};b.setBoolean=function(a,c){this.setParameterValue(a,"BOOLEAN",!!c)};b.getTrigger=function(a){return this.getParameterValue(a,"TRIGGER")};b.setTrigger=function(a){this.setParameterValue(a,"TRIGGER",!0)};b.resetTrigger=function(a){this.setParameterValue(a,"TRIGGER",!1)};N(d,[{key:"stateGraphAsset",get:function(){return this.data.stateGraphAsset},set:function(a){if(null===a)this.removeStateGraph();else{if(a instanceof fa){var c=a.id;var e=this.system.app.assets.get(c);e||(this.system.app.assets.add(a),
e=this.system.app.assets.get(c))}else c=a,e=this.system.app.assets.get(c);e&&this.data.stateGraphAsset!==c&&(e.resource?(this.data.stateGraph=e.resource,this.loadStateGraph(this.data.stateGraph),e.on("change",function(f){this.data.stateGraph=new Lf(f._data);this.loadStateGraph(this.data.stateGraph)}.bind(this))):(e.once("load",function(f){this.data.stateGraph=f.resource;this.loadStateGraph(this.data.stateGraph)}.bind(this)),e.on("change",function(f){this.data.stateGraph=new Lf(f._data);this.loadStateGraph(this.data.stateGraph)}.bind(this)),
this.system.app.assets.load(e)),this.data.stateGraphAsset=c)}}},{key:"animationAssets",get:function(){return this.data.animationAssets},set:function(a){this.data.animationAssets=a;this.loadAnimationAssets()}},{key:"playable",get:function(){for(var a=0;a<this.data.layers.length;a++)if(!this.data.layers[a].playable)return!1;return!0}},{key:"baseLayer",get:function(){return 0<this.data.layers.length?this.data.layers[0]:null}}]);return d}(ca),sp=function(){this.stateGraphAsset=null;this.animationAssets=
{};this.speed=1;this.enabled=this.activate=!0;this.playing=!1;this.stateGraph=null;this.layers=[];this.layerIndices={};this.parameters={}},Hl=["enabled","speed","activate","playing"],Il=function(g){function d(a){a=g.call(this,a)||this;a.id="anim";a.ComponentType=Oh;a.DataType=sp;a.schema=Hl;a.on("beforeremove",a.onBeforeRemove,F(a));O.bind("animationUpdate",a.onAnimationUpdate,F(a));return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c,e){e=["activate","enabled","speed","playing"];
g.prototype.initializeComponentData.call(this,a,c,e);c.stateGraphAsset&&(a.stateGraphAsset=c.stateGraphAsset);c.animationAssets&&(a.animationAssets=Object.assign(a.data.animationAssets,c.animationAssets))};b.onAnimationUpdate=function(a){var c=this.store,e;for(e in c)if(c.hasOwnProperty(e)){var f=c[e],h=f.data;if(h.enabled&&f.entity.enabled&&h.playing)for(f=0;f<h.layers.length;f++)h.layers[f].update(a*h.speed)}};return d}(O);ca._buildAccessors(Oh.prototype,Hl);var Ph=function(g){function d(a,c){return g.call(this,
a,c)||this}K(d,g);var b=d.prototype;b.setCurrentListener=function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var a=this.system.current.getPosition();this.system.manager.listener.setPosition(a)}};b.onEnable=function(){this.setCurrentListener()};b.onDisable=function(){this.system.current===this.entity&&(this.system.current=null)};return d}(ca),tp=function(){this.enabled=!0},Jl=["enabled"],Kl=function(g){function d(a,c){a=g.call(this,a)||this;a.id=
"audiolistener";a.ComponentType=Ph;a.DataType=tp;a.schema=Jl;a.manager=c;a.current=null;O.bind("update",a.onUpdate,F(a));return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c,e){e=["enabled"];g.prototype.initializeComponentData.call(this,a,c,e)};b.onUpdate=function(a){this.current&&(a=this.current.getPosition(),this.manager.listener.setPosition(a),a=this.current.getWorldTransform(),this.manager.listener.setOrientation(a))};return d}(O);ca._buildAccessors(Ph.prototype,Jl);var Qh=
function(g){function d(a,c){a=g.call(this,a,c)||this;a.on("set_assets",a.onSetAssets,F(a));a.on("set_loop",a.onSetLoop,F(a));a.on("set_volume",a.onSetVolume,F(a));a.on("set_pitch",a.onSetPitch,F(a));a.on("set_minDistance",a.onSetMinDistance,F(a));a.on("set_maxDistance",a.onSetMaxDistance,F(a));a.on("set_rollOffFactor",a.onSetRollOffFactor,F(a));a.on("set_distanceModel",a.onSetDistanceModel,F(a));a.on("set_3d",a.onSet3d,F(a));return a}K(d,g);var b=d.prototype;b.play=function(a){if(this.enabled&&this.entity.enabled){this.channel&&
this.stop();var c=this.data;if(c.sources[a]){if(c["3d"]){var e=this.entity.getPosition();e=this.system.manager.playSound3d(c.sources[a],e,c)}else e=this.system.manager.playSound(c.sources[a],c);c.currentSource=a;c.channel=e}}};b.pause=function(){this.channel&&this.channel.pause()};b.unpause=function(){this.channel&&this.channel.paused&&this.channel.unpause()};b.stop=function(){this.channel&&(this.channel.stop(),this.channel=null)};b.onSetAssets=function(a,c,e){a=[];var f,h=e.length;if(c&&c.length)for(f=
0;f<c.length;f++)if(c[f]){var k=this.system.app.assets.get(c[f]);k&&(k.off("change",this.onAssetChanged,this),k.off("remove",this.onAssetRemoved,this),this.currentSource===k.name&&this.stop())}if(h)for(f=0;f<h;f++)0>c.indexOf(e[f])&&(e[f]instanceof fa?a.push(e[f].id):a.push(e[f]));!this.system._inTools&&a.length&&this.loadAudioSourceAssets(a)};b.onAssetChanged=function(a,c,e,f){"resource"===c&&this.data.sources&&(this.data.sources[a.name]=e,this.data.currentSource===a.name&&this.channel&&(this.channel.paused?
(this.play(a.name),this.pause()):this.play(a.name)))};b.onAssetRemoved=function(a){a.off("remove",this.onAssetRemoved,this);this.data.sources[a.name]&&(delete this.data.sources[a.name],this.data.currentSource===a.name&&(this.stop(),this.data.currentSource=null))};b.onSetLoop=function(a,c,e){c!=e&&this.channel&&this.channel.setLoop(e)};b.onSetVolume=function(a,c,e){c!=e&&this.channel&&this.channel.setVolume(e)};b.onSetPitch=function(a,c,e){c!=e&&this.channel&&this.channel.setPitch(e)};b.onSetMaxDistance=
function(a,c,e){c!=e&&this.channel instanceof Mb&&this.channel.setMaxDistance(e)};b.onSetMinDistance=function(a,c,e){c!=e&&this.channel instanceof Mb&&this.channel.setMinDistance(e)};b.onSetRollOffFactor=function(a,c,e){c!=e&&this.channel instanceof Mb&&this.channel.setRollOffFactor(e)};b.onSetDistanceModel=function(a,c,e){c!==e&&this.channel instanceof Mb&&this.channel.setDistanceModel(e)};b.onSet3d=function(a,c,e){c!==e&&this.system.initialized&&this.currentSource&&(c=a=!1,this.channel&&(a=this.channel.paused,
c=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=a,this.channel.suspended=c))};b.onEnable=function(){var a=this.data.assets;if(a)for(var c=this.system.app.assets,e=0,f=a.length;e<f;e++){var h=a[e];h instanceof fa||(h=c.get(h));h&&!h.resource&&c.load(h)}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())};b.onDisable=function(){this.pause()};b.loadAudioSourceAssets=function(a){var c=this,e=a.map(function(p){return this.system.app.assets.get(p)},
this),f={},h=null,k=e.length,m=function(p){k--},n=function(){this.data.sources=f;this.data.currentSource=h;if(this.enabled&&this.activate&&h)this.onEnable()}.bind(this);e.forEach(function(p,t){p?(h=h||p.name,p.off("change",this.onAssetChanged,this),p.on("change",this.onAssetChanged,this),p.off("remove",this.onAssetRemoved,this),p.on("remove",this.onAssetRemoved,this),p.off("error",m,this),p.on("error",m,this),p.ready(function(r){f[r.name]=r.resource;k--;0===k&&n()}),!p.resource&&c.enabled&&c.entity.enabled&&
this.system.app.assets.load(p)):(k--,0===k&&n(),this.system.app.assets.on("add:"+a[t],function(r){r.ready(function(u){c.data.sources[u.name]=u.resource});r.resource||c.system.app.assets.load(r)}))},this)};return d}(ca),up=function(){this.enabled=!0;this.assets=[];this.activate=!0;this.pitch=this.volume=1;this.loop=!1;this["3d"]=!0;this.minDistance=1;this.maxDistance=1E4;this.rollOffFactor=1;this.distanceModel="inverse";this.paused=!0;this.sources={};this.channel=this.currentSource=null},Ll="enabled assets volume pitch loop activate 3d minDistance maxDistance rollOffFactor distanceModel sources currentSource channel".split(" "),
Ml=function(g){function d(a,c){a=g.call(this,a)||this;a.id="audiosource";a.ComponentType=Qh;a.DataType=up;a.schema=Ll;a.manager=c;a.initialized=!1;O.bind("initialize",a.onInitialize,F(a));O.bind("update",a.onUpdate,F(a));a.on("remove",a.onRemove,F(a));return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c,e){e="activate volume pitch loop 3d minDistance maxDistance rollOffFactor distanceModel enabled assets".split(" ");g.prototype.initializeComponentData.call(this,a,c,e);a.paused=
!(a.enabled&&a.activate)};b.onInitialize=function(a){a.audiosource&&a.enabled&&a.audiosource.enabled&&a.audiosource.activate&&a.audiosource.play(a.audiosource.currentSource);a=a._children;var c,e=a.length;for(c=0;c<e;c++)if(a[c]instanceof Ba)this.onInitialize(a[c]);this.initialized=!0};b.onUpdate=function(a){a=this.store;for(var c in a)if(a.hasOwnProperty(c)){var e=a[c],f=e.entity;e=e.data;e.enabled&&f.enabled&&e.channel instanceof Mb&&(f=f.getPosition(),e.channel.setPosition(f))}};b.onRemove=function(a,
c){c.channel&&(c.channel.stop(),c.channel=null)};b.setVolume=function(a){this.manager.setVolume(a)};return d}(O);ca._buildAccessors(Qh.prototype,Ll);var nc=function(g){function d(a,c,e){var f=g.call(this)||this;if(a&&a instanceof ca){if(!c||"string"!==typeof c)throw Error("The propertyName argument is required and must be a string");if(e&&"object"!==typeof e)throw Error("If provided, the eventConfig argument must be an object");}else throw Error("The parentComponent argument is required and must be a Component");
f._parentComponent=a;f._entityPropertyName=c;f._entity=null;f._app=a.system.app;f._configureEventListeners(e||{},{"entity#destroy":f._onEntityDestroy});f._toggleLifecycleListeners("on");return f}K(d,g);var b=d.prototype;b._configureEventListeners=function(a,c){a=this._parseEventListenerConfig(a,"external",this._parentComponent);c=this._parseEventListenerConfig(c,"internal",this);this._eventListenerConfigs=a.concat(c);this._listenerStatusFlags={};this._gainListeners={};this._loseListeners={}};b._parseEventListenerConfig=
function(a,c,e){return Object.keys(a).map(function(f,h){var k=f.split("#"),m=k[0],n=k[1],p=a[f];if(2!==k.length||"string"!==typeof m||0===m.length||"string"!==typeof n||0===n.length)throw Error("Invalid event listener description: `"+f+"`");if("function"!==typeof p)throw Error("Invalid or missing callback for event listener `"+f+"`");return{id:c+"_"+h+"_"+f,sourceName:m,eventName:n,callback:p,scope:e}},this)};b._toggleLifecycleListeners=function(a){this._parentComponent[a]("set_"+this._entityPropertyName,
this._onSetEntity,this);this._parentComponent.system[a]("beforeremove",this._onParentComponentRemove,this);O[a]("postinitialize",this._onPostInitialize,this);this._app[a]("tools:sceneloaded",this._onSceneLoaded,this);for(var c=[],e=0;e<this._eventListenerConfigs.length;++e){var f=this._eventListenerConfigs[e],h=this._app.systems[f.sourceName];h&&(-1===c.indexOf(h)&&c.push(h),h&&"gain"===f.eventName&&(this._gainListeners[f.sourceName]=f),h&&"lose"===f.eventName&&(this._loseListeners[f.sourceName]=
f))}for(e=0;e<c.length;++e)c[e][a]("add",this._onComponentAdd,this),c[e][a]("beforeremove",this._onComponentRemove,this)};b._onSetEntity=function(a,c,e){e instanceof Ba?this._updateEntityReference():null!==e&&void 0!==e&&"string"!==typeof e?console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof e+"'"):c!==e&&this._updateEntityReference()};b._onPostInitialize=function(){this._updateEntityReference()};b.onParentComponentEnable=function(){this._entity||this._updateEntityReference()};
b._onSceneLoaded=function(){this._updateEntityReference()};b._updateEntityReference=function(){var a=this._parentComponent.data[this._entityPropertyName];if(a instanceof Ba){var c=a;a=c.getGuid();this._parentComponent.data[this._entityPropertyName]=a}else c=this._parentComponent.system.app.root,c=this._parentComponent.entity.isDescendantOf(c)&&a?c.findByGuid(a):null;this._entity!==c&&(this._entity&&this._onBeforeEntityChange(),(this._entity=c)&&this._onAfterEntityChange(),this.fire("set:entity",this._entity))};
b._onBeforeEntityChange=function(){this._toggleEntityListeners("off");this._callAllGainOrLoseListeners(this._loseListeners)};b._onAfterEntityChange=function(){this._toggleEntityListeners("on");this._callAllGainOrLoseListeners(this._gainListeners)};b._onComponentAdd=function(a,c){c=c.system.id;a===this._entity&&(this._callGainOrLoseListener(c,this._gainListeners),this._toggleComponentListeners("on",c))};b._onComponentRemove=function(a,c){c=c.system.id;a===this._entity&&(this._callGainOrLoseListener(c,
this._loseListeners),this._toggleComponentListeners("off",c,!0))};b._callAllGainOrLoseListeners=function(a){for(var c in this._entity.c)this._callGainOrLoseListener(c,a)};b._callGainOrLoseListener=function(a,c){this._entity.c.hasOwnProperty(a)&&c[a]&&(a=c[a],a.callback.call(a.scope))};b._toggleEntityListeners=function(a,c){if(this._entity)for(var e=0;e<this._eventListenerConfigs.length;++e)this._safeToggleListener(a,this._eventListenerConfigs[e],c)};b._toggleComponentListeners=function(a,c,e){for(var f=
0;f<this._eventListenerConfigs.length;++f){var h=this._eventListenerConfigs[f];h.sourceName===c&&this._safeToggleListener(a,h,e)}};b._safeToggleListener=function(a,c,e){var f="on"===a;if(!f||!this._listenerStatusFlags[c.id])if(e=this._getEventSource(c.sourceName,e))e[a](c.eventName,c.callback,c.scope),this._listenerStatusFlags[c.id]=f};b._getEventSource=function(a,c){if("entity"===a)return this._entity;var e=this._entity[a];if(e)return e;c||console.warn("Entity has no component with name "+a);return null};
b._onEntityDestroy=function(a){this._entity===a&&(this._toggleEntityListeners("off",!0),this._entity=null)};b._onParentComponentRemove=function(a,c){c===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))};b.hasComponent=function(a){return this._entity&&this._entity.c?!!this._entity.c[a]:!1};N(d,[{key:"entity",get:function(){return this._entity}}]);return d}(ba),vp={DEFAULT:"_defaultTint",HOVER:"hoverTint",PRESSED:"pressedTint",INACTIVE:"inactiveTint"},
wp={DEFAULT:"_defaultSpriteAsset",HOVER:"hoverSpriteAsset",PRESSED:"pressedSpriteAsset",INACTIVE:"inactiveSpriteAsset"},xp={DEFAULT:"_defaultSpriteFrame",HOVER:"hoverSpriteFrame",PRESSED:"pressedSpriteFrame",INACTIVE:"inactiveSpriteFrame"},Rh=function(g){function d(a,c){c=g.call(this,a,c)||this;c._visualState="DEFAULT";c._isHovering=!1;c._hoveringCounter=0;c._isPressed=!1;c._defaultTint=new Q(1,1,1,1);c._defaultSpriteAsset=null;c._defaultSpriteFrame=0;c._imageReference=new nc(F(c),"imageEntity",{"element#gain":c._onImageElementGain,
"element#lose":c._onImageElementLose,"element#set:color":c._onSetColor,"element#set:opacity":c._onSetOpacity,"element#set:spriteAsset":c._onSetSpriteAsset,"element#set:spriteFrame":c._onSetSpriteFrame});c._toggleLifecycleListeners("on",a);return c}K(d,g);var b=d.prototype;b._toggleLifecycleListeners=function(a,c){this[a]("set_active",this._onSetActive,this);this[a]("set_transitionMode",this._onSetTransitionMode,this);this[a]("set_hoverTint",this._onSetTransitionValue,this);this[a]("set_pressedTint",
this._onSetTransitionValue,this);this[a]("set_inactiveTint",this._onSetTransitionValue,this);this[a]("set_hoverSpriteAsset",this._onSetTransitionValue,this);this[a]("set_hoverSpriteFrame",this._onSetTransitionValue,this);this[a]("set_pressedSpriteAsset",this._onSetTransitionValue,this);this[a]("set_pressedSpriteFrame",this._onSetTransitionValue,this);this[a]("set_inactiveSpriteAsset",this._onSetTransitionValue,this);this[a]("set_inactiveSpriteFrame",this._onSetTransitionValue,this);c.app.systems.element[a]("add",
this._onElementComponentAdd,this);c.app.systems.element[a]("beforeremove",this._onElementComponentRemove,this)};b._onSetActive=function(a,c,e){c!==e&&this._updateVisualState()};b._onSetTransitionMode=function(a,c,e){c!==e&&(this._cancelTween(),this._resetToDefaultVisualState(c),this._forceReapplyVisualState())};b._onSetTransitionValue=function(a,c,e){c!==e&&this._forceReapplyVisualState()};b._onElementComponentRemove=function(a){this.entity===a&&this._toggleHitElementListeners("off")};b._onElementComponentAdd=
function(a){this.entity===a&&this._toggleHitElementListeners("on")};b._onImageElementLose=function(){this._cancelTween();this._resetToDefaultVisualState(this.transitionMode)};b._onImageElementGain=function(){this._storeDefaultVisualState();this._forceReapplyVisualState()};b._toggleHitElementListeners=function(a){if(this.entity.element){var c="on"===a;c&&this._hasHitElementListeners||(this.entity.element[a]("mouseenter",this._onMouseEnter,this),this.entity.element[a]("mouseleave",this._onMouseLeave,
this),this.entity.element[a]("mousedown",this._onMouseDown,this),this.entity.element[a]("mouseup",this._onMouseUp,this),this.entity.element[a]("touchstart",this._onTouchStart,this),this.entity.element[a]("touchend",this._onTouchEnd,this),this.entity.element[a]("touchleave",this._onTouchLeave,this),this.entity.element[a]("touchcancel",this._onTouchCancel,this),this.entity.element[a]("selectstart",this._onSelectStart,this),this.entity.element[a]("selectend",this._onSelectEnd,this),this.entity.element[a]("selectenter",
this._onSelectEnter,this),this.entity.element[a]("selectleave",this._onSelectLeave,this),this.entity.element[a]("click",this._onClick,this),this._hasHitElementListeners=c)}};b._storeDefaultVisualState=function(){this._imageReference.hasComponent("element")&&(this._storeDefaultColor(this._imageReference.entity.element.color),this._storeDefaultOpacity(this._imageReference.entity.element.opacity),this._storeDefaultSpriteAsset(this._imageReference.entity.element.spriteAsset),this._storeDefaultSpriteFrame(this._imageReference.entity.element.spriteFrame))};
b._storeDefaultColor=function(a){this._defaultTint.r=a.r;this._defaultTint.g=a.g;this._defaultTint.b=a.b};b._storeDefaultOpacity=function(a){this._defaultTint.a=a};b._storeDefaultSpriteAsset=function(a){this._defaultSpriteAsset=a};b._storeDefaultSpriteFrame=function(a){this._defaultSpriteFrame=a};b._onSetColor=function(a){this._isApplyingTint||(this._storeDefaultColor(a),this._forceReapplyVisualState())};b._onSetOpacity=function(a){this._isApplyingTint||(this._storeDefaultOpacity(a),this._forceReapplyVisualState())};
b._onSetSpriteAsset=function(a){this._isApplyingSprite||(this._storeDefaultSpriteAsset(a),this._forceReapplyVisualState())};b._onSetSpriteFrame=function(a){this._isApplyingSprite||(this._storeDefaultSpriteFrame(a),this._forceReapplyVisualState())};b._onMouseEnter=function(a){this._isHovering=!0;this._updateVisualState();this._fireIfActive("mouseenter",a)};b._onMouseLeave=function(a){this._isPressed=this._isHovering=!1;this._updateVisualState();this._fireIfActive("mouseleave",a)};b._onMouseDown=function(a){this._isPressed=
!0;this._updateVisualState();this._fireIfActive("mousedown",a)};b._onMouseUp=function(a){this._isPressed=!1;this._updateVisualState();this._fireIfActive("mouseup",a)};b._onTouchStart=function(a){this._isPressed=!0;this._updateVisualState();this._fireIfActive("touchstart",a)};b._onTouchEnd=function(a){a.event.preventDefault();this._isPressed=!1;this._updateVisualState();this._fireIfActive("touchend",a)};b._onTouchLeave=function(a){this._isPressed=!1;this._updateVisualState();this._fireIfActive("touchleave",
a)};b._onTouchCancel=function(a){this._isPressed=!1;this._updateVisualState();this._fireIfActive("touchcancel",a)};b._onSelectStart=function(a){this._isPressed=!0;this._updateVisualState();this._fireIfActive("selectstart",a)};b._onSelectEnd=function(a){this._isPressed=!1;this._updateVisualState();this._fireIfActive("selectend",a)};b._onSelectEnter=function(a){this._hoveringCounter++;1===this._hoveringCounter&&(this._isHovering=!0,this._updateVisualState());this._fireIfActive("selectenter",a)};b._onSelectLeave=
function(a){this._hoveringCounter--;0===this._hoveringCounter&&(this._isPressed=this._isHovering=!1,this._updateVisualState());this._fireIfActive("selectleave",a)};b._onClick=function(a){this._fireIfActive("click",a)};b._fireIfActive=function(a,c){this.data.active&&this.fire(a,c)};b._updateVisualState=function(a){var c=this._visualState,e=this._determineVisualState();if((c!==e||a)&&this.enabled)switch(this._visualState=e,"HOVER"===c&&this._fireIfActive("hoverend"),"PRESSED"===c&&this._fireIfActive("pressedend"),
"HOVER"===e&&this._fireIfActive("hoverstart"),"PRESSED"===e&&this._fireIfActive("pressedstart"),this.transitionMode){case 0:this._applyTint(this[vp[this._visualState]]);break;case 1:this._applySprite(this[wp[this._visualState]],this[xp[this._visualState]])}};b._forceReapplyVisualState=function(){this._updateVisualState(!0)};b._resetToDefaultVisualState=function(a){if(this._imageReference.hasComponent("element"))switch(a){case 0:this._cancelTween();this._applyTintImmediately(this._defaultTint);break;
case 1:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}};b._determineVisualState=function(){if(this.active){if(this._isPressed)return"PRESSED";if(this._isHovering)return"HOVER"}else return"INACTIVE";return"DEFAULT"};b._applySprite=function(a,c){c=c||0;this._imageReference.hasComponent("element")&&(this._imageReference.entity.element.spriteAsset=a,this._imageReference.entity.element.spriteFrame=c,this._isApplyingSprite=!1)};b._applyTint=function(a){this._cancelTween();0===this.fadeDuration?
this._applyTintImmediately(a):this._applyTintWithTween(a)};b._applyTintImmediately=function(a){this._imageReference.hasComponent("element")&&a&&(this._isApplyingTint=!0,this._imageReference.entity.element.color=new Q(a.r,a.g,a.b),this._imageReference.entity.element.opacity=a.a,this._isApplyingTint=!1)};b._applyTintWithTween=function(a){if(this._imageReference.hasComponent("element")&&a){var c=this._imageReference.entity.element.color,e=this._imageReference.entity.element.opacity;this._tweenInfo={startTime:eb(),
from:new Q(c.r,c.g,c.b,e),to:a.clone(),lerpColor:new Q}}};b._updateTintTween=function(){var a=eb()-this._tweenInfo.startTime;a=0===this.fadeDuration?1:a/this.fadeDuration;a=R.clamp(a,0,1);if(1E-5<Math.abs(a-1)){var c=this._tweenInfo.lerpColor;c.lerp(this._tweenInfo.from,this._tweenInfo.to,a);this._applyTintImmediately(new Q(c.r,c.g,c.b,c.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()};b._cancelTween=function(){delete this._tweenInfo};b.onUpdate=function(){this._tweenInfo&&
this._updateTintTween()};b.onEnable=function(){this._isHovering=!1;this._hoveringCounter=0;this._isPressed=!1;this._imageReference.onParentComponentEnable();this._toggleHitElementListeners("on");this._forceReapplyVisualState()};b.onDisable=function(){this._toggleHitElementListeners("off");this._resetToDefaultVisualState(this.transitionMode)};b.onRemove=function(){this._toggleLifecycleListeners("off",this.system);this.onDisable()};return d}(ca),yp=function(){this.active=this.enabled=!0;this.imageEntity=
null;this.hitPadding=new Z;this.transitionMode=0;this.hoverTint=new Q(.75,.75,.75);this.pressedTint=new Q(.5,.5,.5);this.inactiveTint=new Q(.25,.25,.25);this.fadeDuration=0;this.hoverSpriteAsset=null;this.hoverSpriteFrame=0;this.pressedSpriteAsset=null;this.pressedSpriteFrame=0;this.inactiveSpriteAsset=null;this.inactiveSpriteFrame=0},Sh=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},
{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"],Nl=function(g){function d(a){a=g.call(this,a)||this;a.id="button";a.ComponentType=Rh;a.DataType=yp;a.schema=Sh;a.on("beforeremove",a._onRemoveComponent,F(a));O.bind("update",a.onUpdate,F(a));return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c,e){g.prototype.initializeComponentData.call(this,a,c,Sh)};b.onUpdate=
function(a){a=this.store;for(var c in a){var e=a[c].entity,f=e.button;if(f.enabled&&e.enabled)f.onUpdate()}};b._onRemoveComponent=function(a,c){c.onRemove()};return d}(O);ca._buildAccessors(Rh.prototype,Sh);var Dd,Th=function(){function g(b,a){var c=this;this.app=b;this.camera=a;this.effects=[];this.enabled=!1;this.depthTarget=null;this.renderTargetScale=1;this.resizeTimeout=null;this.resizeLast=0;this._resizeTimeoutCallback=function(){c.resizeRenderTargets()};a.on("set_rect",this.onCameraRectChanged,
this);this._origStencilColorBuffer=this._origDepthColorBuffer=this._origClearColorBuffer=this._origOverrideClear=!1}var d=g.prototype;d._createOffscreenTarget=function(b,a){var c=this.camera.rect,e=Math.floor(c.z*this.app.graphicsDevice.width*this.renderTargetScale);c=Math.floor(c.w*this.app.graphicsDevice.height*this.renderTargetScale);var f=this.app.graphicsDevice,h=a?f.getHdrFormat():7;a=this.app.graphicsDevice.supportsStencil;var k=b?f.samples:1;e=new X(f,{format:h,width:e,height:c});e.name="posteffect #"+
this.effects.length;e.minFilter=0;e.magFilter=0;e.addressU=1;e.addressV=1;return new va(this.app.graphicsDevice,e,{depth:b,stencil:a,samples:k})};d._resizeOffscreenTarget=function(b){var a=this.camera.rect,c=Math.floor(a.z*this.app.graphicsDevice.width*this.renderTargetScale);a=Math.floor(a.w*this.app.graphicsDevice.height*this.renderTargetScale);var e=this.app.graphicsDevice,f=b.colorBuffer.format;b._colorBuffer.destroy();c=new X(e,{format:f,width:c,height:a});c.name="posteffect";c.minFilter=0;c.magFilter=
0;c.addressU=1;c.addressV=1;b._colorBuffer=c;b.destroy()};d._destroyOffscreenTarget=function(b){b._colorBuffer&&b._colorBuffer.destroy();b._depthBuffer&&b._depthBuffer.destroy();b.destroy()};d.setRenderTargetScale=function(b){this.renderTargetScale=b;this.resizeRenderTargets()};d.addEffect=function(b){var a=this.effects,c={effect:b,inputTarget:this._createOffscreenTarget(0===this.effects.length,b.hdr),outputTarget:null};if(!this.layer){this.layer=new nb({opaqueSortMode:0,transparentSortMode:0,passThrough:!0,
name:"PostEffectQueue",renderTarget:this.camera.renderTarget,clear:!1,onPostRender:function(){for(var p=0;p<this._commandList.length;p++)this._commandList[p]()}});var e=this.app.scene.layers.layerList,f=0,h,k=e.length-1;for(h=k;0<=h;h--)if(4===e[h].id){k=h-1;this._origOverrideClear=e[h].overrideClear;this._origClearColorBuffer=e[h].clearColorBuffer;this._origDepthColorBuffer=e[h].clearDepthBuffer;this._origStencilColorBuffer=e[h].clearStencilBuffer;e[h].overrideClear=!0;e[h].clearColorBuffer=!1;e[h].clearDepthBuffer=
this.camera.clearDepthBuffer;e[h].clearStencilBuffer=this.camera.clearStencilBuffer;break}this._sourceLayers=[];for(h=0;h<this.camera.layers.length;h++){e=this.camera.layers[h];var m=this.app.scene.layers.getLayerById(e),n=this.app.scene.layers.layerList.indexOf(m);n<=k&&(1!=e&&(m.renderTarget=c.inputTarget,this._sourceLayers.push(m)),n>f&&(f=n))}this.app.scene.layers.insertOpaque(this.layer,f+1);this._sourceTarget=c.inputTarget;this.layer._commandList=[];this.layer.isPostEffect=!0}a.push(c);f=a.length;
1<f&&(a[f-2].outputTarget=c.inputTarget);this._newPostEffect=b;b.needsDepthBuffer&&this._requestDepthMap();this.enable();this._newPostEffect=void 0};d.removeEffect=function(b){var a,c=-1;var e=0;for(a=this.effects.length;e<a;e++)if(this.effects[e].effect===b){c=e;break}if(0<=c){if(0<c)this.effects[c-1].outputTarget=c+1<this.effects.length?this.effects[c+1].inputTarget:null;else if(1<this.effects.length)for(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),
this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),e=0;e<this._sourceLayers.length;e++)this._sourceLayers[e].renderTarget=this.effects[1].inputTarget;this._destroyOffscreenTarget(this.effects[c].inputTarget);this.effects.splice(c,1)}this.enabled&&b.needsDepthBuffer&&this._releaseDepthMap();0===this.effects.length&&this.disable()};d._requestDepthMaps=function(){for(var b=0,a=this.effects.length;b<a;b++){var c=this.effects[b].effect;
this._newPostEffect!==c&&c.needsDepthBuffer&&this._requestDepthMap()}};d._releaseDepthMaps=function(){for(var b=0,a=this.effects.length;b<a;b++)this.effects[b].effect.needsDepthBuffer&&this._releaseDepthMap()};d._requestDepthMap=function(){Dd||(Dd=this.app.scene.layers.getLayerById(1));Dd&&Dd.incrementCounter()};d._releaseDepthMap=function(){Dd&&Dd.decrementCounter()};d.destroy=function(){for(var b=0,a=this.effects.length;b<a;b++)this.effects[b].inputTarget.destroy();this.effects.length=0;this.disable()};
d.enable=function(){if(!this.enabled&&this.effects.length){this.enabled=!0;var b=this;this._requestDepthMaps();this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this);this.command=function(){if(b.enabled){var a=null,c=b.effects.length;if(c){b.layer.renderTarget=b.effects[0].inputTarget;for(var e=0;e<c;e++){var f=b.effects[e];e===c-1&&(a=b.camera.rect);f.effect.render(f.inputTarget,f.outputTarget,a)}}}};this.layer._commandList.push(this.command)}};d.disable=function(){if(this.enabled){this.enabled=
!1;this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this);this._releaseDepthMaps();this._destroyOffscreenTarget(this._sourceTarget);var b=this.layer._commandList.indexOf(this.command);0<=b&&this.layer._commandList.splice(b,1);var a=this.app.scene.layers.layerList,c=a.length-1;for(b=0;b<=a.length;b++)if(4===a[b].id){c=b-1;a[b].overrideClear=this._origOverrideClear;a[b].clearColorBuffer=this._origClearColorBuffer;a[b].clearDepthBuffer=this._origDepthColorBuffer;a[b].clearStencilBuffer=
this._origStencilColorBuffer;break}for(b=c;0<=b;b--)0<=a[b].cameras.indexOf(this.camera)&&(a[b].renderTarget=void 0);this.app.scene.layers.removeOpaque(this.layer);this.layer=null}};d._onCanvasResized=function(b,a){b=this.camera.rect;a=this.app.graphicsDevice;this.camera.camera.aspectRatio=a.width*b.z/(a.height*b.w);this.resizeTimeout||(100<eb()-this.resizeLast?this.resizeRenderTargets():this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,100))};d.resizeRenderTargets=function(){this.resizeTimeout&&
(clearTimeout(this.resizeTimeout),this.resizeTimeout=null);this.resizeLast=eb();var b=this.camera.rect,a=Math.floor(b.z*this.app.graphicsDevice.width*this.renderTargetScale);b=Math.floor(b.w*this.app.graphicsDevice.height*this.renderTargetScale);for(var c=this.effects,e=0,f=c.length;e<f;e++){var h=c[e];h.inputTarget.width===a&&h.inputTarget.height===b||this._resizeOffscreenTarget(h.inputTarget)}};d.onCameraRectChanged=function(b,a,c){this.enabled&&this.resizeRenderTargets()};return g}(),se=function(g){function d(a,
c){var e=g.call(this,a,c)||this;e._camera=new be;e._camera.node=c;e._priority=0;e._postEffects=new Th(a.app,F(e));return e}K(d,g);var b=d.prototype;b.screenToWorld=function(a,c,e,f){var h=this.system.app.graphicsDevice;return this._camera.screenToWorld(a,c,e,h.clientRect.width,h.clientRect.height,f)};b.worldToScreen=function(a,c){var e=this.system.app.graphicsDevice;return this._camera.worldToScreen(a,e.clientRect.width,e.clientRect.height,c)};b.onPrerender=function(){this._camera._viewMatDirty=!0;
this._camera._viewProjMatDirty=!0};b.addCameraToLayers=function(){for(var a=this.layers,c=0;c<a.length;c++){var e=this.system.app.scene.layers.getLayerById(a[c]);e&&e.addCamera(this)}};b.removeCameraFromLayers=function(){for(var a=this.layers,c=0;c<a.length;c++){var e=this.system.app.scene.layers.getLayerById(a[c]);e&&e.removeCamera(this)}};b.onLayersChanged=function(a,c){this.addCameraToLayers();a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);c.on("add",this.onLayerAdded,
this);c.on("remove",this.onLayerRemoved,this)};b.onLayerAdded=function(a){0>this.layers.indexOf(a.id)||a.addCamera(this)};b.onLayerRemoved=function(a){0>this.layers.indexOf(a.id)||a.removeCamera(this)};b.onEnable=function(){var a=this.system,c=a.app.scene,e=c.layers;a.addCamera(this);c.on("set:layers",this.onLayersChanged,this);e&&(e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&this.addCameraToLayers();this.postEffects.enable()};b.onDisable=
function(){var a=this.system,c=a.app.scene,e=c.layers;this.postEffects.disable();this.removeCameraFromLayers();c.off("set:layers",this.onLayersChanged,this);e&&(e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this));a.removeCamera(this)};b.onRemove=function(){this.onDisable();this.off()};b.calculateAspectRatio=function(a){a=a?a:this.system.app.graphicsDevice;var c=this.rect;return a.width*c.z/(a.height*c.w)};b.frameBegin=function(a){0===this.aspectRatioMode&&(this.aspectRatio=
this.calculateAspectRatio(a))};b.frameEnd=function(){};b.enterVr=function(a,c){a instanceof Function&&!c&&(c=a,a=null);if(this.system.app.vr)if(a||(a=this.system.app.vr.display),a){var e=this;a.capabilities.canPresent?a.requestPresent(function(f){f||(e.vrDisplay=a,e.vrDisplay.once("beforepresentchange",function(h){h.presenting||(e.vrDisplay=null)}));c(f)}):(e.vrDisplay=a,c())}else c("No pc.VrDisplay to present");else c("VrManager not created. Enable VR in project settings.")};b.exitVr=function(a){if(this.vrDisplay)if(this.vrDisplay.capabilities.canPresent){var c=
this.vrDisplay;this.vrDisplay=null;c.exitPresent(a)}else this.vrDisplay=null,a();else a("Not presenting VR")};b.startXr=function(a,c,e){this.system.app.xr.start(this,a,c,e)};b.endXr=function(a){this._camera.xr?this._camera.xr.end(a):a&&a(Error("Camera is not in XR"))};N(d,[{key:"camera",get:function(){return this._camera}},{key:"layers",get:function(){return this._camera.layers},set:function(a){var c,e,f=this._camera.layers;for(c=0;c<f.length;c++)(e=this.system.app.scene.layers.getLayerById(f[c]))&&
e.removeCamera(this);this._camera.layers=a;if(this.enabled&&this.entity.enabled)for(c=0;c<a.length;c++)(e=this.system.app.scene.layers.getLayerById(a[c]))&&e.addCamera(this)}},{key:"postEffects",get:function(){return this._postEffects}},{key:"priority",get:function(){return this._priority},set:function(a){this._priority=a;a=this.layers;for(var c=0;c<a.length;c++){var e=this.system.app.scene.layers.getLayerById(a[c]);e&&e._sortCameras()}}}]);return d}(ca);[{name:"aspectRatio",readonly:!1},{name:"aspectRatioMode",
readonly:!1},{name:"calculateProjection",readonly:!1},{name:"calculateTransform",readonly:!1},{name:"clearColor",readonly:!1},{name:"clearColorBuffer",readonly:!1},{name:"clearDepthBuffer",readonly:!1},{name:"clearStencilBuffer",readonly:!1},{name:"cullFaces",readonly:!1},{name:"farClip",readonly:!1},{name:"flipFaces",readonly:!1},{name:"fov",readonly:!1},{name:"frustum",readonly:!0},{name:"frustumCulling",readonly:!1},{name:"horizontalFov",readonly:!1},{name:"nearClip",readonly:!1},{name:"orthoHeight",
readonly:!1},{name:"projection",readonly:!1},{name:"projectionMatrix",readonly:!0},{name:"rect",readonly:!1},{name:"renderTarget",readonly:!1},{name:"scissorRect",readonly:!1},{name:"viewMatrix",readonly:!0},{name:"vrDisplay",readonly:!1}].forEach(function(g){var d=g.name,b={get:function(){return this._camera[d]}};g.readonly||(b.set=function(a){this._camera[d]=a});Object.defineProperty(se.prototype,d,b)});var zp=function(){this.enabled=!0},Ol=["enabled"],Pl=function(g){function d(a){a=g.call(this,
a)||this;a.id="camera";a.ComponentType=se;a.DataType=zp;a.schema=Ol;a.cameras=[];a.on("beforeremove",a.onBeforeRemove,F(a));a.app.on("prerender",a.onPrerender,F(a));O.bind("update",a.onUpdate,F(a));return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c,e){e="aspectRatio aspectRatioMode calculateProjection calculateTransform clearColor clearColorBuffer clearDepthBuffer clearStencilBuffer cullFaces farClip flipFaces fov frustumCulling horizontalFov layers renderTarget nearClip orthoHeight projection priority rect scissorRect".split(" ");
for(var f=0;f<e.length;f++){var h=e[f];if(c.hasOwnProperty(h)){var k=c[h];switch(h){case "rect":case "scissorRect":Array.isArray(k)?a[h]=new Z(k[0],k[1],k[2],k[3]):a[h]=k;break;case "clearColor":Array.isArray(k)?a[h]=new Q(k[0],k[1],k[2],k[3]):a[h]=k;break;default:a[h]=k}}}g.prototype.initializeComponentData.call(this,a,c,["enabled"])};b.cloneComponent=function(a,c){a=a.camera;this.addComponent(c,{aspectRatio:a.aspectRatio,aspectRatioMode:a.aspectRatioMode,calculateProjection:a.calculateProjection,
calculateTransform:a.calculateTransform,clearColor:a.clearColor,clearColorBuffer:a.clearColorBuffer,clearDepthBuffer:a.clearDepthBuffer,clearStencilBuffer:a.clearStencilBuffer,cullFaces:a.cullFaces,farClip:a.farClip,flipFaces:a.flipFaces,fov:a.fov,frustumCulling:a.frustumCulling,horizontalFov:a.horizontalFov,layers:a.layers,renderTarget:a.renderTarget,nearClip:a.nearClip,orthoHeight:a.orthoHeight,projection:a.projection,priority:a.priority,rect:a.rect,scissorRect:a.scissorRect})};b.onBeforeRemove=
function(a,c){this.removeCamera(c)};b.onUpdate=function(a){if(this.app.vr){a=this.store;for(var c in a){var e=a[c];if(e.data.enabled&&e.entity.enabled){var f=e.entity.camera,h=f.vrDisplay;h&&(h.setClipPlanes(f.nearClip,f.farClip),e.entity&&(e.entity.localTransform.copy(h.combinedViewInv),e.entity._dirtyLocal=!1,e.entity._dirtifyWorld()))}}}};b.onPrerender=function(){for(var a=0,c=this.cameras.length;a<c;a++)this.cameras[a].onPrerender()};b.addCamera=function(a){this.cameras.push(a);this.sortCamerasByPriority()};
b.removeCamera=function(a){a=this.cameras.indexOf(a);0<=a&&(this.cameras.splice(a,1),this.sortCamerasByPriority())};b.sortCamerasByPriority=function(){this.cameras.sort(function(a,c){return a.priority-c.priority})};return d}(O);ca._buildAccessors(se.prototype,Ol);var Uh=function(g){function d(a,c){a=g.call(this,a,c)||this;a._compoundParent=null;a.entity.on("insert",a._onInsert,F(a));a.on("set_type",a.onSetType,F(a));a.on("set_halfExtents",a.onSetHalfExtents,F(a));a.on("set_radius",a.onSetRadius,F(a));
a.on("set_height",a.onSetHeight,F(a));a.on("set_axis",a.onSetAxis,F(a));a.on("set_asset",a.onSetAsset,F(a));a.on("set_model",a.onSetModel,F(a));return a}K(d,g);var b=d.prototype;b.onSetType=function(a,c,e){c!==e&&this.system.changeType(this,c,e)};b.onSetHalfExtents=function(a,c,e){a=this.data.type;this.data.initialized&&"box"===a&&this.system.recreatePhysicalShapes(this)};b.onSetRadius=function(a,c,e){a=this.data.type;!this.data.initialized||"sphere"!==a&&"capsule"!==a&&"cylinder"!==a&&"cone"!==a||
this.system.recreatePhysicalShapes(this)};b.onSetHeight=function(a,c,e){a=this.data.type;!this.data.initialized||"capsule"!==a&&"cylinder"!==a&&"cone"!==a||this.system.recreatePhysicalShapes(this)};b.onSetAxis=function(a,c,e){a=this.data.type;!this.data.initialized||"capsule"!==a&&"cylinder"!==a&&"cone"!==a||this.system.recreatePhysicalShapes(this)};b.onSetAsset=function(a,c,e){a=this.system.app.assets;c&&(c=a.get(c))&&c.off("remove",this.onAssetRemoved,this);e&&(e instanceof fa&&(this.data.asset=
e.id),c=a.get(this.data.asset))&&(c.off("remove",this.onAssetRemoved,this),c.on("remove",this.onAssetRemoved,this));this.data.initialized&&"mesh"===this.data.type&&(e||(this.data.model=null),this.system.recreatePhysicalShapes(this))};b.onSetModel=function(a,c,e){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)};b.onAssetRemoved=function(a){a.off("remove",this.onAssetRemoved,this);this.data.asset===a.id&&(this.asset=null)};b._getCompoundChildShapeIndex=
function(a){for(var c=this.data.shape,e=c.getNumChildShapes(),f=0;f<e;f++)if(c.getChildShape(f).ptr===a.ptr)return f;return null};b._onInsert=function(a){if("undefined"!==typeof Ammo)if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody)for(a=this.entity.parent;a;){if(a.collision&&"compound"===a.collision.type){0===a.collision.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(a.collision):this.system.recreatePhysicalShapes(this);break}a=a.parent}};
b._updateCompound=function(){var a=this.entity;if(a._dirtyWorld){for(var c=a._dirtyLocal,e=a;e&&!c&&(!e.collision||e.collision!==this._compoundParent);)e._dirtyLocal&&(c=!0),e=e.parent;c&&(a.forEach(this.system.implementations.compound._updateEachDescendantTransform,a),(a=this._compoundParent.entity.rigidbody)&&a.activate())}};b.onEnable=function(){if("mesh"===this.data.type&&this.data.asset&&this.data.initialized){var a=this.system.app.assets.get(this.data.asset);if(a&&(!a.resource||!this.data.shape)){this.system.recreatePhysicalShapes(this);
return}}this.entity.rigidbody?this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation():this._compoundParent&&this!==this._compoundParent?0===this._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(this._compoundParent):(a=this.system._getNodeTransform(this.entity,this._compoundParent.entity),this._compoundParent.shape.addChildShape(a,this.data.shape),Ammo.destroy(a),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&
this.entity.trigger.enable()};b.onDisable=function(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()};b.onBeforeRemove=function(){this.asset&&(this.asset=null);this.entity.off("insert",
this._onInsert,this);this.off()};return d}(ca),Ap=function(){this.enabled=!0;this.type="box";this.halfExtents=new A(.5,.5,.5);this.radius=.5;this.axis=1;this.height=2;this.model=this.shape=this.asset=null;this.initialized=!1},bc,te,Ed,Ql=function(){function g(b,a,c){this.entity=a.entity;this.component=a;this.app=b;"undefined"===typeof Ammo||bc||(bc=new Ammo.btVector3,te=new Ammo.btQuaternion,Ed=new Ammo.btTransform);this.initialize(c)}var d=g.prototype;d.initialize=function(b){var a=this.entity;if((b=
b.shape)&&"undefined"!==typeof Ammo){a.trigger&&a.trigger.destroy();var c=a.getPosition(),e=a.getRotation();bc.setValue(c.x,c.y,c.z);te.setValue(e.x,e.y,e.z,e.w);Ed.setOrigin(bc);Ed.setRotation(te);b=this.app.systems.rigidbody.createBody(1,b,Ed);b.setRestitution(0);b.setFriction(0);b.setDamping(0,0);bc.setValue(0,0,0);b.setLinearFactor(bc);b.setAngularFactor(bc);b.setCollisionFlags(b.getCollisionFlags()|4);b.entity=a;this.body=b;this.component.enabled&&a.enabled&&this.enable()}};d.destroy=function(){var b=
this.body;b&&(this.disable(),this.app.systems.rigidbody.destroyBody(b))};d._getEntityTransform=function(b){var a=this.entity.getPosition(),c=this.entity.getRotation();bc.setValue(a.x,a.y,a.z);te.setValue(c.x,c.y,c.z,c.w);b.setOrigin(bc);b.setRotation(te)};d.updateTransform=function(){this._getEntityTransform(Ed);var b=this.body;b.setWorldTransform(Ed);b.activate()};d.enable=function(){var b=this.body;if(b){var a=this.app.systems;a.rigidbody.addBody(b,16,65517);a.rigidbody._triggers.push(this);b.forceActivationState(1);
this.updateTransform()}};d.disable=function(){var b=this.body;if(b){var a=this.app.systems,c=a.rigidbody._triggers.indexOf(this);-1<c&&a.rigidbody._triggers.splice(c,1);a.rigidbody.removeBody(b);b.forceActivationState(5)}};return g}(),Sf=new M,Bp=new A,Cp=new ea,Rl="enabled type halfExtents radius axis height asset shape model".split(" "),Rc=function(){function g(b){this.system=b}var d=g.prototype;d.beforeInitialize=function(b,a){a.shape=null;a.model=new fb;a.model.graph=new pa};d.afterInitialize=
function(b,a){this.recreatePhysicalShapes(b);b.data.initialized=!0};d.reset=function(b,a){this.beforeInitialize(b,a);this.afterInitialize(b,a)};d.recreatePhysicalShapes=function(b){var a=b.entity,c=b.data;if("undefined"!==typeof Ammo){a.trigger&&(a.trigger.destroy(),delete a.trigger);c.shape&&(b._compoundParent&&(this.system._removeCompoundChild(b._compoundParent,c.shape),b._compoundParent.entity.rigidbody&&b._compoundParent.entity.rigidbody.activate()),Ammo.destroy(c.shape),c.shape=null);c.shape=
this.createPhysicalShape(b.entity,c);var e=!b._compoundParent;if("compound"===c.type&&(!b._compoundParent||b===b._compoundParent))b._compoundParent=b,a.forEach(this._addEachDescendant,b);else if("compound"!==c.type&&(b._compoundParent&&b===b._compoundParent&&a.forEach(this.system.implementations.compound._updateEachDescendant,b),!b.rigidbody)){b._compoundParent=null;for(var f=a.parent;f;){if(f.collision&&"compound"===f.collision.type){b._compoundParent=f.collision;break}f=f.parent}}b._compoundParent&&
b!==b._compoundParent&&(e&&0===b._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(b._compoundParent):(this.system.updateCompoundChildTransform(a),b._compoundParent.entity.rigidbody&&b._compoundParent.entity.rigidbody.activate()));a.rigidbody?(a.rigidbody.disableSimulation(),a.rigidbody.createBody(),a.enabled&&a.rigidbody.enabled&&a.rigidbody.enableSimulation()):b._compoundParent||(a.trigger?a.trigger.initialize(c):a.trigger=new Ql(this.system.app,b,c))}};d.createPhysicalShape=
function(b,a){};d.updateTransform=function(b,a,c,e){b.entity.trigger&&b.entity.trigger.updateTransform()};d.beforeRemove=function(b,a){a.data.shape&&(a._compoundParent&&!a._compoundParent.entity._destroying&&(this.system._removeCompoundChild(a._compoundParent,a.data.shape),a._compoundParent.entity.rigidbody&&a._compoundParent.entity.rigidbody.activate()),a._compoundParent=null,Ammo.destroy(a.data.shape),a.data.shape=null)};d.remove=function(b,a){var c=this.system.app;b.rigidbody&&b.rigidbody.body&&
(c.systems.rigidbody.removeBody(b.rigidbody.body),b.rigidbody.disableSimulation());b.trigger&&(b.trigger.destroy(),delete b.trigger);c.scene.containsModel(a.model)&&(c.root.removeChild(a.model.graph),c.scene.removeModel(a.model))};d.clone=function(b,a){b=this.system.store[b.getGuid()];return this.system.addComponent(a,{enabled:b.data.enabled,type:b.data.type,halfExtents:[b.data.halfExtents.x,b.data.halfExtents.y,b.data.halfExtents.z],radius:b.data.radius,axis:b.data.axis,height:b.data.height,asset:b.data.asset,
model:b.data.model})};return g}(),Dp=function(g){function d(b){return g.call(this,b)||this}K(d,g);d.prototype.createPhysicalShape=function(b,a){if("undefined"!==typeof Ammo)return b=a.halfExtents,b=new Ammo.btVector3(b?b.x:.5,b?b.y:.5,b?b.z:.5),a=new Ammo.btBoxShape(b),Ammo.destroy(b),a};return d}(Rc),Ep=function(g){function d(b){return g.call(this,b)||this}K(d,g);d.prototype.createPhysicalShape=function(b,a){if("undefined"!==typeof Ammo)return new Ammo.btSphereShape(a.radius)};return d}(Rc),Fp=function(g){function d(b){return g.call(this,
b)||this}K(d,g);d.prototype.createPhysicalShape=function(b,a){b=null;var c=void 0!==a.axis?a.axis:1,e=a.radius||.5;a=Math.max((a.height||2)-2*e,0);if("undefined"!==typeof Ammo)switch(c){case 0:b=new Ammo.btCapsuleShapeX(e,a);break;case 1:b=new Ammo.btCapsuleShape(e,a);break;case 2:b=new Ammo.btCapsuleShapeZ(e,a)}return b};return d}(Rc),Gp=function(g){function d(b){return g.call(this,b)||this}K(d,g);d.prototype.createPhysicalShape=function(b,a){var c=b=null,e=void 0!==a.axis?a.axis:1,f=void 0!==a.radius?
a.radius:.5;a=void 0!==a.height?a.height:1;if("undefined"!==typeof Ammo)switch(e){case 0:b=new Ammo.btVector3(.5*a,f,f);c=new Ammo.btCylinderShapeX(b);break;case 1:b=new Ammo.btVector3(f,.5*a,f);c=new Ammo.btCylinderShape(b);break;case 2:b=new Ammo.btVector3(f,f,.5*a),c=new Ammo.btCylinderShapeZ(b)}b&&Ammo.destroy(b);return c};return d}(Rc),Hp=function(g){function d(b){return g.call(this,b)||this}K(d,g);d.prototype.createPhysicalShape=function(b,a){b=null;var c=void 0!==a.axis?a.axis:1,e=void 0!==
a.radius?a.radius:.5;a=void 0!==a.height?a.height:1;if("undefined"!==typeof Ammo)switch(c){case 0:b=new Ammo.btConeShapeX(e,a);break;case 1:b=new Ammo.btConeShape(e,a);break;case 2:b=new Ammo.btConeShapeZ(e,a)}return b};return d}(Rc),Ip=function(g){function d(a){return g.call(this,a)||this}K(d,g);var b=d.prototype;b.beforeInitialize=function(a,c){};b.createPhysicalShape=function(a,c){if("undefined"!==typeof Ammo&&c.model){var e=c.model;c=new Ammo.btCompoundShape;var f,h;for(f=0;f<e.meshInstances.length;f++){var k=
e.meshInstances[f],m=k.mesh;if(this.system._triMeshCache[m.id])var n=this.system._triMeshCache[m.id];else{n=m.indexBuffer[0];var p=m.vertexBuffer,t=p.getFormat(),r=t.size/4,u;for(h=0;h<t.elements.length;h++){var v=t.elements[h];"POSITION"===v.name&&(u=new Float32Array(p.lock(),v.offset))}p=new Uint16Array(n.lock());t=m.primitive[0].count/3;v=new Ammo.btVector3;var w=new Ammo.btVector3,y=new Ammo.btVector3,x=m.primitive[0].base;n=new Ammo.btTriangleMesh;this.system._triMeshCache[m.id]=n;for(h=0;h<
t;h++){m=p[x+3*h]*r;var z=p[x+3*h+1]*r;var B=p[x+3*h+2]*r;v.setValue(u[m],u[m+1],u[m+2]);w.setValue(u[z],u[z+1],u[z+2]);y.setValue(u[B],u[B+1],u[B+2]);n.addTriangle(v,w,y,!0)}Ammo.destroy(v);Ammo.destroy(w);Ammo.destroy(y)}h=new Ammo.btBvhTriangleMeshShape(n,!0);r=this.system._getNodeScaling(k.node);h.setLocalScaling(r);Ammo.destroy(r);k=this.system._getNodeTransform(k.node);c.addChildShape(k,h);Ammo.destroy(k)}a=a.getWorldTransform().getScale();a=new Ammo.btVector3(a.x,a.y,a.z);c.setLocalScaling(a);
Ammo.destroy(a);return c}};b.recreatePhysicalShapes=function(a){null!==a.data.asset&&a.enabled&&a.entity.enabled?this.loadModelAsset(a):this.doRecreatePhysicalShape(a)};b.loadModelAsset=function(a){var c=this,e=a.data.asset,f=a.data,h=this.system.app.assets,k=h.get(e);if(k)k.ready(function(m){f.model=m.resource;c.doRecreatePhysicalShape(a)}),h.load(k);else h.once("add:"+e,function(m){m.ready(function(n){f.model=n.resource;c.doRecreatePhysicalShape(a)});h.load(m)})};b.doRecreatePhysicalShape=function(a){var c=
a.entity,e=a.data;e.model?(this.destroyShape(e),e.shape=this.createPhysicalShape(c,e),c.rigidbody?(c.rigidbody.disableSimulation(),c.rigidbody.createBody(),c.enabled&&c.rigidbody.enabled&&c.rigidbody.enableSimulation()):c.trigger?c.trigger.initialize(e):c.trigger=new Ql(this.system.app,a,e)):(this.beforeRemove(c,a),this.remove(c,e))};b.updateTransform=function(a,c,e,f){if(a.shape){var h=a.entity.getWorldTransform().getScale(),k=a.shape.getLocalScaling();h.x===k.x()&&h.y===k.y()&&h.z===k.z()||this.doRecreatePhysicalShape(a)}g.prototype.updateTransform.call(this,
a,c,e,f)};b.destroyShape=function(a){if(a.shape){for(var c=a.shape.getNumChildShapes(),e=0;e<c;e++){var f=a.shape.getChildShape(e);Ammo.destroy(f)}Ammo.destroy(a.shape);a.shape=null}};b.remove=function(a,c){this.destroyShape(c);g.prototype.remove.call(this,a,c)};return d}(Rc),Jp=function(g){function d(a){return g.call(this,a)||this}K(d,g);var b=d.prototype;b.createPhysicalShape=function(a,c){if("undefined"!==typeof Ammo)return new Ammo.btCompoundShape};b._addEachDescendant=function(a){a.collision&&
!a.rigidbody&&(a.collision._compoundParent=this,a!==this.entity&&a.collision.system.recreatePhysicalShapes(a.collision))};b._updateEachDescendant=function(a){a.collision&&a.collision._compoundParent===this&&(a.collision._compoundParent=null,a===this.entity||a.rigidbody||a.collision.system.recreatePhysicalShapes(a.collision))};b._updateEachDescendantTransform=function(a){a.collision&&a.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(a)};
return d}(Rc),Sl=function(g){function d(a){a=g.call(this,a)||this;a.id="collision";a.ComponentType=Uh;a.DataType=Ap;a.schema=Rl;a.implementations={};a._triMeshCache={};a.on("beforeremove",a.onBeforeRemove,F(a));a.on("remove",a.onRemove,F(a));return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c,e){e="type halfExtents radius axis height shape model asset enabled".split(" ");for(var f={},h=0,k=e.length;h<k;h++){var m=e[h];f[m]=c[m]}c.hasOwnProperty("asset")?(c=e.indexOf("model"),
-1!==c&&e.splice(c,1)):c.hasOwnProperty("model")&&(c=e.indexOf("asset"),-1!==c&&e.splice(c,1));f.type||(f.type=a.data.type);a.data.type=f.type;f.halfExtents&&Array.isArray(f.halfExtents)&&(f.halfExtents=new A(f.halfExtents[0],f.halfExtents[1],f.halfExtents[2]));c=this._createImplementation(f.type);c.beforeInitialize(a,f);g.prototype.initializeComponentData.call(this,a,f,e);c.afterInitialize(a,f)};b._createImplementation=function(a){if(void 0===this.implementations[a]){switch(a){case "box":var c=new Dp(this);
break;case "sphere":c=new Ep(this);break;case "capsule":c=new Fp(this);break;case "cylinder":c=new Gp(this);break;case "cone":c=new Hp(this);break;case "mesh":c=new Ip(this);break;case "compound":c=new Jp(this)}this.implementations[a]=c}return this.implementations[a]};b._getImplementation=function(a){return this.implementations[a.collision.data.type]};b.cloneComponent=function(a,c){return this._getImplementation(a).clone(a,c)};b.onBeforeRemove=function(a,c){this.implementations[c.data.type].beforeRemove(a,
c);c.onBeforeRemove()};b.onRemove=function(a,c){this.implementations[c.type].remove(a,c)};b.updateCompoundChildTransform=function(a){this._removeCompoundChild(a.collision._compoundParent,a.collision.data.shape);if(a.enabled&&a.collision.enabled){var c=this._getNodeTransform(a,a.collision._compoundParent.entity);a.collision._compoundParent.shape.addChildShape(c,a.collision.data.shape);Ammo.destroy(c)}};b._removeCompoundChild=function(a,c){a.shape.removeChildShape?a.shape.removeChildShape(c):(c=a._getCompoundChildShapeIndex(c),
null!==c&&a.shape.removeChildShapeByIndex(c))};b.onTransformChanged=function(a,c,e,f){this.implementations[a.data.type].updateTransform(a,c,e,f)};b.changeType=function(a,c,e){this.implementations[c].beforeRemove(a.entity,a);this.implementations[c].remove(a.entity,a.data);this._createImplementation(e).reset(a,a.data)};b.recreatePhysicalShapes=function(a){this.implementations[a.data.type].recreatePhysicalShapes(a)};b._calculateNodeRelativeTransform=function(a,c){a===c?(a=a.getWorldTransform().getScale(),
Sf.setScale(a.x,a.y,a.z)):(this._calculateNodeRelativeTransform(a.parent,c),Sf.mul(a.getLocalTransform()))};b._getNodeScaling=function(a){a=a.getWorldTransform().getScale();return new Ammo.btVector3(a.x,a.y,a.z)};b._getNodeTransform=function(a,c){c?(this._calculateNodeRelativeTransform(a,c),c=Bp,a=Cp,Sf.getTranslation(c),a.setFromMat4(Sf)):(c=a.getPosition(),a=a.getRotation());var e=new Ammo.btTransform;e.setIdentity();var f=e.getOrigin();f.setValue(c.x,c.y,c.z);c=new Ammo.btQuaternion;c.setValue(a.x,
a.y,a.z,a.w);e.setRotation(c);Ammo.destroy(c);Ammo.destroy(f);return e};b.destroy=function(){for(var a in this._triMeshCache)Ammo.destroy(this._triMeshCache[a]);this._triMeshCache=null;g.prototype.destroy.call(this)};return d}(O);ca._buildAccessors(Uh.prototype,Rl);var Tl=function(){function g(){this.list=[]}var d=g.prototype;d.add=function(b){var a=b.id;if(this[a])throw Error("ComponentSystem name '"+a+"' already registered or not allowed");this[a]=b;this.list.push(b)};d.remove=function(b){b=b.id;
if(!this[b])throw Error("No ComponentSystem named '"+b+"' registered");delete this[b];b=this.list.indexOf(this[b]);-1!==b&&this.list.splice(b,1)};return g}(),ue=function(){function g(d){this.func=void 0===d.func?7:d.func;this.ref=d.ref||0;this.readMask=void 0===d.readMask?255:d.readMask;this.writeMask=void 0===d.writeMask?255:d.writeMask;this.fail=d.fail||0;this.zfail=d.zfail||0;this.zpass=d.zpass||0}g.prototype.clone=function(){return new g({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,
fail:this.fail,zfail:this.zfail,zpass:this.zpass})};return g}(),Kp=function(){function g(b,a,c){this._entity=b;this._element=b.element;this.model=new fb;this.node=new pa;this.model.graph=this.node;this.mesh=a;this.meshInstance=new Ga(this.node,this.mesh,c);this.meshInstance.name="ImageElement: "+b.name;this.meshInstance.castShadow=!1;this._meshDirty=this.meshInstance.receiveShadow=!1;this.model.meshInstances.push(this.meshInstance);this._entity.addChild(this.model.graph);this.model._entity=this._entity;
this.unmaskMeshInstance=null}var d=g.prototype;d.destroy=function(){this.setMaterial(null);this._element.removeModelFromLayers(this.model);this.model.destroy();this._element=this._entity=this.meshInstance=this.mesh=this.node=this.model=null};d.setMesh=function(b){this.meshInstance&&(this.mesh=b,this.meshInstance.mesh=b,this.meshInstance.visible=!!b,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=b),this.forceUpdateAabb())};d.setMask=function(b){if(this.meshInstance){if(b){this.unmaskMeshInstance=
new Ga(this.node,this.mesh,this.meshInstance.material);this.unmaskMeshInstance.name="Unmask: "+this._entity.name;this.unmaskMeshInstance.castShadow=!1;this.unmaskMeshInstance.receiveShadow=!1;this.unmaskMeshInstance.pick=!1;this.model.meshInstances.push(this.unmaskMeshInstance);for(var a in this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(a,this.meshInstance.parameters[a].data)}else b=this.model.meshInstances.indexOf(this.unmaskMeshInstance),0<=b&&this.model.meshInstances.splice(b,
1),this.unmaskMeshInstance=null;this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}};d.setMaterial=function(b){this.meshInstance&&(this.meshInstance.material=b,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=b))};d.setParameter=function(b,a){this.meshInstance&&(this.meshInstance.setParameter(b,a),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(b,a))};d.deleteParameter=function(b){this.meshInstance&&
(this.meshInstance.deleteParameter(b),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(b))};d.setUnmaskDrawOrder=function(){if(this.meshInstance){var b=function e(c){var f;c=c.children;var h=c.length;if(h){for(var k=0;k<h;k++)c[k].element&&(f=c[k]);return f?(c=e(f))?c:f:null}return null};this.unmaskMeshInstance&&(b=b(this._entity),this.unmaskMeshInstance.drawOrder=b&&b.element?b.element.drawOrder+b.element.getMaskOffset():this.meshInstance.drawOrder+this._element.getMaskOffset())}};
d.setDrawOrder=function(b){this.meshInstance&&(this.meshInstance.drawOrder=b)};d.setCull=function(b){if(this.meshInstance){var a=this._element,c=null;b&&a._isScreenCulled()&&(c=function(e){return a.isVisibleForCamera(e)});this.meshInstance.cull=b;this.meshInstance.isVisibleFunc=c;this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=b,this.unmaskMeshInstance.isVisibleFunc=c)}};d.setScreenSpace=function(b){this.meshInstance&&(this.meshInstance.screenSpace=b,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=
b))};d.setLayer=function(b){this.meshInstance&&(this.meshInstance.layer=b,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=b))};d.forceUpdateAabb=function(b){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))};d.setAabbFunc=function(b){this.meshInstance&&(this.meshInstance._updateAabbFunc=b,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=b))};return g}(),Ul=function(){function g(b){this._element=b;this._entity=
b.entity;this._system=b.system;this._sprite=this._spriteAsset=this._material=this._materialAsset=this._texture=this._textureAsset=null;this._spriteFrame=0;this._pixelsPerUnit=null;this._rect=new Z(0,0,1,1);this._mask=!1;this._maskRef=0;this._outerScale=new S;this._outerScaleUniform=new Float32Array(2);this._innerOffset=new Z;this._innerOffsetUniform=new Float32Array(4);this._atlasRect=new Z;this._atlasRectUniform=new Float32Array(4);this._defaultMesh=this._createMesh();this._renderable=new Kp(this._entity,
this._defaultMesh,this._material);this._color=new Q(1,1,1,1);this._colorUniform=new Float32Array([1,1,1]);this._renderable.setParameter("material_emissive",this._colorUniform);this._renderable.setParameter("material_opacity",1);this._updateAabbFunc=this._updateAabb.bind(this);this._onScreenChange(this._element.screen);this._element.on("resize",this._onParentResizeOrPivotChange,this);this._element.on("set:pivot",this._onParentResizeOrPivotChange,this);this._element.on("screen:set:screenspace",this._onScreenSpaceChange,
this);this._element.on("set:screen",this._onScreenChange,this);this._element.on("set:draworder",this._onDrawOrderChange,this);this._element.on("screen:set:resolution",this._onResolutionChange,this)}var d=g.prototype;d.destroy=function(){this.materialAsset=this.spriteAsset=this.textureAsset=null;this._renderable.setMesh(this._defaultMesh);this._renderable.destroy();this._defaultMesh=null;this._element.off("resize",this._onParentResizeOrPivotChange,this);this._element.off("set:pivot",this._onParentResizeOrPivotChange,
this);this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this);this._element.off("set:screen",this._onScreenChange,this);this._element.off("set:draworder",this._onDrawOrderChange,this);this._element.off("screen:set:resolution",this._onResolutionChange,this)};d._onResolutionChange=function(b){};d._onParentResizeOrPivotChange=function(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)};d._onScreenSpaceChange=function(b){this._updateMaterial(b)};d._onScreenChange=function(b,
a){b?this._updateMaterial(b.screen.screenSpace):this._updateMaterial(!1)};d._onDrawOrderChange=function(b){this._renderable.setDrawOrder(b);if(this.mask&&this._element.screen)this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder()},this)};d._hasUserMaterial=function(){return!!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)};d._use9Slicing=function(){return this.sprite&&(1===this.sprite.renderMode||2===
this.sprite.renderMode)};d._updateMaterial=function(b){var a=!!this._mask,c=!(!this.sprite||1!==this.sprite.renderMode),e=!(!this.sprite||2!==this.sprite.renderMode);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(b,a,c,e));this._renderable&&(this._renderable.setCull(!0),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(b),this._renderable.setLayer(b?0:15))};d._createMesh=function(){var b=this._element,a=b.calculatedWidth;b=b.calculatedHeight;
var c=this._rect,e=new ArrayBuffer(128),f=new Float32Array(e);f[5]=1;f[6]=c.x;f[7]=c.y;f[8]=a;f[13]=1;f[14]=c.x+c.z;f[15]=c.y;f[16]=a;f[17]=b;f[21]=1;f[22]=c.x+c.z;f[23]=c.y+c.w;f[25]=b;f[29]=1;f[30]=c.x;f[31]=c.y+c.w;c=this._system.app.graphicsDevice;f=new Ma(c,[{semantic:"POSITION",components:3,type:6},{semantic:"NORMAL",components:3,type:6},{semantic:"TEXCOORD0",components:2,type:6}]);e=new Ra(c,f,4,0,e);c=new bb(c);c.vertexBuffer=e;c.primitive[0].type=6;c.primitive[0].base=0;c.primitive[0].count=
4;c.primitive[0].indexed=!1;c.aabb.setMinMax(A.ZERO,new A(a,b,0));this._updateMesh(c);return c};d._updateMesh=function(b){var a=this._element,c=a.calculatedWidth,e=a.calculatedHeight,f=a._isScreenSpace();this._updateMaterial(f);this._renderable&&this._renderable.forceUpdateAabb();if(!this.sprite||1!==this.sprite.renderMode&&2!==this.sprite.renderMode){var h=b.vertexBuffer,k=new Float32Array(h.lock());f=a.pivot.x;a=a.pivot.y;k[0]=-(f*c);k[1]=-(a*e);k[8]=c-f*c;k[9]=-(a*e);k[16]=c-f*c;k[17]=e-a*e;k[24]=
-(f*c);k[25]=e-a*e;var m=1,n=1,p=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){var t=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];t&&(p=t.rect,m=this._sprite.atlas.texture.width,n=this._sprite.atlas.texture.height)}k[6]=p.x/m;k[7]=p.y/n;k[14]=(p.x+p.z)/m;k[15]=p.y/n;k[22]=(p.x+p.z)/m;k[23]=(p.y+p.w)/n;k[30]=p.x/m;k[31]=(p.y+p.w)/n;h.unlock();h=new A(-(f*c),-(a*e),0);c=new A(c-f*c,e-a*e,0);b.aabb.setMinMax(h,c);this._renderable&&
(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}else b=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],f=2/b.rect.z,h=2/b.rect.w,this._innerOffset.set(b.border.x*f,b.border.y*h,b.border.z*f,b.border.w*h),f=this.sprite.atlas.texture,this._atlasRect.set(b.rect.x/f.width,b.rect.y/f.height,b.rect.z/f.width,b.rect.w/f.height),h=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,f=b.rect.z/
h,b=b.rect.w/h,this._outerScale.set(Math.max(c,this._innerOffset.x*f),Math.max(e,this._innerOffset.y*b)),h=b,this._outerScale.x/=f,this._outerScale.y/=b,f*=R.clamp(c/(this._innerOffset.x*f),1E-4,1),h*=R.clamp(e/(this._innerOffset.y*b),1E-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),
this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(f,h,1),this._renderable.node.setLocalPosition((.5-
a.pivot.x)*c,(.5-a.pivot.y)*e,0));this._meshDirty=!1};d._updateSprite=function(){var b=!1,a=null;this._sprite&&this._sprite.atlas&&(a=this._sprite.meshes[this.spriteFrame],b=1===this._sprite.renderMode||2===this._sprite.renderMode);if(this.mesh=b?a:this._defaultMesh)this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh)};d._updateAabb=function(b){b.center.set(0,0,0);b.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001);b.setFromTransformedAabb(b,this._renderable.node.getWorldTransform());
return b};d._toggleMask=function(){this._element._dirtifyMask();var b=this._element._isScreenSpace();this._updateMaterial(b);this._renderable.setMask(!!this._mask)};d._onMaterialLoad=function(b){this.material=b.resource};d._onMaterialAdded=function(b){this._system.app.assets.off("add:"+b.id,this._onMaterialAdded,this);this._materialAsset===b.id&&this._bindMaterialAsset(b)};d._bindMaterialAsset=function(b){this._entity.enabled&&(b.on("load",this._onMaterialLoad,this),b.on("change",this._onMaterialChange,
this),b.on("remove",this._onMaterialRemove,this),b.resource?this._onMaterialLoad(b):this._system.app.assets.load(b))};d._unbindMaterialAsset=function(b){b.off("load",this._onMaterialLoad,this);b.off("change",this._onMaterialChange,this);b.off("remove",this._onMaterialRemove,this)};d._onMaterialChange=function(){};d._onMaterialRemove=function(){};d._onTextureAdded=function(b){this._system.app.assets.off("add:"+b.id,this._onTextureAdded,this);this._textureAsset===b.id&&this._bindTextureAsset(b)};d._bindTextureAsset=
function(b){this._entity.enabled&&(b.on("load",this._onTextureLoad,this),b.on("change",this._onTextureChange,this),b.on("remove",this._onTextureRemove,this),b.resource?this._onTextureLoad(b):this._system.app.assets.load(b))};d._unbindTextureAsset=function(b){b.off("load",this._onTextureLoad,this);b.off("change",this._onTextureChange,this);b.off("remove",this._onTextureRemove,this)};d._onTextureLoad=function(b){this.texture=b.resource};d._onTextureChange=function(b){};d._onTextureRemove=function(b){};
d._onSpriteAssetAdded=function(b){this._system.app.assets.off("add:"+b.id,this._onSpriteAssetAdded,this);this._spriteAsset===b.id&&this._bindSpriteAsset(b)};d._bindSpriteAsset=function(b){this._entity.enabled&&(b.on("load",this._onSpriteAssetLoad,this),b.on("change",this._onSpriteAssetChange,this),b.on("remove",this._onSpriteAssetRemove,this),b.resource?this._onSpriteAssetLoad(b):this._system.app.assets.load(b))};d._unbindSpriteAsset=function(b){b.off("load",this._onSpriteAssetLoad,this);b.off("change",
this._onSpriteAssetChange,this);b.off("remove",this._onSpriteAssetRemove,this);b.data.textureAtlasAsset&&this._system.app.assets.off("load:"+b.data.textureAtlasAsset,this._onTextureAtlasLoad,this)};d._onSpriteAssetLoad=function(b){if(b&&b.resource)if(b.resource.atlas)this.sprite=b.resource;else{if(b=b.data.textureAtlasAsset){var a=this._system.app.assets;a.off("load:"+b,this._onTextureAtlasLoad,this);a.once("load:"+b,this._onTextureAtlasLoad,this)}}else this.sprite=null};d._onSpriteAssetChange=function(b){this._onSpriteAssetLoad(b)};
d._onSpriteAssetRemove=function(b){};d._bindSprite=function(b){b.on("set:meshes",this._onSpriteMeshesChange,this);b.on("set:pixelsPerUnit",this._onSpritePpuChange,this);b.on("set:atlas",this._onAtlasTextureChange,this);if(b.atlas)b.atlas.on("set:texture",this._onAtlasTextureChange,this)};d._unbindSprite=function(b){b.off("set:meshes",this._onSpriteMeshesChange,this);b.off("set:pixelsPerUnit",this._onSpritePpuChange,this);b.off("set:atlas",this._onAtlasTextureChange,this);b.atlas&&b.atlas.off("set:texture",
this._onAtlasTextureChange,this)};d._onSpriteMeshesChange=function(){this._sprite&&(this._spriteFrame=R.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1));this._updateSprite()};d._onSpritePpuChange=function(){0!==this.sprite.renderMode&&null===this._pixelsPerUnit&&this._updateSprite()};d._onAtlasTextureChange=function(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",
this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))};d._onTextureAtlasLoad=function(b){b=this._spriteAsset;b instanceof fa?this._onSpriteAssetLoad(b):this._onSpriteAssetLoad(this._system.app.assets.get(b))};d.onEnable=function(){var b;this._materialAsset&&(b=this._system.app.assets.get(this._materialAsset))&&b.resource!==this._material&&this._bindMaterialAsset(b);this._textureAsset&&(b=this._system.app.assets.get(this._textureAsset))&&
b.resource!==this._texture&&this._bindTextureAsset(b);this._spriteAsset&&(b=this._system.app.assets.get(this._spriteAsset))&&b.resource!==this._sprite&&this._bindSpriteAsset(b);this._element.addModelToLayers(this._renderable.model)};d.onDisable=function(){this._element.removeModelFromLayers(this._renderable.model)};d._setStencil=function(b){this._renderable.meshInstance.stencilFront=b;this._renderable.meshInstance.stencilBack=b;b=0;this._element.maskedBy&&(b=this._element.maskedBy.element._image._maskRef);
this._renderable.unmaskMeshInstance&&(b=new ue({ref:b+1,func:2,zpass:5}),this._renderable.unmaskMeshInstance.stencilFront=b,this._renderable.unmaskMeshInstance.stencilBack=b)};N(g,[{key:"color",get:function(){return this._color},set:function(b){var a=b.r,c=b.g;b=b.b;if(this._color.r!==a||this._color.g!==c||this._color.b!==b)this._color.r=a,this._color.g=c,this._color.b=b,this._colorUniform[0]=a,this._colorUniform[1]=c,this._colorUniform[2]=b,this._renderable.setParameter("material_emissive",this._colorUniform),
this._element&&this._element.fire("set:color",this._color)}},{key:"opacity",get:function(){return this._color.a},set:function(b){b!==this._color.a&&(this._color.a=b,this._renderable.setParameter("material_opacity",b),this._element&&this._element.fire("set:opacity",b))}},{key:"rect",get:function(){return this._rect},set:function(b){if(b instanceof Z){var a=b.x;var c=b.y;var e=b.z;b=b.w}else a=b[0],c=b[1],e=b[2],b=b[3];if(a!==this._rect.x||c!==this._rect.y||e!==this._rect.z||b!==this._rect.w)this._rect.set(a,
c,e,b),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh))}},{key:"material",get:function(){return this._material},set:function(b){this._material!==b&&(b||(b=this._element._isScreenSpace(),b=this.mask?b?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:b?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial),this._material=b)&&(this._renderable.setMaterial(b),this._hasUserMaterial()?
(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}},{key:"materialAsset",get:function(){return this._materialAsset},set:function(b){var a=this._system.app.assets,c=b;b instanceof fa&&(c=b.id);this._materialAsset!==
c&&(this._materialAsset&&(a.off("add:"+this._materialAsset,this._onMaterialAdded,this),b=a.get(this._materialAsset))&&(b.off("load",this._onMaterialLoad,this),b.off("change",this._onMaterialChange,this),b.off("remove",this._onMaterialRemove,this)),(this._materialAsset=c)?(c=a.get(this._materialAsset))?this._bindMaterialAsset(c):(this.material=null,a.on("add:"+this._materialAsset,this._onMaterialAdded,this)):this.material=null)}},{key:"texture",get:function(){return this._texture},set:function(b){if(this._texture!==
b){if(this._textureAsset){var a=this._system.app.assets.get(this._textureAsset);a&&a.resource!==b&&(this.textureAsset=null)}(this._texture=b)?(this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",
this._color.a)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}}},{key:"textureAsset",get:function(){return this._textureAsset},set:function(b){var a=this._system.app.assets,c=b;b instanceof fa&&(c=b.id);this._textureAsset!==c&&(this._textureAsset&&(a.off("add:"+this._textureAsset,this._onTextureAdded,this),b=a.get(this._textureAsset))&&(b.off("load",this._onTextureLoad,this),b.off("change",this._onTextureChange,this),b.off("remove",
this._onTextureRemove,this)),(this._textureAsset=c)?(c=a.get(this._textureAsset))?this._bindTextureAsset(c):(this.texture=null,a.on("add:"+this._textureAsset,this._onTextureAdded,this)):this.texture=null)}},{key:"spriteAsset",get:function(){return this._spriteAsset},set:function(b){var a=this._system.app.assets,c=b;b instanceof fa&&(c=b.id);this._spriteAsset!==c&&(this._spriteAsset&&(a.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this),(b=a.get(this._spriteAsset))&&this._unbindSpriteAsset(b)),
(this._spriteAsset=c)?(b=a.get(this._spriteAsset))?this._bindSpriteAsset(b):(this.sprite=null,a.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)):this.sprite=null,this._element&&this._element.fire("set:spriteAsset",c))}},{key:"sprite",get:function(){return this._sprite},set:function(b){if(this._sprite!==b){this._sprite&&this._unbindSprite(this._sprite);if(this._spriteAsset){var a=this._system.app.assets.get(this._spriteAsset);a&&a.resource!==b&&(this.spriteAsset=null)}if(this._sprite=b)this._bindSprite(this._sprite),
this._textureAsset&&(this.textureAsset=null);this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"));this._sprite&&(this._spriteFrame=R.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1));this._updateSprite()}}},{key:"spriteFrame",
get:function(){return this._spriteFrame},set:function(b){var a=this._spriteFrame;this._spriteFrame=this._sprite?R.clamp(b,0,this._sprite.frameKeys.length-1):b;this._spriteFrame!==a&&(this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",b))}},{key:"mesh",get:function(){return this._renderable.mesh},set:function(b){this._renderable.setMesh(b);this._defaultMesh===b?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}},{key:"mask",get:function(){return this._mask},
set:function(b){this._mask!==b&&(this._mask=b,this._toggleMask())}},{key:"pixelsPerUnit",get:function(){return this._pixelsPerUnit},set:function(b){this._pixelsPerUnit!==b&&(this._pixelsPerUnit=b,!this._sprite||1!==this._sprite.renderMode&&2!==this._sprite.renderMode||this._updateSprite())}},{key:"aabb",get:function(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}]);return g}(),Vl=function(g){function d(a){var c=g.call(this)||this;c._app=a;a.i18n.on("set:locale",c._onSetLocale,
F(c));c._autoLoad=!1;c._disableLocalization=!1;c._defaultAsset=null;c._localizedAsset=null;return c}K(d,g);var b=d.prototype;b._bindDefaultAsset=function(){var a=this._app.assets.get(this._defaultAsset);if(a)this._onDefaultAssetAdd(a);else this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)};b._unbindDefaultAsset=function(){if(this._defaultAsset){this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);var a=this._app.assets.get(this._defaultAsset);a&&
(a.off("add:localized",this._onLocaleAdd,this),a.off("remove:localized",this._onLocaleRemove,this),a.off("remove",this._onDefaultAssetRemove,this))}};b._onDefaultAssetAdd=function(a){this._defaultAsset===a.id&&(a.on("add:localized",this._onLocaleAdd,this),a.on("remove:localized",this._onLocaleRemove,this),a.once("remove",this._onDefaultAssetRemove,this))};b._onDefaultAssetRemove=function(a){this._defaultAsset===a.id&&(a.off("add:localized",this._onLocaleAdd,this),a.off("remove:localized",this._onLocaleAdd,
this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))};b._bindLocalizedAsset=function(){if(this._autoLoad){var a=this._app.assets.get(this._localizedAsset);a&&(a.on("load",this._onLocalizedAssetLoad,this),a.on("change",this._onLocalizedAssetChange,this),a.on("remove",this._onLocalizedAssetRemove,this),a.resource?this._onLocalizedAssetLoad(a):this._app.assets.load(a))}};b._unbindLocalizedAsset=function(){var a=this._app.assets.get(this._localizedAsset);a&&(a.off("load",
this._onLocalizedAssetLoad,this),a.off("change",this._onLocalizedAssetChange,this),a.off("remove",this._onLocalizedAssetRemove,this))};b._onLocalizedAssetAdd=function(a){this._localizedAsset===a.id&&this._bindLocalizedAsset()};b._onLocalizedAssetLoad=function(a){this.fire("load",a)};b._onLocalizedAssetChange=function(a,c,e,f){this.fire("change",a,c,e,f)};b._onLocalizedAssetRemove=function(a){this._localizedAsset===a.id&&(this.localizedAsset=this._defaultAsset);this.fire("remove",a)};b._onLocaleAdd=
function(a,c){this._app.i18n.locale===a&&this._onSetLocale(a)};b._onLocaleRemove=function(a,c){this._app.i18n.locale===a&&this._onSetLocale(a)};b._onSetLocale=function(a){if(this._defaultAsset){var c=this._app.assets.get(this._defaultAsset);this.localizedAsset=!c||this._disableLocalization?this._defaultAsset:(a=c.getLocalizedAssetId(a))?a:this._defaultAsset}else this.localizedAsset=null};b.destroy=function(){this.defaultAsset=null;this._app.i18n.off("set:locale",this._onSetLocale,this);this.off()};
N(d,[{key:"defaultAsset",get:function(){return this._defaultAsset},set:function(a){a=a instanceof fa?a.id:a;this._defaultAsset!==a&&(this._defaultAsset&&this._unbindDefaultAsset(),(this._defaultAsset=a)&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}},{key:"localizedAsset",get:function(){return this._localizedAsset},set:function(a){a=a instanceof fa?a.id:a;if(this._localizedAsset!==a&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,
this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=a))if(this._app.assets.get(this._localizedAsset))this._bindLocalizedAsset();else this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)}},{key:"autoLoad",get:function(){return this._autoLoad},set:function(a){this._autoLoad!==a&&(this._autoLoad=a)&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset())}},{key:"disableLocalization",get:function(){return this._disableLocalization},
set:function(a){this._disableLocalization!==a&&(this._disableLocalization=a,this._onSetLocale(this._app.i18n.locale))}}]);return d}(ba),Lp=/[A-Z|a-z|0-9|_|-|/]/,Mp=function(){function g(b){this._symbols=b;this._last=this._index=0;this._cur=0<this._symbols.length?this._symbols[0]:null;this._buf=[];this._mode="text";this._error=null}var d=g.prototype;d.read=function(){for(var b=this._read();8===b;)b=this._read();0!==b&&1!==b&&(this._last=this._index);return b};d.buf=function(){return this._buf};d.last=
function(){return this._last};d.error=function(){return this._error};d.debugPrint=function(){for(var b="EOF ERROR TEXT OPEN_BRACKET CLOSE_BRACKET EQUALS STRING IDENTIFIER WHITESPACE".split(" "),a=this.read(),c="";;){c+=(0<c.length?"\n":"")+b[a]+" '"+this.buf().join("")+"'";if(0===a||1===a)break;a=this.read()}return c};d._read=function(){this._buf=[];return this._eof()?0:"text"===this._mode?this._text():this._tag()};d._text=function(){for(;;)switch(this._cur){case null:return 0<this._buf.length?2:
0;case "[":return this._mode="tag",0<this._buf.length?2:this._tag();case "\\":this._next();switch(this._cur){case "[":this._store();break;default:this._output("\\")}break;default:this._store()}};d._tag=function(){for(;;)switch(this._cur){case null:return this._error="unexpected end of input reading tag",1;case "[":return this._store(),3;case "]":return this._store(),this._mode="text",4;case "=":return this._store(),5;case " ":case "\t":case "\n":case "\r":case "\v":case "\f":return this._whitespace();
case '"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",1)}};d._whitespace=function(){for(this._store();-1!==" \t\n\r\v\f".indexOf(this._cur);)this._store();return 8};d._string=function(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",1;case '"':return this._next(),6;default:this._store()}};d._identifier=function(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();
return 7};d._isIdentifierSymbol=function(b){return 1===b.length&&null!==b.match(Lp)};d._eof=function(){return null===this._cur};d._next=function(){this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null);return this._cur};d._store=function(){this._buf.push(this._cur);return this._next()};d._output=function(b){this._buf.push(b)};return g}(),Qn=function(){function g(b){this._scanner=new Mp(b);this._error=null}var d=g.prototype;d.parse=function(b,a){for(;;)switch(this._scanner.read()){case 0:return!0;
case 1:return!1;case 2:Array.prototype.push.apply(b,this._scanner.buf());break;case 3:if(!this._parseTag(b,a))return!1;break;default:return!1}};d.error=function(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"};d._parseTag=function(b,a){var c=this._scanner.read();if(7!==c)return this._error="expected identifier",!1;c=this._scanner.buf().join("");if("/"===c[0]){for(var e=a.length-1;0<=e;--e)if(c==="/"+a[e].name&&null===a[e].end)return a[e].end=
b.length,c=this._scanner.read(),4!==c?(this._error="expected close bracket",!1):!0;this._error="failed to find matching tag";return!1}b={name:c,value:null,attributes:{},start:b.length,end:null};c=this._scanner.read();if(5===c){c=this._scanner.read();if(6!==c)return this._error="expected string",!1;b.value=this._scanner.buf().join("");c=this._scanner.read()}for(;;){switch(c){case 4:return a.push(b),!0;case 7:e=this._scanner.buf().join("");c=this._scanner.read();if(5!==c)return this._error="expected equals",
!1;c=this._scanner.read();if(6!==c)return this._error="expected string",!1;c=this._scanner.buf().join("");b.attributes[e]=c;break;default:return this._error="expected close bracket or identifier",!1}c=this._scanner.read()}};return g}(),Np=function(){function g(){}g.evaluate=function(d){return Pn(d)};return g}(),Op=function(){this.quad=this.count=0;this.lines={};this.positions=[];this.normals=[];this.uvs=[];this.colors=[];this.indices=[];this.meshInstance=null},Wl=/^[\r\n]$/,Pp=/^[ \t]$/,Qp=/^[ \t\-]$/,
Rp="\u061c\u200e\u200f\u202a\u202b\u202c\u202d\u202e\u2066\u2067\u2068\u2069".split(""),Sp={width:0,height:0,xadvance:0,xoffset:0,yoffset:0},Xl=function(){function g(b){this._element=b;this._system=b.system;this._entity=b.entity;this._text="";this._symbols=[];this._colorPalette=[];this._i18nKey=this._symbolColors=null;this._fontAsset=new Vl(this._system.app);this._fontAsset.disableLocalization=!0;this._fontAsset.on("load",this._onFontLoad,this);this._fontAsset.on("change",this._onFontChange,this);
this._fontAsset.on("remove",this._onFontRemove,this);this._font=null;this._color=new Q(1,1,1,1);this._colorUniform=new Float32Array(3);this._spacing=1;this._fontSize=32;this._fontMaxY=this._fontMinY=0;this._maxFontSize=this._originalFontSize=32;this._minFontSize=8;this._autoFitHeight=this._autoFitWidth=!1;this._maxLines=-1;this._scaledLineHeight=this._lineHeight=32;this._wrapLines=!1;this._drawOrder=0;this._alignment=new S(.5,.5);this._autoHeight=this._autoWidth=!0;this.height=this.width=0;this._node=
new pa;this._model=new fb;this._model.graph=this._node;this._entity.addChild(this._node);this._meshInfo=[];this._material=null;this._aabbDirty=!0;this._aabb=new la;this._noResize=!1;this._maskedMaterialSrc=this._currentMaterialType=null;this._rtl=this._unicodeConverter=this._rtlReorder=!1;this._outlineColor=new Q(0,0,0,1);this._outlineColorUniform=new Float32Array(4);this._outlineThicknessScale=.2;this._outlineThickness=0;this._shadowColor=new Q(0,0,0,1);this._shadowColorUniform=new Float32Array(4);
this._shadowOffsetScale=.005;this._shadowOffset=new S(0,0);this._shadowOffsetUniform=new Float32Array(2);this._enableMarkup=!1;this._onScreenChange(this._element.screen);b.on("resize",this._onParentResize,this);b.on("set:screen",this._onScreenChange,this);b.on("screen:set:screenspace",this._onScreenSpaceChange,this);b.on("set:draworder",this._onDrawOrderChange,this);b.on("set:pivot",this._onPivotChange,this);this._system.app.i18n.on("set:locale",this._onLocaleSet,this);this._system.app.i18n.on("data:add",
this._onLocalizationData,this);this._system.app.i18n.on("data:remove",this._onLocalizationData,this);this._rangeEnd=this._rangeStart=0}var d=g.prototype;d.destroy=function(){this._setMaterial(null);this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null);this._fontAsset.destroy();this.font=null;this._element.off("resize",this._onParentResize,this);this._element.off("set:screen",this._onScreenChange,this);this._element.off("screen:set:screenspace",this._onScreenSpaceChange,
this);this._element.off("set:draworder",this._onDrawOrderChange,this);this._element.off("set:pivot",this._onPivotChange,this);this._system.app.i18n.off("set:locale",this._onLocaleSet,this);this._system.app.i18n.off("data:add",this._onLocalizationData,this);this._system.app.i18n.off("data:remove",this._onLocalizationData,this)};d._onParentResize=function(b,a){this._noResize||this._font&&this._updateText()};d._onScreenChange=function(b){b?this._updateMaterial(b.screen.screenSpace):this._updateMaterial(!1)};
d._onScreenSpaceChange=function(b){this._updateMaterial(b)};d._onDrawOrderChange=function(b){this._drawOrder=b;if(this._model){var a;var c=0;for(a=this._model.meshInstances.length;c<a;c++)this._model.meshInstances[c].drawOrder=b}};d._onPivotChange=function(b){this._font&&this._updateText()};d._onLocaleSet=function(b){this._i18nKey&&(this.fontAsset&&(b=this._system.app.assets.get(this.fontAsset),b&&b.resource&&b.resource===this._font||(this.font=null)),this._resetLocalizedText())};d._onLocalizationData=
function(b,a){this._i18nKey&&a[this._i18nKey]&&this._resetLocalizedText()};d._resetLocalizedText=function(){this._setText(this._system.app.i18n.getText(this._i18nKey))};d._setText=function(b){if(this.unicodeConverter){var a=this._system.getUnicodeConverter();a?b=a(b):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==b&&(this._font&&this._updateText(b),this._text=b)};d._updateText=function(b){var a;void 0===b&&(b=this._text);this._symbols=
Eb.getSymbols(b);0===this._symbols.length&&(this._symbols=[" "]);if(this._enableMarkup){b=Np.evaluate(this._symbols);this._symbols=b.symbols;var c=b.tags}this._rtlReorder?(b=this._system.app.systems.element.getRtlReorder())?(b=b(this._symbols),this._rtl=b.rtl,this._symbols=b.mapping.map(function(u){return this._symbols[u]},this),c&&(c=b.mapping.map(function(u){return c[u]}))):console.warn("Element created with rtlReorder option but no rtlReorder function registered"):this._rtl=!1;if(c){var e={};this._colorPalette=
[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)];this._symbolColors=[];b=e[this._color.toString(!1).toLowerCase()]=0;for(a=this._symbols.length;b<a;++b){var f=c[b],h=0;f&&f.color&&f.color.value&&(f=f.color.value,7===f.length&&"#"===f[0]&&(f=f.substring(1).toLowerCase(),e.hasOwnProperty(f)?h=e[f]:/^([0-9a-f]{2}){3}$/.test(f)&&(h=this._colorPalette.length/3,e[f]=h,this._colorPalette.push(parseInt(f.substring(0,2),16)),this._colorPalette.push(parseInt(f.substring(2,
4),16)),this._colorPalette.push(parseInt(f.substring(4,6),16)))));this._symbolColors.push(h)}}else this._colorPalette=[],this._symbolColors=null;e=this._calculateCharsPerTexture();h=!1;var k=this._element;f=k._isScreenSpace();var m=k._isScreenCulled(),n=function(u){return k.isVisibleForCamera(u)};b=0;for(a=this._meshInfo.length;b<a;b++){var p=e[b]||0,t=this._meshInfo[b];if(t.count!==p)if(h||(k.removeModelFromLayers(this._model),h=!0),t.count=p,t.positions.length=t.normals.length=12*p,t.indices.length=
6*p,t.uvs.length=8*p,t.colors.length=16*p,t.meshInstance&&this._removeMeshInstance(t.meshInstance),0===p)t.meshInstance=null;else{for(var r=0;r<p;r++)t.indices[6*r]=4*r,t.indices[6*r+1]=4*r+1,t.indices[6*r+2]=4*r+3,t.indices[6*r+3]=4*r+2,t.indices[6*r+4]=4*r+3,t.indices[6*r+5]=4*r+1,t.normals[12*r]=0,t.normals[12*r+1]=0,t.normals[12*r+2]=-1,t.normals[12*r+3]=0,t.normals[12*r+4]=0,t.normals[12*r+5]=-1,t.normals[12*r+6]=0,t.normals[12*r+7]=0,t.normals[12*r+8]=-1,t.normals[12*r+9]=0,t.normals[12*r+10]=
0,t.normals[12*r+11]=-1;p=kb(this._system.app.graphicsDevice,t.positions,{uvs:t.uvs,normals:t.normals,colors:t.colors,indices:t.indices});p=new Ga(this._node,p,this._material);p.name="Text Element: "+this._entity.name;p.castShadow=!1;p.receiveShadow=!1;p.cull=!f;p.screenSpace=f;p.drawOrder=this._drawOrder;m&&(p.cull=!0,p.isVisibleFunc=n);this._setTextureParams(p,this._font.textures[b]);this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=
this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b);p.setParameter("material_emissive",this._colorUniform);p.setParameter("material_opacity",this._color.a);p.setParameter("font_sdfIntensity",this._font.intensity);p.setParameter("font_pxrange",this._getPxRange(this._font));p.setParameter("font_textureWidth",this._font.data.info.maps[b].width);this._outlineColorUniform[0]=this._outlineColor.r;this._outlineColorUniform[1]=this._outlineColor.g;this._outlineColorUniform[2]=
this._outlineColor.b;this._outlineColorUniform[3]=this._outlineColor.a;p.setParameter("outline_color",this._outlineColorUniform);p.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness);this._shadowColorUniform[0]=this._shadowColor.r;this._shadowColorUniform[1]=this._shadowColor.g;this._shadowColorUniform[2]=this._shadowColor.b;this._shadowColorUniform[3]=this._shadowColor.a;p.setParameter("shadow_color",this._shadowColorUniform);r=this._font.data.info.maps[b].width/
this._font.data.info.maps[b].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x;this._shadowOffsetUniform[1]=r*this._shadowOffsetScale*this._shadowOffset.y;p.setParameter("shadow_offset",this._shadowOffsetUniform);t.meshInstance=p;this._model.meshInstances.push(p)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy);h&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model);this._updateMeshes();this._rangeStart=
0;this._rangeEnd=this._symbols.length;this._updateRenderRange()};d._removeMeshInstance=function(b){b.material=null;var a=b.mesh;a&&a.destroy();b=this._model.meshInstances.indexOf(b);-1!==b&&this._model.meshInstances.splice(b,1)};d._setMaterial=function(b){var a;this._material=b;if(this._model){var c=0;for(a=this._model.meshInstances.length;c<a;c++)this._model.meshInstances[c].material=b}};d._updateMaterial=function(b){var a=this._element,c=a._isScreenCulled(),e=function(m){return a.isVisibleForCamera(m)};
this._material=this._system.getTextElementMaterial(b,this._font&&"msdf"===this._font.type);if(this._model)for(var f=0,h=this._model.meshInstances.length;f<h;f++){var k=this._model.meshInstances[f];k.cull=!b;k.material=this._material;k.screenSpace=b;c?(k.cull=!0,k.isVisibleFunc=e):k.isVisibleFunc=null}};d._updateMeshes=function(){function b(Ia,Kb,Wb){c._lineWidths.push(Math.abs(Wb));Ia=Ia.slice(w>Kb?Kb+1:w,w>Kb?w+1:Kb);if(z)for(Wb=Ia.length;Wb--&&0<z;)Wl.test(Ia[Wb])&&(Ia.splice(Wb,1),z--);c._lineContents.push(Ia.join(""));
m=0;n-=c._scaledLineHeight;r++;u=z=x=y=0;w=Kb}var a=this._font.data,c=this,e=Math.min(this._minFontSize,this._maxFontSize),f=this._maxFontSize,h=this._shouldAutoFit();h&&(this._fontSize=this._maxFontSize);var k=this._symbols.length,m=0,n=0,p=0,t=0,r=1,u=0,v=0,w=0,y=0,x=0,z=0,B=1E-4<=Math.abs(this._element.anchor.x-this._element.anchor.z),C=this._element.calculatedWidth;if(this.autoWidth&&!B||!this._wrapLines)C=Number.POSITIVE_INFINITY;var D=0;B=0;for(var G=1,J,E,H,P=!0;P;){P=!1;this._scaledLineHeight=
h?this._lineHeight*this._fontSize/(this._maxFontSize||1E-4):this._lineHeight;this.height=this.width=0;this._lineWidths=[];this._lineContents=[];t=p=n=m=0;r=1;z=x=y=w=v=u=0;G=this._fontSize/32;D=this._fontMinY*G;B=this._fontMaxY*G;for(H=0;H<this._meshInfo.length;H++)this._meshInfo[H].quad=0,this._meshInfo[H].lines={};var Y=255,L=255,V=255;for(H=0;H<k;H++){J=this._symbols[H];var wa=0,xa=0,U=0,ha=1;E=a.chars[J];if(!E)if(-1!==Rp.indexOf(J))E=Sp;else if(a.chars[" "])E=a.chars[" "];else for(var aa in a.chars){E=
a.chars[aa];break}if(E){var T=0;0<x&&(U=this._font.data.kerning)&&(U=U[Eb.getCodePoint(this._symbols[H-1])||0])&&(T=U[Eb.getCodePoint(this._symbols[H])||0]||0);U=E.scale||1;var pd=(E.width+E.height)/2;ha=G*pd/U;U=(E.xadvance+T)*G;wa=(E.xoffset-T)*G;xa=E.yoffset*G}else console.error("Couldn't substitute missing character: '"+J+"'");if(pd=Wl.test(J)){if(z++,0>this._maxLines||r<this._maxLines)b(this._symbols,H,t),v=H+1,w=H+1}else{var ie=Pp.test(J);T=this._meshInfo[E&&E.map||0];var qd=m+this._spacing*
U;if(qd>C&&0<x&&!ie&&(0>this._maxLines||r<this._maxLines))if(0===y)v=H,b(this._symbols,H,t);else{E=Math.max(H-v,0);if(1>=this._meshInfo.length)T.lines[r-1]-=E,T.quad-=E;else for(T=H,J=v;J<T;J++)U=a.chars[this._symbols[J]],U=this._meshInfo[U&&U.map||0],--U.lines[r-1],--U.quad;H-=E+1;b(this._symbols,v,u);continue}E=T.quad;T.lines[r-1]=E;var sa=m-wa,Xa=sa+ha;xa=n-xa;var Ub=xa+ha;this._rtl&&(ha=ha-wa-this._spacing*U-wa,sa-=ha,Xa-=ha);T.positions[12*E]=sa;T.positions[12*E+1]=xa;T.positions[12*E+2]=p;T.positions[12*
E+3]=Xa;T.positions[12*E+4]=xa;T.positions[12*E+5]=p;T.positions[12*E+6]=Xa;T.positions[12*E+7]=Ub;T.positions[12*E+8]=p;T.positions[12*E+9]=sa;T.positions[12*E+10]=Ub;T.positions[12*E+11]=p;this.width=Math.max(this.width,qd);if(this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(ha=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1E-4)),ha=R.clamp(ha,e,f),ha!==this._element.fontSize)){this._fontSize=ha;P=!0;break}this.height=Math.max(this.height,B-(n+
D));if(this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(ha=R.clamp(this._fontSize-1,e,f),ha!==this._element.fontSize)){this._fontSize=ha;P=!0;break}m+=this._spacing*U;ie||pd||(t=m);Qp.test(J)&&(y++,u=t,v=H+1);x++;J=this._getUv(J);T.uvs[8*E]=J[0];T.uvs[8*E+1]=J[1];T.uvs[8*E+2]=J[2];T.uvs[8*E+3]=J[1];T.uvs[8*E+4]=J[2];T.uvs[8*E+5]=J[3];T.uvs[8*E+6]=J[0];T.uvs[8*E+7]=J[3];this._symbolColors&&(V=3*this._symbolColors[H],Y=this._colorPalette[V],L=this._colorPalette[V+1],V=this._colorPalette[V+
2]);T.colors[16*E]=Y;T.colors[16*E+1]=L;T.colors[16*E+2]=V;T.colors[16*E+3]=255;T.colors[16*E+4]=Y;T.colors[16*E+5]=L;T.colors[16*E+6]=V;T.colors[16*E+7]=255;T.colors[16*E+8]=Y;T.colors[16*E+9]=L;T.colors[16*E+10]=V;T.colors[16*E+11]=255;T.colors[16*E+12]=Y;T.colors[16*E+13]=L;T.colors[16*E+14]=V;T.colors[16*E+15]=255;T.quad++}}P||w<k&&b(this._symbols,k,m)}this._noResize=!0;this.autoWidth=this._autoWidth;this.autoHeight=this._autoHeight;this._noResize=!1;a=this._element.pivot.x;e=this._element.pivot.y;
f=this._alignment.x;h=this._alignment.y;for(H=0;H<this._meshInfo.length;H++)if(0!==this._meshInfo[H].count){aa=0;for(var Vb in this._meshInfo[H].lines){k=this._meshInfo[H].lines[Vb];C=this._lineWidths[parseInt(Vb,10)];C=-a*this._element.calculatedWidth+f*(this._element.calculatedWidth-C)*(this._rtl?-1:1);p=(1-e)*this._element.calculatedHeight-B-(1-h)*(this._element.calculatedHeight-this.height);for(E=aa;E<=k;E++)this._meshInfo[H].positions[12*E]+=C,this._meshInfo[H].positions[12*E+3]+=C,this._meshInfo[H].positions[12*
E+6]+=C,this._meshInfo[H].positions[12*E+9]+=C,this._meshInfo[H].positions[12*E+1]+=p,this._meshInfo[H].positions[12*E+4]+=p,this._meshInfo[H].positions[12*E+7]+=p,this._meshInfo[H].positions[12*E+10]+=p;if(this._rtl)for(E=aa;E<=k;E++){aa=12*E;for(p=0;4>p;++p)this._meshInfo[H].positions[aa+3*p]=this._element.calculatedWidth-this._meshInfo[H].positions[aa+3*p]+2*C;p=this._meshInfo[H].positions[aa+3];t=this._meshInfo[H].positions[aa+6];this._meshInfo[H].positions[aa+3]=this._meshInfo[H].positions[aa+
0];this._meshInfo[H].positions[aa+6]=this._meshInfo[H].positions[aa+9];this._meshInfo[H].positions[aa+0]=p;this._meshInfo[H].positions[aa+9]=t}aa=k+1}k=4*this._meshInfo[H].count;C=4*this._meshInfo[H].quad;E=new vb(this._meshInfo[H].meshInstance.mesh.vertexBuffer);for(aa=0;aa<k;aa++)aa>=C?(E.element.POSITION.set(0,0,0),E.element.TEXCOORD0.set(0,0),E.element.COLOR.set(0,0,0,0)):(E.element.POSITION.set(this._meshInfo[H].positions[3*aa],this._meshInfo[H].positions[3*aa+1],this._meshInfo[H].positions[3*
aa+2]),E.element.TEXCOORD0.set(this._meshInfo[H].uvs[2*aa],this._meshInfo[H].uvs[2*aa+1]),E.element.COLOR.set(this._meshInfo[H].colors[4*aa],this._meshInfo[H].colors[4*aa+1],this._meshInfo[H].colors[4*aa+2],this._meshInfo[H].colors[4*aa+3])),E.next();E.end();this._meshInfo[H].meshInstance.mesh.aabb.compute(this._meshInfo[H].positions);this._meshInfo[H].meshInstance._aabbVer=-1}this._aabbDirty=!0};d._onFontRender=function(){this.font=this._font};d._onFontLoad=function(b){this.font!==b.resource&&(this.font=
b.resource)};d._onFontChange=function(b,a,c,e){if("data"===a)for(this._font.data=c,b=this._font.data.info.maps.length,a=0;a<b;a++)this._meshInfo[a]&&(c=this._meshInfo[a].meshInstance)&&(c.setParameter("font_sdfIntensity",this._font.intensity),c.setParameter("font_pxrange",this._getPxRange(this._font)),c.setParameter("font_textureWidth",this._font.data.info.maps[a].width))};d._onFontRemove=function(b){};d._setTextureParams=function(b,a){this._font&&("msdf"===this._font.type?(b.deleteParameter("texture_emissiveMap"),
b.deleteParameter("texture_opacityMap"),b.setParameter("texture_msdfMap",a)):"bitmap"===this._font.type&&(b.deleteParameter("texture_msdfMap"),b.setParameter("texture_emissiveMap",a),b.setParameter("texture_opacityMap",a)))};d._getPxRange=function(b){b=Object.keys(this._font.data.chars);for(var a=0;a<b.length;a++){var c=this._font.data.chars[b[a]];if(c.range)return(c.scale||1)*c.range}return 2};d._getUv=function(b){var a=this._font.data;if(!a.chars[b])return a.chars[" "]?this._getUv(" "):[0,0,0,0];
var c=a.chars[b].map,e=a.info.maps[c].width;c=a.info.maps[c].height;var f=a.chars[b].x,h=a.chars[b].y,k=1-a.chars[b].height/c;return[f/e,k-h/c,(f+a.chars[b].width)/e,k-(h-a.chars[b].height)/c]};d.onEnable=function(){this._fontAsset.autoLoad=!0;this._model&&this._element.addModelToLayers(this._model)};d.onDisable=function(){this._fontAsset.autoLoad=!1;this._model&&this._element.removeModelFromLayers(this._model)};d._setStencil=function(b){if(this._model)for(var a=this._model.meshInstances,c=0;c<a.length;c++)a[c].stencilFront=
b,a[c].stencilBack=b};d._shouldAutoFitWidth=function(){return this._autoFitWidth&&!this._autoWidth};d._shouldAutoFitHeight=function(){return this._autoFitHeight&&!this._autoHeight};d._shouldAutoFit=function(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight};d._calculateCharsPerTexture=function(b){var a={};void 0===b&&(b=this._symbols.length);var c;for(c=0;c<b;c++){var e=this._symbols[c];e=this._font.data.chars[e];e||(e=this._font.data.chars[" "])||(e=this._font.data.chars[Object.keys(this._font.data.chars)[0]]);
e=e.map;a[e]?a[e]++:a[e]=1}return a};d._updateRenderRange=function(){var b=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),a=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd),c;var e=0;for(c=this._meshInfo.length;e<c;e++){var f=b[e]||0,h=a[e]||0,k=this._meshInfo[e].meshInstance;k&&(k=k.mesh)&&(k.primitive[0].base=6*f,k.primitive[0].count=6*(h-f))}};N(g,[{key:"text",get:function(){return this._text},set:function(b){this._i18nKey=null;this._setText(null!=b&&
b.toString()||"")}},{key:"key",get:function(){return this._i18nKey},set:function(b){b=null!==b?b.toString():null;this._i18nKey!==b&&((this._i18nKey=b)?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}},{key:"color",get:function(){return this._color},set:function(b){var a=b.r,c=b.g;b=b.b;if(this._color.r!==a||this._color.g!==c||this._color.b!==b)if(this._color.r=a,this._color.g=c,this._color.b=b,this._symbolColors)this._font&&this._updateText();
else for(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,a=0,c=this._model.meshInstances.length;a<c;a++)this._model.meshInstances[a].setParameter("material_emissive",this._colorUniform)}},{key:"opacity",get:function(){return this._color.a},set:function(b){if(this._color.a!==b&&(this._color.a=b,this._model))for(var a=0,c=this._model.meshInstances.length;a<c;a++)this._model.meshInstances[a].setParameter("material_opacity",b)}},{key:"lineHeight",
get:function(){return this._lineHeight},set:function(b){var a=this._lineHeight;this._scaledLineHeight=this._lineHeight=b;a!==b&&this._font&&this._updateText()}},{key:"wrapLines",get:function(){return this._wrapLines},set:function(b){var a=this._wrapLines;this._wrapLines=b;a!==b&&this._font&&this._updateText()}},{key:"lines",get:function(){return this._lineContents}},{key:"spacing",get:function(){return this._spacing},set:function(b){var a=this._spacing;this._spacing=b;a!==b&&this._font&&this._updateText()}},
{key:"fontSize",get:function(){return this._fontSize},set:function(b){var a=this._fontSize;this._originalFontSize=this._fontSize=b;a!==b&&this._font&&this._updateText()}},{key:"fontAsset",get:function(){return this._fontAsset.localizedAsset},set:function(b){this._fontAsset.defaultAsset=b}},{key:"font",get:function(){return this._font},set:function(b){if(this._font){var a=this._font.type;this._font.off&&this._font.off("render",this._onFontRender,this)}this._font=b;this._fontMaxY=this._fontMinY=0;if(b){var c=
this._font.data,e;for(e in c.chars){var f=c.chars[e];f.bounds&&(this._fontMinY=Math.min(this._fontMinY,f.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,f.bounds[3]))}if(this._font.on)this._font.on("render",this._onFontRender,this);this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null);b.type!==a&&(b=this._element._isScreenSpace(),this._updateMaterial(b));b=0;for(a=this._font.textures.length;b<a;b++)if(this._meshInfo[b]){if(c=
this._meshInfo[b].meshInstance)c.setParameter("font_sdfIntensity",this._font.intensity),c.setParameter("font_pxrange",this._getPxRange(this._font)),c.setParameter("font_textureWidth",this._font.data.info.maps[b].width),this._setTextureParams(c,this._font.textures[b])}else this._meshInfo[b]=new Op;a=!1;for(b=this._font.textures.length;b<this._meshInfo.length;b++)this._meshInfo[b].meshInstance&&(a||(this._element.removeModelFromLayers(this._model),a=!0),this._removeMeshInstance(this._meshInfo[b].meshInstance));
this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length);this._updateText()}}},{key:"alignment",get:function(){return this._alignment},set:function(b){b instanceof S?this._alignment.set(b.x,b.y):this._alignment.set(b[0],b[1]);this._font&&this._updateText()}},{key:"autoWidth",get:function(){return this._autoWidth},set:function(b){var a=this._autoWidth;(this._autoWidth=b)&&1E-4>Math.abs(this._element.anchor.x-this._element.anchor.z)&&(this._element.width=
this.width);a!==b&&(b=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,b!==this._fontSize&&(this._fontSize=b,this._font&&this._updateText()))}},{key:"autoHeight",get:function(){return this._autoHeight},set:function(b){var a=this._autoHeight;(this._autoHeight=b)&&1E-4>Math.abs(this._element.anchor.y-this._element.anchor.w)&&(this._element.height=this.height);a!==b&&(b=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,b!==this._fontSize&&(this._fontSize=b,this._font&&this._updateText()))}},
{key:"rtlReorder",get:function(){return this._rtlReorder},set:function(b){this._rtlReorder!==b&&(this._rtlReorder=b,this._font&&this._updateText())}},{key:"unicodeConverter",get:function(){return this._unicodeConverter},set:function(b){this._unicodeConverter!==b&&(this._unicodeConverter=b,this._setText(this._text))}},{key:"aabb",get:function(){if(this._aabbDirty){for(var b=!1,a=0;a<this._meshInfo.length;a++)this._meshInfo[a].meshInstance&&(b?this._aabb.add(this._meshInfo[a].meshInstance.aabb):(this._aabb.copy(this._meshInfo[a].meshInstance.aabb),
b=!0));this._aabbDirty=!1}return this._aabb}},{key:"outlineColor",get:function(){return this._outlineColor},set:function(b){var a=b instanceof Q?b.r:b[0],c=b instanceof Q?b.g:b[1],e=b instanceof Q?b.b:b[2];b=b instanceof Q?b.a:b[3];if(this._outlineColor.r!==a||this._outlineColor.g!==c||this._outlineColor.b!==e||this._outlineColor.a!==b)if(this._outlineColor.r=a,this._outlineColor.g=c,this._outlineColor.b=e,this._outlineColor.a=b,this._model)for(this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=
this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a,a=0,c=this._model.meshInstances.length;a<c;a++)this._model.meshInstances[a].setParameter("outline_color",this._outlineColorUniform)}},{key:"outlineThickness",get:function(){return this._outlineThickness},set:function(b){var a=this._outlineThickness;this._outlineThickness=b;if(a!==b&&this._font&&this._model)for(b=0,a=this._model.meshInstances.length;b<a;b++)this._model.meshInstances[b].setParameter("outline_thickness",
this._outlineThicknessScale*this._outlineThickness)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(b){var a=b instanceof Q?b.r:b[0],c=b instanceof Q?b.g:b[1],e=b instanceof Q?b.b:b[2];b=b instanceof Q?b.a:b[3];if(this._shadowColor.r!==a||this._shadowColor.g!==c||this._shadowColor.b!==e||this._shadowColor.a!==b)if(this._shadowColor.r=a,this._shadowColor.g=c,this._shadowColor.b=e,this._shadowColor.a=b,this._model)for(this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=
this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a,a=0,c=this._model.meshInstances.length;a<c;a++)this._model.meshInstances[a].setParameter("shadow_color",this._shadowColorUniform)}},{key:"shadowOffset",get:function(){return this._shadowOffset},set:function(b){var a=b instanceof S?b.x:b[0];b=b instanceof S?b.y:b[1];if(this._shadowOffset.x!==a||this._shadowOffset.y!==b)if(this._shadowOffset.set(a,b),this._font&&this._model)for(a=0,b=
this._model.meshInstances.length;a<b;a++){var c=this._font.data.info.maps[a].width/this._font.data.info.maps[a].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x;this._shadowOffsetUniform[1]=c*this._shadowOffsetScale*this._shadowOffset.y;this._model.meshInstances[a].setParameter("shadow_offset",this._shadowOffsetUniform)}}},{key:"minFontSize",get:function(){return this._minFontSize},set:function(b){this._minFontSize!==b&&(this._minFontSize=b,this.font&&this._shouldAutoFit()&&
this._updateText())}},{key:"maxFontSize",get:function(){return this._maxFontSize},set:function(b){this._maxFontSize!==b&&(this._maxFontSize=b,this.font&&this._shouldAutoFit()&&this._updateText())}},{key:"autoFitWidth",get:function(){return this._autoFitWidth},set:function(b){this._autoFitWidth!==b&&(this._autoFitWidth=b,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}},{key:"autoFitHeight",get:function(){return this._autoFitHeight},set:function(b){this._autoFitHeight!==
b&&(this._autoFitHeight=b,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}},{key:"maxLines",get:function(){return this._maxLines},set:function(b){this._maxLines===b||null===b&&-1===this._maxLines||(this._maxLines=null===b?-1:b,this.font&&this._wrapLines&&this._updateText())}},{key:"enableMarkup",get:function(){return this._enableMarkup},set:function(b){b=!!b;this._enableMarkup!==b&&(this._enableMarkup=b,this.font&&this._updateText())}},
{key:"symbols",get:function(){return this._symbols}},{key:"symbolColors",get:function(){return null===this._symbolColors?null:this._symbolColors.map(function(b){return this._colorPalette.slice(3*b,3*b+3)},this)}},{key:"rtl",get:function(){return this._rtl}},{key:"rangeStart",get:function(){return this._rangeStart},set:function(b){b=Math.max(0,Math.min(b,this._symbols.length));b!==this._rangeStart&&(this._rangeStart=b,this._updateRenderRange())}},{key:"rangeEnd",get:function(){return this._rangeEnd},
set:function(b){b=Math.max(this._rangeStart,Math.min(b,this._symbols.length));b!==this._rangeEnd&&(this._rangeEnd=b,this._updateRenderRange())}}]);return g}(),Vh=new A,Yl=new M,Nb=new A,Sc=new A,sb=new M,Tf=new M,Uf=new M,Fd=new M,ka=function(g){function d(a,c){a=g.call(this,a,c)||this;a._beingInitialized=!1;a._anchor=new Z;a._localAnchor=new Z;a._pivot=new S;a._width=a._calculatedWidth=32;a._height=a._calculatedHeight=32;a._margin=new Z(0,0,-32,-32);a._modelTransform=new M;a._screenToWorld=new M;
a._anchorTransform=new M;a._anchorDirty=!0;a._parentWorldTransform=new M;a._screenTransform=new M;a._screenCorners=[new A,new A,new A,new A];a._canvasCorners=[new S,new S,new S,new S];a._worldCorners=[new A,new A,new A,new A];a._cornersDirty=!0;a._canvasCornersDirty=!0;a._worldCornersDirty=!0;a.entity.on("insert",a._onInsert,F(a));a._patch();a.screen=null;a._type="group";a._image=null;a._text=null;a._group=null;a._drawOrder=0;a._useInput=!1;a._layers=[4];a._addedModels=[];a._batchGroupId=-1;a._offsetReadAt=
0;a._maskOffset=.5;a._maskedBy=null;return a}K(d,g);var b=d.prototype;b._patch=function(){this.entity._sync=this._sync;this.entity.setPosition=this._setPosition;this.entity.setLocalPosition=this._setLocalPosition};b._unpatch=function(){this.entity._sync=Ba.prototype._sync;this.entity.setPosition=Ba.prototype.setPosition;this.entity.setLocalPosition=Ba.prototype.setLocalPosition};b._setPosition=function(a,c,e){if(!this.element.screen)return Ba.prototype.setPosition.call(this,a,c,e);a instanceof A?
Vh.copy(a):Vh.set(a,c,e);this.getWorldTransform();Yl.copy(this.element._screenToWorld).invert();Yl.transformPoint(Vh,this.localPosition);this._dirtyLocal||this._dirtifyLocal()};b._setLocalPosition=function(a,c,e){a instanceof A?this.localPosition.copy(a):this.localPosition.set(a,c,e);a=this.element;c=this.localPosition;e=a._pivot;a._margin.x=c.x-a._calculatedWidth*e.x;a._margin.z=a._localAnchor.z-a._localAnchor.x-a._calculatedWidth-a._margin.x;a._margin.y=c.y-a._calculatedHeight*e.y;a._margin.w=a._localAnchor.w-
a._localAnchor.y-a._calculatedHeight-a._margin.y;this._dirtyLocal||this._dirtifyLocal()};b._sync=function(){var a=this.element,c=a.screen;if(c){if(a._anchorDirty){var e=0,f=1;if(this._parent&&this._parent.element){var h=this._parent.element.calculatedWidth;var k=this._parent.element.calculatedHeight;e=this._parent.element.pivot.x;f=this._parent.element.pivot.y}else k=c.screen.resolution,h=k.x/c.screen.scale,k=k.y/c.screen.scale;a._anchorTransform.setTranslate(h*(a.anchor.x-e),-(k*(f-a.anchor.y)),
0);a._anchorDirty=!1;a._calculateLocalAnchors()}a._sizeDirty&&a._calculateSize(!1,!1)}this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),h=this.localPosition,e=a._pivot,a._margin.x=h.x-a._calculatedWidth*e.x,a._margin.z=a._localAnchor.z-a._localAnchor.x-a._calculatedWidth-a._margin.x,a._margin.y=h.y-a._calculatedHeight*e.y,a._margin.w=a._localAnchor.w-a._localAnchor.y-a._calculatedHeight-a._margin.y,this._dirtyLocal=!1);if(!c)return this._dirtyWorld&&
(a._cornersDirty=!0,a._canvasCornersDirty=!0,a._worldCornersDirty=!0),Ba.prototype._sync.call(this);this._dirtyWorld&&(null===this._parent?this.worldTransform.copy(this.localTransform):(this._parent.element?a._screenToWorld.mul2(this._parent.element._modelTransform,a._anchorTransform):a._screenToWorld.copy(a._anchorTransform),a._modelTransform.mul2(a._screenToWorld,this.localTransform),c?(a._screenToWorld.mul2(c.screen._screenMatrix,a._screenToWorld),c.screen.screenSpace||a._screenToWorld.mul2(c.worldTransform,
a._screenToWorld),this.worldTransform.mul2(a._screenToWorld,this.localTransform),h=a._parentWorldTransform,h.setIdentity(),(e=this._parent)&&e.element&&e!==c&&(sb.setTRS(A.ZERO,e.getLocalRotation(),e.getLocalScale()),h.mul2(e.element._parentWorldTransform,sb)),Nb.set(0,0,this.localPosition.z),Sc.set(a._absLeft+a._pivot.x*a.calculatedWidth,a._absBottom+a._pivot.y*a.calculatedHeight,0),sb.setTranslate(-Sc.x,-Sc.y,-Sc.z),Tf.setTRS(Nb,this.getLocalRotation(),this.getLocalScale()),Uf.setTranslate(Sc.x,
Sc.y,Sc.z),a._screenTransform.mul2(a._parentWorldTransform,Uf).mul(Tf).mul(sb),a._cornersDirty=!0,a._canvasCornersDirty=!0,a._worldCornersDirty=!0):this.worldTransform.copy(a._modelTransform)),this._dirtyWorld=!1)};b._onInsert=function(a){a=this._parseUpToScreen();this.entity._dirtifyWorld();this._updateScreen(a.screen);this._dirtifyMask()};b._dirtifyMask=function(){for(var a=this.entity;a;){var c=a.parent;if((null===c||c.screen)&&a.element){this.system._prerender&&this.system._prerender.length||
(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));var e=this.system._prerender.indexOf(this.entity);0<=e&&this.system._prerender.splice(e,1);0>this.system._prerender.indexOf(a)&&this.system._prerender.push(a)}a=c}};b._onPrerender=function(){for(var a=0;a<this.system._prerender.length;a++){var c=this.system._prerender[a];c.element&&c.element.syncMask(1)}this.system._prerender.length=0};b._bindScreen=function(a){a._bindElement(this)};b._unbindScreen=function(a){a._unbindElement(this)};
b._updateScreen=function(a){this.screen&&this.screen!==a&&this._unbindScreen(this.screen.screen);var c=this.screen;(this.screen=a)&&this._bindScreen(this.screen.screen);this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY);this.fire("set:screen",this.screen,c);this._anchorDirty=!0;c=this.entity.children;for(var e=0,f=c.length;e<f;e++)c[e].element&&c[e].element._updateScreen(a);this.screen&&this.screen.screen.syncDrawOrder()};b.syncMask=function(a){var c=this._parseUpToScreen();this._updateMask(c.mask,
a)};b._setMaskedBy=function(a){var c=this._image||this._text;if(a){var e=new ue({ref:a.element._image._maskRef,func:2});c&&c._setStencil&&c._setStencil(e);this._maskedBy=a}else c&&c._setStencil&&c._setStencil(null),this._maskedBy=null};b._updateMask=function(a,c){var e;a?(this._setMaskedBy(a),this.mask&&(a=new ue({ref:a.element._image._maskRef,func:2,zpass:3}),this._image._setStencil(a),this._image._maskRef=c,c++,a=this.entity)):(this._setMaskedBy(null),this.mask&&(a=new ue({ref:c,func:7,zpass:2}),
this._image._setStencil(a),this._image._maskRef=c,c++,a=this.entity));var f=this.entity.children;var h=0;for(e=f.length;h<e;h++)f[h].element&&f[h].element._updateMask(a,c)};b._parseUpToScreen=function(){for(var a={screen:null,mask:null},c=this.entity._parent;c&&!c.screen;)c.element&&c.element.mask&&!a.mask&&(a.mask=c),c=c.parent;c&&c.screen&&(a.screen=c);return a};b._onScreenResize=function(a){this._worldCornersDirty=this._cornersDirty=this._anchorDirty=!0;this._calculateSize(this._hasSplitAnchorsX,
this._hasSplitAnchorsY);this.fire("screen:set:resolution",a)};b._onScreenSpaceChange=function(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)};b._onScreenRemove=function(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null))};b._calculateLocalAnchors=function(){var a=1E3,c=1E3,e=this.entity._parent;e&&e.element?(a=e.element.calculatedWidth,c=e.element.calculatedHeight):this.screen&&(c=this.screen.screen.resolution,e=this.screen.screen.scale,a=c.x/e,
c=c.y/e);this._localAnchor.set(this._anchor.x*a,this._anchor.y*c,this._anchor.z*a,this._anchor.w*c)};b.getOffsetPosition=function(a,c){var e=this.entity.getLocalPosition().clone();e.x+=a;e.y+=c;this._screenToWorld.transformPoint(e,e);return e};b.onLayersChanged=function(a,c){this.addModelToLayers(this._image?this._image._model:this._text._model);a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);c.on("add",this.onLayerAdded,this);c.on("remove",this.onLayerRemoved,this)};
b.onLayerAdded=function(a){0>this.layers.indexOf(a.id)||(this._image?a.addMeshInstances(this._image._model.meshInstances):this._text&&a.addMeshInstances(this._text._model.meshInstances))};b.onLayerRemoved=function(a){0>this.layers.indexOf(a.id)||(this._image?a.removeMeshInstances(this._image._model.meshInstances):this._text&&a.removeMeshInstances(this._text._model.meshInstances))};b.onEnable=function(){if(this._image)this._image.onEnable();if(this._text)this._text.onEnable();if(this._group)this._group.onEnable();
this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this);this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));0<=this._batchGroupId&&this.system.app.batcher.insert(Da.ELEMENT,this.batchGroupId,this.entity);this.fire("enableelement")};b.onDisable=function(){this.system.app.scene.off("set:layers",
this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));if(this._image)this._image.onDisable();if(this._text)this._text.onDisable();if(this._group)this._group.onDisable();this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this);0<=this._batchGroupId&&this.system.app.batcher.remove(Da.ELEMENT,this.batchGroupId,this.entity);this.fire("disableelement")};
b.onRemove=function(){this.entity.off("insert",this._onInsert,this);this._unpatch();this._image&&this._image.destroy();this._text&&this._text.destroy();this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this);this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder());this.off()};b._calculateSize=function(a,c){if(this.entity._parent||this.screen){this._calculateLocalAnchors();var e=this._absRight-this._absLeft,f=
this._absTop-this._absBottom;a?this._setWidth(e):this._setCalculatedWidth(e,!1);c?this._setHeight(f):this._setCalculatedHeight(f,!1);a=this.entity.getLocalPosition();a.x=this._margin.x+this._calculatedWidth*this._pivot.x;a.y=this._margin.y+this._calculatedHeight*this._pivot.y;this.entity.setLocalPosition(a);this._sizeDirty=!1}};b._setWidth=function(a){this._width=a;this._setCalculatedWidth(a,!1);this.fire("set:width",this._width)};b._setHeight=function(a){this._height=a;this._setCalculatedHeight(a,
!1);this.fire("set:height",this._height)};b._setCalculatedWidth=function(a,c){1E-4>=Math.abs(a-this._calculatedWidth)||(this._calculatedWidth=a,this.entity._dirtifyLocal(),c&&(a=this.entity.getLocalPosition(),this._margin.x=a.x-this._calculatedWidth*this._pivot.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x),this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight))};
b._setCalculatedHeight=function(a,c){1E-4>=Math.abs(a-this._calculatedHeight)||(this._calculatedHeight=a,this.entity._dirtifyLocal(),c&&(a=this.entity.getLocalPosition(),this._margin.y=a.y-this._calculatedHeight*this._pivot.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y),this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight))};b._flagChildrenAsDirty=function(){var a,
c=this.entity._children;var e=0;for(a=c.length;e<a;e++)c[e].element&&(c[e].element._anchorDirty=!0,c[e].element._sizeDirty=!0)};b.addModelToLayers=function(a){var c;this._addedModels.push(a);for(var e=0;e<this.layers.length;e++)(c=this.system.app.scene.layers.getLayerById(this.layers[e]))&&c.addMeshInstances(a.meshInstances)};b.removeModelFromLayers=function(a){var c=this._addedModels.indexOf(a);0<=c&&this._addedModels.splice(c,1);for(var e=0;e<this.layers.length;e++)(c=this.system.app.scene.layers.getLayerById(this.layers[e]))&&
c.removeMeshInstances(a.meshInstances)};b.getMaskOffset=function(){var a=this.system.app.frame;this._offsetReadAt!==a&&(this._maskOffset=.5,this._offsetReadAt=a);a=this._maskOffset;this._maskOffset-=.001;return a};b.isVisibleForCamera=function(a){if(this.maskedBy){a=this.maskedBy.element.screenCorners;var c=Math.min(Math.min(a[0].x,a[1].x),Math.min(a[2].x,a[3].x));var e=Math.max(Math.max(a[0].x,a[1].x),Math.max(a[2].x,a[3].x));var f=Math.min(Math.min(a[0].y,a[1].y),Math.min(a[2].y,a[3].y));a=Math.max(Math.max(a[0].y,
a[1].y),Math.max(a[2].y,a[3].y))}else{c=this.system.app.graphicsDevice.width;var h=this.system.app.graphicsDevice.height;e=a._rect.z*c;f=a._rect.w*h;c*=a._rect.x;e=c+e;a=(1-a._rect.y)*h;f=a-f}h=this.screenCorners;var k=Math.min(Math.min(h[0].x,h[1].x),Math.min(h[2].x,h[3].x)),m=Math.min(Math.min(h[0].y,h[1].y),Math.min(h[2].y,h[3].y)),n=Math.max(Math.max(h[0].y,h[1].y),Math.max(h[2].y,h[3].y));return Math.max(Math.max(h[0].x,h[1].x),Math.max(h[2].x,h[3].x))<c||k>e||m>a||n<f?!1:!0};b._isScreenSpace=
function(){return this.screen&&this.screen.screen?this.screen.screen.screenSpace:!1};b._isScreenCulled=function(){return this.screen&&this.screen.screen?this.screen.screen.cull:!1};return d}(ca);Object.defineProperty(ka.prototype,"type",{get:function(){return this._type},set:function(g){g!==this._type&&(this._type=g,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),"image"===g?this._image=new Ul(this):"text"===g&&(this._text=new Xl(this)))}});
Object.defineProperty(ka.prototype,"layers",{get:function(){return this._layers},set:function(g){var d,b,a;if(this._addedModels.length)for(d=0;d<this._layers.length;d++)if(a=this.system.app.scene.layers.getLayerById(this._layers[d]))for(b=0;b<this._addedModels.length;b++)a.removeMeshInstances(this._addedModels[b].meshInstances);this._layers=g;if(this.enabled&&this.entity.enabled&&this._addedModels.length)for(d=0;d<this._layers.length;d++)if(a=this.system.app.scene.layers.getLayerById(this._layers[d]))for(b=
0;b<this._addedModels.length;b++)a.addMeshInstances(this._addedModels[b].meshInstances)}});Object.defineProperty(ka.prototype,"drawOrder",{get:function(){return this._drawOrder},set:function(g){var d=0;this.screen&&(d=this.screen.screen.priority);16777215<g&&(g=16777215);this._drawOrder=(d<<24)+g;this.fire("set:draworder",this._drawOrder)}});Object.defineProperty(ka.prototype,"_absLeft",{get:function(){return this._localAnchor.x+this._margin.x}});Object.defineProperty(ka.prototype,"_absRight",{get:function(){return this._localAnchor.z-
this._margin.z}});Object.defineProperty(ka.prototype,"_absTop",{get:function(){return this._localAnchor.w-this._margin.w}});Object.defineProperty(ka.prototype,"_absBottom",{get:function(){return this._localAnchor.y+this._margin.y}});Object.defineProperty(ka.prototype,"margin",{get:function(){return this._margin},set:function(g){this._margin.copy(g);this._calculateSize(!0,!0);this.fire("set:margin",this._margin)}});Object.defineProperty(ka.prototype,"left",{get:function(){return this._margin.x},set:function(g){this._margin.x=
g;var d=this.entity.getLocalPosition();this._setWidth(this._absRight-(this._localAnchor.x+g));d.x=g+this._calculatedWidth*this._pivot.x;this.entity.setLocalPosition(d)}});Object.defineProperty(ka.prototype,"right",{get:function(){return this._margin.z},set:function(g){this._margin.z=g;var d=this.entity.getLocalPosition();this._setWidth(this._localAnchor.z-g-this._absLeft);d.x=this._localAnchor.z-this._localAnchor.x-g-this._calculatedWidth*(1-this._pivot.x);this.entity.setLocalPosition(d)}});Object.defineProperty(ka.prototype,
"top",{get:function(){return this._margin.w},set:function(g){this._margin.w=g;var d=this.entity.getLocalPosition();this._setHeight(this._localAnchor.w-g-this._absBottom);d.y=this._localAnchor.w-this._localAnchor.y-g-this._calculatedHeight*(1-this._pivot.y);this.entity.setLocalPosition(d)}});Object.defineProperty(ka.prototype,"bottom",{get:function(){return this._margin.y},set:function(g){this._margin.y=g;var d=this.entity.getLocalPosition();this._setHeight(this._absTop-(this._localAnchor.y+g));d.y=
g+this._calculatedHeight*this._pivot.y;this.entity.setLocalPosition(d)}});Object.defineProperty(ka.prototype,"width",{get:function(){return this._width},set:function(g){this._width=g;this._hasSplitAnchorsX||this._setCalculatedWidth(g,!0);this.fire("set:width",this._width)}});Object.defineProperty(ka.prototype,"height",{get:function(){return this._height},set:function(g){this._height=g;this._hasSplitAnchorsY||this._setCalculatedHeight(g,!0);this.fire("set:height",this._height)}});Object.defineProperty(ka.prototype,
"calculatedWidth",{get:function(){return this._calculatedWidth},set:function(g){this._setCalculatedWidth(g,!0)}});Object.defineProperty(ka.prototype,"calculatedHeight",{get:function(){return this._calculatedHeight},set:function(g){this._setCalculatedHeight(g,!0)}});Object.defineProperty(ka.prototype,"pivot",{get:function(){return this._pivot},set:function(g){var d=this._pivot.x,b=this._pivot.y;g instanceof S?this._pivot.set(g.x,g.y):this._pivot.set(g[0],g[1]);g=this._margin.x+this._margin.z;d=this._pivot.x-
d;this._margin.x+=g*d;this._margin.z-=g*d;d=this._margin.y+this._margin.w;b=this._pivot.y-b;this._margin.y+=d*b;this._margin.w-=d*b;this._worldCornersDirty=this._cornersDirty=this._anchorDirty=!0;this._calculateSize(!1,!1);this._flagChildrenAsDirty();this.fire("set:pivot",this._pivot)}});Object.defineProperty(ka.prototype,"anchor",{get:function(){return this._anchor},set:function(g){g instanceof Z?this._anchor.set(g.x,g.y,g.z,g.w):this._anchor.set(g[0],g[1],g[2],g[3]);this.entity._parent||this.screen?
this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors();this._anchorDirty=!0;this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:anchor",this._anchor)}});Object.defineProperty(ka.prototype,"_hasSplitAnchorsX",{get:function(){return.001<Math.abs(this._anchor.x-this._anchor.z)}});Object.defineProperty(ka.prototype,"_hasSplitAnchorsY",{get:function(){return.001<Math.abs(this._anchor.y-this._anchor.w)}});Object.defineProperty(ka.prototype,"aabb",
{get:function(){return this._image?this._image.aabb:this._text?this._text.aabb:null}});Object.defineProperty(ka.prototype,"screenCorners",{get:function(){if(!this._cornersDirty||!this.screen)return this._screenCorners;var g=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0);this._screenCorners[1].set(this._absRight,this._absBottom,0);this._screenCorners[2].set(this._absRight,this._absTop,0);this._screenCorners[3].set(this._absLeft,
this._absTop,0);for(var d=this.screen.screen.screenSpace,b=0;4>b;b++)this._screenTransform.transformPoint(this._screenCorners[b],this._screenCorners[b]),d&&this._screenCorners[b].scale(this.screen.screen.scale),g&&this._screenCorners[b].add(g);this._cornersDirty=!1;this._worldCornersDirty=this._canvasCornersDirty=!0;return this._screenCorners}});Object.defineProperty(ka.prototype,"canvasCorners",{get:function(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;
for(var g=this.system.app.graphicsDevice,d=this.screenCorners,b=g.canvas.clientWidth/g.width,a=g.canvas.clientHeight/g.height,c=0;4>c;c++)this._canvasCorners[c].set(d[c].x*b,(g.height-d[c].y)*a);this._canvasCornersDirty=!1;return this._canvasCorners}});Object.defineProperty(ka.prototype,"worldCorners",{get:function(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){var g=this.screenCorners;if(!this.screen.screen.screenSpace){sb.copy(this.screen.screen._screenMatrix);sb.data[13]=
-sb.data[13];sb.mul2(this.screen.getWorldTransform(),sb);for(var d=0;4>d;d++)sb.transformPoint(g[d],this._worldCorners[d])}}else g=this.entity.getLocalPosition(),sb.setTranslate(-g.x,-g.y,-g.z),Tf.setTRS(A.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),Uf.setTranslate(g.x,g.y,g.z),Fd.copy((this.entity.parent?this.entity.parent:this.entity).getWorldTransform()),Fd.mul(Uf).mul(Tf).mul(sb),Nb.set(g.x-this.pivot.x*this.calculatedWidth,g.y-this.pivot.y*this.calculatedHeight,g.z),Fd.transformPoint(Nb,
this._worldCorners[0]),Nb.set(g.x+(1-this.pivot.x)*this.calculatedWidth,g.y-this.pivot.y*this.calculatedHeight,g.z),Fd.transformPoint(Nb,this._worldCorners[1]),Nb.set(g.x+(1-this.pivot.x)*this.calculatedWidth,g.y+(1-this.pivot.y)*this.calculatedHeight,g.z),Fd.transformPoint(Nb,this._worldCorners[2]),Nb.set(g.x-this.pivot.x*this.calculatedWidth,g.y+(1-this.pivot.y)*this.calculatedHeight,g.z),Fd.transformPoint(Nb,this._worldCorners[3]);this._worldCornersDirty=!1;return this._worldCorners}});Object.defineProperty(ka.prototype,
"textWidth",{get:function(){return this._text?this._text.width:0}});Object.defineProperty(ka.prototype,"textHeight",{get:function(){return this._text?this._text.height:0}});Object.defineProperty(ka.prototype,"useInput",{get:function(){return this._useInput},set:function(g){this._useInput!==g&&(this._useInput=g,this.system.app.elementInput?g?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):!0===this._useInput&&console.warn("Elements will not get any input events because this.system.app.elementInput is not created"),
this.fire("set:useInput",g))}});Object.defineProperty(ka.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(g){this._batchGroupId!==g&&(this.entity.enabled&&0<=this._batchGroupId&&this.system.app.batcher.remove(Da.ELEMENT,this.batchGroupId,this.entity),this.entity.enabled&&0<=g&&this.system.app.batcher.insert(Da.ELEMENT,g,this.entity),0>g&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):
this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=g)}});Object.defineProperty(ka.prototype,"maskedBy",{get:function(){return this._maskedBy}});var ia=function(g){Object.defineProperty(ka.prototype,g,{get:function(){return this._text?this._text[g]:this._image?this._image[g]:null},set:function(d){this._text?this._text[g]=d:this._image&&(this._image[g]=d)}})};ia("fontSize");ia("minFontSize");ia("maxFontSize");ia("maxLines");ia("autoFitWidth");ia("autoFitHeight");
ia("color");ia("font");ia("fontAsset");ia("spacing");ia("lineHeight");ia("wrapLines");ia("lines");ia("alignment");ia("autoWidth");ia("autoHeight");ia("rtlReorder");ia("unicodeConverter");ia("text");ia("key");ia("texture");ia("textureAsset");ia("material");ia("materialAsset");ia("sprite");ia("spriteAsset");ia("spriteFrame");ia("pixelsPerUnit");ia("opacity");ia("rect");ia("mask");ia("outlineColor");ia("outlineThickness");ia("shadowColor");ia("shadowOffset");ia("enableMarkup");ia("rangeStart");ia("rangeEnd");
var Tp=function(){this.enabled=!0},Zl=["enabled"],$l=function(g){function d(a){var c=g.call(this,a)||this;c.id="element";c.ComponentType=ka;c.DataType=Tp;c.schema=Zl;c._unicodeConverter=null;c._rtlReorder=null;c._defaultTexture=new X(a.graphicsDevice,{width:1,height:1,format:7});c._defaultTexture.name="element-system";a=c._defaultTexture.lock();var e=new Uint8Array(4);e[0]=255;e[1]=255;e[2]=255;e[3]=255;a.set(e);c._defaultTexture.unlock();c.defaultImageMaterial=null;c.defaultImage9SlicedMaterial=
null;c.defaultImage9TiledMaterial=null;c.defaultImageMaskMaterial=null;c.defaultImage9SlicedMaskMaterial=null;c.defaultImage9TiledMaskMaterial=null;c.defaultScreenSpaceImageMaterial=null;c.defaultScreenSpaceImage9SlicedMaterial=null;c.defaultScreenSpaceImage9TiledMaterial=null;c.defaultScreenSpaceImageMask9SlicedMaterial=null;c.defaultScreenSpaceImageMask9TiledMaterial=null;c.defaultScreenSpaceImageMaskMaterial=null;c.defaultTextMaterial=null;c.defaultBitmapTextMaterial=null;c.defaultScreenSpaceTextMaterial=
null;c.defaultScreenSpaceBitmapTextMaterial=null;c.defaultImageMaterials=[];c.on("beforeremove",c.onRemoveComponent,F(c));return c}K(d,g);var b=d.prototype;b.destroy=function(){this._defaultTexture.destroy()};b.initializeComponentData=function(a,c,e){a._beingInitialized=!0;void 0!==c.anchor&&(c.anchor instanceof Z?a.anchor.copy(c.anchor):a.anchor.set(c.anchor[0],c.anchor[1],c.anchor[2],c.anchor[3]));void 0!==c.pivot&&(c.pivot instanceof S?a.pivot.copy(c.pivot):a.pivot.set(c.pivot[0],c.pivot[1]));
var f=.001<Math.abs(a.anchor.x-a.anchor.z),h=.001<Math.abs(a.anchor.y-a.anchor.w),k=!1;void 0!==c.margin&&(c.margin instanceof Z?a.margin.copy(c.margin):a._margin.set(c.margin[0],c.margin[1],c.margin[2],c.margin[3]),k=!0);void 0!==c.left&&(a._margin.x=c.left,k=!0);void 0!==c.bottom&&(a._margin.y=c.bottom,k=!0);void 0!==c.right&&(a._margin.z=c.right,k=!0);void 0!==c.top&&(a._margin.w=c.top,k=!0);k&&(a.margin=a._margin);k=!1;void 0===c.width||f?f&&(k=!0):a.width=c.width;void 0===c.height||h?h&&(k=!0):
a.height=c.height;k&&(a.anchor=a.anchor);void 0!==c.enabled&&(a.enabled=c.enabled);void 0!==c.useInput&&(a.useInput=c.useInput);a.batchGroupId=void 0===c.batchGroupId||null===c.batchGroupId?-1:c.batchGroupId;c.layers&&Array.isArray(c.layers)&&(a.layers=c.layers.slice(0));void 0!==c.type&&(a.type=c.type);"image"===a.type?(void 0!==c.rect&&(a.rect=c.rect),void 0!==c.color&&(f=c.color,f instanceof Q||(f=new Q(c.color[0],c.color[1],c.color[2])),a.color=f),void 0!==c.opacity&&(a.opacity=c.opacity),void 0!==
c.textureAsset&&(a.textureAsset=c.textureAsset),c.texture&&(a.texture=c.texture),void 0!==c.spriteAsset&&(a.spriteAsset=c.spriteAsset),c.sprite&&(a.sprite=c.sprite),void 0!==c.spriteFrame&&(a.spriteFrame=c.spriteFrame),void 0!==c.pixelsPerUnit&&null!==c.pixelsPerUnit&&(a.pixelsPerUnit=c.pixelsPerUnit),void 0!==c.materialAsset&&(a.materialAsset=c.materialAsset),c.material&&(a.material=c.material),void 0!==c.mask&&(a.mask=c.mask)):"text"===a.type&&(void 0!==c.autoWidth&&(a.autoWidth=c.autoWidth),void 0!==
c.autoHeight&&(a.autoHeight=c.autoHeight),void 0!==c.rtlReorder&&(a.rtlReorder=c.rtlReorder),void 0!==c.unicodeConverter&&(a.unicodeConverter=c.unicodeConverter),null!==c.text&&void 0!==c.text?a.text=c.text:null!==c.key&&void 0!==c.key&&(a.key=c.key),void 0!==c.color&&(f=c.color,f instanceof Q||(f=new Q(f[0],f[1],f[2])),a.color=f),void 0!==c.opacity&&(a.opacity=c.opacity),void 0!==c.spacing&&(a.spacing=c.spacing),void 0!==c.fontSize&&(a.fontSize=c.fontSize,c.lineHeight||(a.lineHeight=c.fontSize)),
void 0!==c.lineHeight&&(a.lineHeight=c.lineHeight),void 0!==c.maxLines&&(a.maxLines=c.maxLines),void 0!==c.wrapLines&&(a.wrapLines=c.wrapLines),void 0!==c.minFontSize&&(a.minFontSize=c.minFontSize),void 0!==c.maxFontSize&&(a.maxFontSize=c.maxFontSize),c.autoFitWidth&&(a.autoFitWidth=c.autoFitWidth),c.autoFitHeight&&(a.autoFitHeight=c.autoFitHeight),void 0!==c.fontAsset&&(a.fontAsset=c.fontAsset),void 0!==c.font&&(a.font=c.font),void 0!==c.alignment&&(a.alignment=c.alignment),void 0!==c.outlineColor&&
(a.outlineColor=c.outlineColor),void 0!==c.outlineThickness&&(a.outlineThickness=c.outlineThickness),void 0!==c.shadowColor&&(a.shadowColor=c.shadowColor),void 0!==c.shadowOffset&&(a.shadowOffset=c.shadowOffset),void 0!==c.enableMarkup&&(a.enableMarkup=c.enableMarkup));f=a._parseUpToScreen();f.screen&&a._updateScreen(f.screen);g.prototype.initializeComponentData.call(this,a,c,e);a._beingInitialized=!1;"image"===a.type&&a._image._meshDirty&&a._image._updateMesh(a._image.mesh)};b.onRemoveComponent=
function(a,c){c.onRemove()};b.cloneComponent=function(a,c){a=a.element;var e={enabled:a.enabled,width:a.width,height:a.height,anchor:a.anchor.clone(),pivot:a.pivot.clone(),margin:a.margin.clone(),alignment:a.alignment&&a.alignment.clone()||a.alignment,autoWidth:a.autoWidth,autoHeight:a.autoHeight,type:a.type,rect:a.rect&&a.rect.clone()||a.rect,rtlReorder:a.rtlReorder,unicodeConverter:a.unicodeConverter,materialAsset:a.materialAsset,material:a.material,color:a.color&&a.color.clone()||a.color,opacity:a.opacity,
textureAsset:a.textureAsset,texture:a.texture,spriteAsset:a.spriteAsset,sprite:a.sprite,spriteFrame:a.spriteFrame,pixelsPerUnit:a.pixelsPerUnit,spacing:a.spacing,lineHeight:a.lineHeight,wrapLines:a.wrapLines,layers:a.layers,fontSize:a.fontSize,minFontSize:a.minFontSize,maxFontSize:a.maxFontSize,autoFitWidth:a.autoFitWidth,autoFitHeight:a.autoFitHeight,maxLines:a.maxLines,fontAsset:a.fontAsset,font:a.font,useInput:a.useInput,batchGroupId:a.batchGroupId,mask:a.mask,outlineColor:a.outlineColor&&a.outlineColor.clone()||
a.outlineColor,outlineThickness:a.outlineThickness,shadowColor:a.shadowColor&&a.shadowColor.clone()||a.shadowColor,shadowOffset:a.shadowOffset&&a.shadowOffset.clone()||a.shadowOffset,enableMarkup:a.enableMarkup};void 0!==a.key&&null!==a.key?e.key=a.key:e.text=a.text;return this.addComponent(c,e)};b.getTextElementMaterial=function(a,c){if(a){if(c)return this.defaultScreenSpaceTextMaterial||(this.defaultScreenSpaceTextMaterial=new ma,this.defaultScreenSpaceTextMaterial.name="defaultScreenSpaceTextMaterial",
this.defaultScreenSpaceTextMaterial.msdfMap=this._defaultTexture,this.defaultScreenSpaceTextMaterial.useLighting=!1,this.defaultScreenSpaceTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceTextMaterial.useFog=!1,this.defaultScreenSpaceTextMaterial.useSkybox=!1,this.defaultScreenSpaceTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceTextMaterial.emissive.set(1,1,1),this.defaultScreenSpaceTextMaterial.opacity=.5,this.defaultScreenSpaceTextMaterial.blendType=4,this.defaultScreenSpaceTextMaterial.depthWrite=
!1,this.defaultScreenSpaceTextMaterial.depthTest=!1,this.defaultScreenSpaceTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceTextMaterial.update()),this.defaultScreenSpaceTextMaterial;this.defaultScreenSpaceBitmapTextMaterial||(this.defaultScreenSpaceBitmapTextMaterial=new ma,this.defaultScreenSpaceBitmapTextMaterial.name="defaultScreenSpaceBitmapTextMaterial",this.defaultScreenSpaceBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultScreenSpaceBitmapTextMaterial.emissiveMap=this._defaultTexture,
this.defaultScreenSpaceBitmapTextMaterial.emissiveTint=!0,this.defaultScreenSpaceBitmapTextMaterial.opacity=.5,this.defaultScreenSpaceBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.opacityMapChannel="a",this.defaultScreenSpaceBitmapTextMaterial.useLighting=!1,this.defaultScreenSpaceBitmapTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceBitmapTextMaterial.useFog=!1,this.defaultScreenSpaceBitmapTextMaterial.useSkybox=!1,this.defaultScreenSpaceBitmapTextMaterial.diffuse.set(0,
0,0),this.defaultScreenSpaceBitmapTextMaterial.blendType=4,this.defaultScreenSpaceBitmapTextMaterial.depthWrite=!1,this.defaultScreenSpaceBitmapTextMaterial.depthTest=!1,this.defaultScreenSpaceBitmapTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceBitmapTextMaterial.update());return this.defaultScreenSpaceBitmapTextMaterial}if(c)return this.defaultTextMaterial||(this.defaultTextMaterial=new ma,this.defaultTextMaterial.name="defaultTextMaterial",this.defaultTextMaterial.msdfMap=this._defaultTexture,
this.defaultTextMaterial.useLighting=!1,this.defaultTextMaterial.useGammaTonemap=!1,this.defaultTextMaterial.useFog=!1,this.defaultTextMaterial.useSkybox=!1,this.defaultTextMaterial.diffuse.set(0,0,0),this.defaultTextMaterial.emissive.set(1,1,1),this.defaultTextMaterial.opacity=.5,this.defaultTextMaterial.blendType=4,this.defaultTextMaterial.depthWrite=!1,this.defaultTextMaterial.emissiveVertexColor=!0,this.defaultTextMaterial.update()),this.defaultTextMaterial;this.defaultBitmapTextMaterial||(this.defaultBitmapTextMaterial=
new ma,this.defaultBitmapTextMaterial.name="defaultBitmapTextMaterial",this.defaultBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultBitmapTextMaterial.emissiveTint=!0,this.defaultBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacity=.5,this.defaultBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacityMapChannel="a",this.defaultBitmapTextMaterial.useLighting=!1,this.defaultBitmapTextMaterial.useGammaTonemap=!1,this.defaultBitmapTextMaterial.useFog=
!1,this.defaultBitmapTextMaterial.useSkybox=!1,this.defaultBitmapTextMaterial.diffuse.set(0,0,0),this.defaultBitmapTextMaterial.blendType=4,this.defaultBitmapTextMaterial.depthWrite=!1,this.defaultBitmapTextMaterial.emissiveVertexColor=!0,this.defaultBitmapTextMaterial.update());return this.defaultBitmapTextMaterial};b._createBaseImageMaterial=function(){var a=new ma;a.diffuse.set(0,0,0);a.emissive.set(.5,.5,.5);a.emissiveMap=this._defaultTexture;a.emissiveTint=!0;a.opacityMap=this._defaultTexture;
a.opacityMapChannel="a";a.opacityTint=!0;a.opacity=0;a.useLighting=!1;a.useGammaTonemap=!1;a.useFog=!1;a.useSkybox=!1;a.blendType=4;a.depthWrite=!1;return a};b.getImageElementMaterial=function(a,c,e,f){if(a){if(c){if(e)return this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=
1,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),
this.defaultScreenSpaceImageMask9SlicedMaterial;if(f)return this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=
!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial;this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name=
"defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial));return this.defaultScreenSpaceImageMaskMaterial}if(e)return this.defaultScreenSpaceImage9SlicedMaterial||
(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial;if(f)return this.defaultScreenSpaceImage9TiledMaterial||
(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial;this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=
this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial));return this.defaultScreenSpaceImageMaterial}if(c){if(e)return this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",
this.defaultImage9SlicedMaskMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial;if(f)return this.defaultImage9TiledMaskMaterial||
(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=2,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),
this.defaultImage9TiledMaskMaterial;this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial));
return this.defaultImageMaskMaterial}if(e)return this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial;if(f)return this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),
this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=2,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial;this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial));return this.defaultImageMaterial};
b.registerUnicodeConverter=function(a){this._unicodeConverter=a};b.registerRtlReorder=function(a){this._rtlReorder=a};b.getUnicodeConverter=function(){return this._unicodeConverter};b.getRtlReorder=function(){return this._rtlReorder};return d}(O);ca._buildAccessors(ka.prototype,Zl);var Se=function(g){function d(b,a){b=g.call(this,b,a)||this;b._minWidth=0;b._minHeight=0;b._maxWidth=null;b._maxHeight=null;b._fitWidthProportion=0;b._fitHeightProportion=0;b._excludeFromLayout=!1;return b}K(d,g);return d}(ca);
Ac("minWidth");Ac("minHeight");Ac("maxWidth");Ac("maxHeight");Ac("fitWidthProportion");Ac("fitHeightProportion");Ac("excludeFromLayout");var Up=function(){this.enabled=!0},am=["enabled"],bm=function(g){function d(a){a=g.call(this,a)||this;a.id="layoutchild";a.ComponentType=Se;a.DataType=Up;a.schema=am;return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c,e){void 0!==c.enabled&&(a.enabled=c.enabled);void 0!==c.minWidth&&(a.minWidth=c.minWidth);void 0!==c.minHeight&&(a.minHeight=
c.minHeight);void 0!==c.maxWidth&&(a.maxWidth=c.maxWidth);void 0!==c.maxHeight&&(a.maxHeight=c.maxHeight);void 0!==c.fitWidthProportion&&(a.fitWidthProportion=c.fitWidthProportion);void 0!==c.fitHeightProportion&&(a.fitHeightProportion=c.fitHeightProportion);void 0!==c.excludeFromLayout&&(a.excludeFromLayout=c.excludeFromLayout);g.prototype.initializeComponentData.call(this,a,c,e)};b.cloneComponent=function(a,c){a=a.layoutchild;return this.addComponent(c,{enabled:a.enabled,minWidth:a.minWidth,minHeight:a.minHeight,
maxWidth:a.maxWidth,maxHeight:a.maxHeight,fitWidthProportion:a.fitWidthProportion,fitHeightProportion:a.fitHeightProportion,excludeFromLayout:a.excludeFromLayout})};return d}(O);ca._buildAccessors(Se.prototype,am);var fj={0:{axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},1:{axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",
fittingProportion:"fitHeightProportion"}},Sn={0:1,1:0},Rn={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},Za={NONE:"NONE",APPLY_STRETCHING:"APPLY_STRETCHING",APPLY_SHRINKING:"APPLY_SHRINKING"},cb=new S,Wh={};Wh[0]=ej(0);Wh[1]=ej(1);var cm=function(){function g(){}g.prototype.calculateLayout=function(d,b){var a=Wh[b.orientation];if(a)return a(d,b);throw Error("Unrecognized orientation value: "+
b.orientation);};return g}(),Te=function(g){function d(a,c){c=g.call(this,a,c)||this;c._orientation=0;c._reverseX=!1;c._reverseY=!0;c._alignment=new S(0,1);c._padding=new Z;c._spacing=new S;c._widthFitting=0;c._heightFitting=0;c._wrap=!1;c._layoutCalculator=new cm;c._listenForReflowEvents(c.entity,"on");c.entity.children.forEach(function(e){this._listenForReflowEvents(e,"on")}.bind(F(c)));c.entity.on("childinsert",c._onChildInsert,F(c));c.entity.on("childremove",c._onChildRemove,F(c));a.app.systems.element.on("add",
c._onElementOrLayoutComponentAdd,F(c));a.app.systems.element.on("beforeremove",c._onElementOrLayoutComponentRemove,F(c));a.app.systems.layoutchild.on("add",c._onElementOrLayoutComponentAdd,F(c));a.app.systems.layoutchild.on("beforeremove",c._onElementOrLayoutComponentRemove,F(c));return c}K(d,g);var b=d.prototype;b._isSelfOrChild=function(a){return a===this.entity||-1!==this.entity.children.indexOf(a)};b._listenForReflowEvents=function(a,c){a.element&&(a.element[c]("enableelement",this._scheduleReflow,
this),a.element[c]("disableelement",this._scheduleReflow,this),a.element[c]("resize",this._scheduleReflow,this),a.element[c]("set:pivot",this._scheduleReflow,this));a.layoutchild&&(a.layoutchild[c]("set_enabled",this._scheduleReflow,this),a.layoutchild[c]("resize",this._scheduleReflow,this))};b._onElementOrLayoutComponentAdd=function(a){this._isSelfOrChild(a)&&(this._listenForReflowEvents(a,"on"),this._scheduleReflow())};b._onElementOrLayoutComponentRemove=function(a){this._isSelfOrChild(a)&&(this._listenForReflowEvents(a,
"off"),this._scheduleReflow())};b._onChildInsert=function(a){this._listenForReflowEvents(a,"on");this._scheduleReflow()};b._onChildRemove=function(a){this._listenForReflowEvents(a,"off");this._scheduleReflow()};b._scheduleReflow=function(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)};b.reflow=function(){var a=this.entity.element,c=this.entity.children.filter(Un).map(Tn);a&&0!==c.length&&(a={orientation:this._orientation,reverseX:this._reverseX,
reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new S(Math.max(a.calculatedWidth,0),Math.max(a.calculatedHeight,0))},this._isPerformingReflow=!0,c=this._layoutCalculator.calculateLayout(c,a),this._isPerformingReflow=!1,this.fire("reflow",c))};b.onEnable=function(){this._scheduleReflow()};b.onRemove=function(){this.entity.off("childinsert",this._onChildInsert,
this);this.entity.off("childremove",this._onChildRemove,this);this._listenForReflowEvents(this.entity,"off");this.entity.children.forEach(function(a){this._listenForReflowEvents(a,"off")}.bind(this));this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this);this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this);this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this);this.system.app.systems.layoutchild.off("beforeremove",
this._onElementOrLayoutComponentRemove,this)};return d}(ca);Pb("orientation");Pb("reverseX");Pb("reverseY");Pb("alignment");Pb("padding");Pb("spacing");Pb("widthFitting");Pb("heightFitting");Pb("wrap");var Vp=function(){this.enabled=!0},dm=["enabled"],em=function(g){function d(a){a=g.call(this,a)||this;a.id="layoutgroup";a.ComponentType=Te;a.DataType=Vp;a.schema=dm;a._reflowQueue=[];a.on("beforeremove",a._onRemoveComponent,F(a));O.bind("postUpdate",a._onPostUpdate,F(a));return a}K(d,g);var b=d.prototype;
b.initializeComponentData=function(a,c,e){void 0!==c.enabled&&(a.enabled=c.enabled);void 0!==c.orientation&&(a.orientation=c.orientation);void 0!==c.reverseX&&(a.reverseX=c.reverseX);void 0!==c.reverseY&&(a.reverseY=c.reverseY);void 0!==c.alignment&&(c.alignment instanceof S?a.alignment.copy(c.alignment):a.alignment.set(c.alignment[0],c.alignment[1]),a.alignment=a.alignment);void 0!==c.padding&&(c.padding instanceof Z?a.padding.copy(c.padding):a.padding.set(c.padding[0],c.padding[1],c.padding[2],
c.padding[3]),a.padding=a.padding);void 0!==c.spacing&&(c.spacing instanceof S?a.spacing.copy(c.spacing):a.spacing.set(c.spacing[0],c.spacing[1]),a.spacing=a.spacing);void 0!==c.widthFitting&&(a.widthFitting=c.widthFitting);void 0!==c.heightFitting&&(a.heightFitting=c.heightFitting);void 0!==c.wrap&&(a.wrap=c.wrap);g.prototype.initializeComponentData.call(this,a,c,e)};b.cloneComponent=function(a,c){a=a.layoutgroup;return this.addComponent(c,{enabled:a.enabled,orientation:a.orientation,reverseX:a.reverseX,
reverseY:a.reverseY,alignment:a.alignment,padding:a.padding,spacing:a.spacing,widthFitting:a.widthFitting,heightFitting:a.heightFitting,wrap:a.wrap})};b.scheduleReflow=function(a){-1===this._reflowQueue.indexOf(a)&&this._reflowQueue.push(a)};b._onPostUpdate=function(){this._processReflowQueue()};b._processReflowQueue=function(){if(0!==this._reflowQueue.length)for(var a=0;0<this._reflowQueue.length;){var c=this._reflowQueue.slice();this._reflowQueue.length=0;c.sort(function(f,h){return f.entity.graphDepth-
h.entity.graphDepth});for(var e=0;e<c.length;++e)c[e].reflow();if(100<=++a){console.warn("Max reflow iterations limit reached, bailing.");break}}};b._onRemoveComponent=function(a,c){c.onRemove()};return d}(O);ca._buildAccessors(Te.prototype,dm);var Vf=new A,Wf=new A,Xh=new A,Yh={r:0,g:1,b:2,a:3},fm=function(){function g(){this._type=0;this._color=new Q(.8,.8,.8);this._intensity=1;this.enabled=this._castShadows=!1;this.mask=1;this.isStatic=!1;this.key=0;this.bakeDir=!0;this.attenuationEnd=this.attenuationStart=
10;this._shadowType=this._falloffMode=0;this._vsmBlurSize=11;this.vsmBlurMode=1;this.vsmBias=.0025;this._cookie=null;this.cookieIntensity=1;this._cookieFalloff=!0;this._cookieChannel="rgb";this._cookieTransform=null;this._cookieTransformUniform=new Float32Array(4);this._cookieOffset=null;this._cookieOffsetUniform=new Float32Array(2);this._cookieOffsetSet=this._cookieTransformSet=!1;this._innerConeAngle=40;this._outerConeAngle=45;this._shape=0;this._finalColor=new Float32Array([.8,.8,.8]);var b=Math.pow(this._finalColor[0],
2.2);this._linearFinalColor=new Float32Array([b,b,b]);this._position=new A(0,0,0);this._direction=new A(0,0,0);this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180);this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180);this._shadowCamera=null;this._shadowMatrix=new M;this.shadowDistance=40;this._shadowResolution=1024;this.shadowBias=-5E-4;this._normalOffsetBias=0;this.shadowUpdateMode=2;this._node=this._scene=null;this._rendererParams=[];this._isVsm=!1;this._isPcf=!0;this._isCachedShadowMap=
this._cacheShadowMap=!1;this._visibleLength=[0];this._visibleList=[[]];this._visibleCameraSettings=[]}var d=g.prototype;d.destroy=function(){this._destroyShadowMap()};d.clone=function(){var b=new g;b.type=this._type;b.setColor(this._color);b.intensity=this._intensity;b.castShadows=this.castShadows;b.enabled=this.enabled;b.attenuationStart=this.attenuationStart;b.attenuationEnd=this.attenuationEnd;b.falloffMode=this._falloffMode;b.shadowType=this._shadowType;b.vsmBlurSize=this._vsmBlurSize;b.vsmBlurMode=
this.vsmBlurMode;b.vsmBias=this.vsmBias;b.shadowUpdateMode=this.shadowUpdateMode;b.mask=this.mask;b.innerConeAngle=this._innerConeAngle;b.outerConeAngle=this._outerConeAngle;b.shape=this._shape;b.shadowBias=this.shadowBias;b.normalOffsetBias=this._normalOffsetBias;b.shadowResolution=this._shadowResolution;b.shadowDistance=this.shadowDistance;return b};d.getColor=function(){return this._color};d.getBoundingSphere=function(b){if(2===this._type){var a=this.attenuationEnd,c=this._outerConeAngle,e=Math.cos(c*
R.DEG_TO_RAD),f=this._node;Vf.copy(f.up);Vf.scale(.5*-a*e);Vf.add(f.getPosition());b.center=Vf;Wf.copy(f.up);Wf.scale(-a);Xh.copy(f.right);Xh.scale(Math.sin(c*R.DEG_TO_RAD)*a);Wf.add(Xh);b.radius=.5*Wf.length()}else 1===this._type&&(b.center=this._node.getPosition(),b.radius=this.attenuationEnd)};d.getBoundingBox=function(b){if(2===this._type){var a=this.attenuationEnd,c=this._node,e=Math.abs(Math.sin(this._outerConeAngle*R.DEG_TO_RAD)*a);b.center.set(0,.5*-a,0);b.halfExtents.set(e,.5*a,e);b.setFromTransformedAabb(b,
c.getWorldTransform())}else 1===this._type&&(b.center.copy(this._node.getPosition()),b.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))};d._updateFinalColor=function(){var b=this._color,a=b.r,c=b.g;b=b.b;var e=this._intensity,f=this._finalColor,h=this._linearFinalColor;f[0]=a*e;f[1]=c*e;f[2]=b*e;1<=e?(h[0]=Math.pow(a,2.2)*e,h[1]=Math.pow(c,2.2)*e,h[2]=Math.pow(b,2.2)*e):(h[0]=Math.pow(f[0],2.2),h[1]=Math.pow(f[1],2.2),h[2]=Math.pow(f[2],2.2))};d.setColor=function(){if(1===
arguments.length){var b=arguments[0].r;var a=arguments[0].g;var c=arguments[0].b}else 3===arguments.length&&(b=arguments[0],a=arguments[1],c=arguments[2]);this._color.set(b,a,c);this._updateFinalColor()};d._destroyShadowMap=function(){if(this._shadowCamera){if(!this._isCachedShadowMap){var b=this._shadowCamera.renderTarget,a;if(b)if(b.length)for(a=0;a<b.length;a++)b[a].colorBuffer&&b[a].colorBuffer.destroy(),b[a].destroy();else b.colorBuffer&&b.colorBuffer.destroy(),b.depthBuffer&&b.depthBuffer.destroy(),
b.destroy()}this._shadowCubeMap=this._shadowCamera=this._shadowCamera.renderTarget=null;0===this.shadowUpdateMode&&(this.shadowUpdateMode=1)}};d.updateShadow=function(){2!==this.shadowUpdateMode&&(this.shadowUpdateMode=1)};d.updateKey=function(){var b=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|Yh[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<
9;3===this._cookieChannel.length&&(b|=Yh[this._cookieChannel.charAt(1)]<<16,b|=Yh[this._cookieChannel.charAt(2)]<<14);b!==this.key&&null!==this._scene&&(this._scene.layers._dirtyLights=!0);this.key=b};d.uploadAreaLightLUTs=function(){function b(n,p,t){n=new X(n,{width:64,height:64,format:t,addressU:1,addressV:1,type:"default",magFilter:1,minFilter:0,anisotropy:1});n.lock().set(p);n.unlock();n.upload();return n}function a(n,p,t){for(var r=n.length,u=new Float32Array(r),v=0;v<r;v++){var w=v%4;u[v]=
(n[v]+p[w])*t[w]}return u}function c(n){for(var p=n.length,t=new Uint16Array(p),r=R.float2Half,u=0;u<p;u++)t[u]=r(n[u]);return t}function e(n){for(var p=n.length,t=new Uint8ClampedArray(p),r=0;r<p;r++)t[r]=255*n[r];return t}var f=qa.getApplication(),h=pc._areaLightLutData;if(h&&!h.ready){h.ready=!0;f=f.graphicsDevice;var k=f._areaLightLutFormat;if(14===k){var m=h.data1;h=h.data2}else 12===k?(m=c(h.data1),h=c(h.data2)):(m=e(a(h.data1,[0,.2976,.01381,0],[.999,3.08737,1.6546,.603249])),h=e(a(h.data2,
[-.306897,0,0,0],[1.442787,1,1,1])));m=b(f,m,k);k=b(f,h,k);f.scope.resolve("areaLightsLutTex1").setValue(m);f.scope.resolve("areaLightsLutTex2").setValue(k)}};N(g,[{key:"type",get:function(){return this._type},set:function(b){this._type!==b&&(this._type=b,this._destroyShadowMap(),this.updateKey(),b=this._shadowType,this._shadowType=null,this.shadowType=b)}},{key:"shape",get:function(){return this._shape},set:function(b){void 0===b&&(b=0);this._shape!==b&&(0!==b&&this.uploadAreaLightLUTs(),this._shape=
b,this._destroyShadowMap(),this.updateKey(),b=this._shadowType,this._shadowType=null,this.shadowType=b)}},{key:"shadowType",get:function(){return this._shadowType},set:function(b){if(this._shadowType!==b){var a=qa.getApplication().graphicsDevice;1===this._type&&(b=0);4!==b||a.webgl2||(b=0);3!==b||a.textureFloatRenderable||(b=2);2!==b||a.textureHalfFloatRenderable||(b=1);this._isVsm=1<=b&&3>=b;this._isPcf=4===b||0===b;this._shadowType=b;this._destroyShadowMap();this.updateKey()}}},{key:"castShadows",
get:function(){return this._castShadows&&4!==this.mask&&0!==this.mask},set:function(b){this._castShadows!==b&&(this._castShadows=b,this.updateKey())}},{key:"shadowResolution",get:function(){return this._shadowResolution},set:function(b){if(this._shadowResolution!==b){var a=qa.getApplication().graphicsDevice;this._shadowResolution=b=1===this._type?Math.min(b,a.maxCubeMapSize):Math.min(b,a.maxTextureSize)}}},{key:"vsmBlurSize",get:function(){return this._vsmBlurSize},set:function(b){this._vsmBlurSize!==
b&&(0===b%2&&b++,this._vsmBlurSize=b)}},{key:"normalOffsetBias",get:function(){return this._normalOffsetBias},set:function(b){this._normalOffsetBias!==b&&((!this._normalOffsetBias&&b||this._normalOffsetBias&&!b)&&this.updateKey(),this._normalOffsetBias=b)}},{key:"falloffMode",get:function(){return this._falloffMode},set:function(b){this._falloffMode!==b&&(this._falloffMode=b,this.updateKey())}},{key:"innerConeAngle",get:function(){return this._innerConeAngle},set:function(b){this._innerConeAngle!==
b&&(this._innerConeAngle=b,this._innerConeAngleCos=Math.cos(b*Math.PI/180))}},{key:"outerConeAngle",get:function(){return this._outerConeAngle},set:function(b){this._outerConeAngle!==b&&(this._outerConeAngle=b,this._outerConeAngleCos=Math.cos(b*Math.PI/180))}},{key:"intensity",get:function(){return this._intensity},set:function(b){this._intensity!==b&&(this._intensity=b,this._updateFinalColor())}},{key:"cookie",get:function(){return this._cookie},set:function(b){this._cookie!==b&&(this._cookie=b,
this.updateKey())}},{key:"cookieFalloff",get:function(){return this._cookieFalloff},set:function(b){this._cookieFalloff!==b&&(this._cookieFalloff=b,this.updateKey())}},{key:"cookieChannel",get:function(){return this._cookieChannel},set:function(b){if(this._cookieChannel!==b){if(3>b.length)for(var a=b.charAt(b.length-1),c=3-b.length,e=0;e<c;e++)b+=a;this._cookieChannel=b;this.updateKey()}}},{key:"cookieTransform",get:function(){return this._cookieTransform},set:function(b){this._cookieTransform!==
b&&(this._cookieTransform=b,this._cookieTransformSet=!!b,b&&!this._cookieOffset&&(this.cookieOffset=new S,this._cookieOffsetSet=!1),this.updateKey())}},{key:"cookieOffset",get:function(){return this._cookieOffset},set:function(b){this._cookieOffset!==b&&((this._cookieTransformSet||b)&&!b&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=b,this._cookieOffsetSet=!!b,b&&!this._cookieTransform&&(this.cookieTransform=new Z(1,1,0,0),this._cookieTransformSet=!1),this.updateKey())}}]);return g}(),
$c=[],gj=[],Ue=function(g){function d(a,c){a=g.call(this,a,c)||this;a._cookieAsset=null;a._cookieAssetId=null;a._cookieAssetAdd=!1;a._cookieMatrix=null;return a}K(d,g);var b=d.prototype;b.addLightToLayers=function(){for(var a,c=0;c<this.layers.length;c++)(a=this.system.app.scene.layers.getLayerById(this.layers[c]))&&a.addLight(this)};b.removeLightFromLayers=function(){for(var a,c=0;c<this.layers.length;c++)(a=this.system.app.scene.layers.getLayerById(this.layers[c]))&&a.removeLight(this)};b.onLayersChanged=
function(a,c){this.enabled&&this.entity.enabled&&this.addLightToLayers();a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);c.on("add",this.onLayerAdded,this);c.on("remove",this.onLayerRemoved,this)};b.onLayerAdded=function(a){0>this.layers.indexOf(a.id)||this.enabled&&this.entity.enabled&&a.addLight(this)};b.onLayerRemoved=function(a){0>this.layers.indexOf(a.id)||a.removeLight(this)};b.refreshProperties=function(){for(var a,c=0;c<$c.length;c++)a=$c[c],this[a]=this[a];if(this.enabled&&
this.entity.enabled)this.onEnable()};b.updateShadow=function(){this.light.updateShadow()};b.onCookieAssetSet=function(){var a=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(a=this._cookieAsset.loadFaces=!0);this._cookieAsset.resource&&!a||this.system.app.assets.load(this._cookieAsset);if(this._cookieAsset.resource)this.onCookieAssetLoad()};b.onCookieAssetAdd=function(a){if(this._cookieAssetId===a.id){this._cookieAsset=a;if(this.light.enabled)this.onCookieAssetSet();this._cookieAsset.on("load",
this.onCookieAssetLoad,this);this._cookieAsset.on("remove",this.onCookieAssetRemove,this)}};b.onCookieAssetLoad=function(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)};b.onCookieAssetRemove=function(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",
this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)};b.onEnable=function(){this.light.enabled=!0;this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&this.addLightToLayers();if(this._cookieAsset&&!this.cookie)this.onCookieAssetSet()};b.onDisable=function(){this.light.enabled=
!1;this.system.app.scene.off("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));this.removeLightFromLayers()};b.onRemove=function(){this.onDisable();this.light.destroy();this.cookieAsset=null};return d}(ca);(function(){ja("enabled",!0,function(g,d){this.onSetEnabled(null,d,g)});ja("light",null);ja("type","directional",function(g,d){this.system.changeType(this,
d,g);this.refreshProperties()});ja("color",new Q(1,1,1),function(g,d){this.light.setColor(g)},!0);ja("intensity",1,function(g,d){this.light.intensity=g});ja("shape",0,function(g,d){this.light.shape=g});ja("castShadows",!1,function(g,d){this.light.castShadows=g});ja("shadowDistance",40,function(g,d){this.light.shadowDistance=g});ja("shadowResolution",1024,function(g,d){this.light.shadowResolution=g});ja("shadowBias",.05,function(g,d){this.light.shadowBias=-.01*g});ja("normalOffsetBias",0,function(g,
d){this.light.normalOffsetBias=g});ja("range",10,function(g,d){this.light.attenuationEnd=g});ja("innerConeAngle",40,function(g,d){this.light.innerConeAngle=g});ja("outerConeAngle",45,function(g,d){this.light.outerConeAngle=g});ja("falloffMode",0,function(g,d){this.light.falloffMode=g});ja("shadowType",0,function(g,d){this.light.shadowType=g});ja("vsmBlurSize",11,function(g,d){this.light.vsmBlurSize=g});ja("vsmBlurMode",1,function(g,d){this.light.vsmBlurMode=g});ja("vsmBias",.0025,function(g,d){this.light.vsmBias=
g});ja("cookieAsset",null,function(g,d){if(!this._cookieAssetId||!(g instanceof fa&&g.id===this._cookieAssetId||g===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,g instanceof fa)this._cookieAssetId=this.data.cookieAsset=g.id,this.onCookieAssetAdd(g);else if("number"===typeof g)if(this._cookieAssetId=g,g=this.system.app.assets.get(g))this.onCookieAssetAdd(g);else this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this)});
ja("cookie",null,function(g,d){this.light.cookie=g});ja("cookieIntensity",1,function(g,d){this.light.cookieIntensity=g});ja("cookieFalloff",!0,function(g,d){this.light.cookieFalloff=g});ja("cookieChannel","rgb",function(g,d){this.light.cookieChannel=g});ja("cookieAngle",0,function(g,d){if(0!==g||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new Z);var b=d=1;this.cookieScale&&(d=this.cookieScale.x,b=this.cookieScale.y);var a=Math.cos(g*R.DEG_TO_RAD);g=Math.sin(g*R.DEG_TO_RAD);this._cookieMatrix.set(a/
d,-g/d,g/b,a/b);this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null});ja("cookieScale",null,function(g,d){if(null!==g||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new Z);d=g.x;g=g.y;var b=Math.cos(this.cookieAngle*R.DEG_TO_RAD),a=Math.sin(this.cookieAngle*R.DEG_TO_RAD);this._cookieMatrix.set(b/d,-a/d,a/g,b/g);this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null},!0);ja("cookieOffset",null,function(g,d){this.light.cookieOffset=
g},!0);ja("shadowUpdateMode",2,function(g,d){this.light.shadowUpdateMode=g});ja("mask",1,function(g,d){this.light.mask=g});ja("affectDynamic",!0,function(g,d){this.light.mask=g?this.light.mask|1:this.light.mask&-2});ja("affectLightmapped",!1,function(g,d){g?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))});ja("bake",!1,function(g,d){g?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&
(this.light.mask|=2))});ja("bakeDir",!0,function(g,d){this.light.bakeDir=g});ja("isStatic",!1,function(g,d){this.light.isStatic=g});ja("layers",[0],function(g,d){var b,a;for(b=0;b<d.length;b++)(a=this.system.app.scene.layers.getLayerById(d[b]))&&a.removeLight(this);for(b=0;b<g.length;b++)(a=this.system.app.scene.layers.getLayerById(g[b]))&&this.enabled&&this.entity.enabled&&a.addLight(this)})})();var Wp=function(){for(var g=$c,d=gj,b,a=0;a<g.length;a++)b=d[a],this[g[a]]=b&&b.clone?b.clone():b},gm=
{directional:0,omni:1,point:1,spot:2},hm=function(g){function d(a){a=g.call(this,a)||this;a.id="light";a.ComponentType=Ue;a.DataType=Wp;a.on("beforeremove",a._onRemoveComponent,F(a));return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c){for(var e=$c,f={},h=0,k=e.length;h<k;h++){var m=e[h];f[m]=c[m]}f.type||(f.type=a.data.type);a.data.type=f.type;f.layers&&Array.isArray(f.layers)&&(f.layers=f.layers.slice(0));f.color&&Array.isArray(f.color)&&(f.color=new Q(f.color[0],f.color[1],
f.color[2]));f.cookieOffset&&f.cookieOffset instanceof Array&&(f.cookieOffset=new S(f.cookieOffset[0],f.cookieOffset[1]));f.cookieScale&&f.cookieScale instanceof Array&&(f.cookieScale=new S(f.cookieScale[0],f.cookieScale[1]));f.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),f.enabled=f.enable);c=new fm;c.type=gm[f.type];c._node=a.entity;c._scene=this.app.scene;a.data.light=c;g.prototype.initializeComponentData.call(this,a,f,e)};b._onRemoveComponent=
function(a,c){c.onRemove()};b.cloneComponent=function(a,c){a=a.light;for(var e=[],f,h=$c,k=0;k<h.length;k++)f=h[k],"light"!==f&&(e[f]=a[f]&&a[f].clone?a[f].clone():a[f]);this.addComponent(c,e)};b.changeType=function(a,c,e){c!==e&&(a.light.type=gm[e])};return d}(O),Xf=function(g){function d(a,c){var e=g.call(this,a,c)||this;e._type="asset";e._asset=null;e._model=null;e._mapping={};e._castShadows=!0;e._receiveShadows=!0;e._materialAsset=null;e._material=a.defaultMaterial;e._castShadowsLightmap=!0;e._lightmapped=
!1;e._lightmapSizeMultiplier=1;e._isStatic=!1;e._layers=[0];e._batchGroupId=-1;e._aabb=null;e._area=null;e._assetOld=0;e._materialEvents=null;e._dirtyModelAsset=!1;e._dirtyMaterialAsset=!1;e._clonedModel=!1;c.on("remove",e.onRemoveChild,F(e));c.on("insert",e.onInsertChild,F(e));return e}K(d,g);var b=d.prototype;b.addModelToLayers=function(){for(var a,c=this.system.app.scene.layers,e=0;e<this._layers.length;e++)(a=c.getLayerById(this._layers[e]))&&a.addMeshInstances(this.meshInstances)};b.removeModelFromLayers=
function(){for(var a,c=this.system.app.scene.layers,e=0;e<this._layers.length;e++)(a=c.getLayerById(this._layers[e]))&&a.removeMeshInstances(this.meshInstances)};b.onRemoveChild=function(){this._model&&this.removeModelFromLayers()};b.onInsertChild=function(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()};b.onRemove=function(){"asset"===this.type?this.asset=null:this.model=null;this.materialAsset=null;this._unsetMaterialEvents();this.entity.off("remove",this.onRemoveChild,
this);this.entity.off("insert",this.onInsertChild,this)};b.onLayersChanged=function(a,c){this.addModelToLayers();a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);c.on("add",this.onLayerAdded,this);c.on("remove",this.onLayerRemoved,this)};b.onLayerAdded=function(a){0>this.layers.indexOf(a.id)||a.addMeshInstances(this.meshInstances)};b.onLayerRemoved=function(a){0>this.layers.indexOf(a.id)||a.removeMeshInstances(this.meshInstances)};b._setMaterialEvent=function(a,c,e,f){c=
c+":"+e;this.system.app.assets.on(c,f,this);this._materialEvents||(this._materialEvents=[]);this._materialEvents[a]||(this._materialEvents[a]={});this._materialEvents[a][c]={id:e,handler:f}};b._unsetMaterialEvents=function(){var a=this.system.app.assets,c=this._materialEvents;if(c){for(var e=0,f=c.length;e<f;e++)if(c[e]){var h=c[e],k;for(k in h)a.off(k,h[k].handler,this)}this._materialEvents=null}};b._getAssetByIdOrPath=function(a){var c=null;isNaN(parseInt(a,10))?this.asset&&(a=this._getMaterialAssetUrl(a))&&
(c=this.system.app.assets.getByUrl(a)):c=this.system.app.assets.get(a);return c};b._getMaterialAssetUrl=function(a){if(!this.asset)return null;var c=this.system.app.assets.get(this.asset);return c?c.getAbsoluteUrl(a):null};b._loadAndSetMeshInstanceMaterial=function(a,c,e){var f=this.system.app.assets;a&&(a.resource?(c.material=a.resource,this._setMaterialEvent(e,"remove",a.id,function(){c.material=this.system.defaultMaterial})):(this._setMaterialEvent(e,"load",a.id,function(h){c.material=h.resource;
this._setMaterialEvent(e,"remove",a.id,function(){c.material=this.system.defaultMaterial})}),this.enabled&&this.entity.enabled&&f.load(a)))};b.onEnable=function(){var a=this.system.app,c=a.scene;c.on("set:layers",this.onLayersChanged,this);c.layers&&(c.layers.on("add",this.onLayerAdded,this),c.layers.on("remove",this.onLayerRemoved,this));c="asset"===this._type;var e;this._model?this.addModelToLayers():c&&this._asset&&(e=a.assets.get(this._asset))&&e.resource!==this._model&&this._bindModelAsset(e);
this._materialAsset&&(e=a.assets.get(this._materialAsset))&&e.resource!==this._material&&this._bindMaterialAsset(e);if(c&&this._mapping)for(var f in this._mapping)this._mapping[f]&&(e=this._getAssetByIdOrPath(this._mapping[f]))&&!e.resource&&a.assets.load(e);0<=this._batchGroupId&&a.batcher.insert(Da.MODEL,this.batchGroupId,this.entity)};b.onDisable=function(){var a=this.system.app,c=a.scene;c.off("set:layers",this.onLayersChanged,this);c.layers&&(c.layers.off("add",this.onLayerAdded,this),c.layers.off("remove",
this.onLayerRemoved,this));0<=this._batchGroupId&&a.batcher.remove(Da.MODEL,this.batchGroupId,this.entity);this._model&&this.removeModelFromLayers()};b.hide=function(){if(this._model){var a,c=this._model.meshInstances;var e=0;for(a=c.length;e<a;e++)c[e].visible=!1}};b.show=function(){if(this._model){var a,c=this._model.meshInstances;var e=0;for(a=c.length;e<a;e++)c[e].visible=!0}};b._bindMaterialAsset=function(a){a.on("load",this._onMaterialAssetLoad,this);a.on("unload",this._onMaterialAssetUnload,
this);a.on("remove",this._onMaterialAssetRemove,this);a.on("change",this._onMaterialAssetChange,this);a.resource?this._onMaterialAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)};b._unbindMaterialAsset=function(a){a.off("load",this._onMaterialAssetLoad,this);a.off("unload",this._onMaterialAssetUnload,this);a.off("remove",this._onMaterialAssetRemove,this);a.off("change",this._onMaterialAssetChange,this)};b._onMaterialAssetAdd=function(a){this.system.app.assets.off("add:"+
a.id,this._onMaterialAssetAdd,this);this._materialAsset===a.id&&this._bindMaterialAsset(a)};b._onMaterialAssetLoad=function(a){this._setMaterial(a.resource)};b._onMaterialAssetUnload=function(a){this._setMaterial(this.system.defaultMaterial)};b._onMaterialAssetRemove=function(a){this._onMaterialAssetUnload(a)};b._onMaterialAssetChange=function(a){};b._bindModelAsset=function(a){this._unbindModelAsset(a);a.on("load",this._onModelAssetLoad,this);a.on("unload",this._onModelAssetUnload,this);a.on("change",
this._onModelAssetChange,this);a.on("remove",this._onModelAssetRemove,this);a.resource?this._onModelAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)};b._unbindModelAsset=function(a){a.off("load",this._onModelAssetLoad,this);a.off("unload",this._onModelAssetUnload,this);a.off("change",this._onModelAssetChange,this);a.off("remove",this._onModelAssetRemove,this)};b._onModelAssetAdded=function(a){this.system.app.assets.off("add:"+a.id,this._onModelAssetAdded,this);a.id===
this._asset&&this._bindModelAsset(a)};b._onModelAssetLoad=function(a){this.model=a.resource.clone();this._clonedModel=!0};b._onModelAssetUnload=function(a){this.model=null};b._onModelAssetChange=function(a,c,e,f){"data"===c&&(this.mapping=this._mapping)};b._onModelAssetRemove=function(a){this.model=null};b._setMaterial=function(a){if(this._material!==a){this._material=a;var c=this._model;if(c&&"asset"!==this._type){c=c.meshInstances;for(var e=0,f=c.length;e<f;e++)c[e].material=a}}};N(d,[{key:"meshInstances",
get:function(){return this._model?this._model.meshInstances:null},set:function(a){this._model&&(this._model.meshInstances=a)}},{key:"aabb",get:function(){return this._aabb},set:function(a){this._aabb=a;if(a=this._model.meshInstances)for(var c=0;c<a.length;c++)a[c].setOverrideAabb(this._aabb)}},{key:"type",get:function(){return this._type},set:function(a){if(this._type!==a)if(this._area=null,this._type=a,"asset"===a)null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else{a=Si(this.system.app.graphicsDevice,
a);this._area=a.area;a=a.mesh;var c=new pa,e=new fb;e.graph=c;e.meshInstances=[new Ga(c,a,this._material)];this.system._inTools&&e.generateWireframe();this.model=e;this._asset=null}}},{key:"asset",get:function(){return this._asset},set:function(a){var c=this.system.app.assets,e=a;a instanceof fa&&(e=a.id);this._asset!==e&&(this._asset&&(c.off("add:"+this._asset,this._onModelAssetAdded,this),(a=c.get(this._asset))&&this._unbindModelAsset(a)),(this._asset=e)?(e=c.get(this._asset))?this._bindModelAsset(e):
(this.model=null,c.on("add:"+this._asset,this._onModelAssetAdded,this)):this.model=null)}},{key:"model",get:function(){return this._model},set:function(a){if(!(this._model===a||a&&a._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this.entity.removeChild(this._model.getGraph()),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=a)){this._model._immutable=!0;var c=this._model.meshInstances;for(a=0;a<c.length;a++)c[a].castShadow=
this._castShadows,c[a].receiveShadow=this._receiveShadows,c[a].isStatic=this._isStatic,c[a].setOverrideAabb(this._aabb);this.lightmapped=this._lightmapped;this.entity.addChild(this._model.graph);this.enabled&&this.entity.enabled&&this.addModelToLayers();this._model._entity=this.entity;this.entity.animation&&this.entity.animation.setModel(this._model);this.entity.anim&&this.entity.anim.resetStateGraph();"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}},{key:"lightmapped",
get:function(){return this._lightmapped},set:function(a){if(a!==this._lightmapped&&(this._lightmapped=a,this._model))for(var c=this._model.meshInstances,e=0;e<c.length;e++)c[e].setLightmapped(a)}},{key:"castShadows",get:function(){return this._castShadows},set:function(a){if(this._castShadows!==a){var c,e,f=this._model;if(f){var h=this.layers,k=this.system.app.scene;if(this._castShadows&&!a)for(e=0;e<h.length;e++)(c=this.system.app.scene.layers.getLayerById(this.layers[e]))&&c.removeShadowCasters(f.meshInstances);
c=f.meshInstances;for(e=0;e<c.length;e++)c[e].castShadow=a;if(!this._castShadows&&a)for(e=0;e<h.length;e++)(c=k.layers.getLayerById(h[e]))&&c.addShadowCasters(f.meshInstances)}this._castShadows=a}}},{key:"receiveShadows",get:function(){return this._receiveShadows},set:function(a){if(this._receiveShadows!==a&&(this._receiveShadows=a,this._model))for(var c=this._model.meshInstances,e=0,f=c.length;e<f;e++)c[e].receiveShadow=a}},{key:"castShadowsLightmap",get:function(){return this._castShadowsLightmap},
set:function(a){this._castShadowsLightmap=a}},{key:"lightmapSizeMultiplier",get:function(){return this._lightmapSizeMultiplier},set:function(a){this._lightmapSizeMultiplier=a}},{key:"isStatic",get:function(){return this._isStatic},set:function(a){if(this._isStatic!==a){this._isStatic=a;var c;if(this._model){var e=this._model.meshInstances;for(c=0;c<e.length;c++){var f=e[c];f.isStatic=a}}}}},{key:"layers",get:function(){return this._layers},set:function(a){var c,e,f=this.system.app.scene.layers;if(this.meshInstances)for(c=
0;c<this._layers.length;c++)(e=f.getLayerById(this._layers[c]))&&e.removeMeshInstances(this.meshInstances);for(c=this._layers.length=0;c<a.length;c++)this._layers[c]=a[c];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(c=0;c<this._layers.length;c++)(e=f.getLayerById(this._layers[c]))&&e.addMeshInstances(this.meshInstances)}},{key:"batchGroupId",get:function(){return this._batchGroupId},set:function(a){if(this._batchGroupId!==a){var c=this.system.app.batcher;this.entity.enabled&&0<=this._batchGroupId&&
c.remove(Da.MODEL,this.batchGroupId,this.entity);this.entity.enabled&&0<=a&&c.insert(Da.MODEL,a,this.entity);0>a&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&this.addModelToLayers();this._batchGroupId=a}}},{key:"materialAsset",get:function(){return this._materialAsset},set:function(a){var c=a;a instanceof fa&&(c=a.id);a=this.system.app.assets;if(c!==this._materialAsset){if(this._materialAsset){a.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);var e=a.get(this._materialAsset);
e&&this._unbindMaterialAsset(e)}(this._materialAsset=c)?(c=a.get(this._materialAsset))?this._bindMaterialAsset(c):(this._setMaterial(this.system.defaultMaterial),a.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this)):this._setMaterial(this.system.defaultMaterial)}}},{key:"material",get:function(){return this._material},set:function(a){this._material!==a&&(this.materialAsset=null,this._setMaterial(a))}},{key:"mapping",get:function(){return this._mapping},set:function(a){if("asset"===this._type&&
(this._unsetMaterialEvents(),a||(a={}),this._mapping=a,this._model)){var c=this._model.meshInstances,e=this.asset?this.system.app.assets.get(this.asset):null;e=e?e.data.mapping:null;for(var f=null,h=0,k=c.length;h<k;h++)if(void 0!==a[h])a[h]?(f=this.system.app.assets.get(a[h]),this._loadAndSetMeshInstanceMaterial(f,c[h],h)):c[h].material=this.system.defaultMaterial;else if(e)if(e[h]&&(e[h].material||e[h].path)){if(void 0!==e[h].material)f=this.system.app.assets.get(e[h].material);else if(void 0!==
e[h].path){var m=this._getMaterialAssetUrl(e[h].path);m&&(f=this.system.app.assets.getByUrl(m))}this._loadAndSetMeshInstanceMaterial(f,c[h],h)}else c[h].material=this.system.defaultMaterial}}}]);return d}(ca),Xp=function(){this.enabled=!0},im=["enabled"],jm=function(g){function d(a){var c=g.call(this,a)||this;c.id="model";c.ComponentType=Xf;c.DataType=Xp;c.schema=im;c.defaultMaterial=a.scene.defaultMaterial;c.on("beforeremove",c.onRemove,F(c));return c}K(d,g);var b=d.prototype;b.initializeComponentData=
function(a,c,e){e="material materialAsset asset castShadows receiveShadows castShadowsLightmap lightmapped lightmapSizeMultiplier type mapping layers isStatic batchGroupId".split(" ");if(null===c.batchGroupId||void 0===c.batchGroupId)c.batchGroupId=-1;c.layers&&c.layers.length&&(c.layers=c.layers.slice(0));for(var f=0;f<e.length;f++)c.hasOwnProperty(e[f])&&(a[e[f]]=c[e[f]]);g.prototype.initializeComponentData.call(this,a,c,["enabled"])};b.cloneComponent=function(a,c){var e={type:a.model.type,asset:a.model.asset,
castShadows:a.model.castShadows,receiveShadows:a.model.receiveShadows,castShadowsLightmap:a.model.castShadowsLightmap,lightmapped:a.model.lightmapped,lightmapSizeMultiplier:a.model.lightmapSizeMultiplier,isStatic:a.model.isStatic,enabled:a.model.enabled,layers:a.model.layers,batchGroupId:a.model.batchGroupId,mapping:Ob({},a.model.mapping)},f=a.model.materialAsset;f instanceof fa||null==f||(f=this.app.assets.get(f));var h=a.model.material;h&&h!==this.defaultMaterial&&f&&h!==f.resource||(e.materialAsset=
f);c=this.addComponent(c,e);a.model.model&&"asset"===a.model.type&&!a.model.asset&&(c.model=a.model.model.clone(),c._clonedModel=!0);e.materialAsset||(c.material=h);if(a.model.model)for(a=a.model.model.meshInstances,e=c.model.meshInstances,h=0;h<a.length;h++)e[h].mask=a[h].mask,e[h].material=a[h].material,e[h].layer=a[h].layer,e[h].receiveShadow=a[h].receiveShadow};b.onRemove=function(a,c){c.onRemove()};return d}(O);ca._buildAccessors(Xf.prototype,im);var km=function(g){function d(a,c){var e=g.call(this,
a,c)||this;e._type="asset";e._castShadows=!0;e._receiveShadows=!0;e._castShadowsLightmap=!0;e._lightmapped=!1;e._lightmapSizeMultiplier=1;e._isStatic=!1;e._batchGroupId=-1;e._meshInstances=[];e._layers=[0];e._aabb=null;e._area=null;e._rootBone=new nc(F(e),"rootBone");e._rootBone.on("set:entity",e._onSetRootBone,F(e));e._assetReference=new ne("asset",F(e),a.app.assets,{add:e._onRenderAssetAdded,load:e._onRenderAssetLoad,remove:e._onRenderAssetRemove,unload:e._onRenderAssetUnload},F(e));e._material=
a.defaultMaterial;e._materialReferences=[];c.on("remove",e.onRemoveChild,F(e));c.on("insert",e.onInsertChild,F(e));return e}K(d,g);var b=d.prototype;b._onSetRootBone=function(a){a&&this._onRootBoneChanged()};b._onRootBoneChanged=function(){this._clearSkinInstances();this._cloneSkinInstances()};b.destroyMeshInstances=function(){var a=this._meshInstances;if(a){this.removeFromLayers();for(var c=0;c<a.length;c++)a[c].destroy();this._meshInstances.length=0}};b.addToLayers=function(){for(var a,c=this.system.app.scene.layers,
e=0;e<this._layers.length;e++)(a=c.getLayerById(this._layers[e]))&&a.addMeshInstances(this._meshInstances)};b.removeFromLayers=function(){if(this._meshInstances&&this._meshInstances.length)for(var a,c=this.system.app.scene.layers,e=0;e<this._layers.length;e++)(a=c.getLayerById(this._layers[e]))&&a.removeMeshInstances(this._meshInstances)};b.onRemoveChild=function(){this.removeFromLayers()};b.onInsertChild=function(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()};b.onRemove=
function(){this.destroyMeshInstances();this.materialAsset=this.asset=null;this.entity.off("remove",this.onRemoveChild,this);this.entity.off("insert",this.onInsertChild,this)};b.onLayersChanged=function(a,c){this.addToLayers();a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);c.on("add",this.onLayerAdded,this);c.on("remove",this.onLayerRemoved,this)};b.onLayerAdded=function(a){0>this.layers.indexOf(a.id)||a.addMeshInstances(this._meshInstances)};b.onLayerRemoved=function(a){0>
this.layers.indexOf(a.id)||a.removeMeshInstances(this._meshInstances)};b.onEnable=function(){var a=this.system.app,c=a.scene;this._rootBone.onParentComponentEnable();c.on("set:layers",this.onLayersChanged,this);c.layers&&(c.layers.on("add",this.onLayerAdded,this),c.layers.on("remove",this.onLayerRemoved,this));c="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():c&&this.asset&&this._onRenderAssetAdded();for(c=0;c<this._materialReferences.length;c++)this._materialReferences[c].asset&&
this.system.app.assets.load(this._materialReferences[c].asset);0<=this._batchGroupId&&a.batcher.insert(Da.RENDER,this.batchGroupId,this.entity)};b.onDisable=function(){var a=this.system.app,c=a.scene;c.off("set:layers",this.onLayersChanged,this);c.layers&&(c.layers.off("add",this.onLayerAdded,this),c.layers.off("remove",this.onLayerRemoved,this));0<=this._batchGroupId&&a.batcher.remove(Da.RENDER,this.batchGroupId,this.entity);this.removeFromLayers()};b.hide=function(){if(this._meshInstances)for(var a=
0;a<this._meshInstances.length;a++)this._meshInstances[a].visible=!1};b.show=function(){if(this._meshInstances)for(var a=0;a<this._meshInstances.length;a++)this._meshInstances[a].visible=!0};b._onRenderAssetAdded=function(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))};b._onRenderAssetLoad=function(){this.destroyMeshInstances();if(this._assetReference.asset){var a=
this._assetReference.asset.resource;a.off("set:meshes",this._onSetMeshes,this);a.on("set:meshes",this._onSetMeshes,this);a.meshes&&this._onSetMeshes(a.meshes)}};b._onSetMeshes=function(a){this._cloneMeshes(a)};b._clearSkinInstances=function(){for(var a=0;a<this._meshInstances.length;a++)this._meshInstances[a].skinInstance=null};b._cloneSkinInstances=function(){if(this._meshInstances.length&&this._rootBone.entity instanceof pa)for(var a,c,e,f=new Map,h=0;h<this._meshInstances.length;h++){var k=this._meshInstances[h];
a=k.mesh;if(a.skin&&!a.skinInstance){c=a.skin;e=f.get(c);if(!e){e=new ic(c);f.set(c,e);var m=[];for(a=0;a<c.boneNames.length;a++){var n=c.boneNames[a],p=this._rootBone.entity.findByName(n);p||(console.error("Failed to find bone ["+n+"] in the entity hierarchy, RenderComponent on "+this.entity.name+", rootBone: "+this._rootBone.entity.name),p=this.entity);m.push(p)}e.bones=m}k.skinInstance=e}}};b._cloneMeshes=function(a){if(a&&a.length){for(var c=[],e=0;e<a.length;e++){var f=a[e],h=new Ga(this.entity,
f,this._materialReferences[e]&&this._materialReferences[e].asset&&this._materialReferences[e].asset.resource||this.system.defaultMaterial);c.push(h);f.morph&&(h.morphInstance=new ae(f.morph))}this.meshInstances=c;this._cloneSkinInstances()}};b._onRenderAssetUnload=function(){"asset"===this._type&&this.destroyMeshInstances()};b._onRenderAssetRemove=function(){this._assetReference.asset&&this._assetReference.asset.resource&&this._assetReference.asset.resource.off("set:meshes",this._onSetMeshes,this);
this._onRenderAssetUnload()};b._onMaterialAdded=function(a,c,e){e.resource?this._onMaterialLoad(a,c,e):this.enabled&&this.entity.enabled&&this.system.app.assets.load(e)};b._onMaterialLoad=function(a,c,e){this._meshInstances[a]&&(this._meshInstances[a].material=e.resource)};b._onMaterialRemove=function(a,c,e){this._meshInstances[a]&&(this._meshInstances[a].material=this.system.defaultMaterial)};b._onMaterialUnload=function(a,c,e){this._meshInstances[a]&&(this._meshInstances[a].material=this.system.defaultMaterial)};
b.generateWireframe=function(){var a,c=[];for(a=0;a<this._meshInstances.length;a++){var e=this._meshInstances[a].mesh;-1===c.indexOf(e)&&c.push(e)}for(a=0;a<c.length;++a)e=c[a],e.primitive[1]||e.generateWireframe()};N(d,[{key:"aabb",get:function(){return this._aabb},set:function(a){this._aabb=a;if(a=this._meshInstances)for(var c=0;c<a.length;c++)a[c].setOverrideAabb(this._aabb)}},{key:"type",get:function(){return this._type},set:function(a){if(this._type!==a&&(this._area=null,this._type=a,this.destroyMeshInstances(),
"asset"!==a)){var c=this._material;c&&c!==this.system.defaultMaterial||(c=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);a=Si(this.system.app.graphicsDevice,a);this._area=a.area;this.meshInstances=[new Ga(this.entity,a.mesh,c||this.system.defaultMaterial)];this.system._inTools&&this.generateWireframe()}}},{key:"meshInstances",get:function(){return this._meshInstances},set:function(a){this.destroyMeshInstances();if(this._meshInstances=a){a=
this._meshInstances;for(var c=0;c<a.length;c++)a[c].castShadow=this._castShadows,a[c].receiveShadow=this._receiveShadows,a[c].isStatic=this._isStatic,a[c].setLightmapped(this._lightmapped),a[c].setOverrideAabb(this._aabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}},{key:"lightmapped",get:function(){return this._lightmapped},set:function(a){if(a!==this._lightmapped){this._lightmapped=a;var c=this._meshInstances;if(c)for(var e=0;e<c.length;e++)c[e].setLightmapped(a)}}},{key:"castShadows",
get:function(){return this._castShadows},set:function(a){if(this._castShadows!==a){var c,e,f=this._meshInstances;if(f){var h=this.layers,k=this.system.app.scene;if(this._castShadows&&!a)for(c=0;c<h.length;c++)(e=k.layers.getLayerById(this.layers[c]))&&e.removeShadowCasters(f);for(c=0;c<f.length;c++)f[c].castShadow=a;if(!this._castShadows&&a)for(c=0;c<h.length;c++)(e=k.layers.getLayerById(h[c]))&&e.addShadowCasters(f)}this._castShadows=a}}},{key:"receiveShadows",get:function(){return this._receiveShadows},
set:function(a){if(this._receiveShadows!==a){this._receiveShadows=a;var c=this._meshInstances;if(c)for(var e=0;e<c.length;e++)c[e].receiveShadow=a}}},{key:"castShadowsLightmap",get:function(){return this._castShadowsLightmap},set:function(a){this._castShadowsLightmap=a}},{key:"lightmapSizeMultiplier",get:function(){return this._lightmapSizeMultiplier},set:function(a){this._lightmapSizeMultiplier=a}},{key:"isStatic",get:function(){return this._isStatic},set:function(a){if(this._isStatic!==a){this._isStatic=
a;var c=this._meshInstances;if(c)for(var e=0;e<c.length;e++)c[e].isStatic=a}}},{key:"layers",get:function(){return this._layers},set:function(a){var c,e,f=this.system.app.scene.layers;if(this._meshInstances)for(c=0;c<this._layers.length;c++)(e=f.getLayerById(this._layers[c]))&&e.removeMeshInstances(this._meshInstances);for(c=this._layers.length=0;c<a.length;c++)this._layers[c]=a[c];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(c=0;c<this._layers.length;c++)(e=f.getLayerById(this._layers[c]))&&
e.addMeshInstances(this._meshInstances)}},{key:"batchGroupId",get:function(){return this._batchGroupId},set:function(a){if(this._batchGroupId!==a){var c=this.system.app.batcher;this.entity.enabled&&0<=this._batchGroupId&&c.remove(Da.RENDER,this.batchGroupId,this.entity);this.entity.enabled&&0<=a&&c.insert(Da.RENDER,a,this.entity);0>a&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&this.addToLayers();this._batchGroupId=a}}},{key:"material",get:function(){return this._material},set:function(a){if(this._material!==
a&&(this._material=a,this._meshInstances&&"asset"!==this._type))for(var c=0;c<this._meshInstances.length;c++)this._meshInstances[c].material=a}},{key:"materialAssets",get:function(){return this._materialReferences.map(function(a){return a.id})},set:function(a){var c;a=a||[];if(this._materialReferences.length>a.length){for(c=a.length;c<this._materialReferences.length;c++)this._materialReferences[c].id=null;this._materialReferences.length=a.length}for(c=0;c<a.length;c++)if(this._materialReferences[c]||
this._materialReferences.push(new ne(c,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),a[c]){var e=a[c]instanceof fa?a[c].id:a[c];this._materialReferences[c].id!==e&&(this._materialReferences[c].id=e);this._materialReferences[c].asset&&this._onMaterialAdded(c,this,this._materialReferences[c].asset)}else this._materialReferences[c].id=null,this._meshInstances[c]&&(this._meshInstances[c].material=this.system.defaultMaterial)}},
{key:"asset",get:function(){return this._assetReference.id},set:function(a){a=a instanceof fa?a.id:a;this._assetReference.id!==a&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=a,this._assetReference.asset&&this._onRenderAssetAdded())}}]);return d}(ca),Yp=function(){this.enabled=!0;this.rootBone=null},Zh=[{name:"rootBone",type:"entity"},"enabled"],Tc="material asset materialAssets castShadows receiveShadows castShadowsLightmap lightmapped lightmapSizeMultiplier type layers isStatic batchGroupId".split(" "),
Zp=function(g){function d(a){var c=g.call(this,a)||this;c.id="render";c.ComponentType=km;c.DataType=Yp;c.schema=Zh;c.defaultMaterial=a.scene.defaultMaterial;c.on("beforeremove",c.onRemove,F(c));return c}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c,e){if(null===c.batchGroupId||void 0===c.batchGroupId)c.batchGroupId=-1;c.layers&&c.layers.length&&(c.layers=c.layers.slice(0));for(e=0;e<Tc.length;e++)c.hasOwnProperty(Tc[e])&&(a[Tc[e]]=c[Tc[e]]);g.prototype.initializeComponentData.call(this,
a,c,Zh)};b.cloneComponent=function(a,c){var e,f={};for(e=0;e<Tc.length;e++)f[Tc[e]]=a.render[Tc[e]];e=this.addComponent(c,f);if(a.render)for(a=a.render.meshInstances,c=e.meshInstances,e=0;e<a.length&&e<c.length;e++)c[e].mask=a[e].mask,c[e].material=a[e].material,c[e].layer=a[e].layer,c[e].receiveShadow=a[e].receiveShadow};b.onRemove=function(a,c){c.onRemove()};return d}(O);ca._buildAccessors(km.prototype,Zh);var $p="emitterExtents emitterRadius emitterExtentsInner emitterRadiusInner loop initialVelocity animSpeed normalMap particleNormal".split(" "),
aq="numParticles lifetime rate rate2 startAngle startAngle2 lighting halfLambert intensity wrap wrapBounds depthWrite noFog sort stretch alignToMotion preWarm emitterShape animTilesX animTilesY animStartFrame animNumFrames animNumAnimations animIndex randomizeAnimIndex animLoop colorMap localSpace screenSpace orientation".split(" "),bq="scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 velocityGraph velocityGraph2 localVelocityGraph localVelocityGraph2 rotationSpeedGraph rotationSpeedGraph2 radialSpeedGraph radialSpeedGraph2".split(" "),
Yf=["colorMapAsset","normalMapAsset","meshAsset"],Gd,$h=function(g){function d(a,c){a=g.call(this,a,c)||this;a.on("set_colorMapAsset",a.onSetColorMapAsset,F(a));a.on("set_normalMapAsset",a.onSetNormalMapAsset,F(a));a.on("set_meshAsset",a.onSetMeshAsset,F(a));a.on("set_mesh",a.onSetMesh,F(a));a.on("set_loop",a.onSetLoop,F(a));a.on("set_blendType",a.onSetBlendType,F(a));a.on("set_depthSoftening",a.onSetDepthSoftening,F(a));a.on("set_layers",a.onSetLayers,F(a));$p.forEach(function(e){this.on("set_"+
e,this.onSetSimpleProperty,this)}.bind(F(a)));aq.forEach(function(e){this.on("set_"+e,this.onSetComplexProperty,this)}.bind(F(a)));bq.forEach(function(e){this.on("set_"+e,this.onSetGraphProperty,this)}.bind(F(a)));a._requestedDepth=!1;a._drawOrder=0;return a}K(d,g);var b=d.prototype;b.addModelToLayers=function(){if(this.data.model)for(var a,c=0;c<this.layers.length;c++)if(a=this.system.app.scene.layers.getLayerById(this.layers[c]))a.addMeshInstances(this.data.model.meshInstances),this.emitter._layer=
a};b.removeModelFromLayers=function(a){if(this.data.model)for(var c=0;c<this.layers.length;c++)(a=this.system.app.scene.layers.getLayerById(this.layers[c]))&&a.removeMeshInstances(this.data.model.meshInstances)};b.onSetLayers=function(a,c,e){if(this.data.model){var f;for(a=0;a<c.length;a++)(f=this.system.app.scene.layers.getLayerById(c[a]))&&f.removeMeshInstances(this.data.model.meshInstances);if(this.enabled&&this.entity.enabled)for(a=0;a<e.length;a++)(f=this.system.app.scene.layers.getLayerById(e[a]))&&
f.addMeshInstances(this.data.model.meshInstances)}};b.onLayersChanged=function(a,c){this.addModelToLayers();a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);c.on("add",this.onLayerAdded,this);c.on("remove",this.onLayerRemoved,this)};b.onLayerAdded=function(a){this.data.model&&(0>this.layers.indexOf(a.id)||a.addMeshInstances(this.data.model.meshInstances))};b.onLayerRemoved=function(a){this.data.model&&(0>this.layers.indexOf(a.id)||a.removeMeshInstances(this.data.model.meshInstances))};
b._bindColorMapAsset=function(a){a.on("load",this._onColorMapAssetLoad,this);a.on("unload",this._onColorMapAssetUnload,this);a.on("remove",this._onColorMapAssetRemove,this);a.on("change",this._onColorMapAssetChange,this);a.resource?this._onColorMapAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)};b._unbindColorMapAsset=function(a){a.off("load",this._onColorMapAssetLoad,this);a.off("unload",this._onColorMapAssetUnload,this);a.off("remove",this._onColorMapAssetRemove,this);
a.off("change",this._onColorMapAssetChange,this)};b._onColorMapAssetLoad=function(a){this.colorMap=a.resource};b._onColorMapAssetUnload=function(a){this.colorMap=null};b._onColorMapAssetRemove=function(a){this._onColorMapAssetUnload(a)};b._onColorMapAssetChange=function(a){};b.onSetColorMapAsset=function(a,c,e){var f=this;a=this.system.app.assets;c&&(c=a.get(c))&&this._unbindColorMapAsset(c);if(e)if(e instanceof fa&&(e=this.data.colorMapAsset=e.id),c=a.get(e))f._bindColorMapAsset(c);else a.once("add:"+
e,function(h){f._bindColorMapAsset(h)});else this.colorMap=null};b._bindNormalMapAsset=function(a){a.on("load",this._onNormalMapAssetLoad,this);a.on("unload",this._onNormalMapAssetUnload,this);a.on("remove",this._onNormalMapAssetRemove,this);a.on("change",this._onNormalMapAssetChange,this);a.resource?this._onNormalMapAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)};b._unbindNormalMapAsset=function(a){a.off("load",this._onNormalMapAssetLoad,this);a.off("unload",this._onNormalMapAssetUnload,
this);a.off("remove",this._onNormalMapAssetRemove,this);a.off("change",this._onNormalMapAssetChange,this)};b._onNormalMapAssetLoad=function(a){this.normalMap=a.resource};b._onNormalMapAssetUnload=function(a){this.normalMap=null};b._onNormalMapAssetRemove=function(a){this._onNormalMapAssetUnload(a)};b._onNormalMapAssetChange=function(a){};b.onSetNormalMapAsset=function(a,c,e){var f=this;a=this.system.app.assets;c&&(c=a.get(c))&&this._unbindNormalMapAsset(c);if(e)if(e instanceof fa&&(e=this.data.normalMapAsset=
e.id),c=a.get(e))f._bindNormalMapAsset(c);else a.once("add:"+e,function(h){f._bindNormalMapAsset(h)});else this.normalMap=null};b._bindMeshAsset=function(a){a.on("load",this._onMeshAssetLoad,this);a.on("unload",this._onMeshAssetUnload,this);a.on("remove",this._onMeshAssetRemove,this);a.on("change",this._onMeshAssetChange,this);a.resource?this._onMeshAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)};b._unbindMeshAsset=function(a){a.off("load",this._onMeshAssetLoad,this);
a.off("unload",this._onMeshAssetUnload,this);a.off("remove",this._onMeshAssetRemove,this);a.off("change",this._onMeshAssetChange,this)};b._onMeshAssetLoad=function(a){this._onMeshChanged(a.resource)};b._onMeshAssetUnload=function(a){this.mesh=null};b._onMeshAssetRemove=function(a){this._onMeshAssetUnload(a)};b._onMeshAssetChange=function(a){};b.onSetMeshAsset=function(a,c,e){a=this.system.app.assets;c&&(c=a.get(c))&&this._unbindMeshAsset(c);if(e){if(e instanceof fa&&(e=this.data.meshAsset=e.id),c=
a.get(e))this._bindMeshAsset(c),c.resource?this._onMeshChanged(c.resource):a.load(c)}else this._onMeshChanged(null)};b.onSetMesh=function(a,c,e){!e||e instanceof fa||"number"===typeof e?this.meshAsset=e:this._onMeshChanged(e)};b._onMeshChanged=function(a){!a||a instanceof bb||(a=a.meshInstances[0]?a.meshInstances[0].mesh:null);this.data.mesh=a;this.emitter&&(this.emitter.mesh=a,this.emitter.resetMaterial(),this.rebuild())};b.onSetLoop=function(a,c,e){this.emitter&&(this.emitter[a]=e,this.emitter.resetTime())};
b.onSetBlendType=function(a,c,e){this.emitter&&(this.emitter[a]=e,this.emitter.material.blendType=e,this.emitter.resetMaterial(),this.rebuild())};b._requestDepth=function(){this._requestedDepth||(Gd||(Gd=this.system.app.scene.layers.getLayerById(1)),Gd&&(Gd.incrementCounter(),this._requestedDepth=!0))};b._releaseDepth=function(){this._requestedDepth&&Gd&&(Gd.decrementCounter(),this._requestedDepth=!1)};b.onSetDepthSoftening=function(a,c,e){c!==e&&(e?this.enabled&&this.entity.enabled&&this._requestDepth():
this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[a]=e),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))};b.onSetSimpleProperty=function(a,c,e){this.emitter&&(this.emitter[a]=e,this.emitter.resetMaterial())};b.onSetComplexProperty=function(a,c,e){this.emitter&&(this.emitter[a]=e,this.emitter.resetMaterial(),this.rebuild(),this.reset())};b.onSetGraphProperty=function(a,c,e){this.emitter&&(this.emitter[a]=e,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())};
b.onEnable=function(){for(var a=this.data,c=0,e=Yf.length;c<e;c++){var f=a[Yf[c]];if(f){if(!(f instanceof fa))if(0<=parseInt(f,10))f=this.system.app.assets.get(f);else continue;f&&!f.resource&&this.system.app.assets.load(f)}}this.emitter||(c=a.mesh,c instanceof bb||(c=null),this.emitter=new Cf(this.system.app.graphicsDevice,{numParticles:a.numParticles,emitterExtents:a.emitterExtents,emitterExtentsInner:a.emitterExtentsInner,emitterRadius:a.emitterRadius,emitterRadiusInner:a.emitterRadiusInner,emitterShape:a.emitterShape,
initialVelocity:a.initialVelocity,wrap:a.wrap,localSpace:a.localSpace,screenSpace:a.screenSpace,wrapBounds:a.wrapBounds,lifetime:a.lifetime,rate:a.rate,rate2:a.rate2,orientation:a.orientation,particleNormal:a.particleNormal,animTilesX:a.animTilesX,animTilesY:a.animTilesY,animStartFrame:a.animStartFrame,animNumFrames:a.animNumFrames,animNumAnimations:a.animNumAnimations,animIndex:a.animIndex,randomizeAnimIndex:a.randomizeAnimIndex,animSpeed:a.animSpeed,animLoop:a.animLoop,startAngle:a.startAngle,startAngle2:a.startAngle2,
scaleGraph:a.scaleGraph,scaleGraph2:a.scaleGraph2,colorGraph:a.colorGraph,colorGraph2:a.colorGraph2,alphaGraph:a.alphaGraph,alphaGraph2:a.alphaGraph2,localVelocityGraph:a.localVelocityGraph,localVelocityGraph2:a.localVelocityGraph2,velocityGraph:a.velocityGraph,velocityGraph2:a.velocityGraph2,rotationSpeedGraph:a.rotationSpeedGraph,rotationSpeedGraph2:a.rotationSpeedGraph2,radialSpeedGraph:a.radialSpeedGraph,radialSpeedGraph2:a.radialSpeedGraph2,colorMap:a.colorMap,normalMap:a.normalMap,loop:a.loop,
preWarm:a.preWarm,sort:a.sort,stretch:a.stretch,alignToMotion:a.alignToMotion,lighting:a.lighting,halfLambert:a.halfLambert,intensity:a.intensity,depthSoftening:a.depthSoftening,scene:this.system.app.scene,mesh:c,depthWrite:a.depthWrite,noFog:a.noFog,node:this.entity,blendType:a.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,this.psys=new fb,this.psys.graph=this.entity,this.psys.emitter=this.emitter,this.psys.meshInstances=[this.emitter.meshInstance],
a.model=this.psys,this.emitter.psys=this.psys,a.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1));a.model&&this.emitter.colorMap&&this.addModelToLayers();this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&a.depthSoftening&&this._requestDepth()};b.onDisable=function(){this.system.app.scene.off("set:layers",
this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));this.data.model&&(this.removeModelFromLayers(),this.data.depthSoftening&&this._releaseDepth());this.emitter&&(this.emitter.camera=null)};b.onBeforeRemove=function(){this.enabled&&(this.enabled=!1);var a=this.data;a.model&&(this.entity.removeChild(a.model.getGraph()),a.model.destroy(),a.model=null);this.emitter&&
(this.emitter.destroy(),this.emitter=null);for(var c=0;c<Yf.length;c++){var e=Yf[c];a[e]&&(this[e]=null)}this.off()};b.reset=function(){this.emitter&&this.emitter.reset()};b.stop=function(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))};b.pause=function(){this.data.paused=!0};b.unpause=function(){this.data.paused=!1};b.play=function(){this.data.paused=!1;this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())};
b.isPlaying=function(){return this.data.paused?!1:this.emitter&&this.emitter.loop?!0:Date.now()<=this.emitter.endTime};b.rebuild=function(){var a=this.enabled;this.enabled=!1;this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity,this.data.model.meshInstances=[this.emitter.meshInstance]);this.enabled=a};N(d,[{key:"drawOrder",get:function(){return this._drawOrder},set:function(a){this._drawOrder=a;this.emitter&&(this.emitter.drawOrder=a)}}]);return d}(ca),cq=function(){this.rate=
this.numParticles=1;this.rate2=null;this.startAngle=0;this.startAngle2=null;this.lifetime=50;this.emitterExtents=new A;this.emitterExtentsInner=new A;this.initialVelocity=this.emitterShape=this.emitterRadiusInner=this.emitterRadius=0;this.wrapBounds=new A;this.screenSpace=this.localSpace=!1;this.normalMapAsset=this.normalMap=this.colorMapAsset=this.colorMap=null;this.loop=!0;this.preWarm=!1;this.mode=this.sort=0;this.scene=null;this.halfLambert=this.lighting=!1;this.intensity=1;this.stretch=0;this.alignToMotion=
!1;this.depthSoftening=0;this.mesh=this.meshAsset=null;this.noFog=this.depthWrite=!1;this.orientation=0;this.particleNormal=new A(0,1,0);this.animTilesY=this.animTilesX=1;this.animStartFrame=0;this.animNumAnimations=this.animNumFrames=1;this.animIndex=0;this.randomizeAnimIndex=!1;this.animSpeed=1;this.animLoop=!0;this.radialSpeedGraph2=this.radialSpeedGraph=this.rotationSpeedGraph2=this.rotationSpeedGraph=this.velocityGraph2=this.velocityGraph=this.localVelocityGraph2=this.localVelocityGraph=this.alphaGraph2=
this.alphaGraph=this.colorGraph2=this.colorGraph=this.scaleGraph2=this.scaleGraph=null;this.blendType=2;this.model=null;this.enabled=!0;this.paused=!1;this.autoPlay=!0;this.layers=[0]},lm="enabled autoPlay numParticles lifetime rate rate2 startAngle startAngle2 loop preWarm lighting halfLambert intensity depthWrite noFog depthSoftening sort blendType stretch alignToMotion emitterShape emitterExtents emitterExtentsInner emitterRadius emitterRadiusInner initialVelocity wrap wrapBounds localSpace screenSpace colorMapAsset normalMapAsset mesh meshAsset orientation particleNormal localVelocityGraph localVelocityGraph2 velocityGraph velocityGraph2 rotationSpeedGraph rotationSpeedGraph2 radialSpeedGraph radialSpeedGraph2 scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 colorMap normalMap animTilesX animTilesY animStartFrame animNumFrames animNumAnimations animIndex randomizeAnimIndex animSpeed animLoop layers".split(" "),
mm=function(g){function d(a){a=g.call(this,a)||this;a.id="particlesystem";a.ComponentType=$h;a.DataType=cq;a.schema=lm;a.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",
radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"};a.on("beforeremove",a.onBeforeRemove,F(a));O.bind("update",a.onUpdate,F(a));return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c,e){var f={};e=[];var h=this.propertyTypes;if(c.mesh instanceof fa||"number"===typeof c.mesh)c.meshAsset=c.mesh,delete c.mesh;for(var k in c){c.hasOwnProperty(k)&&(e.push(k),f[k]=c[k]);if("vec3"===h[k])Array.isArray(f[k])&&(f[k]=new A(f[k][0],f[k][1],f[k][2]));else if("curve"===h[k]){if(!(f[k]instanceof
db)){var m=f[k].type;f[k]=new db(f[k].keys);f[k].type=m}}else"curveset"!==h[k]||f[k]instanceof Qb||(m=f[k].type,f[k]=new Qb(f[k].keys),f[k].type=m);f.layers&&Array.isArray(f.layers)&&(f.layers=f.layers.slice(0))}g.prototype.initializeComponentData.call(this,a,f,e)};b.cloneComponent=function(a,c){a=a.particlesystem.data;for(var e=this.schema,f={},h=0,k=e.length;h<k;h++){var m=e[h],n=a[m];n instanceof A||n instanceof db||n instanceof Qb?(n=n.clone(),f[m]=n):"layers"===m?f.layers=a.layers.slice(0):null!==
n&&void 0!==n&&(f[m]=n)}return this.addComponent(c,f)};b.onUpdate=function(a){var c=this.store,e,f=this.app.stats.particles,h;for(h in c)if(c.hasOwnProperty(h)){var k=c[h];var m=k.entity;var n=k.data;if(n.enabled&&m.enabled){var p=n.model.emitter;if(p.meshInstance.visible){if(p.lighting){var t=n.layers;for(m=0;m<t.length;m++)if(k=this.app.scene.layers.getLayerById(t[m])){k._lightCube||(k._lightCube=new Float32Array(18));var r=k._lightCube;for(m=0;6>m;m++)r[3*m]=this.app.scene.ambientLight.r,r[3*m+
1]=this.app.scene.ambientLight.g,r[3*m+2]=this.app.scene.ambientLight.b;var u=k._splitLights[0];for(e=0;e<u.length;e++)for(k=0;6>k;k++){var v=Math.max(p.lightCubeDir[k].dot(u[e]._direction),0)*u[e]._intensity;r[3*k]+=u[e]._color.r*v;r[3*k+1]+=u[e]._color.g*v;r[3*k+2]+=u[e]._color.b*v}}p.constantLightCube.setValue(r)}if(!n.paused){p.simTime+=a;if(p.simTime>p.fixedTimeStep){var w=Math.floor(p.simTime/p.fixedTimeStep);p.simTime-=w*p.fixedTimeStep}if(w){w=Math.min(w,p.maxSubSteps);for(m=0;m<w;m++)p.addTime(p.fixedTimeStep,
!1);f._updatesPerFrame+=w;f._frameTime+=p._addTimeTime;p._addTimeTime=0}p.finishFrame()}}}}};b.onBeforeRemove=function(a,c){c.onBeforeRemove()};return d}(O);ca._buildAccessors($h.prototype,lm);var ai=function(){function g(b,a){this._constructor=b;this._pool=[];this._count=0;this._resize(a)}var d=g.prototype;d._resize=function(b){if(b>this._pool.length)for(var a=this._pool.length;a<b;a++)this._pool[a]=new this._constructor};d.allocate=function(){this._count>=this._pool.length&&this._resize(2*this._pool.length);
return this._pool[this._count++]};d.freeAll=function(){this._count=0};return g}(),tb,ua,ve,bi,ci,we=function(g){function d(a,c){a=g.call(this,a,c)||this;"undefined"===typeof Ammo||tb||(tb=new Ammo.btTransform,ua=new Ammo.btVector3,ve=new Ammo.btVector3,bi=new Ammo.btQuaternion,ci=new Ammo.btVector3(0,0,0));a.on("set_mass",a.onSetMass,F(a));a.on("set_linearDamping",a.onSetLinearDamping,F(a));a.on("set_angularDamping",a.onSetAngularDamping,F(a));a.on("set_linearFactor",a.onSetLinearFactor,F(a));a.on("set_angularFactor",
a.onSetAngularFactor,F(a));a.on("set_friction",a.onSetFriction,F(a));a.on("set_restitution",a.onSetRestitution,F(a));a.on("set_type",a.onSetType,F(a));a.on("set_group",a.onSetGroupOrMask,F(a));a.on("set_mask",a.onSetGroupOrMask,F(a));a.on("set_body",a.onSetBody,F(a));a._linearVelocity=new A(0,0,0);a._angularVelocity=new A(0,0,0);return a}K(d,g);var b=d.prototype;b.createBody=function(){var a=this.entity;if(a.collision){var c=a.collision.shape;a.trigger&&(a.trigger.destroy(),delete a.trigger)}if(c){if(this.body)this.system.onRemove(this.entity,
this);var e="dynamic"===this.type?this.mass:0;this._getEntityTransform(tb);c=this.system.createBody(e,c,tb);c.setRestitution(this.restitution);c.setFriction(this.friction);c.setDamping(this.linearDamping,this.angularDamping);"dynamic"===this.type?(e=this.linearFactor,ua.setValue(e.x,e.y,e.z),c.setLinearFactor(ua),e=this.angularFactor,ua.setValue(e.x,e.y,e.z),c.setAngularFactor(ua)):"kinematic"===this.type&&(c.setCollisionFlags(c.getCollisionFlags()|2),c.setActivationState(4));c.entity=a;a.rigidbody.body=
c;this.enabled&&this.entity.enabled&&this.enableSimulation()}};b.isActive=function(){var a=this.body;return a?a.isActive():!1};b.activate=function(){var a=this.body;a&&a.activate()};b.enableSimulation=function(){if(this.entity.collision&&this.entity.collision.enabled&&!this.data.simulationEnabled){var a=this.body;if(a){this.system.addBody(a,this.group,this.mask);switch(this.type){case "dynamic":this.system._dynamic.push(this);a.forceActivationState(1);this.syncEntityToBody();break;case "kinematic":this.system._kinematic.push(this);
a.forceActivationState(4);break;case "static":a.forceActivationState(1),this.syncEntityToBody()}"compound"===this.entity.collision.type&&this.system._compounds.push(this.entity.collision);a.activate();this.data.simulationEnabled=!0}}};b.disableSimulation=function(){var a=this.body;if(a&&this.data.simulationEnabled){var c=this.system._compounds.indexOf(this.entity.collision);-1<c&&this.system._compounds.splice(c,1);c=this.system._dynamic.indexOf(this);-1<c&&this.system._dynamic.splice(c,1);c=this.system._kinematic.indexOf(this);
-1<c&&this.system._kinematic.splice(c,1);this.system.removeBody(a);a.forceActivationState(5);this.data.simulationEnabled=!1}};b.applyForce=function(){switch(arguments.length){case 1:var a=arguments[0].x;var c=arguments[0].y;var e=arguments[0].z;break;case 2:a=arguments[0].x;c=arguments[0].y;e=arguments[0].z;var f=arguments[1].x;var h=arguments[1].y;var k=arguments[1].z;break;case 3:a=arguments[0];c=arguments[1];e=arguments[2];break;case 6:a=arguments[0],c=arguments[1],e=arguments[2],f=arguments[3],
h=arguments[4],k=arguments[5]}var m=this.body;m&&(m.activate(),ua.setValue(a,c,e),void 0!==f?(ve.setValue(f,h,k),m.applyForce(ua,ve)):m.applyForce(ua,ci))};b.applyTorque=function(){switch(arguments.length){case 1:var a=arguments[0].x;var c=arguments[0].y;var e=arguments[0].z;break;case 3:a=arguments[0];c=arguments[1];e=arguments[2];break;default:return}var f=this.body;f&&(f.activate(),ua.setValue(a,c,e),f.applyTorque(ua))};b.applyImpulse=function(){switch(arguments.length){case 1:var a=arguments[0].x;
var c=arguments[0].y;var e=arguments[0].z;break;case 2:a=arguments[0].x;c=arguments[0].y;e=arguments[0].z;var f=arguments[1].x;var h=arguments[1].y;var k=arguments[1].z;break;case 3:a=arguments[0];c=arguments[1];e=arguments[2];break;case 6:a=arguments[0];c=arguments[1];e=arguments[2];f=arguments[3];h=arguments[4];k=arguments[5];break;default:return}var m=this.body;m&&(m.activate(),ua.setValue(a,c,e),void 0!==f?(ve.setValue(f,h,k),m.applyImpulse(ua,ve)):m.applyImpulse(ua,ci))};b.applyTorqueImpulse=
function(){switch(arguments.length){case 1:var a=arguments[0].x;var c=arguments[0].y;var e=arguments[0].z;break;case 3:a=arguments[0];c=arguments[1];e=arguments[2];break;default:return}var f=this.body;f&&(f.activate(),ua.setValue(a,c,e),f.applyTorqueImpulse(ua))};b.isStatic=function(){return"static"===this.type};b.isStaticOrKinematic=function(){return"static"===this.type||"kinematic"===this.type};b.isKinematic=function(){return"kinematic"===this.type};b._getEntityTransform=function(a){var c=this.entity.getPosition(),
e=this.entity.getRotation();ua.setValue(c.x,c.y,c.z);bi.setValue(e.x,e.y,e.z,e.w);a.setOrigin(ua);a.setRotation(bi)};b.syncEntityToBody=function(){var a=this.data.body;if(a){this._getEntityTransform(tb);a.setWorldTransform(tb);if("kinematic"===this.type){var c=a.getMotionState();c&&c.setWorldTransform(tb)}a.activate()}};b._updateDynamic=function(){var a=this.data.body;if(a.isActive()&&(a=a.getMotionState())){a.getWorldTransform(tb);a=tb.getOrigin();var c=tb.getRotation();this.entity.setPosition(a.x(),
a.y(),a.z());this.entity.setRotation(c.x(),c.y(),c.z(),c.w())}};b._updateKinematic=function(){var a=this.data.body.getMotionState();a&&(this._getEntityTransform(tb),a.setWorldTransform(tb))};b.teleport=function(){3>arguments.length?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof ea?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],
arguments[1],arguments[2]));this.syncEntityToBody()};b.onEnable=function(){this.body||this.createBody();this.enableSimulation()};b.onDisable=function(){this.disableSimulation()};b.onSetMass=function(a,c,e){(a=this.data.body)&&"dynamic"===this.type&&((c=this.enabled&&this.entity.enabled)&&this.disableSimulation(),a.getCollisionShape().calculateLocalInertia(e,ua),a.setMassProps(e,ua),a.updateInertiaTensor(),c&&this.enableSimulation())};b.onSetLinearDamping=function(a,c,e){(a=this.data.body)&&a.setDamping(e,
this.data.angularDamping)};b.onSetAngularDamping=function(a,c,e){(a=this.data.body)&&a.setDamping(this.data.linearDamping,e)};b.onSetLinearFactor=function(a,c,e){(a=this.data.body)&&"dynamic"===this.type&&(ua.setValue(e.x,e.y,e.z),a.setLinearFactor(ua))};b.onSetAngularFactor=function(a,c,e){(a=this.data.body)&&"dynamic"===this.type&&(ua.setValue(e.x,e.y,e.z),a.setAngularFactor(ua))};b.onSetFriction=function(a,c,e){(a=this.data.body)&&a.setFriction(e)};b.onSetRestitution=function(a,c,e){(a=this.data.body)&&
a.setRestitution(e)};b.onSetType=function(a,c,e){e!==c&&(this.disableSimulation(),"dynamic"===e?(this.data.group=1,this.data.mask=65535):"kinematic"===e?(this.data.group=4,this.data.mask=65535):(this.data.group=2,this.data.mask=65533),this.createBody())};b.onSetGroupOrMask=function(a,c,e){e!==c&&this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation())};b.onSetBody=function(a,c,e){this.body&&this.data.simulationEnabled&&this.body.activate()};N(d,[{key:"linearVelocity",
get:function(){var a=this.body;a&&"dynamic"===this.type&&(a=a.getLinearVelocity(),this._linearVelocity.set(a.x(),a.y(),a.z()));return this._linearVelocity},set:function(a){var c=this.body;c&&"dynamic"===this.type&&(c.activate(),ua.setValue(a.x,a.y,a.z),c.setLinearVelocity(ua),this._linearVelocity.copy(a))}},{key:"angularVelocity",get:function(){var a=this.body;a&&"dynamic"===this.type&&(a=a.getAngularVelocity(),this._angularVelocity.set(a.x(),a.y(),a.z()));return this._angularVelocity},set:function(a){var c=
this.body;c&&"dynamic"===this.type&&(c.activate(),ua.setValue(a.x,a.y,a.z),c.setAngularVelocity(ua),this._angularVelocity.copy(a))}}]);return d}(ca),dq=function(){this.enabled=!0;this.mass=1;this.angularDamping=this.linearDamping=0;this.linearFactor=new A(1,1,1);this.angularFactor=new A(1,1,1);this.friction=.5;this.restitution=0;this.type="static";this.group=2;this.mask=65533;this.body=null;this.simulationEnabled=!1},Uc,Vc,oc={},xe={},di=function(g,d,b){this.entity=g;this.point=d;this.normal=b},nm=
function(g,d,b){0===arguments.length?(this.b=this.a=null,this.localPointA=new A,this.localPointB=new A,this.pointA=new A,this.pointB=new A,this.normal=new A):(this.a=g,this.b=d,this.localPointA=b.localPoint,this.localPointB=b.localPointOther,this.pointA=b.point,this.pointB=b.pointOther,this.normal=b.normal)},om=function(g,d,b,a,c){0===arguments.length?(this.localPoint=new A,this.localPointOther=new A,this.point=new A,this.pointOther=new A,this.normal=new A):(this.localPoint=g,this.localPointOther=
d,this.point=b,this.pointOther=a,this.normal=c)},pm=function(g,d){this.other=g;this.contacts=d},qm="enabled type mass linearDamping angularDamping linearFactor angularFactor friction restitution group mask body".split(" "),ei=function(g){function d(a){var c=g.call(this,a)||this;c.id="rigidbody";c._stats=a.stats.frame;c.ComponentType=we;c.DataType=dq;c.contactPointPool=null;c.contactResultPool=null;c.singleContactResultPool=null;c.schema=qm;c.maxSubSteps=10;c.fixedTimeStep=1/60;c.gravity=new A(0,-9.81,
0);c._dynamic=[];c._kinematic=[];c._triggers=[];c._compounds=[];c.on("beforeremove",c.onBeforeRemove,F(c));c.on("remove",c.onRemove,F(c));return c}K(d,g);var b=d.prototype;b.onLibraryLoaded=function(){if("undefined"!==typeof Ammo){this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=
new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);if(this.dynamicsWorld.setInternalTickCallback){var a=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(a)}Uc=new Ammo.btVector3;Vc=new Ammo.btVector3;this.contactPointPool=new ai(om,1);this.contactResultPool=new ai(pm,1);this.singleContactResultPool=new ai(nm,1);O.bind("update",this.onUpdate,this)}else O.unbind("update",this.onUpdate,
this)};b.initializeComponentData=function(a,c,e){e="enabled mass linearDamping angularDamping linearFactor angularFactor friction restitution type group mask".split(" ");for(var f={},h=0,k=e.length;h<k;h++){var m=e[h];f[m]=c[m]}c.bodyType&&(f.type=c.bodyType);f.linearFactor&&Array.isArray(f.linearFactor)&&(f.linearFactor=new A(f.linearFactor[0],f.linearFactor[1],f.linearFactor[2]));f.angularFactor&&Array.isArray(f.angularFactor)&&(f.angularFactor=new A(f.angularFactor[0],f.angularFactor[1],f.angularFactor[2]));
g.prototype.initializeComponentData.call(this,a,f,e)};b.cloneComponent=function(a,c){this.addComponent(c,{enabled:a.rigidbody.enabled,mass:a.rigidbody.mass,linearDamping:a.rigidbody.linearDamping,angularDamping:a.rigidbody.angularDamping,linearFactor:[a.rigidbody.linearFactor.x,a.rigidbody.linearFactor.y,a.rigidbody.linearFactor.z],angularFactor:[a.rigidbody.angularFactor.x,a.rigidbody.angularFactor.y,a.rigidbody.angularFactor.z],friction:a.rigidbody.friction,restitution:a.rigidbody.restitution,type:a.rigidbody.type,
group:a.rigidbody.group,mask:a.rigidbody.mask})};b.onBeforeRemove=function(a,c){c.enabled&&(c.enabled=!1)};b.onRemove=function(a,c){if(a=c.body)this.removeBody(a),this.destroyBody(a),c.body=null};b.addBody=function(a,c,e){void 0!==c&&void 0!==e?this.dynamicsWorld.addRigidBody(a,c,e):this.dynamicsWorld.addRigidBody(a)};b.removeBody=function(a){this.dynamicsWorld.removeRigidBody(a)};b.createBody=function(a,c,e){var f=new Ammo.btVector3(0,0,0);0!==a&&c.calculateLocalInertia(a,f);e=new Ammo.btDefaultMotionState(e);
a=new Ammo.btRigidBodyConstructionInfo(a,e,c,f);c=new Ammo.btRigidBody(a);Ammo.destroy(a);Ammo.destroy(f);return c};b.destroyBody=function(a){var c=a.getMotionState();c&&Ammo.destroy(c);Ammo.destroy(a)};b.raycastFirst=function(a,c){var e=null;Uc.setValue(a.x,a.y,a.z);Vc.setValue(c.x,c.y,c.z);var f=new Ammo.ClosestRayResultCallback(Uc,Vc);this.dynamicsWorld.rayTest(Uc,Vc,f);if(f.hasHit()){var h=f.get_m_collisionObject();if(h=Ammo.castObject(h,Ammo.btRigidBody)){e=f.get_m_hitPointWorld();var k=f.get_m_hitNormalWorld();
e=new di(h.entity,new A(e.x(),e.y(),e.z()),new A(k.x(),k.y(),k.z()));if(2<arguments.length)(0,arguments[2])(e)}}Ammo.destroy(f);return e};b.raycastAll=function(a,c){var e=[];Uc.setValue(a.x,a.y,a.z);Vc.setValue(c.x,c.y,c.z);a=new Ammo.AllHitsRayResultCallback(Uc,Vc);this.dynamicsWorld.rayTest(Uc,Vc,a);if(a.hasHit()){c=a.get_m_collisionObjects();for(var f=a.get_m_hitPointWorld(),h=a.get_m_hitNormalWorld(),k=c.size(),m=0;m<k;m++){var n=Ammo.castObject(c.at(m),Ammo.btRigidBody);if(n){var p=f.at(m),t=
h.at(m);n=new di(n.entity,new A(p.x(),p.y(),p.z()),new A(t.x(),t.y(),t.z()));e.push(n)}}}Ammo.destroy(a);return e};b._storeCollision=function(a,c){var e=!1,f=a.getGuid();oc[f]=oc[f]||{others:[],entity:a};0>oc[f].others.indexOf(c)&&(oc[f].others.push(c),e=!0);xe[f]=xe[f]||{others:[],entity:a};xe[f].others.push(c);return e};b._createContactPointFromAmmo=function(a){var c=a.get_m_localPointA(),e=a.get_m_localPointB(),f=a.getPositionWorldOnA(),h=a.getPositionWorldOnB();a=a.get_m_normalWorldOnB();var k=
this.contactPointPool.allocate();k.localPoint.set(c.x(),c.y(),c.z());k.localPointOther.set(e.x(),e.y(),e.z());k.point.set(f.x(),f.y(),f.z());k.pointOther.set(h.x(),h.y(),h.z());k.normal.set(a.x(),a.y(),a.z());return k};b._createReverseContactPointFromAmmo=function(a){var c=a.get_m_localPointA(),e=a.get_m_localPointB(),f=a.getPositionWorldOnA(),h=a.getPositionWorldOnB();a=a.get_m_normalWorldOnB();var k=this.contactPointPool.allocate();k.localPointOther.set(c.x(),c.y(),c.z());k.localPoint.set(e.x(),
e.y(),e.z());k.pointOther.set(f.x(),f.y(),f.z());k.point.set(h.x(),h.y(),h.z());k.normal.set(a.x(),a.y(),a.z());return k};b._createSingleContactResult=function(a,c,e){var f=this.singleContactResultPool.allocate();f.a=a;f.b=c;f.localPointA=e.localPoint;f.localPointB=e.localPointOther;f.pointA=e.point;f.pointB=e.pointOther;f.normal=e.normal;return f};b._createContactResult=function(a,c){var e=this.contactResultPool.allocate();e.other=a;e.contacts=c;return e};b._cleanOldCollisions=function(){for(var a in oc)if(oc.hasOwnProperty(a)){var c=
xe[a],e=oc[a],f=e.entity,h=f.collision,k=f.rigidbody;e=e.others;for(var m=e.length;m--;){var n=e[m];if(!c||0>c.others.indexOf(n))e.splice(m,1),f.trigger?(h&&h.fire("triggerleave",n),n.rigidbody&&n.rigidbody.fire("triggerleave",f)):n.trigger||(k&&k.fire("collisionend",n),h&&h.fire("collisionend",n))}0===e.length&&delete oc[a]}};b._hasContactEvent=function(a){var c=a.collision;return c&&(c.hasEvent("collisionstart")||c.hasEvent("collisionend")||c.hasEvent("contact"))?!0:(a=a.rigidbody)&&(a.hasEvent("collisionstart")||
a.hasEvent("collisionend")||a.hasEvent("contact"))};b._checkForCollisions=function(a,c){a=Ammo.wrapPointer(a,Ammo.btDynamicsWorld).getDispatcher();c=a.getNumManifolds();xe={};for(var e=0;e<c;e++){var f=a.getManifoldByIndexInternal(e),h=f.getBody0(),k=f.getBody1(),m=Ammo.castObject(h,Ammo.btRigidBody),n=Ammo.castObject(k,Ammo.btRigidBody);k=m.entity;h=n.entity;if(k&&h){var p=m.getCollisionFlags(),t=n.getCollisionFlags(),r=f.getNumContacts(),u=[],v=[];if(0<r)if(p&4||t&4){n=k.collision&&(k.collision.hasEvent("triggerenter")||
k.collision.hasEvent("triggerleave"));m=h.collision&&(h.collision.hasEvent("triggerenter")||h.collision.hasEvent("triggerleave"));f=k.rigidbody&&(k.rigidbody.hasEvent("triggerenter")||k.rigidbody.hasEvent("triggerleave"));v=h.rigidbody&&(h.rigidbody.hasEvent("triggerenter")||h.rigidbody.hasEvent("triggerleave"));if(n){var w=this._storeCollision(k,h);!w||t&4||k.collision.fire("triggerenter",h)}m&&(w=this._storeCollision(h,k),!w||p&4||h.collision.fire("triggerenter",k));f&&(w||(w=this._storeCollision(h,
k)),w&&k.rigidbody.fire("triggerenter",h));v&&(w||(w=this._storeCollision(k,h)),w&&h.rigidbody.fire("triggerenter",k))}else if(n=this._hasContactEvent(k),m=this._hasContactEvent(h),(p=this.hasEvent("contact"))||n||m){for(t=0;t<r;t++){var y=f.getContactPoint(t),x=this._createContactPointFromAmmo(y);if(n||m)y=this._createReverseContactPointFromAmmo(y),u.push(x),v.push(y);p&&(x=this._createSingleContactResult(k,h,x),this.fire("contact",x))}n&&(f=this._createContactResult(h,u),w=this._storeCollision(k,
h),k.collision&&(k.collision.fire("contact",f),w&&k.collision.fire("collisionstart",f)),k.rigidbody&&(k.rigidbody.fire("contact",f),w&&k.rigidbody.fire("collisionstart",f)));m&&(f=this._createContactResult(k,v),w=this._storeCollision(h,k),h.collision&&(h.collision.fire("contact",f),w&&h.collision.fire("collisionstart",f)),h.rigidbody&&(h.rigidbody.fire("contact",f),w&&h.rigidbody.fire("collisionstart",f)))}}}this._cleanOldCollisions();this.contactPointPool.freeAll();this.contactResultPool.freeAll();
this.singleContactResultPool.freeAll()};b.onUpdate=function(a){var c;var e=this.dynamicsWorld.getGravity();if(e.x()!==this.gravity.x||e.y()!==this.gravity.y||e.z()!==this.gravity.z)e.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(e);var f=this._triggers;e=0;for(c=f.length;e<c;e++)f[e].updateTransform();f=this._compounds;e=0;for(c=f.length;e<c;e++)f[e]._updateCompound();f=this._kinematic;e=0;for(c=f.length;e<c;e++)f[e]._updateKinematic();this.dynamicsWorld.stepSimulation(a,
this.maxSubSteps,this.fixedTimeStep);f=this._dynamic;e=0;for(c=f.length;e<c;e++)f[e]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),a)};b.destroy=function(){"undefined"!==typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),this.collisionConfiguration=this.dispatcher=this.overlappingPairCache=
this.solver=this.dynamicsWorld=null)};return d}(O);ca._buildAccessors(we.prototype,qm);var rm=new M,fi=function(g){function d(a,c){c=g.call(this,a,c)||this;c._resolution=new S(640,320);c._referenceResolution=new S(640,320);c._scaleMode="none";c.scale=1;c._scaleBlend=.5;c._priority=0;c._screenSpace=!1;c.cull=c._screenSpace;c._screenMatrix=new M;c._elements=new Set;a.app.graphicsDevice.on("resizecanvas",c._onResize,F(c));return c}K(d,g);var b=d.prototype;b.syncDrawOrder=function(){this.system.queueDrawOrderSync(this.entity.getGuid(),
this._processDrawOrderSync,this)};b._recurseDrawOrderSync=function(a,c){if(!(a instanceof Ba))return c;if(a.element){var e=a.element.drawOrder;a.element.drawOrder=c++;0<=a.element._batchGroupId&&e!=a.element.drawOrder&&this.system.app.batcher.markGroupDirty(a.element._batchGroupId)}a.particlesystem&&(a.particlesystem.drawOrder=c++);a=a.children;for(e=0;e<a.length;e++)c=this._recurseDrawOrderSync(a[e],c);return c};b._processDrawOrderSync=function(){this._recurseDrawOrderSync(this.entity,1);this.fire("syncdraworder")};
b._calcProjectionMatrix=function(){var a=this._resolution.x/this.scale,c=this._resolution.y/this.scale;this._screenMatrix.setOrtho(0,a,-c,0,1,-1);this._screenSpace||(rm.setScale(.5*a,.5*c,1),this._screenMatrix.mul2(rm,this._screenMatrix))};b._updateScale=function(){this.scale=this._calcScale(this._resolution,this.referenceResolution)};b._calcScale=function(a,c){return Math.pow(2,Math.log2(a.x/c.x)*(1-this._scaleBlend)+Math.log2(a.y/c.y)*this._scaleBlend)};b._onResize=function(a,c){this._screenSpace&&
(this._resolution.set(a,c),this.resolution=this._resolution)};b._bindElement=function(a){this._elements.add(a)};b._unbindElement=function(a){this._elements.delete(a)};b.onRemove=function(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this);this.fire("remove");this._elements.forEach(function(a){return a._onScreenRemove()});this._elements.clear();this.off()};N(d,[{key:"resolution",set:function(a){var c=this;this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,
this.system.app.graphicsDevice.height):this._resolution.set(a.x,a.y);this._updateScale();this._calcProjectionMatrix();this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:resolution",this._resolution);this._elements.forEach(function(e){return e._onScreenResize(c._resolution)})},get:function(){return this._resolution}},{key:"referenceResolution",set:function(a){var c=this;this._referenceResolution.set(a.x,a.y);this._updateScale();this._calcProjectionMatrix();this.entity._dirtyLocal||
this.entity._dirtifyLocal();this.fire("set:referenceresolution",this._resolution);this._elements.forEach(function(e){return e._onScreenResize(c._resolution)})},get:function(){return"none"===this._scaleMode?this._resolution:this._referenceResolution}},{key:"screenSpace",set:function(a){(this._screenSpace=a)&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height);this.resolution=this._resolution;this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:screenspace",
this._screenSpace);this._elements.forEach(function(c){return c._onScreenSpaceChange()})},get:function(){return this._screenSpace}},{key:"scaleMode",set:function(a){"none"!==a&&"blend"!==a&&(a="none");this._screenSpace||"none"===a||(a="none");this._scaleMode=a;this.resolution=this._resolution;this.fire("set:scalemode",this._scaleMode)},get:function(){return this._scaleMode}},{key:"scaleBlend",set:function(a){var c=this;this._scaleBlend=a;this._updateScale();this._calcProjectionMatrix();this.entity._dirtyLocal||
this.entity._dirtifyLocal();this.fire("set:scaleblend",this._scaleBlend);this._elements.forEach(function(e){return e._onScreenResize(c._resolution)})},get:function(){return this._scaleBlend}},{key:"priority",get:function(){return this._priority},set:function(a){255<a&&(a=255);this._priority=a}}]);return d}(ca),eq=function(){this.enabled=!0},sm=["enabled"],tm=function(g){function d(a){a=g.call(this,a)||this;a.id="screen";a.ComponentType=fi;a.DataType=eq;a.schema=sm;a.windowResolution=new S;a._drawOrderSyncQueue=
new vj;a.app.graphicsDevice.on("resizecanvas",a._onResize,F(a));O.bind("update",a._onUpdate,F(a));a.on("beforeremove",a.onRemoveComponent,F(a));return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c,e){void 0!==c.priority&&(a.priority=c.priority);void 0!==c.screenSpace&&(a.screenSpace=c.screenSpace);a.cull=a.screenSpace;void 0!==c.scaleMode&&(a.scaleMode=c.scaleMode);void 0!==c.scaleBlend&&(a.scaleBlend=c.scaleBlend);void 0!==c.resolution&&(c.resolution instanceof S?a._resolution.copy(c.resolution):
a._resolution.set(c.resolution[0],c.resolution[1]),a.resolution=a._resolution);void 0!==c.referenceResolution&&(c.referenceResolution instanceof S?a._referenceResolution.copy(c.referenceResolution):a._referenceResolution.set(c.referenceResolution[0],c.referenceResolution[1]),a.referenceResolution=a._referenceResolution);a.syncDrawOrder();g.prototype.initializeComponentData.call(this,a,c,e)};b.destroy=function(){this.off();this.app.graphicsDevice.off("resizecanvas",this._onResize,this)};b._onUpdate=
function(a){var c=this.store,e;for(e in c)c[e].entity.screen.update&&c[e].entity.screen.update(a)};b._onResize=function(a,c){this.windowResolution.x=a;this.windowResolution.y=c};b.cloneComponent=function(a,c){a=a.screen;return this.addComponent(c,{enabled:a.enabled,screenSpace:a.screenSpace,scaleMode:a.scaleMode,resolution:a.resolution.clone(),referenceResolution:a.referenceResolution.clone()})};b.onRemoveComponent=function(a,c){c.onRemove()};b.processDrawOrderSyncQueue=function(){for(var a=this._drawOrderSyncQueue.list(),
c=0;c<a.length;c++){var e=a[c];e.callback.call(e.scope)}this._drawOrderSyncQueue.clear()};b.queueDrawOrderSync=function(a,c,e){if(!this._drawOrderSyncQueue.list().length)this.app.once("prerender",this.processDrawOrderSyncQueue,this);this._drawOrderSyncQueue.has(a)||this._drawOrderSyncQueue.push(a,{callback:c,scope:e})};return d}(O);ca._buildAccessors(fi.prototype,sm);var Wn=["x","y","z","w"],Vn=[void 0,void 0,S,A,Z],ad=function(){function g(b){this.scriptType=b;this.index={}}var d=g.prototype;d.add=
function(b,a){this.index[b]||g.reservedNames.has(b)||(this.index[b]=a,Object.defineProperty(this.scriptType.prototype,b,{get:function(){return this.__attributes[b]},set:function(c){var e="attr:"+b,f=this.__attributes[b],h=f;f&&"json"!==a.type&&f.clone&&(this._callbacks.attr||this._callbacks[e])&&(h=f.clone());if(a.array){if(this.__attributes[b]=[],c){var k;var m=0;for(k=c.length;m<k;m++)this.__attributes[b].push(Ve(this.app,a,c[m],f?f[m]:null))}}else this.__attributes[b]=Ve(this.app,a,c,f);this.fire("attr",
b,this.__attributes[b],h);this.fire(e,this.__attributes[b],h)}}))};d.remove=function(b){if(!this.index[b])return!1;delete this.index[b];delete this.scriptType.prototype[b];return!0};d.has=function(b){return!!this.index[b]};d.get=function(b){return this.index[b]||null};return g}();ad.reservedNames=new Set("app entity enabled _enabled _enabledOld _destroyed __attributes __attributesRaw __scriptType __executionOrder _callbacks has get on off fire once hasEvent".split(" "));var ye=function(g){function d(a,
c){a=g.call(this,a,c)||this;a._scripts=[];a._updateList=new Wd({sortBy:"__executionOrder"});a._postUpdateList=new Wd({sortBy:"__executionOrder"});a._scriptsIndex={};a._destroyedScripts=[];a._destroyed=!1;a._scriptsData=null;a._oldState=!0;a._enabled=!0;a._beingEnabled=!1;a._isLoopingThroughScripts=!1;a._executionOrder=-1;a.on("set_enabled",a._onSetEnabled,F(a));return a}K(d,g);var b=d.prototype;b.onEnable=function(){this._beingEnabled=!0;this._checkState();if(!this.entity._beingEnabled)this.onPostStateChange();
this._beingEnabled=!1};b.onDisable=function(){this._checkState()};b.onPostStateChange=function(){for(var a,c=this._beginLooping(),e=0,f=this.scripts.length;e<f;e++)a=this.scripts[e],a._initialized&&!a._postInitialized&&a.enabled&&(a._postInitialized=!0,a.postInitialize&&this._scriptMethod(a,d.scriptMethods.postInitialize));this._endLooping(c)};b._beginLooping=function(){var a=this._isLoopingThroughScripts;this._isLoopingThroughScripts=!0;return a};b._endLooping=function(a){(this._isLoopingThroughScripts=
a)||this._removeDestroyedScripts()};b._onSetEnabled=function(a,c,e){this._beingEnabled=!0;this._checkState();this._beingEnabled=!1};b._checkState=function(){var a=this.enabled&&this.entity.enabled;if(a!==this._oldState){this._oldState=a;this.fire(a?"enable":"disable");this.fire("state",a);a?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);a=this._beginLooping();for(var c,e=0,f=this.scripts.length;e<f;e++)c=this.scripts[e],c.enabled=c._enabled;this._endLooping(a)}};
b._onBeforeRemove=function(){this.fire("remove");for(var a=this._beginLooping(),c=0;c<this.scripts.length;c++){var e=this.scripts[c];e&&this.destroy(e.__scriptType.__name)}this._endLooping(a)};b._removeDestroyedScripts=function(){var a=this._destroyedScripts.length;if(a){var c;for(c=0;c<a;c++)this._removeScriptInstance(this._destroyedScripts[c]);this._destroyedScripts.length=0;this._resetExecutionOrder(0,this._scripts.length)}};b._onInitializeAttributes=function(){for(var a=0,c=this.scripts.length;a<
c;a++)this.scripts[a].__initializeAttributes()};b._scriptMethod=function(a,c,e){a[c](e)};b._onInitialize=function(){for(var a,c=this._scripts,e=this._beginLooping(),f=0,h=c.length;f<h;f++)a=c[f],!a._initialized&&a.enabled&&(a._initialized=!0,a.initialize&&this._scriptMethod(a,d.scriptMethods.initialize));this._endLooping(e)};b._onPostInitialize=function(){this.onPostStateChange()};b._onUpdate=function(a){var c=this._updateList;if(c.length){var e=this._beginLooping();for(c.loopIndex=0;c.loopIndex<
c.length;c.loopIndex++){var f=c.items[c.loopIndex];f.enabled&&this._scriptMethod(f,d.scriptMethods.update,a)}this._endLooping(e)}};b._onPostUpdate=function(a){var c=this._postUpdateList;if(c.length){var e=this._beginLooping();for(c.loopIndex=0;c.loopIndex<c.length;c.loopIndex++){var f=c.items[c.loopIndex];f.enabled&&this._scriptMethod(f,d.scriptMethods.postUpdate,a)}this._endLooping(e)}};b._insertScriptInstance=function(a,c,e){-1===c?(this._scripts.push(a),a.__executionOrder=e,a.update&&this._updateList.append(a),
a.postUpdate&&this._postUpdateList.append(a)):(this._scripts.splice(c,0,a),a.__executionOrder=c,this._resetExecutionOrder(c+1,e+1),a.update&&this._updateList.insert(a),a.postUpdate&&this._postUpdateList.insert(a))};b._removeScriptInstance=function(a){var c=this._scripts.indexOf(a);if(-1===c)return c;this._scripts.splice(c,1);a.update&&this._updateList.remove(a);a.postUpdate&&this._postUpdateList.remove(a);return c};b._resetExecutionOrder=function(a,c){for(;a<c;a++)this._scripts[a].__executionOrder=
a};b._resolveEntityScriptAttribute=function(a,c,e,f,h,k){if(a.array){if(a=e.length){e=e.slice();for(var m=0;m<a;m++){var n=e[m]instanceof Ba?e[m].getGuid():e[m];k[n]&&(e[m]=f?k[n].getGuid():k[n])}h[c]=e}}else{if(e instanceof Ba)e=e.getGuid();else if("string"!==typeof e)return;k[e]&&(h[c]=k[e])}};b.has=function(a){if("string"===typeof a)return!!this._scriptsIndex[a];if(!a)return!1;var c=this._scriptsIndex[a.__name];return(c&&c.instance)instanceof a};b.get=function(a){if("string"===typeof a)return(a=
this._scriptsIndex[a])?a.instance:null;if(!a)return null;var c=this._scriptsIndex[a.__name];c=c&&c.instance;return c instanceof a?c:null};b.create=function(a,c){void 0===c&&(c={});var e=this,f=a,h=a;"string"===typeof f?f=this.system.app.scripts.get(f):f&&(h=f.__name);if(f){if(!this._scriptsIndex[h]||!this._scriptsIndex[h].instance){a=new f({app:this.system.app,entity:this.entity,enabled:c.hasOwnProperty("enabled")?c.enabled:!0,attributes:c.attributes});f=this._scripts.length;var k=-1;"number"===typeof c.ind&&
-1!==c.ind&&f>c.ind&&(k=c.ind);this._insertScriptInstance(a,k,f);this._scriptsIndex[h]={instance:a,onSwap:function(){e.swap(h)}};this[h]=a;c.preloading||a.__initializeAttributes();this.fire("create",h,a);this.fire("create:"+h,a);this.system.app.scripts.on("swap:"+h,this._scriptsIndex[h].onSwap);c.preloading||(a.enabled&&!a._initialized&&(a._initialized=!0,a.initialize&&this._scriptMethod(a,d.scriptMethods.initialize)),a.enabled&&!a._postInitialized&&(a._postInitialized=!0,a.postInitialize&&this._scriptMethod(a,
d.scriptMethods.postInitialize)));return a}console.warn("script '"+h+"' is already added to entity '"+this.entity.name+"'")}else this._scriptsIndex[h]={awaiting:!0,ind:this._scripts.length},console.warn("script '"+h+"' is not found, awaiting it to be added to registry");return null};b.destroy=function(a){var c=a;"string"===typeof a?this.system.app.scripts.get(a):a&&(c=a.__name);a=this._scriptsIndex[c];delete this._scriptsIndex[c];if(!a)return!1;var e=a.instance;if(e&&!e._destroyed)if(e.enabled=!1,
e._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(e);else{var f=this._removeScriptInstance(e);0<=f&&this._resetExecutionOrder(f,this._scripts.length)}this.system.app.scripts.off("swap:"+c,a.onSwap);delete this[c];this.fire("destroy",c,e||null);this.fire("destroy:"+c,e||null);e&&e.fire("destroy");return!0};b.swap=function(a){var c=a;"string"===typeof a?a=this.system.app.scripts.get(a):a&&(c=a.__name);var e=this._scriptsIndex[c];if(!e||!e.instance)return!1;e=e.instance;var f=
this._scripts.indexOf(e);a=new a({app:this.system.app,entity:this.entity,enabled:e.enabled,attributes:e.__attributes});if(!a.swap)return!1;a.__initializeAttributes();this._scripts[f]=a;this._scriptsIndex[c].instance=a;this[c]=a;a.__executionOrder=f;e.update&&this._updateList.remove(e);e.postUpdate&&this._postUpdateList.remove(e);a.update&&this._updateList.insert(a);a.postUpdate&&this._postUpdateList.insert(a);this._scriptMethod(a,d.scriptMethods.swap,e);this.fire("swap",c,a);this.fire("swap:"+c,a);
return!0};b.resolveDuplicatedEntityReferenceProperties=function(a,c){var e=this.entity.script,f,h,k;for(k in a._scriptsIndex){var m=this.system.app.scripts.get(k);if(m&&(f=a._scriptsIndex[k])&&f.instance){var n=e[k].__attributesRaw,p=e[k].__attributes;if(n||p){var t=!!n,r=f.instance.__attributes,u;for(u in r)if(r[u]){var v=m.attributes.get(u);if(v)if("entity"===v.type)this._resolveEntityScriptAttribute(v,u,r[u],t,n||p,c);else if("json"===v.type&&Array.isArray(v.schema)){var w=r[u],y=n?n[u]:p[u];for(f=
0;f<v.schema.length;f++){var x=v.schema[f];if("entity"===x.type)if(v.array)for(h=0;h<w.length;h++)this._resolveEntityScriptAttribute(x,x.name,w[h][x.name],t,y[h],c);else this._resolveEntityScriptAttribute(x,x.name,w[x.name],t,y,c)}}}}}}};b.move=function(a,c){var e=this._scripts.length;if(c>=e||0>c)return!1;var f=a,h=a;"string"!==typeof h?h=a.__name:f=null;a=this._scriptsIndex[h];if(!a||!a.instance)return!1;a=a.instance;if(f&&!(a instanceof f))return!1;f=this._scripts.indexOf(a);if(-1===f||f===c)return!1;
this._scripts.splice(c,0,this._scripts.splice(f,1)[0]);this._resetExecutionOrder(0,e);this._updateList.sort();this._postUpdateList.sort();this.fire("move",h,a,c,f);this.fire("move:"+h,a,c,f);return!0};N(d,[{key:"enabled",get:function(){return this._enabled},set:function(a){var c=this._enabled;this._enabled=a;this.fire("set","enabled",c,a)}},{key:"scripts",get:function(){return this._scripts},set:function(a){this._scriptsData=a;for(var c in a)if(a.hasOwnProperty(c)){var e=this._scriptsIndex[c];if(e){if("boolean"===
typeof a[c].enabled&&(e.enabled=!!a[c].enabled),"object"===typeof a[c].attributes)for(var f in a[c].attributes)if(!ad.reservedNames.has(f)){if(!e.__attributes.hasOwnProperty(f)){var h=this.system.app.scripts.get(c);h&&h.attributes.add(f,{})}e[f]=a[c].attributes[f]}}else console.log(this.order)}}}]);return d}(ca);ye.scriptMethods={initialize:"initialize",postInitialize:"postInitialize",update:"update",postUpdate:"postUpdate",swap:"swap"};var fq=function(){this.enabled=!0},Zf=0,um=function(g){function d(a){a=
g.call(this,a)||this;a.id="script";a.ComponentType=ye;a.DataType=fq;a._components=new Wd({sortBy:"_executionOrder"});a._enabledComponents=new Wd({sortBy:"_executionOrder"});a.preloading=!0;a.on("beforeremove",a._onBeforeRemove,F(a));O.bind("initialize",a._onInitialize,F(a));O.bind("postInitialize",a._onPostInitialize,F(a));O.bind("update",a._onUpdate,F(a));O.bind("postUpdate",a._onPostUpdate,F(a));return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c){a._executionOrder=Zf++;this._components.append(a);
Zf>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder();a.enabled=c.hasOwnProperty("enabled")?!!c.enabled:!0;a.enabled&&a.entity.enabled&&this._enabledComponents.append(a);if(c.hasOwnProperty("order")&&c.hasOwnProperty("scripts")){a._scriptsData=c.scripts;for(var e=0;e<c.order.length;e++)a.create(c.order[e],{enabled:c.scripts[c.order[e]].enabled,attributes:c.scripts[c.order[e]].attributes,preloading:this.preloading})}};b.cloneComponent=function(a,c){var e,f,h=[],k={};for(e=0;e<a.script._scripts.length;e++){var m=
a.script._scripts[e],n=m.__scriptType.__name;h.push(n);var p={};for(f in m.__attributes)p[f]=m.__attributes[f];k[n]={enabled:m._enabled,attributes:p}}for(f in a.script._scriptsIndex)f.awaiting&&h.splice(f.ind,0,f);return this.addComponent(c,{enabled:a.script.enabled,order:h,scripts:k})};b._resetExecutionOrder=function(){for(var a=Zf=0,c=this._components.length;a<c;a++)this._components.items[a]._executionOrder=Zf++};b._callComponentMethod=function(a,c,e){for(a.loopIndex=0;a.loopIndex<a.length;a.loopIndex++)a.items[a.loopIndex][c](e)};
b._onInitialize=function(){this.preloading=!1;this._callComponentMethod(this._components,"_onInitializeAttributes");this._callComponentMethod(this._enabledComponents,"_onInitialize")};b._onPostInitialize=function(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize")};b._onUpdate=function(a){this._callComponentMethod(this._enabledComponents,"_onUpdate",a)};b._onPostUpdate=function(a){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",a)};b._addComponentToEnabled=function(a){this._enabledComponents.insert(a)};
b._removeComponentFromEnabled=function(a){this._enabledComponents.remove(a)};b._onBeforeRemove=function(a,c){0<=this._components.items.indexOf(c)&&c._onBeforeRemove();this._removeComponentFromEnabled(c);this._components.remove(c)};return d}(O),gi=function(g){function d(a,c){a=g.call(this,a,c)||this;a.on("set_scripts",a.onSetScripts,F(a));return a}K(d,g);var b=d.prototype;b.send=function(a,c){var e=Array.prototype.slice.call(arguments,2),f=this.entity.script.instances,h;if(f&&f[a]&&(h=f[a].instance[c]))return h.apply(f[a].instance,
e)};b.onEnable=function(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))};b.onDisable=function(){this.system._disableScriptComponent(this)};b.onSetScripts=function(a,c,e){this.system._inTools&&!this.runInTools||this._updateScriptAttributes(c,e)||(this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),
this.data.areScriptsLoaded=!1,a=e.map(function(f){return f.url}),this._loadFromCache(a)||this._loadScripts(a))};b._updateScriptAttributes=function(a,c){var e=!0;if(a.length!==c.length)e=!1;else{var f,h=c.length;for(f=0;f<h;f++)if(a[f].url!==c[f].url){e=!1;break}}if(e)for(var k in this.instances)this.instances.hasOwnProperty(k)&&this.system._updateAccessors(this.entity,this.instances[k]);return e};b._loadFromCache=function(a){var c,e=[],f=this.system.app._scriptPrefix||"",h=/^http(s)?:\/\//i;var k=
0;for(c=a.length;k<c;k++){var m=a[k];h.test(m)||(m=da.join(f,m));m=this.system.app.loader.getFromCache(m,"script");if(!m)return!1;e.push(m)}k=0;for(c=e.length;k<c;k++)f=e[k],!0!==f&&f&&this.entity.script&&!this.entity.script.instances[f._pcScriptName]&&(h=new f(this.entity),this.system._preRegisterInstance(this.entity,a[k],f._pcScriptName,h));this.data&&(this.data.areScriptsLoaded=!0);this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity));return!0};
b._loadScripts=function(a){var c=a.length,e=this.system.app._scriptPrefix||"";a.forEach(function(f){var h=null,k=null;f.toLowerCase().startsWith("http://")||f.toLowerCase().startsWith("https://")?h=k=f:(k=f,h=da.join(e,f));this.system.app.loader.load(h,"script",function(m,n){c--;m?console.error(m):n&&this.entity.script&&!this.entity.script.instances[n._pcScriptName]&&(m=new n(this.entity),this.system._preRegisterInstance(this.entity,k,n._pcScriptName,m));0===c&&(this.data.areScriptsLoaded=!0,this.system.preloading||
(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))}.bind(this))}.bind(this))};return d}(ca),gq=function(){this.scripts=[];this.enabled=!0;this.instances={};this._instances={};this.runInTools=!1;this.attributes={};this.areScriptsLoaded=this.postInitialized=this.initialized=!1},vm=["enabled","scripts","instances","runInTools"],wm=function(g){function d(a){a=g.call(this,a)||this;a.id="script";a.ComponentType=gi;a.DataType=gq;a.schema=vm;a.preloading=!1;a.instancesWithUpdate=
[];a.instancesWithFixedUpdate=[];a.instancesWithPostUpdate=[];a.instancesWithToolsUpdate=[];a.on("beforeremove",a.onBeforeRemove,F(a));O.bind("initialize",a.onInitialize,F(a));O.bind("postInitialize",a.onPostInitialize,F(a));O.bind("update",a.onUpdate,F(a));O.bind("fixedUpdate",a.onFixedUpdate,F(a));O.bind("postUpdate",a.onPostUpdate,F(a));O.bind("toolsUpdate",a.onToolsUpdate,F(a));return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c,e){e=["runInTools","enabled","scripts"];c.scripts&&
c.scripts.length&&c.scripts.forEach(function(f){if(f.attributes&&Array.isArray(f.attributes)){for(var h={},k=0;k<f.attributes.length;k++)h[f.attributes[k].name]=f.attributes[k];f.attributes=h}});g.prototype.initializeComponentData.call(this,a,c,e)};b.cloneComponent=function(a,c){var e=this.store[a.getGuid()];a={runInTools:e.data.runInTools,scripts:[],enabled:e.data.enabled};e=e.data.scripts;for(var f=0,h=e.length;f<h;f++){var k=e[f].attributes;k&&delete e[f].attributes;a.scripts.push(Ob({},e[f]));
k&&(a.scripts[f].attributes=this._cloneAttributes(k),e[f].attributes=k)}return this.addComponent(c,a)};b.onBeforeRemove=function(a,c){c.enabled&&this._disableScriptComponent(c);this._destroyScriptComponent(c)};b.onInitialize=function(a){this._registerInstances(a);if(a.enabled){a.script&&a.script.enabled&&this._initializeScriptComponent(a.script);a=a._children;var c,e=a.length;for(c=0;c<e;c++)if(a[c]instanceof Ba)this.onInitialize(a[c])}};b.onPostInitialize=function(a){if(a.enabled){a.script&&a.script.enabled&&
this._postInitializeScriptComponent(a.script);a=a._children;var c,e=a.length;for(c=0;c<e;c++)if(a[c]instanceof Ba)this.onPostInitialize(a[c])}};b._callInstancesMethod=function(a,c){a=a.data.instances;for(var e in a)if(a.hasOwnProperty(e)){var f=a[e].instance;if(f[c])f[c]()}};b._initializeScriptComponent=function(a){this._callInstancesMethod(a,"initialize");a.data.initialized=!0;a.enabled&&a.entity.enabled&&this._enableScriptComponent(a)};b._enableScriptComponent=function(a){this._callInstancesMethod(a,
"onEnable")};b._disableScriptComponent=function(a){this._callInstancesMethod(a,"onDisable")};b._destroyScriptComponent=function(a){var c=a.data.instances,e;for(e in c)if(c.hasOwnProperty(e)){var f=c[e].instance;f.destroy&&f.destroy();if(f.update){var h=this.instancesWithUpdate.indexOf(f);0<=h&&this.instancesWithUpdate.splice(h,1)}f.fixedUpdate&&(h=this.instancesWithFixedUpdate.indexOf(f),0<=h&&this.instancesWithFixedUpdate.splice(h,1));f.postUpdate&&(h=this.instancesWithPostUpdate.indexOf(f),0<=h&&
this.instancesWithPostUpdate.splice(h,1));f.toolsUpdate&&(h=this.instancesWithToolsUpdate.indexOf(f),0<=h&&this.instancesWithToolsUpdate.splice(h,1));a.instances[e].instance===a[e]&&delete a[e];delete a.instances[e]}};b._postInitializeScriptComponent=function(a){this._callInstancesMethod(a,"postInitialize");a.data.postInitialized=!0};b._updateInstances=function(a,c,e){for(var f,h=0,k=c.length;h<k;h++)if((f=c[h])&&f.entity&&f.entity.enabled&&f.entity.script.enabled)f[a](e)};b.onUpdate=function(a){this._updateInstances("update",
this.instancesWithUpdate,a)};b.onFixedUpdate=function(a){this._updateInstances("fixedUpdate",this.instancesWithFixedUpdate,a)};b.onPostUpdate=function(a){this._updateInstances("postUpdate",this.instancesWithPostUpdate,a)};b.onToolsUpdate=function(a){this._updateInstances("toolsUpdate",this.instancesWithToolsUpdate,a)};b.broadcast=function(a,c){var e=Array.prototype.slice.call(arguments,2),f,h,k=this.store;for(f in k)if(k.hasOwnProperty(f)){var m=k[f].data;m.instances[a]&&(h=m.instances[a].instance[c])&&
h.apply(m.instances[a].instance,e)}};b._preRegisterInstance=function(a,c,e,f){if(a.script){a.script.data._instances=a.script.data._instances||{};if(a.script.data._instances[e])throw Error("Script name collision '"+e+"'. Scripts from '"+c+"' and '"+a.script.data._instances[e].url+"' {"+a.getGuid()+"}");a.script.data._instances[e]={url:c,name:e,instance:f}}};b._registerInstances=function(a){var c;if(a.script&&a.script.data._instances){a.script.instances=a.script.data._instances;for(c in a.script.instances){var e=
a.script.instances[c];var f=e.instance;Ud.attach(f);f.update&&this.instancesWithUpdate.push(f);f.fixedUpdate&&this.instancesWithFixedUpdate.push(f);f.postUpdate&&this.instancesWithPostUpdate.push(f);f.toolsUpdate&&this.instancesWithToolsUpdate.push(f);a.script.scripts&&this._createAccessors(a,e);if(a.script[c])throw Error("Script with name '"+c+"' is already attached to Script Component");a.script[c]=f}delete a.script.data._instances}a=a._children;f=a.length;for(e=0;e<f;e++)a[e]instanceof Ba&&this._registerInstances(a[e])};
b._cloneAttributes=function(a){var c={},e;for(e in a)if(a.hasOwnProperty(e))if("entity"!==a[e].type)c[e]=Ob({},a[e]);else{var f=a[e].value;delete a[e].value;c[e]=Ob({},a[e]);c[e].value=f;a[e].value=f}return c};b._createAccessors=function(a,c){var e,f=a.script.scripts.length,h=c.url;for(e=0;e<f;e++){var k=a.script.scripts[e];if(k.url===h){e=k.attributes;if(k.name&&e){for(var m in e)e.hasOwnProperty(m)&&this._createAccessor(e[m],c);a.script.data.attributes[k.name]=this._cloneAttributes(e)}break}}};
b._createAccessor=function(a,c){var e=this;a={name:a.name,value:a.value,type:a.type};e._convertAttributeValue(a);Object.defineProperty(c.instance,a.name,{get:function(){return a.value},set:function(f){var h=a.value;a.value=f;e._convertAttributeValue(a);c.instance.fire("set",a.name,h,a.value)},configurable:!0})};b._updateAccessors=function(a,c){var e,f=a.script.scripts.length,h,k=c.url;for(e=0;e<f;e++){var m=a.script;var n=m.scripts[e];if(n.url===k){a=n.name;n=n.attributes;if(a){if(n)for(h in n)n.hasOwnProperty(h)&&
this._createAccessor(n[h],c);if(e=m.data.attributes[a])for(h in e)if(f=e[h],!(h in n))delete c.instance[f.name];else if(n[h].value!==f.value&&c.instance.onAttributeChanged)c.instance.onAttributeChanged(f.name,f.value,n[h].value);n?m.data.attributes[a]=this._cloneAttributes(n):delete m.data.attributes[a]}break}}};b._convertAttributeValue=function(a){if("rgb"===a.type||"rgba"===a.type)Array.isArray(a.value)&&(a.value=3===a.value.length?new Q(a.value[0],a.value[1],a.value[2]):new Q(a.value[0],a.value[1],
a.value[2],a.value[3]));else if("vec2"===a.type)Array.isArray(a.value)&&(a.value=new S(a.value[0],a.value[1]));else if("vec3"===a.type||"vector"===a.type)Array.isArray(a.value)&&(a.value=new A(a.value[0],a.value[1],a.value[2]));else if("vec4"===a.type)Array.isArray(a.value)&&(a.value=new Z(a.value[0],a.value[1],a.value[2],a.value[3]));else if("entity"===a.type)null!==a.value&&"string"===typeof a.value&&(a.value=this.app.root.findByGuid(a.value));else if("curve"===a.type||"colorcurve"===a.type)a.value=
new (a.value.keys[0]instanceof Array?Qb:db)(a.value.keys),a.value.type=a.value.type};return d}(O);ca._buildAccessors(gi.prototype,vm);var qc=new S,xm=new A,ze=new A,$f=new A,ym=new A,hi=new A,hq=new ea,iq={x:"y",y:"x"},ii=function(g){function d(a,c){var e=g.call(this)||this;if(!(a&&a instanceof ka))throw Error("Element was null or not an ElementComponent");if(c&&"x"!==c&&"y"!==c)throw Error("Unrecognized axis: "+c);e._element=a;e._app=a.system.app;e._axis=c||null;e._enabled=!0;e._dragScale=new A;
e._dragStartMousePosition=new A;e._dragStartHandlePosition=new A;e._deltaMousePosition=new A;e._deltaHandlePosition=new A;e._isDragging=!1;e._toggleLifecycleListeners("on");return e}K(d,g);var b=d.prototype;b._toggleLifecycleListeners=function(a){this._element[a]("mousedown",this._onMouseDownOrTouchStart,this);this._element[a]("touchstart",this._onMouseDownOrTouchStart,this)};b._toggleDragListeners=function(a){var c="on"===a,e=c?"addEventListener":"removeEventListener";this._hasDragListeners&&c||
(this._handleMouseUpOrTouchEnd||(this._handleMouseUpOrTouchEnd=this._onMouseUpOrTouchEnd.bind(this)),this._app.mouse&&(this._app.mouse[a]("mousemove",this._onMove,this),window[e]("mouseup",this._handleMouseUpOrTouchEnd,!1)),za.touch&&(this._app.touch[a]("touchmove",this._onMove,this),window[e]("touchend",this._handleMouseUpOrTouchEnd,!1),window[e]("touchcancel",this._handleMouseUpOrTouchEnd,!1)),this._hasDragListeners=c)};b._onMouseDownOrTouchStart=function(a){this._element&&!this._isDragging&&this.enabled&&
(this._dragCamera=a.camera,this._calculateDragScale(),a=this._screenToLocal(a))&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(a),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))};b._onMouseUpOrTouchEnd=function(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))};b._screenToLocal=function(a){this._determineInputPosition(a);this._chooseRayOriginAndDirection();ym.copy(this._element.entity.getPosition());
hi.copy(this._element.entity.forward).scale(-1);a=hi.dot($f);return 0<Math.abs(a)?(a=ym.sub(ze).dot(hi)/a,a=ze.add($f.scale(a)),hq.copy(this._element.entity.getRotation()).invert().transformVector(a,a),a.mul(this._dragScale),a):null};b._determineInputPosition=function(a){var c=this._app.graphicsDevice.maxPixelRatio;"undefined"!==typeof a.x&&"undefined"!==typeof a.y?(qc.x=a.x*c,qc.y=a.y*c):a.changedTouches?(qc.x=a.changedTouches[0].x*c,qc.y=a.changedTouches[0].y*c):console.warn("Could not determine position from input event")};
b._chooseRayOriginAndDirection=function(){this._element.screen&&this._element.screen.screen.screenSpace?(ze.set(qc.x,-qc.y,0),$f.set(0,0,-1)):(xm.copy(this._dragCamera.screenToWorld(qc.x,qc.y,1)),ze.copy(this._dragCamera.entity.getPosition()),$f.copy(xm).sub(ze).normalize())};b._calculateDragScale=function(){var a=this._element.entity.parent,c=this._element.screen&&this._element.screen.screen,e=c&&c.screenSpace;c=e?c.scale:1;var f=this._dragScale;for(f.set(c,c,c);a&&(f.mul(a.getLocalScale()),a=a.parent,
!e||!a.screen););f.x=1/f.x;f.y=1/f.y;f.z=1/f.z};b._onMove=function(a){if(this._element&&this._isDragging&&this.enabled&&this._element.enabled&&this._element.entity.enabled&&(a=this._screenToLocal(a),this._dragStartMousePosition&&a)){this._deltaMousePosition.copy(a).sub(this._dragStartMousePosition);this._deltaHandlePosition.copy(this._dragStartHandlePosition).add(this._deltaMousePosition);if(this._axis){a=this._element.entity.getLocalPosition();var c=iq[this._axis];this._deltaHandlePosition[c]=a[c]}this._element.entity.setLocalPosition(this._deltaHandlePosition);
this.fire("drag:move",this._deltaHandlePosition)}};b.destroy=function(){this._toggleLifecycleListeners("off");this._toggleDragListeners("off")};N(d,[{key:"enabled",get:function(){return this._enabled},set:function(a){this._enabled=a}},{key:"isDragging",get:function(){return this._isDragging}}]);return d}(ba),ji=new S,ki=function(g){function d(a,c){c=g.call(this,a,c)||this;c._viewportReference=new nc(F(c),"viewportEntity",{"element#gain":c._onViewportElementGain,"element#resize":c._onSetContentOrViewportSize});
c._contentReference=new nc(F(c),"contentEntity",{"element#gain":c._onContentElementGain,"element#lose":c._onContentElementLose,"element#resize":c._onSetContentOrViewportSize});c._scrollbarUpdateFlags={};c._scrollbarReferences={};c._scrollbarReferences[0]=new nc(F(c),"horizontalScrollbarEntity",{"scrollbar#set:value":c._onSetHorizontalScrollbarValue,"scrollbar#gain":c._onHorizontalScrollbarGain});c._scrollbarReferences[1]=new nc(F(c),"verticalScrollbarEntity",{"scrollbar#set:value":c._onSetVerticalScrollbarValue,
"scrollbar#gain":c._onVerticalScrollbarGain});c._prevContentSizes={};c._prevContentSizes[0]=null;c._prevContentSizes[1]=null;c._scroll=new S;c._velocity=new A;c._dragStartPosition=new A;c._disabledContentInput=!1;c._disabledContentInputEntities=[];c._toggleLifecycleListeners("on",a);c._toggleElementListeners("on");return c}K(d,g);var b=d.prototype;b._toggleLifecycleListeners=function(a,c){this[a]("set_horizontal",this._onSetHorizontalScrollingEnabled,this);this[a]("set_vertical",this._onSetVerticalScrollingEnabled,
this);c.app.systems.element[a]("add",this._onElementComponentAdd,this);c.app.systems.element[a]("beforeremove",this._onElementComponentRemove,this)};b._toggleElementListeners=function(a){!this.entity.element||"on"===a&&this._hasElementListeners||(this.entity.element[a]("resize",this._onSetContentOrViewportSize,this),this._hasElementListeners="on"===a)};b._onElementComponentAdd=function(a){this.entity===a&&this._toggleElementListeners("on")};b._onElementComponentRemove=function(a){this.entity===a&&
this._toggleElementListeners("off")};b._onViewportElementGain=function(){this._syncAll()};b._onContentElementGain=function(){this._destroyDragHelper();this._contentDragHelper=new ii(this._contentReference.entity.element);this._contentDragHelper.on("drag:start",this._onContentDragStart,this);this._contentDragHelper.on("drag:end",this._onContentDragEnd,this);this._contentDragHelper.on("drag:move",this._onContentDragMove,this);this._prevContentSizes[0]=null;this._prevContentSizes[1]=null;this._syncAll()};
b._onContentElementLose=function(){this._destroyDragHelper()};b._onContentDragStart=function(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())};b._onContentDragEnd=function(){this._prevContentDragPosition=null;this._enableContentInput()};b._onContentDragMove=function(a){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(a),this._setVelocityFromContentPositionDelta(a),
!this._disabledContentInput)){var c=a.y-this._dragStartPosition.y;(Math.abs(a.x-this._dragStartPosition.x)>this.dragThreshold||Math.abs(c)>this.dragThreshold)&&this._disableContentInput()}};b._onSetContentOrViewportSize=function(){this._syncAll()};b._onSetHorizontalScrollbarValue=function(a){!this._scrollbarUpdateFlags[0]&&this.enabled&&this.entity.enabled&&this._onSetScroll(a,null)};b._onSetVerticalScrollbarValue=function(a){!this._scrollbarUpdateFlags[1]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,
a)};b._onSetHorizontalScrollingEnabled=function(){this._syncScrollbarEnabledState(0)};b._onSetVerticalScrollingEnabled=function(){this._syncScrollbarEnabledState(1)};b._onHorizontalScrollbarGain=function(){this._syncScrollbarEnabledState(0);this._syncScrollbarPosition(0)};b._onVerticalScrollbarGain=function(){this._syncScrollbarEnabledState(1);this._syncScrollbarPosition(1)};b._onSetScroll=function(a,c,e){!1!==e&&this._velocity.set(0,0,0);a=0|this._updateAxis(a,"x",0);(a|=this._updateAxis(c,"y",1))&&
this.fire("set:scroll",this._scroll)};b._updateAxis=function(a,c,e){var f=null!==a&&1E-5<Math.abs(a-this._scroll[c]);if(f||this._isDragging()||0===a)this._scroll[c]=this._determineNewScrollValue(a,c,e),this._syncContentPosition(e),this._syncScrollbarPosition(e);return f};b._determineNewScrollValue=function(a,c,e){if(!this._getScrollingEnabled(e))return this._scroll[c];switch(this.scrollMode){case 0:return R.clamp(a,0,this._getMaxScrollValue(e));case 1:return this._setVelocityFromOvershoot(a,c,e),
a;case 2:return a;default:return console.warn("Unhandled scroll mode:"+this.scrollMode),a}};b._syncAll=function(){this._syncContentPosition(0);this._syncContentPosition(1);this._syncScrollbarPosition(0);this._syncScrollbarPosition(1);this._syncScrollbarEnabledState(0);this._syncScrollbarEnabledState(1)};b._syncContentPosition=function(a){var c=this._getAxis(a),e=this._getSign(a),f=this._contentReference.entity;if(f){var h=this._prevContentSizes[a],k=this._getContentSize(a);if(null!==h&&1E-4<Math.abs(h-
k)){h=this._getMaxOffset(a,h);var m=this._getMaxOffset(a,k);this._scroll[c]=0===m?1:R.clamp(this._scroll[c]*h/m,0,1)}h=this._scroll[c]*this._getMaxOffset(a);m=f.getLocalPosition();m[c]=h*e;f.setLocalPosition(m);this._prevContentSizes[a]=k}};b._syncScrollbarPosition=function(a){var c=this._getAxis(a),e=this._scrollbarReferences[a].entity;e&&e.scrollbar&&(this._scrollbarUpdateFlags[a]=!0,e.scrollbar.value=this._scroll[c],e.scrollbar.handleSize=this._getScrollbarHandleSize(c,a),this._scrollbarUpdateFlags[a]=
!1)};b._syncScrollbarEnabledState=function(a){var c=this._scrollbarReferences[a].entity;if(c){var e=this._getScrollingEnabled(a),f=this._getScrollbarVisibility(a);switch(f){case 0:c.enabled=e;break;case 1:c.enabled=e&&this._contentIsLargerThanViewport(a);break;default:console.warn("Unhandled scrollbar visibility:"+f),c.enabled=e}}};b._contentIsLargerThanViewport=function(a){return this._getContentSize(a)>this._getViewportSize(a)};b._contentPositionToScrollValue=function(a){var c=this._getMaxOffset(0),
e=this._getMaxOffset(1);ji.x=0===c?0:a.x/c;ji.y=0===e?0:a.y/-e;return ji};b._getMaxOffset=function(a,c){c=void 0===c?this._getContentSize(a):c;var e=this._getViewportSize(a);return c<e?-this._getViewportSize(a):e-c};b._getMaxScrollValue=function(a){return this._contentIsLargerThanViewport(a)?1:0};b._getScrollbarHandleSize=function(a,c){var e=this._getViewportSize(c),f=this._getContentSize(c);if(.001>Math.abs(f))return 1;e=Math.min(e/f,1);a=this._toOvershoot(this._scroll[a],c);return 0===a?e:e/(1+
Math.abs(a))};b._getViewportSize=function(a){return this._getSize(a,this._viewportReference)};b._getContentSize=function(a){return this._getSize(a,this._contentReference)};b._getSize=function(a,c){return c.entity&&c.entity.element?c.entity.element[this._getCalculatedDimension(a)]:0};b._getScrollingEnabled=function(a){if(0===a)return this.horizontal;if(1===a)return this.vertical;console.warn("Unrecognized orientation: "+a)};b._getScrollbarVisibility=function(a){if(0===a)return this.horizontalScrollbarVisibility;
if(1===a)return this.verticalScrollbarVisibility;console.warn("Unrecognized orientation: "+a)};b._getSign=function(a){return 0===a?1:-1};b._getAxis=function(a){return 0===a?"x":"y"};b._getCalculatedDimension=function(a){return 0===a?"calculatedWidth":"calculatedHeight"};b._destroyDragHelper=function(){this._contentDragHelper&&this._contentDragHelper.destroy()};b.onUpdate=function(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1))};
b._updateVelocity=function(){if(!this._isDragging()&&(1===this.scrollMode&&(this._hasOvershoot("x",0)&&this._setVelocityFromOvershoot(this.scroll.x,"x",0),this._hasOvershoot("y",1)&&this._setVelocityFromOvershoot(this.scroll.y,"y",1)),this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction,1E-4<Math.abs(this._velocity.x)||1E-4<Math.abs(this._velocity.y))){var a=this._contentReference.entity.getLocalPosition();a.x+=this._velocity.x;a.y+=this._velocity.y;this._contentReference.entity.setLocalPosition(a);
this._setScrollFromContentPosition(a)}};b._hasOvershoot=function(a,c){return.001<Math.abs(this._toOvershoot(this.scroll[a],c))};b._toOvershoot=function(a,c){c=this._getMaxScrollValue(c);return 0>a?a:a>c?a-c:0};b._setVelocityFromOvershoot=function(a,c,e){a=this._toOvershoot(a,e)*this._getMaxOffset(e)*this._getSign(e);0<Math.abs(a)&&(this._velocity[c]=-a/(50*this.bounceAmount+1))};b._setVelocityFromContentPositionDelta=function(a){this._prevContentDragPosition?(this._velocity.sub2(a,this._prevContentDragPosition),
this._prevContentDragPosition.copy(a)):(this._velocity.set(0,0,0),this._prevContentDragPosition=a.clone())};b._setScrollFromContentPosition=function(a){a=this._contentPositionToScrollValue(a);this._isDragging()&&(a=this._applyScrollValueTension(a));this._onSetScroll(a.x,a.y,!1)};b._applyScrollValueTension=function(a){var c=this._getMaxScrollValue(0);var e=this._toOvershoot(a.x,0);0<e?a.x=c+1*Math.log10(1+e):0>e&&(a.x=-1*Math.log10(1-e));c=this._getMaxScrollValue(1);e=this._toOvershoot(a.y,1);0<e?
a.y=c+1*Math.log10(1+e):0>e&&(a.y=-1*Math.log10(1-e));return a};b._isDragging=function(){return this._contentDragHelper&&this._contentDragHelper.isDragging};b._setScrollbarComponentsEnabled=function(a){this._scrollbarReferences[0].hasComponent("scrollbar")&&(this._scrollbarReferences[0].entity.scrollbar.enabled=a);this._scrollbarReferences[1].hasComponent("scrollbar")&&(this._scrollbarReferences[1].entity.scrollbar.enabled=a)};b._setContentDraggingEnabled=function(a){this._contentDragHelper&&(this._contentDragHelper.enabled=
a)};b._enableContentInput=function(){for(;this._disabledContentInputEntities.length;){var a=this._disabledContentInputEntities.pop();a.element&&(a.element.useInput=!0)}this._disabledContentInput=!1};b._disableContentInput=function(){var a=this,c=function n(m){m.element&&m.element.useInput&&(a._disabledContentInputEntities.push(m),m.element.useInput=!1);m=m.children;var p;var t=0;for(p=m.length;t<p;t++)n(m[t])},e=this._contentReference.entity;if(e){e=e.children;var f,h=e.length;for(f=0;f<h;f++)c(e[f])}this._disabledContentInput=
!0};b.onEnable=function(){this._viewportReference.onParentComponentEnable();this._contentReference.onParentComponentEnable();this._scrollbarReferences[0].onParentComponentEnable();this._scrollbarReferences[1].onParentComponentEnable();this._setScrollbarComponentsEnabled(!0);this._setContentDraggingEnabled(!0);this._syncAll()};b.onDisable=function(){this._setScrollbarComponentsEnabled(!1);this._setContentDraggingEnabled(!1)};b.onRemove=function(){this._toggleLifecycleListeners("off",this.system);this._toggleElementListeners("off");
this._destroyDragHelper()};N(d,[{key:"scroll",get:function(){return this._scroll},set:function(a){this._onSetScroll(a.x,a.y)}}]);return d}(ca),jq=function(){this.enabled=!0},li=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",
type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}],zm=function(g){function d(a){a=g.call(this,a)||this;a.id="scrollview";a.ComponentType=ki;a.DataType=jq;a.schema=li;a.on("beforeremove",a._onRemoveComponent,F(a));O.bind("update",a.onUpdate,F(a));return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c,e){void 0===c.dragThreshold&&(c.dragThreshold=
10);g.prototype.initializeComponentData.call(this,a,c,li)};b.onUpdate=function(a){a=this.store;for(var c in a){var e=a[c].entity,f=e.scrollview;if(f.enabled&&e.enabled)f.onUpdate()}};b._onRemoveComponent=function(a,c){c.onRemove()};return d}(O);ca._buildAccessors(ki.prototype,li);var mi=function(g){function d(a,c){c=g.call(this,a,c)||this;c._app=a.app;c._handleReference=new nc(F(c),"handleEntity",{"element#gain":c._onHandleElementGain,"element#lose":c._onHandleElementLose,"element#set:anchor":c._onSetHandleAlignment,
"element#set:margin":c._onSetHandleAlignment,"element#set:pivot":c._onSetHandleAlignment});c._toggleLifecycleListeners("on");return c}K(d,g);var b=d.prototype;b._toggleLifecycleListeners=function(a){this[a]("set_value",this._onSetValue,this);this[a]("set_handleSize",this._onSetHandleSize,this);this[a]("set_orientation",this._onSetOrientation,this)};b._onHandleElementGain=function(){this._destroyDragHelper();this._handleDragHelper=new ii(this._handleReference.entity.element,this._getAxis());this._handleDragHelper.on("drag:move",
this._onHandleDrag,this);this._updateHandlePositionAndSize()};b._onHandleElementLose=function(){this._destroyDragHelper()};b._onHandleDrag=function(a){this._handleReference.entity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(a[this._getAxis()]))};b._onSetValue=function(a,c,e){1E-5<Math.abs(e-c)&&(this.data.value=R.clamp(e,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))};b._onSetHandleSize=function(a,c,e){1E-5<Math.abs(e-c)&&(this.data.handleSize=
R.clamp(e,0,1),this._updateHandlePositionAndSize())};b._onSetHandleAlignment=function(){this._updateHandlePositionAndSize()};b._onSetOrientation=function(a,c,e){e!==c&&this._handleReference.hasComponent("element")&&(this._handleReference.entity.element[this._getOppositeDimension()]=0)};b._updateHandlePositionAndSize=function(){var a=this._handleReference.entity,c=a&&a.element;a&&(a=a.getLocalPosition(),a[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(a));
c&&(c[this._getDimension()]=this._getHandleLength())};b._handlePositionToScrollValue=function(a){return a*this._getSign()/this._getUsableTrackLength()};b._scrollValueToHandlePosition=function(a){return a*this._getSign()*this._getUsableTrackLength()};b._getUsableTrackLength=function(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)};b._getTrackLength=function(){return this.entity.element?0===this.orientation?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:
0};b._getHandleLength=function(){return this._getTrackLength()*this.handleSize};b._getHandlePosition=function(){return this._scrollValueToHandlePosition(this.value)};b._getSign=function(){return 0===this.orientation?1:-1};b._getAxis=function(){return 0===this.orientation?"x":"y"};b._getDimension=function(){return 0===this.orientation?"width":"height"};b._getOppositeDimension=function(){return 0===this.orientation?"height":"width"};b._destroyDragHelper=function(){this._handleDragHelper&&this._handleDragHelper.destroy()};
b._setHandleDraggingEnabled=function(a){this._handleDragHelper&&(this._handleDragHelper.enabled=a)};b.onEnable=function(){this._handleReference.onParentComponentEnable();this._setHandleDraggingEnabled(!0)};b.onDisable=function(){this._setHandleDraggingEnabled(!1)};b.onRemove=function(){this._destroyDragHelper();this._toggleLifecycleListeners("off")};return d}(ca),kq=function(){this.enabled=!0},ni=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",
type:"number"},{name:"handleEntity",type:"entity"}],Am=function(g){function d(a){a=g.call(this,a)||this;a.id="scrollbar";a.ComponentType=mi;a.DataType=kq;a.schema=ni;a.on("beforeremove",a._onRemoveComponent,F(a));return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c,e){g.prototype.initializeComponentData.call(this,a,c,ni)};b._onRemoveComponent=function(a,c){c.onRemove()};return d}(O);ca._buildAccessors(mi.prototype,ni);var ib=function(g){function d(a,c,e){var f=g.call(this)||this;
f._manager=a;f._volume=void 0!==e.volume?R.clamp(Number(e.volume)||0,0,1):1;f._pitch=void 0!==e.pitch?Math.max(.01,Number(e.pitch)||0):1;f._loop=!(void 0===e.loop||!e.loop);f._sound=c;f._state=2;f._suspended=!1;f._suspendEndEvent=!1;f._suspendInstanceEvents=!1;f._playWhenLoaded=!0;f._startTime=Math.max(0,Number(e.startTime)||0);f._duration=Math.max(0,Number(e.duration)||0);f._startOffset=null;f.source=null;f._onPlayCallback=e.onPlay;f._onPauseCallback=e.onPause;f._onResumeCallback=e.onResume;f._onStopCallback=
e.onStop;f._onEndCallback=e.onEnd;wb()?(f._startedAt=0,f._currentTime=0,f._currentOffset=0,f._inputNode=null,f._connectorNode=null,f._firstNode=null,f._lastNode=null,f._initializeNodes(),f._endedHandler=f._onEnded.bind(F(f))):(f._isReady=!1,f._loadedMetadataHandler=f._onLoadedMetadata.bind(F(f)),f._timeUpdateHandler=f._onTimeUpdate.bind(F(f)),f._endedHandler=f._onEnded.bind(F(f)),f._createSource());return f}K(d,g);var b=d.prototype;b._onPlay=function(){this.fire("play");this._onPlayCallback&&this._onPlayCallback(this)};
b._onPause=function(){this.fire("pause");this._onPauseCallback&&this._onPauseCallback(this)};b._onResume=function(){this.fire("resume");this._onResumeCallback&&this._onResumeCallback(this)};b._onStop=function(){this.fire("stop");this._onStopCallback&&this._onStopCallback(this)};b._onEnded=function(){this._suspendEndEvent?this._suspendEndEvent=!1:(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop())};b._onManagerVolumeChange=function(){this.volume=this._volume};b._onManagerSuspend=
function(){0!==this._state||this._suspended||(this._suspended=!0,this.pause())};b._onManagerResume=function(){this._suspended&&(this._suspended=!1,this.resume())};N(d,[{key:"loop",get:function(){return this._loop},set:function(a){this._loop=!!a;this.source&&(this.source.loop=this._loop)}},{key:"startTime",get:function(){return this._startTime},set:function(a){this._startTime=Math.max(0,Number(a)||0);a=0===this._state;this.stop();a&&this.play()}},{key:"duration",get:function(){return this._sound?this._duration?
this._duration%this._sound.duration||0:this._sound.duration:0},set:function(a){this._duration=Math.max(0,Number(a)||0);a=0===this._state;this.stop();a&&this.play()}},{key:"isPlaying",get:function(){return 0===this._state}},{key:"isPaused",get:function(){return 1===this._state}},{key:"isStopped",get:function(){return 2===this._state}},{key:"isSuspended",get:function(){return this._suspended}}]);return d}(ba);wb()?(Object.assign(ib.prototype,{_initializeNodes:function(){this._connectorNode=this._inputNode=
this.gain=this._manager.context.createGain();this._connectorNode.connect(this._manager.context.destination)},play:function(){2!==this._state&&this.stop();this.source||this._createSource();var g=this._startOffset%this.duration||0;g=(this._startTime+g)%this._sound.duration||0;this._startOffset=null;this._duration?this.source.start(0,g,this._duration):this.source.start(0,g);this._startedAt=this._manager.context.currentTime;this._currentTime=0;this._currentOffset=g;this._state=0;this._playWhenLoaded=
!1;this.volume=this._volume;this.loop=this._loop;this.pitch=this._pitch;this._manager.on("volumechange",this._onManagerVolumeChange,this);this._manager.on("suspend",this._onManagerSuspend,this);this._manager.on("resume",this._onManagerResume,this);this._manager.on("destroy",this._onManagerDestroy,this);this._manager.suspended&&this._onManagerSuspend();this._suspendInstanceEvents||this._onPlay();return!0},pause:function(){if(0!==this._state||!this.source)return!1;this._updateCurrentTime();this._state=
1;this._suspendEndEvent=!0;this.source.stop(0);this.source=null;this._playWhenLoaded=!1;this._startOffset=null;this._suspendInstanceEvents||this._onPause();return!0},resume:function(){if(1!==this._state)return!1;this.source||this._createSource();var g=this.currentTime;null!==this._startOffset&&(g=this._startOffset%this.duration||0,g=(this._startTime+g)%this._sound.duration||0,this._startOffset=null);this._duration?this.source.start(0,g,this._duration):this.source.start(0,g);this._state=0;this._startedAt=
this._manager.context.currentTime;this._currentOffset=g;this.volume=this._volume;this.loop=this._loop;this.pitch=this._pitch;this._playWhenLoaded=!1;this._suspendInstanceEvents||this._onResume();return!0},stop:function(){if(2===this._state||!this.source)return!1;this._manager.off("volumechange",this._onManagerVolumeChange,this);this._manager.off("suspend",this._onManagerSuspend,this);this._manager.off("resume",this._onManagerResume,this);this._manager.off("destroy",this._onManagerDestroy,this);this._currentOffset=
this._currentTime=this._startedAt=0;this._startOffset=null;this._playWhenLoaded=!1;this._suspendEndEvent=!0;0===this._state&&this.source.stop(0);this.source=null;this._state=2;this._suspendInstanceEvents||this._onStop();return!0},setExternalNodes:function(g,d){if(g){d||(d=g);var b=this._manager.context.destination;this._firstNode!==g&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(b),this._firstNode=g,this._connectorNode.connect(g));this._lastNode!==
d&&(this._lastNode&&this._lastNode.disconnect(b),this._lastNode=d,this._lastNode.connect(b))}else console.error("The firstNode must be a valid Audio Node")},clearExternalNodes:function(){var g=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null);this._lastNode&&(this._lastNode.disconnect(g),this._lastNode=null);this._connectorNode.connect(g)},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_createSource:function(){if(!this._sound)return null;
var g=this._manager.context;this._sound.buffer&&(this.source=g.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=this._startTime%this.source.buffer.duration||0,this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,(this._startTime+this._duration)%this.source.buffer.duration||0)));return this.source},_updateCurrentTime:function(){this._currentTime=((this._manager.context.currentTime-
this._startedAt)*this._pitch+this._currentOffset)%this.duration||0},_onManagerDestroy:function(){this.source&&0===this._state&&(this.source.stop(0),this.source=null)}}),Object.defineProperty(ib.prototype,"volume",{get:function(){return this._volume},set:function(g){this._volume=g=R.clamp(g,0,1);this.gain&&(this.gain.gain.value=g*this._manager.volume)}}),Object.defineProperty(ib.prototype,"pitch",{get:function(){return this._pitch},set:function(g){this._currentOffset=this.currentTime;this._startedAt=
this._manager.context.currentTime;this._pitch=Math.max(Number(g)||0,.01);this.source&&(this.source.playbackRate.value=this._pitch)}}),Object.defineProperty(ib.prototype,"sound",{get:function(){return this._sound},set:function(g){this._sound=g;2!==this._state?this.stop():this._createSource()}}),Object.defineProperty(ib.prototype,"currentTime",{get:function(){if(null!==this._startOffset)return this._startOffset;if(1===this._state)return this._currentTime;if(2===this._state||!this.source)return 0;this._updateCurrentTime();
return this._currentTime},set:function(g){if(!(0>g))if(0===this._state){this.stop();var d=this._suspendInstanceEvents;this._suspendInstanceEvents=!0;this._startOffset=g;this.play();this._suspendInstanceEvents=d}else this._currentTime=this._startOffset=g}})):(Object.assign(ib.prototype,{play:function(){2!==this._state&&this.stop();if(!this.source&&!this._createSource())return!1;this.volume=this._volume;this.pitch=this._pitch;this.loop=this._loop;this.source.play();this._state=0;this._playWhenLoaded=
!1;this._manager.on("volumechange",this._onManagerVolumeChange,this);this._manager.on("suspend",this._onManagerSuspend,this);this._manager.on("resume",this._onManagerResume,this);this._manager.on("destroy",this._onManagerDestroy,this);this._manager.suspended&&this._onManagerSuspend();this._suspendInstanceEvents||this._onPlay();return!0},pause:function(){if(!this.source||0!==this._state)return!1;this._suspendEndEvent=!0;this.source.pause();this._playWhenLoaded=!1;this._state=1;this._startOffset=null;
this._suspendInstanceEvents||this._onPause();return!0},resume:function(){if(!this.source||1!==this._state)return!1;this._state=0;this._playWhenLoaded=!1;this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume());return!0},stop:function(){if(!this.source||2===this._state)return!1;this._manager.off("volumechange",this._onManagerVolumeChange,this);this._manager.off("suspend",this._onManagerSuspend,this);this._manager.off("resume",this._onManagerResume,this);this._manager.off("destroy",
this._onManagerDestroy,this);this._suspendEndEvent=!0;this.source.pause();this._playWhenLoaded=!1;this._state=2;this._startOffset=null;this._suspendInstanceEvents||this._onStop();return!0},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler);this._isReady=!0;var g=this._startOffset%this.duration||0;g=(this._startTime+g)%this._sound.duration||
0;this._startOffset=null;this.source.currentTime=g},_createSource:function(){this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler);return this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>((this._startTime+this._duration)%this.source.duration||0)&&(this.loop?
this.source.currentTime=this._startTime%this.source.duration||0:(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(ib.prototype,"volume",{get:function(){return this._volume},set:function(g){this._volume=g=R.clamp(g,0,1);this.source&&(this.source.volume=g*this._manager.volume)}}),Object.defineProperty(ib.prototype,"pitch",{get:function(){return this._pitch},
set:function(g){this._pitch=Math.max(Number(g)||0,.01);this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(ib.prototype,"sound",{get:function(){return this._sound},set:function(g){this.stop();this._sound=g}}),Object.defineProperty(ib.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(g){0>g||(this._startOffset=g,this.source&&this._isReady&&(this.source.currentTime=
(this._startTime+(g%this.duration||0))%this._sound.duration||0,this._startOffset=null))}}));var Ya=function(g){function d(b,a,c){b=g.call(this,b,a,c)||this;c=c||{};b._position=new A;c.position&&(b.position=c.position);b._velocity=new A;c.velocity&&(b.velocity=c.velocity);b.maxDistance=void 0!==c.maxDistance?Number(c.maxDistance):1E4;b.refDistance=void 0!==c.refDistance?Number(c.refDistance):1;b.rollOffFactor=void 0!==c.rollOffFactor?Number(c.rollOffFactor):1;b.distanceModel=void 0!==c.distanceModel?
c.distanceModel:"linear";return b}K(d,g);return d}(ib);if(wb())Object.assign(Ya.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain();this.panner=this._manager.context.createPanner();this.panner.connect(this.gain);this._inputNode=this.panner;this._connectorNode=this.gain;this._connectorNode.connect(this._manager.context.destination)}}),Object.defineProperty(Ya.prototype,"position",{get:function(){return this._position},set:function(g){this._position.copy(g);this.panner.setPosition(g.x,
g.y,g.z)}}),Object.defineProperty(Ya.prototype,"velocity",{get:function(){return this._velocity},set:function(g){this._velocity.copy(g);this.panner.setVelocity(g.x,g.y,g.z)}}),Object.defineProperty(Ya.prototype,"maxDistance",{get:function(){return this.panner.maxDistance},set:function(g){this.panner.maxDistance=g}}),Object.defineProperty(Ya.prototype,"refDistance",{get:function(){return this.panner.refDistance},set:function(g){this.panner.refDistance=g}}),Object.defineProperty(Ya.prototype,"rollOffFactor",
{get:function(){return this.panner.rolloffFactor},set:function(g){this.panner.rolloffFactor=g}}),Object.defineProperty(Ya.prototype,"distanceModel",{get:function(){return this.panner.distanceModel},set:function(g){this.panner.distanceModel=g}});else{var oi=new A;Object.defineProperty(Ya.prototype,"position",{get:function(){return this._position},set:function(g){this._position.copy(g);if(this.source){var d=this._manager.listener.getPosition();g=this.refDistance;var b=this.maxDistance,a=this.rollOffFactor,
c=this.distanceModel;oi=oi.sub2(d,this._position);d=oi.length();if(d<g)g=1;else if(d>b)g=0;else{var e=0;"linear"===c?e=1-a*(d-g)/(b-g):"inverse"===c?e=g/(g+a*(d-g)):"exponential"===c&&(e=Math.pow(d/g,-a));g=R.clamp(e,0,1)}this.source.volume=this.volume*g*this._manager.volume}}});Object.defineProperty(Ya.prototype,"velocity",{get:function(){return this._velocity},set:function(g){this._velocity.copy(g)}});Object.defineProperty(Ya.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(g){this._maxDistance=
g}});Object.defineProperty(Ya.prototype,"refDistance",{get:function(){return this._refDistance},set:function(g){this._refDistance=g}});Object.defineProperty(Ya.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(g){this._rollOffFactor=g}});Object.defineProperty(Ya.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(g){this._distanceModel=g}})}var Qa={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new A,maxDistance:0,refDistance:0,
rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null},ag=function(g){function d(a,c,e){var f=g.call(this)||this;f._component=a;f._assets=a.system.app.assets;f._manager=a.system.manager;f.name=c||"Untitled";e=e||{};f._volume=void 0!==e.volume?R.clamp(Number(e.volume)||0,0,1):1;f._pitch=void 0!==e.pitch?Math.max(.01,Number(e.pitch)||0):1;f._loop=!(void 0===e.loop||!e.loop);f._duration=0<e.duration?e.duration:null;f._startTime=Math.max(0,Number(e.startTime)||
0);f._overlap=!!e.overlap;f._autoPlay=!!e.autoPlay;f._firstNode=null;f._lastNode=null;f._asset=e.asset;f._asset instanceof fa&&(f._asset=f._asset.id);f._onInstancePlayHandler=f._onInstancePlay.bind(F(f));f._onInstancePauseHandler=f._onInstancePause.bind(F(f));f._onInstanceResumeHandler=f._onInstanceResume.bind(F(f));f._onInstanceStopHandler=f._onInstanceStop.bind(F(f));f._onInstanceEndHandler=f._onInstanceEnd.bind(F(f));f.instances=[];return f}K(d,g);var b=d.prototype;b.play=function(){this.overlap||
this.stop();if(this.isLoaded||this._hasAsset()){var a=this._createInstance();this.instances.push(a);if(this.isLoaded)a.play();else{var c=function(e){var f=a._playWhenLoaded;a.sound=e;f&&a.play()};this.off("load",c);this.once("load",c);this.load()}return a}};b.pause=function(){for(var a=!1,c=this.instances,e=0,f=c.length;e<f;e++)c[e].pause()&&(a=!0);return a};b.resume=function(){for(var a=!1,c=this.instances,e=0,f=c.length;e<f;e++)c[e].resume()&&(a=!0);return a};b.stop=function(){for(var a=!1,c=this.instances,
e=c.length;e--;)c[e].stop(),a=!0;c.length=0;return a};b.load=function(){if(this._hasAsset()){var a=this._assets.get(this._asset);a?(a.off("remove",this._onAssetRemoved,this),a.on("remove",this._onAssetRemoved,this),a.resource?this.fire("load",a.resource):(a.off("load",this._onAssetLoad,this),a.once("load",this._onAssetLoad,this),this._assets.load(a))):(this._assets.off("add:"+this._asset,this._onAssetAdd,this),this._assets.once("add:"+this._asset,this._onAssetAdd,this))}};b.setExternalNodes=function(a,
c){if(a){if(c||(c=a),this._firstNode=a,this._lastNode=c,!this._overlap)for(var e=this.instances,f=0,h=e.length;f<h;f++)e[f].setExternalNodes(a,c)}else console.error("The firstNode must have a valid AudioNode")};b.clearExternalNodes=function(){this._lastNode=this._firstNode=null;if(!this._overlap)for(var a=this.instances,c=0,e=a.length;c<e;c++)a[c].clearExternalNodes()};b.getExternalNodes=function(){return[this._firstNode,this._lastNode]};b._hasAsset=function(){return null!=this._asset};b._createInstance=
function(){var a=this._component;var c=null;if(this._hasAsset()){var e=this._assets.get(this._asset);e&&(c=e.resource)}Qa.volume=this._volume*a.volume;Qa.pitch=this._pitch*a.pitch;Qa.loop=this._loop;Qa.startTime=this._startTime;Qa.duration=this._duration;Qa.onPlay=this._onInstancePlayHandler;Qa.onPause=this._onInstancePauseHandler;Qa.onResume=this._onInstanceResumeHandler;Qa.onStop=this._onInstanceStopHandler;Qa.onEnd=this._onInstanceEndHandler;a.positional?(Qa.position.copy(a.entity.getPosition()),
Qa.maxDistance=a.maxDistance,Qa.refDistance=a.refDistance,Qa.rollOffFactor=a.rollOffFactor,Qa.distanceModel=a.distanceModel,a=new Ya(this._manager,c,Qa)):a=new ib(this._manager,c,Qa);this._firstNode&&a.setExternalNodes(this._firstNode,this._lastNode);return a};b._onInstancePlay=function(a){this.fire("play",a);this._component.fire("play",this,a)};b._onInstancePause=function(a){this.fire("pause",a);this._component.fire("pause",this,a)};b._onInstanceResume=function(a){this.fire("resume",a);this._component.fire("resume",
this,a)};b._onInstanceStop=function(a){var c=this.instances.indexOf(a);-1!==c&&this.instances.splice(c,1);this.fire("stop",a);this._component.fire("stop",this,a)};b._onInstanceEnd=function(a){var c=this.instances.indexOf(a);-1!==c&&this.instances.splice(c,1);this.fire("end",a);this._component.fire("end",this,a)};b._onAssetAdd=function(a){this.load()};b._onAssetLoad=function(a){this.load()};b._onAssetRemoved=function(a){a.off("remove",this._onAssetRemoved,this);this._assets.off("add:"+a.id,this._onAssetAdd,
this);this.stop()};b.updatePosition=function(a){for(var c=this.instances,e=0,f=c.length;e<f;e++)c[e].position=a};N(d,[{key:"volume",get:function(){return this._volume},set:function(a){this._volume=R.clamp(Number(a)||0,0,1);if(!this._overlap){a=this.instances;for(var c=0,e=a.length;c<e;c++)a[c].volume=this._volume*this._component.volume}}},{key:"pitch",get:function(){return this._pitch},set:function(a){this._pitch=Math.max(Number(a)||0,.01);if(!this._overlap){a=this.instances;for(var c=0,e=a.length;c<
e;c++)a[c].pitch=this.pitch*this._component.pitch}}},{key:"loop",get:function(){return this._loop},set:function(a){this._loop=!!a;a=this.instances;for(var c=0,e=a.length;c<e;c++)a[c].loop=this._loop}},{key:"autoPlay",get:function(){return this._autoPlay},set:function(a){this._autoPlay=!!a}},{key:"overlap",get:function(){return this._overlap},set:function(a){this._overlap=!!a}},{key:"startTime",get:function(){return this._startTime},set:function(a){this._startTime=Math.max(0,Number(a)||0);if(!this._overlap){a=
this.instances;for(var c=0,e=a.length;c<e;c++)a[c].startTime=this._startTime}}},{key:"duration",get:function(){var a=0;this._hasAsset()&&(a=this._assets.get(this._asset),a=a.resource?a.resource.duration:0);return null!=this._duration?this._duration%(a||1):a},set:function(a){this._duration=Math.max(0,Number(a)||0)||null;if(!this._overlap){a=this.instances;for(var c=0,e=a.length;c<e;c++)a[c].duration=this._duration}}},{key:"asset",get:function(){return this._asset},set:function(a){var c=this._asset;
c&&(this._assets.off("add:"+c,this._onAssetAdd,this),(c=this._assets.get(c))&&c.off("remove",this._onAssetRemoved,this));this._asset=a;this._asset instanceof fa&&(this._asset=this._asset.id);this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}},{key:"isLoaded",get:function(){if(this._hasAsset()){var a=this._assets.get(this._asset);if(a)return!!a.resource}return!1}},{key:"isPlaying",get:function(){for(var a=this.instances,c=0,e=a.length;c<e;c++)if(a[c].isPlaying)return!0;
return!1}},{key:"isPaused",get:function(){var a=this.instances,c=a.length;if(0===c)return!1;for(var e=0;e<c;e++)if(!a[e].isPaused)return!1;return!0}},{key:"isStopped",get:function(){for(var a=this.instances,c=0,e=a.length;c<e;c++)if(!a[c].isStopped)return!1;return!0}}]);return d}(ba),Sd=function(g){function d(a,c){a=g.call(this,a,c)||this;a._volume=1;a._pitch=1;a._positional=!0;a._refDistance=1;a._maxDistance=1E4;a._rollOffFactor=1;a._distanceModel="linear";a._slots={};a._playingBeforeDisable={};
return a}K(d,g);var b=d.prototype;b.onEnable=function(){if(!this.system._inTools){var a=this._slots,c=this._playingBeforeDisable,e;for(e in a){var f=a[e];f.autoPlay&&f.isStopped?f.play():c[e]?f.resume():f.isLoaded||f.load()}}};b.onDisable=function(){var a=this._slots,c={},e;for(e in a)!a[e].overlap&&a[e].isPlaying&&(a[e].pause(),c[e]=!0);this._playingBeforeDisable=c};b.onRemove=function(){this.off()};b.addSlot=function(a,c){var e=this._slots;if(e[a])return null;c=new ag(this,a,c);e[a]=c;c.autoPlay&&
this.enabled&&this.entity.enabled&&c.play();return c};b.removeSlot=function(a){var c=this._slots;c[a]&&(c[a].stop(),delete c[a])};b.slot=function(a){return this._slots[a]};b.play=function(a){return this.enabled&&this.entity.enabled?(a=this._slots[a])?a.play():null:null};b.pause=function(a){var c=this._slots;if(a)(a=c[a])&&a.pause();else for(var e in c)c[e].pause()};b.resume=function(a){var c=this._slots;if(a)(a=c[a])&&a.isPaused&&a.resume();else for(var e in c)c[e].resume()};b.stop=function(a){var c=
this._slots;if(a)(a=c[a])&&a.stop();else for(var e in c)c[e].stop()};N(d,[{key:"positional",get:function(){return this._positional},set:function(a){this._positional=a;a=this._slots;for(var c in a){var e=a[c];if(!e.overlap)for(var f=e.instances,h=f.length-1;0<=h;h--){var k=f[h].isPlaying||f[h].isSuspended,m=f[h].currentTime;k&&f[h].stop();var n=e._createInstance();k&&(n.play(),n.currentTime=m);f.push(n)}}}},{key:"slots",get:function(){return this._slots},set:function(a){var c,e=this._slots;if(e)for(c in e)e[c].stop();
e={};for(c in a)a[c]instanceof ag?e[a[c].name]=a[c]:a[c].name&&(e[a[c].name]=new ag(this,a[c].name,a[c]));this._slots=e;if(this.enabled&&this.entity.enabled)this.onEnable()}}]);return d}(ca);hj("pitch","_pitch");hj("volume","_volume");We("refDistance","_refDistance");We("maxDistance","_maxDistance");We("rollOffFactor","_rollOffFactor");We("distanceModel","_distanceModel");var lq=function(){this.enabled=!0},Bm=["enabled"],Cm=function(g){function d(a,c){a=g.call(this,a)||this;a.id="sound";a.ComponentType=
Sd;a.DataType=lq;a.schema=Bm;a.manager=c;O.bind("update",a.onUpdate,F(a));a.on("beforeremove",a.onBeforeRemove,F(a));return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c,e){e="volume pitch positional refDistance maxDistance rollOffFactor distanceModel slots".split(" ");for(var f=0;f<e.length;f++)c.hasOwnProperty(e[f])&&(a[e[f]]=c[e[f]]);g.prototype.initializeComponentData.call(this,a,c,["enabled"])};b.cloneComponent=function(a,c){a=a.sound;var e=a.slots,f={},h;for(h in e){var k=
e[h];f[h]={name:k.name,volume:k.volume,pitch:k.pitch,loop:k.loop,duration:k.duration,startTime:k.startTime,overlap:k.overlap,autoPlay:k.autoPlay,asset:k.asset}}return this.addComponent(c,{distanceModel:a.distanceModel,enabled:a.enabled,maxDistance:a.maxDistance,pitch:a.pitch,positional:a.positional,refDistance:a.refDistance,rollOffFactor:a.rollOffFactor,slots:f,volume:a.volume})};b.onUpdate=function(a){a=this.store;for(var c in a)if(a.hasOwnProperty(c)){var e=a[c].entity;if(e.enabled){var f=e.sound;
if(f.enabled&&f.positional){e=e.getPosition();f=f.slots;for(var h in f)f[h].updatePosition(e)}}}};b.onBeforeRemove=function(a,c){a=c.slots;for(var e in a)a[e].overlap||a[e].stop();c.onRemove()};N(d,[{key:"volume",get:function(){return this.manager.volume},set:function(a){this.manager.volume=a}},{key:"context",get:function(){return wb()?this.manager.context:null}}]);return d}(O);ca._buildAccessors(Sd.prototype,Bm);var bg=function(g){function d(a,c){var e=g.call(this)||this;e._component=a;e._frame=
0;e._sprite=null;e._spriteAsset=null;e.spriteAsset=c.spriteAsset;e.name=c.name;e.fps=c.fps||0;e.loop=c.loop||!1;e._playing=!1;e._paused=!1;e._time=0;return e}K(d,g);var b=d.prototype;b._onSpriteAssetAdded=function(a){this._component.system.app.assets.off("add:"+a.id,this._onSpriteAssetAdded,this);this._spriteAsset===a.id&&this._bindSpriteAsset(a)};b._bindSpriteAsset=function(a){a.on("load",this._onSpriteAssetLoad,this);a.on("remove",this._onSpriteAssetRemove,this);a.resource?this._onSpriteAssetLoad(a):
this._component.system.app.assets.load(a)};b._unbindSpriteAsset=function(a){a.off("load",this._onSpriteAssetLoad,this);a.off("remove",this._onSpriteAssetRemove,this);a.resource&&a.resource.atlas&&this._component.system.app.assets.off("load:"+a.data.textureAtlasAsset,this._onTextureAtlasLoad,this)};b._onSpriteAssetLoad=function(a){if(a.resource)if(a.resource.atlas)this.sprite=a.resource;else{a=a.data.textureAtlasAsset;var c=this._component.system.app.assets;c.off("load:"+a,this._onTextureAtlasLoad,
this);c.once("load:"+a,this._onTextureAtlasLoad,this)}else this.sprite=null};b._onTextureAtlasLoad=function(a){a=this._spriteAsset;a instanceof fa?this._onSpriteAssetLoad(a):this._onSpriteAssetLoad(this._component.system.app.assets.get(a))};b._onSpriteAssetRemove=function(a){this.sprite=null};b._onSpriteMeshesChange=function(){this._component.currentClip===this&&this._component._showFrame(this.frame)};b._onSpritePpuChanged=function(){this._component.currentClip===this&&0!==this.sprite.renderMode&&
this._component._showFrame(this.frame)};b._update=function(a){if(0!==this.fps&&this._playing&&!this._paused&&this._sprite){var c=this._time+a*this._component.speed*(0>this.fps?-1:1),e=this.duration;a=c>e||0>c;this._setTime(c);c=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/e):0;c!==this._frame&&this._setFrame(c);a&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._paused=this._playing=!1,this.fire("end"),this._component.fire("end",this)))}};b._setTime=function(a){this._time=
a;a=this.duration;0>this._time?this._time=this.loop?this._time%a+a:0:this._time>a&&(this._time=this.loop?this._time%a:a)};b._setFrame=function(a){this._frame=this._sprite?R.clamp(a,0,this._sprite.frameKeys.length-1):a;this._component.currentClip===this&&this._component._showFrame(this._frame)};b._destroy=function(){this._sprite&&(this.sprite=null);this._spriteAsset&&(this.spriteAsset=null)};b.play=function(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",
this))};b.pause=function(){this._playing&&!this._paused&&(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))};b.resume=function(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))};b.stop=function(){this._playing&&(this._paused=this._playing=!1,this.frame=this._time=0,this.fire("stop"),this._component.fire("stop",this))};N(d,[{key:"spriteAsset",get:function(){return this._spriteAsset},set:function(a){var c=this._component.system.app.assets,
e=a;a instanceof fa&&(e=a.id);this._spriteAsset!==e&&(this._spriteAsset&&(a=c.get(this._spriteAsset))&&this._unbindSpriteAsset(a),(this._spriteAsset=e)?(e=c.get(this._spriteAsset))?this._bindSpriteAsset(e):(this.sprite=null,c.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)):this.sprite=null)}},{key:"sprite",get:function(){return this._sprite},set:function(a){this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,
this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this));if(this._sprite=a)if(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas)this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this);if(this._component.currentClip===this){var c;
if(a&&a.atlas){if(a.atlas.texture){if(c=this._component._meshInstance)c.setParameter("texture_emissiveMap",a.atlas.texture),c.setParameter("texture_opacityMap",a.atlas.texture);this._component.enabled&&this._component.entity.enabled&&this._component._showModel()}this.time&&this.fps?this.time=this.time:this.frame=this.frame}else{if(c=this._component._meshInstance)c.deleteParameter("texture_emissiveMap"),c.deleteParameter("texture_opacityMap");this._component._hideModel()}}}},{key:"frame",get:function(){return this._frame},
set:function(a){this._setFrame(a);this._setTime(this._frame/(this.fps||Number.MIN_VALUE))}},{key:"isPlaying",get:function(){return this._playing}},{key:"isPaused",get:function(){return this._paused}},{key:"duration",get:function(){return this._sprite?this._sprite.frameKeys.length/Math.abs(this.fps||Number.MIN_VALUE):0}},{key:"time",get:function(){return this._time},set:function(a){this._setTime(a);this.frame=this._sprite?Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):
0}}]);return d}(ba),pi=function(g){function d(a,c){var e=g.call(this,a,c)||this;e._type="simple";e._material=a.defaultMaterial;e._color=new Q(1,1,1,1);e._colorUniform=new Float32Array(3);e._speed=1;e._flipX=!1;e._flipY=!1;e._width=1;e._height=1;e._drawOrder=0;e._layers=[0];e._outerScale=new S(1,1);e._outerScaleUniform=new Float32Array(2);e._innerOffset=new Z;e._innerOffsetUniform=new Float32Array(4);e._atlasRect=new Z;e._atlasRectUniform=new Float32Array(4);e._batchGroupId=-1;e._batchGroup=null;e._node=
new pa;e._model=new fb;e._model.graph=e._node;e._meshInstance=null;c.addChild(e._model.graph);e._model._entity=c;e._updateAabbFunc=e._updateAabb.bind(F(e));e._addedModel=!1;e._autoPlayClip=null;e._clips={};e._defaultClip=new bg(F(e),{name:e.entity.name,fps:0,loop:!1,spriteAsset:null});e._currentClip=e._defaultClip;return e}K(d,g);var b=d.prototype;b.onEnable=function(){var a=this.system.app,c=a.scene;c.on("set:layers",this._onLayersChanged,this);c.layers&&(c.layers.on("add",this._onLayerAdded,this),
c.layers.on("remove",this._onLayerRemoved,this));this._showModel();this._autoPlayClip&&this._tryAutoPlay();0<=this._batchGroupId&&a.batcher.insert(Da.SPRITE,this._batchGroupId,this.entity)};b.onDisable=function(){var a=this.system.app,c=a.scene;c.off("set:layers",this._onLayersChanged,this);c.layers&&(c.layers.off("add",this._onLayerAdded,this),c.layers.off("remove",this._onLayerRemoved,this));this.stop();this._hideModel();0<=this._batchGroupId&&a.batcher.remove(Da.SPRITE,this._batchGroupId,this.entity)};
b.onDestroy=function(){this._currentClip=null;this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null);for(var a in this._clips)this._clips[a]._destroy();this._clips=null;this._hideModel();this._model=null;this._node&&(this._node.parent&&this._node.parent.removeChild(this._node),this._node=null);this._meshInstance&&(this._meshInstance.material=null,this._meshInstance=this._meshInstance.mesh=null)};b._showModel=function(){if(!this._addedModel&&this._meshInstance){var a,c=[this._meshInstance];
var e=0;for(a=this._layers.length;e<a;e++){var f=this.system.app.scene.layers.getLayerById(this._layers[e]);f&&f.addMeshInstances(c)}this._addedModel=!0}};b._hideModel=function(){if(this._addedModel&&this._meshInstance){var a,c=[this._meshInstance];var e=0;for(a=this._layers.length;e<a;e++){var f=this.system.app.scene.layers.getLayerById(this._layers[e]);f&&f.removeMeshInstances(c)}this._addedModel=!1}};b._showFrame=function(a){if(this.sprite){var c=this.sprite.meshes[a];if(c){var e=1===this.sprite.renderMode?
this.system.default9SlicedMaterialSlicedMode:2===this.sprite.renderMode?this.system.default9SlicedMaterialTiledMode:this.system.defaultMaterial;this._meshInstance||(this._meshInstance=new Ga(this._node,c,this._material),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",
this._colorUniform),this._meshInstance.setParameter("material_opacity",this._color.a),this.enabled&&this.entity.enabled&&this._showModel());this._meshInstance.material!==e&&(this._meshInstance.material=e);this._meshInstance.mesh!==c&&(this._meshInstance.mesh=c,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1);this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter("texture_emissiveMap",this.sprite.atlas.texture),this._meshInstance.setParameter("texture_opacityMap",
this.sprite.atlas.texture)):(this._meshInstance.deleteParameter("texture_emissiveMap"),this._meshInstance.deleteParameter("texture_opacityMap"));!this.sprite.atlas||1!==this.sprite.renderMode&&2!==this.sprite.renderMode?this._meshInstance._updateAabbFunc=null:(this._meshInstance._updateAabbFunc=this._updateAabbFunc,(a=this.sprite.atlas.frames[this.sprite.frameKeys[a]])?(c=2/a.rect.z,e=2/a.rect.w,this._innerOffset.set(a.border.x*c,a.border.y*e,a.border.z*c,a.border.w*e),c=this.sprite.atlas.texture,
this._atlasRect.set(a.rect.x/c.width,a.rect.y/c.height,a.rect.z/c.width,a.rect.w/c.height)):this._innerOffset.set(0,0,0,0),this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=
this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform));this._updateTransform()}else this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1)}};b._updateTransform=function(){var a=this.flipX?-1:1,c=this.flipY?-1:1,e=0,f=0;if(this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){var h=1,k=1;if(this.sprite.atlas){var m=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];m&&(h=
m.rect.z,k=m.rect.w,e=(.5-m.pivot.x)*this._width,f=(.5-m.pivot.y)*this._height)}h/=this.sprite.pixelsPerUnit;k/=this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*h),Math.max(this._height,this._innerOffset.y*k));c*=k;this._outerScale.x/=h;this._outerScale.y/=k;a=a*h*R.clamp(this._width/(this._innerOffset.x*h),1E-4,1);c*=R.clamp(this._height/(this._innerOffset.y*k),1E-4,1);this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=
this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform))}this._node.setLocalScale(a,c,1);this._node.setLocalPosition(e,f,0)};b._updateAabb=function(a){a.center.set(0,0,0);a.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001);a.setFromTransformedAabb(a,this._node.getWorldTransform());return a};b._tryAutoPlay=function(){if(this._autoPlayClip&&"animated"===this.type){var a=this._clips[this._autoPlayClip];!a||a.isPlaying||this._currentClip&&this._currentClip.isPlaying||
this.enabled&&this.entity.enabled&&this.play(a.name)}};b._onLayersChanged=function(a,c){a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);c.on("add",this.onLayerAdded,this);c.on("remove",this.onLayerRemoved,this);this.enabled&&this.entity.enabled&&this._showModel()};b._onLayerAdded=function(a){0>this.layers.indexOf(a.id)||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&a.addMeshInstances([this._meshInstance])};b._onLayerRemoved=function(a){this._meshInstance&&
(0>this.layers.indexOf(a.id)||a.removeMeshInstances([this._meshInstance]))};b.removeModelFromLayers=function(){for(var a,c=0;c<this.layers.length;c++)(a=this.system.app.scene.layers.getLayerById(this.layers[c]))&&a.removeMeshInstances([this._meshInstance])};b.addClip=function(a){var c=new bg(this,{name:a.name,fps:a.fps,loop:a.loop,spriteAsset:a.spriteAsset});this._clips[a.name]=c;c.name&&c.name===this._autoPlayClip&&this._tryAutoPlay();return c};b.removeClip=function(a){delete this._clips[a]};b.clip=
function(a){return this._clips[a]};b.play=function(a){a=this._clips[a];var c=this._currentClip;c&&c!==a&&(c._playing=!1);if(this._currentClip=a)this._currentClip=a,this._currentClip.play();return a};b.pause=function(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()};b.resume=function(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()};b.stop=function(){this._currentClip!==this._defaultClip&&this._currentClip.stop()};
N(d,[{key:"type",get:function(){return this._type},set:function(a){this._type!==a&&(this._type=a,"simple"===this._type?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):"animated"===this._type&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}},
{key:"frame",get:function(){return this._currentClip.frame},set:function(a){this._currentClip.frame=a}},{key:"spriteAsset",get:function(){return this._defaultClip._spriteAsset},set:function(a){this._defaultClip.spriteAsset=a}},{key:"sprite",get:function(){return this._currentClip.sprite},set:function(a){this._currentClip.sprite=a}},{key:"material",get:function(){return this._material},set:function(a){this._material=a;this._meshInstance&&(this._meshInstance.material=a)}},{key:"color",get:function(){return this._color},
set:function(a){this._color.r=a.r;this._color.g=a.g;this._color.b=a.b;this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform))}},{key:"opacity",get:function(){return this._color.a},set:function(a){this._color.a=a;this._meshInstance&&this._meshInstance.setParameter("material_opacity",a)}},{key:"clips",get:function(){return this._clips},set:function(a){var c,
e;if(a){for(c in this._clips){var f=!1;for(e in a)if(a[e].name===c){f=!0;this._clips[c].fps=a[e].fps;this._clips[c].loop=a[e].loop;a[e].hasOwnProperty("sprite")?this._clips[c].sprite=a[e].sprite:a[e].hasOwnProperty("spriteAsset")&&(this._clips[c].spriteAsset=a[e].spriteAsset);break}f||this.removeClip(c)}for(e in a)this._clips[a[e].name]||this.addClip(a[e]);this._autoPlayClip&&this._tryAutoPlay();this._currentClip&&this._currentClip.sprite||this._hideModel()}else for(c in this._clips)this.removeClip(c)}},
{key:"currentClip",get:function(){return this._currentClip}},{key:"speed",get:function(){return this._speed},set:function(a){this._speed=a}},{key:"flipX",get:function(){return this._flipX},set:function(a){this._flipX!==a&&(this._flipX=a,this._updateTransform())}},{key:"flipY",get:function(){return this._flipY},set:function(a){this._flipY!==a&&(this._flipY=a,this._updateTransform())}},{key:"width",get:function(){return this._width},set:function(a){a!==this._width&&(this._width=a,this._outerScale.x=
this._width,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}},{key:"height",get:function(){return this._height},set:function(a){a!==this._height&&(this._height=a,this._outerScale.y=this.height,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}},{key:"batchGroupId",get:function(){return this._batchGroupId},set:function(a){if(this._batchGroupId!==a){var c=this._batchGroupId;this._batchGroupId=a;this.entity.enabled&&
0<=c&&this.system.app.batcher.remove(Da.SPRITE,c,this.entity);this.entity.enabled&&0<=a?this.system.app.batcher.insert(Da.SPRITE,a,this.entity):0<=c&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}}},{key:"autoPlayClip",get:function(){return this._autoPlayClip},set:function(a){this._autoPlayClip=a instanceof bg?a.name:a;this._tryAutoPlay()}},{key:"drawOrder",get:function(){return this._drawOrder},set:function(a){this._drawOrder=a;this._meshInstance&&
(this._meshInstance.drawOrder=a)}},{key:"layers",get:function(){return this._layers},set:function(a){this._addedModel&&this._hideModel();this._layers=a;this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}},{key:"aabb",get:function(){return this._meshInstance?this._meshInstance.aabb:null}}]);return d}(ca),mq=function(){this.enabled=!0},Dm=["enabled"],Em=function(g){function d(a){a=g.call(this,a)||this;a.id="sprite";a.ComponentType=pi;a.DataType=mq;a.schema=Dm;a._defaultTexture=
null;a._defaultMaterial=null;a._default9SlicedMaterialSlicedMode=null;a._default9SlicedMaterialTiledMode=null;O.bind("update",a.onUpdate,F(a));a.on("beforeremove",a.onBeforeRemove,F(a));return a}K(d,g);var b=d.prototype;b.destroy=function(){this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)};b.initializeComponentData=function(a,c,e){void 0!==c.enabled&&(a.enabled=c.enabled);a.type=c.type;c.layers&&Array.isArray(c.layers)&&(a.layers=c.layers.slice(0));void 0!==c.drawOrder&&
(a.drawOrder=c.drawOrder);void 0!==c.color&&(c.color instanceof Q?a.color.set(c.color.r,c.color.g,c.color.b,void 0!==c.opacity?c.opacity:1):a.color.set(c.color[0],c.color[1],c.color[2],void 0!==c.opacity?c.opacity:1),a.color=a.color);void 0!==c.opacity&&(a.opacity=c.opacity);void 0!==c.flipX&&(a.flipX=c.flipX);void 0!==c.flipY&&(a.flipY=c.flipY);void 0!==c.width&&(a.width=c.width);void 0!==c.height&&(a.height=c.height);void 0!==c.spriteAsset&&(a.spriteAsset=c.spriteAsset);c.sprite&&(a.sprite=c.sprite);
void 0!==c.frame&&(a.frame=c.frame);if(c.clips)for(var f in c.clips)a.addClip(c.clips[f]);void 0!==c.speed&&(a.speed=c.speed);c.autoPlayClip&&(a.autoPlayClip=c.autoPlayClip);a.batchGroupId=void 0===c.batchGroupId||null===c.batchGroupId?-1:c.batchGroupId;g.prototype.initializeComponentData.call(this,a,c,e)};b.cloneComponent=function(a,c){a=a.sprite;return this.addComponent(c,{enabled:a.enabled,type:a.type,spriteAsset:a.spriteAsset,sprite:a.sprite,frame:a.frame,color:a.color.clone(),opacity:a.opacity,
flipX:a.flipX,flipY:a.flipY,speed:a.speed,clips:a.clips,autoPlayClip:a.autoPlayClip,batchGroupId:a.batchGroupId,drawOrder:a.drawOrder,layers:a.layers.slice(0)})};b.onUpdate=function(a){var c=this.store,e;for(e in c)if(c.hasOwnProperty(e)){var f=c[e];f.data.enabled&&f.entity.enabled&&(f=f.entity.sprite,f._currentClip&&f._currentClip._update(a))}};b.onBeforeRemove=function(a,c){c.onDestroy()};N(d,[{key:"defaultMaterial",get:function(){if(!this._defaultMaterial){var a=new X(this.app.graphicsDevice,{width:1,
height:1,format:7}),c=new Uint8Array(a.lock());c[0]=c[1]=c[2]=c[3]=255;a.name="sprite";a.unlock();c=new ma;c.diffuse.set(0,0,0);c.emissive.set(.5,.5,.5);c.emissiveMap=a;c.emissiveMapTint=!0;c.opacityMap=a;c.opacityMapChannel="a";c.opacityTint=!0;c.opacity=0;c.useLighting=!1;c.useGammaTonemap=!1;c.useFog=!1;c.useSkybox=!1;c.blendType=4;c.depthWrite=!1;c.pixelSnap=!1;c.cull=0;c.update();this._defaultTexture=a;this._defaultMaterial=c}return this._defaultMaterial},set:function(a){this._defaultMaterial=
a}},{key:"default9SlicedMaterialSlicedMode",get:function(){if(!this._default9SlicedMaterialSlicedMode){var a=this.defaultMaterial.clone();a.nineSlicedMode=1;a.update();this._default9SlicedMaterialSlicedMode=a}return this._default9SlicedMaterialSlicedMode},set:function(a){this._default9SlicedMaterialSlicedMode=a}},{key:"default9SlicedMaterialTiledMode",get:function(){if(!this._default9SlicedMaterialTiledMode){var a=this.defaultMaterial.clone();a.nineSlicedMode=2;a.update();this._default9SlicedMaterialTiledMode=
a}return this._default9SlicedMaterialTiledMode},set:function(a){this._default9SlicedMaterialTiledMode=a}}]);return d}(O);ca._buildAccessors(pi.prototype,Dm);var qi=function(g){function d(a,c){a=g.call(this,a,c)||this;a._oldState=!0;a._size=new A;a.on("set_enabled",a._onSetEnabled,F(a));return a}K(d,g);var b=d.prototype;b.onEnable=function(){this._checkState()};b.onDisable=function(){this._checkState()};b._onSetEnabled=function(a,c,e){this._checkState()};b._checkState=function(){var a=this.enabled&&
this.entity.enabled;a!==this._oldState&&(this._oldState=a,this.fire("enable"),this.fire("state",this.enabled))};b._onBeforeRemove=function(){this.fire("remove")};N(d,[{key:"size",set:function(a){a instanceof A?this._size.copy(a):a instanceof Array&&3<=a.length&&this.size.set(a[0],a[1],a[2])},get:function(){return this._size}}]);return d}(ca),nq=function(){this.enabled=!0},Fm=["enabled"],Gm=function(g){function d(a){a=g.call(this,a)||this;a.id="zone";a.ComponentType=qi;a.DataType=nq;a.schema=Fm;a.on("beforeremove",
a._onBeforeRemove,F(a));return a}K(d,g);var b=d.prototype;b.initializeComponentData=function(a,c,e){a.enabled=c.hasOwnProperty("enabled")?!!c.enabled:!0;c.size&&(c.size instanceof A?a.size.copy(c.size):c.size instanceof Array&&3<=c.size.length&&a.size.set(c.size[0],c.size[1],c.size[2]))};b.cloneComponent=function(a,c){return this.addComponent(c,{size:a.zone.size})};b._onBeforeRemove=function(a,c){c._onBeforeRemove()};return d}(O);ca._buildAccessors(qi.prototype,Fm);var oq=function(){function g(d){this.frame=
{fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,_timeToCountFrames:0,_fpsAccum:0};this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0};this.misc={renderTargetCreationTime:0};this.particles={updatesPerFrame:0,
_updatesPerFrame:0,frameTime:0,_frameTime:0};this.shaders=d._shaderStats;this.vram=d._vram;Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}});Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}N(g,[{key:"scene",get:function(){return qa.getApplication().scene._stats}},{key:"lightmapper",get:function(){return qa.getApplication().lightmapper._stats}},{key:"batcher",get:function(){return qa.getApplication().batcher._stats}}]);return g}(),
Hm=function(g,d){this.name=g;this.url=d},Im=function(){function g(b){this._app=b;this._list=[];this._index={};this._urlIndex={}}var d=g.prototype;d.destroy=function(){this._app=null};d.list=function(){return this._list};d.add=function(b,a){if(this._index.hasOwnProperty(b))return!1;b=new Hm(b,a);a=this._list.push(b);this._index[b.name]=a-1;this._urlIndex[b.url]=a-1;return!0};d.find=function(b){return this._index.hasOwnProperty(b)?this._list[this._index[b]]:null};d.findByUrl=function(b){return this._urlIndex.hasOwnProperty(b)?
this._list[this._urlIndex[b]]:null};d.remove=function(b){if(this._index.hasOwnProperty(b)){var a=this._index[b],c=this._list[a];delete this._urlIndex[c.url];delete this._index[b];this._list.splice(a,1);for(a=0;a<this._list.length;a++)c=this._list[a],this._index[c.name]=a,this._urlIndex[c.url]=a}};d.loadSceneHierarchy=function(b,a){var c=this,e=this._app.loader.getHandler("hierarchy");this._app.assets&&this._app.assets.prefix&&!wd.test(b)&&(b=da.join(this._app.assets.prefix,b));e.load(b,function(f,
h){f?a&&a(f):c._app._preloadScripts(h,function(){c._app.systems.script.preloading=!0;var k=e.open(b,h);c._app.systems.script.preloading=!1;c._app.loader.clearCache(b,"hierarchy");c._app.root.addChild(k);O.initialize(k);O.postInitialize(k);a&&a(f,k)})})};d.loadSceneSettings=function(b,a){var c=this;this._app.assets&&this._app.assets.prefix&&!wd.test(b)&&(b=da.join(this._app.assets.prefix,b));this._app.loader.load(b,"scenesettings",function(e,f){e?a&&a(e):(c._app.applySceneSettings(f),a&&a(null))})};
d.loadScene=function(b,a){var c=this,e=this._app.loader.getHandler("scene");this._app.assets&&this._app.assets.prefix&&!wd.test(b)&&(b=da.join(this._app.assets.prefix,b));e.load(b,function(f,h){f?a&&a(f):c._app._preloadScripts(h,function(){c._app.systems.script.preloading=!0;var k=e.open(b,h);c._app.systems.script.preloading=!1;c._app.loader.clearCache(b,"scene");c._app.loader.patch({resource:k,type:"scene"},c._app.assets);c._app.root.addChild(k.root);c._app.systems.rigidbody&&"undefined"!==typeof Ammo&&
c._app.systems.rigidbody.gravity.set(k._gravity.x,k._gravity.y,k._gravity.z);a&&a(null,k)})})};return g}(),Jm=function(){function g(b){this.length=b;this.count=0}var d=g.prototype;d.inc=function(){this.count++};d.done=function(){return this.count===this.length};return g}(),Hd=!1,rc=new pa;q.app=null;var qa=function(g){function d(a,c){void 0===c&&(c={});var e=g.call(this)||this;console.log("Powered by PlayCanvas 1.38.0 98cb89e");d._applications[a.id]=F(e);d._currentApplication=F(e);q.app=F(e);e._time=
0;e.timeScale=1;e.maxDeltaTime=.1;e.frame=0;e.autoRender=!0;e.renderNextFrame=!1;e.useLegacyScriptAttributeCloning=Va.legacy;e._librariesLoaded=!1;e._fillMode="KEEP_ASPECT";e._resolutionMode="FIXED";e._allowResize=!0;e.context=F(e);c.graphicsDeviceOptions||(c.graphicsDeviceOptions={});c.graphicsDeviceOptions.xrCompatible=!0;c.graphicsDeviceOptions.alpha=c.graphicsDeviceOptions.alpha||!1;e.graphicsDevice=new Ae(a,c.graphicsDeviceOptions);e.stats=new oq(e.graphicsDevice);e._soundManager=new vd(c);e.loader=
new Nk(F(e));e._entityIndex={};e.scene=new mh;e.root=new Ba(F(e));e.root._enabledInHierarchy=!0;e._enableList=[];e._enableList.size=0;e.assets=new Dh(e.loader);c.assetPrefix&&(e.assets.prefix=c.assetPrefix);e.bundles=new gl(e.assets);e.enableBundles="undefined"!==typeof TextDecoder;e.scriptsOrder=c.scriptsOrder||[];e.scripts=new hl(F(e));e.i18n=new rh(F(e));e.scenes=new Im(F(e));var f=F(e);e.defaultLayerWorld=new nb({name:"World",id:0});e.graphicsDevice.webgl2?(e.defaultLayerDepth=new nb({enabled:!1,
name:"Depth",id:1,onEnable:function(){if(!this.renderTarget){var h=new X(f.graphicsDevice,{format:17,width:f.graphicsDevice.width,height:f.graphicsDevice.height});h.name="rt-depth2";h.minFilter=0;h.magFilter=0;h.addressU=1;h.addressV=1;this.renderTarget=new va({colorBuffer:null,depthBuffer:h,autoResolve:!1});f.graphicsDevice.scope.resolve("uDepthMap").setValue(h)}},onDisable:function(){this.renderTarget&&(this.renderTarget._depthBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},
onPreRenderOpaque:function(h){var k=f.graphicsDevice.gl;this.srcFbo=k.getParameter(k.FRAMEBUFFER_BINDING);this.renderTarget&&this.renderTarget.width===f.graphicsDevice.width&&this.renderTarget.height===f.graphicsDevice.height||(this.onDisable(),this.onEnable());this.oldClear=this.cameras[h].camera._clearOptions;this.cameras[h].camera._clearOptions=this.depthClearOptions},onPostRenderOpaque:function(h){this.renderTarget&&(this.cameras[h].camera._clearOptions=this.oldClear,h=f.graphicsDevice.gl,f.graphicsDevice.setRenderTarget(this.renderTarget),
f.graphicsDevice.updateBegin(),h.bindFramebuffer(h.READ_FRAMEBUFFER,this.srcFbo),h.bindFramebuffer(h.DRAW_FRAMEBUFFER,this.renderTarget._glFrameBuffer),h.blitFramebuffer(0,0,this.renderTarget.width,this.renderTarget.height,0,0,this.renderTarget.width,this.renderTarget.height,h.DEPTH_BUFFER_BIT,h.NEAREST))}}),e.defaultLayerDepth.depthClearOptions={flags:0}):(e.defaultLayerDepth=new nb({enabled:!1,name:"Depth",id:1,shaderPass:2,onEnable:function(){if(!this.renderTarget){var h=new X(f.graphicsDevice,
{format:7,width:f.graphicsDevice.width,height:f.graphicsDevice.height});h.name="rt-depth1";h.minFilter=0;h.magFilter=0;h.addressU=1;h.addressV=1;this.renderTarget=new va(f.graphicsDevice,h,{depth:!0,stencil:f.graphicsDevice.supportsStencil});f.graphicsDevice.scope.resolve("uDepthMap").setValue(h)}},onDisable:function(){this.renderTarget&&(this.renderTarget._colorBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onPostCull:function(h){var k=this.instances.visibleOpaque[h],m=k.list,
n=0,p=f.scene.layers.layerList,t=f.scene.layers.subLayerEnabled,r=f.scene.layers.subLayerList,u=f.scene.layers.getLayerById(0).renderTarget;h=this.cameras[h];for(var v,w,y,x,z=0;z<p.length;z++){v=p[z];if(v===this)break;if(v.renderTarget===u&&v.enabled&&t[z]&&(w=v.cameras.indexOf(h),!(0>w)))for(w=(y=r[z])?v.instances.visibleTransparent[w]:v.instances.visibleOpaque[w],y=w.length,w=w.list,v=0;v<y;v++)x=w[v],x.material&&x.material.depthWrite&&!x._noDepthDrawGl1&&(m[n]=x,n++)}k.length=n},onPreRenderOpaque:function(h){this.renderTarget&&
this.renderTarget.width===f.graphicsDevice.width&&this.renderTarget.height===f.graphicsDevice.height||(this.onDisable(),this.onEnable());this.oldClear=this.cameras[h].camera._clearOptions;this.cameras[h].camera._clearOptions=this.rgbaDepthClearOptions},onDrawCall:function(){f.graphicsDevice.setColorWrite(!0,!0,!0,!0)},onPostRenderOpaque:function(h){this.renderTarget&&(this.cameras[h].camera._clearOptions=this.oldClear)}}),e.defaultLayerDepth.rgbaDepthClearOptions={color:[254/255,254/255,254/255,254/
255],depth:1,flags:3});e.defaultLayerSkybox=new nb({enabled:!1,name:"Skybox",id:2,opaqueSortMode:0});e.defaultLayerUi=new nb({enabled:!0,name:"UI",id:4,transparentSortMode:1,passThrough:!1});e.defaultLayerImmediate=new nb({enabled:!0,name:"Immediate",id:3,opaqueSortMode:0,passThrough:!0});e.defaultLayerComposition=new yf;e.defaultLayerComposition.pushOpaque(e.defaultLayerWorld);e.defaultLayerComposition.pushOpaque(e.defaultLayerDepth);e.defaultLayerComposition.pushOpaque(e.defaultLayerSkybox);e.defaultLayerComposition.pushTransparent(e.defaultLayerWorld);
e.defaultLayerComposition.pushOpaque(e.defaultLayerImmediate);e.defaultLayerComposition.pushTransparent(e.defaultLayerImmediate);e.defaultLayerComposition.pushTransparent(e.defaultLayerUi);e.scene.layers=e.defaultLayerComposition;e._immediateLayer=e.defaultLayerImmediate;e.scene.on("set:layers",function(h,k){h=k.layerList;for(var m=0;m<h.length;m++)switch(k=h[m],k.id){case 1:k.onEnable=f.defaultLayerDepth.onEnable;k.onDisable=f.defaultLayerDepth.onDisable;k.onPreRenderOpaque=f.defaultLayerDepth.onPreRenderOpaque;
k.onPostRenderOpaque=f.defaultLayerDepth.onPostRenderOpaque;k.depthClearOptions=f.defaultLayerDepth.depthClearOptions;k.rgbaDepthClearOptions=f.defaultLayerDepth.rgbaDepthClearOptions;k.shaderPass=f.defaultLayerDepth.shaderPass;k.onPostCull=f.defaultLayerDepth.onPostCull;k.onDrawCall=f.defaultLayerDepth.onDrawCall;break;case 4:k.passThrough=f.defaultLayerUi.passThrough;break;case 3:k.passThrough=f.defaultLayerImmediate.passThrough}});e.renderer=new hh(e.graphicsDevice);e.renderer.scene=e.scene;e.lightmapper=
new Zj(e.graphicsDevice,e.root,e.scene,e.renderer,e.assets);e.once("prerender",e._firstBake,F(e));e.batcher=new Ej(e.graphicsDevice,e.root,e.scene);e.once("prerender",e._firstBatch,F(e));e.keyboard=c.keyboard||null;e.mouse=c.mouse||null;e.touch=c.touch||null;e.gamepads=c.gamepads||null;e.elementInput=c.elementInput||null;e.elementInput&&(e.elementInput.app=F(e));e.vr=null;e.xr=new Al(F(e));e.elementInput&&e.elementInput.attachSelectEvents();e._inTools=!1;e._skyboxLast=0;e._scriptPrefix=c.scriptPrefix||
"";e.enableBundles&&e.loader.addHandler("bundle",new yk(e.assets));e.loader.addHandler("animation",new sk);e.loader.addHandler("animclip",new tk);e.loader.addHandler("animstategraph",new uk);e.loader.addHandler("model",new Lk(e.graphicsDevice,e.scene.defaultMaterial));e.loader.addHandler("render",new Mk(e.assets));e.loader.addHandler("material",new Kk(F(e)));e.loader.addHandler("texture",new fl(e.graphicsDevice,e.assets,e.loader));e.loader.addHandler("text",new Wk);e.loader.addHandler("json",new Ik);
e.loader.addHandler("audio",new vk(e._soundManager));e.loader.addHandler("script",new Td(F(e)));e.loader.addHandler("scene",new Ok(F(e)));e.loader.addHandler("cubemap",new Ck(e.graphicsDevice,e.assets,e.loader));e.loader.addHandler("html",new Hk);e.loader.addHandler("css",new Bk);e.loader.addHandler("shader",new Rk);e.loader.addHandler("hierarchy",new Gk(F(e)));e.loader.addHandler("scenesettings",new Pk(F(e)));e.loader.addHandler("folder",new Dk);e.loader.addHandler("font",new Ek(e.loader));e.loader.addHandler("binary",
new wk);e.loader.addHandler("textureatlas",new Yk(e.loader));e.loader.addHandler("sprite",new Tk(e.assets,e.graphicsDevice));e.loader.addHandler("template",new Vk(F(e)));e.loader.addHandler("container",new Ak(e.graphicsDevice,e.scene.defaultMaterial));e.systems=new Tl;e.systems.add(new ei(F(e)));e.systems.add(new Sl(F(e)));e.systems.add(new Dl(F(e)));e.systems.add(new Il(F(e)));e.systems.add(new jm(F(e)));e.systems.add(new Zp(F(e)));e.systems.add(new Pl(F(e)));e.systems.add(new hm(F(e)));Va.legacy?
e.systems.add(new wm(F(e))):e.systems.add(new um(F(e)));e.systems.add(new Ml(F(e),e._soundManager));e.systems.add(new Cm(F(e),e._soundManager));e.systems.add(new Kl(F(e),e._soundManager));e.systems.add(new mm(F(e)));e.systems.add(new tm(F(e)));e.systems.add(new $l(F(e)));e.systems.add(new Nl(F(e)));e.systems.add(new zm(F(e)));e.systems.add(new Am(F(e)));e.systems.add(new Em(F(e)));e.systems.add(new em(F(e)));e.systems.add(new bm(F(e)));e.systems.add(new Gm(F(e)));e._visibilityChangeHandler=e.onVisibilityChange.bind(F(e));
"undefined"!==typeof document&&(void 0!==document.hidden?(e._hiddenAttr="hidden",document.addEventListener("visibilitychange",e._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(e._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",e._visibilityChangeHandler,!1)):void 0!==document.msHidden?(e._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",e._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(e._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",
e._visibilityChangeHandler,!1)));e.meshInstanceArray=[];e.tick=pq(F(e));return e}K(d,g);d.getApplication=function(a){return a?d._applications[a]:d._currentApplication};var b=d.prototype;b.configure=function(a,c){var e=this;oa.get(a,function(f,h){if(f)c(f);else{var k=h.scenes,m=h.assets;e._parseApplicationProperties(h.application_properties,function(n){e._parseScenes(k);e._parseAssets(m);n?c(n):c(null)})}})};b.preload=function(a){var c=this,e;c.fire("preload:start");var f=this.assets.list({preload:!0}),
h=new Jm(f.length),k=!1,m=function(){c.graphicsDevice&&!k&&h.done()&&(k=!0,c.fire("preload:end"),a())};var n=f.length;if(h.length){var p=function(r){h.inc();c.fire("preload:progress",h.count/n);h.done()&&m()},t=function(r,u){h.inc();c.fire("preload:progress",h.count/n);h.done()&&m()};for(e=0;e<f.length;e++)f[e].loaded?(h.inc(),c.fire("preload:progress",h.count/n),h.done()&&m()):(f[e].once("load",p),f[e].once("error",t),this.assets.load(f[e]))}else m()};b._preloadScripts=function(a,c){if(Va.legacy){var e=
this;e.systems.script.preloading=!0;a=this._getScriptReferences(a);var f=0,h=a.length,k=new Jm(h),m=/^http(s)?:\/\//;if(h){var n=function(t,r){t&&console.error(t);k.inc();k.done()&&(e.systems.script.preloading=!1,c())};for(f=0;f<h;f++){var p=a[f];!m.test(p.toLowerCase())&&e._scriptPrefix&&(p=da.join(e._scriptPrefix,a[f]));this.loader.load(p,"script",n)}}else e.systems.script.preloading=!1,c()}else c()};b._parseApplicationProperties=function(a,c){"number"===typeof a.maxAssetRetries&&0<a.maxAssetRetries&&
this.loader.enableRetry(a.maxAssetRetries);a.useDevicePixelRatio||(a.useDevicePixelRatio=a.use_device_pixel_ratio);a.resolutionMode||(a.resolutionMode=a.resolution_mode);a.fillMode||(a.fillMode=a.fill_mode);this._width=a.width;this._height=a.height;a.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio);this.setCanvasResolution(a.resolutionMode,this._width,this._height);this.setCanvasFillMode(a.fillMode,this._width,this._height);if(a.layers&&a.layerOrder){var e=new yf,f=
{};for(k in a.layers){var h=a.layers[k];h.id=parseInt(k,10);h.enabled=1!==h.id;f[k]=new nb(h)}var k=0;for(h=a.layerOrder.length;k<h;k++){var m=a.layerOrder[k],n=f[m.layer];n&&(m.transparent?e.pushTransparent(n):e.pushOpaque(n),e.subLayerEnabled[k]=m.enabled)}this.scene.layers=e}if(a.batchGroups)for(k=0,h=a.batchGroups.length;k<h;k++)e=a.batchGroups[k],this.batcher.addGroup(e.name,e.dynamic,e.maxAabbSize,e.id,e.layers);a.i18nAssets&&(this.i18n.assets=a.i18nAssets);this._loadLibraries(a.libraries,c)};
b._loadLibraries=function(a,c){var e=a.length,f=e,h=this,k=/^http(s)?:\/\//;if(e)for(var m=function(t,r){f--;t?c(t):0===f&&(h.onLibrariesLoaded(),c(null))},n=0;n<e;++n){var p=a[n];!k.test(p.toLowerCase())&&h._scriptPrefix&&(p=da.join(h._scriptPrefix,p));this.loader.load(p,"script",m)}else h.onLibrariesLoaded(),c(null)};b._parseScenes=function(a){if(a)for(var c=0;c<a.length;c++)this.scenes.add(a[c].name,a[c].url)};b._parseAssets=function(a){var c,e=[],f={},h={};if(Va.legacy){if(this.enableBundles)for(k in a)"bundle"===
a[k].type&&(h[k]=!0,e.push(a[k]));for(k in a)h[k]||e.push(a[k])}else{for(c=0;c<this.scriptsOrder.length;c++){var k=this.scriptsOrder[c];a[k]&&(f[k]=!0,e.push(a[k]))}if(this.enableBundles)for(k in a)"bundle"===a[k].type&&(h[k]=!0,e.push(a[k]));for(k in a)f[k]||h[k]||e.push(a[k])}for(c=0;c<e.length;c++){a=e[c];k=new fa(a.name,a.type,a.file,a.data);k.id=parseInt(a.id,10);k.preload=a.preload?a.preload:!1;k.loaded="script"===a.type&&a.data&&0<a.data.loadingType;k.tags.add(a.tags);if(a.i18n)for(var m in a.i18n)k.addLocalizedAssetId(m,
a.i18n[m]);this.assets.add(k)}};b._getScriptReferences=function(a){var c,e,f=[];a.settings.priority_scripts&&(f=a.settings.priority_scripts);var h=[],k={};for(c=0;c<f.length;c++)h.push(f[c]),k[f[c]]=!0;a=a.entities;for(e in a)if(a[e].components.script)for(f=a[e].components.script.scripts,c=0;c<f.length;c++)k[f[c].url]||(h.push(f[c].url),k[f[c].url]=!0);return h};b.start=function(){this.frame=0;this.fire("start",{timestamp:eb(),target:this});if(!this._librariesLoaded)this.onLibrariesLoaded();O.initialize(this.root);
this.fire("initialize");O.postInitialize(this.root);this.fire("postinitialize");this.tick()};b.update=function(a){this.frame++;this.graphicsDevice.updateClientRect();this.vr&&this.vr.poll();Va.legacy&&O.fixedUpdate(1/60,this._inTools);O.update(a,this._inTools);O.animationUpdate(a,this._inTools);O.postUpdate(a,this._inTools);this.fire("update",a);this.controller&&this.controller.update(a);this.mouse&&this.mouse.update(a);this.keyboard&&this.keyboard.update(a);this.gamepads&&this.gamepads.update(a)};
b.render=function(){this.fire("prerender");this.root.syncHierarchy();this.batcher.updateAll();this.renderer.renderComposition(this.scene.layers);this.fire("postrender")};b._fillFrameStatsBasic=function(a,c,e){var f=this.stats.frame;f.dt=c;f.ms=e;a>f._timeToCountFrames?(f.fps=f._fpsAccum,f._fpsAccum=0,f._timeToCountFrames=a+1E3):f._fpsAccum++;this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame;this.graphicsDevice._drawCallsPerFrame=0};b._fillFrameStats=function(){var a=this.stats.frame;
a.cameras=this.renderer._camerasRendered;a.materials=this.renderer._materialSwitches;a.shaders=this.graphicsDevice._shaderSwitchesPerFrame;a.shadowMapUpdates=this.renderer._shadowMapUpdates;a.shadowMapTime=this.renderer._shadowMapTime;a.depthMapTime=this.renderer._depthMapTime;a.forwardTime=this.renderer._forwardTime;var c=this.graphicsDevice._primsPerFrame;a.triangles=c[4]/3+Math.max(c[5]-2,0)+Math.max(c[6]-2,0);a.cullTime=this.renderer._cullTime;a.sortTime=this.renderer._sortTime;a.skinTime=this.renderer._skinTime;
a.morphTime=this.renderer._morphTime;a.instancingTime=this.renderer._instancingTime;for(var e=a.otherPrimitives=0;e<c.length;e++)4>e&&(a.otherPrimitives+=c[e]),c[e]=0;this.renderer._camerasRendered=0;this.renderer._materialSwitches=0;this.renderer._shadowMapUpdates=0;this.graphicsDevice._shaderSwitchesPerFrame=0;this.renderer._cullTime=0;this.renderer._layerCompositionUpdateTime=0;this.renderer._sortTime=0;this.renderer._skinTime=0;this.renderer._morphTime=0;this.renderer._instancingTime=0;this.renderer._shadowMapTime=
0;this.renderer._depthMapTime=0;this.renderer._forwardTime=0;a=this.stats.drawCalls;a.forward=this.renderer._forwardDrawCalls;a.culled=this.renderer._numDrawCallsCulled;a.depth=0;a.shadow=this.renderer._shadowDrawCalls;a.skinned=this.renderer._skinDrawCalls;a.immediate=0;a.instanced=0;a.removedByInstancing=0;a.misc=a.total-(a.forward+a.shadow);this.renderer._depthDrawCalls=0;this.renderer._shadowDrawCalls=0;this.renderer._forwardDrawCalls=0;this.renderer._numDrawCallsCulled=0;this.renderer._skinDrawCalls=
0;this.renderer._immediateRendered=0;this.renderer._instancedDrawCalls=0;this.renderer._removedByInstancing=0;this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime;a=this.stats.particles;a.updatesPerFrame=a._updatesPerFrame;a.frameTime=a._frameTime;a._updatesPerFrame=0;a._frameTime=0};b.setCanvasFillMode=function(a,c,e){this._fillMode=a;this.resizeCanvas(c,e)};b.setCanvasResolution=function(a,c,e){this._resolutionMode=a;"AUTO"===a&&void 0===c&&(c=this.graphicsDevice.canvas.clientWidth,
e=this.graphicsDevice.canvas.clientHeight);this.graphicsDevice.resizeCanvas(c,e)};b.isHidden=function(){return document[this._hiddenAttr]};b.onVisibilityChange=function(){this.isHidden()?this._soundManager.suspend():this._soundManager.resume()};b.resizeCanvas=function(a,c){if(this._allowResize&&(!this.xr||!this.xr.session)){var e=window.innerWidth,f=window.innerHeight;if("KEEP_ASPECT"===this._fillMode){var h=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;h>e/f?(a=e,c=a/h):(c=f,
a=c*h)}else"FILL_WINDOW"===this._fillMode&&(a=e,c=f);this.graphicsDevice.canvas.style.width=a+"px";this.graphicsDevice.canvas.style.height=c+"px";"AUTO"===this._resolutionMode&&this.setCanvasResolution("AUTO");return{width:a,height:c}}};b.onLibrariesLoaded=function(){this._librariesLoaded=!0;this.systems.rigidbody.onLibraryLoaded()};b.applySceneSettings=function(a){if(this.systems.rigidbody&&"undefined"!==typeof Ammo){var c=a.physics.gravity;this.systems.rigidbody.gravity.set(c[0],c[1],c[2])}this.scene.applySettings(a);
if(a.render.hasOwnProperty("skybox"))if(a.render.skybox)if(c=this.assets.get(a.render.skybox))this.setSkybox(c);else this.assets.once("add:"+a.render.skybox,this.setSkybox,this);else this.setSkybox(null)};b.setSkybox=function(a){a?this._skyboxLast===a.id?0!==this.scene.skyboxMip||a.loadFaces?this._onSkyboxChange(a):this._skyboxLoad(a):(this._skyboxLast&&(this.assets.off("add:"+this._skyboxLast,this.setSkybox,this),this.assets.off("load:"+this._skyboxLast,this._onSkyboxChange,this),this.assets.off("remove:"+
this._skyboxLast,this._skyboxRemove,this)),this._skyboxLast=a.id,this.assets.on("load:"+a.id,this._onSkyboxChange,this),this.assets.once("remove:"+a.id,this._skyboxRemove,this),a.resource&&this.scene.setSkybox(a.resources),this._skyboxLoad(a)):this._skyboxLast&&this._skyboxRemove({id:this._skyboxLast})};b.enableVr=function(){this.vr||(this.vr=new Eh(this))};b.disableVr=function(){this.vr&&(this.vr.destroy(),this.vr=null)};b._onSkyboxChange=function(a){this.scene.setSkybox(a.resources)};b._skyboxLoad=
function(a){0===this.scene.skyboxMip&&(a.loadFaces=!0);this.assets.load(a);this._onSkyboxChange(a)};b._skyboxRemove=function(a){this._skyboxLast&&(this.assets.off("add:"+a.id,this.setSkybox,this),this.assets.off("load:"+a.id,this._onSkyboxChange,this),this.assets.off("remove:"+a.id,this._skyboxRemove,this),this.scene.setSkybox(null),this._skyboxLast=null)};b._firstBake=function(){this.lightmapper.bake(null,this.scene.lightmapMode)};b._firstBatch=function(){this.scene._needsStaticPrepare&&(this.renderer.prepareStaticMeshes(this.graphicsDevice,
this.scene),this.scene._needsStaticPrepare=!1);this.batcher.generate()};b._processTimestamp=function(a){return a};b._preRenderImmediate=function(){for(var a=0;a<this._immediateData.lineBatches.length;a++)this._immediateData.lineBatches[a]&&this._immediateData.lineBatches[a].finalize(this.meshInstanceArray)};b._postRenderImmediate=function(){for(var a=0;a<this._immediateData.layers.length;a++)this._immediateData.layers[a].clearMeshInstances(!0);this._immediateData.layers.length=0};b._initImmediate=
function(){this._immediateData||(this._immediateData=new so(this.graphicsDevice),this.on("prerender",this._preRenderImmediate,this),this.on("postrender",this._postRenderImmediate,this))};b._addLines=function(a,c,e){var f=e&&e.layer?e.layer:this.scene.layers.getLayerById(3),h=e&&void 0!==e.depthTest?e.depthTest:!0;e=e&&e.mask?e.mask:void 0;this._initImmediate();this._immediateData.addLayer(f);var k=this._immediateData.getLayerIdx(f);void 0===k?(k=new to,k.init(this.graphicsDevice,this._immediateData.lineVertexFormat,
f,a.length/2),k.material.depthTest=h,e&&(k.meshInstance.mask=e),k=this._immediateData.lineBatches.push(k)-1,this._immediateData.addLayerIdx(k,f)):(this._immediateData.lineBatches[k].init(this.graphicsDevice,this._immediateData.lineVertexFormat,f,a.length/2),this._immediateData.lineBatches[k].material.depthTest=h,e&&(this._immediateData.lineBatches[k].meshInstance.mask=e));this._immediateData.lineBatches[k].addLines(a,c)};b.renderLine=function(a,c,e,f,h){var k=e;if(f instanceof Q)if(k=f,"number"===
typeof h){Hd||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),Hd=!0);var m=1===h?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}}else m=h;else"number"===typeof f?(Hd||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),Hd=!0),k=e,m=1===f?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):f&&(m=
f);this._addLines([a,c],[e,k],m)};b.renderLines=function(a,c,e){e?"number"===typeof e&&(Hd||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),Hd=!0),e=1===e?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):e={layer:this.scene.layers.getLayerById(3),depthTest:!0};c.length&&a.length!==c.length?console.error("renderLines: position/color arrays have different lengths"):0!==a.length%2?console.error("renderLines: array length is not divisible by 2"):
this._addLines(a,c,e)};b.renderWireCube=function(a,c,e){var f;this._initImmediate();this._immediateData.cubeLocalPos||(this._immediateData.cubeLocalPos=[new A(-.5,-.5,-.5),new A(-.5,.5,-.5),new A(.5,.5,-.5),new A(.5,-.5,-.5),new A(-.5,-.5,.5),new A(-.5,.5,.5),new A(.5,.5,.5),new A(.5,-.5,.5)],this._immediateData.cubeWorldPos=[new A,new A,new A,new A,new A,new A,new A,new A]);var h=this._immediateData.cubeLocalPos,k=this._immediateData.cubeWorldPos;for(f=0;8>f;f++)a.transformPoint(h[f],k[f]);this.renderLines([k[0],
k[1],k[1],k[2],k[2],k[3],k[3],k[0],k[4],k[5],k[5],k[6],k[6],k[7],k[7],k[4],k[0],k[4],k[1],k[5],k[2],k[6],k[3],k[7]],c,e)};b.renderMeshInstance=function(a,c){c||(c={layer:this.scene.layers.getLayerById(3)});this._initImmediate();this._immediateData.addLayer(c.layer);this.meshInstanceArray[0]=a;c.layer.addMeshInstances(this.meshInstanceArray,!0)};b.renderMesh=function(a,c,e,f){f||(f={layer:this.scene.layers.getLayerById(3)});this._initImmediate();rc.worldTransform=e;rc._dirtyWorld=rc._dirtyNormal=!1;
a=new Ga(rc,a,c);a.cull=!1;f.mask&&(a.mask=f.mask);this._immediateData.addLayer(f.layer);this.meshInstanceArray[0]=a;f.layer.addMeshInstances(this.meshInstanceArray,!0)};b.renderQuad=function(a,c,e){e||(e={layer:this.scene.layers.getLayerById(3)});this._initImmediate();if(!this._immediateData.quadMesh){var f=new Ma(this.graphicsDevice,[{semantic:"POSITION",components:3,type:6}]);f=new Ra(this.graphicsDevice,f,4);var h=new vb(f);h.element.POSITION.set(-.5,-.5,0);h.next();h.element.POSITION.set(.5,
-.5,0);h.next();h.element.POSITION.set(-.5,.5,0);h.next();h.element.POSITION.set(.5,.5,0);h.end();this._immediateData.quadMesh=new bb(this.graphicsDevice);this._immediateData.quadMesh.vertexBuffer=f;this._immediateData.quadMesh.primitive[0].type=5;this._immediateData.quadMesh.primitive[0].base=0;this._immediateData.quadMesh.primitive[0].count=4;this._immediateData.quadMesh.primitive[0].indexed=!1}rc.worldTransform=a;rc._dirtyWorld=rc._dirtyNormal=!1;a=new Ga(rc,this._immediateData.quadMesh,c);a.cull=
!1;this.meshInstanceArray[0]=a;this._immediateData.addLayer(e.layer);e.layer.addMeshInstances(this.meshInstanceArray,!0)};b.destroy=function(){var a,c=this.graphicsDevice.canvas.id;this.off("librariesloaded");document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1);document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1);document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1);document.removeEventListener("webkitvisibilitychange",
this._visibilityChangeHandler,!1);this.onVisibilityChange=this._visibilityChangeHandler=null;this.root.destroy();this.root=null;this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null);this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null);this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null);this.elementInput&&(this.elementInput.detach(),this.elementInput=null);this.controller&&(this.controller=null);var e=this.systems.list;var f=0;for(a=e.length;f<
a;f++)e[f].destroy();O.destroy();a=this.assets.list();for(f=0;f<a.length;f++)a[f].unload(),a[f].off();this.assets.off();this.bundles.destroy();this.bundles=null;this.i18n.destroy();this.i18n=null;for(var h in this.loader.getHandler("script")._cache)f=this.loader.getHandler("script")._cache[h],(a=f.parentNode)&&a.removeChild(f);this.loader.getHandler("script")._cache={};this.loader.destroy();this.loader=null;this.scene.destroy();this.scene=null;this.systems=[];this.context=null;this.scripts.destroy();
this.scripts=null;this.scenes.destroy();this.scenes=null;this.lightmapper.destroy();this.lightmapper=null;this.batcher.destroyManager();this.batcher=null;this._entityIndex={};this.defaultLayerDepth.onPreRenderOpaque=null;this.defaultLayerDepth.onPostRenderOpaque=null;this.defaultLayerDepth.onDisable=null;this.defaultLayerWorld=this.defaultLayerDepth=this.defaultLayerDepth.onEnable=null;vc&&(vc.destroy(),vc=null);this.vr&&(this.vr.destroy(),this.vr=null);this.xr.end();this.graphicsDevice.destroy();
this.tick=this.renderer=this.graphicsDevice=null;this.off();this._soundManager&&(this._soundManager.destroy(),this._soundManager=null);Va.app=null;Cf.DEFAULT_PARAM_TEXTURE=null;d._applications[c]=null;d._currentApplication===this&&(d._currentApplication=null)};b.getEntityFromIndex=function(a){return this._entityIndex[a]};N(d,[{key:"fillMode",get:function(){return this._fillMode}},{key:"resolutionMode",get:function(){return this._resolutionMode}}]);return d}(ba);qa._currentApplication=null;qa._applications=
{};var cg={},pq=function(g){var d;return function(b,a){if(g.graphicsDevice){qa._currentApplication=g;d&&(window.cancelAnimationFrame(d),d=null);q.app=g;b=g._processTimestamp(b)||eb();var c=b-(g._time||b);var e=R.clamp(c/1E3,0,g.maxDeltaTime);e*=g.timeScale;g._time=b;d=g.vr&&g.vr.display?g.vr.display.requestAnimationFrame(g.tick):g.xr.session?g.xr.session.requestAnimationFrame(g.tick):window.requestAnimationFrame(g.tick);if(!g.graphicsDevice.contextLost){g._fillFrameStatsBasic(b,e,c);g.fire("frameupdate",
c);a?(g.xr.update(a),g.graphicsDevice.defaultFramebuffer=a.session.renderState.baseLayer.framebuffer):g.graphicsDevice.defaultFramebuffer=null;g.update(e);g.fire("framerender");if(g.autoRender||g.renderNextFrame)g.render(),g.renderNextFrame=!1;cg.timestamp=eb();cg.target=g;g.fire("frameend",cg);g.fire("frameEnd",cg);g.vr&&g.vr.display&&g.vr.display.presenting&&g.vr.display.submitFrame()}}}},Ha=[],Km=[],Eg=[],Fg=[],Bc={},Ye=[],qq=function(){function g(){}g.prototype.copy=function(d){for(var b in d)d.hasOwnProperty(b)&&
"copy"!==b&&(this[b]=d[b])};return g}(),ma=function(g){function d(){var a=g.call(this)||this;a._assetReferences={};a._validator=null;a.shaderOptBuilder=new jb;a.reset();return a}K(d,g);var b=d.prototype;b.reset=function(){for(var a=0;a<Ha.length;a++){var c=Km[a];this[Ha[a]]=c?c.clone?c.clone():c:c}for(a=0;a<Eg.length;a++)this[Eg[a]]=null;for(a=0;a<Fg.length;a++)this[Fg[a]]=new Float32Array(3);this._chunks=new qq;this.cubeMapMinUniform=new Float32Array(3);this.cubeMapMaxUniform=new Float32Array(3)};
b.clone=function(){var a=new d;this._cloneInternal(a);for(var c=0;c<Ha.length;c++){var e=Ha[c];void 0!==this[e]&&(this[e]&&this[e].copy?a[e]?a[e].copy(this[e]):a[e]=this[e].clone():a[e]=this[e])}return a};b._updateMapTransform=function(a,c,e){if(1===c.x&&1===c.y&&0===e.x&&0===e.y)return null;a=a||new Z;a.set(c.x,c.y,e.x,e.y);return a};b._setParameter=function(a,c){this.parameters[a]||this._propsSet.push(a);this.setParameter(a,c)};b._clearParameters=function(){for(var a=this._propsSet,c=0;c<a.length;c++)delete this.parameters[a[c]];
this._propsSet=[]};b._updateMap=function(a){var c=a+"Map";if(a=this[c]){this._setParameter("texture_"+c,a);a=c+"Transform";this[a]=this._updateMapTransform(this[a],this[c+"Tiling"],this[c+"Offset"]);var e=this[a];if(e){c+="TransformUniform";var f=this[c];f||(f=new Float32Array(4),this[c]=f);f[0]=e.x;f[1]=e.y;f[2]=e.z;f[3]=e.w;this._setParameter("texture_"+a,f)}}};b.getUniform=function(a,c,e){return(a=Bc[a])?a(this,c,e):null};b.updateUniforms=function(){this._clearParameters();this._setParameter("material_ambient",
this.ambientUniform);this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",this.diffuseUniform);this.useMetalness?(!this.metalnessMap||1>this.metalness)&&this._setParameter("material_metalness",this.metalness):this.specularMap&&!this.specularTint||this._setParameter("material_specular",this.specularUniform);this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy);0<this.clearCoat&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGlossiness",
this.clearCoatGlossiness),this._setParameter("material_clearCoatReflectivity",this.clearCoat),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness));var a=this.getUniform("shininess",this.shininess,!0);this._setParameter(a.name,a.value);this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",this.emissiveUniform);this.emissiveMap&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity);0<this.refraction&&(this._setParameter("material_refraction",
this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex));this._setParameter("material_opacity",this.opacity);!1===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade);this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity);1===this.cubeMapProjection&&this._setParameter(this.getUniform("cubeMapProjectionBox",this.cubeMapProjectionBox,!0));for(var c in Fb)this._updateMap(c);this.ambientSH&&
this._setParameter("ambientSH[0]",this.ambientSH);this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness);this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness);this.heightMap&&(a=this.getUniform("heightMapFactor",this.heightMapFactor,!0),this._setParameter(a.name,a.value));this.cubeMap&&this._setParameter("texture_cubeMap",this.cubeMap);this.prefilteredCubeMap128?this._setParameter("texture_prefilteredCubeMap128",
this.prefilteredCubeMap128):this._scene&&this._scene._skyboxPrefiltered[0]&&this._setParameter("texture_prefilteredCubeMap128",this._scene._skyboxPrefiltered[0]);this.prefilteredCubeMap64?this._setParameter("texture_prefilteredCubeMap64",this.prefilteredCubeMap64):this._scene&&this._scene._skyboxPrefiltered[1]&&this._setParameter("texture_prefilteredCubeMap64",this._scene._skyboxPrefiltered[1]);this.prefilteredCubeMap32?this._setParameter("texture_prefilteredCubeMap32",this.prefilteredCubeMap32):
this._scene&&this._scene._skyboxPrefiltered[2]&&this._setParameter("texture_prefilteredCubeMap32",this._scene._skyboxPrefiltered[2]);this.prefilteredCubeMap16?this._setParameter("texture_prefilteredCubeMap16",this.prefilteredCubeMap16):this._scene&&this._scene._skyboxPrefiltered[3]&&this._setParameter("texture_prefilteredCubeMap16",this._scene._skyboxPrefiltered[3]);this.prefilteredCubeMap8?this._setParameter("texture_prefilteredCubeMap8",this.prefilteredCubeMap8):this._scene&&this._scene._skyboxPrefiltered[4]&&
this._setParameter("texture_prefilteredCubeMap8",this._scene._skyboxPrefiltered[4]);this.prefilteredCubeMap4?this._setParameter("texture_prefilteredCubeMap4",this.prefilteredCubeMap4):this._scene&&this._scene._skyboxPrefiltered[5]&&this._setParameter("texture_prefilteredCubeMap4",this._scene._skyboxPrefiltered[5]);this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap);this.dpAtlas&&this._setParameter("texture_sphereMap",this.dpAtlas);this._setParameter("material_reflectivity",this.reflectivity);
if(this.dirtyShader||!this._scene)this.shader=null,this.clearVariants();this._processColor()};b._processColor=function(){if(this.dirtyColor&&(this._scene||!this.useGammaTonemap)){var a=!1;this.useGammaTonemap&&(a=this._scene.gammaCorrection);for(var c=0;c<Ye.length;c++){var e=this["_"+Ye[c]],f=this[Ye[c]+"Uniform"];a?(f[0]=Math.pow(e.r,2.2),f[1]=Math.pow(e.g,2.2),f[2]=Math.pow(e.b,2.2)):(f[0]=e.r,f[1]=e.g,f[2]=e.b)}for(a=0;3>a;a++)this.emissiveUniform[a]*=this.emissiveIntensity;this.dirtyColor=!1}};
b.updateShader=function(a,c,e,f,h,k){!this._colorProcessed&&this._scene&&(this._colorProcessed=!0,this._processColor());var m=a.useTexCubeLod,n=!a.extTextureLod;if(this.useSkybox){var p=c._skyboxPrefiltered[0];var t=c._skyboxPrefiltered[1];var r=c._skyboxPrefiltered[2];var u=c._skyboxPrefiltered[3];var v=c._skyboxPrefiltered[4];var w=c._skyboxPrefiltered[5]}p=this.prefilteredCubeMap128||p;t=this.prefilteredCubeMap64||t;r=this.prefilteredCubeMap32||r;u=this.prefilteredCubeMap16||u;v=this.prefilteredCubeMap8||
v;w=this.prefilteredCubeMap4||w;if(p){var y=p&&t&&r&&u&&v&&w;if(n&&y){if(!p.dpAtlas){m=[p,t,r,u,v,w];n=new Z;w=new Z;t=4*m[0].width;v=Ja(a,I.fullscreenQuadVS,I.dpAtlasQuadPS,"dpAtlasQuad");r=a.scope.resolve("source");y=a.scope.resolve("params");var x=new X(a,{type:m[0].type,format:m[0].format,width:t,height:t,mipmaps:!1});x.name="paraboloid";for(var z=new va(a,x,{depth:!1}),B=(t+2)/t-1,C=0;6>C;C++){var D=a;var G=m[C],J=C,E=Ja(D,I.fullscreenQuadVS,(G.fixCubemapSeams?I.fixCubemapSeamsStretchPS:I.fixCubemapSeamsNonePS)+
I.genParaboloidPS,"genParaboloid"),H=D.scope.resolve("source"),P=D.scope.resolve("params"),Y=new Z,L=G.width,V=G.format;L=2*Math.max(L,8);L=new X(D,{type:G.type,format:V,width:2*L,height:L,mipmaps:!1});L.name="paraboloid";V=new va(D,L,{depth:!1});Y.x=J;Y.y=1;H.setValue(G);P.setValue(Y.data);Ea(D,V,E);D=L;r.setValue(D);D=n;G=C;D.x=.5*R.clamp(G-2,0,1);G-=6*D.x;J=1-D.x;D.y=Math.min(.5*G,.75)*J+D.x;D.z=(1-.5*R.clamp(G,0,1))*J;D.w=.5*D.z;D=1/D.z;w.x=D*B;w.y=2*w.x;w.x+=1;w.y+=1;y.setValue(w.data);n.x*=
t;n.y*=t;n.z*=t;n.w*=t;Ea(a,z,v,n)}p.dpAtlas=x;p.sh=jj(a,u)}this.dpAtlas=p.dpAtlas;this.ambientSH=p.sh;this._setParameter("ambientSH[0]",this.ambientSH);this._setParameter("texture_sphereMap",this.dpAtlas)}else m?6>p._levels.length?y?this._setParameter("texture_prefilteredCubeMap128",p):console.log("Can't use prefiltered cubemap: "+y+", "+m+", "+p._levels):this._setParameter("texture_prefilteredCubeMap128",p):y?(this._setParameter("texture_prefilteredCubeMap128",p),this._setParameter("texture_prefilteredCubeMap64",
t),this._setParameter("texture_prefilteredCubeMap32",r),this._setParameter("texture_prefilteredCubeMap16",u),this._setParameter("texture_prefilteredCubeMap8",v),this._setParameter("texture_prefilteredCubeMap4",w)):console.log("Can't use prefiltered cubemap: "+y+", "+m+", "+p._levels);this.useSkybox&&!c.skyboxRotation.equals(ea.IDENTITY)&&c._skyboxRotationMat3&&this._setParameter("cubeMapRotationMatrix",c._skyboxRotationMat3.data)}m=(u=1<h&&18>=h)?Vg.optionsContextMin:Vg.optionsContext;u?this.shaderOptBuilder.updateMinRef(m,
a,c,this,e,f,h,k,p):this.shaderOptBuilder.updateRef(m,a,c,this,e,f,h,k,p);this.onUpdateShader&&(m=this.onUpdateShader(m));this.shader=a.getProgramLibrary().getProgram("standard",m);e||(this.clearVariants(),this.variants[0]=this.shader);this.dirtyShader=!1};return d}(Fa);ma.TEXTURE_PARAMETERS=Bd;ma.CUBEMAP_PARAMETERS=Mf;(function(g){g.dirtyShader=!0;g.dirtyColor=!0;g._scene=null;g._colorProcessed=!1;Xe(g,"ambient",new Q(.7,.7,.7));Xe(g,"diffuse",new Q(1,1,1));Xe(g,"specular",new Q(0,0,0));Xe(g,"emissive",
new Q(0,0,0),!0);Na(g,"shininess",25,function(b,a){return{name:"material_shininess",value:0===b.shadingModel?Math.pow(2,.11*a):.01*a}});Na(g,"heightMapFactor",1,function(b,a){return{name:"material_heightMapFactor",value:.025*a}});Na(g,"opacity",1);Na(g,"alphaFade",1);Na(g,"alphaTest",0);Na(g,"bumpiness",1);Na(g,"normalDetailMapBumpiness",1);Na(g,"reflectivity",1);Na(g,"occludeSpecularIntensity",1);Na(g,"refraction",0);Na(g,"refractionIndex",1/1.5);Na(g,"metalness",1);Na(g,"anisotropy",0);Na(g,"clearCoat",
0);Na(g,"clearCoatGlossiness",1);Na(g,"clearCoatBumpiness",1);Na(g,"aoUvSet",0,null);xb(g,"ambientSH",function(b,a,c){return{name:"ambientSH[0]",value:a}});xb(g,"cubeMapProjectionBox",function(b,a,c){var e=c?b.cubeMapMinUniform:new Float32Array(3);b=c?b.cubeMapMaxUniform:new Float32Array(3);e[0]=a.center.x-a.halfExtents.x;e[1]=a.center.y-a.halfExtents.y;e[2]=a.center.z-a.halfExtents.z;b[0]=a.center.x+a.halfExtents.x;b[1]=a.center.y+a.halfExtents.y;b[2]=a.center.z+a.halfExtents.z;return[{name:"envBoxMin",
value:e},{name:"envBoxMax",value:b}]});Xn();ya(g,"ambientTint",!1);ya(g,"diffuseTint",!1);ya(g,"specularTint",!1);ya(g,"emissiveTint",!1);ya(g,"fastTbn",!1);ya(g,"specularAntialias",!1);ya(g,"useMetalness",!1);ya(g,"enableGGXSpecular",!1);ya(g,"occludeDirect",!1);ya(g,"normalizeNormalMap",!0);ya(g,"conserveEnergy",!0);ya(g,"opacityFadesSpecular",!0);ya(g,"occludeSpecular",1);ya(g,"shadingModel",1);ya(g,"fresnelModel",0);ya(g,"cubeMapProjection",0);ya(g,"customFragmentShader",null);ya(g,"forceFragmentPrecision",
null);ya(g,"useFog",!0);ya(g,"useLighting",!0);ya(g,"useGammaTonemap",!0);ya(g,"useSkybox",!0);ya(g,"forceUv1",!1);ya(g,"pixelSnap",!1);ya(g,"twoSidedLighting",!1);ya(g,"nineSlicedMode",void 0);Sa(g,"diffuse",0,3,"",!0);Sa(g,"specular",0,3,"",!0);Sa(g,"emissive",0,3,"",!0);Sa(g,"normal",0,-1,"",!1);Sa(g,"metalness",0,1,"",!0);Sa(g,"gloss",0,1,"",!0);Sa(g,"opacity",0,1,"a",!0);Sa(g,"height",0,1,"",!1);Sa(g,"ao",0,1,"",!0);Sa(g,"light",1,3,"",!0);Sa(g,"msdf",0,3,"",!1);Sa(g,"diffuseDetail",0,3,"",!1,
!0);Sa(g,"normalDetail",0,-1,"",!1);Sa(g,"clearCoat",0,1,"",!0);Sa(g,"clearCoatGloss",0,1,"",!0);Sa(g,"clearCoatNormal",0,-1,"",!1);xb(g,"cubeMap");xb(g,"sphereMap");xb(g,"dpAtlas");xb(g,"prefilteredCubeMap128");xb(g,"prefilteredCubeMap64");xb(g,"prefilteredCubeMap32");xb(g,"prefilteredCubeMap16");xb(g,"prefilteredCubeMap8");xb(g,"prefilteredCubeMap4");yb(g,"diffuseTint","diffuseMapTint");yb(g,"specularTint","specularMapTint");yb(g,"emissiveTint","emissiveMapTint");yb(g,"aoVertexColor","aoMapVertexColor");
yb(g,"diffuseVertexColor","diffuseMapVertexColor");yb(g,"specularVertexColor","specularMapVertexColor");yb(g,"emissiveVertexColor","emissiveMapVertexColor");yb(g,"metalnessVertexColor","metalnessMapVertexColor");yb(g,"glossVertexColor","glossMapVertexColor");yb(g,"opacityVertexColor","opacityMapVertexColor");yb(g,"lightVertexColor","lightMapVertexColor");for(var d=0;d<Ha.length;d++)Km[d]=g[Ha[d]];g._propsSet=[]})(ma.prototype);var ri=function(){function g(b){this._device=b;this._cache={};this._generators=
{};this._precached=this._isClearingCache=!1;this._programsCollection=[];this._defaultStdMatOption={};this._defaultStdMatOptionMin={};var a=new ma;a.shaderOptBuilder.updateRef(this._defaultStdMatOption,b,{},a,null,[],0,null,null);a.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,b,{},a,null,[],3,null,null)}var d=g.prototype;d.register=function(b,a){this.isRegistered(b)||(this._generators[b]=a)};d.unregister=function(b){this.isRegistered(b)&&delete this._generators[b]};d.isRegistered=function(b){return void 0!==
this._generators[b]};d.getProgram=function(b,a){var c=this._generators[b];if(void 0===c)return null;var e=this._device,f=c.generateKey(a),h=this._cache[f];if(!h){if(a.lights){var k=a.lights;a.lights=k.map(function(m){var n=m.clone?m.clone():m;n.key=m.key;return n})}this.storeNewProgram(b,a);a.lights&&(a.lights=k);this._precached&&console.warn("ProgramLibrary#getProgram: Cache miss for shader",b,"key",f,"after shaders precaching");b=c.createShaderDefinition(e,a);h=this._cache[f]=new Ld(e,b)}return h};
d.storeNewProgram=function(b,a){var c={};if("standard"===b){var e=this._getDefaultStdMatOptions(a.pass),f;for(f in a)if(a.hasOwnProperty(f)&&e[f]!==a[f]||"pass"===f)c[f]=a[f]}else c=a;this._programsCollection.push(JSON.stringify({name:b,options:c}))};d.dumpPrograms=function(){var b="var device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\nvar shaders = [";this._programsCollection[0]&&(b+="\n\t"+this._programsCollection[0]);for(var a=1;a<this._programsCollection.length;++a)b+=
",\n\t"+this._programsCollection[a];b+='\n];\ndevice.programLib.precompile(shaders);\nif (pc.version != "1.38.0" || pc.revision != "98cb89e")\n\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';a=document.createElement("a");a.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(b));a.setAttribute("download","precompile-shaders.js");a.style.display="none";document.body.appendChild(a);a.click();document.body.removeChild(a)};
d.clearCache=function(){var b=this._cache;this._isClearingCache=!0;for(var a in b)b.hasOwnProperty(a)&&b[a].destroy();this._cache={};this._isClearingCache=!1};d.removeFromCache=function(b){if(!this._isClearingCache){var a=this._cache,c;for(c in a)if(a.hasOwnProperty(c)&&a[c]===b){delete a[c];break}}};d._getDefaultStdMatOptions=function(b){return 1<b&&18>=b?this._defaultStdMatOptionMin:this._defaultStdMatOption};d.precompile=function(b){if(b)for(var a=Array(b.length),c=0;c<b.length;c++){if("standard"===
b[c].name){var e=b[c].options,f=this._getDefaultStdMatOptions(e.pass),h;for(h in f)f.hasOwnProperty(h)&&void 0===e[h]&&(e[h]=f[h]);e.useTexCubeLod=this._device.useTexCubeLod}a[c]=this.getProgram(b[c].name,b[c].options)}this._precached=!0};return g}(),Lm=function(){function g(){this.revision=this.globalId=0}var d=g.prototype;d.equals=function(b){return this.globalId===b.globalId&&this.revision===b.revision};d.copy=function(b){this.globalId=b.globalId;this.revision=b.revision};d.reset=function(){this.revision=
this.globalId=0};return g}(),Mm=0,rq=function(){function g(){Mm++;this.version=new Lm;this.version.globalId=Mm}g.prototype.increment=function(){this.version.revision++};return g}(),si=function(){function g(b){this.name=b;this.value=null;this.versionObject=new rq}var d=g.prototype;d.setValue=function(b){this.value=b;this.versionObject.increment()};d.getValue=function(){return this.value};return g}(),Nm=function(){function g(b){this.name=b;this.variables={};this.namespaces={}}var d=g.prototype;d.resolve=
function(b){this.variables.hasOwnProperty(b)||(this.variables[b]=new si(b));return this.variables[b]};d.getSubSpace=function(b){this.namespaces.hasOwnProperty(b)||(this.namespaces[b]=new g(b));return this.namespaces[b]};return g}(),ti=function(g,d,b,a){this.locationId=a;this.scopeId=g.scope.resolve(d);this.version=new Lm;if("[0]"===d.substr(d.length-3))switch(b){case 2:b=17;break;case 3:b=21;break;case 4:b=22;break;case 5:b=23}this.dataType=b;this.value=[null,null,null,null];this.array=[]},Om=function(g,
d){var b=g.width,a=g.height;if(b>d||a>d){var c=d/Math.max(b,a),e=Math.floor(b*c);c=Math.floor(a*c);console.warn("Image dimensions larger than max supported texture size of "+d+". Resizing from "+b+", "+a+" to "+e+", "+c+".");d=document.createElement("canvas");d.width=e;d.height=c;d.getContext("2d").drawImage(g,0,0,b,a,0,0,e,c);return d}return g},Ae=function(g){function d(a,c){var e=g.call(this)||this;var f;e.canvas=a;e._enableAutoInstancing=!1;e.autoInstancingMaxObjects=16384;e.defaultFramebuffer=
null;e._maxPixelRatio=1;e._width=0;e._height=0;e.updateClientRect();e.shaders=[];e.buffers=[];e.textures=[];e.targets=[];e.contextLost=!1;e._contextLostHandler=function(w){w.preventDefault();this.contextLost=!0;this.loseContext();this.fire("devicelost")}.bind(F(e));e._contextRestoredHandler=function(){this.restoreContext();this.contextLost=!1;this.fire("devicerestored")}.bind(F(e));var h=c&&void 0!==c.preferWebGl2?c.preferWebGl2:!0,k=h?["webgl2","experimental-webgl2","webgl","experimental-webgl"]:
["webgl","experimental-webgl"],m=null;c=c||{};c.stencil=!0;for(f=0;f<k.length;f++){try{m=a.getContext(k[f],c)}catch(w){}if(m){e.webgl2=h&&2>f;break}}if(!m)throw Error("WebGL not supported");e.gl=m;e._tempEnableSafariTextureUnitWorkaround=!!window.safari;f=!!window.chrome;h=-1!==navigator.appVersion.indexOf("Mac");e._tempMacChromeBlitFramebufferWorkaround=h&&f&&!c.alpha;window.setupVertexArrayObject(m);a.addEventListener("webglcontextlost",e._contextLostHandler,!1);a.addEventListener("webglcontextrestored",
e._contextRestoredHandler,!1);e.initializeExtensions();e.initializeCapabilities();e.initializeRenderState();e.initializeContextCaches();e.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3};e.glAddress=[m.REPEAT,m.CLAMP_TO_EDGE,m.MIRRORED_REPEAT];e.glBlendEquation=[m.FUNC_ADD,m.FUNC_SUBTRACT,m.FUNC_REVERSE_SUBTRACT,e.webgl2?m.MIN:e.extBlendMinmax?e.extBlendMinmax.MIN_EXT:m.FUNC_ADD,e.webgl2?m.MAX:e.extBlendMinmax?e.extBlendMinmax.MAX_EXT:m.FUNC_ADD];e.glBlendFunction=[m.ZERO,m.ONE,m.SRC_COLOR,
m.ONE_MINUS_SRC_COLOR,m.DST_COLOR,m.ONE_MINUS_DST_COLOR,m.SRC_ALPHA,m.SRC_ALPHA_SATURATE,m.ONE_MINUS_SRC_ALPHA,m.DST_ALPHA,m.ONE_MINUS_DST_ALPHA];e.glComparison=[m.NEVER,m.LESS,m.EQUAL,m.LEQUAL,m.GREATER,m.NOTEQUAL,m.GEQUAL,m.ALWAYS];e.glStencilOp=[m.KEEP,m.ZERO,m.REPLACE,m.INCR,m.INCR_WRAP,m.DECR,m.DECR_WRAP,m.INVERT];e.glClearFlag=[0,m.COLOR_BUFFER_BIT,m.DEPTH_BUFFER_BIT,m.COLOR_BUFFER_BIT|m.DEPTH_BUFFER_BIT,m.STENCIL_BUFFER_BIT,m.STENCIL_BUFFER_BIT|m.COLOR_BUFFER_BIT,m.STENCIL_BUFFER_BIT|m.DEPTH_BUFFER_BIT,
m.STENCIL_BUFFER_BIT|m.COLOR_BUFFER_BIT|m.DEPTH_BUFFER_BIT];e.glCull=[0,m.BACK,m.FRONT,m.FRONT_AND_BACK];e.glFilter=[m.NEAREST,m.LINEAR,m.NEAREST_MIPMAP_NEAREST,m.NEAREST_MIPMAP_LINEAR,m.LINEAR_MIPMAP_NEAREST,m.LINEAR_MIPMAP_LINEAR];e.glPrimitive=[m.POINTS,m.LINES,m.LINE_LOOP,m.LINE_STRIP,m.TRIANGLES,m.TRIANGLE_STRIP,m.TRIANGLE_FAN];e.glType=[m.BYTE,m.UNSIGNED_BYTE,m.SHORT,m.UNSIGNED_SHORT,m.INT,m.UNSIGNED_INT,m.FLOAT];e.pcUniformType={};e.pcUniformType[m.BOOL]=0;e.pcUniformType[m.INT]=1;e.pcUniformType[m.FLOAT]=
2;e.pcUniformType[m.FLOAT_VEC2]=3;e.pcUniformType[m.FLOAT_VEC3]=4;e.pcUniformType[m.FLOAT_VEC4]=5;e.pcUniformType[m.INT_VEC2]=6;e.pcUniformType[m.INT_VEC3]=7;e.pcUniformType[m.INT_VEC4]=8;e.pcUniformType[m.BOOL_VEC2]=9;e.pcUniformType[m.BOOL_VEC3]=10;e.pcUniformType[m.BOOL_VEC4]=11;e.pcUniformType[m.FLOAT_MAT2]=12;e.pcUniformType[m.FLOAT_MAT3]=13;e.pcUniformType[m.FLOAT_MAT4]=14;e.pcUniformType[m.SAMPLER_2D]=15;e.pcUniformType[m.SAMPLER_CUBE]=16;e.webgl2&&(e.pcUniformType[m.SAMPLER_2D_SHADOW]=18,
e.pcUniformType[m.SAMPLER_CUBE_SHADOW]=19,e.pcUniformType[m.SAMPLER_3D]=20);e.targetToSlot={};e.targetToSlot[m.TEXTURE_2D]=0;e.targetToSlot[m.TEXTURE_CUBE_MAP]=1;e.targetToSlot[m.TEXTURE_3D]=2;var n,p,t,r,u;e.commitFunction=[];e.commitFunction[0]=function(w,y){w.value!==y&&(m.uniform1i(w.locationId,y),w.value=y)};e.commitFunction[1]=e.commitFunction[0];e.commitFunction[2]=function(w,y){w.value!==y&&(m.uniform1f(w.locationId,y),w.value=y)};e.commitFunction[3]=function(w,y){u=w.value;n=y[0];p=y[1];
if(u[0]!==n||u[1]!==p)m.uniform2fv(w.locationId,y),u[0]=n,u[1]=p};e.commitFunction[4]=function(w,y){u=w.value;n=y[0];p=y[1];t=y[2];if(u[0]!==n||u[1]!==p||u[2]!==t)m.uniform3fv(w.locationId,y),u[0]=n,u[1]=p,u[2]=t};e.commitFunction[5]=function(w,y){u=w.value;n=y[0];p=y[1];t=y[2];r=y[3];if(u[0]!==n||u[1]!==p||u[2]!==t||u[3]!==r)m.uniform4fv(w.locationId,y),u[0]=n,u[1]=p,u[2]=t,u[3]=r};e.commitFunction[6]=function(w,y){u=w.value;n=y[0];p=y[1];if(u[0]!==n||u[1]!==p)m.uniform2iv(w.locationId,y),u[0]=n,
u[1]=p};e.commitFunction[9]=e.commitFunction[6];e.commitFunction[7]=function(w,y){u=w.value;n=y[0];p=y[1];t=y[2];if(u[0]!==n||u[1]!==p||u[2]!==t)m.uniform3iv(w.locationId,y),u[0]=n,u[1]=p,u[2]=t};e.commitFunction[10]=e.commitFunction[7];e.commitFunction[8]=function(w,y){u=w.value;n=y[0];p=y[1];t=y[2];r=y[3];if(u[0]!==n||u[1]!==p||u[2]!==t||u[3]!==r)m.uniform4iv(w.locationId,y),u[0]=n,u[1]=p,u[2]=t,u[3]=r};e.commitFunction[11]=e.commitFunction[8];e.commitFunction[12]=function(w,y){m.uniformMatrix2fv(w.locationId,
!1,y)};e.commitFunction[13]=function(w,y){m.uniformMatrix3fv(w.locationId,!1,y)};e.commitFunction[14]=function(w,y){m.uniformMatrix4fv(w.locationId,!1,y)};e.commitFunction[17]=function(w,y){m.uniform1fv(w.locationId,y)};e.commitFunction[21]=function(w,y){m.uniform2fv(w.locationId,y)};e.commitFunction[22]=function(w,y){m.uniform3fv(w.locationId,y)};e.commitFunction[23]=function(w,y){m.uniform4fv(w.locationId,y)};e.scope=new Nm("Device");e.programLib=new ri(F(e));for(var v in lf)e.programLib.register(v,
lf[v]);e.supportsBoneTextures=e.extTextureFloat&&0<e.maxVertexTextures;e.useTexCubeLod=e.extTextureLod&&16>e.maxTextures;e.boneLimit=Math.floor((e.vertexUniformsCount-16-8-1-16)/3);e.boneLimit=Math.min(e.boneLimit,128);"Mali-450 MP"===e.unmaskedRenderer&&(e.boneLimit=34);e._drawCallsPerFrame=0;e._shaderSwitchesPerFrame=0;e._primsPerFrame=[];for(f=0;6>=f;f++)e._primsPerFrame[f]=0;e._renderTargetCreationTime=0;e._vram={tex:0,vb:0,ib:0};e._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,
compileTime:0};e.constantTexSource=e.scope.resolve("source");e.textureFloatRenderable=e.extTextureFloat?e.webgl2?!!e.extColorBufferFloat:ij(m,m.FLOAT):!1;e.textureHalfFloatRenderable=e.extTextureHalfFloat?e.webgl2?!!e.extColorBufferFloat:ij(m,e.extTextureHalfFloat.HALF_FLOAT_OES):!1;e.supportsMorphTargetTexturesCore="highp"===e.maxPrecision&&2<=e.maxVertexTextures;e._textureFloatHighPrecision=void 0;e._textureHalfFloatUpdatable=void 0;e.grabPassAvailable=!0;e.grabPassApha=c.alpha;e.createGrabPass();
Ma.init(F(e));e._areaLightLutFormat=e.extTextureFloat?14:e.extTextureHalfFloat&&e.textureHalfFloatUpdatable?12:7;return e}K(d,g);var b=d.prototype;b.getPrecision=function(){var a=this.gl,c="highp";if(a.getShaderPrecisionFormat){var e=a.getShaderPrecisionFormat(a.VERTEX_SHADER,a.HIGH_FLOAT),f=a.getShaderPrecisionFormat(a.VERTEX_SHADER,a.MEDIUM_FLOAT),h=a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT);a=a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT);f=0<f.precision&&0<a.precision;
0<e.precision&&0<h.precision||(c=f?"mediump":"lowp")}return c};b.initializeExtensions=function(){var a=this.gl,c=a.getSupportedExtensions(),e=function(){for(var h=0;h<arguments.length;h++)if(-1!==c.indexOf(arguments[h]))return a.getExtension(arguments[h]);return null};if(this.webgl2)this.extVertexArrayObject=this.extUintElement=this.extTextureLod=this.extTextureHalfFloatLinear=this.extTextureHalfFloat=this.extTextureFloat=this.extStandardDerivatives=this.extInstancing=this.extDrawBuffers=this.extBlendMinmax=
!0,this.extColorBufferFloat=e("EXT_color_buffer_float"),this.extDisjointTimerQuery=e("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query");else{this.extBlendMinmax=e("EXT_blend_minmax");this.extDrawBuffers=e("EXT_draw_buffers");if(this.extInstancing=e("ANGLE_instanced_arrays")){var f=this.extInstancing;a.drawArraysInstanced=f.drawArraysInstancedANGLE.bind(f);a.drawElementsInstanced=f.drawElementsInstancedANGLE.bind(f);a.vertexAttribDivisor=f.vertexAttribDivisorANGLE.bind(f)}this.extStandardDerivatives=
e("OES_standard_derivatives");this.extTextureFloat=e("OES_texture_float");this.extTextureHalfFloat=e("OES_texture_half_float");this.extTextureHalfFloatLinear=e("OES_texture_half_float_linear");this.extTextureLod=e("EXT_shader_texture_lod");this.extUintElement=e("OES_element_index_uint");if(this.extVertexArrayObject=e("OES_vertex_array_object"))f=this.extVertexArrayObject,a.createVertexArray=f.createVertexArrayOES.bind(f),a.deleteVertexArray=f.deleteVertexArrayOES.bind(f),a.isVertexArray=f.isVertexArrayOES.bind(f),
a.bindVertexArray=f.bindVertexArrayOES.bind(f);this.extDisjointTimerQuery=this.extColorBufferFloat=null}this.extDebugRendererInfo=e("WEBGL_debug_renderer_info");this.extTextureFloatLinear=e("OES_texture_float_linear");this.extFloatBlend=e("EXT_float_blend");this.extTextureFilterAnisotropic=e("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic");this.extCompressedTextureETC1=e("WEBGL_compressed_texture_etc1");this.extCompressedTextureETC=e("WEBGL_compressed_texture_etc");this.extCompressedTexturePVRTC=
e("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc");this.extCompressedTextureS3TC=e("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc");this.extCompressedTextureATC=e("WEBGL_compressed_texture_atc");this.extCompressedTextureASTC=e("WEBGL_compressed_texture_astc");this.extParallelShaderCompile=e("KHR_parallel_shader_compile");this.supportsInstancing=!!this.extInstancing};b.initializeCapabilities=function(){var a=this.gl;this.maxPrecision=this.precision=this.getPrecision();
var c=a.getContextAttributes();this.supportsMsaa=c.antialias;this.supportsStencil=c.stencil;this.maxTextureSize=a.getParameter(a.MAX_TEXTURE_SIZE);this.maxCubeMapSize=a.getParameter(a.MAX_CUBE_MAP_TEXTURE_SIZE);this.maxRenderBufferSize=a.getParameter(a.MAX_RENDERBUFFER_SIZE);this.maxTextures=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS);this.maxCombinedTextures=a.getParameter(a.MAX_COMBINED_TEXTURE_IMAGE_UNITS);this.maxVertexTextures=a.getParameter(a.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this.vertexUniformsCount=
a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS);this.fragmentUniformsCount=a.getParameter(a.MAX_FRAGMENT_UNIFORM_VECTORS);this.webgl2?(this.maxDrawBuffers=a.getParameter(a.MAX_DRAW_BUFFERS),this.maxColorAttachments=a.getParameter(a.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=a.getParameter(a.MAX_3D_TEXTURE_SIZE)):(this.maxDrawBuffers=(c=this.extDrawBuffers)?a.getParameter(c.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=c?a.getParameter(c.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1);this.unmaskedRenderer=
(c=this.extDebugRendererInfo)?a.getParameter(c.UNMASKED_RENDERER_WEBGL):"";this.unmaskedVendor=c?a.getParameter(c.UNMASKED_VENDOR_WEBGL):"";this.maxAnisotropy=(c=this.extTextureFilterAnisotropic)?a.getParameter(c.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;this.samples=a.getParameter(a.SAMPLES)};b.initializeRenderState=function(){var a=this.gl;this.blending=!1;a.disable(a.BLEND);this.blendSrc=1;this.blendDst=0;this.blendSrcAlpha=1;this.blendDstAlpha=0;this.separateAlphaBlend=!1;this.blendAlphaEquation=this.blendEquation=
0;this.separateAlphaEquation=!1;a.blendFunc(a.ONE,a.ZERO);a.blendEquation(a.FUNC_ADD);this.writeAlpha=this.writeBlue=this.writeGreen=this.writeRed=!0;a.colorMask(!0,!0,!0,!0);this.cullMode=1;a.enable(a.CULL_FACE);a.cullFace(a.BACK);this.depthTest=!0;a.enable(a.DEPTH_TEST);this.depthFunc=3;a.depthFunc(a.LEQUAL);this.depthWrite=!0;a.depthMask(!0);this.stencil=!1;a.disable(a.STENCIL_TEST);this.stencilFuncFront=this.stencilFuncBack=7;this.stencilRefFront=this.stencilRefBack=0;this.stencilMaskFront=this.stencilMaskBack=
255;a.stencilFunc(a.ALWAYS,0,255);this.stencilZpassFront=this.stencilZpassBack=this.stencilZfailFront=this.stencilZfailBack=this.stencilFailFront=this.stencilFailBack=0;this.stencilWriteMaskBack=this.stencilWriteMaskFront=255;a.stencilOp(a.KEEP,a.KEEP,a.KEEP);a.stencilMask(255);this.alphaToCoverage=!1;this.raster=!0;this.webgl2&&(a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),a.disable(a.RASTERIZER_DISCARD));this.depthBiasEnabled=!1;a.disable(a.POLYGON_OFFSET_FILL);this.clearDepth=1;a.clearDepth(1);this.clearAlpha=
this.clearGreen=this.clearBlue=this.clearRed=0;a.clearColor(0,0,0,0);this.clearStencil=0;a.clearStencil(0);this.sx=this.sy=this.sw=this.sh=this.vx=this.vy=this.vw=this.vh=0;this.webgl2?a.hint(a.FRAGMENT_SHADER_DERIVATIVE_HINT,a.NICEST):this.extStandardDerivatives&&a.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,a.NICEST);a.enable(a.SCISSOR_TEST);a.pixelStorei(a.UNPACK_COLORSPACE_CONVERSION_WEBGL,a.NONE);this.unpackFlipY=!1;a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1);this.unpackPremultiplyAlpha=
!1;a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1)};b.initializeContextCaches=function(){this.vertexShaderCache={};this.fragmentShaderCache={};this._vaoMap=new Map;this.indexBuffer=this.boundVao=null;this.vertexBuffers=[];this.transformFeedbackBuffer=this.feedback=this.activeFramebuffer=this.renderTarget=this.shader=null;this.textureUnit=0;this.textureUnits=[];for(var a=0;a<this.maxCombinedTextures;a++)this.textureUnits.push([null,null,null])};b.loseContext=function(){var a;for(a=0;a<this.shaders.length;a++)this.shaders[a].loseContext();
for(this.destroyGrabPass();0<this.textures.length;)a=this.textures[0],this.destroyTexture(a),a.dirtyAll();for(a=0;a<this.buffers.length;a++)this.buffers[a].loseContext();for(a=0;a<this.targets.length;a++)this.targets[a].loseContext()};b.restoreContext=function(){this.initializeExtensions();this.initializeCapabilities();this.initializeRenderState();this.initializeContextCaches();var a;var c=0;for(a=this.shaders.length;c<a;c++)this.compileAndLinkShader(this.shaders[c]);c=0;for(a=this.buffers.length;c<
a;c++)this.buffers[c].unlock();this.createGrabPass()};b.createGrabPass=function(){if(!this.grabPassTexture){var a=new X(this,{format:!1===this.grabPassApha?6:7,minFilter:1,magFilter:1,addressU:1,addressV:1,mipmaps:!1});a.name="texture_grabPass";var c=this.scope.resolve(a.name);c.setValue(a);this.grabPassRenderTarget=new va({colorBuffer:a,depth:!1});this.grabPassTextureId=c;this.grabPassTexture=a}};b.updateGrabPass=function(){var a=this.gl;if(!this.grabPassAvailable)return!1;var c=this.renderTarget,
e=c&&c._glResolveFrameBuffer,f=this.grabPassTexture,h=this.width,k=this.height;this.webgl2&&!this._tempMacChromeBlitFramebufferWorkaround&&h===f._width&&k===f._height?(e&&c.resolve(!0),e=c?c._glFrameBuffer:null,c=c?c._glResolveFrameBuffer||c._glFrameBuffer:null,this.initRenderTarget(this.grabPassRenderTarget),f=this.grabPassRenderTarget._glFrameBuffer,a.bindFramebuffer(a.READ_FRAMEBUFFER,c),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,f),a.blitFramebuffer(0,0,h,k,0,0,h,k,a.COLOR_BUFFER_BIT,a.NEAREST),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,
e)):(e&&(c.resolve(!0),a.bindFramebuffer(a.FRAMEBUFFER,c._glResolveFrameBuffer)),a.copyTexImage2D(a.TEXTURE_2D,0,f._glFormat,0,0,h,k,0),f._width=h,f._height=k,e&&a.bindFramebuffer(a.FRAMEBUFFER,c._glFrameBuffer));return!0};b.destroyGrabPass=function(){this.grabPassRenderTarget.destroy();this.grabPassTextureId=this.grabPassRenderTarget=null;this.grabPassTexture.destroy();this.grabPassTexture=null};b.updateClientRect=function(){this.clientRect=this.canvas.getBoundingClientRect()};b.setViewport=function(a,
c,e,f){if(this.vx!==a||this.vy!==c||this.vw!==e||this.vh!==f)this.gl.viewport(a,c,e,f),this.vx=a,this.vy=c,this.vw=e,this.vh=f};b.setScissor=function(a,c,e,f){if(this.sx!==a||this.sy!==c||this.sw!==e||this.sh!==f)this.gl.scissor(a,c,e,f),this.sx=a,this.sy=c,this.sw=e,this.sh=f};b.getProgramLibrary=function(){return this.programLib};b.setProgramLibrary=function(a){this.programLib=a};b.setFramebuffer=function(a){this.activeFramebuffer!==a&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,a),this.activeFramebuffer=
a)};b._checkFbo=function(){var a=this.gl;switch(a.checkFramebufferStatus(a.FRAMEBUFFER)){case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case a.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED")}};
b.copyRenderTarget=function(a,c,e,f){var h=this.gl;if(!this.webgl2&&f)return!1;if(e)if(!c){if(!a._colorBuffer)return!1}else if(!a._colorBuffer||!c._colorBuffer||a._colorBuffer._format!==c._colorBuffer._format)return!1;if(f&&(!a._depthBuffer||!c._depthBuffer||a._depthBuffer._format!==c._depthBuffer._format))return!1;if(this.webgl2&&c){var k=this.renderTarget;this.renderTarget=c;this.updateBegin();h.bindFramebuffer(h.READ_FRAMEBUFFER,a?a._glFrameBuffer:null);h.bindFramebuffer(h.DRAW_FRAMEBUFFER,c._glFrameBuffer);
var m=a?a.width:c.width;a=a?a.height:c.height;h.blitFramebuffer(0,0,m,a,0,0,m,a,(e?h.COLOR_BUFFER_BIT:0)|(f?h.DEPTH_BUFFER_BIT:0),h.NEAREST);this.renderTarget=k;h.bindFramebuffer(h.FRAMEBUFFER,k?k._glFrameBuffer:null)}else e=this.getCopyShader(),this.constantTexSource.setValue(a._colorBuffer),Ea(this,c,e);return!0};b.initRenderTarget=function(a){if(!a._glFrameBuffer){a._device=this;var c=this.gl;a._glFrameBuffer=c.createFramebuffer();this.setFramebuffer(a._glFrameBuffer);var e=a._colorBuffer;e&&(e._glTexture||
(e._width=Math.min(e.width,this.maxRenderBufferSize),e._height=Math.min(e.height,this.maxRenderBufferSize),this.setTexture(e,0)),c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,e._cubemap?c.TEXTURE_CUBE_MAP_POSITIVE_X+a._face:c.TEXTURE_2D,e._glTexture,0));var f=a._depthBuffer;f&&this.webgl2?(f._glTexture||(f._width=Math.min(f.width,this.maxRenderBufferSize),f._height=Math.min(f.height,this.maxRenderBufferSize),this.setTexture(f,0)),a._stencil?c.framebufferTexture2D(c.FRAMEBUFFER,c.DEPTH_STENCIL_ATTACHMENT,
f._cubemap?c.TEXTURE_CUBE_MAP_POSITIVE_X+a._face:c.TEXTURE_2D,a._depthBuffer._glTexture,0):c.framebufferTexture2D(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,f._cubemap?c.TEXTURE_CUBE_MAP_POSITIVE_X+a._face:c.TEXTURE_2D,a._depthBuffer._glTexture,0)):!a._depth||1<a._samples&&this.webgl2||(a._glDepthBuffer||(a._glDepthBuffer=c.createRenderbuffer()),c.bindRenderbuffer(c.RENDERBUFFER,a._glDepthBuffer),a._stencil?(c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_STENCIL,a.width,a.height),c.framebufferRenderbuffer(c.FRAMEBUFFER,
c.DEPTH_STENCIL_ATTACHMENT,c.RENDERBUFFER,a._glDepthBuffer)):(c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,a.width,a.height),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,a._glDepthBuffer)),c.bindRenderbuffer(c.RENDERBUFFER,null));this.webgl2&&1<a._samples&&(a._glResolveFrameBuffer=a._glFrameBuffer,a._glFrameBuffer=c.createFramebuffer(),this.setFramebuffer(a._glFrameBuffer),e&&(a._glMsaaColorBuffer||(a._glMsaaColorBuffer=c.createRenderbuffer()),c.bindRenderbuffer(c.RENDERBUFFER,
a._glMsaaColorBuffer),c.renderbufferStorageMultisample(c.RENDERBUFFER,a._samples,e._glInternalFormat,a.width,a.height),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,a._glMsaaColorBuffer)),a._depth&&(a._glMsaaDepthBuffer||(a._glMsaaDepthBuffer=c.createRenderbuffer()),c.bindRenderbuffer(c.RENDERBUFFER,a._glMsaaDepthBuffer),a._stencil?(c.renderbufferStorageMultisample(c.RENDERBUFFER,a._samples,c.DEPTH24_STENCIL8,a.width,a.height),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_STENCIL_ATTACHMENT,
c.RENDERBUFFER,a._glMsaaDepthBuffer)):(c.renderbufferStorageMultisample(c.RENDERBUFFER,a._samples,c.DEPTH_COMPONENT32F,a.width,a.height),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,a._glMsaaDepthBuffer))));this.targets.push(a)}};b.getCopyShader=function(){this._copyShader||(this._copyShader=Ja(this,I.fullscreenQuadVS,I.outputTex2DPS,"outputTex2D"));return this._copyShader};b.updateBegin=function(){this.boundVao=null;if(this._tempEnableSafariTextureUnitWorkaround)for(var a=
0;a<this.textureUnits.length;++a)for(var c=0;3>c;++c)this.textureUnits[a][c]=null;(a=this.renderTarget)?a._glFrameBuffer?this.setFramebuffer(a._glFrameBuffer):this.initRenderTarget(a):this.setFramebuffer(this.defaultFramebuffer)};b.updateEnd=function(){var a=this.gl;this.boundVao=null;this.gl.bindVertexArray(null);var c=this.renderTarget;if(c){var e=c._colorBuffer;e&&e._glTexture&&e.mipmaps&&e.pot&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(e),a.generateMipmap(e._glTarget));
this.webgl2&&1<c._samples&&c.autoResolve&&c.resolve()}};b.initializeTexture=function(a){var c=this.gl;a._glTexture=c.createTexture();a._glTarget=a._cubemap?c.TEXTURE_CUBE_MAP:a._volume?c.TEXTURE_3D:c.TEXTURE_2D;switch(a._format){case 0:a._glFormat=c.ALPHA;a._glInternalFormat=c.ALPHA;a._glPixelType=c.UNSIGNED_BYTE;break;case 1:a._glFormat=c.LUMINANCE;a._glInternalFormat=c.LUMINANCE;a._glPixelType=c.UNSIGNED_BYTE;break;case 2:a._glFormat=c.LUMINANCE_ALPHA;a._glInternalFormat=c.LUMINANCE_ALPHA;a._glPixelType=
c.UNSIGNED_BYTE;break;case 3:a._glFormat=c.RGB;a._glInternalFormat=c.RGB;a._glPixelType=c.UNSIGNED_SHORT_5_6_5;break;case 4:a._glFormat=c.RGBA;a._glInternalFormat=c.RGBA;a._glPixelType=c.UNSIGNED_SHORT_5_5_5_1;break;case 5:a._glFormat=c.RGBA;a._glInternalFormat=c.RGBA;a._glPixelType=c.UNSIGNED_SHORT_4_4_4_4;break;case 6:a._glFormat=c.RGB;a._glInternalFormat=this.webgl2?c.RGB8:c.RGB;a._glPixelType=c.UNSIGNED_BYTE;break;case 7:a._glFormat=c.RGBA;a._glInternalFormat=this.webgl2?c.RGBA8:c.RGBA;a._glPixelType=
c.UNSIGNED_BYTE;break;case 8:var e=this.extCompressedTextureS3TC;a._glFormat=c.RGB;a._glInternalFormat=e.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:e=this.extCompressedTextureS3TC;a._glFormat=c.RGBA;a._glInternalFormat=e.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case 10:e=this.extCompressedTextureS3TC;a._glFormat=c.RGBA;a._glInternalFormat=e.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:e=this.extCompressedTextureETC1;a._glFormat=c.RGB;a._glInternalFormat=e.COMPRESSED_RGB_ETC1_WEBGL;break;case 24:e=this.extCompressedTexturePVRTC;
a._glFormat=c.RGB;a._glInternalFormat=e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case 25:e=this.extCompressedTexturePVRTC;a._glFormat=c.RGBA;a._glInternalFormat=e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:e=this.extCompressedTexturePVRTC;a._glFormat=c.RGB;a._glInternalFormat=e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:e=this.extCompressedTexturePVRTC;a._glFormat=c.RGBA;a._glInternalFormat=e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:e=this.extCompressedTextureETC;a._glFormat=c.RGB;a._glInternalFormat=
e.COMPRESSED_RGB8_ETC2;break;case 23:e=this.extCompressedTextureETC;a._glFormat=c.RGBA;a._glInternalFormat=e.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:e=this.extCompressedTextureASTC;a._glFormat=c.RGBA;a._glInternalFormat=e.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:e=this.extCompressedTextureATC;a._glFormat=c.RGB;a._glInternalFormat=e.COMPRESSED_RGB_ATC_WEBGL;break;case 30:e=this.extCompressedTextureATC;a._glFormat=c.RGBA;a._glInternalFormat=e.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 11:e=
this.extTextureHalfFloat;a._glFormat=c.RGB;this.webgl2?(a._glInternalFormat=c.RGB16F,a._glPixelType=c.HALF_FLOAT):(a._glInternalFormat=c.RGB,a._glPixelType=e.HALF_FLOAT_OES);break;case 12:e=this.extTextureHalfFloat;a._glFormat=c.RGBA;this.webgl2?(a._glInternalFormat=c.RGBA16F,a._glPixelType=c.HALF_FLOAT):(a._glInternalFormat=c.RGBA,a._glPixelType=e.HALF_FLOAT_OES);break;case 13:a._glFormat=c.RGB;a._glInternalFormat=this.webgl2?c.RGB32F:c.RGB;a._glPixelType=c.FLOAT;break;case 14:a._glFormat=c.RGBA;
a._glInternalFormat=this.webgl2?c.RGBA32F:c.RGBA;a._glPixelType=c.FLOAT;break;case 15:a._glFormat=c.RED;a._glInternalFormat=c.R32F;a._glPixelType=c.FLOAT;break;case 16:this.webgl2?(a._glFormat=c.DEPTH_COMPONENT,a._glInternalFormat=c.DEPTH_COMPONENT32F,a._glPixelType=c.FLOAT):(a._glFormat=c.DEPTH_COMPONENT,a._glInternalFormat=c.DEPTH_COMPONENT,a._glPixelType=c.UNSIGNED_SHORT);break;case 17:a._glFormat=c.DEPTH_STENCIL;a._glInternalFormat=c.DEPTH24_STENCIL8;a._glPixelType=c.UNSIGNED_INT_24_8;break;case 18:a._glFormat=
c.RGB;a._glInternalFormat=c.R11F_G11F_B10F;a._glPixelType=c.FLOAT;break;case 19:a._glFormat=c.RGB;a._glInternalFormat=c.SRGB8;a._glPixelType=c.UNSIGNED_BYTE;break;case 20:a._glFormat=c.RGBA,a._glInternalFormat=c.SRGB8_ALPHA8,a._glPixelType=c.UNSIGNED_BYTE}this.textures.push(a)};b.destroyTexture=function(a){if(a._glTexture){var c=this.textures.indexOf(a);-1!==c&&this.textures.splice(c,1);for(var e in this.scope.variables)c=this.scope.variables[e],c.value===a&&(c.value=null);for(e=0;e<this.textureUnits.length;e++){c=
this.textureUnits[e];for(var f=0;f<c.length;f++)c[f]===a._glTexture&&(c[f]=null)}this.gl.deleteTexture(a._glTexture);delete a._glTexture;delete a._glTarget;delete a._glFormat;delete a._glInternalFormat;delete a._glPixelType;this._vram.tex-=a._gpuSize}};b.setUnpackFlipY=function(a){if(this.unpackFlipY!==a){this.unpackFlipY=a;var c=this.gl;c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,a)}};b.setUnpackPremultiplyAlpha=function(a){if(this.unpackPremultiplyAlpha!==a){this.unpackPremultiplyAlpha=a;var c=this.gl;
c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}};b._isBrowserInterface=function(a){return"undefined"!==typeof HTMLCanvasElement&&a instanceof HTMLCanvasElement||"undefined"!==typeof HTMLImageElement&&a instanceof HTMLImageElement||"undefined"!==typeof HTMLVideoElement&&a instanceof HTMLVideoElement||"undefined"!==typeof ImageBitmap&&a instanceof ImageBitmap};b.uploadTexture=function(a){var c=this.gl;if(a._needsUpload||!(a._needsMipmapsUpload&&a._mipmapsUploaded||!a.pot)){for(var e=0,f,h,k=Math.log2(Math.max(a._width,
a._height))+1;a._levels[e]||0===e;){if(a._needsUpload||0!==e){if(e&&(!a._needsMipmapsUpload||!a._mipmaps))break;f=a._levels[e];1==e&&!a._compressed&&a._levels.length<k&&(c.generateMipmap(a._glTarget),a._mipmapsUploaded=!0);if(a._cubemap){var m;if(this._isBrowserInterface(f[0]))for(m=0;6>m;m++)a._levelsUpdated[0][m]&&(h=f[m],h instanceof HTMLImageElement&&(h.width>this.maxCubeMapSize||h.height>this.maxCubeMapSize)&&(h=Om(h,this.maxCubeMapSize),0===e&&(a._width=h.width,a._height=h.height)),this.setUnpackFlipY(!1),
this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),c.texImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+m,e,a._glInternalFormat,a._glFormat,a._glPixelType,h));else for(h=1/Math.pow(2,e),m=0;6>m;m++)if(a._levelsUpdated[0][m]){var n=f[m];a._compressed?c.compressedTexImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+m,e,a._glInternalFormat,Math.max(a._width*h,1),Math.max(a._height*h,1),0,n):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),c.texImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+m,e,a._glInternalFormat,
Math.max(a._width*h,1),Math.max(a._height*h,1),0,a._glFormat,a._glPixelType,n))}}else a._volume?(h=1/Math.pow(2,e),a._compressed?c.compressedTexImage3D(c.TEXTURE_3D,e,a._glInternalFormat,Math.max(a._width*h,1),Math.max(a._height*h,1),Math.max(a._depth*h,1),0,f):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),c.texImage3D(c.TEXTURE_3D,e,a._glInternalFormat,Math.max(a._width*h,1),Math.max(a._height*h,1),Math.max(a._depth*h,1),0,a._glFormat,a._glPixelType,f))):(this._isBrowserInterface(f)?
(f instanceof HTMLImageElement&&(f.width>this.maxTextureSize||f.height>this.maxTextureSize)&&(f=Om(f,this.maxTextureSize),0===e&&(a._width=f.width,a._height=f.height)),this.setUnpackFlipY(a._flipY),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),c.texImage2D(c.TEXTURE_2D,e,a._glInternalFormat,a._glFormat,a._glPixelType,f)):(h=1/Math.pow(2,e),a._compressed?c.compressedTexImage2D(c.TEXTURE_2D,e,a._glInternalFormat,Math.max(a._width*h,1),Math.max(a._height*h,1),0,f):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),
c.texImage2D(c.TEXTURE_2D,e,a._glInternalFormat,Math.max(a._width*h,1),Math.max(a._height*h,1),0,a._glFormat,a._glPixelType,f))),a._mipmapsUploaded=0===e?!1:!0)}e++}if(a._needsUpload)if(a._cubemap)for(e=0;6>e;e++)a._levelsUpdated[0][e]=!1;else a._levelsUpdated[0]=!1;!a._compressed&&a._mipmaps&&a._needsMipmapsUpload&&a.pot&&1===a._levels.length&&(c.generateMipmap(a._glTarget),a._mipmapsUploaded=!0);a._gpuSize&&(this._vram.tex-=a._gpuSize);a._gpuSize=a.gpuSize;this._vram.tex+=a._gpuSize}};b.activeTexture=
function(a){this.textureUnit!==a&&(this.gl.activeTexture(this.gl.TEXTURE0+a),this.textureUnit=a)};b.bindTexture=function(a){var c=a._glTarget;a=a._glTexture;var e=this.textureUnit,f=this.targetToSlot[c];this.textureUnits[e][f]!==a&&(this.gl.bindTexture(c,a),this.textureUnits[e][f]=a)};b.bindTextureOnUnit=function(a,c){var e=a._glTarget;a=a._glTexture;var f=this.targetToSlot[e];this.textureUnits[c][f]!==a&&(this.activeTexture(c),this.gl.bindTexture(e,a),this.textureUnits[c][f]=a)};b.setTextureParameters=
function(a){var c=this.gl,e=a._parameterFlags,f=a._glTarget;if(e&1){var h=a._minFilter;if(!a.pot||!a._mipmaps||a._compressed&&1===a._levels.length)if(2===h||3===h)h=0;else if(4===h||5===h)h=1;c.texParameteri(f,c.TEXTURE_MIN_FILTER,this.glFilter[h])}e&2&&c.texParameteri(f,c.TEXTURE_MAG_FILTER,this.glFilter[a._magFilter]);e&4&&(this.webgl2?c.texParameteri(f,c.TEXTURE_WRAP_S,this.glAddress[a._addressU]):c.texParameteri(f,c.TEXTURE_WRAP_S,this.glAddress[a.pot?a._addressU:1]));e&8&&(this.webgl2?c.texParameteri(f,
c.TEXTURE_WRAP_T,this.glAddress[a._addressV]):c.texParameteri(f,c.TEXTURE_WRAP_T,this.glAddress[a.pot?a._addressV:1]));e&16&&this.webgl2&&c.texParameteri(f,c.TEXTURE_WRAP_R,this.glAddress[a._addressW]);e&32&&this.webgl2&&c.texParameteri(f,c.TEXTURE_COMPARE_MODE,a._compareOnRead?c.COMPARE_REF_TO_TEXTURE:c.NONE);e&64&&this.webgl2&&c.texParameteri(f,c.TEXTURE_COMPARE_FUNC,this.glComparison[a._compareFunc]);e&128&&(e=this.extTextureFilterAnisotropic)&&c.texParameterf(f,e.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,
Math.min(Math.round(a._anisotropy),this.maxAnisotropy)))};b.setTexture=function(a,c){a._glTexture||this.initializeTexture(a);0<a._parameterFlags||a._needsUpload||a._needsMipmapsUpload||a===this.grabPassTexture?(this.activeTexture(c),this.bindTexture(a),a._parameterFlags&&(this.setTextureParameters(a),a._parameterFlags=0),c=!1,a===this.grabPassTexture&&(this.updateGrabPass(),c=!0),c||!a._needsUpload&&!a._needsMipmapsUpload||(this.uploadTexture(a),a._needsUpload=!1,a._needsMipmapsUpload=!1)):this.bindTextureOnUnit(a,
c)};b.createVertexArray=function(a){var c,e=1<a.length;if(e){var f="";for(c=0;c<a.length;c++){var h=a[c];f+=h.id+h.format.renderingingHash}var k=this._vaoMap.get(f)}if(!k){var m=this.gl;k=m.createVertexArray();m.bindVertexArray(k);m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null);for(c=0;c<a.length;c++){h=a[c];m.bindBuffer(m.ARRAY_BUFFER,h.bufferId);var n=h.format.elements;for(var p=0;p<n.length;p++){var t=n[p];var r=Qg[t.name];m.vertexAttribPointer(r,t.numComponents,this.glType[t.dataType],t.normalize,t.stride,
t.offset);m.enableVertexAttribArray(r);h.instancing&&m.vertexAttribDivisor(r,1)}}m.bindVertexArray(null);m.bindBuffer(m.ARRAY_BUFFER,null);e&&this._vaoMap.set(f,k)}return k};b.setBuffers=function(){var a=this.gl;if(1===this.vertexBuffers.length){var c=this.vertexBuffers[0];c._vao||(c._vao=this.createVertexArray(this.vertexBuffers));c=c._vao}else c=this.createVertexArray(this.vertexBuffers);this.boundVao!==c&&(this.boundVao=c,a.bindVertexArray(c));this.vertexBuffers.length=0;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
this.indexBuffer?this.indexBuffer.bufferId:null)};b.draw=function(a,c,e){var f=this.gl,h,k,m,n=this.shader;var p=n.samplers;n=n.uniforms;e||this.setBuffers();var t=0;e=0;for(k=p.length;e<k;e++){var r=p[e];if(m=r.scopeId.value)if(m instanceof X){var u=m;this.setTexture(u,t);r.slot!==t&&(f.uniform1i(r.locationId,t),r.slot=t);t++}else{r.array.length=0;var v=m.length;for(h=0;h<v;h++)u=m[h],this.setTexture(u,t),r.array[h]=t,t++;f.uniform1iv(r.locationId,r.array)}}e=0;for(k=n.length;e<k;e++)if(p=n[e],h=
p.scopeId,r=p.version,m=h.versionObject.version,r.globalId!==m.globalId||r.revision!==m.revision)if(r.globalId=m.globalId,r.revision=m.revision,null!==h.value)this.commitFunction[p.dataType](p,h.value);this.webgl2&&this.transformFeedbackBuffer&&(f.bindBufferBase(f.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.bufferId),f.beginTransformFeedback(f.POINTS));n=this.glPrimitive[a.type];e=a.count;a.indexed?(p=this.indexBuffer,k=p.glFormat,a=a.base*p.bytesPerIndex,0<c?f.drawElementsInstanced(n,
e,k,a,c):f.drawElements(n,e,k,a)):(a=a.base,0<c?f.drawArraysInstanced(n,a,e,c):f.drawArrays(n,a,e));this.webgl2&&this.transformFeedbackBuffer&&(f.endTransformFeedback(),f.bindBufferBase(f.TRANSFORM_FEEDBACK_BUFFER,0,null));this._drawCallsPerFrame++};b.clear=function(a){var c=this.defaultClearOptions;a=a||c;var e=void 0==a.flags?c.flags:a.flags;if(0!==e){var f=this.gl;if(e&1){var h=void 0==a.color?c.color:a.color;this.setClearColor(h[0],h[1],h[2],h[3])}e&2&&(this.setClearDepth(void 0==a.depth?c.depth:
a.depth),this.depthWrite||f.depthMask(!0));e&4&&this.setClearStencil(void 0==a.stencil?c.stencil:a.stencil);f.clear(this.glClearFlag[e]);e&2&&(this.depthWrite||f.depthMask(!1))}};b.readPixels=function(a,c,e,f,h){var k=this.gl;k.readPixels(a,c,e,f,k.RGBA,k.UNSIGNED_BYTE,h)};b.setClearDepth=function(a){a!==this.clearDepth&&(this.gl.clearDepth(a),this.clearDepth=a)};b.setClearColor=function(a,c,e,f){if(a!==this.clearRed||c!==this.clearGreen||e!==this.clearBlue||f!==this.clearAlpha)this.gl.clearColor(a,
c,e,f),this.clearRed=a,this.clearGreen=c,this.clearBlue=e,this.clearAlpha=f};b.setClearStencil=function(a){a!==this.clearStencil&&(this.gl.clearStencil(a),this.clearStencil=a)};b.setRenderTarget=function(a){this.renderTarget=a};b.getRenderTarget=function(){return this.renderTarget};b.getDepthTest=function(){return this.depthTest};b.setDepthTest=function(a){if(this.depthTest!==a){var c=this.gl;a?c.enable(c.DEPTH_TEST):c.disable(c.DEPTH_TEST);this.depthTest=a}};b.setDepthFunc=function(a){this.depthFunc!==
a&&(this.gl.depthFunc(this.glComparison[a]),this.depthFunc=a)};b.getDepthWrite=function(){return this.depthWrite};b.setDepthWrite=function(a){this.depthWrite!==a&&(this.gl.depthMask(a),this.depthWrite=a)};b.setColorWrite=function(a,c,e,f){if(this.writeRed!==a||this.writeGreen!==c||this.writeBlue!==e||this.writeAlpha!==f)this.gl.colorMask(a,c,e,f),this.writeRed=a,this.writeGreen=c,this.writeBlue=e,this.writeAlpha=f};b.setAlphaToCoverage=function(a){this.webgl2&&this.alphaToCoverage!==a&&((this.alphaToCoverage=
a)?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))};b.setTransformFeedbackBuffer=function(a){if(this.transformFeedbackBuffer!==a&&(this.transformFeedbackBuffer=a,this.webgl2)){var c=this.gl;a?(this.feedback||(this.feedback=c.createTransformFeedback()),c.bindTransformFeedback(c.TRANSFORM_FEEDBACK,this.feedback)):c.bindTransformFeedback(c.TRANSFORM_FEEDBACK,null)}};b.setRaster=function(a){this.raster!==a&&(this.raster=a,this.webgl2&&(a?this.gl.disable(this.gl.RASTERIZER_DISCARD):
this.gl.enable(this.gl.RASTERIZER_DISCARD)))};b.setDepthBias=function(a){this.depthBiasEnabled!==a&&((this.depthBiasEnabled=a)?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))};b.setDepthBiasValues=function(a,c){this.gl.polygonOffset(c,a)};b.getBlending=function(){return this.blending};b.setBlending=function(a){if(this.blending!==a){var c=this.gl;a?c.enable(c.BLEND):c.disable(c.BLEND);this.blending=a}};b.setStencilTest=function(a){if(this.stencil!==a){var c=
this.gl;a?c.enable(c.STENCIL_TEST):c.disable(c.STENCIL_TEST);this.stencil=a}};b.setStencilFunc=function(a,c,e){if(this.stencilFuncFront!==a||this.stencilRefFront!==c||this.stencilMaskFront!==e||this.stencilFuncBack!==a||this.stencilRefBack!==c||this.stencilMaskBack!==e)this.gl.stencilFunc(this.glComparison[a],c,e),this.stencilFuncFront=this.stencilFuncBack=a,this.stencilRefFront=this.stencilRefBack=c,this.stencilMaskFront=this.stencilMaskBack=e};b.setStencilFuncFront=function(a,c,e){if(this.stencilFuncFront!==
a||this.stencilRefFront!==c||this.stencilMaskFront!==e){var f=this.gl;f.stencilFuncSeparate(f.FRONT,this.glComparison[a],c,e);this.stencilFuncFront=a;this.stencilRefFront=c;this.stencilMaskFront=e}};b.setStencilFuncBack=function(a,c,e){if(this.stencilFuncBack!==a||this.stencilRefBack!==c||this.stencilMaskBack!==e){var f=this.gl;f.stencilFuncSeparate(f.BACK,this.glComparison[a],c,e);this.stencilFuncBack=a;this.stencilRefBack=c;this.stencilMaskBack=e}};b.setStencilOperation=function(a,c,e,f){if(this.stencilFailFront!==
a||this.stencilZfailFront!==c||this.stencilZpassFront!==e||this.stencilFailBack!==a||this.stencilZfailBack!==c||this.stencilZpassBack!==e)this.gl.stencilOp(this.glStencilOp[a],this.glStencilOp[c],this.glStencilOp[e]),this.stencilFailFront=this.stencilFailBack=a,this.stencilZfailFront=this.stencilZfailBack=c,this.stencilZpassFront=this.stencilZpassBack=e;if(this.stencilWriteMaskFront!==f||this.stencilWriteMaskBack!==f)this.gl.stencilMask(f),this.stencilWriteMaskBack=this.stencilWriteMaskFront=f};b.setStencilOperationFront=
function(a,c,e,f){if(this.stencilFailFront!==a||this.stencilZfailFront!==c||this.stencilZpassFront!==e)this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[a],this.glStencilOp[c],this.glStencilOp[e]),this.stencilFailFront=a,this.stencilZfailFront=c,this.stencilZpassFront=e;this.stencilWriteMaskFront!==f&&(this.gl.stencilMaskSeparate(this.gl.FRONT,f),this.stencilWriteMaskFront=f)};b.setStencilOperationBack=function(a,c,e,f){if(this.stencilFailBack!==a||this.stencilZfailBack!==c||this.stencilZpassBack!==
e)this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[a],this.glStencilOp[c],this.glStencilOp[e]),this.stencilFailBack=a,this.stencilZfailBack=c,this.stencilZpassBack=e;this.stencilWriteMaskBack!==f&&(this.gl.stencilMaskSeparate(this.gl.BACK,f),this.stencilWriteMaskBack=f)};b.setBlendFunction=function(a,c){if(this.blendSrc!==a||this.blendDst!==c||this.separateAlphaBlend)this.gl.blendFunc(this.glBlendFunction[a],this.glBlendFunction[c]),this.blendSrc=a,this.blendDst=c,this.separateAlphaBlend=!1};
b.setBlendFunctionSeparate=function(a,c,e,f){this.blendSrc===a&&this.blendDst===c&&this.blendSrcAlpha===e&&this.blendDstAlpha===f&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[a],this.glBlendFunction[c],this.glBlendFunction[e],this.glBlendFunction[f]),this.blendSrc=a,this.blendDst=c,this.blendSrcAlpha=e,this.blendDstAlpha=f,this.separateAlphaBlend=!0)};b.setBlendEquation=function(a){if(this.blendEquation!==a||this.separateAlphaEquation)this.gl.blendEquation(this.glBlendEquation[a]),
this.blendEquation=a,this.separateAlphaEquation=!1};b.setBlendEquationSeparate=function(a,c){this.blendEquation===a&&this.blendAlphaEquation===c&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[a],this.glBlendEquation[c]),this.blendEquation=a,this.blendAlphaEquation=c,this.separateAlphaEquation=!0)};b.setCullMode=function(a){if(this.cullMode!==a){if(0===a)this.gl.disable(this.gl.CULL_FACE);else{0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);var c=this.glCull[a];
this.cullFace!==c&&(this.gl.cullFace(c),this.cullFace=c)}this.cullMode=a}};b.getCullMode=function(){return this.cullMode};b.setIndexBuffer=function(a){this.indexBuffer=a};b.setVertexBuffer=function(a){a&&this.vertexBuffers.push(a)};b.compileShaderSource=function(a,c){var e=this.gl,f=c?this.vertexShaderCache[a]:this.fragmentShaderCache[a];f||(f=e.createShader(c?e.VERTEX_SHADER:e.FRAGMENT_SHADER),e.shaderSource(f,a),e.compileShader(f),c?this.vertexShaderCache[a]=f:this.fragmentShaderCache[a]=f);return f};
b.compileAndLinkShader=function(a){var c=this.gl,e=a.definition,f,h=e.attributes,k=this.compileShaderSource(e.vshader,!0),m=this.compileShaderSource(e.fshader,!1),n=c.createProgram();c.attachShader(n,k);c.attachShader(n,m);if(this.webgl2&&e.useTransformFeedback){e=[];for(f in h)h.hasOwnProperty(f)&&e.push("out_"+f);c.transformFeedbackVaryings(n,e,c.INTERLEAVED_ATTRIBS)}for(f in h)h.hasOwnProperty(f)&&c.bindAttribLocation(n,Qg[h[f]],f);c.linkProgram(n);a._glVertexShader=k;a._glFragmentShader=m;a._glProgram=
n};b.createShader=function(a){this.compileAndLinkShader(a);this.shaders.push(a)};b.destroyShader=function(a){var c=this.shaders.indexOf(a);-1!==c&&this.shaders.splice(c,1);a._glProgram&&(this.gl.deleteProgram(a._glProgram),a._glProgram=null,this.removeShaderFromCache(a))};b._addLineNumbers=function(a){a=a.split("\n");for(var c=0,e=a.length;c<e;c++)a[c]=c+1+":\t"+a[c];return a.join("\n")};b.postLink=function(a){var c=this.gl,e=a._glVertexShader,f=a._glFragmentShader,h=a._glProgram,k=a.definition;if(!c.getShaderParameter(e,
c.COMPILE_STATUS))return console.error("Failed to compile vertex shader:\n\n"+this._addLineNumbers(k.vshader)+"\n\n"+c.getShaderInfoLog(e)),!1;if(!c.getShaderParameter(f,c.COMPILE_STATUS))return console.error("Failed to compile fragment shader:\n\n"+this._addLineNumbers(k.fshader)+"\n\n"+c.getShaderInfoLog(f)),!1;if(!c.getProgramParameter(h,c.LINK_STATUS))return console.error("Failed to link shader program. Error: "+c.getProgramInfoLog(h)),!1;e=0;for(var m=c.getProgramParameter(h,c.ACTIVE_ATTRIBUTES);e<
m;){f=c.getActiveAttrib(h,e++);var n=c.getAttribLocation(h,f.name);void 0===k.attributes[f.name]&&console.error('Vertex shader attribute "'+f.name+'" is not mapped to a semantic in shader definition.');n=new ti(this,k.attributes[f.name],this.pcUniformType[f.type],n);a.attributes.push(n)}e=0;for(k=c.getProgramParameter(h,c.ACTIVE_UNIFORMS);e<k;)f=c.getActiveUniform(h,e++),n=c.getUniformLocation(h,f.name),n=new ti(this,f.name,this.pcUniformType[f.type],n),f.type===c.SAMPLER_2D||f.type===c.SAMPLER_CUBE||
this.webgl2&&(f.type===c.SAMPLER_2D_SHADOW||f.type===c.SAMPLER_CUBE_SHADOW||f.type===c.SAMPLER_3D)?a.samplers.push(n):a.uniforms.push(n);return a.ready=!0};b.setShader=function(a){if(a!==this.shader){if(!a.ready&&!this.postLink(a))return!1;this.shader=a;this.gl.useProgram(a._glProgram);this.attributesInvalidated=!0}return!0};b.getHdrFormat=function(){return this.textureHalfFloatRenderable?12:this.textureFloatRenderable?14:7};b.getBoneLimit=function(){return this.boneLimit};b.setBoneLimit=function(a){this.boneLimit=
a};b.resizeCanvas=function(a,c){this._width=a;this._height=c;var e=Math.min(this._maxPixelRatio,window.devicePixelRatio);a*=e;c*=e;if(this.canvas.width!==a||this.canvas.height!==c)this.canvas.width=a,this.canvas.height=c,this.fire("resizecanvas",a,c)};b.setResolution=function(a,c){this._width=a;this._height=c;this.canvas.width=a;this.canvas.height=c;this.fire("resizecanvas",a,c)};b.clearShaderCache=function(){var a=this.gl,c;for(c in this.fragmentShaderCache)a.deleteShader(this.fragmentShaderCache[c]),
delete this.fragmentShaderCache[c];for(c in this.vertexShaderCache)a.deleteShader(this.vertexShaderCache[c]),delete this.vertexShaderCache[c];this.programLib.clearCache()};b.clearVertexArrayObjectCache=function(){var a=this.gl;this._vaoMap.forEach(function(c,e,f){a.deleteVertexArray(c)});this._vaoMap.clear()};b.removeShaderFromCache=function(a){this.programLib.removeFromCache(a)};b.destroy=function(){var a=this.gl;this.destroyGrabPass();this.webgl2&&this.feedback&&a.deleteTransformFeedback(this.feedback);
this.clearShaderCache();this.clearVertexArrayObjectCache();this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1);this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1);this.gl=this.canvas=this._contextRestoredHandler=this._contextLostHandler=null};N(d,[{key:"width",get:function(){return this.gl.drawingBufferWidth||this.canvas.width}},{key:"height",get:function(){return this.gl.drawingBufferHeight||this.canvas.height}},{key:"fullscreen",get:function(){return!!document.fullscreenElement},
set:function(a){a?this.gl.canvas.requestFullscreen():document.exitFullscreen()}},{key:"enableAutoInstancing",get:function(){return this._enableAutoInstancing},set:function(a){this._enableAutoInstancing=a&&this.extInstancing}},{key:"maxPixelRatio",get:function(){return this._maxPixelRatio},set:function(a){this._maxPixelRatio=a;this.resizeCanvas(this._width,this._height)}},{key:"textureFloatHighPrecision",get:function(){if(void 0===this._textureFloatHighPrecision){if(this.textureFloatRenderable){var a=
Ja(this,I.fullscreenQuadVS,I.precisionTestPS,"ptest1"),c=Ja(this,I.fullscreenQuadVS,I.precisionTest2PS,"ptest2"),e={format:14,width:1,height:1,mipmaps:!1,minFilter:0,magFilter:0};var f=new X(this,e);f.name="testFHP";var h=new va(this,f,{depth:!1});Ea(this,h,a);e.format=7;a=new X(this,e);a.name="testFHP";e=new va(this,a,{depth:!1});this.constantTexSource.setValue(f);Ea(this,e,c);c=this.activeFramebuffer;this.setFramebuffer(e._glFrameBuffer);var k=new Uint8Array(4);this.readPixels(0,0,1,1,k);this.setFramebuffer(c);
c=k[0]/255/16777216+k[1]/255/65536+k[2]/255/256+k[3]/255;f.destroy();h.destroy();a.destroy();e.destroy();f=0===c}else f=!1;this._textureFloatHighPrecision=f}return this._textureFloatHighPrecision}},{key:"textureHalfFloatUpdatable",get:function(){if(void 0===this._textureHalfFloatUpdatable)if(this.webgl2)this._textureHalfFloatUpdatable=!0;else{var a=this.gl,c=this.extTextureHalfFloat.HALF_FLOAT_OES,e=!0,f=a.createTexture();a.bindTexture(a.TEXTURE_2D,f);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,
a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);var h=new Uint16Array(16);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,2,2,0,a.RGBA,c,h);a.getError()!==a.NO_ERROR&&(e=!1,console.log("Above error related to HALF_FLOAT_OES can be ignored, it was triggered by testing half float texture support"));a.bindTexture(a.TEXTURE_2D,null);a.deleteTexture(f);this._textureHalfFloatUpdatable=
e}return this._textureHalfFloatUpdatable}}]);return d}(ba),sq={depth:!0,face:0},va=function(){function g(b,a,c){b instanceof Ae?(this._colorBuffer=a,b=c):this._colorBuffer=b.colorBuffer;this._glDepthBuffer=this._glFrameBuffer=null;b=void 0!==b?b:sq;this._depthBuffer=b.depthBuffer;this._face=void 0!==b.face?b.face:0;this._depthBuffer?(a=this._depthBuffer._format,16===a?(this._depth=!0,this._stencil=!1):this._stencil=17===a?this._depth=!0:this._depth=!1):(this._depth=void 0!==b.depth?b.depth:!0,this._stencil=
void 0!==b.stencil?b.stencil:!1);this._samples=void 0!==b.samples?b.samples:1;this.autoResolve=void 0!==b.autoResolve?b.autoResolve:!0;this._glMsaaDepthBuffer=this._glMsaaColorBuffer=this._glResolveFrameBuffer=null}var d=g.prototype;d.destroy=function(){if(this._device){var b=this._device,a=b.targets.indexOf(this);-1!==a&&b.targets.splice(a,1);b=b.gl;this._glFrameBuffer&&(b.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null);this._glDepthBuffer&&(b.deleteRenderbuffer(this._glDepthBuffer),
this._glDepthBuffer=null);this._glResolveFrameBuffer&&(b.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null);this._glMsaaColorBuffer&&(b.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null);this._glMsaaDepthBuffer&&(b.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}};d.loseContext=function(){this._glMsaaDepthBuffer=this._glMsaaColorBuffer=this._glResolveFrameBuffer=this._glDepthBuffer=this._glFrameBuffer=void 0};d.resolve=function(b,
a){void 0===b&&(b=!0);void 0===a&&(a=!!this._depthBuffer);if(this._device&&this._device.webgl2){var c=this._device.gl;c.bindFramebuffer(c.READ_FRAMEBUFFER,this._glFrameBuffer);c.bindFramebuffer(c.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer);c.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,(b?c.COLOR_BUFFER_BIT:0)|(a?c.DEPTH_BUFFER_BIT:0),c.NEAREST);c.bindFramebuffer(c.FRAMEBUFFER,this._glFrameBuffer)}};d.copy=function(b,a,c){if(!this._device)if(b._device)this._device=b._device;
else return!1;return this._device.copyRenderTarget(b,this,a,c)};N(g,[{key:"colorBuffer",get:function(){return this._colorBuffer}},{key:"depthBuffer",get:function(){return this._depthBuffer}},{key:"face",get:function(){return this._face}},{key:"width",get:function(){return this._colorBuffer?this._colorBuffer.width:this._depthBuffer.width}},{key:"height",get:function(){return this._colorBuffer?this._colorBuffer.height:this._depthBuffer.height}}]);return g}(),Yn={type:5,base:0,count:4,indexed:!1},Pm=
function(){function g(d){this.device=d;this.depthMap=this.shader=null;this.vertexBuffer=lj(d);this.needsDepthBuffer=!1}g.prototype.render=function(d,b,a){};return g}(),tq=function(){function g(b,a){void 0===a&&(a=3);this.device=b.device;var c=this.device.gl;this._inputBuffer=b;3===a&&b.usage!==a&&(c.bindBuffer(c.ARRAY_BUFFER,b.bufferId),c.bufferData(c.ARRAY_BUFFER,b.storage,c.DYNAMIC_COPY));this._outputBuffer=new Ra(b.device,b.format,b.numVertices,a,b.storage)}g.createShader=function(b,a,c){return Ja(b,
a,null,c,!0)};var d=g.prototype;d.destroy=function(){this._outputBuffer.destroy()};d.process=function(b,a){void 0===a&&(a=!0);var c=this.device;c.setRenderTarget(null);c.updateBegin();c.setVertexBuffer(this._inputBuffer,0);c.setRaster(!1);c.setTransformFeedbackBuffer(this._outputBuffer);c.setShader(b);c.draw({type:0,base:0,count:this._inputBuffer.numVertices,indexed:!1});c.setTransformFeedbackBuffer(null);c.setRaster(!0);c.updateEnd();a&&(b=this._inputBuffer.bufferId,this._inputBuffer.bufferId=this._outputBuffer.bufferId,
this._outputBuffer.bufferId=b,b=this._inputBuffer._vao,this._inputBuffer._vao=this._outputBuffer._vao,this._outputBuffer._vao=b)};N(g,[{key:"inputBuffer",get:function(){return this._inputBuffer}},{key:"outputBuffer",get:function(){return this._outputBuffer}}]);return g}(),Qm=function(g){function d(){return g.call(this)||this}K(d,g);var b=d.prototype;b.clone=function(){var a=new d;Fa.prototype._cloneInternal.call(this,a);return a};b.updateShader=function(a){var c={skin:!!this.meshInstances[0].skinInstance};
this.shader=a.getProgramLibrary().getProgram("depth",c)};return d}(Fa),Rm=function(){function g(b,a,c){b instanceof Ae&&(b=qa.getApplication());this.app=b;var e=this.device=b.graphicsDevice;this.library=e.getProgramLibrary();this.pickColor=new Float32Array(4);this.pickColor[3]=1;this.mapping=[];this.scene=null;this.drawCalls=[];this.layerComp=this.layer=null;this.clearOptions={color:[1,1,1,1],depth:1,flags:3};var f=this;this._clearDepthOptions={depth:1,flags:2};this.clearDepthCommand=new Xg(0,0,function(){e.clear(f._clearDepthOptions)});
this.resize(a,c);this._ignoreOpacityFor=null}var d=g.prototype;d.getSelection=function(b,a,c,e){var f=this.device;"object"===typeof b?(e=b,b=e.x,a=e.y,c=e.width,e=e.height):a=this.layer.renderTarget.height-(a+(e||1));b=Math.floor(b);a=Math.floor(a);c=Math.floor(Math.max(c||1,1));e=Math.floor(Math.max(e||1,1));var h=f.renderTarget;f.setRenderTarget(this.layer.renderTarget);f.updateBegin();var k=new Uint8Array(4*c*e);f.readPixels(b,a,c,e,k);f.updateEnd();f.setRenderTarget(h);b=[];a=this.mapping;for(f=
0;f<c*e;f++){h=k[4*f];var m=k[4*f+1];var n=k[4*f+2];h=h<<16|m<<8|n;16777215!==h&&(h=a[h],-1===b.indexOf(h)&&b.push(h))}return b};d.prepare=function(b,a,c){var e=this.device,f=this;b instanceof be&&(b=b.node.camera);this.scene=a;var h=null,k=null;c instanceof nb?h=c:k=c;if(!this.layer){var m=e.scope.resolve("uColor");this.layer=new nb({name:"Picker",shaderPass:18,opaqueSortMode:0,onEnable:function(){if(!this.renderTarget){var w=new X(e,{format:7,width:f.width,height:f.height,mipmaps:!1});w.name="pick";
w.minFilter=0;w.magFilter=0;w.addressU=1;w.addressV=1;this.renderTarget=new va(e,w,{depth:!0})}},onDisable:function(){this.renderTarget&&(this.renderTarget._colorBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onDrawCall:function(w,y){f.pickColor[0]=(y>>16&255)/255;f.pickColor[1]=(y>>8&255)/255;f.pickColor[2]=(y&255)/255;m.setValue(f.pickColor);e.setBlending(!1);f.mapping[y]=w}});this.layerComp=new yf;this.layerComp.pushOpaque(this.layer);this.meshInstances=this.layer.opaqueMeshInstances;
this._instancesVersion=-1}if(!h){this.layer.clearMeshInstances();c=a.layers.layerList;var n=a.layers.subLayerEnabled,p=a.layers.subLayerList;for(a=0;a<c.length;a++)c[a].overrideClear&&c[a]._clearDepthBuffer&&(c[a]._pickerCleared=!1);for(a=0;a<c.length;a++){var t=c[a];if(t.renderTarget===k&&t.enabled&&n[a]){var r=t.cameras.indexOf(b);if(!(0>r)){t.overrideClear&&t._clearDepthBuffer&&!t._pickerCleared&&(this.meshInstances.push(this.clearDepthCommand),t._pickerCleared=!0);r=(r=p[a])?t.instances.transparentMeshInstances:
t.instances.opaqueMeshInstances;var u=r.length;for(t=0;t<u;t++){var v=r[t];v.pick&&this.meshInstances.push(v)}}}}}else if(this._instancesVersion!==h._version){this.layer.clearMeshInstances();r=h.instances.opaqueMeshInstances;u=r.length;for(t=0;t<u;t++)v=r[t],v.pick&&this.meshInstances.push(v);r=h.instances.transparentMeshInstances;u=r.length;for(t=0;t<u;t++)v=r[t],v.pick&&this.meshInstances.push(v);this._instancesVersion=h._version}this.layer.cameras[0]!==b&&(this.layer.clearCameras(),this.layer.addCamera(b));
this.onLayerPreRender(this.layer,h,k);f.mapping.length=0;this.app.renderer.renderComposition(this.layerComp);this.onLayerPostRender(this.layer)};d.onLayerPreRender=function(b,a,c){if(this.width!==b.renderTarget.width||this.height!==b.renderTarget.height)b.onDisable(),b.onEnable();b.oldClear=b.cameras[0].camera._clearOptions;b.oldAspectMode=b.cameras[0].aspectRatioMode;b.oldAspect=b.cameras[0].aspectRatio;b.cameras[0].camera._clearOptions=this.clearOptions;b.cameras[0].aspectRatioMode=1;b.cameras[0].aspectRatio=
b.cameras[0].calculateAspectRatio(c?c:a?a.renderTarget:null);this.app.renderer.updateCameraFrustum(b.cameras[0].camera)};d.onLayerPostRender=function(b){b.cameras[0].camera._clearOptions=b.oldClear;b.cameras[0].aspectRatioMode=b.oldAspectMode;b.cameras[0].aspectRatio=b.oldAspect};d.resize=function(b,a){this.width=b;this.height=a};N(g,[{key:"renderTarget",get:function(){return this.layer.renderTarget}}]);return g}(),uq=function(g){function d(a,c){void 0===c&&(c={});var e=g.call(this)||this;e.type=
"bitmap";e.app=a;e.intensity=0;e.fontWeight=c.fontWeight||"normal";e.fontSize=parseInt(c.fontSize,10);e.glyphSize=e.fontSize;e.fontName=c.fontName||"Arial";e.color=c.color||new Q(1,1,1);e.padding=c.padding||0;a=4096<c.width?4096:c.width||512;var f=4096<c.height?4096:c.height||512;c=document.createElement("canvas");c.height=f;c.width=a;a=new X(e.app.graphicsDevice,{format:7,autoMipmap:!0});a.name="font";a.setSource(c);a.minFilter=5;a.magFilter=1;a.addressU=1;a.addressV=1;e.textures=[a];e.chars="";
e.data={};return e}K(d,g);var b=d.prototype;b.createTextures=function(a){a=this._normalizeCharsSet(a);if(a.length!==this.chars.length)this._renderAtlas(a);else for(var c=0;c<a.length;c++)if(a[c]!==this.chars[c]){this._renderAtlas(a);break}};b.updateTextures=function(a){a=this._normalizeCharsSet(a);for(var c=[],e=0;e<a.length;e++){var f=a[e];this.data.chars[f]||c.push(f)}0<c.length&&this._renderAtlas(this.chars.concat(c))};b.destroy=function(){for(var a=0;a<this.textures.length;a++)this.textures[a].destroy();
this.fontWeight=this.type=this.textures=this.intensity=this.glyphSize=this.fontSize=this.fontName=this.data=this.color=this.chars=null};b._getAndClearContext=function(a,c){var e=a.width,f=a.height;a=a.getContext("2d",{alpha:!0});a.clearRect(0,0,e,f);a.fillStyle=c;a.fillRect(0,0,e,f);return a};b._colorToRgbString=function(a,c){var e=Math.round(255*a.r),f=Math.round(255*a.g),h=Math.round(255*a.b);return c?"rgba("+e+", "+f+", "+h+", "+a.a+")":"rgb("+e+", "+f+", "+h+")"};b.renderCharacter=function(a,
c,e,f,h){a.fillStyle=h;a.fillText(c,e,f)};b._renderAtlas=function(a){this.chars=a;a=1;var c=this.textures[a-1].getSource(),e=c.width,f=c.height,h=this._colorToRgbString(this.color,!1),k=this.color.a;this.color.a=1/255;var m=this._colorToRgbString(this.color,!0);this.color.a=k;k=this._getAndClearContext(c,m);k.font=this.fontWeight+" "+this.fontSize.toString()+"px "+this.fontName;k.textAlign="center";k.textBaseline="alphabetic";this.data=this._createJson(this.chars,this.fontName,e,f);var n=Eb.getSymbols(this.chars.join("")),
p=this.textures.length,t=0,r=0,u={},v;for(v=0;v<n.length;v++)c=n[v],u[c]=this._getTextMetrics(c),t=Math.max(t,u[c].height),r=Math.max(r,u[c].descent);this.glyphSize=Math.max(this.glyphSize,t);t=this.glyphSize+2*this.padding;var w=this.glyphSize+2*this.padding,y=this.glyphSize/2+this.padding,x=w-r-this.padding,z=0,B=0;for(v=0;v<n.length;v++){c=n[v];var C=Eb.getCodePoint(n[v]),D=this.fontSize;k.font=this.fontWeight+" "+D.toString()+"px "+this.fontName;k.textAlign="center";k.textBaseline="alphabetic";
var G=k.measureText(c).width;G>D&&(D=this.fontSize*this.fontSize/G,k.font=this.fontWeight+" "+D.toString()+"px "+this.fontName,G=this.fontSize);this.renderCharacter(k,c,z+y,B+x,h);this._addChar(this.data,c,C,z,B,t,w,this.padding+(this.glyphSize-G)/2,-this.padding+u[c].descent-r,G,a-1,e,f);z+=t;z+t>e&&(z=0,B+=w,B+w>f&&(this.textures[a-1].upload(),a++,B=0,a>p?(c=document.createElement("canvas"),c.height=f,c.width=e,k=this._getAndClearContext(c,m),C=new X(this.app.graphicsDevice,{format:7,autoMipmap:!0}),
C.name="font-atlas",C.setSource(c),C.minFilter=5,C.magFilter=1,C.addressU=1,C.addressV=1,this.textures.push(C)):(c=this.textures[a-1].getSource(),k=this._getAndClearContext(c,m))))}this.textures[a-1].upload();if(a<p){for(v=a;v<p;v++)this.textures[v].destroy();this.textures.splice(a)}this.fire("render")};b._createJson=function(a,c,e,f){return{version:3,intensity:this.intensity,info:{face:c,width:e,height:f,maps:[{width:e,height:f}]},chars:{}}};b._addChar=function(a,c,e,f,h,k,m,n,p,t,r,u,v){a.info.maps.length<
r+1&&a.info.maps.push({width:u,height:v});u=this.fontSize/32;a.chars[c]={id:e,letter:c,x:f,y:h,width:k,height:m,xadvance:t/u,xoffset:n/u,yoffset:(p+this.padding)/u,scale:u,range:1,map:r,bounds:[0,0,k/u,m/u]}};b._normalizeCharsSet=function(a){var c=this.app.systems.element.getUnicodeConverter();c&&(a=c(a));c={};a=Eb.getSymbols(a);var e;for(e=0;e<a.length;e++){var f=a[e];c[f]||(c[f]=f)}return Object.keys(c).sort()};b._getTextMetrics=function(a){var c=document.createElement("span");c.id="content-span";
c.innerHTML=a;a=document.createElement("div");a.id="content-block";a.style.display="inline-block";a.style.width="1px";a.style.height="0px";var e=document.createElement("div");e.appendChild(c);e.appendChild(a);e.style.font=this.fontName;e.style.fontSize=this.fontSize+"px";document.body.appendChild(e);var f=-1,h=-1,k=-1;try{a.style["vertical-align"]="baseline",f=a.offsetTop-c.offsetTop,a.style["vertical-align"]="bottom",k=a.offsetTop-c.offsetTop,h=k-f}finally{document.body.removeChild(e)}return{ascent:f,
descent:h,height:k}};return d}(ba),vq=function(){function g(){}var d=g.prototype;d.load=function(b,a,c){throw Error("not implemented");};d.open=function(b,a,c){throw Error("not implemented");};d.patch=function(b,a){};return g}(),wq=/^\s*function(?:\s|\s*\/\*.*\*\/\s*)+([^\(\s\/]*)\s*/,ec=function(g){function d(b){var a=g.call(this)||this;var c=a.constructor;a.app=b.app;a.entity=b.entity;a._enabled="boolean"===typeof b.enabled?b.enabled:!0;a._enabledOld=a.enabled;a.__destroyed=!1;a.__attributes={};
a.__attributesRaw=b.attributes||{};a.__scriptType=c;a.__executionOrder=-1;return a}K(d,g);d.__getScriptName=function(b){if("function"===typeof b)return"name"in Function.prototype?b.name:b===Function||b===Function.prototype.constructor?"Function":(b=(""+b).match(wq))?b[1]:void 0};d.prototype.__initializeAttributes=function(b){if(b||this.__attributesRaw){for(var a in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(a)?this[a]=this.__attributesRaw[a]:this.__attributes.hasOwnProperty(a)||
(this.__scriptType.attributes.index[a].hasOwnProperty("default")?this[a]=this.__scriptType.attributes.index[a].default:this[a]=null);this.__attributesRaw=null}};d.extend=function(b){for(var a in b)b.hasOwnProperty(a)&&(this.prototype[a]=b[a])};N(d,[{key:"enabled",get:function(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled},set:function(b){this._enabled=!!b;this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),
this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,ye.scriptMethods.initialize)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,ye.scriptMethods.postInitialize)))}}],[{key:"scriptName",get:function(){return this.__name}},{key:"attributes",get:function(){this.hasOwnProperty("__attributes")||
(this.__attributes=new ad(this));return this.__attributes}}]);return d}(ba);ec.__name=null;var oj=new Set("system entity create destroy swap move scripts _scripts _scriptsIndex _scriptsData enabled _oldState onEnable onDisable onPostStateChange _onSetEnabled _checkState _onBeforeRemove _onInitializeAttributes _onInitialize _onPostInitialize _onUpdate _onPostUpdate _callbacks has get on off fire once hasEvent".split(" ")),Sm={};ad.reservedNames.forEach(function(g,d,b){Sm[g]=1});nj.reservedAttributes=
Sm;var ui=function(g,d){d?(this.key=d.keyCode,this.element=d.target,this.event=d):this.event=this.element=this.key=null},af=new ui,xq={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},vi=function(g){function d(a,c){void 0===c&&(c={});var e=g.call(this)||this;e._element=null;e._keyDownHandler=e._handleKeyDown.bind(F(e));e._keyUpHandler=e._handleKeyUp.bind(F(e));e._keyPressHandler=e._handleKeyPress.bind(F(e));e._keymap={};e._lastmap=
{};a&&e.attach(a);e.preventDefault=c.preventDefault||!1;e.stopPropagation=c.stopPropagation||!1;return e}K(d,g);var b=d.prototype;b.attach=function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("keydown",this._keyDownHandler,!1);this._element.addEventListener("keypress",this._keyPressHandler,!1);this._element.addEventListener("keyup",this._keyUpHandler,!1)};b.detach=function(){this._element.removeEventListener("keydown",this._keyDownHandler);this._element.removeEventListener("keypress",
this._keyPressHandler);this._element.removeEventListener("keyup",this._keyUpHandler);this._element=null};b.toKeyIdentifier=function(a){a=bf(a);var c;if(c=xq[a.toString()])return c;c=a.toString(16).toUpperCase();var e=c.length;for(a=0;a<4-e;a++)c="0"+c;return"U+"+c};b._handleKeyDown=function(a){var c=a.keyCode||a.charCode;void 0!==c&&(c=this.toKeyIdentifier(c),this._keymap[c]=!0,this.fire("keydown",Gg(a)),this.preventDefault&&a.preventDefault(),this.stopPropagation&&a.stopPropagation())};b._handleKeyUp=
function(a){var c=a.keyCode||a.charCode;void 0!==c&&(c=this.toKeyIdentifier(c),delete this._keymap[c],this.fire("keyup",Gg(a)),this.preventDefault&&a.preventDefault(),this.stopPropagation&&a.stopPropagation())};b._handleKeyPress=function(a){this.fire("keypress",Gg(a));this.preventDefault&&a.preventDefault();this.stopPropagation&&a.stopPropagation()};b.update=function(){for(var a in this._lastmap)delete this._lastmap[a];for(a in this._keymap)this._keymap.hasOwnProperty(a)&&(this._lastmap[a]=this._keymap[a])};
b.isPressed=function(a){a=bf(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]};b.wasPressed=function(a){a=bf(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]&&!this._lastmap[a]};b.wasReleased=function(a){a=bf(a);a=this.toKeyIdentifier(a);return!this._keymap[a]&&!!this._lastmap[a]};return d}(ba),Wc=function a(d,b){var c={x:0,y:0};if(b){if(b instanceof a)throw Error("Expected MouseEvent");c=d._getTargetCoords(b)}else b={};if(c)this.x=c.x,this.y=c.y;else if(Hg())this.y=this.x=0;else return;this.wheelDelta=
0;"wheel"===b.type&&(0<b.deltaY?this.wheelDelta=1:0>b.deltaY&&(this.wheelDelta=-1));Hg()?(this.dx=b.movementX||b.webkitMovementX||b.mozMovementX||0,this.dy=b.movementY||b.webkitMovementY||b.mozMovementY||0):(this.dx=this.x-d._lastX,this.dy=this.y-d._lastY);this.button="mousedown"===b.type||"mouseup"===b.type?b.button:-1;this.buttons=d._buttons.slice(0);this.element=b.target;this.ctrlKey=b.ctrlKey||!1;this.altKey=b.altKey||!1;this.shiftKey=b.shiftKey||!1;this.metaKey=b.metaKey||!1;this.event=b},Id=
function(d){function b(c){var e=d.call(this)||this;e._lastX=0;e._lastY=0;e._buttons=[!1,!1,!1];e._lastbuttons=[!1,!1,!1];e._upHandler=e._handleUp.bind(F(e));e._downHandler=e._handleDown.bind(F(e));e._moveHandler=e._handleMove.bind(F(e));e._wheelHandler=e._handleWheel.bind(F(e));e._contextMenuHandler=function(f){f.preventDefault()};e._target=null;e._attached=!1;e.attach(c);return e}K(b,d);b.isPointerLocked=function(){return Hg()};var a=b.prototype;a.attach=function(c){this._target=c;this._attached||
(this._attached=!0,c=za.passiveEvents?{passive:!1}:!1,window.addEventListener("mouseup",this._upHandler,c),window.addEventListener("mousedown",this._downHandler,c),window.addEventListener("mousemove",this._moveHandler,c),window.addEventListener("wheel",this._wheelHandler,c))};a.detach=function(){if(this._attached){this._attached=!1;this._target=null;var c=za.passiveEvents?{passive:!1}:!1;window.removeEventListener("mouseup",this._upHandler,c);window.removeEventListener("mousedown",this._downHandler,
c);window.removeEventListener("mousemove",this._moveHandler,c);window.removeEventListener("wheel",this._wheelHandler,c)}};a.disableContextMenu=function(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)};a.enableContextMenu=function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)};a.enablePointerLock=function(c,e){if(document.body.requestPointerLock){var f=function m(){c();document.removeEventListener("pointerlockchange",
m)},h=function n(){e();document.removeEventListener("pointerlockerror",n)};c&&document.addEventListener("pointerlockchange",f,!1);e&&document.addEventListener("pointerlockerror",h,!1);document.body.requestPointerLock()}else e&&e()};a.disablePointerLock=function(c){if(document.exitPointerLock){var e=function h(){c();document.removeEventListener("pointerlockchange",h)};c&&document.addEventListener("pointerlockchange",e,!1);document.exitPointerLock()}};a.update=function(){this._lastbuttons[0]=this._buttons[0];
this._lastbuttons[1]=this._buttons[1];this._lastbuttons[2]=this._buttons[2]};a.isPressed=function(c){return this._buttons[c]};a.wasPressed=function(c){return this._buttons[c]&&!this._lastbuttons[c]};a.wasReleased=function(c){return!this._buttons[c]&&this._lastbuttons[c]};a._handleUp=function(c){this._buttons[c.button]=!1;c=new Wc(this,c);c.event&&this.fire("mouseup",c)};a._handleDown=function(c){this._buttons[c.button]=!0;c=new Wc(this,c);c.event&&this.fire("mousedown",c)};a._handleMove=function(c){c=
new Wc(this,c);c.event&&(this.fire("mousemove",c),this._lastX=c.x,this._lastY=c.y)};a._handleWheel=function(c){c=new Wc(this,c);c.event&&this.fire("mousewheel",c)};a._getTargetCoords=function(c){var e=this._target.getBoundingClientRect(),f=Math.floor(e.left);e=Math.floor(e.top);return c.clientX<f||c.clientX>=f+this._target.clientWidth||c.clientY<e||c.clientY>=e+this._target.clientHeight?null:{x:c.clientX-f,y:c.clientY-e}};return b}(ba),Tm=function(){function d(a,c){void 0===c&&(c={});this._keyboard=
c.keyboard||null;this._mouse=c.mouse||null;this._gamepads=c.gamepads||null;this._element=null;this._actions={};this._axes={};this._axesValues={};a&&this.attach(a)}var b=d.prototype;b.attach=function(a){this._element=a;this._keyboard&&this._keyboard.attach(a);this._mouse&&this._mouse.attach(a)};b.detach=function(){this._keyboard&&this._keyboard.detach();this._mouse&&this._mouse.detach();this._element=null};b.disableContextMenu=function(){this._mouse||this._enableMouse();this._mouse.disableContextMenu()};
b.enableContextMenu=function(){this._mouse||this._enableMouse();this._mouse.enableContextMenu()};b.update=function(a){this._keyboard&&this._keyboard.update(a);this._mouse&&this._mouse.update(a);this._gamepads&&this._gamepads.update(a);this._axesValues={};for(var c in this._axes)this._axesValues[c]=[]};b.registerKeys=function(a,c){this._keyboard||this._enableKeyboard();if(this._actions[a])throw Error("Action: "+a+" already registered");if(void 0===c)throw Error("Invalid button");c.length||(c=[c]);
this._actions[a]?this._actions[a].push({type:"keyboard",keys:c}):this._actions[a]=[{type:"keyboard",keys:c}]};b.registerMouse=function(a,c){this._mouse||this._enableMouse();if(void 0===c)throw Error("Invalid button");this._actions[a]?this._actions[a].push({type:"mouse",button:c}):this._actions[a]=[{type:"mouse",button:-c}]};b.registerPadButton=function(a,c,e){if(void 0===e)throw Error("Invalid button");this._actions[a]?this._actions[a].push({type:"gamepad",button:e,pad:c}):this._actions[a]=[{type:"gamepad",
button:e,pad:c}]};b.registerAxis=function(a){var c=a.name;this._axes[c]||(this._axes[c]=[]);var e=this._axes[c].push(c);a=a||{};a.pad=a.pad||0;var f=function(h,k,m,n){switch(k){case "mousex":h._mouse.on("mousemove",function(p){h._axesValues[c][e]=p.dx/10});break;case "mousey":h._mouse.on("mousemove",function(p){h._axesValues[c][e]=p.dy/10});break;case "key":h._axes[c].push(function(){return h._keyboard.isPressed(n)?m:0});break;case "padrx":h._axes[c].push(function(){return h._gamepads.getAxis(a.pad,
2)});break;case "padry":h._axes[c].push(function(){return h._gamepads.getAxis(a.pad,3)});break;case "padlx":h._axes[c].push(function(){return h._gamepads.getAxis(a.pad,0)});break;case "padly":h._axes[c].push(function(){return h._gamepads.getAxis(a.pad,1)});break;default:throw Error("Unknown axis");}};f(this,a.positive,1,a.positiveKey);(a.negativeKey||a.negative!==a.positive)&&f(this,a.negative,-1,a.negativeKey)};b.isPressed=function(a){if(!this._actions[a])return!1;var c,e=this._actions[a].length;
for(c=0;c<e;++c){var f=this._actions[a][c];switch(f.type){case "keyboard":if(this._keyboard){var h,k=f.keys.length;for(h=0;h<k;h++)if(this._keyboard.isPressed(f.keys[h]))return!0}break;case "mouse":if(this._mouse&&this._mouse.isPressed(f.button))return!0;break;case "gamepad":if(this._gamepads&&this._gamepads.isPressed(f.pad,f.button))return!0}}return!1};b.wasPressed=function(a){if(!this._actions[a])return!1;var c,e=this._actions[a].length;for(c=0;c<e;++c){var f=this._actions[a][c];switch(f.type){case "keyboard":if(this._keyboard){var h,
k=f.keys.length;for(h=0;h<k;h++)if(this._keyboard.wasPressed(f.keys[h]))return!0}break;case "mouse":if(this._mouse&&this._mouse.wasPressed(f.button))return!0;break;case "gamepad":if(this._gamepads&&this._gamepads.wasPressed(f.pad,f.button))return!0}}return!1};b.getAxis=function(a){var c=0;if(this._axes[a]){var e,f=this._axes[a].length;for(e=0;e<f;e++)if("function"===cc(this._axes[a][e])){var h=this._axes[a][e]();Math.abs(h)>Math.abs(c)&&(c=h)}else this._axesValues[a]&&Math.abs(this._axesValues[a][e])>
Math.abs(c)&&(c=this._axesValues[a][e])}return c};b._enableMouse=function(){this._mouse=new Id;if(!this._element)throw Error("Controller must be attached to an Element");this._mouse.attach(this._element)};b._enableKeyboard=function(){this._keyboard=new vi;if(!this._element)throw Error("Controller must be attached to an Element");this._keyboard.attach(this._element)};return d}(),ub,sc,Um=new A,Vm=new A,tc=new Ec,Wm=new Ec,wi=new Ec;tc.end=new A;Wm.end=new A;wi.end=new A;var bd=new A,cf=new A,Ig=new A,
qj=new A,Jg=new A,df=new A,rj=new A,xi=new S,Be=new A,dg=new A,eg=new A,Ce=new A,Xm=new A,Ym=new A,Zm=new A,$m=new A,yq=new Z,fg=function(){function d(b,a,c){this.event=b;this.element=a;this.camera=c;this._stopPropagation=!1}d.prototype.stopPropagation=function(){this._stopPropagation=!0;this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())};return d}(),De=function(d){function b(a,c,e,f,h,k,m){c=d.call(this,a,c,e)||this;c.x=f;c.y=h;c.ctrlKey=a.ctrlKey||!1;c.altKey=a.altKey||
!1;c.shiftKey=a.shiftKey||!1;c.metaKey=a.metaKey||!1;c.button=a.button;Id.isPointerLocked()?(c.dx=a.movementX||a.webkitMovementX||a.mozMovementX||0,c.dy=a.movementY||a.webkitMovementY||a.mozMovementY||0):(c.dx=f-k,c.dy=h-m);c.wheelDelta=0;"wheel"===a.type&&(0<a.deltaY?c.wheelDelta=1:0>a.deltaY&&(c.wheelDelta=-1));return c}K(b,d);return b}(fg),Jd=function(d){function b(a,c,e,f,h,k){c=d.call(this,a,c,e)||this;c.touches=a.touches;c.changedTouches=a.changedTouches;c.x=f;c.y=h;c.touch=k;return c}K(b,d);
return b}(fg),uc=function(d){function b(a,c,e,f){a=d.call(this,a,c,e)||this;a.inputSource=f;return a}K(b,d);return b}(fg),an=function(){function d(a,c){this._app=null;this._attached=!1;this._target=null;this._enabled=!0;this._lastY=this._lastX=0;this._upHandler=this._handleUp.bind(this);this._downHandler=this._handleDown.bind(this);this._moveHandler=this._handleMove.bind(this);this._wheelHandler=this._handleWheel.bind(this);this._touchstartHandler=this._handleTouchStart.bind(this);this._touchcancelHandler=
this._touchendHandler=this._handleTouchEnd.bind(this);this._touchmoveHandler=this._handleTouchMove.bind(this);this._sortHandler=this._sortElements.bind(this);this._elements=[];this._pressedElement=this._hoveredElement=null;this._touchedElements={};this._touchesForWhichTouchLeaveHasFired={};this._selectedElements={};this._selectedPressedElements={};this._useMouse=!c||!1!==c.useMouse;this._useTouch=!c||!1!==c.useTouch;this._useXr=!c||!1!==c.useXr;this._selectEventsAttached=!1;za.touch&&(this._clickedEntities=
{});this.attach(a)}var b=d.prototype;b.attach=function(a){this._attached&&(this._attached=!1,this.detach());this._target=a;this._attached=!0;a=za.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.addEventListener("mouseup",this._upHandler,a),window.addEventListener("mousedown",this._downHandler,a),window.addEventListener("mousemove",this._moveHandler,a),window.addEventListener("wheel",this._wheelHandler,a));this._useTouch&&za.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,
a),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1));this.attachSelectEvents()};b.attachSelectEvents=function(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))};b.detach=function(){if(this._attached){this._attached=
!1;var a=za.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,a),window.removeEventListener("mousedown",this._downHandler,a),window.removeEventListener("mousemove",this._moveHandler,a),window.removeEventListener("wheel",this._wheelHandler,a));this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,a),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,
!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1));this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this));this._target=null}};b.addElement=function(a){-1===
this._elements.indexOf(a)&&this._elements.push(a)};b.removeElement=function(a){a=this._elements.indexOf(a);-1!==a&&this._elements.splice(a,1)};b._handleUp=function(a){this._enabled&&!Id.isPointerLocked()&&(this._calcMouseCoords(a),null!==ub&&this._onElementMouseEvent("mouseup",a))};b._handleDown=function(a){this._enabled&&!Id.isPointerLocked()&&(this._calcMouseCoords(a),null!==ub&&this._onElementMouseEvent("mousedown",a))};b._handleMove=function(a){this._enabled&&(this._calcMouseCoords(a),null!==
ub&&(this._onElementMouseEvent("mousemove",a),this._lastX=ub,this._lastY=sc))};b._handleWheel=function(a){this._enabled&&(this._calcMouseCoords(a),null!==ub&&this._onElementMouseEvent("mousewheel",a))};b._determineTouchedElements=function(a){var c={},e=this.app.systems.camera.cameras,f,h;for(f=e.length-1;0<=f;f--){var k=e[f],m=0;var n=0;for(h=a.changedTouches.length;n<h;n++)if(c[a.changedTouches[n].identifier])m++;else{var p=this._calcTouchCoords(a.changedTouches[n]),t=this._getTargetElement(k,p.x,
p.y);t&&(m++,c[a.changedTouches[n].identifier]={element:t,camera:k,x:p.x,y:p.y})}if(m===h)break}return c};b._handleTouchStart=function(a){if(this._enabled){for(var c=this._determineTouchedElements(a),e=0,f=a.changedTouches.length;e<f;e++){var h=a.changedTouches[e],k=c[h.identifier],m=this._touchedElements[h.identifier];!k||m&&k.element===m.element||(this._fireEvent(a.type,new Jd(a,k.element,k.camera,k.x,k.y,h)),this._touchesForWhichTouchLeaveHasFired[h.identifier]=!1)}for(var n in c)this._touchedElements[n]=
c[n]}};b._handleTouchEnd=function(a){if(this._enabled){var c=this.app.systems.camera.cameras;for(e in this._clickedEntities)delete this._clickedEntities[e];var e=0;for(var f=a.changedTouches.length;e<f;e++){var h=a.changedTouches[e],k=this._touchedElements[h.identifier];if(k){var m=k.element,n=k.camera,p=k.x;k=k.y;delete this._touchedElements[h.identifier];delete this._touchesForWhichTouchLeaveHasFired[h.identifier];this._fireEvent(a.type,new Jd(a,m,n,p,k,h));if(0===a.touches.length)for(var t=this._calcTouchCoords(h),
r=c.length-1;0<=r;r--)this._getTargetElement(c[r],t.x,t.y)!==m||this._clickedEntities[m.entity.getGuid()]||(this._fireEvent("click",new Jd(a,m,n,p,k,h)),this._clickedEntities[m.entity.getGuid()]=!0)}}}};b._handleTouchMove=function(a){a.preventDefault();if(this._enabled)for(var c=this._determineTouchedElements(a),e=0,f=a.changedTouches.length;e<f;e++){var h=a.changedTouches[e],k=c[h.identifier],m=this._touchedElements[h.identifier];if(m){var n=this._calcTouchCoords(h);k&&k.element===m.element||this._touchesForWhichTouchLeaveHasFired[h.identifier]||
(this._fireEvent("touchleave",new Jd(a,m.element,m.camera,n.x,n.y,h)),this._touchesForWhichTouchLeaveHasFired[h.identifier]=!0);this._fireEvent("touchmove",new Jd(a,m.element,m.camera,n.x,n.y,h))}}};b._onElementMouseEvent=function(a,c){var e,f=this._hoveredElement;this._hoveredElement=null;for(var h=this.app.systems.camera.cameras,k,m=h.length-1;0<=m&&!(k=h[m],e=this._getTargetElement(k,ub,sc));m--);e&&(this._fireEvent(a,new De(c,e,k,ub,sc,this._lastX,this._lastY)),this._hoveredElement=e,"mousedown"===
a&&(this._pressedElement=e));f!==this._hoveredElement&&(f&&this._fireEvent("mouseleave",new De(c,f,k,ub,sc,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new De(c,this._hoveredElement,k,ub,sc,this._lastX,this._lastY)));"mouseup"===a&&this._pressedElement&&(this._pressedElement===this._hoveredElement?(this._pressedElement=null,this._clickedEntities&&this._clickedEntities[this._hoveredElement.entity.getGuid()]||this._fireEvent("click",new De(c,this._hoveredElement,k,ub,
sc,this._lastX,this._lastY))):this._pressedElement=null)};b._onXrStart=function(){this.app.xr.on("end",this._onXrEnd,this);this.app.xr.on("update",this._onXrUpdate,this);this.app.xr.input.on("selectstart",this._onSelectStart,this);this.app.xr.input.on("selectend",this._onSelectEnd,this);this.app.xr.input.on("remove",this._onXrInputRemove,this)};b._onXrEnd=function(){this.app.xr.off("update",this._onXrUpdate,this);this.app.xr.input.off("selectstart",this._onSelectStart,this);this.app.xr.input.off("selectend",
this._onSelectEnd,this);this.app.xr.input.off("remove",this._onXrInputRemove,this)};b._onXrUpdate=function(){if(this._enabled)for(var a=this.app.xr.input.inputSources,c=0;c<a.length;c++)this._onElementSelectEvent("selectmove",a[c],null)};b._onXrInputRemove=function(a){var c=this._selectedElements[a.id];c&&(a._elementEntity=null,this._fireEvent("selectleave",new uc(null,c,null,a)));delete this._selectedElements[a.id];delete this._selectedPressedElements[a.id]};b._onSelectStart=function(a,c){this._enabled&&
this._onElementSelectEvent("selectstart",a,c)};b._onSelectEnd=function(a,c){this._enabled&&this._onElementSelectEvent("selectend",a,c)};b._onElementSelectEvent=function(a,c,e){var f,h=this._selectedElements[c.id],k=this.app.systems.camera.cameras;if(c.elementInput){wi.set(c.getOrigin(),c.getDirection());for(var m=k.length-1;0<=m;m--){var n=k[m];if(f=this._getTargetElementByRay(wi,n))break}}c._elementEntity=f||null;if(f)var p=this._selectedElements[c.id]=f;else delete this._selectedElements[c.id];
h!==p&&(h&&this._fireEvent("selectleave",new uc(e,h,n,c)),p&&this._fireEvent("selectenter",new uc(e,p,n,c)));"selectstart"===a&&(this._selectedPressedElements[c.id]=p)&&this._fireEvent("selectstart",new uc(e,p,n,c));f=this._selectedPressedElements[c.id];!c.elementInput&&f&&(delete this._selectedPressedElements[c.id],h&&this._fireEvent("selectend",new uc(e,h,n,c)));"selectend"===a&&c.elementInput&&(delete this._selectedPressedElements[c.id],h&&this._fireEvent("selectend",new uc(e,h,n,c)),f&&f===h&&
this._fireEvent("click",new uc(e,f,n,c)))};b._fireEvent=function(a,c){for(var e=c.element;;){e.fire(a,c);if(c._stopPropagation)break;if(!e.entity.parent)break;e=e.entity.parent.element;if(!e)break}};b._calcMouseCoords=function(a){var c=this._target.getBoundingClientRect(),e=Math.floor(c.left);c=Math.floor(c.top);a.clientX<e||a.clientX>=e+this._target.clientWidth||a.clientY<c||a.clientY>=c+this._target.clientHeight?sc=ub=null:(ub=a.clientX-e,sc=a.clientY-c)};b._calcTouchCoords=function(a){for(var c=
0,e=0,f=a.target;!(f instanceof HTMLElement);)f=f.parentNode;do c+=f.offsetLeft-f.scrollLeft,e+=f.offsetTop-f.scrollTop,f=f.offsetParent;while(f);return{x:a.pageX-c,y:a.pageY-e}};b._sortElements=function(a,c){var e=this.app.scene.layers.sortTransparentLayers(a.layers,c.layers);return 0!==e?e:a.screen&&!c.screen?-1:!a.screen&&c.screen?1:a.screen||c.screen?a.screen.screen.screenSpace&&!c.screen.screen.screenSpace?-1:c.screen.screen.screenSpace&&!a.screen.screen.screenSpace?1:c.drawOrder-a.drawOrder:
0};b._getTargetElement=function(a,c,e){var f=null;this._elements.sort(this._sortHandler);for(var h,k,m=0,n=this._elements.length;m<n;m++){var p=this._elements[m],t=!1;if(p.screen&&p.screen.screen.screenSpace){void 0===h&&(h=tc,!1===this._calculateRayScreen(c,e,a,h)&&(h=null));var r=h;t=!0}else void 0===k&&(k=Wm,!1===this._calculateRay3d(c,e,a,k)&&(k=null)),r=k;if(r&&this._checkElement(r,p,t)){f=p;break}}return f};b._getTargetElementByRay=function(a,c){var e=null;tc.origin.copy(a.origin);tc.direction.copy(a.direction);
tc.end.copy(tc.direction).scale(2*c.farClip).add(tc.origin);this._elements.sort(this._sortHandler);a=0;for(c=this._elements.length;a<c;a++){var f=this._elements[a];if((!f.screen||!f.screen.screen.screenSpace)&&this._checkElement(tc,f,!1)){e=f;break}}return e};b._buildHitCorners=function(a,c,e,f){if(a.entity&&a.entity.button){var h=a.entity.button.hitPadding||yq;Be.copy(a.entity.up);dg.copy(Be).scale(-1);Ce.copy(a.entity.right);eg.copy(Ce).scale(-1);Be.scale(h.w*f);dg.scale(h.y*f);Ce.scale(h.z*e);
eg.scale(h.x*e);Xm.copy(c[0]).add(dg).add(eg);Ym.copy(c[1]).add(dg).add(Ce);Zm.copy(c[2]).add(Be).add(Ce);$m.copy(c[3]).add(Be).add(eg);c=[Xm,Ym,Zm,$m]}return c};b._calculateScaleToScreen=function(a){var c=a.entity;a=a.screen.screen.scale;for(xi.set(a,a);c&&!c.screen;)xi.mul(c.getLocalScale()),c=c.parent;return xi};b._calculateRayScreen=function(a,c,e,f){var h=this.app.graphicsDevice.width,k=this.app.graphicsDevice.height,m=e.rect.z*h,n=e.rect.w*k,p=e.rect.x*h;e=(1-e.rect.y)*k;var t=e-n;a=a*h/this._target.clientWidth;
c=c*k/this._target.clientHeight;return a>=p&&a<=p+m&&c<=e&&c>=t?(f.origin.set(h*(a-p)/m,k-k*(c-t)/n,1),f.direction.set(0,0,-1),f.end.copy(f.direction).scale(2).add(f.origin),!0):!1};b._calculateRay3d=function(a,c,e,f){var h=this._target.clientWidth,k=this._target.clientHeight,m=e.rect.z*h,n=e.rect.w*k,p=e.rect.x*h,t=(1-e.rect.y)*k,r=t-n,u=c;return a>=p&&a<=p+m&&c<=t&&u>=r?(a=h*(a-p)/m,u=k*(u-r)/n,e.screenToWorld(a,u,e.nearClip,Um),e.screenToWorld(a,u,e.farClip,Vm),f.origin.copy(Um),f.direction.set(0,
0,-1),f.end.copy(Vm),!0):!1};b._checkElement=function(a,c,e){if(c.maskedBy&&!this._checkElement(a,c.maskedBy.element,e))return!1;var f=e?this._calculateScaleToScreen(c):c.entity.getWorldTransform().getScale();c=this._buildHitCorners(c,e?c.screenCorners:c.worldCorners,f.x,f.y);return Zn(a.origin,a.end,c)?!0:!1};N(d,[{key:"enabled",get:function(){return this._enabled},set:function(a){this._enabled=a}},{key:"app",get:function(){return this._app||qa.getApplication()},set:function(a){this._app=a}}]);return d}(),
bn={DEFAULT:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_3 PAD_FACE_4 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_4 PAD_FACE_3 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),
axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},cn={"Product: 0268":"PS3"},dn=function(){function d(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads;this.current=[];this.previous=[];this.deadZone=.25}var b=d.prototype;b.update=function(){var a,c;var e=0;for(c=this.current.length;e<c;e++){var f=this.current[e].pad.buttons;var h=f.length;for(a=0;a<h;a++)void 0===this.previous[e]&&(this.previous[e]=[]),this.previous[e][a]=f[a].pressed}this.poll(this.current)};
b.poll=function(a){void 0===a&&(a=[]);0<a.length&&(a.length=0);if(this.gamepadsSupported){var c=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads(),e,f=c.length;for(e=0;e<f;e++)c[e]&&a.push({map:this.getMap(c[e]),pad:c[e]})}return a};b.getMap=function(a){for(var c in cn)if(0<=a.id.indexOf(c))return bn[cn[c]];return bn.DEFAULT};b.isPressed=function(a,c){return this.current[a]?this.current[a].pad.buttons[pc[this.current[a].map.buttons[c]]].pressed:!1};b.wasPressed=function(a,
c){if(!this.current[a])return!1;c=pc[this.current[a].map.buttons[c]];return this.current[a].pad.buttons[c].pressed&&!this.previous[a][c]};b.getAxis=function(a,c){if(!this.current[a])return 0;a=this.current[a].pad.axes[pc[this.current[a].map.axes[c]]];Math.abs(a)<this.deadZone&&(a=0);return a};return d}(),gg=function(d){var b=Kg(d);this.id=d.identifier;this.x=b.x;this.y=b.y;this.target=d.target;this.touch=d},Kd=function(){function d(b,a){this.element=a.target;this.event=a;this.touches=[];this.changedTouches=
[];if(a){var c=a.touches.length;for(b=0;b<c;b++)this.touches.push(new gg(a.touches[b]));c=a.changedTouches.length;for(b=0;b<c;b++)this.changedTouches.push(new gg(a.changedTouches[b]))}}d.prototype.getTouchById=function(b,a){var c,e=a.length;for(c=0;c<e;c++)if(a[c].id===b)return a[c];return null};return d}(),en=function(d){function b(c){var e=d.call(this)||this;e._element=null;e._startHandler=e._handleTouchStart.bind(F(e));e._endHandler=e._handleTouchEnd.bind(F(e));e._moveHandler=e._handleTouchMove.bind(F(e));
e._cancelHandler=e._handleTouchCancel.bind(F(e));e.attach(c);return e}K(b,d);var a=b.prototype;a.attach=function(c){this._element&&this.detach();this._element=c;this._element.addEventListener("touchstart",this._startHandler,!1);this._element.addEventListener("touchend",this._endHandler,!1);this._element.addEventListener("touchmove",this._moveHandler,!1);this._element.addEventListener("touchcancel",this._cancelHandler,!1)};a.detach=function(){this._element&&(this._element.removeEventListener("touchstart",
this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1));this._element=null};a._handleTouchStart=function(c){this.fire("touchstart",new Kd(this,c))};a._handleTouchEnd=function(c){this.fire("touchend",new Kd(this,c))};a._handleTouchMove=function(c){c.preventDefault();this.fire("touchmove",new Kd(this,c))};a._handleTouchCancel=function(c){this.fire("touchcancel",
new Kd(this,c))};return b}(ba),fn=function(){},Ca=[null,null],yi=null,gn,ab=new Z,Ee=new Float32Array(4),Cb=[],Fe=!1,zi=!1,Ai=!1,$n=/uniform[ \t\n\r]+\S+[ \t\n\r]+\S+[ \t\n\r]*;/g,ao=/\S+[ \t\n\r]*;/,bo=/[ \t\n\r]*;/,zq=/(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^;]+[ \t\n\r]*,*)+;/g,Aq=/(float|int|bool|vec2|vec3|vec4|struct|,|;|\{|\})/g,Bq=/(uniform|varying|in|out)[ \t\n\r]+(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^;]+[ \t\n\r]*,*)+;/g,Cq=/(float|int|bool|vec2|vec3|vec4|struct|uniform|varying|in|out|,|;|\{|\})/g,
Dq=/#version/g,Eq=/out highp vec4 pc_fragColor;/g,Fq=/#define gl_FragColor/g,Gq=/gl_FragColor/g,Hq=/uniform[ \t\n\r]+sampler2D[ \t\n\r]+uColorBuffer;/g,Iq=/(varying|in)[ \t\n\r]+vec2[ \t\n\r]+vUv0;/g,Jq=/(texture2D|texture)[ \t\n\r]*\([ \t\n\r]*uColorBuffer/g,Kq=/void[ \t\n\r]+main/g,Lq=function(){function d(b,a){this.app=b;this.srcRenderTarget=a.srcRenderTarget;this.hdr=a.hdr;this.blending=a.blending;this.shader=a.shader;this.setup=a.setup;var c=this,e=b.graphicsDevice;this.layer=new nb({opaqueSortMode:0,
transparentSortMode:0,passThrough:!0,name:a.name,onPostRender:function(){c.srcRenderTarget?(ab.x=c.srcRenderTarget.width,ab.y=c.srcRenderTarget.height,ab.z=1/c.srcRenderTarget.width,ab.w=1/c.srcRenderTarget.height):(ab.x=e.width,ab.y=e.height,ab.z=1/e.width,ab.w=1/e.height);Ee[0]=ab.x;Ee[1]=ab.y;Ee[2]=ab.z;Ee[3]=ab.w;gn.setValue(Ee);if(this._postEffectCombined&&0>this._postEffectCombined)c.setup&&c.setup(e,c,ab,null,this.renderTarget);else{var h=this._postEffectCombinedSrc?this._postEffectCombinedSrc:
c.srcRenderTarget?c.srcRenderTarget:Ca[this._backbufferRtId];1<h._samples&&h.resolve(!0,!1);var k=h._colorBuffer;k.magFilter=(this._postEffectCombinedShader?this._postEffectCombinedBilinear:this.postEffectBilinear)?1:0;yi.setValue(k);c.setup&&c.setup(e,c,ab,h,this.renderTarget);(h=this._postEffectCombinedShader?this._postEffectCombinedShader:this.shader)&&Ea(e,this.renderTarget,h,null,null,c.blending);if(!c.srcRenderTarget)for(h=b.scene.layers.layerList,k=0;k<h.length&&h[k]!==c.layer;k++)if(h[k].renderTarget===
Ca[0]||h[k].renderTarget===Ca[1])h[k].renderTarget=null}}});this.layer._generateCameraHash();this.layer.isPostEffect=!0;this.layer.unmodifiedUvs=a.unmodifiedUvs;this.layer.postEffectBilinear=a.bilinear;this.layer.postEffect=this;this.layer.shader=a.shader;this.layer.renderTarget=a.destRenderTarget;if(!yi){yi=e.scope.resolve("uColorBuffer");gn=e.scope.resolve("uScreenSize");a=e.supportsMsaa?4:1;for(var f=0;2>f;f++)Ca[f]=new va({depth:!0,stencil:e.supportsStencil,samples:a,autoResolve:!1}),Ca[f].name=
"backbuffer"+f;b.on("prerender",function(){var h=b.scene.layers.layerList,k,m=0,n=0;Ai=zi=Fe=!1;var p=7;if(b.scene.layers._dirty){var t=0;for(k=0;k<h.length;k++){var r=!1;var u;if((u=h[k].isPostEffect)&&!(u=0===t)&&(u=h[k].unmodifiedUvs&&h[k].shader)){a:{var v,w,y;var x=h;var z=Cb;var B=t,C=sj(h[k].shader.definition.fshader);if(0!==C.length)for(y=0;y<B;y++)for(w=0;w<C.length;w++){u=C[w];var D=sj(x[z[y]].shader.definition.fshader);for(v=0;v<D.length;v++)if(D[v]===u){u=!0;break a}}u=!1}u=!u}u?(Cb[t]=
k,t++,k===h.length-1&&(r=!0)):0<t&&(r=!0);if(r){if(1<t){u="post_";for(r=0;r<t;r++)D=h[Cb[r]],u+=D.name?D.name:D.id,r<t-1&&(u+="_");D=e.programLib._cache[u];if(!D){v="vec4 shaderOutput;\n";w="void main() {\n";y=[];for(r=0;r<t;r++){D=h[Cb[r]].shader.definition.fshader+"\n";D=D.replace(Dq,"//").replace(Eq,"//").replace(Fq,"//").replace(Gq,"shaderOutput");0<r&&(D=D.replace(Hq,"//").replace(Iq,"//").replace(Jq,"shaderOutput;//"));D=D.replace(Kq,"void main"+r);var G;C=D;z=y;var J=C.length;var E=0,H=G=0;
B="";for(x=0;x<J;x++){var P=C.charAt(x);"{"===P?(0===G&&(E=x),G++):"}"===P&&(1===G&&(P=x,B+=C.substr(H,E-H+1),H=P),G--)}B+=C.substr(H,C.length-H+1);E=null;H=B.match(zq)||[];for(x=0;x<H.length;x++)for(C=H[x].split(","),J=0;J<C.length;J++)G=C[J].replace(Aq,"").trim(),0<=z.indexOf(G)?(E||(E=[]),E.push(G)):z.push(G);B=B.match(Bq)||[];for(x=0;x<B.length;x++)for(C=B[x].split(","),J=0;J<C.length;J++)G=C[J].replace(Cq,"").trim(),G=z.indexOf(G),0<=G&&z.splice(G,1);if(x=E)for(z=0;z<x.length;z++)D=D.replace(new RegExp("\\b"+
x[z]+"\\b","g"),x[z]+"NNNN"+r);v+=D;w+="main"+r+"();\n"}w+="gl_FragColor = shaderOutput;\n}\n";D=Ja(e,I.fullscreenQuadVS,v+w,u)}for(r=0;r<t;r++)h[Cb[r]]._postEffectCombined=r===t-1?1:-1;h[Cb[t-1]]._postEffectCombinedShader=D;h[Cb[t-1]]._postEffectCombinedBilinear=h[Cb[0]].postEffectBilinear;h[Cb[t-1]]._postEffectCombinedSrc=h[Cb[0]].postEffect.srcRenderTarget}Cb[0]=k;t=1}}}for(k=0;k<h.length;k++){if(h[k].isPostEffect&&(!h[k].postEffect.srcRenderTarget&&!h[k]._postEffectCombined||!h[k].postEffect._postEffectCombinedSrc&&
0<=h[k]._postEffectCombined)){for(r=k-1;r>=m;r--)h[r].renderTarget||(h[r].renderTarget=Ca[n]);h[k]._backbufferRtId=n;m=k;Fe=!0;1===n&&(zi=!0);h[k].postEffect.hdr&&(p=e.webgl2&&e.textureFloatRenderable?18:e.extTextureHalfFloatLinear&&e.textureHalfFloatRenderable?12:7);h[k].postEffect.shader&&!h[k].renderTarget&&(n=1-n)}else h[k].isPostEffect||h[k].renderTarget||!Fe||(h[k].renderTarget=Ca[n]);h[k].isPostEffect&&!h[k].renderTarget&&(Ai=!0)}if(Fe)if(!Ca[0].colorBuffer)ef(0,e,p);else if(Ca[0].width!==
e.width||Ca[0].height!==e.height||Ca[0]._colorBuffer._format!==p)Ca[0].colorBuffer.destroy(),Ca[0].destroy(),ef(0,e,p);if(zi)if(!Ca[1].colorBuffer)ef(1,e,p);else if(Ca[1].width!==e.width||Ca[1].height!==e.height||Ca[1]._colorBuffer._format!==p)Ca[1].colorBuffer.destroy(),Ca[1].destroy(),ef(1,e,p)},this);b.on("postrender",function(){var h=b.graphicsDevice;if(Fe&&!Ai){for(var k=b.scene.layers.layerList,m,n=k.length-1;0<=n&&(m=k[n].renderTarget,m!==Ca[0]&&m!==Ca[1]);n--);m&&(1<m._samples&&m.resolve(!0,
!1),h.copyRenderTarget(m,null,!0,!1))}},this)}}d.prototype.addToComposition=function(b){this.app.scene.layers.insertTransparent(this.layer,b)};return d}(),hg={write:function(d){console.log(d)},open:function(){hg.write("Powered by PlayCanvas 1.38.0 98cb89e")},info:function(d){console.info("INFO:\t\t"+d)},debug:function(d){console.debug("DEBUG:\t "+d)},error:function(d){console.error("ERROR:\t "+d)},warning:function(d){console.warn("WARNING: "+d)},alert:function(d){function b(a){return d.apply(this,
arguments)}b.toString=function(){return d.toString()};return b}(function(d){hg.write("ALERT:\t "+d);alert(d)}),assert:function(d,b){!1===d&&hg.write("ASSERT:\t"+b)}};Eb.endsWith=function(d,b){return d.endsWith(b)};Eb.startsWith=function(d,b){return d.startsWith(b)};var Mq={now:eb,Timer:wj};Object.defineProperty(Q.prototype,"data",{get:function(){this._data||(this._data=new Float32Array(4));this._data[0]=this.r;this._data[1]=this.g;this._data[2]=this.b;this._data[3]=this.a;return this._data}});Object.defineProperty(Q.prototype,
"data3",{get:function(){this._data3||(this._data3=new Float32Array(3));this._data3[0]=this.r;this._data3[1]=this.g;this._data3[2]=this.b;return this._data3}});R.INV_LOG2=Math.LOG2E;R.intToBytes=R.intToBytes32;R.bytesToInt=R.bytesToInt32;Object.defineProperty(S.prototype,"data",{get:function(){this._data||(this._data=new Float32Array(2));this._data[0]=this.x;this._data[1]=this.y;return this._data}});Object.defineProperty(A.prototype,"data",{get:function(){this._data||(this._data=new Float32Array(3));
this._data[0]=this.x;this._data[1]=this.y;this._data[2]=this.z;return this._data}});Object.defineProperty(Z.prototype,"data",{get:function(){this._data||(this._data=new Float32Array(4));this._data[0]=this.x;this._data[1]=this.y;this._data[2]=this.z;this._data[3]=this.w;return this._data}});var Nq={Aabb:la,Sphere:dd,Plane:Aj};dd.prototype.intersectRay=dd.prototype.intersectsRay;Og.prototype.update=function(d,b){var a=new M;a.mul2(d,b);this.setFromMat4(a)};Lg.prototype=Error.prototype;Mg.prototype=
Error.prototype;var Oq={ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,ADDRESS_REPEAT:0,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,ELEMENTTYPE_INT8:0,
ELEMENTTYPE_UINT8:1,ELEMENTTYPE_INT16:2,ELEMENTTYPE_UINT16:3,ELEMENTTYPE_INT32:4,ELEMENTTYPE_UINT32:5,ELEMENTTYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,
PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD:"TEXCOORD",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,drawQuadWithShader:Ea,programlib:lf,shaderChunks:I,ContextCreationError:Mg,Device:Ae,IndexBuffer:Db,ProgramLibrary:ri,RenderTarget:va,ScopeId:si,Shader:Ld,ShaderInput:ti,
Texture:X,UnsupportedBrowserError:Lg,VertexBuffer:Ra,VertexFormat:Ma,VertexIterator:vb},Pq={createFullscreenQuad:lj,drawFullscreenQuad:mj,PostEffect:Pm,PostEffectQueue:Th};Object.defineProperty(I,"transformSkinnedVS",{get:function(){return"#define SKIN\n"+I.transformVS}});Object.defineProperties(X.prototype,{rgbm:{get:function(){return"rgbm"===this.type},set:function(d){this.type=d?"rgbm":"default"}},swizzleGGGR:{get:function(){return"swizzleGGGR"===this.type},set:function(d){this.type=d?"swizzleGGGR":
"default"}}});var Qq=ma,Rq={partitionSkin:Xi,procedural:{calculateTangents:Qi,createMesh:kb,createTorus:Ri,createCylinder:pg,createCapsule:qg,createCone:rg,createSphere:sg,createPlane:tg,createBox:Oe},BasicMaterial:ih,Command:Xg,DepthMaterial:Qm,ForwardRenderer:hh,GraphNode:pa,Material:Fa,Mesh:bb,MeshInstance:Ga,Model:fb,ParticleEmitter:Cf,PhongMaterial:ma,Picker:Rm,Projection:{ORTHOGRAPHIC:1,PERSPECTIVE:0},Scene:mh,Skin:Ff,SkinInstance:ic};pa.prototype._dirtify=function(d){d?this._dirtifyLocal():
this._dirtifyWorld()};pa.prototype.addLabel=function(d){this._labels[d]=!0};pa.prototype.getLabels=function(){return Object.keys(this._labels)};pa.prototype.hasLabel=function(d){return!!this._labels[d]};pa.prototype.removeLabel=function(d){delete this._labels[d]};pa.prototype.findByLabel=function(d,b){var a,c=this._children.length;b=b||[];this.hasLabel(d)&&b.push(this);for(a=0;a<c;++a)b=this._children[a].findByLabel(d,b);return b};pa.prototype.getChildren=function(){return this.children};pa.prototype.getName=
function(){return this.name};pa.prototype.getPath=function(){return this.path};pa.prototype.getRoot=function(){return this.root};pa.prototype.getParent=function(){return this.parent};pa.prototype.setName=function(d){this.name=d};Fa.prototype.getName=function(){return this.name};Fa.prototype.setName=function(d){this.name=d};Fa.prototype.getShader=function(){return this.shader};Fa.prototype.setShader=function(d){this.shader=d};var Sq={Animation:$b,Key:Df,Node:Ef,Skeleton:rb};$b.prototype.getDuration=
function(){return this.duration};$b.prototype.getName=function(){return this.name};$b.prototype.getNodes=function(){return this.nodes};$b.prototype.setDuration=function(d){this.duration=d};$b.prototype.setName=function(d){this.name=d};rb.prototype.getAnimation=function(){return this.animation};rb.prototype.getCurrentTime=function(){return this.currentTime};rb.prototype.getLooping=function(){return this.looping};rb.prototype.getNumNodes=function(){return this.numNodes};rb.prototype.setAnimation=function(d){this.animation=
d};rb.prototype.setCurrentTime=function(d){this.currentTime=d};rb.prototype.setLooping=function(d){this.looping=d};var Tq={AudioManager:vd,Channel:ud,Channel3d:Mb,Listener:kk,Sound:uh};vd.prototype.getListener=function(){return this.listener};vd.prototype.getVolume=function(){return this.volume};vd.prototype.setVolume=function(d){this.volume=d};Dh.prototype.getAssetById=function(d){return this.get(d)};Object.defineProperty(oe.prototype,"ray",{get:function(){return this._rayLocal}});Object.defineProperty(oe.prototype,
"position",{get:function(){return this._localPosition}});Object.defineProperty(oe.prototype,"rotation",{get:function(){return this._localRotation}});var Uq={getTouchTargetCoords:Kg,Controller:Tm,GamePads:dn,Keyboard:vi,KeyboardEvent:ui,Mouse:Id,MouseEvent:Wc,Touch:gg,TouchDevice:en,TouchEvent:Kd};Object.defineProperty(an.prototype,"wheel",{get:function(){return-2*this.wheelDelta}});Object.defineProperty(Wc.prototype,"wheel",{get:function(){return-2*this.wheelDelta}});var Vq={Application:qa,Component:ca,
ComponentData:fn,ComponentSystem:O,Entity:Ba,FillMode:{NONE:"NONE",FILL_WINDOW:"FILL_WINDOW",KEEP_ASPECT:"KEEP_ASPECT"},ResolutionMode:{AUTO:"AUTO",FIXED:"FIXED"}};qa.prototype.isFullscreen=function(){return!!document.fullscreenElement};qa.prototype.enableFullscreen=function(d,b,a){d=d||this.graphicsDevice.canvas;var c=function h(){b();document.removeEventListener("fullscreenchange",h)},e=function k(){a();document.removeEventListener("fullscreenerror",k)};b&&document.addEventListener("fullscreenchange",
c,!1);a&&document.addEventListener("fullscreenerror",e,!1);d.requestFullscreen?d.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):a()};qa.prototype.disableFullscreen=function(d){var b=function c(){d();document.removeEventListener("fullscreenchange",c)};d&&document.addEventListener("fullscreenchange",b,!1);document.exitFullscreen()};qa.prototype.getSceneUrl=function(d){return(d=this.scenes.find(d))?d.url:null};qa.prototype.loadScene=function(d,b){this.scenes.loadScene(d,b)};qa.prototype.loadSceneHierarchy=
function(d,b){this.scenes.loadSceneHierarchy(d,b)};qa.prototype.loadSceneSettings=function(d,b){this.scenes.loadSceneSettings(d,b)};Object.defineProperty(se.prototype,"node",{get:function(){return this.entity}});Object.defineProperty(Ue.prototype,"enable",{get:function(){return this.enabled},set:function(d){this.enabled=d}});Xf.prototype.setVisible=function(d){this.enabled=d};Object.defineProperty(we.prototype,"bodyType",{get:function(){return this.type},set:function(d){this.type=d}});we.prototype.syncBodyToEntity=
function(){this._updateDynamic()};ei.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};q.ABSOLUTE_URL=wd;q.ACTION_GAMEPAD="gamepad";q.ACTION_KEYBOARD="keyboard";q.ACTION_MOUSE="mouse";q.ADDRESS_CLAMP_TO_EDGE=1;q.ADDRESS_MIRRORED_REPEAT=2;q.ADDRESS_REPEAT=0;q.ANIM_BLEND_1D="1D";q.ANIM_BLEND_2D_CARTESIAN="2D_CARTESIAN";q.ANIM_BLEND_2D_DIRECTIONAL="2D_DIRECTIONAL";q.ANIM_BLEND_DIRECT="DIRECT";q.ANIM_EQUAL_TO=
"EQUAL_TO";q.ANIM_GREATER_THAN="GREATER_THAN";q.ANIM_GREATER_THAN_EQUAL_TO="GREATER_THAN_EQUAL_TO";q.ANIM_INTERRUPTION_NEXT="NEXT_STATE";q.ANIM_INTERRUPTION_NEXT_PREV="NEXT_STATE_PREV_STATE";q.ANIM_INTERRUPTION_NONE="NONE";q.ANIM_INTERRUPTION_PREV="PREV_STATE";q.ANIM_INTERRUPTION_PREV_NEXT="PREV_STATE_NEXT_STATE";q.ANIM_LESS_THAN="LESS_THAN";q.ANIM_LESS_THAN_EQUAL_TO="LESS_THAN_EQUAL_TO";q.ANIM_NOT_EQUAL_TO="NOT_EQUAL_TO";q.ANIM_PARAMETER_BOOLEAN="BOOLEAN";q.ANIM_PARAMETER_FLOAT="FLOAT";q.ANIM_PARAMETER_INTEGER=
"INTEGER";q.ANIM_PARAMETER_TRIGGER="TRIGGER";q.ANIM_STATE_ANY="ANY";q.ANIM_STATE_END="END";q.ANIM_STATE_START="START";q.ASPECT_AUTO=0;q.ASPECT_MANUAL=1;q.ASSET_ANIMATION="animation";q.ASSET_AUDIO="audio";q.ASSET_CONTAINER="container";q.ASSET_CSS="css";q.ASSET_CUBEMAP="cubemap";q.ASSET_HTML="html";q.ASSET_IMAGE="image";q.ASSET_JSON="json";q.ASSET_MATERIAL="material";q.ASSET_MODEL="model";q.ASSET_SCRIPT="script";q.ASSET_SHADER="shader";q.ASSET_TEXT="text";q.ASSET_TEXTURE="texture";q.AXIS_KEY="key";
q.AXIS_MOUSE_X="mousex";q.AXIS_MOUSE_Y="mousey";q.AXIS_PAD_L_X="padlx";q.AXIS_PAD_L_Y="padly";q.AXIS_PAD_R_X="padrx";q.AXIS_PAD_R_Y="padry";q.AnimBinder=Pc;q.AnimClip=Hh;q.AnimClipHandler=tk;q.AnimComponent=Oh;q.AnimComponentLayer=El;q.AnimComponentSystem=Il;q.AnimController=Gl;q.AnimCurve=ph;q.AnimData=Gf;q.AnimEvaluator=Ih;q.AnimPropertyLocator=sh;q.AnimSnapshot=Bl;q.AnimStateGraph=Lf;q.AnimStateGraphHandler=uk;q.AnimTarget=mc;q.AnimTrack=ke;q.Animation=$b;q.AnimationComponent=Kh;q.AnimationComponentSystem=
Dl;q.AnimationHandler=sk;q.Application=qa;q.Asset=fa;q.AssetListLoader=Fk;q.AssetReference=ne;q.AssetRegistry=Dh;q.AudioHandler=vk;q.AudioListenerComponent=Ph;q.AudioListenerComponentSystem=Kl;q.AudioSourceComponent=Qh;q.AudioSourceComponentSystem=Ml;q.BAKE_COLOR=0;q.BAKE_COLORDIR=1;q.BLENDEQUATION_ADD=0;q.BLENDEQUATION_MAX=4;q.BLENDEQUATION_MIN=3;q.BLENDEQUATION_REVERSE_SUBTRACT=2;q.BLENDEQUATION_SUBTRACT=1;q.BLENDMODE_DST_ALPHA=9;q.BLENDMODE_DST_COLOR=4;q.BLENDMODE_ONE=1;q.BLENDMODE_ONE_MINUS_DST_ALPHA=
10;q.BLENDMODE_ONE_MINUS_DST_COLOR=5;q.BLENDMODE_ONE_MINUS_SRC_ALPHA=8;q.BLENDMODE_ONE_MINUS_SRC_COLOR=3;q.BLENDMODE_SRC_ALPHA=6;q.BLENDMODE_SRC_ALPHA_SATURATE=7;q.BLENDMODE_SRC_COLOR=2;q.BLENDMODE_ZERO=0;q.BLEND_ADDITIVE=1;q.BLEND_ADDITIVEALPHA=6;q.BLEND_MAX=10;q.BLEND_MIN=9;q.BLEND_MULTIPLICATIVE=5;q.BLEND_MULTIPLICATIVE2X=7;q.BLEND_NONE=3;q.BLEND_NORMAL=2;q.BLEND_PREMULTIPLIED=4;q.BLEND_SCREEN=8;q.BLEND_SUBTRACTIVE=0;q.BLUR_BOX=0;q.BLUR_GAUSSIAN=1;q.BODYFLAG_KINEMATIC_OBJECT=2;q.BODYFLAG_NORESPONSE_OBJECT=
4;q.BODYFLAG_STATIC_OBJECT=1;q.BODYGROUP_DEFAULT=1;q.BODYGROUP_DYNAMIC=1;q.BODYGROUP_ENGINE_1=8;q.BODYGROUP_ENGINE_2=32;q.BODYGROUP_ENGINE_3=64;q.BODYGROUP_KINEMATIC=4;q.BODYGROUP_NONE=0;q.BODYGROUP_STATIC=2;q.BODYGROUP_TRIGGER=16;q.BODYGROUP_USER_1=128;q.BODYGROUP_USER_2=256;q.BODYGROUP_USER_3=512;q.BODYGROUP_USER_4=1024;q.BODYGROUP_USER_5=2048;q.BODYGROUP_USER_6=4096;q.BODYGROUP_USER_7=8192;q.BODYGROUP_USER_8=16384;q.BODYMASK_ALL=65535;q.BODYMASK_NONE=0;q.BODYMASK_NOT_STATIC=65533;q.BODYMASK_NOT_STATIC_KINEMATIC=
65529;q.BODYMASK_STATIC=2;q.BODYSTATE_ACTIVE_TAG=1;q.BODYSTATE_DISABLE_DEACTIVATION=4;q.BODYSTATE_DISABLE_SIMULATION=5;q.BODYSTATE_ISLAND_SLEEPING=2;q.BODYSTATE_WANTS_DEACTIVATION=3;q.BODYTYPE_DYNAMIC="dynamic";q.BODYTYPE_KINEMATIC="kinematic";q.BODYTYPE_STATIC="static";q.BUFFER_DYNAMIC=1;q.BUFFER_GPUDYNAMIC=3;q.BUFFER_STATIC=0;q.BUFFER_STREAM=2;q.BUTTON_TRANSITION_MODE_SPRITE_CHANGE=1;q.BUTTON_TRANSITION_MODE_TINT=0;q.BasicMaterial=ih;q.BasisParser=Zk;q.Batch=Yg;q.BatchGroup=Da;q.BatchManager=Ej;
q.BinaryHandler=wk;q.BoundingBox=la;q.BoundingSphere=dd;q.Bundle=xk;q.BundleHandler=yk;q.BundleRegistry=gl;q.ButtonComponent=Rh;q.ButtonComponentSystem=Nl;q.CLEARFLAG_COLOR=1;q.CLEARFLAG_DEPTH=2;q.CLEARFLAG_STENCIL=4;q.COMPUPDATED_BLEND=8;q.COMPUPDATED_CAMERAS=4;q.COMPUPDATED_INSTANCES=1;q.COMPUPDATED_LIGHTS=2;q.CUBEFACE_NEGX=1;q.CUBEFACE_NEGY=3;q.CUBEFACE_NEGZ=5;q.CUBEFACE_POSX=0;q.CUBEFACE_POSY=2;q.CUBEFACE_POSZ=4;q.CUBEPROJ_BOX=1;q.CUBEPROJ_NONE=0;q.CULLFACE_BACK=1;q.CULLFACE_FRONT=2;q.CULLFACE_FRONTANDBACK=
3;q.CULLFACE_NONE=0;q.CURVE_CARDINAL=3;q.CURVE_CATMULL=2;q.CURVE_LINEAR=0;q.CURVE_SMOOTHSTEP=1;q.CURVE_SPLINE=4;q.CURVE_STEP=5;q.Camera=be;q.CameraComponent=se;q.CameraComponentSystem=Pl;q.CanvasFont=uq;q.CollisionComponent=Uh;q.CollisionComponentSystem=Sl;q.Color=Q;q.Command=Xg;q.Component=ca;q.ComponentData=fn;q.ComponentSystem=O;q.ComponentSystemRegistry=Tl;q.ContactPoint=om;q.ContactResult=pm;q.ContainerHandler=Ak;q.ContainerResource=zk;q.ContextCreationError=Mg;q.Controller=Tm;q.CssHandler=Bk;
q.CubemapHandler=Ck;q.Curve=db;q.CurveSet=Qb;q.DETAILMODE_ADD="add";q.DETAILMODE_MAX="max";q.DETAILMODE_MIN="min";q.DETAILMODE_MUL="mul";q.DETAILMODE_OVERLAY="overlay";q.DETAILMODE_SCREEN="screen";q.DISTANCE_EXPONENTIAL="exponential";q.DISTANCE_INVERSE="inverse";q.DISTANCE_LINEAR="linear";q.DefaultAnimBinder=Jh;q.DepthMaterial=Qm;q.ELEMENTTYPE_FLOAT32=6;q.ELEMENTTYPE_GROUP="group";q.ELEMENTTYPE_IMAGE="image";q.ELEMENTTYPE_INT16=2;q.ELEMENTTYPE_INT32=4;q.ELEMENTTYPE_INT8=0;q.ELEMENTTYPE_TEXT="text";
q.ELEMENTTYPE_UINT16=3;q.ELEMENTTYPE_UINT32=5;q.ELEMENTTYPE_UINT8=1;q.EMITTERSHAPE_BOX=0;q.EMITTERSHAPE_SPHERE=1;q.EVENT_KEYDOWN="keydown";q.EVENT_KEYUP="keyup";q.EVENT_MOUSEDOWN="mousedown";q.EVENT_MOUSEMOVE="mousemove";q.EVENT_MOUSEUP="mouseup";q.EVENT_MOUSEWHEEL="mousewheel";q.EVENT_SELECT="select";q.EVENT_SELECTEND="selectend";q.EVENT_SELECTSTART="selectstart";q.EVENT_TOUCHCANCEL="touchcancel";q.EVENT_TOUCHEND="touchend";q.EVENT_TOUCHMOVE="touchmove";q.EVENT_TOUCHSTART="touchstart";q.ElementComponent=
ka;q.ElementComponentSystem=$l;q.ElementDragHelper=ii;q.ElementInput=an;q.ElementInputEvent=fg;q.ElementMouseEvent=De;q.ElementSelectEvent=uc;q.ElementTouchEvent=Jd;q.Entity=Ba;q.EntityReference=nc;q.EventHandler=ba;q.FILLMODE_FILL_WINDOW="FILL_WINDOW";q.FILLMODE_KEEP_ASPECT="KEEP_ASPECT";q.FILLMODE_NONE="NONE";q.FILTER_LINEAR=1;q.FILTER_LINEAR_MIPMAP_LINEAR=5;q.FILTER_LINEAR_MIPMAP_NEAREST=4;q.FILTER_NEAREST=0;q.FILTER_NEAREST_MIPMAP_LINEAR=3;q.FILTER_NEAREST_MIPMAP_NEAREST=2;q.FITTING_BOTH=3;q.FITTING_NONE=
0;q.FITTING_SHRINK=2;q.FITTING_STRETCH=1;q.FOG_EXP="exp";q.FOG_EXP2="exp2";q.FOG_LINEAR="linear";q.FOG_NONE="none";q.FONT_BITMAP="bitmap";q.FONT_MSDF="msdf";q.FRESNEL_NONE=0;q.FRESNEL_SCHLICK=2;q.FUNC_ALWAYS=7;q.FUNC_EQUAL=2;q.FUNC_GREATER=4;q.FUNC_GREATEREQUAL=6;q.FUNC_LESS=1;q.FUNC_LESSEQUAL=3;q.FUNC_NEVER=0;q.FUNC_NOTEQUAL=5;q.FolderHandler=Dk;q.Font=xh;q.FontHandler=Ek;q.ForwardRenderer=hh;q.Frustum=Og;q.GAMMA_NONE=0;q.GAMMA_SRGB=1;q.GAMMA_SRGBFAST=2;q.GAMMA_SRGBHDR=3;q.GamePads=dn;q.GraphNode=
pa;q.GraphicsDevice=Ae;q.HierarchyHandler=Gk;q.HtmlHandler=Hk;q.Http=Oa;q.I18n=rh;q.INDEXFORMAT_UINT16=1;q.INDEXFORMAT_UINT32=2;q.INDEXFORMAT_UINT8=0;q.INTERPOLATION_CUBIC=2;q.INTERPOLATION_LINEAR=1;q.INTERPOLATION_STEP=0;q.ImageElement=Ul;q.ImgParser=$k;q.IndexBuffer=Db;q.IndexedList=vj;q.JsonHandler=Ik;q.JsonStandardMaterialParser=Jk;q.KEY_0=48;q.KEY_1=49;q.KEY_2=50;q.KEY_3=51;q.KEY_4=52;q.KEY_5=53;q.KEY_6=54;q.KEY_7=55;q.KEY_8=56;q.KEY_9=57;q.KEY_A=65;q.KEY_ADD=107;q.KEY_ALT=18;q.KEY_B=66;q.KEY_BACKSPACE=
8;q.KEY_BACK_SLASH=220;q.KEY_C=67;q.KEY_CAPS_LOCK=20;q.KEY_CLOSE_BRACKET=221;q.KEY_COMMA=188;q.KEY_CONTEXT_MENU=93;q.KEY_CONTROL=17;q.KEY_D=68;q.KEY_DECIMAL=110;q.KEY_DELETE=46;q.KEY_DIVIDE=111;q.KEY_DOWN=40;q.KEY_E=69;q.KEY_END=35;q.KEY_ENTER=13;q.KEY_EQUAL=61;q.KEY_ESCAPE=27;q.KEY_F=70;q.KEY_F1=112;q.KEY_F10=121;q.KEY_F11=122;q.KEY_F12=123;q.KEY_F2=113;q.KEY_F3=114;q.KEY_F4=115;q.KEY_F5=116;q.KEY_F6=117;q.KEY_F7=118;q.KEY_F8=119;q.KEY_F9=120;q.KEY_G=71;q.KEY_H=72;q.KEY_HOME=36;q.KEY_I=73;q.KEY_INSERT=
45;q.KEY_J=74;q.KEY_K=75;q.KEY_L=76;q.KEY_LEFT=37;q.KEY_M=77;q.KEY_META=224;q.KEY_MULTIPLY=106;q.KEY_N=78;q.KEY_NUMPAD_0=96;q.KEY_NUMPAD_1=97;q.KEY_NUMPAD_2=98;q.KEY_NUMPAD_3=99;q.KEY_NUMPAD_4=100;q.KEY_NUMPAD_5=101;q.KEY_NUMPAD_6=102;q.KEY_NUMPAD_7=103;q.KEY_NUMPAD_8=104;q.KEY_NUMPAD_9=105;q.KEY_O=79;q.KEY_OPEN_BRACKET=219;q.KEY_P=80;q.KEY_PAGE_DOWN=34;q.KEY_PAGE_UP=33;q.KEY_PAUSE=19;q.KEY_PERIOD=190;q.KEY_PRINT_SCREEN=44;q.KEY_Q=81;q.KEY_R=82;q.KEY_RETURN=13;q.KEY_RIGHT=39;q.KEY_S=83;q.KEY_SEMICOLON=
59;q.KEY_SEPARATOR=108;q.KEY_SHIFT=16;q.KEY_SLASH=191;q.KEY_SPACE=32;q.KEY_SUBTRACT=109;q.KEY_T=84;q.KEY_TAB=9;q.KEY_U=85;q.KEY_UP=38;q.KEY_V=86;q.KEY_W=87;q.KEY_WINDOWS=91;q.KEY_X=88;q.KEY_Y=89;q.KEY_Z=90;q.Key=Df;q.Keyboard=vi;q.KeyboardEvent=ui;q.KtxParser=bl;q.LAYERID_DEPTH=1;q.LAYERID_IMMEDIATE=3;q.LAYERID_SKYBOX=2;q.LAYERID_UI=4;q.LAYERID_WORLD=0;q.LAYER_FX=2;q.LAYER_GIZMO=1;q.LAYER_HUD=0;q.LAYER_WORLD=15;q.LIGHTFALLOFF_INVERSESQUARED=1;q.LIGHTFALLOFF_LINEAR=0;q.LIGHTSHAPE_DISK=2;q.LIGHTSHAPE_PUNCTUAL=
0;q.LIGHTSHAPE_RECT=1;q.LIGHTSHAPE_SPHERE=3;q.LIGHTTYPE_DIRECTIONAL=0;q.LIGHTTYPE_OMNI=1;q.LIGHTTYPE_POINT=1;q.LIGHTTYPE_SPOT=2;q.LINEBATCH_GIZMO=2;q.LINEBATCH_OVERLAY=1;q.LINEBATCH_WORLD=0;q.Layer=nb;q.LayerComposition=yf;q.LayoutCalculator=cm;q.LayoutChildComponent=Se;q.LayoutChildComponentSystem=bm;q.LayoutGroupComponent=Te;q.LayoutGroupComponentSystem=em;q.LegacyDdsParser=cl;q.Light=fm;q.LightComponent=Ue;q.LightComponentSystem=hm;q.Lightmapper=Zj;q.LocalizedAsset=Vl;q.MASK_BAKED=2;q.MASK_DYNAMIC=
1;q.MASK_LIGHTMAP=4;q.MOUSEBUTTON_LEFT=0;q.MOUSEBUTTON_MIDDLE=1;q.MOUSEBUTTON_NONE=-1;q.MOUSEBUTTON_RIGHT=2;q.Mat3=lb;q.Mat4=M;q.Material=Fa;q.MaterialHandler=Kk;q.Mesh=bb;q.MeshInstance=Ga;q.Model=fb;q.ModelComponent=Xf;q.ModelComponentSystem=jm;q.ModelHandler=Lk;q.Morph=ed;q.MorphInstance=ae;q.MorphTarget=oh;q.Mouse=Id;q.MouseEvent=Wc;q.Node=Ef;q.ORIENTATION_HORIZONTAL=0;q.ORIENTATION_VERTICAL=1;q.OrientedBox=fo;q.PAD_1=0;q.PAD_2=1;q.PAD_3=2;q.PAD_4=3;q.PAD_DOWN=13;q.PAD_FACE_1=0;q.PAD_FACE_2=1;
q.PAD_FACE_3=2;q.PAD_FACE_4=3;q.PAD_LEFT=14;q.PAD_L_SHOULDER_1=4;q.PAD_L_SHOULDER_2=6;q.PAD_L_STICK_BUTTON=10;q.PAD_L_STICK_X=0;q.PAD_L_STICK_Y=1;q.PAD_RIGHT=15;q.PAD_R_SHOULDER_1=5;q.PAD_R_SHOULDER_2=7;q.PAD_R_STICK_BUTTON=11;q.PAD_R_STICK_X=2;q.PAD_R_STICK_Y=3;q.PAD_SELECT=8;q.PAD_START=9;q.PAD_UP=12;q.PAD_VENDOR=16;q.PARTICLEMODE_CPU=1;q.PARTICLEMODE_GPU=0;q.PARTICLEORIENTATION_EMITTER=2;q.PARTICLEORIENTATION_SCREEN=0;q.PARTICLEORIENTATION_WORLD=1;q.PARTICLESORT_DISTANCE=1;q.PARTICLESORT_NEWER_FIRST=
2;q.PARTICLESORT_NONE=0;q.PARTICLESORT_OLDER_FIRST=3;q.PIXELFORMAT_111110F=18;q.PIXELFORMAT_A8=0;q.PIXELFORMAT_ASTC_4x4=28;q.PIXELFORMAT_ATC_RGB=29;q.PIXELFORMAT_ATC_RGBA=30;q.PIXELFORMAT_DEPTH=16;q.PIXELFORMAT_DEPTHSTENCIL=17;q.PIXELFORMAT_DXT1=8;q.PIXELFORMAT_DXT3=9;q.PIXELFORMAT_DXT5=10;q.PIXELFORMAT_ETC1=21;q.PIXELFORMAT_ETC2_RGB=22;q.PIXELFORMAT_ETC2_RGBA=23;q.PIXELFORMAT_L8=1;q.PIXELFORMAT_L8_A8=2;q.PIXELFORMAT_PVRTC_2BPP_RGBA_1=25;q.PIXELFORMAT_PVRTC_2BPP_RGB_1=24;q.PIXELFORMAT_PVRTC_4BPP_RGBA_1=
27;q.PIXELFORMAT_PVRTC_4BPP_RGB_1=26;q.PIXELFORMAT_R32F=15;q.PIXELFORMAT_R4_G4_B4_A4=5;q.PIXELFORMAT_R5_G5_B5_A1=4;q.PIXELFORMAT_R5_G6_B5=3;q.PIXELFORMAT_R8_G8_B8=6;q.PIXELFORMAT_R8_G8_B8_A8=7;q.PIXELFORMAT_RGB16F=11;q.PIXELFORMAT_RGB32F=13;q.PIXELFORMAT_RGBA16F=12;q.PIXELFORMAT_RGBA32F=14;q.PIXELFORMAT_SRGB=19;q.PIXELFORMAT_SRGBA=20;q.PRIMITIVE_LINELOOP=2;q.PRIMITIVE_LINES=1;q.PRIMITIVE_LINESTRIP=3;q.PRIMITIVE_POINTS=0;q.PRIMITIVE_TRIANGLES=4;q.PRIMITIVE_TRIFAN=6;q.PRIMITIVE_TRISTRIP=5;q.PROJECTION_ORTHOGRAPHIC=
1;q.PROJECTION_PERSPECTIVE=0;q.ParticleEmitter=Cf;q.ParticleSystemComponent=$h;q.ParticleSystemComponentSystem=mm;q.PhongMaterial=Qq;q.Picker=Rm;q.Plane=Aj;q.PostEffect=Pm;q.PostEffectPass=Lq;q.PostEffectQueue=Th;q.ProgramLibrary=ri;q.Quat=ea;q.RENDERSTYLE_POINTS=2;q.RENDERSTYLE_SOLID=0;q.RENDERSTYLE_WIREFRAME=1;q.RESOLUTION_AUTO="AUTO";q.RESOLUTION_FIXED="FIXED";q.RIGIDBODY_ACTIVE_TAG=1;q.RIGIDBODY_CF_KINEMATIC_OBJECT=2;q.RIGIDBODY_CF_NORESPONSE_OBJECT=4;q.RIGIDBODY_CF_STATIC_OBJECT=1;q.RIGIDBODY_DISABLE_DEACTIVATION=
4;q.RIGIDBODY_DISABLE_SIMULATION=5;q.RIGIDBODY_ISLAND_SLEEPING=2;q.RIGIDBODY_TYPE_DYNAMIC="dynamic";q.RIGIDBODY_TYPE_KINEMATIC="kinematic";q.RIGIDBODY_TYPE_STATIC="static";q.RIGIDBODY_WANTS_DEACTIVATION=3;q.Ray=Ec;q.RaycastResult=di;q.RenderHandler=Mk;q.RenderTarget=va;q.ResourceHandler=vq;q.ResourceLoader=Nk;q.RigidBodyComponent=we;q.RigidBodyComponentSystem=ei;q.SCALEMODE_BLEND="blend";q.SCALEMODE_NONE="none";q.SCROLLBAR_VISIBILITY_SHOW_ALWAYS=0;q.SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED=1;q.SCROLL_MODE_BOUNCE=
1;q.SCROLL_MODE_CLAMP=0;q.SCROLL_MODE_INFINITE=2;q.SEMANTIC_ATTR="ATTR";q.SEMANTIC_ATTR0="ATTR0";q.SEMANTIC_ATTR1="ATTR1";q.SEMANTIC_ATTR10="ATTR10";q.SEMANTIC_ATTR11="ATTR11";q.SEMANTIC_ATTR12="ATTR12";q.SEMANTIC_ATTR13="ATTR13";q.SEMANTIC_ATTR14="ATTR14";q.SEMANTIC_ATTR15="ATTR15";q.SEMANTIC_ATTR2="ATTR2";q.SEMANTIC_ATTR3="ATTR3";q.SEMANTIC_ATTR4="ATTR4";q.SEMANTIC_ATTR5="ATTR5";q.SEMANTIC_ATTR6="ATTR6";q.SEMANTIC_ATTR7="ATTR7";q.SEMANTIC_ATTR8="ATTR8";q.SEMANTIC_ATTR9="ATTR9";q.SEMANTIC_BLENDINDICES=
"BLENDINDICES";q.SEMANTIC_BLENDWEIGHT="BLENDWEIGHT";q.SEMANTIC_COLOR="COLOR";q.SEMANTIC_NORMAL="NORMAL";q.SEMANTIC_POSITION="POSITION";q.SEMANTIC_TANGENT="TANGENT";q.SEMANTIC_TEXCOORD="TEXCOORD";q.SEMANTIC_TEXCOORD0="TEXCOORD0";q.SEMANTIC_TEXCOORD1="TEXCOORD1";q.SEMANTIC_TEXCOORD2="TEXCOORD2";q.SEMANTIC_TEXCOORD3="TEXCOORD3";q.SEMANTIC_TEXCOORD4="TEXCOORD4";q.SEMANTIC_TEXCOORD5="TEXCOORD5";q.SEMANTIC_TEXCOORD6="TEXCOORD6";q.SEMANTIC_TEXCOORD7="TEXCOORD7";q.SHADERDEF_DIRLM=128;q.SHADERDEF_INSTANCING=
32;q.SHADERDEF_LM=64;q.SHADERDEF_MORPH_NORMAL=2048;q.SHADERDEF_MORPH_POSITION=1024;q.SHADERDEF_MORPH_TEXTURE_BASED=4096;q.SHADERDEF_NOSHADOW=1;q.SHADERDEF_SCREENSPACE=256;q.SHADERDEF_SKIN=2;q.SHADERDEF_TANGENTS=512;q.SHADERDEF_UV0=4;q.SHADERDEF_UV1=8;q.SHADERDEF_VCOLOR=16;q.SHADERTAG_MATERIAL=1;q.SHADER_DEPTH=2;q.SHADER_FORWARD=0;q.SHADER_FORWARDHDR=1;q.SHADER_PICK=18;q.SHADER_SHADOW=3;q.SHADOWUPDATE_NONE=0;q.SHADOWUPDATE_REALTIME=2;q.SHADOWUPDATE_THISFRAME=1;q.SHADOW_DEPTH=0;q.SHADOW_PCF3=0;q.SHADOW_PCF5=
4;q.SHADOW_VSM16=2;q.SHADOW_VSM32=3;q.SHADOW_VSM8=1;q.SORTKEY_DEPTH=1;q.SORTKEY_FORWARD=0;q.SORTMODE_BACK2FRONT=3;q.SORTMODE_CUSTOM=5;q.SORTMODE_FRONT2BACK=4;q.SORTMODE_MANUAL=1;q.SORTMODE_MATERIALMESH=2;q.SORTMODE_NONE=0;q.SPECOCC_AO=1;q.SPECOCC_GLOSSDEPENDENT=2;q.SPECOCC_NONE=0;q.SPECULAR_BLINN=1;q.SPECULAR_PHONG=0;q.SPRITETYPE_ANIMATED="animated";q.SPRITETYPE_SIMPLE="simple";q.SPRITE_RENDERMODE_SIMPLE=0;q.SPRITE_RENDERMODE_SLICED=1;q.SPRITE_RENDERMODE_TILED=2;q.STENCILOP_DECREMENT=5;q.STENCILOP_DECREMENTWRAP=
6;q.STENCILOP_INCREMENT=3;q.STENCILOP_INCREMENTWRAP=4;q.STENCILOP_INVERT=7;q.STENCILOP_KEEP=0;q.STENCILOP_REPLACE=2;q.STENCILOP_ZERO=1;q.Scene=mh;q.SceneHandler=Ok;q.SceneRegistry=Im;q.SceneRegistryItem=Hm;q.SceneSettingsHandler=Pk;q.ScopeId=si;q.ScopeSpace=Nm;q.ScreenComponent=fi;q.ScreenComponentSystem=tm;q.ScriptAttributes=ad;q.ScriptComponent=ye;q.ScriptComponentSystem=um;q.ScriptHandler=Td;q.ScriptLegacyComponent=gi;q.ScriptLegacyComponentSystem=wm;q.ScriptRegistry=hl;q.ScriptType=ec;q.ScrollViewComponent=
ki;q.ScrollViewComponentSystem=zm;q.ScrollbarComponent=mi;q.ScrollbarComponentSystem=Am;q.Shader=Ld;q.ShaderHandler=Rk;q.SingleContactResult=nm;q.Skeleton=rb;q.Skin=Ff;q.SkinBatchInstance=Zg;q.SkinInstance=ic;q.SortedLoopArray=Wd;q.Sound=uh;q.SoundComponent=Sd;q.SoundComponentSystem=Cm;q.SoundInstance=ib;q.SoundInstance3d=Ya;q.SoundManager=vd;q.SoundSlot=ag;q.Sprite=Sk;q.SpriteAnimationClip=bg;q.SpriteComponent=pi;q.SpriteComponentSystem=Em;q.SpriteHandler=Tk;q.StandardMaterial=ma;q.StencilParameters=
ue;q.TEXHINT_ASSET=2;q.TEXHINT_LIGHTMAP=3;q.TEXHINT_NONE=0;q.TEXHINT_SHADOWMAP=1;q.TEXTURELOCK_READ=1;q.TEXTURELOCK_WRITE=2;q.TEXTURETYPE_DEFAULT="default";q.TEXTURETYPE_RGBE="rgbe";q.TEXTURETYPE_RGBM="rgbm";q.TEXTURETYPE_SWIZZLEGGGR="swizzleGGGR";q.TONEMAP_ACES=3;q.TONEMAP_ACES2=4;q.TONEMAP_FILMIC=1;q.TONEMAP_HEJL=2;q.TONEMAP_LINEAR=0;q.TYPE_FLOAT32=6;q.TYPE_INT16=2;q.TYPE_INT32=4;q.TYPE_INT8=0;q.TYPE_UINT16=3;q.TYPE_UINT32=5;q.TYPE_UINT8=1;q.Tags=Ng;q.Template=Uk;q.TemplateHandler=Vk;q.TemplateUtils=
ac;q.TextElement=Xl;q.TextHandler=Wk;q.Texture=X;q.TextureAtlas=Xk;q.TextureAtlasHandler=Yk;q.TextureHandler=fl;q.TextureParser=hp;q.Timer=wj;q.Touch=gg;q.TouchDevice=en;q.TouchEvent=Kd;q.TransformFeedback=tq;q.UNIFORMTYPE_BOOL=0;q.UNIFORMTYPE_BVEC2=9;q.UNIFORMTYPE_BVEC3=10;q.UNIFORMTYPE_BVEC4=11;q.UNIFORMTYPE_FLOAT=2;q.UNIFORMTYPE_FLOATARRAY=17;q.UNIFORMTYPE_INT=1;q.UNIFORMTYPE_IVEC2=6;q.UNIFORMTYPE_IVEC3=7;q.UNIFORMTYPE_IVEC4=8;q.UNIFORMTYPE_MAT2=12;q.UNIFORMTYPE_MAT3=13;q.UNIFORMTYPE_MAT4=14;q.UNIFORMTYPE_TEXTURE2D=
15;q.UNIFORMTYPE_TEXTURE2D_SHADOW=18;q.UNIFORMTYPE_TEXTURE3D=20;q.UNIFORMTYPE_TEXTURECUBE=16;q.UNIFORMTYPE_TEXTURECUBE_SHADOW=19;q.UNIFORMTYPE_VEC2=3;q.UNIFORMTYPE_VEC2ARRAY=21;q.UNIFORMTYPE_VEC3=4;q.UNIFORMTYPE_VEC3ARRAY=22;q.UNIFORMTYPE_VEC4=5;q.UNIFORMTYPE_VEC4ARRAY=23;q.URI=Ge;q.UnsupportedBrowserError=Lg;q.VIEW_CENTER=0;q.VIEW_LEFT=1;q.VIEW_RIGHT=2;q.Vec2=S;q.Vec3=A;q.Vec4=Z;q.VertexBuffer=Ra;q.VertexFormat=Ma;q.VertexIterator=vb;q.VrDisplay=il;q.VrManager=Eh;q.XRHAND_LEFT="left";q.XRHAND_NONE=
"none";q.XRHAND_RIGHT="right";q.XRSPACE_BOUNDEDFLOOR="bounded-floor";q.XRSPACE_LOCAL="local";q.XRSPACE_LOCALFLOOR="local-floor";q.XRSPACE_UNBOUNDED="unbounded";q.XRSPACE_VIEWER="viewer";q.XRTARGETRAY_GAZE="gaze";q.XRTARGETRAY_POINTER="tracked-pointer";q.XRTARGETRAY_SCREEN="screen";q.XRTRACKABLE_MESH="mesh";q.XRTRACKABLE_PLANE="plane";q.XRTRACKABLE_POINT="point";q.XRTYPE_AR="immersive-ar";q.XRTYPE_INLINE="inline";q.XRTYPE_VR="immersive-vr";q.XrDepthSensing=zl;q.XrDomOverlay=yl;q.XrHitTest=ml;q.XrHitTestSource=
ll;q.XrImageTracking=xl;q.XrInput=sl;q.XrInputSource=oe;q.XrLightEstimation=vl;q.XrManager=Al;q.XrTrackedImage=wl;q.ZoneComponent=qi;q.ZoneComponentSystem=Gm;q.anim=Sq;q.apps={};q.asset={ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SCRIPT:"script"};q.audio=Tq;q.basisDownload=Cg;q.basisDownloadFromConfig=aj;q.basisInitialize=Ag;q.basisSetDownloadConfig=
function(d,b,a){Rd={glueUrl:d,wasmUrl:b,fallbackUrl:a}};q.basisTargetFormat=yg;q.basisTranscode=bj;q.calculateNormals=Pi;q.calculateTangents=Qi;q.common={};q.config={};q.createBox=Oe;q.createCapsule=qg;q.createCone=rg;q.createCylinder=pg;q.createMesh=kb;q.createPlane=tg;q.createScript=nj;q.createSphere=sg;q.createStyle=function(d){var b=document.createElement("style");b.type="text/css";b.styleSheet?b.styleSheet.cssText=d:b.appendChild(document.createTextNode(d));return b};q.createTorus=Ri;q.createURI=
function(d){var b="";if((d.authority||d.scheme)&&(d.host||d.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(d.host&&d.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(d.path&&d.hostpath)throw Error("Can't have 'path' and 'hostpath' option");d.scheme&&(b+=d.scheme+":");d.authority&&(b+="//"+d.authority);d.host&&(b+=d.host);d.path&&(b+=d.path);d.hostpath&&(b+=d.hostpath);d.query&&(b+="?"+d.query);d.fragment&&(b+="#"+d.fragment);return b};
q.data={};q.debug=co;q.drawFullscreenQuad=mj;q.drawQuadWithShader=Ea;q.drawTexture=function(d,b,a,c,e,f,h){void 0===h&&(h=!1);c=c||d.getCopyShader();d.constantTexSource.setValue(b);Ea(d,a,c,e,f,h)};q.events=Ud;q.extend=Ob;q.fw=Vq;q.getTouchTargetCoords=Kg;q.gfx=Oq;q.guid=tj;q.http=oa;q.inherits=function(d,b){var a=function(){},c=function(e,f,h,k,m,n,p,t){b.call(this,e,f,h,k,m,n,p,t);d.call(this,e,f,h,k,m,n,p,t)};c._super=b.prototype;a.prototype=b.prototype;c.prototype=new a;return c};q.input=Uq;q.isDefined=
ig;q.log=hg;q.makeArray=function(d){return Array.prototype.slice.call(d)};q.math=R;q.now=eb;q.path=da;q.platform=za;q.posteffect=Pq;q.prefilterCubemap=function(d){var b=d.device,a=d.sourceCubemap,c=d.method,e=d.samples,f=d.cpuSync;if(!f||a._levels[0]){var h=a.type,k="rgbm"===h,m=Ja(b,I.fullscreenQuadVS,I.rgbmPS+I.prefilterCubemapPS.replace(/\$METHOD/g,0===c?"cos":"phong").replace(/\$NUMSAMPLES/g,e).replace(/\$textureCube/g,k?"textureCubeRGBM":"textureCube"),"prefilter"+c+e+k),n=Ja(b,I.fullscreenQuadVS,
I.outputCubemapPS,"outputCubemap"),p=b.scope.resolve("source"),t=b.scope.resolve("params"),r=new Z,u=a.width;e=a.format;var v=[[],d.filteredFixed,d.filteredRgbm,d.filteredFixedRgbm],w=0===c?[.9,.85,.7,.4,.25,.15,.1]:[512,128,32,8,2,1,1],y=[64,32,16,8,4,2,1],x;var z=!1;f&&(z=a._levels[0][0]instanceof HTMLImageElement);if((6===e||z)&&f){e=7;var B=new X(b,{cubemap:!0,type:h,format:e,width:u,height:u,mipmaps:!1});B.name="prefiltered-cube";for(x=0;6>x;x++){var C=new va(b,B,{face:x,depth:!1});r.x=x;r.y=
0;p.setValue(a);t.setValue(r.data);Ea(b,C,n);Ze(b,C,x)}a=B}if(128<u){var D=Math.round(Math.log2(u))-Math.round(Math.log2(128));for(z=0;z<D;z++){u=.5*a.width;var G=0===c?1:Math.pow(2,Math.round(Math.log2(w[0])+2*(D-z)));B=new X(b,{cubemap:!0,type:h,format:e,width:u,height:u,mipmaps:!1});B.name="prefiltered-cube";for(x=0;6>x;x++)C=new va(b,B,{face:x,depth:!1}),r.x=x,r.y=G,r.z=u,r.w=k?3:0,p.setValue(a),t.setValue(r.data),Ea(b,C,n),z===D-1&&f&&Ze(b,C,x);a=B}}d.sourceCubemap=a;B=null;if(!k&&d.filteredFixedRgbm)for(B=
new X(b,{cubemap:!0,type:"rgbm",format:7,width:u,height:u,mipmaps:!1}),B.name="prefiltered-cube",x=0;6>x;x++)C=new va(b,B,{face:x,depth:!1}),r.x=x,r.w=2,p.setValue(a),t.setValue(r.data),Ea(b,C,n),Ze(b,C,x);u=0===c?1:2048;C=0===c?0:-1;v[C]=[];for(z=0;7>z;z++)for(n=C;n<v.length;n++)null!=v[n]&&(v[n][z]=new X(b,{cubemap:!0,type:2>n?h:"rgbm",format:2>n?e:7,fixCubemapSeams:1===n||3===n,width:y[z],height:y[z],mipmaps:!1}),v[n][z].name="prefiltered-cube");for(n=C;n<v.length;n++)if(null!=v[n])if(1<n&&k)v[n]=
v[n-2];else for(z=0;7>z;z++)for(x=0;6>x;x++)C=new va(b,v[n][z],{face:x,depth:!1}),r.x=x,r.y=0>n?u:w[z],r.z=y[z],r.w=k?3:n,p.setValue(0===z?a:0===c?v[0][z-1]:v[-1][z-1]),t.setValue(r.data),Ea(b,C,m),f&&Ze(b,C,x);d.filtered=v[0];if(f&&d.singleFilteredFixed){a=[a].concat(d.filteredFixed);h=new X(b,{cubemap:!0,type:h,fixCubemapSeams:!0,format:e,width:128,height:128,addressU:1,addressV:1});h.name="prefiltered-cube";for(z=0;z<a.length;z++)h._levels[z]=a[z]._levels[0];h.upload();h._prefilteredMips=!0;d.singleFilteredFixed=
h}if(f&&d.singleFilteredFixedRgbm&&d.filteredFixedRgbm){a=[B].concat(d.filteredFixedRgbm);h=new X(b,{cubemap:!0,type:"rgbm",fixCubemapSeams:!0,format:7,width:128,height:128,addressU:1,addressV:1});h.name="prefiltered-cube";for(z=0;z<a.length;z++)h._levels[z]=a[z]._levels[0];h.upload();h._prefilteredMips=!0;d.singleFilteredFixedRgbm=h}}};q.programlib=lf;q.registerScript=pj;q.reprojectTexture=function(d,b,a,c,e){void 0===e&&(e=1024);var f=void 0!==c?"prefilter":"reproject",h="decode"+kj(b),k="encode"+
kj(a),m=b.cubemap?"sampleCubemap":"sampleEquirect",n=a.cubemap?"getDirectionCubemap":"getDirectionEquirect";e=Ja(d,I.fullscreenQuadVS,"#define PROCESS_FUNC "+f+"\n#define DECODE_FUNC "+h+"\n#define ENCODE_FUNC "+k+"\n#define SOURCE_FUNC "+m+"\n#define TARGET_FUNC "+n+"\n#define NUM_SAMPLES "+e+"\n\n"+I.reprojectPS,f+h+k+m+n,null,d.webgl2?"":"#extension GL_OES_standard_derivatives: enable\n");d.scope.resolve(b.cubemap?"sourceCube":"sourceTex").setValue(b);f=d.scope.resolve("params");h=new Float32Array(4);
h[1]=void 0!==c?c:1;h[2]=1-(b.fixCubemapSeams?1/b.width:0);h[3]=1-(a.fixCubemapSeams?1/a.width:0);for(b=0;b<(a.cubemap?6:1);b++)c=new va(d,a,{face:b,depth:!1}),h[0]=b,f.setValue(h),Ea(d,c,e)};q.revision="98cb89e";q.scene=Rq;q.script=Va;q.semanticToLocation=Qg;q.shFromCubemap=jj;q.shaderChunks=I;q.shape=Nq;q.string=Eb;q.time=Mq;q.type=cc;q.typedArrayIndexFormats=Bj;q.typedArrayIndexFormatsByteSize=[1,2,4];q.typedArrayToType={Int8Array:0,Uint8Array:1,Int16Array:2,Uint16Array:3,Int32Array:4,Uint32Array:5,
Float32Array:6};q.typedArrayTypes=Fc;q.typedArrayTypesByteSize=$d;q.version="1.38.0";Object.defineProperty(q,"__esModule",{value:!0})});
